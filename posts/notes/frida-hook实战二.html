<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> frida-hook实战二 · Uknow - Stay hungry Stay foolish</title><meta name="description" content="frida-hook实战二 - uknow"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/2.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div id="mask" style="display: none;"><img id="mask-image" src="#" style=" "></div><div class="wrap"><header><a href="/" class="logo-link"><img src="/2.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">Blog</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">Archive</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">About</a></li><li class="nav-list-item"><a href="https://github.com/uknowsec" target="_blank" class="nav-list-link">GitHub</a></li><li class="nav-list-item"><a href="http://weibo.com/uknowsec" target="_blank" class="nav-list-link">Weibo</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">frida-hook实战二</h1><div class="post-time">Jan 7, 2020</div><div class="post-content"><h3><span id="traceviewfrida">Traceview+frida</span></h3><p>TraceView 是 Android SDK 中内置的一个工具，它可以加载 <strong>trace</strong> 文件，用图形的形式展示<strong>代码的执行时间、次数及调用栈</strong>。</p>
<h4><span id="利用mprop工具修改当前手机应用都可以调试">利用mprop工具修改当前手机应用都可以调试</span></h4><p>​    使用DDMS时，只能看到手机，看不到进程信息，这样我们就不能获取指定进程的信息</p>
<p>​    如果需要调试android 的程序，以下两个条件满足一个就行。第一是apk的配置文件内的AndroidManifest.xml的 android:debuggable=”true”，第二就是/default.prop中ro.debuggable=1。两种方式第一种通常是解包添加属性再打包，随着加壳软件以及apk校验等，容易出现安装包异常。第二种由于一般的手机发布时ro.debuggable一般是0 也就是不允许调试，通过修改rom的办法在手机上比较麻烦，需要刷机等等，模拟器上一般是vmdk的虚拟机，也没法修改rom。</p>
<p>​    这里我们可以直接用mprop这个工具，可以直接修改android属性。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com\1578290999051.png" alt="1578290999051"></p>
<p>同样有不同的版本，通过adb上传到模拟机，修改属性值。</p>
<p>arm:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">adb push .\libs\armeabi-v7a\mprop /data/local/tmp/</span><br><span class="line">adb shell &quot;chmod 755 /data/local/tmp/mprop&quot;</span><br><span class="line">adb shell &quot;/data/local/tmp/mprop&quot;</span><br><span class="line">adb shell &quot;setprop ro.debuggable 1&quot;</span><br></pre></td></tr></table></figure>
<p>x86:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">adb push .\libs\x86\mprop /data/local/tmp/</span><br><span class="line">adb shell &quot;chmod 755 /data/local/tmp/mprop&quot;</span><br><span class="line">adb shell &quot;/data/local/tmp/mprop&quot;</span><br><span class="line">adb shell &quot;setprop ro.debuggable 1&quot;</span><br></pre></td></tr></table></figure>
<p>这样我们就能看到进行信息了</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com\1578291249889.png" alt="1578291249889"></p>
<h4><span id="traceview-追踪函数">TraceView 追踪函数</span></h4><p>这里用到的是DDMS中的traceview工具，直接下载android-sdk工具包，运行里面的ddms.bat即可。</p>
<p>如图选定进程名，选择Trace based profiling。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com\1578291346817.png" alt="1578291346817"></p>
<p>触发APP条件事件（比如Click或者刷新）生成.trace文件，这样我们就可以看到整个用堆栈过程。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com\1578305250868.png" alt="1578305250868"></p>
<p>对比AES的解密实现，只需要如下三个点得到，key、模式和iv值就行了。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com\1578292369510.png" alt="1578292369510"></p>
<p>key值和iv值是构造函数，根据hook构造函数的方法，要用到<code>$init</code>，并且要<code>return this.$init(arg1,arg2)</code>调用原始的函数实现，同时<code>IvParameterSpec</code>方法的参数是一个比特数组的重载函数。</p>
<p>Java中比特数组表示为<code>[B</code>，其他类型的数组如下表示。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[Z = boolean</span><br><span class="line">[B = byte</span><br><span class="line">[S = short</span><br><span class="line">[I = int</span><br><span class="line">[J = long</span><br><span class="line">[F = float</span><br><span class="line">[D = double</span><br><span class="line">[C = char</span><br><span class="line">[L = any non-primitives(Object)</span><br></pre></td></tr></table></figure>
<p>在frida利用如下方式输出比特数组：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">for (i=0;i&lt;arg1.length;i++)</span><br><span class="line">   &#123;</span><br><span class="line">       b=(arg1[i]&gt;&gt;&gt;0)&amp;0xff;</span><br><span class="line">       n=b.toString(16);</span><br><span class="line">       hexstr += (&quot;00&quot; + n).slice(-2)+&quot; &quot;;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>完整jscode:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">Java.perform(<span class="function"><span class="keyword">function</span> <span class="title">x</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Function to hook is defined here</span></span><br><span class="line">    <span class="keyword">var</span> UtiEncrypt = Java.use(<span class="string">'com.bianlidai123.bc.encrypt.UtiEncrypt'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Whenever button is clicked</span></span><br><span class="line">    UtiEncrypt.decryptAES.overload(<span class="string">'java.lang.String'</span>).implementation = <span class="function"><span class="keyword">function</span> (<span class="params">arg1</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// Show a message to know that the function got called</span></span><br><span class="line">       </span><br><span class="line"></span><br><span class="line">       <span class="keyword">var</span> sign=<span class="keyword">this</span>.decryptAES(arg1);</span><br><span class="line">             </span><br><span class="line">       send(<span class="string">"arg1:"</span>+arg1);</span><br><span class="line">       send(<span class="string">"sign:"</span>+sign);</span><br><span class="line">       <span class="keyword">return</span> sign;</span><br><span class="line">       </span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> Cipher = Java.use(<span class="string">'javax.crypto.Cipher'</span>);</span><br><span class="line">    Cipher.getInstance.overload(<span class="string">'java.lang.String'</span>).implementation = <span class="function"><span class="keyword">function</span> (<span class="params">arg1</span>) </span>&#123;</span><br><span class="line">         <span class="keyword">var</span> sign2=<span class="keyword">this</span>.getInstance(arg1);</span><br><span class="line">         send(<span class="string">"Instance:"</span>+arg1);</span><br><span class="line">         <span class="keyword">return</span> sign2;</span><br><span class="line">    </span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> SecretKeySpec = Java.use(<span class="string">'javax.crypto.spec.SecretKeySpec'</span>);</span><br><span class="line">    SecretKeySpec.$init.overload(<span class="string">'[B'</span>, <span class="string">'java.lang.String'</span>).implementation = <span class="function"><span class="keyword">function</span> (<span class="params">arg1,arg2</span>) </span>&#123;</span><br><span class="line">     hexstr=<span class="string">""</span>;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;arg1.length;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        b=(arg1[i]&gt;&gt;&gt;<span class="number">0</span>)&amp;<span class="number">0xff</span>;</span><br><span class="line">        n=b.toString(<span class="number">16</span>);</span><br><span class="line">        hexstr += (<span class="string">"00"</span> + n).slice(<span class="number">-2</span>)+<span class="string">" "</span>;</span><br><span class="line">    &#125;</span><br><span class="line">        send(<span class="string">"Key: "</span> + hexstr);</span><br><span class="line">      <span class="comment">//send("init1:"+arg1+arg2);</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.$init(arg1,arg2);</span><br><span class="line">    </span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> IvParameterSpec = Java.use(<span class="string">'javax.crypto.spec.IvParameterSpec'</span>);</span><br><span class="line">    IvParameterSpec.$init.overload(<span class="string">'[B'</span>).implementation = <span class="function"><span class="keyword">function</span> (<span class="params">arg1</span>) </span>&#123;</span><br><span class="line">    hexstr=<span class="string">""</span>;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;arg1.length;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        b=(arg1[i]&gt;&gt;&gt;<span class="number">0</span>)&amp;<span class="number">0xff</span>;</span><br><span class="line">        n=b.toString(<span class="number">16</span>);</span><br><span class="line">        hexstr += (<span class="string">"00"</span> + n).slice(<span class="number">-2</span>)+<span class="string">" "</span>;</span><br><span class="line">    &#125;</span><br><span class="line">        send(<span class="string">"Iv: "</span> + hexstr);</span><br><span class="line">      <span class="comment">//send("init4:"+arg1);</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.$init(arg1);</span><br><span class="line">    </span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3><span id="hook-java原生算法同时打印调用堆栈">hook java原生算法同时打印调用堆栈</span></h3><p>如下脚本可以hook java原生MD5、MAC、DES、AES、RSA加密算法并打印出调用堆栈，简单暴力。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> frida, sys</span><br><span class="line"> </span><br><span class="line">jsCode = <span class="string">"""</span></span><br><span class="line"><span class="string">function showStacks() &#123;</span></span><br><span class="line"><span class="string">    Java.perform(function() &#123;</span></span><br><span class="line"><span class="string">        send(Java.use("android.util.Log").getStackTraceString(Java.use("java.lang.Exception").$new()));</span></span><br><span class="line"><span class="string">    &#125;);</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">function bytesToHex(arr) &#123;</span></span><br><span class="line"><span class="string">    var str = "";</span></span><br><span class="line"><span class="string">    for (var i = 0; i &lt; arr.length; i++) &#123;</span></span><br><span class="line"><span class="string">        var tmp = arr[i];</span></span><br><span class="line"><span class="string">        if (tmp &lt; 0) &#123;</span></span><br><span class="line"><span class="string">            tmp = (255 + tmp + 1).toString(16);</span></span><br><span class="line"><span class="string">        &#125; else &#123;</span></span><br><span class="line"><span class="string">            tmp = tmp.toString(16);</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        if (tmp.length == 1) &#123;</span></span><br><span class="line"><span class="string">            tmp = "0" + tmp;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        str += tmp;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    return str;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">function bytesToBase64(e) &#123;</span></span><br><span class="line"><span class="string">    var base64EncodeChars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/';</span></span><br><span class="line"><span class="string">    var r, a, c, h, o, t;</span></span><br><span class="line"><span class="string">    for (c = e.length, a = 0, r = ''; a &lt; c;) &#123;</span></span><br><span class="line"><span class="string">        if (h = 255 &amp; e[a++], a == c) &#123;</span></span><br><span class="line"><span class="string">            r += base64EncodeChars.charAt(h &gt;&gt; 2),</span></span><br><span class="line"><span class="string">            r += base64EncodeChars.charAt((3 &amp; h) &lt;&lt; 4),</span></span><br><span class="line"><span class="string">            r += '==';</span></span><br><span class="line"><span class="string">            break</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        if (o = e[a++], a == c) &#123;</span></span><br><span class="line"><span class="string">            r += base64EncodeChars.charAt(h &gt;&gt; 2),</span></span><br><span class="line"><span class="string">            r += base64EncodeChars.charAt((3 &amp; h) &lt;&lt; 4 | (240 &amp; o) &gt;&gt; 4),</span></span><br><span class="line"><span class="string">            r += base64EncodeChars.charAt((15 &amp; o) &lt;&lt; 2),</span></span><br><span class="line"><span class="string">            r += '=';</span></span><br><span class="line"><span class="string">            break</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        t = e[a++],</span></span><br><span class="line"><span class="string">        r += base64EncodeChars.charAt(h &gt;&gt; 2),</span></span><br><span class="line"><span class="string">        r += base64EncodeChars.charAt((3 &amp; h) &lt;&lt; 4 | (240 &amp; o) &gt;&gt; 4),</span></span><br><span class="line"><span class="string">        r += base64EncodeChars.charAt((15 &amp; o) &lt;&lt; 2 | (192 &amp; t) &gt;&gt; 6),</span></span><br><span class="line"><span class="string">        r += base64EncodeChars.charAt(63 &amp; t)</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    return r</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">function bytesToString(arr) &#123;</span></span><br><span class="line"><span class="string">    if (typeof arr === 'string') &#123;</span></span><br><span class="line"><span class="string">        return arr;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    var str = '',</span></span><br><span class="line"><span class="string">    _arr = arr;</span></span><br><span class="line"><span class="string">    for (var i = 0; i &lt; _arr.length; i++) &#123;</span></span><br><span class="line"><span class="string">        var one = _arr[i].toString(2),</span></span><br><span class="line"><span class="string">        v = one.match(/^1+?(?=0)/);</span></span><br><span class="line"><span class="string">        if (v &amp;&amp; one.length == 8) &#123;</span></span><br><span class="line"><span class="string">            var bytesLength = v[0].length;</span></span><br><span class="line"><span class="string">            var store = _arr[i].toString(2).slice(7 - bytesLength);</span></span><br><span class="line"><span class="string">            for (var st = 1; st &lt; bytesLength; st++) &#123;</span></span><br><span class="line"><span class="string">                store += _arr[st + i].toString(2).slice(2);</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">            str += String.fromCharCode(parseInt(store, 2));</span></span><br><span class="line"><span class="string">            i += bytesLength - 1;</span></span><br><span class="line"><span class="string">        &#125; else &#123;</span></span><br><span class="line"><span class="string">            str += String.fromCharCode(_arr[i]);</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    return str;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Java.perform(function () &#123;</span></span><br><span class="line"><span class="string">    var secretKeySpec = Java.use('javax.crypto.spec.SecretKeySpec');</span></span><br><span class="line"><span class="string">    secretKeySpec.$init.overload('[B','java.lang.String').implementation = function (a,b) &#123;</span></span><br><span class="line"><span class="string">        showStacks();</span></span><br><span class="line"><span class="string">        var result = this.$init(a, b);</span></span><br><span class="line"><span class="string">        send("======================================");</span></span><br><span class="line"><span class="string">        send("算法名：" + b + "|Dec密钥:" + bytesToString(a));</span></span><br><span class="line"><span class="string">        send("算法名：" + b + "|Hex密钥:" + bytesToHex(a));</span></span><br><span class="line"><span class="string">        return result;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    var mac = Java.use('javax.crypto.Mac');</span></span><br><span class="line"><span class="string">    mac.getInstance.overload('java.lang.String').implementation = function (a) &#123;</span></span><br><span class="line"><span class="string">        showStacks();</span></span><br><span class="line"><span class="string">        var result = this.getInstance(a);</span></span><br><span class="line"><span class="string">        send("======================================");</span></span><br><span class="line"><span class="string">        send("算法名：" + a);</span></span><br><span class="line"><span class="string">        return result;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    mac.update.overload('[B').implementation = function (a) &#123;</span></span><br><span class="line"><span class="string">        showStacks();</span></span><br><span class="line"><span class="string">        this.update(a);</span></span><br><span class="line"><span class="string">        send("======================================");</span></span><br><span class="line"><span class="string">        send("update:" + bytesToString(a))</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    mac.update.overload('[B','int','int').implementation = function (a,b,c) &#123;</span></span><br><span class="line"><span class="string">        showStacks();</span></span><br><span class="line"><span class="string">        this.update(a,b,c)</span></span><br><span class="line"><span class="string">        send("======================================");</span></span><br><span class="line"><span class="string">        send("update:" + bytesToString(a) + "|" + b + "|" + c);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    mac.doFinal.overload().implementation = function () &#123;</span></span><br><span class="line"><span class="string">        showStacks();</span></span><br><span class="line"><span class="string">        var result = this.doFinal();</span></span><br><span class="line"><span class="string">        send("======================================");</span></span><br><span class="line"><span class="string">        send("doFinal结果(hex):" + bytesToHex(result));</span></span><br><span class="line"><span class="string">        send("doFinal结果(base64):" + bytesToBase64(result));</span></span><br><span class="line"><span class="string">        return result;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    mac.doFinal.overload('[B').implementation = function (a) &#123;</span></span><br><span class="line"><span class="string">        showStacks();</span></span><br><span class="line"><span class="string">        var result = this.doFinal(a);</span></span><br><span class="line"><span class="string">        send("======================================");</span></span><br><span class="line"><span class="string">        send("doFinal参数:" + bytesToString(a));</span></span><br><span class="line"><span class="string">        send("doFinal结果(hex):" + bytesToHex(result));</span></span><br><span class="line"><span class="string">        send("doFinal结果(base):" + bytesToBase64(result));</span></span><br><span class="line"><span class="string">        return result;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">        var md = Java.use('java.security.MessageDigest');</span></span><br><span class="line"><span class="string">    md.getInstance.overload('java.lang.String','java.lang.String').implementation = function (a,b) &#123;</span></span><br><span class="line"><span class="string">        showStacks();</span></span><br><span class="line"><span class="string">        send("======================================");</span></span><br><span class="line"><span class="string">        send("算法名：" + a);</span></span><br><span class="line"><span class="string">        return this.getInstance(a, b);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    md.getInstance.overload('java.lang.String').implementation = function (a) &#123;</span></span><br><span class="line"><span class="string">        showStacks();</span></span><br><span class="line"><span class="string">        send("======================================");</span></span><br><span class="line"><span class="string">        send("算法名：" + a);</span></span><br><span class="line"><span class="string">        return this.getInstance(a);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    md.update.overload('[B').implementation = function (a) &#123;</span></span><br><span class="line"><span class="string">        showStacks();</span></span><br><span class="line"><span class="string">        send("======================================");</span></span><br><span class="line"><span class="string">        send("update:" + bytesToString(a))</span></span><br><span class="line"><span class="string">        return this.update(a);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    md.update.overload('[B','int','int').implementation = function (a,b,c) &#123;</span></span><br><span class="line"><span class="string">        showStacks();</span></span><br><span class="line"><span class="string">        send("======================================");</span></span><br><span class="line"><span class="string">        send("update:" + bytesToString(a) + "|" + b + "|" + c);</span></span><br><span class="line"><span class="string">        return this.update(a,b,c);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    md.digest.overload().implementation = function () &#123;</span></span><br><span class="line"><span class="string">        showStacks();</span></span><br><span class="line"><span class="string">        send("======================================");</span></span><br><span class="line"><span class="string">        var result = this.digest();</span></span><br><span class="line"><span class="string">        send("digest结果(hex):" + bytesToHex(result));</span></span><br><span class="line"><span class="string">        send("digest结果(base64):" + bytesToBase64(result));</span></span><br><span class="line"><span class="string">        return result;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    md.digest.overload('[B').implementation = function (a) &#123;</span></span><br><span class="line"><span class="string">        showStacks();</span></span><br><span class="line"><span class="string">        send("======================================");</span></span><br><span class="line"><span class="string">        send("digest参数:" + bytesToString(a));</span></span><br><span class="line"><span class="string">        var result = this.digest(a);</span></span><br><span class="line"><span class="string">        send("digest结果(hex):" + bytesToHex(result));</span></span><br><span class="line"><span class="string">        send("digest结果(base64):" + bytesToBase64(result));</span></span><br><span class="line"><span class="string">        return result;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">        var ivParameterSpec = Java.use('javax.crypto.spec.IvParameterSpec');</span></span><br><span class="line"><span class="string">    ivParameterSpec.$init.overload('[B').implementation = function (a) &#123;</span></span><br><span class="line"><span class="string">        showStacks();</span></span><br><span class="line"><span class="string">        var result = this.$init(a);</span></span><br><span class="line"><span class="string">        send("======================================");</span></span><br><span class="line"><span class="string">        send("iv向量:" + bytesToString(a));</span></span><br><span class="line"><span class="string">        send("iv向量(hex):" + bytesToHex(a));</span></span><br><span class="line"><span class="string">        return result;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    var cipher = Java.use('javax.crypto.Cipher');</span></span><br><span class="line"><span class="string">    cipher.getInstance.overload('java.lang.String').implementation = function (a) &#123;</span></span><br><span class="line"><span class="string">        showStacks();</span></span><br><span class="line"><span class="string">        var result = this.getInstance(a);</span></span><br><span class="line"><span class="string">        send("======================================");</span></span><br><span class="line"><span class="string">        send("模式填充:" + a);</span></span><br><span class="line"><span class="string">        return result;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    cipher.update.overload('[B').implementation = function (a) &#123;</span></span><br><span class="line"><span class="string">        showStacks();</span></span><br><span class="line"><span class="string">        var result = this.update(a);</span></span><br><span class="line"><span class="string">        send("======================================");</span></span><br><span class="line"><span class="string">        send("update:" + bytesToString(a));</span></span><br><span class="line"><span class="string">        return result;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    cipher.update.overload('[B','int','int').implementation = function (a,b,c) &#123;</span></span><br><span class="line"><span class="string">        showStacks();</span></span><br><span class="line"><span class="string">        var result = this.update(a,b,c);</span></span><br><span class="line"><span class="string">        send("======================================");</span></span><br><span class="line"><span class="string">        send("update:" + bytesToString(a) + "|" + b + "|" + c);</span></span><br><span class="line"><span class="string">        return result;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    cipher.doFinal.overload().implementation = function () &#123;</span></span><br><span class="line"><span class="string">        showStacks();</span></span><br><span class="line"><span class="string">        var result = this.doFinal();</span></span><br><span class="line"><span class="string">        send("======================================");</span></span><br><span class="line"><span class="string">        send("doFinal结果(hex):" + bytesToHex(result));</span></span><br><span class="line"><span class="string">        send("doFinal结果(base64):" + bytesToBase64(result));</span></span><br><span class="line"><span class="string">        return result;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    cipher.doFinal.overload('[B').implementation = function (a) &#123;</span></span><br><span class="line"><span class="string">        showStacks();</span></span><br><span class="line"><span class="string">        var result = this.doFinal(a);</span></span><br><span class="line"><span class="string">        send("======================================");</span></span><br><span class="line"><span class="string">        send("doFinal参数:" + bytesToString(a));</span></span><br><span class="line"><span class="string">        send("doFinal结果(hex):" + bytesToHex(result));</span></span><br><span class="line"><span class="string">        send("doFinal结果(base64):" + bytesToBase64(result));</span></span><br><span class="line"><span class="string">        return result;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    var x509EncodedKeySpec = Java.use('java.security.spec.X509EncodedKeySpec');</span></span><br><span class="line"><span class="string">    x509EncodedKeySpec.$init.overload('[B').implementation = function (a) &#123;</span></span><br><span class="line"><span class="string">        showStacks();</span></span><br><span class="line"><span class="string">        var result = this.$init(a);</span></span><br><span class="line"><span class="string">        send("======================================");</span></span><br><span class="line"><span class="string">        send("RSA密钥:" + bytesToBase64(a));</span></span><br><span class="line"><span class="string">        return result;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    var rSAPublicKeySpec = Java.use('java.security.spec.RSAPublicKeySpec');</span></span><br><span class="line"><span class="string">    rSAPublicKeySpec.$init.overload('java.math.BigInteger','java.math.BigInteger').implementation = function (a,b) &#123;</span></span><br><span class="line"><span class="string">        showStacks();</span></span><br><span class="line"><span class="string">        var result = this.$init(a,b);</span></span><br><span class="line"><span class="string">        send("======================================");</span></span><br><span class="line"><span class="string">        //send("RSA密钥:" + bytesToBase64(a));</span></span><br><span class="line"><span class="string">        send("RSA密钥N:" + a.toString(16));</span></span><br><span class="line"><span class="string">        send("RSA密钥E:" + b.toString(16));</span></span><br><span class="line"><span class="string">        return result;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;);</span></span><br><span class="line"><span class="string">"""</span>;</span><br><span class="line"> </span><br><span class="line">fw = open(sys.argv[<span class="number">1</span>],<span class="string">'w+'</span>,encoding=<span class="string">'utf-8'</span>)</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">message</span><span class="params">(message, data)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> message[<span class="string">"type"</span>] == <span class="string">'send'</span>:</span><br><span class="line">        print(<span class="string">u"[*] &#123;0&#125;"</span>.format(message[<span class="string">'payload'</span>]))</span><br><span class="line">        fw.write(<span class="string">u"[*] &#123;0&#125;\n"</span>.format(message[<span class="string">'payload'</span>]))</span><br><span class="line">        fw.flush()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(message)</span><br><span class="line"> </span><br><span class="line">process = frida.get_remote_device().attach(sys.argv[<span class="number">1</span>])</span><br><span class="line">script= process.create_script(jsCode)</span><br><span class="line">script.on(<span class="string">"message"</span>, message)</span><br><span class="line">script.load()</span><br><span class="line">sys.stdin.read()</span><br></pre></td></tr></table></figure>
<p><code>python frida-hook.py com.faloo.BookReader4Android</code>脚本加上包名，即可hook所有原生方法。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com\1578403900989.png" alt="1578403900989"></p>
<p>如图某APP登录处，从<code>burp</code>里的流量记录，流量被加密了，在hook脚本中也打印了该段加密数据。</p>
<p>该脚本会在同目录下生成同包名的文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">[*] ======================================</span><br><span class="line">[*] 算法名：AES|Dec密钥:DD240BF148903189BF8DAE0C220C9591</span><br><span class="line">[*] 算法名：AES|Hex密钥:4444323430424631343839303331383942463844414530433232304339353931</span><br><span class="line">[*] java.lang.Exception</span><br><span class="line">	at javax.crypto.Cipher.getInstance(Native Method)</span><br><span class="line">	at com.faloo.util.AES.encrypt(Proguard:211)</span><br><span class="line">	at com.faloo.util.EncryptUtil._e18(Native Method)</span><br><span class="line">	at com.faloo.util.EncryptUtil.getAESEncrypt(Proguard:150)</span><br><span class="line">	at com.faloo.network.module.b.a(Proguard:49)</span><br><span class="line">	at com.faloo.network.util.e.a(Proguard:174)</span><br><span class="line">	at com.faloo.network.service.a.c.a(Proguard:141)</span><br><span class="line">	at com.faloo.app.activity.LoginPageActivity$13.a(Proguard:941)</span><br><span class="line">	at io.reactivex.internal.operators.observable.ObservableCreate.b(Proguard:40)</span><br><span class="line">	at io.reactivex.e.a(Proguard:11194)</span><br><span class="line">	at io.reactivex.internal.operators.observable.ObservableSubscribeOn$a.run(Proguard:96)</span><br><span class="line">	at io.reactivex.k$a.run(Proguard:463)</span><br><span class="line">	at io.reactivex.internal.schedulers.ScheduledRunnable.run(Proguard:66)</span><br><span class="line">	at io.reactivex.internal.schedulers.ScheduledRunnable.call(Proguard:57)</span><br><span class="line">	at java.util.concurrent.FutureTask.run(FutureTask.java:237)</span><br><span class="line">	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$201(ScheduledThreadPoolExecutor.java:152)</span><br><span class="line">	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:265)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1112)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:587)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:818)</span><br><span class="line"></span><br><span class="line">[*] ======================================</span><br><span class="line">[*] 模式填充:AES/CBC/PKCS5Padding</span><br><span class="line">[*] java.lang.Exception</span><br><span class="line">	at javax.crypto.spec.IvParameterSpec.&lt;init&gt;(Native Method)</span><br><span class="line">	at com.faloo.util.AES.encrypt(Proguard:212)</span><br><span class="line">	at com.faloo.util.EncryptUtil._e18(Native Method)</span><br><span class="line">	at com.faloo.util.EncryptUtil.getAESEncrypt(Proguard:150)</span><br><span class="line">	at com.faloo.network.module.b.a(Proguard:49)</span><br><span class="line">	at com.faloo.network.util.e.a(Proguard:174)</span><br><span class="line">	at com.faloo.network.service.a.c.a(Proguard:141)</span><br><span class="line">	at com.faloo.app.activity.LoginPageActivity$13.a(Proguard:941)</span><br><span class="line">	at io.reactivex.internal.operators.observable.ObservableCreate.b(Proguard:40)</span><br><span class="line">	at io.reactivex.e.a(Proguard:11194)</span><br><span class="line">	at io.reactivex.internal.operators.observable.ObservableSubscribeOn$a.run(Proguard:96)</span><br><span class="line">	at io.reactivex.k$a.run(Proguard:463)</span><br><span class="line">	at io.reactivex.internal.schedulers.ScheduledRunnable.run(Proguard:66)</span><br><span class="line">	at io.reactivex.internal.schedulers.ScheduledRunnable.call(Proguard:57)</span><br><span class="line">	at java.util.concurrent.FutureTask.run(FutureTask.java:237)</span><br><span class="line">	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$201(ScheduledThreadPoolExecutor.java:152)</span><br><span class="line">	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:265)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1112)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:587)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:818)</span><br><span class="line"></span><br><span class="line">[*] ======================================</span><br><span class="line">[*] iv向量:                </span><br><span class="line">[*] iv向量(hex):00000000000000000000000000000000</span><br><span class="line">[*] java.lang.Exception</span><br><span class="line">	at javax.crypto.Cipher.doFinal(Native Method)</span><br><span class="line">	at com.faloo.util.AES.encrypt(Proguard:213)</span><br><span class="line">	at com.faloo.util.EncryptUtil._e18(Native Method)</span><br><span class="line">	at com.faloo.util.EncryptUtil.getAESEncrypt(Proguard:150)</span><br><span class="line">	at com.faloo.network.module.b.a(Proguard:49)</span><br><span class="line">	at com.faloo.network.util.e.a(Proguard:174)</span><br><span class="line">	at com.faloo.network.service.a.c.a(Proguard:141)</span><br><span class="line">	at com.faloo.app.activity.LoginPageActivity$13.a(Proguard:941)</span><br><span class="line">	at io.reactivex.internal.operators.observable.ObservableCreate.b(Proguard:40)</span><br><span class="line">	at io.reactivex.e.a(Proguard:11194)</span><br><span class="line">	at io.reactivex.internal.operators.observable.ObservableSubscribeOn$a.run(Proguard:96)</span><br><span class="line">	at io.reactivex.k$a.run(Proguard:463)</span><br><span class="line">	at io.reactivex.internal.schedulers.ScheduledRunnable.run(Proguard:66)</span><br><span class="line">	at io.reactivex.internal.schedulers.ScheduledRunnable.call(Proguard:57)</span><br><span class="line">	at java.util.concurrent.FutureTask.run(FutureTask.java:237)</span><br><span class="line">	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$201(ScheduledThreadPoolExecutor.java:152)</span><br><span class="line">	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:265)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1112)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:587)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:818)</span><br><span class="line"></span><br><span class="line">[*] ======================================</span><br><span class="line">[*] doFinal参数:num=0&amp;userid=1388888888&amp;Password=9c9c5f3bff756cf5395265b6c5f0d8f0&amp;tid=2&amp;ts=1578400865589&amp;nonce=fb4f89a9464e3a318111b337f92a9f1c&amp;resign=e8ca11ce1d27aa18ed6840617b8cbcf7&amp;pwdcode=YTEyMzQ1Ng==</span><br><span class="line">&amp;time=2020-01-07 21:31:33&amp;wt=1&amp;uuid=77a0332f1ca14daf9337f941bcc86e70&amp;appversion=3.4.8&amp;Type=Android&amp;xp=0</span><br><span class="line">[*] doFinal结果(hex):5a2439af1041cdd1bd1df38a9d6107932190b83cf6be7610cc54767ee4c97bb6236dc4e9d4b00e7408b9add01d8f9423eebd8d75386c20c1c84f8751104f50c9408f2b28af82d3eab9c56b442984c399d65581bdf68815dea6430166767e8538ba7349846e87ed1322b79066e7dac527587c0c7d9950046e63a87af64ce479e5113fcdfe3f35d0a40f8bdc917142d943ad0224bf0315c967fb969abb2178a1c764e311c67aaaebd6d69362a7fdf2bb64040db54443572fa897cd1733ef9dcd4733a35881083082ebdd2cc41a8d169de824b621e73445b3a5004fccd4b091095f0f2c2efc87116f82723c6e59c7c379c2a0eeeecb6c0deefdda2b1581b5a0e56c7ba7f1eaca8f59acae5a2e5c24d5dc72736a1fc1c0cb7e68336b3365ad250e00f89ba09971403c2ed265a2cd62a9fdc4</span><br><span class="line">[*] doFinal结果(base64):WiQ5rxBBzdG9HfOKnWEHkyGQuDz2vnYQzFR2fuTJe7YjbcTp1LAOdAi5rdAdj5Qj7r2NdThsIMHIT4dREE9QyUCPKyivgtPqucVrRCmEw5nWVYG99ogV3qZDAWZ2foU4unNJhG6H7RMit5Bm59rFJ1h8DH2ZUARuY6h69kzkeeURP83+PzXQpA+L3JFxQtlDrQIkvwMVyWf7lpq7IXihx2TjEcZ6quvW1pNip/3yu2QEDbVEQ1cvqJfNFzPvnc1HM6NYgQgwguvdLMQajRad6CS2Iec0RbOlAE/M1LCRCV8PLC78hxFvgnI8blnHw3nCoO7uy2wN7v3aKxWBtaDlbHun8erKj1msrlouXCTV3HJzah/BwMt+aDNrM2WtJQ4A+JugmXFAPC7SZaLNYqn9xA==</span><br></pre></td></tr></table></figure>
<p>如下数据是最终加密的结果，即发给服务器的数据。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WiQ5rxBBzdG9HfOKnWEHkyGQuDz2vnYQzFR2fuTJe7YjbcTp1LAOdAi5rdAdj5Qj7r2NdThsIMHIT4dREE9QyUCPKyivgtPqucVrRCmEw5nWVYG99ogV3qZDAWZ2foU4unNJhG6H7RMit5Bm59rFJ1h8DH2ZUARuY6h69kzkeeURP83+PzXQpA+L3JFxQtlDrQIkvwMVyWf7lpq7IXihx2TjEcZ6quvW1pNip/3yu2QEDbVEQ1cvqJfNFzPvnc1HM6NYgQgwguvdLMQajRad6CS2Iec0RbOlAE/M1LCRCV8PLC78hxFvgnI8blnHw3nCoO7uy2wN7v3aKxWBtaDlbHun8erKj1msrlouXCTV3HJzah/BwMt+aDNrM2WtJQ4A+JugmXFAPC7SZaLNYqn9xA==</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com\1578407350853.png" alt="1578407350853"></p>
<p>这里hook到了加密算法和密钥</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[*] 算法名：AES|Dec密钥:DD240BF148903189BF8DAE0C220C9591</span><br><span class="line">[*] 算法名：AES|Hex密钥:4444323430424631343839303331383942463844414530433232304339353931</span><br></pre></td></tr></table></figure>
<p>偏移模式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">模式填充:AES/CBC/PKCS5Padding</span><br></pre></td></tr></table></figure>
<p>iv向量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iv向量(hex):00000000000000000000000000000000</span><br></pre></td></tr></table></figure>
<h4><span id="password加密过程分析">Password加密过程分析</span></h4><p>输出中可以看到其加密之前的数据为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">num=0&amp;userid=1388888888&amp;Password=9c9c5f3bff756cf5395265b6c5f0d8f0&amp;tid=2&amp;ts=1578400865589&amp;nonce=fb4f89a9464e3a318111b337f92a9f1c&amp;resign=e8ca11ce1d27aa18ed6840617b8cbcf7&amp;pwdcode=YTEyMzQ1Ng==</span><br><span class="line">&amp;time=2020-01-07 21:31:33&amp;wt=1&amp;uuid=77a0332f1ca14daf9337f941bcc86e70&amp;appversion=3.4.8&amp;Type=Android&amp;xp=0</span><br></pre></td></tr></table></figure>
<p>数据中userid为用户名，Password为密码，这里的密码是密文<code>9c9c5f3bff756cf5395265b6c5f0d8f0</code>，这里并不知道是什么密文。此密文并非输入的密码的md5值。在输出中我们可以直接搜索这一段密文。</p>
<p>搜索到<code>9c9c5f3bff756cf5395265b6c5f0d8f0</code>为如下输出结果。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[*] ======================================</span><br><span class="line">[*] update:@345Kie(873_dfbKe&gt;d3&lt;.d23432=d67d5e705490b20f8d8a3c8731d4c535</span><br><span class="line">[*] java.lang.Exception</span><br><span class="line">	at java.security.MessageDigest.digest(Native Method)</span><br><span class="line">	at java.security.MessageDigest.digest(MessageDigest.java:278)</span><br><span class="line">	at java.security.MessageDigest.digest(Native Method)</span><br><span class="line">	at com.faloo.network.util.MD5.MD5(Proguard:22)</span><br><span class="line">	at com.faloo.util.EncryptUtil._e16(Native Method)</span><br><span class="line">	at com.faloo.util.EncryptUtil.EncryptPwd(Proguard:23)</span><br><span class="line">	at com.faloo.network.service.a.c.a(Proguard:119)</span><br><span class="line">	at com.faloo.app.activity.LoginPageActivity$13.a(Proguard:941)</span><br><span class="line">	at io.reactivex.internal.operators.observable.ObservableCreate.b(Proguard:40)</span><br><span class="line">	at io.reactivex.e.a(Proguard:11194)</span><br><span class="line">	at io.reactivex.internal.operators.observable.ObservableSubscribeOn$a.run(Proguard:96)</span><br><span class="line">	at io.reactivex.k$a.run(Proguard:463)</span><br><span class="line">	at io.reactivex.internal.schedulers.ScheduledRunnable.run(Proguard:66)</span><br><span class="line">	at io.reactivex.internal.schedulers.ScheduledRunnable.call(Proguard:57)</span><br><span class="line">	at java.util.concurrent.FutureTask.run(FutureTask.java:237)</span><br><span class="line">	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$201(ScheduledThreadPoolExecutor.java:152)</span><br><span class="line">	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:265)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1112)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:587)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:818)</span><br><span class="line"></span><br><span class="line">[*] ======================================</span><br><span class="line">[*] digest结果(hex):9c9c5f3bff756cf5395265b6c5f0d8f0</span><br><span class="line">[*] digest结果(base64):nJxfO/91bPU5UmW2xfDY8A==</span><br><span class="line">[*] digest结果(hex):9c9c5f3bff756cf5395265b6c5f0d8f0</span><br><span class="line">[*] digest结果(base64):nJxfO/91bPU5UmW2xfDY8A==</span><br></pre></td></tr></table></figure>
<p>在这个过程中输入的为<code>@345Kie(873_dfbKe&gt;d3&lt;.d23432=d67d5e705490b20f8d8a3c8731d4c535</code>输出的<code>9c9c5f3bff756cf5395265b6c5f0d8f0</code></p>
<p>通过md5加密对比如下图，发现此过程为md5加密过程。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com\1578404071511.png" alt="1578404071511"></p>
<p><code>@345Kie(873_dfbKe&gt;d3&lt;.d23432=d67d5e705490b20f8d8a3c8731d4c535</code>中，前一段<code>@345Kie(873_dfbKe&gt;d3&lt;.d23432=</code>并没有搜索到，可能为固定值拼接，通过多此测试发现确实为固定值拼接。故直接搜索后32位<code>d67d5e705490b20f8d8a3c8731d4c535</code>跟到如下输出过程。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[*] ======================================</span><br><span class="line">[*] update:EW234@![#$&amp;]*&#123;,OP&#125;Kd^w349Op+-32_a1234561578400865589</span><br><span class="line">[*] java.lang.Exception</span><br><span class="line">	at java.security.MessageDigest.digest(Native Method)</span><br><span class="line">	at java.security.MessageDigest.digest(MessageDigest.java:278)</span><br><span class="line">	at java.security.MessageDigest.digest(Native Method)</span><br><span class="line">	at com.faloo.network.util.MD5.MD5(Proguard:22)</span><br><span class="line">	at com.faloo.util.EncryptUtil._e16(Native Method)</span><br><span class="line">	at com.faloo.util.EncryptUtil.EncryptPwd(Proguard:23)</span><br><span class="line">	at com.faloo.network.service.a.c.a(Proguard:119)</span><br><span class="line">	at com.faloo.app.activity.LoginPageActivity$13.a(Proguard:941)</span><br><span class="line">	at io.reactivex.internal.operators.observable.ObservableCreate.b(Proguard:40)</span><br><span class="line">	at io.reactivex.e.a(Proguard:11194)</span><br><span class="line">	at io.reactivex.internal.operators.observable.ObservableSubscribeOn$a.run(Proguard:96)</span><br><span class="line">	at io.reactivex.k$a.run(Proguard:463)</span><br><span class="line">	at io.reactivex.internal.schedulers.ScheduledRunnable.run(Proguard:66)</span><br><span class="line">	at io.reactivex.internal.schedulers.ScheduledRunnable.call(Proguard:57)</span><br><span class="line">	at java.util.concurrent.FutureTask.run(FutureTask.java:237)</span><br><span class="line">	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$201(ScheduledThreadPoolExecutor.java:152)</span><br><span class="line">	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:265)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1112)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:587)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:818)</span><br><span class="line"></span><br><span class="line">[*] ======================================</span><br><span class="line">[*] digest结果(hex):d67d5e705490b20f8d8a3c8731d4c535</span><br><span class="line">[*] digest结果(base64):1n1ecFSQsg+NijyHMdTFNQ==</span><br><span class="line">[*] digest结果(hex):d67d5e705490b20f8d8a3c8731d4c535</span><br><span class="line">[*] digest结果(base64):1n1ecFSQsg+NijyHMdTFNQ==</span><br></pre></td></tr></table></figure>
<p>如上输入为<code>EW234@![#$&amp;]*{,OP}Kd^w349Op+-32_a1234561578400865589</code>输出为<code>d67d5e705490b20f8d8a3c8731d4c535</code>。这里<code>EW234@![#$&amp;]*{,OP}Kd^w349Op+-32_</code>同样为固定值，<code>a123456</code>为我们输入的密码，<code>1578400865589</code>为时间戳。此过程为MD5加密</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com\1578404464976.png" alt="1578404464976"></p>
<p>至此我们可以获取到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">num=0&amp;userid=1388888888&amp;Password=9c9c5f3bff756cf5395265b6c5f0d8f0&amp;tid=2&amp;ts=1578400865589&amp;nonce=fb4f89a9464e3a318111b337f92a9f1c&amp;resign=e8ca11ce1d27aa18ed6840617b8cbcf7&amp;pwdcode=YTEyMzQ1Ng==</span><br><span class="line">&amp;time=2020-01-07 21:31:33&amp;wt=1&amp;uuid=77a0332f1ca14daf9337f941bcc86e70&amp;appversion=3.4.8&amp;Type=Android&amp;xp=0</span><br></pre></td></tr></table></figure>
<p>aes加密前的数据中password的加密过程：</p>
<p>大致流程为：</p>
<ol>
<li>string1 = <code>EW234@![#$&amp;]*{,OP}Kd^w349Op+-32_</code>+<code>密码</code>+时间戳，对string1进行md5加密</li>
<li>对md5(string1)前拼接@345Kie(873_dfbKe&gt;d3&lt;.d23432=，再进行一次MD5加密得到最后的password加密值。</li>
</ol>
<h4><span id="once加密过程分析">once加密过程分析</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">num=0&amp;userid=1388888888&amp;Password=9c9c5f3bff756cf5395265b6c5f0d8f0&amp;tid=2&amp;ts=1578400865589&amp;nonce=fb4f89a9464e3a318111b337f92a9f1c&amp;resign=e8ca11ce1d27aa18ed6840617b8cbcf7&amp;pwdcode=YTEyMzQ1Ng==</span><br><span class="line">&amp;time=2020-01-07 21:31:33&amp;wt=1&amp;uuid=77a0332f1ca14daf9337f941bcc86e70&amp;appversion=3.4.8&amp;Type=Android&amp;xp=0</span><br></pre></td></tr></table></figure>
<p>如上数据中的ts为时间戳即加密用到的时间戳，客户端将此时间戳发给服务端，因为在密码加密中用到了这个时间戳，所以服务器进行密码对比的时候也要用到这个时间戳，所以这个时间戳是一一对应的。</p>
<p>once值<code>fb4f89a9464e3a318111b337f92a9f1c</code>同样的方法去搜索</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[*] update:1578400865530</span><br><span class="line">[*] java.lang.Exception</span><br><span class="line">	at java.security.MessageDigest.digest(Native Method)</span><br><span class="line">	at org.faloo.app.pay.a.a(Proguard:40)</span><br><span class="line">	at com.faloo.app.activity.LoginPageActivity.e(Proguard:483)</span><br><span class="line">	at com.faloo.app.activity.LoginPageActivity.b(Proguard:111)</span><br><span class="line">	at com.faloo.app.activity.LoginPageActivity$3.a(Proguard:531)</span><br><span class="line">	at com.faloo.app.activity.LoginPageActivity$3.onNext(Proguard:517)</span><br><span class="line">	at io.reactivex.internal.operators.observable.ObservableObserveOn$ObserveOnObserver.drainNormal(Proguard:200)</span><br><span class="line">	at io.reactivex.internal.operators.observable.ObservableObserveOn$ObserveOnObserver.run(Proguard:252)</span><br><span class="line">	at io.reactivex.android.b.b$b.run(Proguard:109)</span><br><span class="line">	at android.os.Handler.handleCallback(Handler.java:739)</span><br><span class="line">	at android.os.Handler.dispatchMessage(Handler.java:95)</span><br><span class="line">	at android.os.Looper.loop(Looper.java:135)</span><br><span class="line">	at android.app.ActivityThread.main(ActivityThread.java:5293)</span><br><span class="line">	at java.lang.reflect.Method.invoke(Native Method)</span><br><span class="line">	at java.lang.reflect.Method.invoke(Method.java:372)</span><br><span class="line">	at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:903)</span><br><span class="line">	at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:698)</span><br><span class="line"></span><br><span class="line">[*] ======================================</span><br><span class="line">[*] digest结果(hex):fb4f89a9464e3a318111b337f92a9f1c</span><br><span class="line">[*] digest结果(base64):+0+JqUZOOjGBEbM3+SqfHA==</span><br></pre></td></tr></table></figure>
<p>得到如上过程，输入<code>1578400865530</code>输出once值。同样为md5加密。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com\1578404968965.png" alt="1578404968965"></p>
<p>此时间戳并非在加密过程中用到，可能在后端并未做校验。</p>
<h4><span id="resign加密过程分析">resign加密过程分析</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">num=0&amp;userid=1388888888&amp;Password=9c9c5f3bff756cf5395265b6c5f0d8f0&amp;tid=2&amp;ts=1578400865589&amp;nonce=fb4f89a9464e3a318111b337f92a9f1c&amp;resign=e8ca11ce1d27aa18ed6840617b8cbcf7&amp;pwdcode=YTEyMzQ1Ng==</span><br><span class="line">&amp;time=2020-01-07 21:31:33&amp;wt=1&amp;uuid=77a0332f1ca14daf9337f941bcc86e70&amp;appversion=3.4.8&amp;Type=Android&amp;xp=0</span><br></pre></td></tr></table></figure>
<p>这个数据中还有一个<code>e8ca11ce1d27aa18ed6840617b8cbcf7</code>为resign签名值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[*] ======================================</span><br><span class="line">[*] update:a1f*(DV&lt;&gt;ME29p08adsfKQ@N&gt;FEP*(F&amp;G)&amp;B)R@PVDbvnTPFPSDFQ&gt;QM@o9i8t5P_)(SGB?9c9c5f3bff756cf5395265b6c5f0d8f0fb4f89a9464e3a318111b337f92a9f1c</span><br><span class="line">[*] java.lang.Exception</span><br><span class="line">	at java.security.MessageDigest.digest(Native Method)</span><br><span class="line">	at java.security.MessageDigest.digest(MessageDigest.java:278)</span><br><span class="line">	at java.security.MessageDigest.digest(Native Method)</span><br><span class="line">	at com.faloo.network.util.MD5.MD5(Proguard:22)</span><br><span class="line">	at com.faloo.util.EncryptUtil._e14(Native Method)</span><br><span class="line">	at com.faloo.util.EncryptUtil.EncryptRePwd(Proguard:46)</span><br><span class="line">	at com.faloo.network.service.a.c.a(Proguard:120)</span><br><span class="line">	at com.faloo.app.activity.LoginPageActivity$13.a(Proguard:941)</span><br><span class="line">	at io.reactivex.internal.operators.observable.ObservableCreate.b(Proguard:40)</span><br><span class="line">	at io.reactivex.e.a(Proguard:11194)</span><br><span class="line">	at io.reactivex.internal.operators.observable.ObservableSubscribeOn$a.run(Proguard:96)</span><br><span class="line">	at io.reactivex.k$a.run(Proguard:463)</span><br><span class="line">	at io.reactivex.internal.schedulers.ScheduledRunnable.run(Proguard:66)</span><br><span class="line">	at io.reactivex.internal.schedulers.ScheduledRunnable.call(Proguard:57)</span><br><span class="line">	at java.util.concurrent.FutureTask.run(FutureTask.java:237)</span><br><span class="line">	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$201(ScheduledThreadPoolExecutor.java:152)</span><br><span class="line">	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:265)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1112)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:587)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:818)</span><br><span class="line"></span><br><span class="line">[*] ======================================</span><br><span class="line">[*] digest结果(hex):e8ca11ce1d27aa18ed6840617b8cbcf7</span><br><span class="line">[*] digest结果(base64):6MoRzh0nqhjtaEBhe4y89w==</span><br><span class="line">[*] digest结果(hex):e8ca11ce1d27aa18ed6840617b8cbcf7</span><br><span class="line">[*] digest结果(base64):6MoRzh0nqhjtaEBhe4y89w==</span><br></pre></td></tr></table></figure>
<p>该签名与<code>a1f*(DV&lt;&gt;ME29p08adsfKQ@N&gt;FEP*(F&amp;G)&amp;B)R@PVDbvnTPFPSDFQ&gt;QM@o9i8t5P_)(SGB?9c9c5f3bff756cf5395265b6c5f0d8f0fb4f89a9464e3a318111b337f92a9f1c</code>有关。此过程也为MD5加密。其中一段为9c9c5f3bff756cf5395265b6c5f0d8f0为password值。<code>fb4f89a9464e3a318111b337f92a9f1c</code>为once值。前面的一段<code>a1f*(DV&lt;&gt;ME29p08adsfKQ@N&gt;FEP*(F&amp;G)&amp;B)R@PVDbvnTPFPSDFQ&gt;QM@o9i8t5P_)(SGB?</code>为固定值。</p>
<p>所以签名值resign为固定值+password+once然后进行md5加密。</p>
<p>而最后的值<code>uuid=77a0332f1ca14daf9337f941bcc86e70</code>可能为用户名标识或者手机设备识别码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">num=0&amp;userid=1388888888&amp;Password=9c9c5f3bff756cf5395265b6c5f0d8f0&amp;tid=2&amp;ts=1578400865589&amp;nonce=fb4f89a9464e3a318111b337f92a9f1c&amp;resign=e8ca11ce1d27aa18ed6840617b8cbcf7&amp;pwdcode=YTEyMzQ1Ng==</span><br><span class="line">&amp;time=2020-01-07 21:31:33&amp;wt=1&amp;uuid=77a0332f1ca14daf9337f941bcc86e70&amp;appversion=3.4.8&amp;Type=Android&amp;xp=0</span><br></pre></td></tr></table></figure>
<p>pwdcode值为<code>YTEyMzQ1Ng==</code>为密码的base64。</p>
<p>自此如上加密数据所有部分都通过hook输出内容进行了分析。</p>
<h4><span id="rsa加密过程分析">RSA加密过程分析</span></h4><p>在hook输出内容中还有，RSA加密过程。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">[*] ======================================</span><br><span class="line">[*] RSA密钥:MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCDiI/dCs429FC75NYnF82omzzAweej2VdpdaKP3DL0D/s3Hg7cnVTGBh6yRrKYI9cvBKorxdrCEaW0SXZYBH5nvmCg8qyzO8jBj08ISiukEQuqG2oS0L2sbcQl0MV7rExsyO0vlPpND7klBWikAIO1UfZW1ab/EWit1XkaXCr6nQIDAQAB</span><br><span class="line">[*] java.lang.Exception</span><br><span class="line">	at javax.crypto.Cipher.getInstance(Native Method)</span><br><span class="line">	at com.faloo.util.SignUtils.encrypt(Proguard:104)</span><br><span class="line">	at com.faloo.util.EncryptUtil._e8(Native Method)</span><br><span class="line">	at com.faloo.util.EncryptUtil.getRSAEncrypt(Proguard:166)</span><br><span class="line">	at com.faloo.network.module.b.d(Proguard:39)</span><br><span class="line">	at com.faloo.network.util.e.a(Proguard:101)</span><br><span class="line">	at com.faloo.network.service.a.c.a(Proguard:141)</span><br><span class="line">	at com.faloo.app.activity.LoginPageActivity$13.a(Proguard:941)</span><br><span class="line">	at io.reactivex.internal.operators.observable.ObservableCreate.b(Proguard:40)</span><br><span class="line">	at io.reactivex.e.a(Proguard:11194)</span><br><span class="line">	at io.reactivex.internal.operators.observable.ObservableSubscribeOn$a.run(Proguard:96)</span><br><span class="line">	at io.reactivex.k$a.run(Proguard:463)</span><br><span class="line">	at io.reactivex.internal.schedulers.ScheduledRunnable.run(Proguard:66)</span><br><span class="line">	at io.reactivex.internal.schedulers.ScheduledRunnable.call(Proguard:57)</span><br><span class="line">	at java.util.concurrent.FutureTask.run(FutureTask.java:237)</span><br><span class="line">	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$201(ScheduledThreadPoolExecutor.java:152)</span><br><span class="line">	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:265)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1112)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:587)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:818)</span><br><span class="line"></span><br><span class="line">[*] ======================================</span><br><span class="line">[*] 模式填充:RSA/ECB/PKCS1Padding</span><br><span class="line">[*] java.lang.Exception</span><br><span class="line">	at javax.crypto.Cipher.doFinal(Native Method)</span><br><span class="line">	at com.faloo.util.SignUtils.encrypt(Proguard:106)</span><br><span class="line">	at com.faloo.util.EncryptUtil._e8(Native Method)</span><br><span class="line">	at com.faloo.util.EncryptUtil.getRSAEncrypt(Proguard:166)</span><br><span class="line">	at com.faloo.network.module.b.d(Proguard:39)</span><br><span class="line">	at com.faloo.network.util.e.a(Proguard:101)</span><br><span class="line">	at com.faloo.network.service.a.c.a(Proguard:141)</span><br><span class="line">	at com.faloo.app.activity.LoginPageActivity$13.a(Proguard:941)</span><br><span class="line">	at io.reactivex.internal.operators.observable.ObservableCreate.b(Proguard:40)</span><br><span class="line">	at io.reactivex.e.a(Proguard:11194)</span><br><span class="line">	at io.reactivex.internal.operators.observable.ObservableSubscribeOn$a.run(Proguard:96)</span><br><span class="line">	at io.reactivex.k$a.run(Proguard:463)</span><br><span class="line">	at io.reactivex.internal.schedulers.ScheduledRunnable.run(Proguard:66)</span><br><span class="line">	at io.reactivex.internal.schedulers.ScheduledRunnable.call(Proguard:57)</span><br><span class="line">	at java.util.concurrent.FutureTask.run(FutureTask.java:237)</span><br><span class="line">	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$201(ScheduledThreadPoolExecutor.java:152)</span><br><span class="line">	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:265)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1112)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:587)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:818)</span><br><span class="line"></span><br><span class="line">[*] ======================================</span><br><span class="line">[*] doFinal参数:DD240BF148903189BF8DAE0C220C9591</span><br><span class="line">[*] doFinal结果(hex):028f36e0538d52fe0b243c02cc68fc1a8a741215e868ef500e87142a84850db9e8cbacbf2e4b77b0c5088b9879b3f99d0fd57b239ffa7894b672722143affe03b504b00bf4d4c82264215d61d5e66c8db0f18f5463a544a7a8dff86f77e6ef16b885091bc6f5034003a300a1d9b38022612b4369f47b17eba5a3adfb5857f6c5</span><br><span class="line">[*] doFinal结果(base64):Ao824FONUv4LJDwCzGj8Gop0EhXoaO9QDocUKoSFDbnoy6y/Lkt3sMUIi5h5s/mdD9V7I5/6eJS2cnIhQ6/+A7UEsAv01MgiZCFdYdXmbI2w8Y9UY6VEp6jf+G935u8WuIUJG8b1A0ADowCh2bOAImErQ2n0exfrpaOt+1hX9sU=</span><br></pre></td></tr></table></figure>
<p>如上为RSA加密过程公钥为<code>MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCDiI/dCs429FC75NYnF82omzzAweej2VdpdaKP3DL0D/s3Hg7cnVTGBh6yRrKYI9cvBKorxdrCEaW0SXZYBH5nvmCg8qyzO8jBj08ISiukEQuqG2oS0L2sbcQl0MV7rExsyO0vlPpND7klBWikAIO1UfZW1ab/EWit1XkaXCr6nQIDAQAB</code></p>
<p>模式填充:<code>RSA/ECB/PKCS1Padding</code></p>
<p>加密数据为：<code>DD240BF148903189BF8DAE0C220C9591</code></p>
<p>加密结果为：<code>Ao824FONUv4LJDwCzGj8Gop0EhXoaO9QDocUKoSFDbnoy6y/Lkt3sMUIi5h5s/mdD9V7I5/6eJS2cnIhQ6/+A7UEsAv01MgiZCFdYdXmbI2w8Y9UY6VEp6jf+G935u8WuIUJG8b1A0ADowCh2bOAImErQ2n0exfrpaOt+1hX9sU=</code></p>
<p>这个过程是为了加密AES密钥，因为RSA加密的加密数据长度是有限的。</p>
<blockquote>
<p>RSA一次能加密的明文长度与密钥长度成正比：</p>
<p>len_in_byte(raw_data) = len_in_bit(key)/8 -11，如 1024bit 的密钥，一次能加密的内容长度为 1024/8 -11 = 117 byte。</p>
<p>所以非对称加密一般都用于加密对称加密算法的密钥，而不是直接加密内容</p>
</blockquote>
<p>因为AES是对称加密</p>
<blockquote>
<p>对称加密就是指，<strong>加密和解密使用同一个密钥的加密方式。</strong></p>
<p>发送方使用密钥将明文数据加密成密文，然后发送出去，接收方收到密文后，使用同一个密钥将密文解密成明文读取。</p>
<p>优点：<strong>加密计算量小、速度块，适合对大量数据进行加密的场景。</strong></p>
</blockquote>
<p>所以通常流量数据为AES，但是AES存在安全问题就是，AES的密钥要是被截获了就可以任意解密数据。</p>
<p>所以目前APP中的加密套路就是:</p>
<p><strong>客户端：流量数据通过AES加密发送给服务端，同时AES密钥随机生成通过RSA公钥加密发服务端</strong></p>
<p><strong>服务端：服务端接收到RSA加密后的AES密钥通过RSA私钥进行解密得到AES密钥，然后通过AES密钥解密流量数据进行验证。</strong></p>
</div></article></div></section><footer><div class="paginator"><a href="/posts/notes/frida-Hook实战一.html" class="next">NEXT</a></div><div class="copyright"><p>© 2016 - 2020 <a href="https://uknowsec.cn">uknow</a>  Stay hungry,Stay foolish.</p></div></footer></div><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-115504647-1",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?225ebcce29d319519ac7c7690425d1d4";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>