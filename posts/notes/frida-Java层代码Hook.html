<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> frida-Java层代码Hook · Uknow - Stay hungry Stay foolish</title><meta name="description" content="frida-Java层代码Hook - uknow"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/2.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div id="mask" style="display: none;"><img id="mask-image" src="#" style=" "></div><div class="wrap"><header><a href="/" class="logo-link"><img src="/2.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">Blog</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">Archive</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">About</a></li><li class="nav-list-item"><a href="https://github.com/uknowsec" target="_blank" class="nav-list-link">GitHub</a></li><li class="nav-list-item"><a href="http://weibo.com/uknowsec" target="_blank" class="nav-list-link">Weibo</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">frida-Java层代码Hook</h1><div class="post-time">Dec 6, 2019</div><div class="post-content"><h3><span id="hook构造方法">Hook构造方法</span></h3><p>要hook的是一个类的构造函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Utils</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Money <span class="title">getMoney</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Money(<span class="number">60</span>, <span class="string">"RMB"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以通过<code>$init</code>来获取并修改一个类的构造方法。（注意，js是弱类型语言，而Java强类型，注意构造的时候的类型转换。）</p>
<p>获取参数可以通过自定义参数名也可以直接用系统隐含的arguments变量获取即可</p>
<p> 下面是jscode</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> money=Java.use(<span class="string">"com.XXXX.app.Money"</span>);</span><br><span class="line">money.$init.implementation = <span class="function"><span class="keyword">function</span>(<span class="params">a, b</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Hook Start..."</span>);</span><br><span class="line">    send(<span class="built_in">arguments</span>[<span class="number">0</span>]);</span><br><span class="line">    send(<span class="built_in">arguments</span>[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.$init(a,b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3><span id="hook重载方法">Hook重载方法</span></h3><p>要hook的重载方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Utils</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"this is test without argument"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">test</span><span class="params">(<span class="keyword">int</span> num)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"this is test with num "</span>+num;</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在方法后面加一个<code>overload</code>属性，参数为函数的类型，类型用字符串传入，用于指定具体要hook的方法。例如<code>utils.test.overload(&quot;int&quot;).implementation</code>。<br> 注意，要填写类的路径，例如如果是字符串类型，则要用<code>overload(&quot;int&quot;,&quot;java.lang.String&quot;)</code><br> jscode:</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">utils.test.overload(<span class="string">"int"</span>).implementation = <span class="function"><span class="keyword">function</span>(<span class="params">a</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Hook Start..."</span>);</span><br><span class="line">        send(<span class="built_in">arguments</span>[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Hook Success..."</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"This overload func is hooked"</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3><span id="hook对象参数的构造">Hook对象参数的构造</span></h3><p>要hook的以对象为参数的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.XXXX.app;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Utils</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">test</span><span class="params">(Money money)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> money.getInfo();</span><br><span class="line">    &#125;</span><br><span class="line">....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们使用一个类型的<code>$new</code>来实例化一个类<br> jscode:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">jscode = <span class="string">"""</span></span><br><span class="line"><span class="string">Java.perform(function()&#123;</span></span><br><span class="line"><span class="string">    var utils = Java.use("com.XXXX.app.Utils");</span></span><br><span class="line"><span class="string">    var money=Java.use("com.XXXX.app.Money");</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    utils.test.overload("com.XXXX.app.Money").implementation = function(a)</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        console.log("Hook Start...");</span></span><br><span class="line"><span class="string">        send(a.getInfo());</span></span><br><span class="line"><span class="string">        var m = money.$new(6666,"DOLLAR");</span></span><br><span class="line"><span class="string">        send(m.getInfo());</span></span><br><span class="line"><span class="string">        return m.getInfo();</span></span><br><span class="line"><span class="string">        //return this.test(m);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;);</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<h3><span id="修改对象属性的值">修改对象属性的值</span></h3><h5><span id="常规方法">常规方法</span></h5><ul>
<li>如果<code>obj.Attr</code>的话，获取到的还是对象，例如<code>a.name</code>的返回值是<code>[*] {&#39;value&#39;: &#39;美元&#39;, &#39;fieldType&#39;: 2, &#39;fieldReturnType&#39;: {&#39;className&#39;: &#39;java.lang.String&#39;, &#39;name&#39;: &#39;Ljava/lang/String;&#39;, &#39;type&#39;: &#39;pointer&#39;, &#39;size&#39;: 1}} [*] 美元</code> </li>
<li>我们使用<code>a.name.value</code>就能获取对象属性的值了。<br> 例如</li>
</ul>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">utils.test.overload(<span class="string">"com.xiaojianbang.app.Money"</span>).implementation = <span class="function"><span class="keyword">function</span>(<span class="params">a</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Hook Start..."</span>);</span><br><span class="line">        send(a.name); <span class="comment">//object</span></span><br><span class="line">        send(a.name.value); <span class="comment">//real value</span></span><br><span class="line">        <span class="keyword">var</span> m = money.$<span class="keyword">new</span>(<span class="number">6666</span>,<span class="string">"DOLLAR"</span>);</span><br><span class="line">        m.name.value=<span class="string">"ForeignMoney"</span>;</span><br><span class="line">        send(m.getInfo());</span><br><span class="line">        <span class="keyword">return</span> m.getInfo();</span><br><span class="line">        <span class="comment">//return this.test(m);</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5><span id="java反射">Java反射</span></h5><p>对于私有属性，我们可以用Java反射的方法设置。<br> 在Java反射中，通过<code>Java.cast(m.getClass(),clazz).getDeclaredField(&#39;num&#39;)</code>，m为一个实例化对象，后面<code>getDeclaredField</code>可以获得属性。通过<code>Java.use(&#39;java.lang.Class&#39;);</code>获取类的构造器<br> 这里，通过属性的<code>get(ObjectsInstantiated)</code>可以获取值，通过属性的<code>setInt(ObjectsInstantiated，value)</code>可以设置一个对象的属性值。<code>ObjectsInstantiated</code>为一个对象。<br> 这里，对于反射后的值，用<code>console.log</code>可以很好的输出值，而<code>send</code>在此处会打印对象。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> utils = Java.use(<span class="string">"com.XXXX.app.Utils"</span>);</span><br><span class="line">    <span class="keyword">var</span> money=Java.use(<span class="string">"com.XXXX.app.Money"</span>);</span><br><span class="line">    </span><br><span class="line">    utils.test.overload(<span class="string">"com.XXXX.app.Money"</span>).implementation = <span class="function"><span class="keyword">function</span>(<span class="params">a</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Hook Start..."</span>);</span><br><span class="line">        <span class="keyword">var</span> m = money.$<span class="keyword">new</span>(<span class="number">6666</span>,<span class="string">"DOLLAR"</span>);</span><br><span class="line">        <span class="keyword">var</span> clazz = Java.use(<span class="string">'java.lang.Class'</span>);</span><br><span class="line">        <span class="keyword">var</span> num_id = Java.cast(m.getClass(),clazz).getDeclaredField(<span class="string">'num'</span>);</span><br><span class="line">        num_id.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">var</span> value = num_id.get(m);</span><br><span class="line">        <span class="built_in">console</span>.log(value);</span><br><span class="line">        send(value); <span class="comment">// have format problem</span></span><br><span class="line">        num_id.setInt(m,<span class="number">23333</span>);</span><br><span class="line">        <span class="built_in">console</span>.log(num_id.get(m));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.test(m);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3><span id="hook内部类">Hook内部类</span></h3><p>要hook的内部类。</p>
<p>在 Java 中，可以将一个类定义在另一个类里面或者一个方法里面，这样的类称为内部类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Circle</span> </span>&#123;</span><br><span class="line">    <span class="keyword">double</span> radius = <span class="number">0</span>;</span><br><span class="line">     </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Circle</span><span class="params">(<span class="keyword">double</span> radius)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.radius = radius;</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Draw</span> </span>&#123;     <span class="comment">//内部类</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">drawSahpe</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"drawshape"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在获取要hook的类后加<code>$</code>和内部类名。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> inInnerClass = Java.use(<span class="string">'com.XXXX.app.Circle$Draw'</span>);</span><br><span class="line"></span><br><span class="line">inInnerClass.drawSahpe.implementation = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3><span id="打印方法堆栈信息">打印方法堆栈信息</span></h3><p>用Java.use方法获取类型变量：var Exception = Java.use(“java.lang.Exception”)</p>
<p>然后是js中支持throw语法的，直接在需要打印堆栈信息的方法中调用即可。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">AndroidLog = Java.use(<span class="string">"android.util.Log"</span>)</span><br><span class="line">AndroidException = Java.use(<span class="string">"java.lang.Exception"</span>)</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">printStackTrace</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(AndroidLog .getStackTraceString(AndroidException .$<span class="keyword">new</span>()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3><span id="总结">总结</span></h3><h4><span id="java层代码hook操作">Java层代码Hook操作</span></h4><ul>
<li><p>1、hook方法包括构造方法和对象方法，构造方法固定写法是$init，普通方法直接是方法名，参数可以自己定义也可以使用系统隐含的变量arguments获取。</p>
</li>
<li><p>2、修改方法的参数和返回值，直接调用原始方法通过传入想要修改的参数来做到修改参数的目的，以及修改返回值即可。</p>
</li>
<li>3、构造对象和修改对象的属性值，直接用反射进行操作，构造对象用固定写法的$new即可。</li>
<li>4、直接用Java的Exception对象打印堆栈信息，然后通过adb logcat -s AndroidRuntime来查看异常信息跟踪代码。</li>
</ul>
<p>总结：获取对象的类类型是Java.use方法，方法有重载的话用overload(…….)解决。</p>
</div></article></div></section><footer><div class="paginator"><a href="/posts/notes/frida-Hook实战一.html" class="prev">上一篇</a><a href="/posts/notes/frida-安装配置.html" class="next">下一篇</a></div><div class="copyright"><p>© 2016 - 2020 <a href="https://uknowsec.cn">uknow</a>  Stay hungry,Stay foolish.</p></div></footer></div><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-115504647-1",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?225ebcce29d319519ac7c7690425d1d4";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>