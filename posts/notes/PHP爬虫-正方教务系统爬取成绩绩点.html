<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> PHP爬虫-正方教务系统爬取成绩绩点 · Uknow - Stay hungry Stay foolish</title><meta name="description" content="PHP爬虫-正方教务系统爬取成绩绩点 - uknow"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/2.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div id="mask" style="display: none;"><img id="mask-image" src="#" style=" "></div><div class="wrap"><header><a href="/" class="logo-link"><img src="/2.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">Blog</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">Archive</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">About</a></li><li class="nav-list-item"><a href="https://github.com/uknowsec" target="_blank" class="nav-list-link">GitHub</a></li><li class="nav-list-item"><a href="http://weibo.com/uknowsec" target="_blank" class="nav-list-link">Weibo</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">PHP爬虫-正方教务系统爬取成绩绩点</h1><div class="post-time">Mar 23, 2018</div><div class="post-content"><!-- ttoc -->
<h2><span id="前言">前言</span></h2><p>从去年寒假开始，学校的一些二级域名就对外网访问进行了限制。而在校内同学们宿舍普遍是用的电信网，要使用内网需要到教学区域连学校的wifi才行。这样是很不方便的。</p>
<p>寒假一直想写个正方教务系统爬虫的，一直拖着拖着的没有完成。开学这一段时间挺闲的，目前完成了正方教务系统爬取成绩绩点和另外两个小项目，一个是正方系统一键报名四六级，一个是物业报修系统一键物业报修。这三个爬虫目前挂在自己的个人服务器上，以某种手段访问内网，后续会转移到内网服务器，转发到外网，提高访问速度。</p>
<p>习惯了，用博客记录自己写的东西，这里简单记录下正方教务系统爬虫成绩绩点的过程。</p>
<h2><span id="正文">正文</span></h2><h3><span id="ui设计">UI设计</span></h3><p>这里提下这个登陆表单和后端的UI界面，这里是借鉴了我在Github上看到的一个类似的项目</p>
<p><a href="https://github.com/wangyufeng0615/bjuthelper" target="_blank" rel="noopener">https://github.com/wangyufeng0615/bjuthelper</a></p>
<p>整个项目跟上述的项目有点类似，都是正方系统，仅仅是在一些小小的地方有区别。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/psb.png" alt=""></p>
<h3><span id="login_gradephp">login_grade.php</span></h3><p>在上面项目中，个别院校的教务系统是有无需验证码的接口的。而在我们学校是没有的，这里我们需要先获取到验证码</p>
<p>这里用到PHP中的CURL进行获取验证码，并把访问页面的cookie保存到本地。并把验证码图片保存到本地。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$rand_id = rand(100000, 999999);    //for verifycode</span><br><span class="line">require_verify_code();  //获取验证码</span><br><span class="line">function require_verify_code()&#123;</span><br><span class="line">    $cookie = dirname(__FILE__).&apos;/cookie/&apos;.$_SESSION[&apos;id&apos;].&apos;.txt&apos;;    //cookie路径  </span><br><span class="line">    $verify_code_url = &quot;http://localhost/CheckCode.aspx&quot;;      //验证码地址</span><br><span class="line">    $curl = curl_init();</span><br><span class="line">    curl_setopt($curl, CURLOPT_URL, $verify_code_url);</span><br><span class="line">    curl_setopt($curl, CURLOPT_COOKIEJAR, $cookie);                     //保存cookie</span><br><span class="line">    curl_setopt($curl, CURLOPT_HEADER, 0);</span><br><span class="line">    curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);</span><br><span class="line">    $img = curl_exec($curl);                                            //执行curl</span><br><span class="line">    curl_close($curl);</span><br><span class="line">    global $rand_id;</span><br><span class="line">    $path_of_verifyCode =dirname(__FILE__).&apos;/verifyCodes/verifyCode_&apos;.$rand_id.&apos;.jpg&apos;;</span><br><span class="line">    $fp = fopen($path_of_verifyCode,&quot;w&quot;);                                  //文件名</span><br><span class="line">    fwrite($fp,$img);                                                   //写入文件</span><br><span class="line">    fclose($fp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>login_grade后面的页面就是利用WEUI写得一个提交表单了，这里就不要过多的说了。</p>
<h3><span id="require_gradephp">require_grade.php</span></h3><h4><span id="抓包分析">抓包分析</span></h4><p>这里还是先简单的抓包分析，先抓登录页面的POST请求包。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">POST /Default2.aspx HTTP/1.1</span><br><span class="line">Host: localhost</span><br><span class="line">Content-Length: 207</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Origin: http://localhost</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/65.0.3325.181 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</span><br><span class="line">Referer: http://localhost/</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Cookie: UM_distinctid=161e202e63c6d9-094afdbce42fa2-3b60450b-1fa400-161e202e63d5b7; ASP.NET_SessionId=ht5hadjnbrhcbebuqa3khb3s</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">__VIEWSTATE=dDwtNTE2MjI4MTQ7Oz7j2BjEQ4cDEffr%2BK8yeXHBPnpEJg%3D%3D&amp;txtUserName=username&amp;Textbox1=&amp;TextBox2=password&amp;txtSecretCode=3vrd&amp;RadioButtonList1=%D1%A7%C9%FA&amp;Button1=&amp;lbLanguage=&amp;hidPdrs=&amp;hidsc=</span><br></pre></td></tr></table></figure>
<p>简单的看下POST提交的参数有</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">__VIEWSTATE=</span><br><span class="line"></span><br><span class="line">txtUserName=</span><br><span class="line"></span><br><span class="line">Textbox1=</span><br><span class="line"></span><br><span class="line">TextBox2=</span><br><span class="line"></span><br><span class="line">txtSecretCode=</span><br><span class="line"></span><br><span class="line">RadioButtonList1=</span><br><span class="line"></span><br><span class="line">&amp;Button1=&amp;lbLanguage=&amp;hidPdrs=&amp;hidsc=</span><br></pre></td></tr></table></figure>
<p>其中txtUserName是学号，TextBox2是密码，txtSecretCode是验证码，后面的参数直接默认提交就行。</p>
<p>这里重点的是__VIEWSTATE参数，这个参数是在登录页面里的。需要去获取这个参数，来找下这个参数的位置。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/viewstate.png" alt=""></p>
<p>这里我们需要得到这个value值,这里我们需要代入login_grade页面里的cookie放入得到响应的vivewstate值</p>
<p>同样利用curl来访问。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">  //function: 构造post数据并登陆</span><br><span class="line">  function login_post($url,$cookie,$post)&#123;</span><br><span class="line">global $cookie;</span><br><span class="line">      $ch = curl_init();</span><br><span class="line">      curl_setopt($ch, CURLOPT_URL, $url);</span><br><span class="line">      curl_setopt($ch, CURLOPT_HEADER, 0);</span><br><span class="line">      curl_setopt($ch, CURLOPT_RETURNTRANSFER,1);  //不自动输出数据，要echo才行</span><br><span class="line">      curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1);  //重要，抓取跳转后数据</span><br><span class="line">      curl_setopt($ch, CURLOPT_COOKIEFILE, $cookie); </span><br><span class="line">      curl_setopt($ch, CURLOPT_REFERER, &apos;http://localhost/default2.aspx&apos;);  //重要，302跳转需要referer，可以在Request Headers找到 </span><br><span class="line">      curl_setopt($ch, CURLOPT_POSTFIELDS,$post);  //post提交数据</span><br><span class="line">      $result=curl_exec($ch);</span><br><span class="line">      curl_close($ch);</span><br><span class="line">      return $result;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$url=&quot;http://localhost/default2.aspx&quot;;  //教务地址</span><br><span class="line">$con1=login_post($url,$cookie,&apos;&apos;);               //登陆</span><br><span class="line">preg_match_all(&apos;/&lt;input type=&quot;hidden&quot; name=&quot;__VIEWSTATE&quot; value=&quot;([^&lt;&gt;]+)&quot; \/&gt;/&apos;, $con1, $view); //获取__VIEWSTATE字段并存到$view数组中</span><br></pre></td></tr></table></figure>
<p>传入教务网地址，访问登录页面，利用preg_match_all函数正则匹配到页面里的__VIEWSTATE的value值。</p>
<p>参数都准备好了，可以模拟登录了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">   $_SESSION[&apos;xh&apos;]=$_POST[&apos;account&apos;];</span><br><span class="line">   $xh=$_POST[&apos;account&apos;];</span><br><span class="line">   $pw=$_POST[&apos;password&apos;];</span><br><span class="line">   $current_year=$_POST[&apos;current_year&apos;];</span><br><span class="line">   $current_term=$_POST[&apos;current_term&apos;];</span><br><span class="line">   $code= $_POST[&apos;verify_code&apos;];</span><br><span class="line">   $cookie = dirname(__FILE__) . &apos;/cookie/&apos;.$_SESSION[&apos;id&apos;].&apos;.txt&apos;;</span><br><span class="line"></span><br><span class="line">$post=array(</span><br><span class="line">       &apos;__VIEWSTATE&apos;=&gt;$view[1][0],</span><br><span class="line">       &apos;txtUserName&apos;=&gt;$xh,</span><br><span class="line">       &apos;TextBox2&apos;=&gt;$pw,</span><br><span class="line">       &apos;txtSecretCode&apos;=&gt;$code,</span><br><span class="line">       &apos;RadioButtonList1&apos;=&gt;iconv(&apos;utf-8&apos;, &apos;gb2312&apos;, &apos;学生&apos;),</span><br><span class="line">       &apos;Button1&apos;=&gt;iconv(&apos;utf-8&apos;, &apos;gb2312&apos;, &apos;登录&apos;),</span><br><span class="line">       &apos;lbLanguage&apos;=&gt;&apos;&apos;,</span><br><span class="line">       &apos;hidPdrs&apos;=&gt;&apos;&apos;,</span><br><span class="line">       &apos;hidsc&apos;=&gt;&apos;&apos;</span><br><span class="line">   );</span><br><span class="line">   $con2=login_post($url,$cookie,http_build_query($post));</span><br></pre></td></tr></table></figure>
<p>这样我们就成功的登录到教务系统了，接下来我们需要跳转到成绩页面。</p>
<p>同样抓包分析，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">POST /xscjcx.aspx?xh=1111111 HTTP/1.1</span><br><span class="line">Host: localhost</span><br><span class="line">Content-Length: 3839</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Origin: http://localhost</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/65.0.3325.181 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</span><br><span class="line">Referer: http://localhost/xscjcx.aspx?xh=208150815&amp;xm=%B3%C9%CF%E9%D4%C0&amp;gnmkdm=N121617</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Cookie: UM_distinctid=161e202e63c6d9-094afdbce42fa2-3b60450b-1fa400-161e202e63d5b7; ASP.NET_SessionId=ht5hadjnbrhcbebuqa3khb3s</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">__EVENTTARGET=&amp;__EVENTARGUMENT=&amp;__VIEWSTATE=dDw&amp;hidLanguage=&amp;ddlXN=2017-2018&amp;ddlXQ=1&amp;ddl_kcxz=&amp;btn_xq=%D1%A7%C6%DA%B3%C9%BC%A8</span><br></pre></td></tr></table></figure>
<p>这里是查询用户选择学期的POST请求包，url里的/xscjcx.aspx?xh=中的xh是用户学号。</p>
<p>POST参数里</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__EVENTTARGET=&amp;__EVENTARGUMENT=&amp;__VIEWSTATE=dDw&amp;hidLanguage=&amp;ddlXN=2017-2018&amp;ddlXQ=1&amp;ddl_kcxz=&amp;btn_xq=%D1%A7%C6%DA%B3%C9%BC%A8</span><br></pre></td></tr></table></figure>
<p>这几个参数都可以看出他们的意思，重要的是获取__VIEWSTATE的value值，同样利用一个正则去获取这个值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$url2=&quot;http://localhost/xscjcx.aspx?xh=&quot;.$_SESSION[&apos;xh&apos;];</span><br><span class="line">$viewstate=login_post($url2,&apos;&apos;);</span><br><span class="line">preg_match_all(&apos;/&lt;input type=&quot;hidden&quot; name=&quot;__VIEWSTATE&quot; value=&quot;([^&lt;&gt;]+)&quot; \/&gt;/&apos;, $viewstate, $vs);</span><br><span class="line">$state=$vs[1][0];  //$state存放一会post的__VIEWSTATE</span><br></pre></td></tr></table></figure>
<p>获取到所有参数，提交post数据报就可以返回值了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$post=array(</span><br><span class="line"> &apos;__EVENTTARGET&apos;=&gt;&apos;&apos;,</span><br><span class="line"> &apos;__EVENTARGUMENT&apos;=&gt;&apos;&apos;,</span><br><span class="line"> &apos;__VIEWSTATE&apos;=&gt;$state,</span><br><span class="line"> &apos;hidLanguage&apos;=&gt;&apos;&apos;,</span><br><span class="line">   &apos;ddlXN&apos;=&gt;$current_year,  //当前学年</span><br><span class="line">   &apos;ddlXQ&apos;=&gt;$current_term,  //当前学期</span><br><span class="line">   &apos;ddl_kcxz&apos;=&gt;&apos;&apos;,</span><br><span class="line">   &apos;btn_xq&apos;=&gt;&apos;%D1%A7%C6%DA%B3%C9%BC%A8&apos;  //“学期成绩”的gbk编码，视情况而定</span><br><span class="line">   );</span><br><span class="line">$content=login_post($url2,$cookie,http_build_query($post)); //获取原始数据</span><br></pre></td></tr></table></figure>
<p>这里就得到要查询的学期的成绩了，得到的HTML里的table标签的数据，需要转换为数组进行输出。</p>
<p>用到一个函数get_td_array()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">function get_td_array($table) &#123;</span><br><span class="line">    $table = preg_replace(&quot;&apos;&lt;table[^&gt;]*?&gt;&apos;si&quot;,&quot;&quot;,$table);</span><br><span class="line">    $table = preg_replace(&quot;&apos;&lt;tr[^&gt;]*?&gt;&apos;si&quot;,&quot;&quot;,$table);</span><br><span class="line">    $table = preg_replace(&quot;&apos;&lt;td[^&gt;]*?&gt;&apos;si&quot;,&quot;&quot;,$table);</span><br><span class="line">    $table = str_replace(&quot;&lt;/tr&gt;&quot;,&quot;&#123;tr&#125;&quot;,$table);</span><br><span class="line">    $table = str_replace(&quot;&lt;/td&gt;&quot;,&quot;&#123;td&#125;&quot;,$table);</span><br><span class="line">        //去掉 HTML 标记</span><br><span class="line">    $table = preg_replace(&quot;&apos;&lt;[/!]*?[^&lt;&gt;]*?&gt;&apos;si&quot;,&quot;&quot;,$table);</span><br><span class="line">        //去掉空白字符</span><br><span class="line">    $table = preg_replace(&quot;&apos;([rn])[s]+&apos;&quot;,&quot;&quot;,$table);</span><br><span class="line">    $table = preg_replace(&apos;/&amp;nbsp;/&apos;,&quot;&quot;,$table);</span><br><span class="line">    $table = str_replace(&quot; &quot;,&quot;&quot;,$table);</span><br><span class="line">    $table = str_replace(&quot; &quot;,&quot;&quot;,$table);</span><br><span class="line">    $table = explode(&apos;&#123;tr&#125;&apos;, $table);</span><br><span class="line">    array_pop($table);</span><br><span class="line">    foreach ($table as $key=&gt;$tr) &#123;</span><br><span class="line">        $td = explode(&apos;&#123;td&#125;&apos;, $tr);</span><br><span class="line">        array_pop($td);</span><br><span class="line">        $td_array[] = $td;</span><br><span class="line">    &#125;</span><br><span class="line">    return $td_array;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从该函数的代码来看，可以看出是利用正则匹配table标签下的tr,td将数据通过遍历存入数组返回。</p>
<p>到这里当前学期的成绩详情都可以获取到了。</p>
<p>下面是绩点的计算，我们学校的系统是把已修学科的学分绩点都列出来了的。我们只需要把数据爬取出来做一个简单的计算就行了。</p>
<p>数据报跟查询学期成绩是差不多的。简单的看下post数据。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$post_allgrade=array(</span><br><span class="line"> &apos;__EVENTTARGET&apos;=&gt;&apos;&apos;,</span><br><span class="line"> &apos;__EVENTARGUMENT&apos;=&gt;&apos;&apos;,</span><br><span class="line"> &apos;__VIEWSTATE&apos;=&gt;$state,</span><br><span class="line"> &apos;hidLanguage&apos;=&gt;&apos;&apos;,</span><br><span class="line">   &apos;ddlXN&apos;=&gt;$current_year,  //当前学年</span><br><span class="line">   &apos;ddlXQ&apos;=&gt;$current_term,  //当前学期</span><br><span class="line">   &apos;ddl_kcxz&apos;=&gt;&apos;&apos;,</span><br><span class="line">   &apos;btn_zcj&apos;=&gt;&apos;%C0%FA%C4%EA%B3%C9%BC%A8&apos;  //历年成绩-gbk</span><br><span class="line">   );</span><br><span class="line">$content_allgrade=login_post($url2,$cookie,http_build_query($post_allgrade)); //获取原始数据</span><br><span class="line">$content_allgrade=get_td_array($content_allgrade);    //table转array</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">//计算总的加权分数和总的GPA</span><br><span class="line">$i = 5;         //从array[5]开始是有效信息</span><br><span class="line">$all_value = 0; //总的学分权值</span><br><span class="line">$all_GPA = 0;   //总的GPA*分数</span><br><span class="line">$all_number_of_lesson_with_public = 0;</span><br><span class="line">$all_score_of_lesson_with_public = 0;</span><br><span class="line">//计算总和的东西，学分/GPA	</span><br><span class="line">while(isset($content_allgrade[$i][4]))&#123;</span><br><span class="line">	if ($content_allgrade[$i][5] == iconv(&quot;utf-8&quot;,&quot;gb2312//IGNORE&quot;,&quot;公选&quot;))&#123;</span><br><span class="line">		//计算公选课课程数和总学分</span><br><span class="line">		$all_number_of_lesson_with_public ++;</span><br><span class="line">		$all_score_of_lesson_with_public += $content_allgrade[$i][6];</span><br><span class="line">		$i++;</span><br><span class="line">	&#125;</span><br><span class="line">	else&#123;</span><br><span class="line">		$all_value += $content_allgrade[$i][6];	//已修总学分</span><br><span class="line">		$all_GPA += ($content_allgrade[$i][6] * $content_allgrade[$i][7]); </span><br><span class="line">		$i++;	</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>上面是一个简单的计算GPA的过程，简单来说就是一个遍历叠加计算的过程。</p>
<p>到这里require_grade页面的PHP部分差不多都说完了，后面的数据的排版输出了。</p>
<h2><span id="github">Github</span></h2><p><a href="https://github.com/uknowsec/GPACrawler" target="_blank" rel="noopener">https://github.com/uknowsec/GPACrawler</a></p>
<h2><span id="reference">Reference</span></h2><p><a href="https://github.com/wangyufeng0615/bjuthelper" target="_blank" rel="noopener">https://github.com/wangyufeng0615/bjuthelper</a></p>
</div></article></div></section><footer><div class="paginator"><a href="/posts/notes/PHP爬虫-正方教务系统一键报名四六级.html" class="prev">PREV</a><a href="/posts/uncategorized/2016-09-29.html" class="next">NEXT</a></div><div class="copyright"><p>© 2016 - 2020 <a href="https://uknowsec.cn">uknow</a>  Stay hungry,Stay foolish.</p></div></footer></div><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-115504647-1",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?225ebcce29d319519ac7c7690425d1d4";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>