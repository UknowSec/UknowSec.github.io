<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> PHP爬虫-正方教务系统一键报名四六级 · Uknow - Stay hungry Stay foolish</title><meta name="description" content="PHP爬虫-正方教务系统一键报名四六级 - uknow"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/2.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div id="mask" style="display: none;"><img id="mask-image" src="#" style=" "></div><div class="wrap"><header><a href="/" class="logo-link"><img src="/2.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">Blog</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">Archive</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">About</a></li><li class="nav-list-item"><a href="https://github.com/uknowsec" target="_blank" class="nav-list-link">GitHub</a></li><li class="nav-list-item"><a href="http://weibo.com/uknowsec" target="_blank" class="nav-list-link">Weibo</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">PHP爬虫-正方教务系统一键报名四六级</h1><div class="post-time">Mar 23, 2018</div><div class="post-content"><p>[TOC]</p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在我们学校四六级也是在正方教务系统进行报名的，login页面是跟查询成绩绩点的差不多，就是添加了几个表单数据。</p>
<p>require页面中一点点区别，模拟登录和之前的成绩绩点爬取是一样的。在报名页面有个地方是很关键的。</p>
<h2 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h2><h3 id="login-cet-php"><a href="#login-cet-php" class="headerlink" title="login_cet.php"></a>login_cet.php</h3><p>login_cet.php页面跟login_grade.php是差不多的，获取到cookie和验证码保存到本地。</p>
<p>以下是提交表单界面</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/psb1.png" alt=""></p>
<h3 id="require-cet-php"><a href="#require-cet-php" class="headerlink" title="require_cet.php"></a>require_cet.php</h3><p>在前言说到，模拟登录跟之前是一样的，加之目前学校已经关闭了报名页面，所以无法抓包。</p>
<h3 id="Posting-multipart-form-data-using-curl-in-PHP"><a href="#Posting-multipart-form-data-using-curl-in-PHP" class="headerlink" title="Posting multipart form data using curl in PHP"></a>Posting multipart form data using curl in PHP</h3><p>如下代码demo</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ch = curl_init();</span><br><span class="line">curl_setopt($ch, CURLOPT_URL, &quot;http://localhost:8888&quot;);</span><br><span class="line">curl_setopt($ch, CURLOPT_CUSTOMREQUEST, &apos;POST&apos;);</span><br><span class="line">curl_setopt($ch, CURLOPT_POSTFIELDS, array(&apos;a&apos; =&gt; &apos;b&apos;, &apos;c&apos; =&gt; &apos;d&apos;));</span><br><span class="line">curl_exec($ch);</span><br></pre></td></tr></table></figure>
<p>以上是一个简单的curl发送一个POST请求</p>
<p>这个demo的产生request如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">POST / HTTP/1.1</span><br><span class="line">Host: localhost:8888</span><br><span class="line">Accept: */*</span><br><span class="line">Content-Length: 228</span><br><span class="line">Expect: 100-continue</span><br><span class="line">Content-Type: multipart/form-data; boundary=------------------------f287dd3807057a2c</span><br><span class="line"></span><br><span class="line">--------------------------f287dd3807057a2c</span><br><span class="line">Content-Disposition: form-data; name=&quot;a&quot;</span><br><span class="line">Content-Length: 1</span><br><span class="line"></span><br><span class="line">b</span><br><span class="line">--------------------------f287dd3807057a2c</span><br><span class="line">Content-Disposition: form-data; name=&quot;c&quot;</span><br><span class="line">Content-Length: 1</span><br><span class="line"></span><br><span class="line">d</span><br><span class="line">--------------------------f287dd3807057a2c--</span><br></pre></td></tr></table></figure>
<p>从以上代码中总结出的就是，在curl_setopt($ch, CURLOPT_POSTFIELDS, $post)这个函数中，</p>
<p>如果$post是字符串，则Content-Type是application/x-www-form-urlencoded。</p>
<p>如果$post是k=&gt;v的数组，则Content-Type是multipart/form-data</p>
<p>在这里因为这个爬虫中，确定提交的POST包的Content-Type是multipart/form-data。</p>
<p>所以这里有用到这个知识点。代码如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$params=[&apos;__EVENTTARGET&apos; =&gt; &apos;&apos;,&apos;__EVENTARGUMENT&apos;=&gt;&apos;&apos;,&apos;__VIEWSTATE&apos;=&gt;$state,&apos;txtxxmc&apos;=&gt;&apos;&apos;,$cet=&gt;&apos;on&apos;,&apos;txtSFZH&apos;=&gt;$idcard,&apos;btnSubmit&apos;=&gt;&apos;确 定&apos;,&apos;TextBox1&apos;=&gt;&apos;&apos;];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">function post_cet($url2,$cookie,$params)</span><br><span class="line">&#123;</span><br><span class="line">	$ch = curl_init();</span><br><span class="line">	curl_setopt($ch, CURLOPT_URL, $url2);</span><br><span class="line">	curl_setopt($ch, CURLOPT_POST, true);</span><br><span class="line">	curl_setopt($ch,CURLOPT_HTTPHEADER,array(</span><br><span class="line">		&apos;User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/64.0.3282.186 Safari/537.36&apos;,</span><br><span class="line">		&apos;Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8&apos;,</span><br><span class="line">		&apos;Accept-Encoding: gzip, deflate&apos;,</span><br><span class="line">		&apos;Accept-Language: zh-CN,zh;q=0.9&apos;,</span><br><span class="line">		&apos;Upgrade-Insecure-Requests: 1&apos;,</span><br><span class="line">		&apos;Cache-Control: max-age=0&apos;</span><br><span class="line">	));</span><br><span class="line">	curl_setopt($ch, CURLOPT_REFERER, $url2);</span><br><span class="line">	curl_setopt($ch, CURLOPT_RETURNTRANSFER,1);  //不自动输出数据，要echo才行</span><br><span class="line">	curl_setopt($ch, CURLOPT_COOKIEFILE, $cookie);</span><br><span class="line">	curl_setopt($ch, CURLOPT_POSTFIELDS, $params);</span><br><span class="line">//	curl_setopt($ch, CURLINFO_HEADER_OUT, TRUE);</span><br><span class="line">	curl_exec($ch);</span><br><span class="line">//	echo curl_getinfo($ch, CURLINFO_HEADER_OUT);</span><br><span class="line">	curl_close($ch);</span><br><span class="line">	return $response;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$con3=post_cet($url2,$cookie,$params);</span><br></pre></td></tr></table></figure>
<p>以上的代码就可以实现提交确认POST数据报了，接下来我还做了个简单的判断，判断是否报名成功。</p>
<p>如果报名成功了，页面会有报名记录的。这里因为无法抓包，就只能根据代码说明了。</p>
<p>这里我没有使用正则匹配，用到的xpath定位。</p>
<p>代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">$con3=post_cet($url2,$cookie,$params);</span><br><span class="line">//echo $con3;</span><br><span class="line">// create document object model</span><br><span class="line">$dom = new DOMDocument();</span><br><span class="line">// load html into document object model</span><br><span class="line">@$dom-&gt;loadHTML($con3);</span><br><span class="line">// create domxpath instance</span><br><span class="line">$xPath = new DOMXPath($dom);</span><br><span class="line">// get all elements with a particular id and then loop through and print the href attribute</span><br><span class="line">$elements = $xPath-&gt;query(&apos;//*[@id=&quot;DBGridInfo&quot;]/tbody/tr[2]&apos;);</span><br><span class="line">if($elements)&#123;</span><br><span class="line">	echo&apos;</span><br><span class="line">	&lt;div class=&quot;weui-msg&quot;&gt;</span><br><span class="line">		&lt;div class=&quot;weui-msg__icon-area&quot;&gt;&lt;i class=&quot;weui-icon-success weui-icon_msg&quot;&gt;&lt;/i&gt;&lt;/div&gt;</span><br><span class="line">		&lt;div class=&quot;weui-msg__text-area&quot;&gt;</span><br><span class="line">			&lt;h2 class=&quot;weui-msg__title&quot;&gt;报考成功&lt;/h2&gt;</span><br><span class="line">		&lt;/div&gt;</span><br><span class="line">		&lt;div class=&quot;weui-msg__opr-area&quot;&gt;</span><br><span class="line">			&lt;p class=&quot;weui-btn-area&quot;&gt;</span><br><span class="line">				&lt;a href=&quot;javascript:;&quot; onClick=&quot;location.href=document.referrer&quot; class=&quot;weui-btn weui-btn_primary&quot;&gt;返回&lt;/a&gt;</span><br><span class="line">			&lt;/p&gt;</span><br><span class="line">		&lt;/div&gt;</span><br><span class="line">	&lt;/div&gt;&apos;;</span><br><span class="line">&#125;</span><br><span class="line">else&#123;</span><br><span class="line">	echo&apos;</span><br><span class="line">	&lt;div class=&quot;weui-msg&quot;&gt;</span><br><span class="line">		&lt;div class=&quot;weui-msg__icon-area&quot;&gt;&lt;i class=&quot;weui-icon-warn weui-icon_msg&quot;&gt;&lt;/i&gt;&lt;/div&gt;</span><br><span class="line">		&lt;div class=&quot;weui-msg__text-area&quot;&gt;</span><br><span class="line">			&lt;h2 class=&quot;weui-msg__title&quot;&gt;报考失败,请返回重试&lt;/h2&gt;</span><br><span class="line">		&lt;/div&gt;</span><br><span class="line">		&lt;div class=&quot;weui-msg__opr-area&quot;&gt;</span><br><span class="line">			&lt;p class=&quot;weui-btn-area&quot;&gt;</span><br><span class="line">				&lt;a href=&quot;javascript:;&quot; onClick=&quot;location.href=document.referrer&quot; class=&quot;weui-btn weui-btn_primary&quot;&gt;返回&lt;/a&gt;</span><br><span class="line">			&lt;/p&gt;</span><br><span class="line">		&lt;/div&gt;</span><br><span class="line">	&lt;/div&gt;&apos;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中的 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">//*[@id=&quot;DBGridInfo&quot;]/tbody/tr[2]</span><br></pre></td></tr></table></figure>
<p>是需要判断的xpath路径，更加匹配该地址的值来判断是否实现报名。</p>
<h2 id="Github"><a href="#Github" class="headerlink" title="Github"></a>Github</h2><p><a href="https://github.com/uknowsec/CETCrawler" target="_blank" rel="noopener">https://github.com/uknowsec/CETCrawler</a></p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="http://titohernandez.com/titohernandez/posting-multipart-form-data-using-curl-in-php/" target="_blank" rel="noopener">Posting multipart form data using curl in PHP.</a></p>
</div></article></div></section><footer><div class="paginator"><a href="/posts/notes/PHP爬虫-物业报修系统一键校园物业报修.html" class="prev">PREV</a><a href="/posts/notes/PHP爬虫-正方教务系统爬取成绩绩点.html" class="next">NEXT</a></div><div class="copyright"><p>© 2016 - 2019 <a href="https://uknowsec.cn">uknow</a>  Stay hungry,Stay foolish.</p></div></footer></div><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-115504647-1",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?225ebcce29d319519ac7c7690425d1d4";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>