<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 同源策略和跨域访问学习笔记 · Uknow - Stay hungry Stay foolish</title><meta name="description" content="同源策略和跨域访问学习笔记 - uknow"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/2.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div id="mask" style="display: none;"><img id="mask-image" src="#" style=" "></div><div class="wrap"><header><a href="/" class="logo-link"><img src="/2.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">Blog</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">Archive</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">About</a></li><li class="nav-list-item"><a href="https://github.com/uknowsec" target="_blank" class="nav-list-link">GitHub</a></li><li class="nav-list-item"><a href="http://weibo.com/uknowsec" target="_blank" class="nav-list-link">Weibo</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">同源策略和跨域访问学习笔记</h1><div class="post-time">Mar 29, 2018</div><div class="post-content"><p>[TOC]</p>
<h2 id="同源策略"><a href="#同源策略" class="headerlink" title="同源策略"></a>同源策略</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><h4 id="含义"><a href="#含义" class="headerlink" title="含义"></a>含义</h4><p>所谓同源是值三个相同</p>
<ul>
<li>协议相同</li>
<li>域名相同</li>
<li>端口相同</li>
</ul>
<h4 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h4><p>同源政策的目的，是为了保证用户信息的安全，防止恶意的网站窃取数据。</p>
<p>设想这样一种情况：A网站是一家银行，用户登录以后，又去浏览其他网站。如果其他网站可以读取A网站的 Cookie，会发生什么？</p>
<p>很显然，如果 Cookie 包含隐私（比如存款总额），这些信息就会泄漏。更可怕的是，Cookie 往往用来保存用户的登录状态，如果用户没有退出登录，其他网站就可以冒充用户，为所欲为。因为浏览器同时还规定，提交表单不受同源政策的限制。</p>
<p>由此可见，”同源政策”是必需的，否则 Cookie 可以共享，互联网就毫无安全可言了。</p>
<h2 id="跨域"><a href="#跨域" class="headerlink" title="跨域"></a>跨域</h2><p>只要协议、域名、端口有任何一个不同，都被当作是不同的域，跨域就是访问非本域的资源。</p>
<h3 id="跨域实现方式"><a href="#跨域实现方式" class="headerlink" title="跨域实现方式"></a>跨域实现方式</h3><ul>
<li>document.domain</li>
<li>window.name</li>
<li>window.postMessage</li>
<li>JSONP</li>
<li>iframe</li>
<li>CORS</li>
</ul>
<h3 id="document-domain"><a href="#document-domain" class="headerlink" title="document.domain"></a>document.domain</h3><p>Cookie 是服务器写入浏览器的一小段信息，只有同源的网页才能共享。但是，两个网页一级域名相同，只是二级域名不同，浏览器允许通过设置document.domain共享 Cookie。</p>
<p>举例来说，A网页是<a href="http://w1.example.com/a.html" target="_blank" rel="noopener">http://w1.example.com/a.html</a> B网页是 <a href="http://w2.example.com/b.html" target="_blank" rel="noopener">http://w2.example.com/b.html</a> 那么只要设置相同的document.domain，两个网页就可以共享Cookie。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">document.domain = &apos;example.com&apos;;</span><br></pre></td></tr></table></figure>
<p>现在，A网页通过脚本设置一个 Cookie。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">document.cookie = &quot;test1=hello&quot;;</span><br></pre></td></tr></table></figure>
<p>B网页就可以读到这个 Cookie。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var allCookie = document.cookie;</span><br></pre></td></tr></table></figure>
<p>注意，这种方法只适用于 Cookie 和 iframe 窗口，LocalStorage 和 IndexDB 无法通过这种方法，规避同源政策。</p>
<p>另外，服务器也可以在设置Cookie的时候，指定Cookie的所属域名为一级域名，比如.example.com。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-Cookie: key=value; domain=.example.com; path=/</span><br></pre></td></tr></table></figure>
<p>这样的话，二级域名和三级域名不用做任何设置，都可以读取这个Cookie。</p>
<h4 id="实验-1-cookie-document-domain"><a href="#实验-1-cookie-document-domain" class="headerlink" title="实验 1 cookie document.domain"></a>实验 1 cookie document.domain</h4><p>w1.example.com/a.html</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;Title&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">	var cookieName = &apos;Cookie&apos;;</span><br><span class="line">	var cookieValue = &apos;Uknow&apos;;</span><br><span class="line">	var myDate = new Date();</span><br><span class="line">	myDate.setMonth(myDate.getMonth() + 12);</span><br><span class="line">	document.cookie = cookieName +&quot;=&quot; + cookieValue + &quot;;expires=&quot; + myDate </span><br><span class="line">					  + &quot;;domain=.example.com;path=/&quot;;</span><br><span class="line">	alert(document.cookie);</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>w2.example.com/b.html</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;Title&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    document.domain = &apos;example.com&apos;;</span><br><span class="line">	alert(document.cookie);</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>在PHPstudy下配置虚拟主机 w1.example.com和w2.example.com，他们的html代码分别如上</p>
<p>访问 w2.example.com/b.html 看得到的cookie是否和 w1.example.com/a.html 一样</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/w2-cookie.png" alt=""></p>
<p>由此可见document.domain可以实现cookie的跨域。</p>
<p>同样，两个网页不同源，就无法拿到对方的DOM。典型的例子是iframe窗口和window.open方法打开的窗口，它们与父窗口无法通信。</p>
<p>这里也可以通过document.domain来进行子域与父域之间的传值。</p>
<h4 id="实验-2-iframe-document-domain"><a href="#实验-2-iframe-document-domain" class="headerlink" title="实验 2 iframe document.domain"></a>实验 2 iframe document.domain</h4><p>父域 example.com/a.html</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;Title&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">    document.domain = &apos;example.com&apos;;</span><br><span class="line">    var ifr = document.createElement(&apos;iframe&apos;);</span><br><span class="line">    ifr.src = &apos;http://w2.example.com/b.html&apos;;</span><br><span class="line">    ifr.style.display = &apos;none&apos;;</span><br><span class="line">    document.body.appendChild(ifr);</span><br><span class="line">    ifr.onload = function()&#123;</span><br><span class="line">        var doc = ifr.contentDocument || ifr.contentWindow.document;</span><br><span class="line">        // 这里操作DOM</span><br><span class="line">        var oUl = doc.getElementById(&apos;ul1&apos;);</span><br><span class="line">        alert(oUl.innerHTML);</span><br><span class="line">        ifr.onload = null;</span><br><span class="line">    &#125;;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>子域 w2.example.com/b.html</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;Title&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    document.domain = &apos;example.com&apos;;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;ul id=&quot;ul1&quot;&gt;我是子域w2.example.com中的UL&lt;/ul&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>这里可以看到我们在子域 w2.example.com/b.html中写了一个w2.example.com/b.html,写了一个UL标签。同时设置了 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">document.domain = &apos;example.com&apos;;</span><br></pre></td></tr></table></figure>
<p>然后在父域 example.com/a.html 定义一个iframe去读取子域的UL，实现异域的DOM读取。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/w2-ifrome.png" alt=""></p>
<h3 id="window-name"><a href="#window-name" class="headerlink" title="window.name"></a>window.name</h3><p>浏览器窗口有window.name属性。这个属性的最大特点是，无论是否同源，只要在同一个窗口里，前一个网页设置了这个属性，后一个网页可以读取它。</p>
<p>在w2.example.com/b.html，该网页将信息写入window.name属性。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">window.name = data;</span><br></pre></td></tr></table></figure>
<p>接着，example.com/a.html跳回一个与它同域的网址。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">src = &quot;http://example.com/Proxy.html</span><br></pre></td></tr></table></figure>
<p>然后在example.com/a.html 读取w2.example.com/b.html的window.name</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">document.getElementById(&quot;iframe&quot;).contentWindow.name</span><br></pre></td></tr></table></figure>
<h4 id="实验-3-iframe-window-name"><a href="#实验-3-iframe-window-name" class="headerlink" title="实验 3 iframe window.name"></a>实验 3 iframe window.name</h4><p>example.com/a.html<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;!doctype html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;example.com/a.html&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;example.com/a.html&lt;/h1&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    function test()&#123;</span><br><span class="line">        var obj = document.getElementById(&quot;iframe&quot;);</span><br><span class="line">        obj.onload = function()&#123;</span><br><span class="line">            var message = obj.contentWindow.name;</span><br><span class="line">            alert(message);</span><br><span class="line">        &#125;</span><br><span class="line">        obj.src = &quot;http://example.com/Proxy.html&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;iframe id=&quot;iframe&quot; src=&quot;http://w2.example.com/b.html&quot; onload=&quot;test()&quot;&gt;&lt;/iframe&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<p>w2.example.com/b.html<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;window.name&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;w2.example.com/b.html&lt;/h1&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    //todo</span><br><span class="line">    window.name = &quot;This is message!&quot;;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<p>整个跨域的流程就是：</p>
<p>w2.example.com/b.html 设置了window.name = “This is message!”</p>
<p>而example.com/a.html想要获取到window.name的值就需要依靠iframe作为中间代理</p>
<p>首先把iframe的src设置成<a href="http://w2.example.com/b.html" target="_blank" rel="noopener">http://w2.example.com/b.html</a> 这样就相当于要获取iframe的window.name，</p>
<p>而要想获取到iframe中的window.name，就需要把iframe的src设置成当前域的一个页面地址”<a href="http://example.com/Proxy.html" target="_blank" rel="noopener">http://example.com/Proxy.html</a>“</p>
<p>不然根据前面讲的同源策略，window.name.html是不能访问到iframe里的window.name属性的。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/w2-windowsname.png" alt=""></p>
<h3 id="window-postMessage"><a href="#window-postMessage" class="headerlink" title="window.postMessage"></a>window.postMessage</h3><p>HTML5引入了一个全新的API：跨文档通信 API（Cross-document messaging）。</p>
<p>这个API为window对象新增了一个window.postMessage方法，允许跨窗口通信，不论这两个窗口是否同源。</p>
<p>向外界窗口发送消息<br>postMessage方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">otherWindow.postMessage(message, targetOrigin);</span><br></pre></td></tr></table></figure>
<ul>
<li><p>otherWindow:  指目标窗口，也就是给哪个window发消息。</p>
</li>
<li><p>message: 要发送的消息，类型为 String、Object (IE8、9 不支持)</p>
</li>
<li><p>targetOrigin: 是限定消息接收范围，不限制请使用 ‘*’</p>
</li>
</ul>
<p>接受信息的”message”事件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">var onmessage = function (event) &#123;</span><br><span class="line">    var data = event.data;</span><br><span class="line">    var origin = event.origin;</span><br><span class="line">    //do someing</span><br><span class="line">&#125;;</span><br><span class="line">if (typeof window.addEventListener != &apos;undefined&apos;) &#123;</span><br><span class="line">    window.addEventListener(&apos;message&apos;, onmessage, false);</span><br><span class="line">&#125; else if (typeof window.attachEvent != &apos;undefined&apos;) &#123;</span><br><span class="line">    //for ie</span><br><span class="line">    window.attachEvent(&apos;onmessage&apos;, onmessage);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>回调函数第一个参数接收 event 对象，有三个常用属性：</p>
<ul>
<li>data:  消息</li>
<li>origin:  消息来源地址</li>
<li>source:  源 DOMWindow 对象</li>
</ul>
<h4 id="实验-4-iframe-window-postMessage"><a href="#实验-4-iframe-window-postMessage" class="headerlink" title="实验 4 iframe window.postMessage"></a>实验 4 iframe window.postMessage</h4><p>example.com/a.html<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;postmessage&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;example.com/a.html&lt;/h1&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    window.onload = function () &#123;</span><br><span class="line">        if (typeof window.postMessage === undefined) &#123;</span><br><span class="line">            alert(&quot;浏览器不支持postMessage！&quot;);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            window.top.postMessage(&quot;Uknow&quot;, &quot;http://w2.example.com&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<p>w2.example.com/b.html<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;!doctype html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;w2.example.com -- iframe-postmessage&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;w2.example.com/b.html&lt;/h1&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    function test()&#123;</span><br><span class="line">        if (typeof window.postMessage === undefined) &#123;</span><br><span class="line">            alert(&quot;浏览器不支持postMessage！&quot;);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            window.addEventListener(&quot;message&quot;, function(e)&#123;</span><br><span class="line">                if (e.origin == &quot;http://example.com&quot;) &#123; //只接收指定的源发来的消息</span><br><span class="line">                    alert(e.data);</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;, false);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;iframe id=&quot;iframe&quot; src=&quot;http://example.com/a.html&quot; onload=&quot;test()&quot;&gt;&lt;/iframe&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/w2-mess.png" alt=""></p>
<h3 id="JSONP"><a href="#JSONP" class="headerlink" title="JSONP"></a>JSONP</h3><p>JSONP 是 JSON with padding（填充式 JSON 或参数式 JSON）的简写。</p>
<p>JSONP实现跨域请求的原理简单的说，就是动态创建script标签，然后利用script的src 不受同源策略约束来跨域获取数据。</p>
<p>JSONP 由两部分组成：回调函数和数据。回调函数是当响应到来时应该在页面中调用的函数。回调函数的名字一般是在请求中指定的。而数据就是传入回调函数中的 JSON 数据。</p>
<h4 id="实验-5-JSONP"><a href="#实验-5-JSONP" class="headerlink" title="实验 5 JSONP"></a>实验 5 JSONP</h4><p>example.com/a.html</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;jsonp-test&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">        function callback_data (data) &#123;</span><br><span class="line">            console.log(data);</span><br><span class="line">        &#125;</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line">    &lt;script type=&quot;text/javascript&quot; src=&quot;http://w2.example.com/jsonp.php?callback=callback_data&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>w2.example.com/jsonp.php</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    $callback = $_GET[&apos;callback&apos;];  // 获取回调函数名</span><br><span class="line">    $arr = array(&quot;name&quot; =&gt; &quot;Uknow&quot;, &quot;blog&quot; =&gt; &quot;uknowsec.cn&quot;); // 要请求的数据</span><br><span class="line">    echo $callback.&quot;(&quot;. json_encode($arr) .&quot;);&quot;; // 输出</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>w2.example.com目录下的jsonp.php文件获取数据时，地址后面跟了一个callback参数（一般的就是用callback这个参数名，你也可以用其他的参数名代替）。</p>
<p>如果你要获取数据的页面是你不能控制的，那你只能根据它所提供的接口格式进行获取。</p>
<p>因为我们的type规定是当成是一个javascript文件来引入的，所以php文件返回的应该是一个可执行的js文件。</p>
<p>访问w2.example.com/jsonp.php 控制台打印出：</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/w2-console.png" alt=""></p>
<p>通过script标签引入一个js文件，这个js文件载入成功后会执行我们在url参数中指定的函数，同时把我们需要的json数据作为参数传入。所以jsonp是需要服务器端和客户端相互配合的。</p>
<p>知道jsonp跨域的原理后我们就可以用js动态生成script标签来进行跨域操作了，而不用特意的手动的书写那些script标签。比如jQuery封装的方法就能很方便的来进行jsonp操作了。</p>
<p>我们在example.com中引用JQuery.js用它封装好的方法进行jsonp操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$.getJSON(&quot;http://w2.example.com/jsonp.php?callback=?&quot;, function(data)&#123;</span><br><span class="line">    console.log(data);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/w2-console1.png" alt=""></p>
<p>原理是一样的，只不过我们不需要手动的插入script标签以及定义回掉函数。jQuery会自动生成一个全局函数来替换callback=?中的问号，之后获取到数据后又会自动销毁，实际上就是起一个临时代理函数的作用。</p>
<p>从请求的url和响应的数据就可以很明显的看出来了：</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/w2-console2.png" alt=""></p>
<p>jQuery214040478116061364444_1522324096074 就是一个临时代理函数。</p>
<p>$.getJSON方法会自动判断是否跨域，不跨域的话，就调用普通的ajax方法；跨域的话，则会以异步加载js文件的形式来调用jsonp的回调函数。</p>
<p>另外jsonp是无法post数据的，尽管jQuery.getJSON(url, [data], [callback]); 提供data参数让你可以携带数据发起请求，但这样是以get方式传递的。比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//$.getJSON()方法</span><br><span class="line">$.getJSON(&quot;http://127.0.0.1:9000/jsonp.php?callback=?&quot;, &#123;u:&apos;abc&apos;, p: &apos;123&apos;&#125;, function(jsonData)&#123;</span><br><span class="line">    console.log(jsonData);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/w2-console3.png" alt=""></p>
<p>调用$.ajax()方法指定type为post，它还是会转成get方式请求</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$.ajax(&#123;</span><br><span class="line">    type: &apos;post&apos;,</span><br><span class="line">    url: &quot;http://w2.example.com/jsonp.php&quot;,</span><br><span class="line">    crossDomain: true,</span><br><span class="line">    data: &#123;u: &apos;Uknow&apos;, age: 20&#125;,</span><br><span class="line">    dataType: &quot;jsonp&quot;,</span><br><span class="line">    success: function(r)&#123;</span><br><span class="line">        console.log(r);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/w2-console4.png" alt=""></p>
<h3 id="CORS"><a href="#CORS" class="headerlink" title="CORS"></a>CORS</h3><p>CORS定义一种跨域访问的机制，全称是”跨域资源共享”（Cross-origin resource sharing），可以让AJAX实现跨域访问。CORS 允许一个域上的网络应用向另一个域提交跨域 AJAX 请求。实现此功能非常简单，只需由服务器发送一个响应标头即可。</p>
<p>浏览器将CORS请求分成两类：简单请求（simple request）和非简单请求（not-so-simple request）。</p>
<p>只要同时满足以下两大条件，就属于简单请求。</p>
<p>（1) 请求方法是以下三种方法之一：</p>
<ul>
<li>HEAD</li>
<li>GET</li>
<li>POST</li>
</ul>
<p>（2）HTTP的头信息不超出以下几种字段：</p>
<ul>
<li>Accept</li>
<li>Accept-Language</li>
<li>Content-Language</li>
<li>Last-Event-ID</li>
<li>Content-Type：只限于三个值application/x-www-form-urlencoded、multipart/form-data、text/plain</li>
</ul>
<p>凡是不同时满足上面两个条件，就属于非简单请求。</p>
<p>浏览器对这两种请求的处理，是不一样的。</p>
<p>对于简单请求，浏览器直接发出CORS请求。具体来说，就是在头信息之中，增加一个Origin字段。</p>
<p>Origin字段用来说明，本次请求来自哪个源（协议 + 域名 + 端口）。服务器根据这个值，决定是否同意这次请求。</p>
<p>非简单请求是那种对服务器有特殊要求的请求，比如请求方法是PUT或DELETE，或者Content-Type字段的类型是application/json。</p>
<p>非简单请求的CORS请求，会在正式通信之前，增加一次HTTP查询请求，称为”预检”请求（preflight）。</p>
<p>浏览器先询问服务器，当前网页所在的域名是否在服务器的许可名单之中，以及可以使用哪些HTTP动词和头信息字段。只有得到肯定答复，浏览器才会发出正式的XMLHttpRequest请求，否则就报错。</p>
<p>即服务器响应头设置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">header(&apos;Access-Control-Allow-Origin: *&apos;); // &quot;*&quot;号表示允许任何域向服务器端提交请求；也可以设置指定的域名，那么就允许来自这个域的请求：</span><br><span class="line">header(&apos;Access-Control-Allow-Methods: POST&apos;);</span><br><span class="line">header(&apos;Access-Control-Max-Age: 1000&apos;);</span><br></pre></td></tr></table></figure>
<ul>
<li>Access-Control-Allow-Origin:该字段是必须的。它的值要么是请求时Origin字段的值，要么是一个*，表示接受任意域名的请求。</li>
<li>Access-Control-Allow-Methods:该字段必需，它的值是逗号分隔的一个字符串，表明服务器支持的所有跨域请求的方法。注意，返回的是所有支持的方法，而不单是浏览器请求的那个方法。这是为了避免多次”预检”请求。</li>
<li>Access-Control-Max-Age:该字段可选，用来指定本次预检请求的有效期，单位为秒。上面结果中，有效期是20天（1728000秒），即允许缓存该条回应1728000秒（即20天），在此期间，不用发出另一条预检请求。</li>
</ul>
<p>example.com/cors.html<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$.ajax(&#123;</span><br><span class="line">    type: &apos;post&apos;,</span><br><span class="line">    url: &quot;http://w2.example.com/cors.php&quot;,</span><br><span class="line">    crossDomain: true,</span><br><span class="line">    data: &#123;u: &apos;Uknow&apos;, age: 20&#125;,</span><br><span class="line">    dataType: &quot;json&quot;,</span><br><span class="line">    success: function(r)&#123;</span><br><span class="line">        console.log(r);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>w2.example.com/cors.php</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    header(&apos;Access-Control-Allow-Origin: *&apos;);</span><br><span class="line">    header(&apos;Access-Control-Allow-Methods: POST&apos;);</span><br><span class="line">    header(&apos;Access-Control-Max-Age: 1000&apos;);</span><br><span class="line">    if($_POST)&#123;</span><br><span class="line">        $arr = array(&apos;name&apos; =&gt; $_POST[&apos;u&apos;], &apos;age&apos; =&gt; $_POST[&apos;age&apos;]);</span><br><span class="line">        echo json_encode($arr);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        echo json_encode([]);</span><br><span class="line">    &#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/w2-console5.png" alt=""></p>
<p>这样也是可以实现跨域post数据的。</p>
<p>兼容性。CORS是W3C中一项较新的方案，所以部分浏览器还没有对其进行支持或者完美支持，详情可移至 <a href="http://www.w3.org/TR/cors/。" target="_blank" rel="noopener">http://www.w3.org/TR/cors/。</a><br>安全问题。CORS提供了一种跨域请求方案，但没有为安全访问提供足够的保障机制，如果你需要信息的绝对安全，不要依赖CORS当中的权限制度，应当使用更多其它的措施来保障。</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="http://www.cnblogs.com/alsy/p/5470772.html" target="_blank" rel="noopener">js实现跨域</a><br><a href="http://www.ruanyifeng.com/blog/2016/04/cors.html" target="_blank" rel="noopener">跨域资源共享 CORS 详解</a><br><a href="http://www.ruanyifeng.com/blog/2016/04/same-origin-policy.html" target="_blank" rel="noopener">浏览器同源政策及其规避方法</a></p>
</div></article></div></section><footer><div class="paginator"><a href="/posts/notes/solveme-peng-kr平台Web练习.html" class="prev">PREV</a><a href="/posts/notes/PHP爬虫-物业报修系统一键校园物业报修.html" class="next">NEXT</a></div><div class="copyright"><p>© 2016 - 2019 <a href="https://uknowsec.cn">uknow</a>  Stay hungry,Stay foolish.</p></div></footer></div><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-115504647-1",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?225ebcce29d319519ac7c7690425d1d4";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>