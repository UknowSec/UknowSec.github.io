<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> PHP爬虫-物业报修系统一键校园物业报修 · Uknow - Stay hungry Stay foolish</title><meta name="description" content="PHP爬虫-物业报修系统一键校园物业报修 - uknow"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/2.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div id="mask" style="display: none;"><img id="mask-image" src="#" style=" "></div><div class="wrap"><header><a href="/" class="logo-link"><img src="/2.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">Blog</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">Archive</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">About</a></li><li class="nav-list-item"><a href="https://github.com/uknowsec" target="_blank" class="nav-list-link">GitHub</a></li><li class="nav-list-item"><a href="http://weibo.com/uknowsec" target="_blank" class="nav-list-link">Weibo</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">PHP爬虫-物业报修系统一键校园物业报修</h1><div class="post-time">Mar 23, 2018</div><div class="post-content"><!-- ttoc -->
<h2><span id="前言">前言</span></h2><p>前面两个爬虫都是基于正方教务系统的，这个爬虫是根据学校的一个物业报修系统写的。</p>
<p>login_baoxiu.php页面有用到一个js做的select二级联动的操作。</p>
<p>require_baoxiu.php页面也就是三个post请求。</p>
<h2><span id="正文">正文</span></h2><h3><span id="login_baoxiuphp">login_baoxiu.php</span></h3><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/psb2.png" alt=""></p>
<p>以上界面中的保修物品里是需要一个select的二级联动的。</p>
<h3><span id="select二级联动">select二级联动</span></h3><p>这里简单的看一个二级联动的JS代码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;select  id=&quot;a&quot;&gt;&lt;/select&gt;</span><br><span class="line">&lt;select id=&quot;b&quot;&gt;</span><br><span class="line">    &lt;option value=&quot;&quot;&gt;请选择&lt;/option&gt;</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure>
<p>两个select标签，id=a的标签是第一级，id=b的标签是第二级。</p>
<p>再看JS代码，<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    var json = [&#123;</span><br><span class="line"></span><br><span class="line">              id: 1,</span><br><span class="line">              name: &apos;蔬菜&apos;,</span><br><span class="line">              child: [&#123;</span><br><span class="line">                  id: &apos;1&apos;,</span><br><span class="line">                  name: &apos;白菜&apos;</span><br><span class="line">              &#125;, &#123;</span><br><span class="line">                  id: &apos;2&apos;,</span><br><span class="line">                  name: &apos;萝卜&apos;</span><br><span class="line">              &#125;, &#123;</span><br><span class="line">                  id: &apos;3&apos;,</span><br><span class="line">                  name: &apos;菠菜&apos;</span><br><span class="line">              &#125;]</span><br><span class="line">          &#125;, &#123;</span><br><span class="line">              id: 2,</span><br><span class="line">              name: &apos;肉类&apos;,</span><br><span class="line">              child: [&#123;</span><br><span class="line">                  id: &apos;1&apos;,</span><br><span class="line">                  name: &apos;猪肉&apos;</span><br><span class="line">              &#125;, &#123;</span><br><span class="line">                  id: &apos;2&apos;,</span><br><span class="line">                  name: &apos;羊肉&apos;</span><br><span class="line">              &#125;, &#123;</span><br><span class="line">                  id: &apos;3&apos;,</span><br><span class="line">                  name: &apos;牛肉&apos;</span><br><span class="line">              &#125;]</span><br><span class="line">          &#125;, &#123;</span><br><span class="line">              id: 3,</span><br><span class="line">              name: &apos;蛋类&apos;,</span><br><span class="line">              child: [&#123;</span><br><span class="line">                  id: &apos;1&apos;,</span><br><span class="line">                  name: &apos;鸡蛋&apos;</span><br><span class="line">              &#125;, &#123;</span><br><span class="line">                  id: &apos;2&apos;,</span><br><span class="line">                  name: &apos;鹅蛋&apos;</span><br><span class="line">              &#125;, &#123;</span><br><span class="line">                  id: &apos;3&apos;,</span><br><span class="line">                  name: &apos;鸭蛋&apos;</span><br><span class="line">              &#125;]</span><br><span class="line">          &#125;];</span><br><span class="line">    var a = document.getElementById(&apos;a&apos;);</span><br><span class="line">    var b = document.getElementById(&apos;b&apos;);</span><br><span class="line">	json.map(function(s)&#123;   //相当于for循环，遍历json，这里s相当于一个json[i]</span><br><span class="line">            createop(s,a);        //这个函数是创建option并添加到select的函数，第一个参数是遍历的json[i],第二个是第一个select。第一个select的创建完成了。</span><br><span class="line">          &#125;);</span><br><span class="line">    a.onchange = function()&#123;    //当第一个select改变时</span><br><span class="line">            b.innerHTML = &apos;&apos;;         //清空第二个select的option   </span><br><span class="line">            json.map(function(s)&#123;    //遍历json</span><br><span class="line">                if(s.id==this.options[this.selectedIndex].id)&#123; //当你选中的option的id和json[i]的id相同时，也就是取到你第一个select选择的json[i].</span><br><span class="line">                    s.child.map(function(x)&#123;    //遍历这个json[i].child,得到每个分类</span><br><span class="line">                        createop(x,b);          //根据每个分类创建option添加到第二个select上</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;.bind(this));  //绑定this，改变this指向为a</span><br><span class="line">          &#125;</span><br><span class="line">    function createop(h,parent)&#123;</span><br><span class="line">              var op = document.createElement(&apos;option&apos;);  //创建option</span><br><span class="line">              var op_t = document.createTextNode(h.name);  //创建option的文字</span><br><span class="line">              op.appendChild(op_t);                    //添加文字到option中</span><br><span class="line">              op.id = h.id;                            //option的id赋值</span><br><span class="line">              parent.appendChild(op);                 //把option添加到传过来的select中</span><br><span class="line">          &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure></p>
<p>在这个JS代码里定义了一个JSON对象来存放select的value值，从JSON中可以看出一共有3个父节点，每个父节点都有自己的子节点。</p>
<p>然后通过下面的js代码实现，当我们第一个select创建option时，遍历json把第一个select的子节点创建option添加到第二个select上</p>
<p>实现select标签的二级联动功能。这里根据require_baoxiu.php里面的提交数据POST包，把以上代码demo进行了一下修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">function createop(h,parent)&#123;</span><br><span class="line">             var op = document.createElement(&apos;option&apos;);  //创建option</span><br><span class="line">             var op_t = document.createTextNode(h.name);  //创建option的文字</span><br><span class="line">             op.appendChild(op_t);                    //添加文字到option中</span><br><span class="line">		  var op_a = document.createTextNode(h.id);  //创建option的id</span><br><span class="line">             op.appendChild(op_a);                    //添加id到option中</span><br><span class="line">             op.id = h.id;							//option的id赋值</span><br><span class="line">             parent.appendChild(op);                 //把option添加到传过来的select中</span><br><span class="line">         &#125;</span><br></pre></td></tr></table></figure>
<p>在这里，我把json中的id和name值都添加到了select,因为传给后面的参数需要这个ID值作为POST提交参数。</p>
<h3><span id="require_baoxiuphp">require_baoxiu.php</span></h3><p>获取到login_baoxiu.php提交过来的表单变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$userId=$_POST[&apos;account&apos;];</span><br><span class="line">$password=$_POST[&apos;password&apos;];</span><br><span class="line">$patterns = &quot;/\d+/&quot;;</span><br><span class="line">preg_match_all($patterns,$_POST[&apos;type1&apos;],$arr1);</span><br><span class="line">$type1=$arr1[0][0];</span><br><span class="line">preg_match_all($patterns,$_POST[&apos;type2&apos;],$arr2);</span><br><span class="line">$type2=$arr2[0][0];</span><br><span class="line">$districtname=$_POST[&apos;districtname&apos;];</span><br><span class="line">$floorid=$_POST[&apos;floorid&apos;];</span><br><span class="line">$dormitoryid=$_POST[&apos;dormitoryid&apos;];</span><br><span class="line">$phone=$_POST[&apos;phone&apos;];</span><br><span class="line">$describe=$_POST[&apos;describe&apos;];</span><br></pre></td></tr></table></figure>
<p>由于$type1和$type2变量传过来的是一个name+id的值，我们需要把name剔除。利用正则得到id值。</p>
<p>下面还是用到CURL</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">function login_post($url,$cookie,$post)&#123;</span><br><span class="line">        $ch = curl_init();</span><br><span class="line">        curl_setopt($ch, CURLOPT_URL, $url);</span><br><span class="line">        curl_setopt($ch, CURLOPT_HEADER, 0);</span><br><span class="line">        curl_setopt($ch, CURLOPT_RETURNTRANSFER,1);  //不自动输出数据，要echo才行</span><br><span class="line">        curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1);  //重要，抓取跳转后数据</span><br><span class="line">        curl_setopt($ch, CURLOPT_COOKIEFILE, $cookie); </span><br><span class="line">        curl_setopt($ch, CURLOPT_REFERER, &apos;http://localhost/Repair/&apos;);  //重要，302跳转需要referer，可以在Request Headers找到 </span><br><span class="line">        curl_setopt($ch, CURLOPT_POSTFIELDS,$post);  //post提交数据</span><br><span class="line">        $result=curl_exec($ch);</span><br><span class="line">        curl_close($ch);</span><br><span class="line">        return $result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>同样先获取cookie值，保存cookie。步骤跟正方教务系统是相同的。</p>
<p>整体的分析下代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$login_url= &apos;http://localhost/Repair/UserServlet&apos;;</span><br><span class="line">$post=array(</span><br><span class="line">	&apos;flag&apos;=&gt; &apos;toCheckStuLogin&apos;,</span><br><span class="line">	&apos;userId&apos; =&gt; $userId,</span><br><span class="line">	&apos;password&apos; =&gt; $password</span><br><span class="line">   );</span><br><span class="line"></span><br><span class="line">$login_con = login_post($login_url,$cookie,http_build_query($post));</span><br></pre></td></tr></table></figure>
<p>登录到报修系统，这里用到的http_build_query()函数，而post请求包也是用到array，在上一篇说到的问题。</p>
<p>因为我们用到了http_build_query()函数，所以Content-Type还是application/x-www-form-urlencoded。</p>
<p>http_build_query()函数的作用就是是使用给出的关联(或下标)数组生成一个经过 URL-encode 的请求字符串。</p>
<p>然后更加抓包分析，我们需要把用户提交的地址更新一下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$add_url1 = &apos;http://localhost/Repair/jsp/student/repair_add.jsp&apos;;</span><br><span class="line">$add_con=login_post($add_url1  ,$cookie,&apos;&apos;);</span><br><span class="line">preg_match_all(&apos;/&lt;input.+?(value=\&quot;(.+?)\&quot;)/&apos;,$add_con, $view); //获取__VIEWSTATE字段并存到$view数组中</span><br><span class="line">//var_dump($view[1][1]);</span><br><span class="line">preg_match_all($patterns,$view[1][1],$arr3);</span><br><span class="line">$tusersid = $arr3[0][0];</span><br><span class="line"></span><br><span class="line">$updateAddress_url = &apos;http://localhost/Repair/StudentServlet?flag=updateAddress&apos;;</span><br><span class="line">$updateAddress_post=array(	</span><br><span class="line">	&apos;tId&apos; =&gt; $tusersid,</span><br><span class="line">	&apos;districtname&apos; =&gt; $districtname,</span><br><span class="line">	&apos;floorid&apos; =&gt; $floorid,</span><br><span class="line">	&apos;dormitoryid&apos; =&gt; $dormitoryid</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">$updateAddress_con = login_post($updateAddress_url,$cookie,http_build_query($updateAddress_post));</span><br></pre></td></tr></table></figure>
<p>将变量值传入更新用户的地址信息。</p>
<p>接下来就是提交报修信息了，也是用到一个post请求包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$repair_add_url = &quot;http://localhost/Repair/StudentServlet?userId=&quot;.$userId;</span><br><span class="line">$repair_add_post=array(	</span><br><span class="line">	&apos;flag&apos;=&gt; &apos;repairAdd&apos;,</span><br><span class="line">	&apos;tusersid&apos; =&gt; $tusersid,</span><br><span class="line">	&apos;districtname&apos; =&gt; $districtname,</span><br><span class="line">	&apos;floorid&apos; =&gt; $floorid,</span><br><span class="line">	&apos;dormitoryid&apos;=&gt; $dormitoryid,</span><br><span class="line">	&apos;phone&apos; =&gt; $phone,</span><br><span class="line">	&apos;goodsType&apos; =&gt; $type1,</span><br><span class="line">	&apos;goodsid&apos; =&gt; $type2,</span><br><span class="line">	&apos;describe&apos;=&gt; $describe</span><br><span class="line">);</span><br><span class="line">$repair_add_con = login_post($repair_add_url,$cookie,http_build_query($repair_add_post));</span><br></pre></td></tr></table></figure>
<p>到这里模拟提交报修信息的工作就完成了，后续我还做了一个简单的判断，判断是否登录成功。</p>
<h2><span id="github">Github</span></h2><p><a href="https://github.com/uknowsec/RepairCrawler" target="_blank" rel="noopener">https://github.com/uknowsec/RepairCrawler</a></p>
<h2><span id="reference">Reference</span></h2><p><a href="https://segmentfault.com/q/1010000011880594" target="_blank" rel="noopener">select二级联动</a></p>
</div></article></div></section><footer><div class="paginator"><a href="/posts/notes/同源策略和跨域访问学习笔记.html" class="prev">上一篇</a><a href="/posts/notes/PHP爬虫-正方教务系统一键报名四六级.html" class="next">下一篇</a></div><div class="copyright"><p>© 2016 - 2019 <a href="https://uknowsec.cn">uknow</a>  Stay hungry,Stay foolish.</p></div></footer></div><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-115504647-1",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?225ebcce29d319519ac7c7690425d1d4";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>