<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 输入表注入 · Uknow - Stay hungry Stay foolish</title><meta name="description" content="输入表注入 - uknow"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/2.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div id="mask" style="display: none;"><img id="mask-image" src="#" style=" "></div><div class="wrap"><header><a href="/" class="logo-link"><img src="/2.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">Blog</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">Archive</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">About</a></li><li class="nav-list-item"><a href="https://github.com/uknowsec" target="_blank" class="nav-list-link">GitHub</a></li><li class="nav-list-item"><a href="http://weibo.com/uknowsec" target="_blank" class="nav-list-link">Weibo</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">输入表注入</h1><div class="post-time">Jun 13, 2020</div><div class="post-content"><h3><span id="前言">前言</span></h3><p>​      上篇没有讲拿破轮胎大佬工具的原理，同时工具生成的DLL目前不是免杀的。所以这里讲一下工具的原理。实际上，注入工具会将输入的shellcode进行一个处理，然后将他写入到和<code>conf.inf</code>文件中，然后<code>wwwcomw.dll</code>可以看成一个shellcode加载器，这里就是分离免杀的原理。工具还帮我完成了修改输入表的步骤。然后我们只需要把<code>wwwcomw.dll</code>和<code>conf.inf</code>放置到exe运行目录即可。</p>
<h3><span id="输入表注入原理">输入表注入原理</span></h3><p>​      当Exe被加载时，系统会根据Exe输入表信息来加载需要用到的DLL,输入表注入的原理就是修改exe输入表，将自己的DLL添加到exe的导入表中，这样exe运行时可以将自己的DLL加载到exe的进程空间。</p>
<h3><span id="输入表注入">输入表注入</span></h3><p>DLL实例源码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">// dllmain.cpp : 定义 DLL 应用程序的入口点。</span><br><span class="line">#include &quot;pch.h&quot;</span><br><span class="line">#include &lt;windows.h&gt;</span><br><span class="line">#include &lt;iostream&gt;</span><br><span class="line">HANDLE My_hThread = NULL;</span><br><span class="line"></span><br><span class="line">DWORD  WINAPI  ceshi(LPVOID pParameter)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    MessageBox(NULL, L&quot;Zero Team&quot;, L&quot;Zero team&quot;, MB_OK);</span><br><span class="line">    return 0;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BOOL APIENTRY DllMain(HMODULE hModule,</span><br><span class="line">    DWORD  ul_reason_for_call,</span><br><span class="line">    LPVOID lpReserved</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    switch (ul_reason_for_call)</span><br><span class="line">    &#123;</span><br><span class="line">    case DLL_PROCESS_ATTACH:</span><br><span class="line">        My_hThread = ::CreateThread(NULL, 0, &amp;ceshi, 0, 0, 0);</span><br><span class="line">        break;</span><br><span class="line">    case DLL_THREAD_ATTACH:</span><br><span class="line">    case DLL_THREAD_DETACH:</span><br><span class="line">    case DLL_PROCESS_DETACH:</span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line">    return TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">extern&quot;C&quot; _declspec(dllexport) void test()</span><br><span class="line">&#123;</span><br><span class="line">    int a;</span><br><span class="line">    a = 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译如上代码，得到dll文件。</p>
<p>使用LordPe查看输出表，可以看到我们写的test函数。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com\1591938826964.png" alt="1591938826964"></p>
<p>使用Stud_PE添加输入表，导入exe查看函数。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com\1591939030535.png" alt="1591939030535"></p>
<p>添加新的输入表，选择DLL，选择函数，加入清单。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com\1591939139072.png" alt="1591939139072"></p>
<p>将DLL放置到exe运行目录，运行exe。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com\1591939196925.png" alt="1591939196925"></p>
<h3><span id="结语">结语</span></h3><p>​        对于该技术的研究仅限于在渗透测试或者钓鱼中的使用，所以没有太多的逆向原理知识部分。关于其他逆向原理知识和DLL处理方面，有兴趣的可以自己研究~</p>
</div></article></div></section><footer><div class="paginator"><a href="/posts/notes/FRP改造计划.html" class="prev">上一篇</a><a href="/posts/notes/DLL劫持+重新制作安装包在钓鱼与反钓鱼的利用.html" class="next">下一篇</a></div><div class="copyright"><p>© 2016 - 2024 <a href="https://uknowsec.cn">uknow</a>  Stay hungry,Stay foolish.</p></div></footer></div><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-115504647-1",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?225ebcce29d319519ac7c7690425d1d4";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>