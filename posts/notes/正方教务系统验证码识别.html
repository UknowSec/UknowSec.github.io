<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 正方教务系统验证码识别 · Uknow - Stay hungry Stay foolish</title><meta name="description" content="正方教务系统验证码识别 - uknow"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/2.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div id="mask" style="display: none;"><img id="mask-image" src="#" style=" "></div><div class="wrap"><header><a href="/" class="logo-link"><img src="/2.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">Blog</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">Archive</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">About</a></li><li class="nav-list-item"><a href="https://github.com/uknowsec" target="_blank" class="nav-list-link">GitHub</a></li><li class="nav-list-item"><a href="http://weibo.com/uknowsec" target="_blank" class="nav-list-link">Weibo</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">正方教务系统验证码识别</h1><div class="post-time">Apr 19, 2018</div><div class="post-content"><h2><span id="验证码预处理">验证码预处理</span></h2><h3><span id="下载验证码">下载验证码</span></h3><h4><span id="实现代码">实现代码：</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def get_checkcode(i):</span><br><span class="line">    r = requests.get(&apos;http:///CheckCode.aspx?&apos;)</span><br><span class="line">    picname = str(i) + &apos;.png&apos;</span><br><span class="line">    with open(&apos;image\\&apos; + picname, &apos;wb&apos;) as f:</span><br><span class="line">        f.write(r.content)</span><br><span class="line">        print(&quot;downloading code %d.png&quot; % i,)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    for i in range(1, 1000):</span><br><span class="line">        get_checkcode(i)</span><br></pre></td></tr></table></figure>
<h4><span id="代码分析">代码分析</span></h4><ul>
<li>利用requests库里的get方法访问生成验证码页面，并保存验证码图片到本地。</li>
</ul>
<h4><span id="代码测试">代码测试：</span></h4><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/QQ截图20180418133234.png" alt="Alt text"></p>
<h3><span id="灰度化-分割">灰度化、分割</span></h3><h4><span id="实现代码">实现代码</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">from PIL import Image, ImageTk, ImageFilter</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def get_checkcode(i):</span><br><span class="line">    r = requests.get(&apos;http:///CheckCode.aspx?&apos;)</span><br><span class="line">    picname = str(i) + &apos;.png&apos;</span><br><span class="line">    with open(&apos;image\\&apos; + picname, &apos;wb&apos;) as f:</span><br><span class="line">        f.write(r.content)</span><br><span class="line">        print(&quot;downloading code %d.png&quot; % i,)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def process_pic(i):</span><br><span class="line">    picname = str(i) + &apos;.png&apos;</span><br><span class="line">    im = Image.open(&apos;image\\&apos; + picname)</span><br><span class="line">    im = im.point(lambda i: i &gt; 43, mode=&apos;1&apos;)</span><br><span class="line">    im.save(picname)</span><br><span class="line">    y_min, y_max = 0, 22  # im.height - 1 # 26</span><br><span class="line">    split_lines = [5, 17, 29, 41, 53]</span><br><span class="line">    ims = [im.crop([u, y_min, v, y_max])</span><br><span class="line">           for u, v in zip(split_lines[:-1], split_lines[1:])]</span><br><span class="line">    return ims</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    for i in range(1, 5):</span><br><span class="line">        get_checkcode(i)</span><br><span class="line">        ims = process_pic(i)</span><br><span class="line">        print(&quot;saving code %d.png cutted&quot; % i)</span><br><span class="line">        for j in range(0, 4):</span><br><span class="line">            ims[j].save(str(i) + &apos;_&apos; + str(j) + &apos;.png&apos;)</span><br></pre></td></tr></table></figure>
<h4><span id="代码分析">代码分析</span></h4><ul>
<li><p>point()方法通过一个函数或者查询表对图像中的像素点进行处理，<code>im = im.point(lambda i: i &gt; 43, mode=&#39;1&#39;)</code><br>中<code>lambda i</code>遍历整张图片，<code>43</code>是一个阀值，大于<code>43</code>填充为<code>1</code>，小于<code>43</code>填充为<code>0</code>，<code>mode=&#39;1&#39;</code>的意思是输出模式为整数型，由此实现灰度化。</p>
</li>
<li><p><code>y_min, y_max = 0, 22</code>设定验证码图片中最大的y值和最小的y值。</p>
</li>
<li><p><code>zip(split_lines[:-1], split_lines[1:])</code> 运行结果为<code>[(5,17),(17,29),(29,41),(41,53)]</code></p>
</li>
<li><p><code>im.crop([u, y_min, v, y_max])</code> ，<code>crop()</code>函数为用来复制一个图片里的一矩形内容，传入参数为矩形的四条边。</p>
</li>
<li><p>所以通过以上的<code>crop()</code>函数实现图片的分割。</p>
</li>
</ul>
<h4><span id="代码测试">代码测试</span></h4><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/QQ截图20180418142427.png" alt="Alt text"></p>
<h3><span id="标识">标识</span></h3><h4><span id="代码分析">代码分析</span></h4><ul>
<li>利用Python的图形开发界面的库<code>tkinter</code>将验证码图片显示在一个图形化的界面，供人工标识验证码。</li>
<li><code>resize()</code>函数将爬虫爬取的验证码放大，利于辨别。</li>
<li><code>display_pic()</code>函数中<code>tk.PhotoImage()</code>方法插入图片。</li>
</ul>
<h4><span id="实现代码">实现代码</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">def get_pic_for_display(i):</span><br><span class="line">    picname = str(i) + &apos;.png&apos;</span><br><span class="line">    im = Image.open(picname)</span><br><span class="line">    w, h = im.size</span><br><span class="line">    w_box = 300</span><br><span class="line">    h_box = 200</span><br><span class="line">    im_resized = resize(w, h, w_box, h_box, im)</span><br><span class="line">    tk_image = ImageTk.PhotoImage(im_resized)</span><br><span class="line">    return tk_image</span><br><span class="line"></span><br><span class="line">def resize(w, h, w_box, h_box, pil_image):</span><br><span class="line">    f1 = w_box / w</span><br><span class="line">    f2 = h_box / h</span><br><span class="line">    factor = min([f1, f2])</span><br><span class="line">    width = int(w * factor)</span><br><span class="line">    height = int(h * factor)</span><br><span class="line">    return pil_image.resize((width, height), Image.ANTIALIAS)</span><br><span class="line"></span><br><span class="line">def display_pic():</span><br><span class="line">    global im</span><br><span class="line">    tmp = get_cnt() + 1</span><br><span class="line">    get_checkcode(tmp)</span><br><span class="line">    im = tk.PhotoImage(file= str(tmp)+&apos;.png&apos;)</span><br><span class="line">    im = get_pic_for_display(tmp)</span><br><span class="line">    picLabel[&apos;image&apos;] = im</span><br><span class="line">    cntLabel[&apos;text&apos;] = &apos;总计: &apos; + str(tmp-1) + &apos;/1000&apos;</span><br></pre></td></tr></table></figure>
<h4><span id="代码测试">代码测试</span></h4><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/QQ截图20180419122240.png" alt="Alt text"></p>
<h3><span id="归类">归类</span></h3><h4><span id="代码分析">代码分析</span></h4><ul>
<li><code>code = var.get()</code>获取图形化界面输入的验证码的值，其类型是一个数组，其中存着四个字符。</li>
<li><code>for i in range(4):</code>遍历四个字符，判断输入的字符值将他们保存到<code>set\</code>目录下相应的字符。其中<code>path = os.path.join(BASE_DIR, &#39;sets&#39;, code[i])</code>是将<code>BASE_DIR, &#39;sets&#39;, code[i]</code>三个参数组合成一个路径返回给<code>path</code>,后续还用了一个<code>if else</code>来判断这个目录是否存在，不存在即用<code>makedirs</code>创建目录。并创建并更新目录其中的<code>conut.txt</code>中的值，这个值是用来记录当前路径下字符验证码图片的数量。<code>ims[i].save(charname)</code>将验证码分隔后得到的图片保存到当前目录下。</li>
</ul>
<h4><span id="实现代码">实现代码</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">def save_imgs():</span><br><span class="line">    tmp = get_cnt() + 1</span><br><span class="line">    ims = process_pic(tmp)</span><br><span class="line">    code = var.get()</span><br><span class="line">    for i in range(4):</span><br><span class="line">        BASE_DIR = os.path.dirname(os.path.realpath(__file__))</span><br><span class="line">        path = os.path.join(BASE_DIR, &apos;sets&apos;, code[i])</span><br><span class="line">        if os.path.exists(path):</span><br><span class="line">            filepath = os.path.join(path, &apos;count.txt&apos;)</span><br><span class="line">            with open(filepath, &apos;r&apos;) as f:</span><br><span class="line">                char_cnt = eval(f.readline())</span><br><span class="line">        else:</span><br><span class="line">            os.makedirs(path)</span><br><span class="line">            filepath = os.path.join(path, &apos;count.txt&apos;)</span><br><span class="line">            with open(filepath, &apos;w&apos;) as f:</span><br><span class="line">                f.write(&apos;0&apos;)</span><br><span class="line">                char_cnt = 0</span><br><span class="line">        charname = os.path.join(path, str(char_cnt + 1) + &apos;.png&apos;)</span><br><span class="line">        ims[i].save(charname)</span><br><span class="line">        filepath = os.path.join(path, &apos;count.txt&apos;)</span><br><span class="line">        with open(filepath,&apos;w+&apos;) as f:</span><br><span class="line">            f.write(str(char_cnt + 1))</span><br><span class="line">    update_cnt(tmp)</span><br></pre></td></tr></table></figure>
<h4><span id="代码测试">代码测试</span></h4><p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/QQ截图20180419125209.png" alt="Alt text"></p>
<h3><span id="预处理完整代码">预处理完整代码</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line">import tkinter as tk</span><br><span class="line">import requests</span><br><span class="line">from PIL import Image, ImageTk, ImageFilter</span><br><span class="line">import numpy as np</span><br><span class="line">import pandas as pd</span><br><span class="line">from matplotlib import pyplot as plt</span><br><span class="line">import os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def get_cnt():</span><br><span class="line">    try:</span><br><span class="line">        with open(&apos;count.txt&apos;, &apos;r&apos;) as f:</span><br><span class="line">            cnt = f.readline()</span><br><span class="line">            cnt = eval(cnt)</span><br><span class="line">        return cnt</span><br><span class="line">    except:</span><br><span class="line">        with open(&apos;count.txt&apos;, &apos;w&apos;) as f:</span><br><span class="line">            f.write(&apos;0&apos;)</span><br><span class="line">        return 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def update_cnt(cnt):</span><br><span class="line">    with open(&apos;count.txt&apos;, &apos;w+&apos;) as f:</span><br><span class="line">        f.write(str(cnt))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def get_checkcode(i):</span><br><span class="line">    r = requests.get(&apos;http:///CheckCode.aspx?&apos;)</span><br><span class="line">    picname = str(i) + &apos;.png&apos;</span><br><span class="line">    with open(picname, &apos;wb&apos;) as f:</span><br><span class="line">        f.write(r.content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def process_pic(i):</span><br><span class="line">    picname = str(i) + &apos;.png&apos;</span><br><span class="line">    im = Image.open(picname)</span><br><span class="line">    im = im.point(lambda i: i != 43, mode=&apos;1&apos;)</span><br><span class="line">    y_min, y_max = 0, 22  # im.height - 1 # 26</span><br><span class="line">    split_lines = [5, 17, 29, 41, 53]</span><br><span class="line">    ims = [im.crop([u, y_min, v, y_max])</span><br><span class="line">           for u, v in zip(split_lines[:-1], split_lines[1:])]</span><br><span class="line">    return ims</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def get_pic_for_display(i):</span><br><span class="line">    picname = str(i) + &apos;.png&apos;</span><br><span class="line">    im = Image.open(picname)</span><br><span class="line">    w, h = im.size</span><br><span class="line">    w_box = 300</span><br><span class="line">    h_box = 200</span><br><span class="line">    im_resized = resize(w, h, w_box, h_box, im)</span><br><span class="line">    tk_image = ImageTk.PhotoImage(im_resized)</span><br><span class="line">    return tk_image</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def resize(w, h, w_box, h_box, pil_image):</span><br><span class="line">    f1 = w_box / w</span><br><span class="line">    f2 = h_box / h</span><br><span class="line">    factor = min([f1, f2])</span><br><span class="line">    width = int(w * factor)</span><br><span class="line">    height = int(h * factor)</span><br><span class="line">    return pil_image.resize((width, height), Image.ANTIALIAS)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def display_pic():</span><br><span class="line">    global im</span><br><span class="line">    tmp = get_cnt() + 1</span><br><span class="line">    get_checkcode(tmp)</span><br><span class="line">    im = tk.PhotoImage(file=str(tmp) + &apos;.png&apos;)</span><br><span class="line">    im = get_pic_for_display(tmp)</span><br><span class="line">    picLabel[&apos;image&apos;] = im</span><br><span class="line">    cntLabel[&apos;text&apos;] = &apos;总计: &apos; + str(tmp - 1) + &apos;/1000&apos;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def save_imgs():</span><br><span class="line">    tmp = get_cnt() + 1</span><br><span class="line">    ims = process_pic(tmp)</span><br><span class="line">    code = var.get()</span><br><span class="line">    for i in range(4):</span><br><span class="line">        BASE_DIR = os.path.dirname(os.path.realpath(__file__))</span><br><span class="line">        path = os.path.join(BASE_DIR, &apos;sets&apos;, code[i])</span><br><span class="line">        if os.path.exists(path):</span><br><span class="line">            filepath = os.path.join(path, &apos;count.txt&apos;)</span><br><span class="line">            with open(filepath, &apos;r&apos;) as f:</span><br><span class="line">                char_cnt = eval(f.readline())</span><br><span class="line">        else:</span><br><span class="line">            os.makedirs(path)</span><br><span class="line">            filepath = os.path.join(path, &apos;count.txt&apos;)</span><br><span class="line">            with open(filepath, &apos;w&apos;) as f:</span><br><span class="line">                f.write(&apos;0&apos;)</span><br><span class="line">                char_cnt = 0</span><br><span class="line">        charname = os.path.join(path, str(char_cnt + 1) + &apos;.png&apos;)</span><br><span class="line">        ims[i].save(charname)</span><br><span class="line">        filepath = os.path.join(path, &apos;count.txt&apos;)</span><br><span class="line">        with open(filepath, &apos;w+&apos;) as f:</span><br><span class="line">            f.write(str(char_cnt + 1))</span><br><span class="line">    update_cnt(tmp)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def submit():</span><br><span class="line">    save_imgs()</span><br><span class="line">    display_pic()</span><br><span class="line">    var.set(&apos;&apos;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def init():</span><br><span class="line">    display_pic()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">global im</span><br><span class="line">app = tk.Tk()</span><br><span class="line">app.title(&apos;Labeller&apos;)</span><br><span class="line">app.geometry(&apos;500x260&apos;)</span><br><span class="line">picLabel = tk.Label(app)</span><br><span class="line">picLabel.pack()</span><br><span class="line">var = tk.StringVar()</span><br><span class="line">textInput = tk.Entry(app, textvariable=var)</span><br><span class="line">textInput.pack(expand=&apos;yes&apos;, fill=&apos;both&apos;, padx=100, side=&apos;top&apos;, pady=10)</span><br><span class="line">submitButton = tk.Button(app, text=&quot;提交&quot;, width=&apos;10&apos;, command=submit)</span><br><span class="line">submitButton.pack()</span><br><span class="line">cntLabel = tk.Label(app)</span><br><span class="line">cntLabel.pack(pady=20)</span><br><span class="line">init()</span><br><span class="line">app.mainloop()</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/labeller.gif" alt="Alt text"></p>
<h2><span id="验证码训练">验证码训练</span></h2><h3><span id="加载-处理图片数据">加载、处理图片数据</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">def process(data):</span><br><span class="line">    for i in range(0, len(data)):</span><br><span class="line">        if(data[0][i] &gt; 0):</span><br><span class="line">            data[0][i] = 1</span><br><span class="line">    return data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def load_image(path):</span><br><span class="line">    im = Image.open(path)</span><br><span class="line">    data = np.array(im.getdata()).reshape(1, -1)</span><br><span class="line">    data = process(data)</span><br><span class="line">    return data</span><br></pre></td></tr></table></figure>
<ul>
<li><code>process()</code>函数是实现一个二值化的过程。</li>
<li><code>data = np.array(im.getdata()).reshape(1, -1)</code>中的<code>im.getdata()</code>以包含像素值的<code>sequence</code>对象形式返回图像的内容，以包含像素值的<code>sequence</code>对象形式返回图像的内容，该对象的每一个元素对应一个像素点的<code>R</code>、<code>G</code>和<code>B</code>三个值。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">def get_count(path, char):</span><br><span class="line">    filepath = os.path.join(path, char, &apos;count.txt&apos;)</span><br><span class="line">    with open(filepath, &apos;r&apos;) as f:</span><br><span class="line">        cnt = eval(f.readline())</span><br><span class="line">    return cnt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def get_label(char):</span><br><span class="line">    global char_list</span><br><span class="line">    for i in range(0, len(char_list)):</span><br><span class="line">        if char_list[i] == char:</span><br><span class="line">            return i</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def build_char_set(path, char):</span><br><span class="line">    cnt = get_count(path, char)</span><br><span class="line">    x = np.zeros((cnt, 264))</span><br><span class="line">    y = np.zeros((cnt, 1))</span><br><span class="line">    for i in range(1, cnt + 1):</span><br><span class="line">        filepath = os.path.join(path, char, str(i) + &apos;.png&apos;)</span><br><span class="line">        x[i - 1, :] = load_image(filepath)</span><br><span class="line">        y[i - 1] = get_label(char)</span><br><span class="line">    char_set = np.hstack((x, y))</span><br><span class="line">    return char_set</span><br><span class="line">	</span><br><span class="line">def build_sets(path):</span><br><span class="line">    global char_list</span><br><span class="line">    sets = build_char_set(path, char_list[0])</span><br><span class="line">    for i in range(1, len(char_list)):</span><br><span class="line">        char_set = build_char_set(path, char_list[i])</span><br><span class="line">        sets = np.vstack((sets, char_set))</span><br><span class="line">    return sets</span><br></pre></td></tr></table></figure>
<ul>
<li><code>cnt = get_count(path, char)</code>通过<code>get_count()</code>函数读取相关字符目录下<code>count.txt</code>文件的数值。</li>
<li><code>x = np.zeros((cnt, 264))  y = np.zeros((cnt, 1))</code>返回来一个给定形状和类型的用0填充的数组，用<code>np.zeros</code>生成<code>(cnt,264)</code>和<code>(cnt,1)</code>的数组下<code>x</code>,<code>y</code>。</li>
<li><code>get_label()</code>函数用来读取人工标识获取的char值。<code>load_image()</code>函数用来读取文件目录下的字符。<code>for</code>循环分别填充刚刚生成的<code>y</code>,<code>x</code>数组。</li>
<li><code>np.hstack((x, y))</code>将填充的<code>y</code>,<code>x</code>数组将水平(按列顺序)把数组给堆叠起来。返回给<code>char_set</code>。</li>
<li><code>for i in range(1, len(char_list)):</code>遍历所有字符，得到所有字符的水平(按列顺序)把数组给堆叠起来的结果再用<code>sets = np.vstack((sets, char_set))</code>垂直（按照行顺序）的把数组给堆叠起来复制给<code>set</code>。</li>
</ul>
<h3><span id="配置svm模型">配置SVM模型</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">def build_training_sets(sets, percent):</span><br><span class="line">    length = int(len(sets) * percent)</span><br><span class="line">    return sets[0:length, :]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def build_test_sets(sets, percent):</span><br><span class="line">    length = int(len(sets) * (1 - percent))</span><br><span class="line">    return sets[length:len(sets), :]</span><br></pre></td></tr></table></figure>
<ul>
<li>声明两个函数分别是<code>build_training_sets(sets, percent)</code>和<code>build_test_sets(sets, percent)</code>。这两个函数参数为<code>sets</code>和<code>percent</code>即上部分析得到的<code>sets</code>值和一个<code>百分比</code>值,用于训练集和测试集的建立。</li>
</ul>
<h3><span id="加载测试集-训练集">加载测试集、训练集</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">def train(training_sets):</span><br><span class="line">    x = training_sets[:, 0:264]</span><br><span class="line">    y = training_sets[:, 264].reshape(-1, 1)</span><br><span class="line">    clf = svm.LinearSVC()</span><br><span class="line">    clf.fit(x, y)</span><br><span class="line">    return clf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def recognize(y):</span><br><span class="line">    global char_list</span><br><span class="line">    return char_list[y]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def predict(clf, x):</span><br><span class="line">    return recognize(int(clf.predict(x)[0]))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def accuracy(pred, real):</span><br><span class="line">    cnt = 0</span><br><span class="line">    for i in range(len(pred)):</span><br><span class="line">        if pred[i] == real[i]:</span><br><span class="line">            cnt = cnt + 1</span><br><span class="line">    return cnt / len(pred)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def test(clf, test_sets):</span><br><span class="line">    x = test_sets[:, 0:264]</span><br><span class="line">    y = test_sets[:, 264].reshape(-1, 1)</span><br><span class="line">    length = x.shape[1]</span><br><span class="line">    pred = []</span><br><span class="line">    real = []</span><br><span class="line">    for i in range(0, length):</span><br><span class="line">        pred.append(predict(clf, x[i, :].reshape(1, -1)))</span><br><span class="line">        real.append(recognize(int(y[i])))</span><br><span class="line">    return accuracy(pred, real)</span><br></pre></td></tr></table></figure>
<ul>
<li><code>train(training_sets)</code>函数中<code>x</code>和<code>y</code>是用来生成训练集数据的，在后续函数可以得知。</li>
<li><code>clf = svm.LinearSVC()</code>初始化一个<code>SVM</code>模型。<code>clf.fit(x, y)</code>用<code>x</code>和<code>y</code>作为训练数据拟合模型。</li>
<li><code>predict(clf, x)</code>是预测<code>load_image()</code>函数用来读取文件目录下的字符的类函数</li>
<li><code>test(clf, test_sets)</code>函数是用来进行测试集数据处理的函数，函数中加载测试集的<code>sets</code>数据，并计算测试集精度由<code>accuracy()</code>函数返回。</li>
</ul>
<h3><span id="训练-测试并更新">训练、测试并更新</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">def update_model():</span><br><span class="line">    BASE_DIR = os.path.dirname(os.path.realpath(__file__))</span><br><span class="line">    data_path = os.path.join(BASE_DIR, &apos;sets&apos;)</span><br><span class="line">    model_path = os.path.join(BASE_DIR, &apos;model&apos;, &apos;svm.model&apos;)</span><br><span class="line">    sets = build_sets(data_path)</span><br><span class="line">    for i in range(5):</span><br><span class="line">        np.random.shuffle(sets)</span><br><span class="line">    training_sets = build_training_sets(sets, 0.9)</span><br><span class="line">    test_sets = build_test_sets(sets, 0.1)</span><br><span class="line">    model = train(training_sets)</span><br><span class="line">    res = test(model, test_sets)</span><br><span class="line">    joblib.dump(model, model_path)</span><br><span class="line">    print(&apos;Model updated! The accuracy on test sets: &apos; + str(res))</span><br></pre></td></tr></table></figure>
<ul>
<li>从<code>update_model()</code>函数分析，这个函数用来更新模型的，显示加载相应的图像数据和<code>svm</code>模型。</li>
<li><code>for i in range(5):   np.random.shuffle(sets)</code>利用一个<code>for</code>循环生成5个用<code>np.random.shuffle(sets)</code>函数打乱顺序的<code>sets</code>值。</li>
<li>利用<code>training_sets = build_training_sets(sets, 0.9)</code>和<code>test_sets = build_test_sets(sets, 0.1)</code>,前面提到的两个函数创建训练集和测试集。</li>
<li><code>model = train(training_sets)</code>加载训练集，训练模型。<code>res = test(model, test_sets)</code>返回测试集的精度。</li>
<li><code>joblib.dump(model, model_path)</code>使用joblib保存模型到响应目录生成新的<code>SVM</code>模型。</li>
</ul>
<h2><span id="识别验证码">识别验证码</span></h2><h3><span id="加载-处理验证码">加载、处理验证码</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">def process_pic(path):</span><br><span class="line">    im = Image.open(path)</span><br><span class="line">    im = im.point(lambda i: i != 43, mode=&apos;1&apos;)</span><br><span class="line">    y_min, y_max = 0, 22  # im.height - 1 # 26</span><br><span class="line">    split_lines = [5, 17, 29, 41, 53]</span><br><span class="line">    ims = [im.crop([u, y_min, v, y_max])</span><br><span class="line">           for u, v in zip(split_lines[:-1], split_lines[1:])]</span><br><span class="line">    return ims</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def process(data):</span><br><span class="line">    for i in range(0, len(data)):</span><br><span class="line">        if(data[0][i] &gt; 0):</span><br><span class="line">            data[0][i] = 1</span><br><span class="line">    return data</span><br></pre></td></tr></table></figure>
<ul>
<li><code>process_pic()</code>函数和<code>process()</code>函数在前面<code>labeler</code>模块是出现过的，第一个函数使用来分隔验证码的，把验证码分隔成四部分。第二个函数是用来进行二值化的。</li>
</ul>
<h3><span id="识别验证码">识别验证码</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">def recognize_checkcode(path):</span><br><span class="line">    model_path = r&apos;./model/svm.model&apos;</span><br><span class="line">    model = joblib.load(model_path)</span><br><span class="line">    char_list = list(&quot;0123456789abcdefghijklmnopqrstuvwxy&quot;)</span><br><span class="line">    ims = process_pic(path)</span><br><span class="line">    code = []</span><br><span class="line">    for j in range(4):</span><br><span class="line">        data = np.array(ims[j].getdata()).reshape(1, -1)</span><br><span class="line">        data = process(data)</span><br><span class="line">        code.append(predict(model, data))</span><br><span class="line">    return code[0] + code[1] + code[2] + code[3]</span><br></pre></td></tr></table></figure>
<ul>
<li><code>recognize_checkcode(path)</code>函数中，首先通过<code>joblib</code>的<code>load</code>方法，加载保存的模型。</li>
<li><code>process_pic(path)</code>分隔图片，<code>for j in range(4)</code>循环把分隔的四张图像进行二值化过程。</li>
<li><code>predict(model, data)</code>，把四张图像加入SVM模型测试。将结果利用数组的<code>append</code>方法添加到数组。</li>
</ul>
</div></article></div></section><footer><div class="paginator"><a href="/posts/notes/hackthebox-invite-code.html" class="prev">上一篇</a><a href="/posts/notes/solveme-peng-kr平台Web练习.html" class="next">下一篇</a></div><div class="copyright"><p>© 2016 - 2019 <a href="https://uknowsec.cn">uknow</a>  Stay hungry,Stay foolish.</p></div></footer></div><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-115504647-1",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?225ebcce29d319519ac7c7690425d1d4";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>