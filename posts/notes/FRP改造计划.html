<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> FRP改造计划 · Uknow - Stay hungry Stay foolish</title><meta name="description" content="FRP改造计划 - uknow"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/2.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div id="mask" style="display: none;"><img id="mask-image" src="#" style=" "></div><div class="wrap"><header><a href="/" class="logo-link"><img src="/2.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">Blog</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">Archive</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">About</a></li><li class="nav-list-item"><a href="https://github.com/uknowsec" target="_blank" class="nav-list-link">GitHub</a></li><li class="nav-list-item"><a href="http://weibo.com/uknowsec" target="_blank" class="nav-list-link">Weibo</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">FRP改造计划</h1><div class="post-time">Jun 21, 2020</div><div class="post-content"><h3><span id="前言">前言</span></h3><p>frp无疑是众多代理工具中，用得最舒服的了。但是他还是存在几个缺点的。</p>
<ul>
<li>.ini配置文件泄露服务器信息。</li>
<li><p>非TLS特征明显</p>
</li>
<li><p>golang编译打包后的体积过大</p>
</li>
</ul>
<p>一直想改来着，但是一直拖着。前两天看到了吐司大佬发的frp讨论帖，于是下定决心改一下。</p>
<p>这里主要是对上面提到的前两个缺点进行改造，体积过大问题需要去整体的修改，减少他用到的一些依赖库和无用功能。</p>
<h3><span id="流量特征非tls">流量特征(非TLS)</span></h3><p>在没有配置<code>tls_enable = true</code></p>
<p>frpc在连接认证frps的时候回把frp的版本信息等等发给frps进行认证。</p>
<p>目前一些流量设备就通过这个特征来识别frp代理。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com\1592656026044.png" alt="1592656026044"></p>
<p>如上图，可以看到有如下几个字段值：<code>version,hostname,arch,user,privilege_key,runid,metas</code></p>
<h3><span id="去除特征">去除特征</span></h3><p>去除的方法也很简单，只要把这些特征值修改一下就行了。</p>
<p><a href="https://github.com/fatedier/frp" target="_blank" rel="noopener">https://github.com/fatedier/frp</a></p>
<p>首先把frp的源码从github上下下来。</p>
<p>定位到认证信息的代码位置为：<code>models/msg/msg.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Login <span class="keyword">struct</span> &#123;</span><br><span class="line">	Version      <span class="keyword">string</span>            <span class="string">`json:"version"`</span></span><br><span class="line">	Hostname     <span class="keyword">string</span>            <span class="string">`json:"hostname"`</span></span><br><span class="line">	Os           <span class="keyword">string</span>            <span class="string">`json:"os"`</span></span><br><span class="line">	Arch         <span class="keyword">string</span>            <span class="string">`json:"arch"`</span></span><br><span class="line">	User         <span class="keyword">string</span>            <span class="string">`json:"user"`</span></span><br><span class="line">	PrivilegeKey <span class="keyword">string</span>            <span class="string">`json:"privilege_key"`</span></span><br><span class="line">	Timestamp    <span class="keyword">int64</span>             <span class="string">`json:"timestamp"`</span></span><br><span class="line">	RunId        <span class="keyword">string</span>            <span class="string">`json:"run_id"`</span></span><br><span class="line">	Metas        <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span> <span class="string">`json:"metas"`</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Some global configures.</span></span><br><span class="line">	PoolCount <span class="keyword">int</span> <span class="string">`json:"pool_count"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> LoginResp <span class="keyword">struct</span> &#123;</span><br><span class="line">	Version       <span class="keyword">string</span> <span class="string">`json:"version"`</span></span><br><span class="line">	RunId         <span class="keyword">string</span> <span class="string">`json:"run_id"`</span></span><br><span class="line">	ServerUdpPort <span class="keyword">int</span>    <span class="string">`json:"server_udp_port"`</span></span><br><span class="line">	Error         <span class="keyword">string</span> <span class="string">`json:"error"`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如上图，这里可以看到定义的结构里有认证时候用到的变量，和认证回显的变量。我们可以修改此处来去除特征。</p>
<p>如<code>`json:&quot;version&quot;</code>修改为<code>json:&quot;a&quot;</code>来逃避流量识别。</p>
<p>同时在这个go文件里还有其他的结构体。可以用同样的方法进行修改。</p>
<p>也可以修改字段的值，比如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Version      string            `json:&quot;version&quot;`</span><br></pre></td></tr></table></figure>
<p><code>version</code>这个变量的值。在Goland里跟进到这个变量被利用到的文件<code>client/service.go</code>。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">loginMsg := &amp;msg.Login&#123;</span><br><span class="line">	Arch:      runtime.GOARCH,</span><br><span class="line">	Os:        runtime.GOOS,</span><br><span class="line">	PoolCount: svr.cfg.PoolCount,</span><br><span class="line">	User:      svr.cfg.User,</span><br><span class="line">	Version:   version.Full(),</span><br><span class="line">	Timestamp: time.Now().Unix(),</span><br><span class="line">	RunId:     svr.runId,</span><br><span class="line">	Metas:     svr.cfg.Metas,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再跟进<code>version.Full()</code>方法到<code>utils\version\version.go</code></p>
<p>我们可以修改<code>version</code>变量的值即可，这个变量是frp的版本号。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> version <span class="keyword">string</span> = <span class="string">"0.33.0"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Full</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> version</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>另外变量值的修改可以通过同样的方法修改。</p>
<h3><span id="frp优化">frp优化</span></h3><p>最近在吐司看到有师傅发了frp的讨论帖子，其中说到几个点挺好的。这里简单的记录一下。</p>
<h4><span id="通过tls和算法加密frp流量">通过tls和算法加密frp流量</span></h4><h5><span id="加密与压缩">加密与压缩</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># frpc.ini</span><br><span class="line">[ssh]</span><br><span class="line">type = tcp</span><br><span class="line">local_port = 22</span><br><span class="line">remote_port = 6000</span><br><span class="line">use_encryption = true</span><br><span class="line">use_compression = true</span><br></pre></td></tr></table></figure>
<p>如果公司内网防火墙对外网访问进行了流量识别与屏蔽，例如禁止了 ssh 协议等，通过设置 use_encryption = true，将 frpc 与 frps 之间的通信内容加密传输，将会有效防止流量被拦截。</p>
<p>如果传输的报文长度较长，通过设置 use_compression = true 对传输内容进行压缩，可以有效减小 frpc 与 frps 之间的网络流量，加快流量转发速度，但是会额外消耗一些 cpu 资源。</p>
<h5><span id="tls">TLS</span></h5><p>从 v0.25.0 版本开始 frpc 和 frps 之间支持通过 TLS 协议加密传输。通过在 frpc.ini 的 common 中配置 tls_enable = true 来启用此功能，安全性更高。<br>为了端口复用，frp 建立 TLS 连接的第一个字节为 0x17。<br>通过将 frps.ini 的 [common] 中 tls_only 设置为 true，可以强制 frps 只接受 TLS 连接。</p>
<p><strong>注意: 启用此功能后除 xtcp 外，不需要再设置 use_encryption。</strong></p>
<h4><span id="frpcini写入源码">frpc.ini写入源码</span></h4><p>修改文件<code>cmd\frpc\sub\root.go</code>里的代码</p>
<p>把frpc.ini配置内容写到上面定义里。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[common]</span><br><span class="line">server_addr=1.1.1.1</span><br><span class="line">server_port=2333</span><br><span class="line">privilege_token = pentest</span><br><span class="line">tls_enable = true</span><br><span class="line">[http_proxy]</span><br><span class="line">type = tcp</span><br><span class="line">remote_port = 23333</span><br><span class="line">plugin = socks5</span><br></pre></td></tr></table></figure>
<p>结果如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	cfgFile     <span class="keyword">string</span></span><br><span class="line">	showVersion <span class="keyword">bool</span></span><br><span class="line">	fileContent <span class="keyword">string</span> = <span class="string">`[common]</span></span><br><span class="line"><span class="string">    server_addr = 1.1.1.1</span></span><br><span class="line"><span class="string">    server_port = 2333</span></span><br><span class="line"><span class="string">    privilege_token = pentest</span></span><br><span class="line"><span class="string">    tls_enable = true</span></span><br><span class="line"><span class="string">    [http_proxy]</span></span><br><span class="line"><span class="string">    type = tcp</span></span><br><span class="line"><span class="string">    remote_port = 23333</span></span><br><span class="line"><span class="string">    plugin = socks5</span></span><br><span class="line"><span class="string">	`</span></span><br><span class="line">	serverAddr      <span class="keyword">string</span></span><br><span class="line">	user            <span class="keyword">string</span></span><br><span class="line">	protocol        <span class="keyword">string</span></span><br><span class="line">	token           <span class="keyword">string</span></span><br><span class="line">	logLevel        <span class="keyword">string</span></span><br><span class="line">	logFile         <span class="keyword">string</span></span><br><span class="line">	logMaxDays      <span class="keyword">int</span></span><br><span class="line">	disableLogColor <span class="keyword">bool</span></span><br><span class="line"></span><br><span class="line">	proxyName         <span class="keyword">string</span></span><br><span class="line">	localIp           <span class="keyword">string</span></span><br><span class="line">	localPort         <span class="keyword">int</span></span><br><span class="line">	remotePort        <span class="keyword">int</span></span><br><span class="line">	useEncryption     <span class="keyword">bool</span></span><br><span class="line">	useCompression    <span class="keyword">bool</span></span><br><span class="line">	customDomains     <span class="keyword">string</span></span><br><span class="line">	subDomain         <span class="keyword">string</span></span><br><span class="line">	httpUser          <span class="keyword">string</span></span><br><span class="line">	httpPwd           <span class="keyword">string</span></span><br><span class="line">	locations         <span class="keyword">string</span></span><br><span class="line">	hostHeaderRewrite <span class="keyword">string</span></span><br><span class="line">	role              <span class="keyword">string</span></span><br><span class="line">	sk                <span class="keyword">string</span></span><br><span class="line">	multiplexer       <span class="keyword">string</span></span><br><span class="line">	serverName        <span class="keyword">string</span></span><br><span class="line">	bindAddr          <span class="keyword">string</span></span><br><span class="line">	bindPort          <span class="keyword">int</span></span><br><span class="line"></span><br><span class="line">	kcpDoneCh <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>修改代码：<code>cmd/frpc/sub/status.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> statusCmd = &amp;cobra.Command&#123;</span><br><span class="line">	Use:   <span class="string">"status"</span>,</span><br><span class="line">	Short: <span class="string">"Overview of all proxies status"</span>,</span><br><span class="line">	RunE: <span class="function"><span class="keyword">func</span><span class="params">(cmd *cobra.Command, args []<span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">		<span class="comment">//iniContent, err := config.GetRenderedConfFromFile(cfgFile)</span></span><br><span class="line">		iniContent:= fileContent</span><br><span class="line">		<span class="comment">/*if err != nil &#123;</span></span><br><span class="line"><span class="comment">			fmt.Println(err)</span></span><br><span class="line"><span class="comment">			os.Exit(1)</span></span><br><span class="line"><span class="comment">		&#125;*/</span></span><br><span class="line"></span><br><span class="line">		clientCfg, err := parseClientCommonCfg(CfgFileTypeIni, iniContent)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Println(err)</span><br><span class="line">			os.Exit(<span class="number">1</span>)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		err = status(clientCfg)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Printf(<span class="string">"frpc get status error: %v\n"</span>, err)</span><br><span class="line">			os.Exit(<span class="number">1</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改代码：<code>cmd/frpc/sub/reload.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> reloadCmd = &amp;cobra.Command&#123;</span><br><span class="line">	Use:   <span class="string">"reload"</span>,</span><br><span class="line">	Short: <span class="string">"Hot-Reload frpc configuration"</span>,</span><br><span class="line">	RunE: <span class="function"><span class="keyword">func</span><span class="params">(cmd *cobra.Command, args []<span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">		<span class="comment">//iniContent, err := config.GetRenderedConfFromFile(cfgFile)</span></span><br><span class="line">		iniContent:=  fileContent</span><br><span class="line">		   </span><br><span class="line">		<span class="comment">/*if err != 0 &#123;</span></span><br><span class="line"><span class="comment">			fmt.Println(err)</span></span><br><span class="line"><span class="comment">			os.Exit(1)</span></span><br><span class="line"><span class="comment">		&#125;*/</span></span><br><span class="line"></span><br><span class="line">		clientCfg, err := parseClientCommonCfg(CfgFileTypeIni, iniContent)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Println(err)</span><br><span class="line">			os.Exit(<span class="number">1</span>)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		err = reload(clientCfg)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Printf(<span class="string">"frpc reload error: %v\n"</span>, err)</span><br><span class="line">			os.Exit(<span class="number">1</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		fmt.Printf(<span class="string">"reload success\n"</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改代码：<code>cmd/frpc/sub/root.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">runClient</span><span class="params">(cfgFilePath <span class="keyword">string</span>)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> content <span class="keyword">string</span></span><br><span class="line">	<span class="comment">//content, err = config.GetRenderedConfFromFile(cfgFilePath)</span></span><br><span class="line">	content, err = fileContent, <span class="literal">nil</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	cfg, err := parseClientCommonCfg(CfgFileTypeIni, content)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	pxyCfgs, visitorCfgs, err := config.LoadAllConfFromIni(cfg.User, content, cfg.Start)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = startService(cfg, pxyCfgs, visitorCfgs, cfgFilePath)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行效果如下：</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com\1592706307411.png" alt="1592706307411"></p>
<h4><span id="frpcini的ip通过参数传入">frpc.ini的ip通过参数传入</span></h4><p>Golang语法规则：</p>
<ul>
<li><p>golang的命名推荐使用驼峰命名法，必须以一个字母（Unicode字母）或下划线开头，后面可以跟任意数量的字母、数字或下划线。</p>
</li>
<li><p>golang中根据首字母的大小写来确定可以访问的权限。无论是方法名、常量、变量名还是结构体的名称，如果首字母大写，则可以被其他的包访问；如果首字母小写，则只能在本包中使用</p>
</li>
</ul>
<p>不用上面的直接增加定义的方法，在<code>cmd/frpc/sub/root.go</code>写一个函数。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getFileContent</span><span class="params">(ip <span class="keyword">string</span>,port <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> content <span class="keyword">string</span> = <span class="string">`[common]</span></span><br><span class="line"><span class="string">    server_addr = `</span> + ip + <span class="string">`</span></span><br><span class="line"><span class="string">    server_port = `</span> + port + <span class="string">`</span></span><br><span class="line"><span class="string">	tls_enable = true</span></span><br><span class="line"><span class="string">    privilege_token = pentest999</span></span><br><span class="line"><span class="string">    [http_proxy]</span></span><br><span class="line"><span class="string">    type = tcp</span></span><br><span class="line"><span class="string">    remote_port = 23333</span></span><br><span class="line"><span class="string">    plugin = socks5</span></span><br><span class="line"><span class="string">	`</span></span><br><span class="line">	fileContent = content</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在<code>cmd\frpc\root.go</code>中定义传参</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	rootCmd.PersistentFlags().StringVarP(&amp;cfgFile, <span class="string">"config"</span>, <span class="string">"c"</span>, <span class="string">"./frpc.ini"</span>, <span class="string">"config file of frpc"</span>)</span><br><span class="line">	rootCmd.PersistentFlags().BoolVarP(&amp;showVersion, <span class="string">"version"</span>, <span class="string">"v"</span>, <span class="literal">false</span>, <span class="string">"version of frpc"</span>)</span><br><span class="line">	rootCmd.PersistentFlags().StringVarP(&amp;ip, <span class="string">"server_addr"</span>, <span class="string">"t"</span>, <span class="string">""</span>, <span class="string">"server_addr"</span>)</span><br><span class="line">	rootCmd.PersistentFlags().StringVarP(&amp;port, <span class="string">"server_port"</span>, <span class="string">"p"</span>, <span class="string">""</span>, <span class="string">"server_port"</span>)</span><br><span class="line">	kcpDoneCh = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改<code>runClient</code>函数</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">runClient</span><span class="params">(cfgFilePath <span class="keyword">string</span>,ip <span class="keyword">string</span>,port <span class="keyword">string</span>)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> content <span class="keyword">string</span></span><br><span class="line">	getFileContent(ip,port)</span><br><span class="line">	<span class="comment">//scontent, err = config.GetRenderedConfFromFile(cfgFilePath)</span></span><br><span class="line">	content, err = fileContent, <span class="literal">nil</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	cfg, err := parseClientCommonCfg(CfgFileTypeIni, content)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	pxyCfgs, visitorCfgs, err := config.LoadAllConfFromIni(cfg.User, content, cfg.Start)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = startService(cfg, pxyCfgs, visitorCfgs, cfgFilePath)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在如下代码中调用<code>runClient()</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> rootCmd = &amp;cobra.Command&#123;</span><br><span class="line">	Use:   <span class="string">"frpc"</span>,</span><br><span class="line">	Short: <span class="string">"frpc is the client of frp (https://github.com/fatedier/frp)"</span>,</span><br><span class="line">	RunE: <span class="function"><span class="keyword">func</span><span class="params">(cmd *cobra.Command, args []<span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> showVersion &#123;</span><br><span class="line">			fmt.Println(version.Full())</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// Do not show command usage here.</span></span><br><span class="line">		err := runClient(cfgFile,ip,port)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Println(err)</span><br><span class="line">			os.Exit(<span class="number">1</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改完上面的代码，就可以用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frpc.exe -t 1.1.1.1 -p 2333</span><br></pre></td></tr></table></figure>
<p>来启动frpc.exe了。</p>
<p>这种在Windows下不会暴露远程ip，但是在linux下还是会暴露的。</p>
<p>所以可以直接加一些加密啥的，<code>-t</code>参数传入ip加密后的地址，然后在源码里加一个解密的步骤即可。</p>
<p>同样也可以将ip地址以十进制或十六进制传入，然后在程序里转换会<code>1.1.1.1</code>格式。</p>
<p>运行效果如下：</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com\1592706410793.png" alt="1592706410793"></p>
<h3><span id="编译打包">编译打包</span></h3><p>frp整个项目编译打包其实也挺简单的，首先保证go和gcc环境都安装好。</p>
<p>然后修改一下目录下带的<code>package.sh</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># compile for version</span></span><br><span class="line">make</span><br><span class="line"><span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"make error"</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">frp_version=`./bin/frps --version`</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"build version: <span class="variable">$frp_version</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cross_compiles</span></span><br><span class="line">make -f ./Makefile.cross-compiles</span><br><span class="line"></span><br><span class="line">rm -rf ./release/packages</span><br><span class="line">mkdir -p ./release/packages</span><br><span class="line"></span><br><span class="line">os_all=<span class="string">'linux windows darwin freebsd'</span></span><br><span class="line">arch_all=<span class="string">'386 amd64 arm arm64 mips64 mips64le mips mipsle'</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> ./release</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> os <span class="keyword">in</span> <span class="variable">$os_all</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">for</span> arch <span class="keyword">in</span> <span class="variable">$arch_all</span>; <span class="keyword">do</span></span><br><span class="line">        frp_dir_name=<span class="string">"frp_<span class="variable">$&#123;frp_version&#125;</span>_<span class="variable">$&#123;os&#125;</span>_<span class="variable">$&#123;arch&#125;</span>"</span></span><br><span class="line">        frp_path=<span class="string">"./packages/frp_<span class="variable">$&#123;frp_version&#125;</span>_<span class="variable">$&#123;os&#125;</span>_<span class="variable">$&#123;arch&#125;</span>"</span></span><br><span class="line">        <span class="built_in">cd</span> ..</span><br><span class="line">        rm -rf <span class="variable">$&#123;frp_path&#125;</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> -</span><br></pre></td></tr></table></figure>
<p>然后运行这个bash脚本，就可以交叉编译得到各种操作系统环境下的应用程序了。</p>
<h3><span id="github">Github</span></h3><p>没有环境或无法正常编译可直接到github下载</p>
<p><a href="https://github.com/uknowsec/frpModify" target="_blank" rel="noopener">https://github.com/uknowsec/frpModify</a></p>
<h3><span id="结语">结语</span></h3><p>通读了一下frpc读取配置文件和认证过程两部分的代码，然后再了解了<a href="github.com/spf13/cobra">cobra</a>库的用法，实现简单的去特征，frpc无参和传参版的改造。后面的目标会继续研究frpc减小体积部分的改造。</p>
</div></article></div></section><footer><div class="paginator"><a href="/posts/notes/输入表注入.html" class="next">NEXT</a></div><div class="copyright"><p>© 2016 - 2020 <a href="https://uknowsec.cn">uknow</a>  Stay hungry,Stay foolish.</p></div></footer></div><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-115504647-1",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?225ebcce29d319519ac7c7690425d1d4";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>